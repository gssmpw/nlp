\begin{algorithm}[t]
    % \SetAlgoNlRelativeSize{-1}
    \KwIn{$\textit{state: }S(T_j), \textit{action: } A(T_j) $}
    \KwOut{Masked action: $\MaskAction$} 
\small
Initializing: $\PowerNeed \gets [\PowerNeed(C_i, T_j)]_{C_i \in \mathbf{C}}$; \quad
$\ReTime \gets [\ReTime(\phi(C_i, T_j))]_{C_i \in \mathbf{C}};$
$\epsilon \gets 10^{-5}$; \quad
$C^{max} \gets [C^{max}_i]_{C_i \in \mathbf{C}}$; \quad
$C^{min} \gets [C^{min}_i]_{C_i \in \mathbf{C}}$

\tcp{Mask 1: Set action = 0 if no car is connected}
    $ \MaskAction \gets \frac{\ReTime}{\ReTime + \epsilon} \times A(T_j)$\
    
    \tcp{Mask 2: Stop charging when required SoC is reached for uni-directional chargers}
    $ \MaskAction_{tmp} \gets \MaskAction$; \quad
    $\MaskAction[\textit{uniIdx}] \gets \min(\MaskAction_{tmp}, \frac{\PowerNeed}{\delta})[\textit{uniIdx}]$
    % $  \gets \MaskAction_{tmp}$

    \tcp{Mask 3: Enforce charging to the req. SoC before departure. }
    $\overline{\Power(T_j)} \gets \frac{ \PowerNeed- (\ReTime - 1) \times C^{max} \times \delta }{\delta}$\
    $\overline{\Power(T_j)} \gets \min(\overline{\Power(T_j)}, C^{max})$; 
    $\MaskAction \gets \max(\MaskAction, \overline{\Power(T_j)})$\
    
    \tcp{Mask 4:  Bidirectional chargers discharge to req. SoC by departure.}
    $\Power^*(T_j) \gets \frac{\PowerNeed- (\ReTime - 1) \times C^{min} \times \delta }{\delta}$\
    $\Power^*(T_j) \gets \max(\Power^*_t, C^{min})$\
    
    $\MaskAction_{tmp}\gets \MaskAction$; \quad
    $ \MaskAction[\textit{biIdx}] \gets \min(\MaskAction_{tmp}, \Power^*_t)[\textit{biIdx}]$\

    \tcp{Mask 5: Power improvement strategy}
    $ \textit{powerGap} \gets \Building(T_j) - \PrdPeak(T_j)$\
    $ \textit{canIncrease} \gets \textit{ReLU}\left(\min\left(\frac{\PowerNeed}{\delta}, C^{max}\right) - \MaskAction \right)$
    
    $ \textit{toImprove} \gets \min\left(\textit{ReLU}(\textit{powerGap} - \sum \MaskAction), \sum \textit{canIncrease}\right)$
    
    $ \MaskAction \gets \MaskAction + \frac{\textit{toImprove} \times \textit{canIncrease}}{\sum(\textit{canIncrease}) + \epsilon}$

    \tcp{Mask 6: Do not discharge below building load}
    $ \textit{toImprove} \gets \max(-\Building(T_j) - \sum(\MaskAction), 0)$
    $ \textit{negAction} \gets \textit{ReLU}(\MaskAction \times -1) \times -1$
    
    % $ \textit{toIncrease} \gets \frac{\textit{toImprove} \times \textit{tmpAction}}{\sum(\textit{tmpAction}) + \epsilon}$\;
    $ \MaskAction \gets \MaskAction +  \frac{\textit{toImprove} \times \textit{negAction}}{\sum(\textit{negAction}) + \epsilon}$

    \caption{Action Masking: $\Mask(S(T_j), A(T_j))$.} 
    \label{alg: action_masking}
\end{algorithm} 