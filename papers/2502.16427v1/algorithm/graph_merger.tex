% !TEX root = ../main.tex

\begin{algorithm}[t]
\caption{Scene graph merging}
\label{alg:hierarchical_graph_merge}
\begin{algorithmic}[1]

  \STATE \textbf{Input:} 
  \STATE \quad $\mathcal{Q} = [ G_1, G_2, \dots, G_n ]$: a priority queue with frame-level scene graphs
  \STATE \quad $\phi(\cdot)$: a graph encoder
  \STATE \quad $\psi_i(\cdot)$: a function returning the $i^\text{th}$ object in a graph
  \STATE \quad $\pi$: a permutation function
  \STATE \quad $\tau$: a threshold

  \STATE \textbf{Output:} $G_{\text{video}}$: a video-level scene graph

  \WHILE{$|\mathcal{Q}| > 1$}
    \STATE $G^s = (\mathcal{O}^s, \mathcal{E}^s) \gets \text{dequeue}(\mathcal{Q})$
    \STATE $G^t = (\mathcal{O}^t, \mathcal{E}^t) \gets \text{dequeue}(\mathcal{Q})$
    \STATE $G^m = (\mathcal{O}^m, \mathcal{E}^m) \gets (\mathcal{O}^s \cup \mathcal{O}^t, \mathcal{E}^s \cup \mathcal{E}^t)$

    \STATE $\pi^* \gets \displaystyle \arg\max_{\pi \in \Pi} \sum_{i} 
      \frac{\psi_i(\phi(G^s))}{\lVert \psi_i(\phi(G^s)) \rVert} \; \cdot \;
      \frac{\psi_i(\phi(G_{\pi}^t))}{\lVert \psi_i(\phi(G_{\pi}^t)) \rVert}$

    \FOR{$(p, q) \in \mathcal{M}$ such that $s_{p, q} > \tau$}
      \STATE $\hat{c} \gets \text{update\_class}(c^s_p, c^t_q)$
      \STATE $\hat{o} \gets (\hat{c}, \mathcal{A}^s_p \cup \mathcal{A}^t_q)$
      \STATE $\mathcal{O}^m \gets \{\hat{o}\} \cup \bigl(\mathcal{O}^m \setminus \{o^s_p, o^t_q\}\bigr)$
      \STATE \textbf{for each} $(o_x, o_y) \in \mathcal{E}^m$:
      \STATE \quad $(o_x, o_y) \mapsto 
        \begin{cases}
           (\hat{o}, o_y), & \text{if } o_x \in \{ o_p^s, o_q^t \}; \\
           (o_x, \hat{o}), & \text{if } o_y \in \{ o_p^s, o_q^t \}; \\
           (o_x, o_y), & \text{otherwise.}
        \end{cases}$
    \ENDFOR

    \STATE $\mathcal{Q} \gets \text{enqueue}(\mathcal{Q}, G^m)$
  \ENDWHILE

  \STATE $G_{\text{video}} \gets \text{dequeue}(\mathcal{Q})$
  \STATE \textbf{return} $G_{\text{video}}$

\end{algorithmic}
\end{algorithm}