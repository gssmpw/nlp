%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Completeness}
\label{sec:compl}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{The Finite Case.}
\label{sec:compl:fin}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Since the rule $\ax{F}$ assumes $I\neq \emptyset$,
it does not allow us to derive 
$(\psi \realto \False) \thesis \False$.
This sequent is sound only when $\I\psi \neq \emptyset$.
In \cite{abramsky91apal},
Abramsky introduced \emph{coprimeness predicates} %$\C$
which select those finite $\varphi$ with $\I\varphi \neq \emptyset$.
We extend our basic deduction system (Figure \ref{fig:log:ded} in \S\ref{sec:log})
with the predicate $\C$ and the rules in \eqref{eq:compl:cc} below.
Recall that $\pair{\varphi,\psi} = \form{\pi_1}\varphi \land \form{\pi_2}\psi$.
\begin{equation}
\label{eq:compl:cc}
\scalebox{.9125}{\text{$\begin{array}{c}

\dfrac{}{\C(\True)}

\quad

\dfrac
  {\text{$\BT \in \Base$ and $a \in \BT$}}
  {\C(\form a)}

\quad

\dfrac{\C(\varphi)}
  {\C(\form\fold \varphi)}

\quad

\dfrac{\C(\varphi) 
  \quad
  \C(\psi)}
  {\C(\pair{\varphi,\psi})}

\quad

\dfrac{\C(\psi)
  \quad
  \psi \thesis \varphi
  \quad
  \varphi \in \Lang_\land}
  {\C(\varphi)}
%~(\varphi \in \Lang_\land)
\\\\

\ax{C}
\dfrac{\C(\psi)}
  {(\psi \realto \False) \,\thesis\, \False}

\quad

\dfrac{\begin{array}{l}
  \text{$I$ finite and $\forall i \in I$,}~
  \C(\psi_i) 
  ~\text{and}~
  \C(\varphi_i) ;
  \\
  \text{$\forall J \sle I$,}~
  \bigwedge_{j \in J} \psi_j \thesis \False
  ~~\text{or}~~
  \C\left( \bigwedge_{j \in J} \varphi_j \right)
  \end{array}}
  {\C\left( \bigwedge_{i \in I}(\psi_i \realto \varphi_i) \right)}
%~(\text{$I$ finite})
\end{array}$}}
\end{equation}


\noindent
In contrast with \cite{abramsky91apal,bk03ic,ac98book},
our $\C$ is a consistency predicate rather than a coprimeness predicate.
Note that the clauses defining $\C$ are positive.%
\footnote{Compare with \cite[Figure 3]{bk03ic} and \cite[Figure 10.3]{ac98book}.}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{proposition}
\label{prop:compl:fin:ded}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
In the extension of Figure~\ref{fig:log:ded} (\S\ref{sec:log})
with \eqref{eq:compl:cc}:
\begin{enumerate}[(1)]
\item
for all $\varphi,\psi \in \Lang_\land(\PT)$,
we have
$\psi \thesis_\PT \varphi$
if, and only if,
$\I\psi \sle \I\varphi$;

\item
for all $\varphi \in \Lang_\land$,
we have
$\C(\varphi)$
if, and only if,
$\I\varphi \neq \emptyset$.
\end{enumerate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{proposition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\noindent
In particular, for each $\varphi \in \Lang_\land$,
either $\C(\varphi)$ or $\varphi \thesis \False$ is derivable.

A type is \emph{finite} if it only contains formulae $\varphi \in \Lang_\land$.
A typing context $x_1:\RTbis_1,\dots,x_n : \RTbis_n$
is finite if so are all $\RTbis_i$'s.
Completeness for finite types can be obtained
from minor adaptations to \cite{abramsky91apal}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{theorem}[Abramsky \cite{abramsky91apal}]
\label{thm:compl:fin}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Assume $\Env$ and $\RT$ are finite.
If $\Env \thesis M : \RT$ is sound,
then $\Env \thesis M : \RT$ is derivable in the system of \S\ref{sec:reft}
extended with \eqref{eq:compl:cc}.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{theorem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Well-Filteredness.}
\label{sec:wf}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Following~\cite{bk03ic},
completeness for types with infinitary formulae relies on the fact that
Scott domains are \emph{well-filtered} spaces.
The latter is stated in \cite[Corollary 7.1.11]{aj95chapter}
and \cite[Proposition 8.3.5]{goubault13book} as a consequence
of the Hofmann-Mislove (or Scott-open filter) Theorem.
It can also be obtained from \cite[Theorem 7.38]{gg24book}.
%
A subset $F$ of a poset $P$ is \emph{filtering} if $F$ is directed in $P^\op$.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{proposition}[Well-Filteredness]
\label{prop:wf}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Let $X$ be an algebraic dcpo,%
\footnote{More generally, this result holds for any sober space $X$
(with $\SP$ open in $X$).}
and let $\Filt$ be a set of compact saturated subsets of $X$.
If $\Filt$ is filtering in $\Po(X)$
and $\bigcap \Filt \sle \SP$ for some Scott-open $\SP$,
then $Q \sle \SP$ for some $Q \in \Filt$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{proposition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Proposition~\ref{prop:wf} yields the soundness of the following deduction rule.
\[
\ax{WF}~
\dfrac{\text{for all $i\in I$, $\psi_i \in \Lang_\land(\PTbis)$}
  \qquad
  \varphi \in \Lang_\Open(\PT)}
  {
  \left( \bigwedge_{i \in I} \psi_i \right)
  \realto
  \varphi
  \,\thesis\,
  \bigvee_{\text{$J \sle I$, $J$ finite}}
  \left(
  \left( \bigwedge_{j \in J} \psi_j \right)
  \realto
  \varphi
  \right)
  }
\]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lemma}
\label{lem:wf}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
The rule $\ax{WF}$ is sound.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Main Results.}
\label{sec:main}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Theorem~\ref{thm:main} below
gives sufficient conditions for the completeness of the system in \S\ref{sec:reft}
extended with \eqref{eq:compl:cc}.
%
This relies on Well-Filteredness (Proposition~\ref{prop:wf}),
but avoids the rule $\ax{WF}$.
Proofs of Lemma~\ref{lem:compl:nf} and Theorem~\ref{thm:main}
are given in Appendix \ref{sec:app:main}.
Motivations are discussed in \S\ref{sec:conc}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lemma}
\label{lem:compl:nf}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Given $\varphi,\psi \in \Norm(\PT)$,
if $\I\psi \sle \I\varphi$,
then $\psi \thesis_\PT \varphi$
is derivable in the extension of Figure~\ref{fig:log:ded} (\S\ref{sec:log})
with \eqref{eq:compl:cc}.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{definition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
A type is \emph{normal} if it is pure or 
$\reft{\PT \mid \varphi}$ with $\varphi \in \Norm(\PT)$.
A typing context $x_1:\RTbis_1,\dots,x_n : \RTbis_n$
is \emph{normal} if so are all $\RTbis_i$'s.

The \emph{first-order over normal forms} (\emph{fonf}) types
are generated by the grammar
\[
\begin{array}{r @{\ \ }c@{\ \ } l}
    \RT
&   \bnf
&   \RTbis
\gs \RT \times \RT
\gs \RTbis \arrow \RT
\end{array}
\]

\noindent
with $\RTbis$ normal.
%
A judgment $\Env \thesis M : \RT$ is \emph{normal}
if $\Env$ is normal and $\RT$ is fonf.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{definition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

We shall see that if $\Env \thesis M : \RT$ is sound and normal,
then it is derivable.
The idea is to reduce to the finite case (Theorem~\ref{thm:compl:fin})
by using Proposition~\ref{prop:wf},
but without using the rule $\ax{WF}$.
We first show that $\RT$ can be assumed to be normal.
To each normal judgment $\Env \thesis M : \RT$
we associate a set of normal judgments $\eta(\Env \thesis M : \RT)$.
We let
\(
  \eta\left(\Env \thesis M : \RT \right)
  \deq
  \left\{\Env \thesis M : \RT \right\}
\)
if $\RT$ is normal, and
\[
\begin{array}{r !{\quad\deq\quad} l}

  \eta\left(\Env \thesis M : \RT_1 \times \RT_2 \right)
& \eta\left(\Env \thesis \pi_1 M : \RT_1 \right)
  \cup
  \eta\left(\Env \thesis \pi_2 M : \RT_2 \right)
\\

  \eta\left(\Env \thesis M : \RTbis \arrow \RT \right)
& \eta\left( \Env, x: \RTbis \thesis M x : \RT \right)

\end{array}
\]

\noindent
Note that for each $(\Env' \thesis M' : \RT') \in \eta(\Env \thesis M : \RT)$,
the type $\RT'$ is normal.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{proposition}
\label{prop:main:eta}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
A normal judgment $\Env \thesis M : \RT$ is sound (resp.\ derivable)
if, and only if, so are all $(\Env' \thesis M' : \RT') \in \eta(\Env \thesis M : \RT)$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{proposition}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{theorem}[Main Result]
\label{thm:main}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
If $\Env \thesis M : \RT$ is sound and normal
then $\Env \thesis M : \RT$ is derivable in the system of \S\ref{sec:reft}
extended with \eqref{eq:compl:cc}.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{theorem}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


With the help of Examples \ref{ex:log:modalnf} and \ref{ex:log:distr},
the judgments for $\filter$, $\diag$
and $\bft$ in Table~\ref{tab:reft} (Example~\ref{ex:reft:fun})
can be assumed to be normal whenever so is $\varphi$.
Hence our Main Theorem~\ref{thm:main} applies and these
judgments are derivable 
in the system of \S\ref{sec:reft} extended with \eqref{eq:compl:cc},
but without the rule $\ax{WF}$.
This improves on \cite{jr21esop},
which does not handle $\filter$,
and which handles $\bft$ only when $\triangle$ is $\forall\Box$.

As for $\map$,
one has to assume that $\psi \in \Lang_\land$ (in addition to $\varphi \in \Norm$).
Recall from Lemma~\ref{lem:top:char} that
any formula is \emph{semantically} equivalent to a normal form.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{The General Case.}
\label{sec:compl:general}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Using $\ax{WF}$ and Example~\ref{ex:log:modalnf},
any formula is \emph{provably} equivalent to a $\psi \in \Norm$.
This yields the completeness result of Bonsangue \& Kok \cite{bk03ic}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{lemma}
\label{lem:compl:nf:wf}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
For each $\varphi \in \Lang(\PT)$, there is a $\psi \in \Norm(\PT)$
such that $\varphi \thesisiff \psi$
in the extension of Figure~\ref{fig:log:ded} (\S\ref{sec:log})
with \eqref{eq:compl:cc} and $\ax{WF}$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{lemma}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{corollary}[Bonsangue \& Kok \cite{bk03ic}]
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
If $\Env \thesis M : \RT$ is sound 
then $\Env \thesis M : \RT$ is derivable in the system of \S\ref{sec:reft}
extended with \eqref{eq:compl:cc} and $\ax{WF}$.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\end{corollary}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




