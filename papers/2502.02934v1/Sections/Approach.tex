\section{Proposed Approach}
\label{sec:approach}

In this section, we introduce the proposed approaches in this work, including the Gait-frequency Network, the Gait-Net-augmented 
kino-dynamics MPC formulation, and the sequential MPC solving mechanism.


\subsection{Gait-frequency Network}
\label{subsec:gaitnet}

Instead of relying on heuristics or solving an additional optimization problem to determine step frequency from the desired foot location, we propose a lightweight Gait-frequency Network that maps current state feedback and desired foot placement to the preferred step duration for the upcoming stride, seamlessly integrating with the MPC framework while co-optimizing the target variables. An illustration of the Gait-Net is shown in Fig.  \ref{fig:gaitnet}. 

\subsubsection{Data collection}
We begin by using a whole-body MPC as our baseline controller to collect variable-frequency walking data. Besides a more accurate representation of kinematics and dynamics of the robot model, this approach is chosen for two key reasons: first, whole-body MPC outperforms other simplified-model-based control methods under strong unknown disturbances \cite{dantec2024centroidal}. Second, we utilize a MATLAB-based high-fidelity simulation framework, bypassing real-time hardware constraints. This enables the use of a more precise and robust interior-point-method-based nonlinear programming solver at higher control frequencies. The primary objective of this stage is to gather high-resolution data using a robust control algorithm under controlled disturbances in simulation.

We ran 15 different sets of walking simulations that have a total period of 600 seconds of walking data with a small-size humanoid model in the simulation. In each set, we command the robot to walk at a constant velocity in the range of $[0,\:1]$ \unit{m/s}. At the beginning of each stride, we generate a randomized step duration between $[150,\:400]$ \unit{ms}. In the first half of the walking simulation, the robot is commanded to walk without any disturbances, while in the second half, we apply randomized external impulses to the CoM of the robot every 2 seconds with the magnitude of $[10,\:100]$ \unit{N} for a duration of 0.2 seconds. 

Despite the relatively small training dataset, the Gait-Net and MPC combination effectively handles various scenarios with predicted step durations, as demonstrated in Sec. \ref{sec:Results}.

\subsubsection{Latent space feature reduction}
The collected data initially includes the robot's floating-base state variables and world-frame foot locations for both legs ($\mathbb R^{16}$). However, not all features/states are equally deterministic in the CoM space to determine the output of the network. To streamline the feature space for more efficient inference in each iteration while maintaining accurate predictions of variable MPC sampling time, we apply Principal Component Analysis (PCA) to reduce the input features. Specifically, we select one feature with a high absolute loading from each of the top six principal axes, as these features are minimally correlated and capture the most significant variance in the feature space. Fig.  \ref{fig:PCA} illustrates the PCA loadings of all features across six principal axes.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Gait-Net-augmented Kino-dynamic MPC}
\label{subsec:gaitnetmpc}

\subsubsection{Motivation}
Given a fixed periodic contact sequence in MPC, one can vary the duration of each swing phase by altering the MPC sampling time $dt$ for the entire swing duration of each footstep made up of $h'$ MPC time steps. Hence the swing time $\Delta t = h'dt$. To achieve a variable-frequency walking MPC, we need to optimize the contact wrenches, contact locations, and MPC $dt$ all together.
In the discrete-time CD at time step $k$, 
\begin{equation}
\begin{aligned}
\label{eq:cd_discrete}
    \begin{bmatrix}
        \bm l_{G,k+1} \\ \bm k_{G,k+1}
    \end{bmatrix}
     = \begin{bmatrix}
        \bm l_{G,k} \\ \bm k_{G,k}
    \end{bmatrix} +
    \left[\begin{array}{c} 
    \sum_{i = 0}^{n_i}\bm f_i \\
    \sum_{i = 0}^{n_i}(\bm p_{f,i}-\bm p_c) \times \bm f_i + \bm \tau_i
    \end{array} \right]dt_k.
\end{aligned}
\end{equation}
Nonlinearity arises from the bilinear and multi-linear terms formed by the (cross) products of the three optimization variables.

In this section, we introduce a novel NN-augmented solving mechanism inspired by the popular SQP approach, allowing the MPC $dt$ to be concurrently determined by the Gait-Net alongside the optimization of other variables. 

\subsubsection{Implicit kinematics assurance in trajectory reference}
By selecting spatial momenta $\bm h$ and their primitive $\bm H$ (centroidal pose) as optimization variables, CD-MPC avoids including joint angles in the optimization process. However, generating these spatial reference trajectories still requires a corresponding whole-body joint space trajectory, which is a significant part of ensuring the kinematics feasibility of the optimization results. 
\begin{align}
    \bm h^\text{ref}_k = \bm A_G(\mathbf q^\text{ref}_k)\dot{\mathbf q}^\text{ref}_k,
\end{align}
\begin{equation}
\begin{aligned}
        \bm H^\text{ref}_k
        \approx \bm A_G(\mathbf q^\text{ref}_k)\mathbf q^\text{ref}_k - \sum^{k-1}_{i = 0} \dot{\bm A}_G(\mathbf q^\text{ref}_i,\dot{\mathbf q}^\text{ref}_i)\mathbf q^\text{ref}_i\:dt.
\end{aligned}
\end{equation}

Additionally, after obtaining the local foot location and CoM position trajectory solutions in each iteration, we perform a fast analytical inverse kinematics (IK) $f_\text{IK}$ to compute the corresponding joint trajectories for spatial momenta updates. The complete analytical IK and the approximation of $\bm H$ are provided in the Appendix. 

\remark{The spatial momentum and centroidal pose reference trajectories are updated in each sequential iteration to align with foot position updates, implicitly enforcing kinematic consistency in the reference trajectory. }


\subsubsection{Convex MPC Subproblem}
\label{subsubsec:cmpc}
To address the weak correlation between foot location and swing duration in the CD formulation, we integrate the proposed Gait-Net (Sec. \ref{subsec:gaitnet}) to predict the MPC sampling time at the beginning of each step based on the local foot and CoM location solutions at each sequential iteration. This process continues until the convergence condition is met. This also translates $dt$ from the optimization variable space to the parameter space for computation efficiency. 

\begin{figure}[!t]
\vspace{0.2cm}
    \center
    \includegraphics[clip, trim=4.5cm 12cm 4.1cm 12cm, width=1\columnwidth]{figures/bilinear_surf.pdf}
    \caption{{\bfseries Bilinear Envelope Approximation by Neglecting Search Direction Product $\delta a\cdot\delta b$.}}
    \label{fig:bisurf}
    \vspace{-0.2cm}
\end{figure}

To linearize the bilinearly constrained dynamics constraint (\ref{eq:cd_discrete}) in the kino-dynamics MPC problem. We take inspiration from the SQP solving mechanism and solve the search direction $\delta$ of the bilinear variables, 
\begin{align}
    \bm f_i = \bm f^j_i +  \delta \bm f_i, \:\: \bm \tau_i = \bm \tau^j_i +  \delta \bm \tau_i, \nonumber\\
    \bm p_{f,i} = \bm p^j_{f,i} +\delta \bm p_{f,i}, \:\: \bm p_{c} = \bm p^j_{c} +\delta \bm p_{c},
\end{align}
where the $j$ superscript denotes the total solution from the previous sequential iteration $j$. 
The dynamics evolution of the angular momentum can  be simplified with the assumption:
\begin{assumption}
    \textit{With reasonable warm-start/initialization of the bilinear variables $a_0,\: b_0$, the bilinear product of the search directions are minimal and negligible as the sequential iteration $j$ increases, $\delta a^j \cdot \delta b^j \approx 0$, illustrated in Fig.  \ref{fig:bisurf}.} 
    \label{assump2}
\end{assumption}

Therefore, at iteration $j+1$, 
\begin{align}
\label{eq:lG}
    \bm l_{G,k+1} & = \bm l_{G,k} + \sum_{i = 0}^{n_i}\bm f^j_i dt_k +  \delta \bm f_i dt_k
\end{align}
\begin{equation}
\allowdisplaybreaks
\begin{aligned}
    \label{eq:kG}
    \bm k_{G,k+1} & = \bm k_{G,k} + \sum_{i = 0}^{n_i}(\bm p^j_{f,i} - \bm p^j_c+\delta \bm p_{f,i}-\delta \bm p_c) \\ & \quad 
    \times (\bm f^j_i +  \delta \bm f_i)dt_k  + (\bm \tau^j_i + \delta \bm \tau_i)dt_k \\
    & = \bm k_{G,k} + \sum_{i = 0}^{n_i} \delta \bm \tau_i dt_k  -\bm f^j_i \times(\delta \bm p_{f,i}-\delta \bm p_c) dt_k \\ & \quad  
    +(\bm p^j_{f,i} - \bm p^j_c)\times \delta \bm f_i dt_k + 
    \underbrace{(\delta \bm p_{f,i}-\delta \bm p_c) \times \delta \bm f_i dt_k}_{\approx 0} \\ & \quad
     + \underbrace{(\bm p^j_{f,i} - \bm p^j_c)\times \bm f^j_i dt_k + \bm \tau^j_i dt_k}_\text{const.} 
\end{aligned}
\end{equation}
\remark{The linearization w.r.t. search directions $\delta$ and with \textit{Assumption} \ref{assump2} arrives mathematically identical to 1st-order Taylor expansion of bilinear constraints with the SQP algorithm \cite{boggs1995sequential}. }


\paragraph{Optimization Variables}
We choose the state variable to be the spatial momentum vector $\bm h$ and centroidal pose $\bm H$, and the control input variables to be the search directions of ground contact wrench, foot location, and MPC sampling time over a finite horizon $h$,
\begin{align}
    \bm {x} = \bigl\{ \bm H_{k};\: {\bm h}_{k}\bigr\}^{h}_{k=0}, \quad\quad\quad\quad\quad\\
    \bm {u} = \bigl\{\{\delta \bm f_{i,k},\: \delta \bm \tau_{i,k},\: \delta \bm p_{f,i,k}\}^{n_i}_{i=0},\:\delta \bm p_{c} \bigr\}^{h-1}_{k=0},
\end{align}

\paragraph{Objective Function}
The linearized finite horizon optimization problem can be formulated as 
\begin{alignat}{3}
    \label{eq:CDMPCcost2}
    \underset{\bm x^j, \bm {u}^j}{\text{min}} \: & \sum_{k = 0}^{h-1} \Bigg\| 
    \begin{bmatrix}
        \bm h_{k} \\ \bm H_{k} \\ \bm p^{j-1}_{f,k} +\delta \bm p_{f,k} \\ \bm p^{j-1}_{c,k} +\delta \bm p_{c,k}
    \end{bmatrix} -
    \begin{bmatrix}
        \bm h_{k}^{\text{ref}} \\ \bm H_{k}^{\text{ref}} \\ \bm p_{f,k}^{\text{ref}}\\ \bm p_{c,k}^{\text{ref}}
    \end{bmatrix}
    \Bigg\|^2 _{\bm L_1} \\ \nonumber & \quad +
    \Bigg\| \begin{bmatrix} 
    \bm f^{j-1}_i + \delta \bm f_i \\ \bm \tau^{j-1}_i  + \delta \bm \tau_i 
    \end{bmatrix} \Bigg\|^2 _{\bm L_2}
\end{alignat}
The objectives are to track spatial trajectories, foot reference trajectory, and CoM position trajectory while minimizing ground reaction wrenches. Note that the foot reference is constructed based on a preferred foot location through Gait-Net with a nominal MPC $dt$. This trajectory will be updated with each sequential iteration $j$ until convergence.
% \subsubsection{Constraints}
\paragraph{Linearized dynamics}
With \textit{Assumption} \ref{assump2} and search direction linearization in equation (\ref{eq:lG}-\ref{eq:kG}), we obtain the CD as a linear form with respect to our choice of control input and state variables. At time step $k$, the discrete dynamics is 
\begin{align}
\label{eq:cdlinear}
    \bm x_{k+1} = \mathbf A_k \bm x_{k} + \mathbf B_k \bm u_k + \mathbf C_k,
\end{align}
where $\mathbf A_k$ and $\mathbf B_k$ are the state space matrices. $\mathbf C_k$ contains only the constant terms shown in equation (\ref{eq:lG}-\ref{eq:kG}) in terms of optimization results obtained from the last sequential iteration $j-1$. By including a constant $1$ at the end of the state variables, $\bm x'_{k} = [\bm x_{k};\:1]$, we can then obtain the discrete dynamics in a linearized state-space form, as similarly outlined in \cite{di2018dynamic,chen2024learning}.

\paragraph{Linear momentum and CoM position}
The dynamics evolution of CoM position $\bm p_c$ is embedded in the linear momentum equation as an equality constraint:
\begin{align}
    \bm p^{j-1}_{c,k+1} +\delta \bm p_{c,k+1}  = \bm p^{j-1}_{c,k} +\delta \bm p_{c,k} + \frac{\bm l_{G,k}}{m}\:dt_k.
\end{align}

\paragraph{Friction pyramid}
The friction pyramid is a conservative approximation of the friction cone when the pyramid is inscribed, such that the pyramid friction coefficient is then approximated as 
\begin{align}
    \mu_{\Box} = \frac{\sqrt{2}}{2}\mu,
\end{align}
where $\mu$ is the actual ground friction coefficient. The linear inequality constraint is
\begin{align}
    \nonumber 
    -\mu_{\Box}  ({f}_{i,z}^{j-1}+\delta f_{i,z}) \leq  \big\{({f}_{i,x}^{j-1}+\delta f_{i,x}), 
    \: ({f}_{i,y}^{j-1}+\delta f_{i,y})\bigr\} \\
    \leq \mu_{\Box}  ({f}_{i,x}^{j-1}+\delta f_{i,x}) \quad \quad
    \label{eq:frictionCons}
\end{align}

\paragraph{Contact-switching Constraints}
For periodic walking gait, we use a binary contact schedule $\bm \sigma \in \mathbb R^{n_i\times h}$ to describe the contact switches for each contact point $i$. Hence, the ground reaction wrench can be switched on or off based on whether a leg is in swing or stance, 
\begin{align}
    \label{eq:contactConstraint1}
     \sigma_{i,k}
    \begin{bmatrix}
        \bm f_\text{min} \\ \bm \tau_\text{min} 
    \end{bmatrix} \leq
    \begin{bmatrix}
        \bm f^{j-1}_i + \delta \bm f_i \\ \bm \tau^{j-1}_i  + \delta \bm \tau_i
    \end{bmatrix} \leq 
    \sigma_{i,k}
    \begin{bmatrix}
        \bm f_\text{max} \\ \bm \tau_\text{max} 
    \end{bmatrix}  
\end{align}
In addition to the control input saturation, we also enforce stationary foot location for each footstep while the contact schedule $\sigma_{i,k} = 1$ for contact point $i$.

\paragraph{Dynamic Range of Foot location}
With the future foot location as part of the optimization variables, the constraints can be directly applied with only one-step preview data in discrete terrain - the bounds of the foot location are dependent on the position of the robot,  
\begin{align}
    \bm p_{f,\text{min}}(\bm p_c) \leq \bm p^{j-1}_{f,k} +\delta \bm p_{f,k} \leq \bm p_{f,\text{max}}(\bm p_c)
    \label{eq:KDfoot}
\end{align}
A visualization of the constraint-triggering conditions is illustrated in Fig. \ref{fig:footlocation}. 

\input{Sections/algo}
\subsubsection{Gait-Net-augmented Sequential MPC Algorithm}
Algorithm \ref{alg:gaitMPC} outlines the procedure for solving the proposed kino-dynamic MPC with sequential CMPC subproblems and Gait-Net. 

In the initialization stage (1-4), $f_\text{j2m}$ describes the mapping from joint-space general-coordinate states to spatial momenta. $f_\text{ref}$ construct a reference trajectory in generalized coordinate with a nominal sampling duration $dt^0$. Within the sequential CMPC iterations (5-11), the iteration is terminated until reached max iteration $j_\text{max}$ or the search direction reaches the desired tolerance $\bm \eta$. In each iteration, the CMPC subproblem described in \ref{subsubsec:cmpc} is solved via QP; the MPC sampling time is updated through Gait-Net policy $\Pi_\text{GN}$. Subsequently, the reference trajectories are updated to reflect the latest foot location and MPC $dt$. 

%%%%%%%%%%%%%% performance comparison %%%%%%%%%%%%%%%%
\begin{figure}[!t]
\vspace{0.2cm}
     \centering
     \begin{subfigure}[b]{0.5\textwidth}
         \centering
	   \includegraphics[clip, trim=0cm 10.4cm 7.4cm 0cm, width=1\columnwidth]{figures/comparison1_3.pdf}
          \caption{Baseline 1: Fixed step duration for every step.}
          \vspace{0.2cm}
          \label{fig:comp1_3}
     \end{subfigure}
     \begin{subfigure}[b]{0.5\textwidth}
        \includegraphics[clip, trim=0cm 11cm 7.4cm 0cm, width=1\columnwidth]{figures/comparison1_1.pdf}
	\caption{Baseline 2: Solving step duration as part of optimization variables in NMPC.}
        \vspace{0.2cm}
	\label{fig:comp1_1}
     \end{subfigure}
     \begin{subfigure}[b]{0.5\textwidth}
         \centering
	   \includegraphics[clip, trim=0cm 10cm 7.4cm 0cm, width=1\columnwidth]{figures/comparison1_2.pdf}
          \caption{Proposed: Gait-Net-augmented Kino-dynamic MPC.}
          \vspace{0.4cm}
          \label{fig:comp1_2}
     \end{subfigure}
     \begin{subfigure}[b]{0.48\textwidth}
         \centering
	   \includegraphics[clip, trim=0cm 3cm 0cm 0cm, width=1\columnwidth]{figures/mpcdt_comparison.pdf}
          \caption{Comparison of MPC $dt$ (interpreted as step duration).}
          % \vspace{0.1cm}
          \label{fig:dt_comp}
     \end{subfigure}
     \caption{{\bfseries{Comparison of Discrete Terrain Locomotion Performance in 2D Simulation.}} }
        \label{fig:comp1}
\end{figure}

%%%%%%%%%%%%%%%% 3D simulation %%%%%%%%%%%%%
\begin{figure*}[!t]
\vspace{0.2cm}
		\center
		\includegraphics[clip, trim=0cm 12cm 0.2cm 0cm, width=2\columnwidth]{figures/foot_location_snap.pdf}
		\caption{{\bfseries Locomotion over 3-D Stepping-stone Terrain.} Simulation snapshots (left) and plot of measured foot locations (right). In the plot, only foot locations that are on the ground are visualized. The green dashed-line bounding box represents the CoM position threshold that triggers the foot location constraints for the corresponding stepping stone patch.}
		\label{fig:footlocation}
		\vspace{-0.2cm}
\end{figure*}
\begin{figure*}[!t]
\vspace{-0.1cm}
		\center
		\includegraphics[clip, trim=0cm 11.3cm 0.2cm 0cm, width=1.9\columnwidth]{figures/h_tracking2.pdf}
		\caption{{\bfseries Spatial Momenta Measurement vs. MPC Prediction along $l_{G,x},\:k_{G,y},\:$and $k_{G,z}$ of 3-D Stepping-stone Simulation Results.}}
		\label{fig:h_tracking}
		\vspace{-0.2cm}
\end{figure*}

\remark{As the sequential iteration progresses, the reference trajectories $\{ \bm x^\text{ref},\:\bm p_f^\text{ref}\}$ are continuously updated to match closely to the real spatial momentum and pose trajectories based on the latest kinematics results. This process inherently embeds an \textit{implicit kinematics assurance} within the framework.}

\remark{The Gait-Net-augmented kino-dynamic MPC is run at the beginning of each footstep to determine a local step duration in terms of MPC $dt$. The rest of this footstep will incorporate the same $dt$ without the inference of Gait-Net and solve only the contact location and wrenches.}