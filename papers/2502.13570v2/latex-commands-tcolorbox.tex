\newif\iffancyversion
\fancyversiontrue
\ificml\fancyversionfalse\fi

\usepackage{etoolbox}
\usepackage[most]{tcolorbox}
\usepackage{xstring} % to check substring for conditional arg

\newcommand\tcbltextmargin{5mm}
\newcommand\tcblmargin{2mm}
\newcommand\belowtitleskip{2em}

\definecolor{customBlue}{RGB}{18,75,126}
\colorlet{titleCol}{customBlue}	% for lemmas, proofs etc.
\colorlet{titleThmCol}{titleCol} % for theorems
%%% auto
\colorlet{backCol}{titleCol!08!white}
\colorlet{backThmCol}{titleThmCol!08!white}

\tcbset{ 
  compactdefaultstyle/.style={
    use color stack, 
	breakable,
	theorem style=plain,
	%terminator sign={.},  % End of title, before the content of the box (to separate because it's inlined)
	enhanced,
	sharp corners,
	frame hidden,
	colback=backCol,
	opacityfill=0, 
	fontupper=\itshape,
	fonttitle=\bfseries\upshape,
		%coltitle=blue, %titleCol,
		%after title={.},
		%separator sign={:\ }, 
	coltitle=black, 
	boxrule=0pt,
	before skip=1mm,
	after skip=1mm,
	right = 0mm, 
	left = -1mm, 
	top = 0mm,
	bottom = 0mm,
  },
  defaultthmstyle/.style={
    use color stack, 
	breakable,
	theorem style=plain,
	%terminator sign={.},  % End of title, before the content of the box (to separate because it's inlined)
	enhanced,
	sharp corners,
	frame hidden,
	colback=backCol,
	opacityfill=0, 
	fontupper=\itshape,
	fonttitle=\bfseries\upshape,
		%coltitle=blue, %titleCol,
		%after title={.},
		%separator sign={:\ }, 
	coltitle=black, 
	boxrule=0pt,
	before skip=2mm,
	after skip=2mm,
	right = 0mm, 
	left = -1mm, 
	top = 1mm,
	bottom = 1mm,
  },
  defaultproofstyle/.style={
    use color stack, 
	breakable,
	theorem style=plain,
	terminator sign={.},  % End of title, before the content of the box (to separate because it's inlined)
	enhanced,
	sharp corners,
	frame hidden,
	colback=backCol,
	opacityfill=0, 
	fontupper=\upshape,
	fonttitle=\itshape,
	%coltitle=blue, %titleCol,
	%after title={.},
	separator sign={:\ }, 
	coltitle=black, 
	boxrule=0pt,
	before skip=2mm,
	after skip=2mm,
	right = 0mm, 
	left = -1mm, 
	top = 1mm,
	bottom = 1mm,
  },
  proofstyle/.style={
    use color stack, 
	breakable,
	enhanced,
	theorem style=plain,
	frame hidden,
	sharp corners,
	colback=backCol,
	boxrule=0pt,
	before skip=2mm,
	after skip=2mm,
	right = 2mm, 
	borderline west={0.4mm}{0pt}{titleCol},
	fonttitle=\bfseries,
	coltitle=titleCol,
	%before upper app={\setlength{\parindent}{1em}},
	%before upper=\setlength{\parindent}{1em}\everypar{{\setbox0\lastbox}\everypar{}},
  }, 
  bluewestlinestyle/.style={
    use color stack, 
	breakable,
	theorem style=plain,
	enhanced,
	sharp corners,
	frame hidden,
	colback=black!03!white,
	coltitle=customBlue,
	boxrule=0pt,
	borderline west={0.8mm}{0pt}{customBlue},
	fonttitle=\upshape\bfseries\hypersetup{citecolor=customBlue,linkcolor=customBlue},
	%fontupper=\upshape,
	before skip=2mm,
	after skip=2mm,
	left = 3mm, 
	right = 2mm, 
% Compactify
	%opacityfill=0, 
	%bottom=0mm, 
	%top=0mm, 
	%toptitle=0mm,
	%bottomtitle=0mm,
  },
  redvioletwestlinestyle/.style={
    use color stack, 
	breakable,
	theorem style=plain,
	enhanced,
	sharp corners,
	frame hidden,
	colback=black!03!white,
	coltitle=RedViolet,
	boxrule=0pt,
	borderline west={0.8mm}{0pt}{RedViolet},
	fonttitle=\upshape\bfseries\hypersetup{citecolor=RedViolet,linkcolor=RedViolet},
	%fontupper=\upshape,
	before skip=2mm,
	after skip=2mm,
	left = 3mm, 
	right = 2mm, 
	%before upper app={\setlength{\parindent}{1em}},
% Compactify
	%opacityfill=0, 
	%bottom=0mm, 
	%top=0mm, 
	%toptitle=0mm,
	%bottomtitle=0mm,
	%right = 0mm, 
  },
  greenwestlinestyle/.style={
    use color stack, 
	breakable,
	theorem style=plain,
	enhanced,
	sharp corners,
	frame hidden,
	colback=black!03!white,
	coltitle=ForestGreen,
	boxrule=0pt,
	borderline west={0.8mm}{0pt}{ForestGreen},
	fonttitle=\upshape\bfseries\hypersetup{citecolor=ForestGreen,linkcolor=ForestGreen},
	%fontupper=\upshape,
	before skip=2mm,
	after skip=2mm,
	left = 3mm, 
	right = 2mm, 
	%before upper app={\setlength{\parindent}{1em}},
% Compactify
	%opacityfill=0, 
	%bottom=0mm, 
	%top=0mm, 
	%toptitle=0mm,
	%bottomtitle=0mm,
	%right = 0mm, 
  },
}

\tcbset{todobox/.style={
  title={Some work is needed here}, 
  colframe=red!70!black,
  colback=red!10,
  fonttitle=\bfseries, 
  coltext=red!70!black, 
  breakable,
  boxed title style={
    %colback=blue,
    outer arc=0pt,
    arc=0pt,
    top=0pt,
    bottom=0pt,
    },
  }
}

\tcbset{warnbox/.style={
  colframe=black,
  colback=yellow!20,
  breakable,
  boxed title style={
    %colback=blue,
    outer arc=0pt,
    arc=0pt,
    top=0pt,
    bottom=0pt,
    },
  }
}
\tcbset{infobox/.style={
  colframe=blue,
  colback=blue!05,
  breakable,
  boxed title style={
    %colback=blue,
    outer arc=0pt,
    arc=0pt,
    top=0pt,
    bottom=0pt,
    },
  }
}

%\newtheorem{assumption}[theorem]{Assumption}
%\newtheorem{remark}{Remark}

% To fix pb with line numbering from the template (from https://tex.stackexchange.com/questions/675711/lineno-iteracts-badly-with-tcolorbox)
\makeatletter
\def\@LN@depthbox{%
  \ifdim\@tempdima = -1000pt
  % \nointerlineskip is already set so we don't need set it again (and we shouldn't back up)
  \else
    \dp\@tempboxa=\@tempdima
    \nointerlineskip \kern-\@tempdima 
  \fi
  \box\@tempboxa
  } 
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\iffancyversion

% Names ending with "b" have a corresponding environment without "b" defined below.
\newtcbtheorem[crefname={theorem}{theorems},Crefname={Theorem}{Theorems},number within=section]{ttheoremb}{Theorem}{bluewestlinestyle}{r}
\newtcbtheorem[crefname={lemma}{lemmas},Crefname={Lemma}{Lemmas},use counter from=ttheoremb]{tlemmab}{Lemma}{bluewestlinestyle}{r}
\newtcbtheorem[crefname={corollary}{corollaries},Crefname={Corollary}{Corollaries},use counter from=ttheoremb]{tcorollaryb}{Corollary}{bluewestlinestyle}{r}
\newtcbtheorem[crefname={proof}{proofs},Crefname={Proof}{Proofs},number within=section]{tproof}{Proof}{redvioletwestlinestyle}{p}
%
\newtcbtheorem[crefname={proposition}{propositions},Crefname={Proposition}{Propositions},use counter from=ttheoremb]{tprop}{Proposition}{bluewestlinestyle}{r}
\newtcbtheorem[crefname={assumption}{assumptions},Crefname={Assumption}{Assumptions},use counter from=ttheoremb]{tassumption}{Assumption}{greenwestlinestyle}{a}
\newtcbtheorem[crefname={remark}{remarks},Crefname={Remark}{Remarks},number within=section, ]{tremark}{Remark}{greenwestlinestyle}{rm}
\newtcbtheorem[crefname={example}{examples},Crefname={Example}{Examples},number within=section,]{texample}{Example}{greenwestlinestyle}{ex}
\newtcbtheorem[crefname={definition}{definitions},Crefname={Definition}{Definitions},number within=section]{tdefinition}{Definition}{bluewestlinestyle}{d}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\else

\newtcbtheorem[crefname={theorem}{theorems},Crefname={Theorem}{Theorems},number within=section]{ttheoremb}{Theorem}{defaultthmstyle}{r}
\newtcbtheorem[crefname={lemma}{lemmas},Crefname={Lemma}{Lemmas},use counter from=ttheoremb]{tlemmab}{Lemma}{defaultthmstyle}{r}
\newtcbtheorem[crefname={corollary}{corollaries},Crefname={Corollary}{Corollaries},use counter from=ttheoremb]{tcorollaryb}{Corollary}{defaultthmstyle}{r}
\newtcbtheorem[crefname={proposition}{propositions},Crefname={Proposition}{Propositions},use counter from=ttheoremb]{tprop}{Proposition}{defaultthmstyle}{r}
\newtcbtheorem[crefname={proof}{proofs},Crefname={Proof}{Proofs},number within=section]{tproof}{Proof}{defaultproofstyle}{p}
%
\newtcbtheorem[crefname={remark}{remarks},Crefname={Remark}{Remarks},number within=section, ]{tremark}{Remark}{defaultthmstyle}{rm}
\newtcbtheorem[crefname={assumption}{assumptions},Crefname={Assumption}{Assumptions},use counter from=ttheoremb, ]{tassumption}{Assumption}{compactdefaultstyle}{a}
\newtcbtheorem[crefname={example}{examples},Crefname={Example}{Examples},number within=section,]{texample}{Example}{compactdefaultstyle}{ex}
\newtcbtheorem[crefname={definition}{definitions},Crefname={Definition}{Definitions},number within=section]{tdefinition}{Definition}{compactdefaultstyle}{d}

\fi

%\newenvironment{tproofof*}[2]{
%\begin{tproof*}[title={Proof of \Cref{#1}:}]{}{#2}
%}{
%\null\hfill$\square$
%\end{tproof*}
%}


\iffancyversion
	% Macro that adds a link "Go to proof" only if the reference passed as argument is valid.
	\makeatletter
	\newcommand\linktoproofifdef[1]{%
	  \@ifundefined{r@#1}{}{%
	\null\hfill\hyperref[#1]{\color{customBlue}{($â†’$ Proof)}}%
	  }%
	}
	\makeatother
\else
	\newcommand\linktoproofifdef[1]{}
\fi

\newif\ifnolinkoption
\NewDocumentEnvironment{tlemma}{omm}{
\IfValueTF{#1}{\IfSubStr{#1}{n}{\nolinkoptiontrue}{\nolinkoptionfalse}
}{ \nolinkoptionfalse }
\begin{tlemmab}[%
	% Add a link "go to proof" only if optional [nolink] has not been provided
	after upper={\ifnolinkoption{}\else{\linktoproofifdef{p:r:#3}}\fi},
	]{#2}{#3}	% #2 is title, %3 is the label
}{
\end{tlemmab}
}
\NewDocumentEnvironment{ttheorem}{omm}{
\IfValueTF{#1}{\IfSubStr{#1}{n}{\nolinkoptiontrue}{\nolinkoptionfalse}
}{ \nolinkoptionfalse }
\begin{ttheoremb}[%
	% Add a link "go to proof" only if optional [nolink] has not been provided
	after upper={\ifnolinkoption{}\else{\linktoproofifdef{p:r:#3}}\fi},
	]{#2}{#3}	% #2 is title, %3 is the label
}{
\end{ttheoremb}
}
\NewDocumentEnvironment{tcorollary}{omm}{
\IfValueTF{#1}{\IfSubStr{#1}{n}{\nolinkoptiontrue}{\nolinkoptionfalse}
}{ \nolinkoptionfalse }
\begin{tcorollaryb}[%
	% Add a link "go to proof" only if optional [nolink] has not been provided
	after upper={\ifnolinkoption{}\else{\linktoproofifdef{p:r:#3}}\fi},
	]{#2}{#3}	% #2 is title, %3 is the label
}{
\end{tcorollaryb}
}

\iffancyversion
	\newenvironment{tproofof*}[1]{
	\begin{tproof}[title={Proof of \Cref{#1}:}]{}{#1}
	}{
	\end{tproof}
	}
\else
	\newenvironment{tproofof*}[1]{
	\begin{tproof}[title={Proof of \Cref{#1}:}]{}{#1}
	}{%
\iffancyversion\else\qed\fi%
%\null\hfill$\blacksquare$%
\end{tproof}
	}
\fi
