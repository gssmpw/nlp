
\documentclass{article} % For LaTeX2e
\usepackage{iclr2025_conference,times}

% Optional math commands from https://github.com/goodfeli/dlbook_notation.
\input{math_commands.tex}

\usepackage{hyperref}
\usepackage{url}
\usepackage[capitalize,noabbrev]{cleveref}


\usepackage{tikz}
\usetikzlibrary{shapes.geometric}

\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{physics}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{wrapfig}
\usepackage{booktabs}
\usepackage{comment}
\usepackage{subcaption}
% MACROS

\newcommand{\pr}[1]{\left(#1 \right)} %for () that scale
\newcommand{\br}[1]{\left[#1 \right]} %for [] that scale
\newcommand{\cbrace}[1]{\left\{#1 \right\}} % for {} that scale
\newcommand{\avg}[1]{\braket{#1}} % for average
\newcommand{\sgn}[1]{\text{sgn} \left( #1 \right)}
\newcommand{\mc}[1]{\mathcal{#1}}

\renewcommand{\d}[3][]{\frac{\mathrm{d}^{#1} #2}{\mathrm{d} #3^{#1}}} % for derivatives
\newcommand{\pd}[2]{\frac{\partial #1}{\partial #2}} % for partial derivatives
\newcommand{\pdd}[2]{\frac{\partial^2 #1}{\partial #2^2}} % for double partial derivatives
\newcommand{\pdc}[3]{\left( \frac{\partial #1}{\partial #2}
 \right)_{#3}} % for thermodynamic partial derivatives
\newcommand{\diff}{\mathrm{d}}
\newcommand{\dr}[1][]{\diff^3 r{#1} \ }

\let\vaccent=\v % rename builtin command \v{} to \vaccent{}
\renewcommand{\v}[1]{\ensuremath{\mathbf{#1}}} % for vectors
\newcommand{\gv}[1]{\ensuremath{\mbox{\boldmath$ #1 $}}} % for vectors of Greek letters
\newcommand{\uv}[1]{\ensuremath{\mathbf{\hat{#1}}}} % for unit vector
\newcommand{\te}[1]{\tensor{#1}}
\newcommand{\pvec}[1]{\vec{#1}\mkern2mu\vphantom{#1}'}
\newcommand{\trb}[1]{\mathrm{Tr}\br{#1}}

\newcommand{\irow}[1]{% inline row vector
  \begin{smallmatrix}\br{\,#1\,}\end{smallmatrix}%
}

\newcommand\sr[1]{\noindent{\color{red} {\bf \fbox{Siamak}} {\it#1}}}
\newcommand{\siba}[1]{{{\textcolor{teal}{\textbf{(Siba:} {#1}\textbf{)}}}}}



% \title{SymmCD: Scalable Diffusion Model for\\ Generating Symmetric Crystals}
\title{SymmCD: Symmetry-Preserving Crystal\\ Generation with Diffusion Models}


% Authors must not appear in the submitted version. They should be hidden
% as long as the \iclrfinalcopy macro remains commented out below.
% Non-anonymous submissions will be rejected without review.

\author{%
  Daniel Levy\thanks{Equal Contribution. Correspondence to: \texttt{daniel.levy6@mail.mcgill.ca}} $^{ 1,2}$, Siba Smarak Panigrahi$^{*1,2,3}$, Sékou-Oumar Kaba$^{* 1,2}$, \\ \textbf{Qiang Zhu$^{4}$, Kin Long Kelvin Lee$^{5}$, Mikhail Galkin$^{5}$, }\\ \textbf{Santiago Miret$^{5}$, Siamak Ravanbakhsh$^{1,2}$} \\
$^{1}$McGill University, $^{2}$Mila, $^{3}$École Polytechnique Fédérale de Lausanne (EPFL), \\$^{4}$University of North Carolina at Charlotte, $^{5}$Intel Labs
}

% The \author macro works with any number of authors. There are two commands
% used to separate the names and addresses of multiple authors: \And and \AND.
%
% Using \And between authors leaves it to \LaTeX{} to determine where to break
% the lines. Using \AND forces a linebreak at that point. So, if \LaTeX{}
% puts 3 of 4 authors names on the first line, and the last on the second
% line, try using \AND instead of \And before the third author name.

\newcommand{\fix}{\marginpar{FIX}}
\newcommand{\new}{\marginpar{NEW}}

\iclrfinalcopy % Uncomment for camera-ready version, but NOT for submission.
\begin{document}


\maketitle

\begin{abstract}
Generating novel crystalline materials has the potential to lead to advancements in fields such as electronics, energy storage, and catalysis.
The defining characteristic of crystals is their symmetry, which plays a central role in determining their physical properties.
However, existing crystal generation methods either fail to generate materials that display the symmetries of real-world crystals, or simply replicate the symmetry information from examples in a database. 
To address this limitation, we propose SymmCD\footnote{ Our code is publicly available at \url{https://github.com/sibasmarak/SymmCD/}}, a novel diffusion-based generative model that explicitly incorporates crystallographic symmetry into the generative process.
We decompose crystals into two components and learn their joint distribution through diffusion: 1) the asymmetric unit,  the smallest subset of the crystal  which can generate the whole crystal through symmetry transformations, and; 2) the symmetry transformations needed to be applied to each atom in the asymmetric unit. We also use a novel and interpretable representation for these transformations, enabling generalization across different 
crystallographic symmetry groups.
We showcase the competitive performance of SymmCD on a subset of the Materials Project,
obtaining diverse and valid crystals with realistic symmetries and predicted properties.




\end{abstract}

\section{Introduction}
Crystals serve as the fundamental building blocks of many materials, and the discovery of new crystalline materials is expected to lead to diverse technological breakthroughs in fields ranging from energy storage to computing hardware \citep{miret2024perspective}. Generative models have the potential to greatly accelerate this process by proposing new candidates materials, and possibly conditioning on desired properties or compositions. 

The defining characteristic of crystals is their symmetry. These symmetries are Euclidean transformations that map the crystal structure back to itself. They can in general be some specific translations, rotations, reflections and combinations of these. The set of these operations is called the \textit{space group} of the crystal. It is known that space groups in three dimensions fall into 230 distinct classes \citep{hahn1983international}. The symmetry of a crystal plays a crucial role in determining its stability along with its thermodynamic, electronic and mechanical properties \citep{nye1985physical}. A classic example is given by piezoelectricity, the ability of a material to generate an electric dipole under mechanical stress, which can only be manifested in materials lacking inversion symmetry.

Importantly, many of the recently proposed generative models for crystals do not generate samples with non-trivial symmetry: for example, the most frequently generated crystals by DiffCSP \citep{jiao2023crystal} and CDVAE \citep{xie2022crystal} are in the low-symmetry P1 space group, which is very rare in nature. MatterGen \citep{zeni2023mattergen} can generate crystals conditioned on a desired space group for space groups that are highly represented in the dataset, but they only recover the target space group roughly 20\% of the time, dropping to about 10\% for more symmetric space groups. \cite{cheetham2024artificial} analyse the space groups of the stable crystal structures proposed by the GNoME model of \cite{merchant2023scaling}, finding that the top 4 most commonly generated space groups account for 34\% of all generated crystals, even though each of those 4 space groups appears in less than 1\% of crystals in the Inorganic Crystal Structure Database \citep{hellenbrandt2004inorganic}.

\begin{figure}[t]
    \centering
    \vspace{-3ex}
    \includegraphics[width=0.90\linewidth]{images/champions_anotated.pdf}
    \caption{\textbf{Illustration of the SymmCD method.} \emph{Left.} Representation of the unit cell of a 2D crystal with $p4m$ symmetry where the asymmetric unit and the site symmetries of the atoms are highlighted. Leveraging symmetry results in a much more compact, yet complete representation. \emph{Right.} Diffusion and denoising on the different components of the representation. For site symmetries and atom types, discrete diffusion is used. For the coordinate and asymmetric unit continuous diffusion is used. The diffusion and denoising processes preserve the space group symmetry.}
    \label{fig:champion}
\end{figure}

In this work, we propose a novel approach for generative modeling of inorganic crystals that ensures any desired distribution of space groups.
The idea is similar to that of creating a paper snowflake, where we fold the paper to create an unconstrained space, and after an unconstrained cutting of the paper in this space, its unfolding creates an object with desired symmetries. In the context of crystals, the unconstrained space is called the \emph{asymmetric unit}, which is a maximal subset of the unit cell with no redundancy. To unfold the asymmetric unit, we need to generate the site symmetry of each atom inside the unit, i.e. the symmetry transformations that fix the atoms in place. In our generative process, the atomic positions are made consistent with generated site symmetries, enabling the unfolding of an asymmetric unit into a symmetric crystal; see \cref{fig:champion}.

Crystals and their individual atoms have many different types of symmetries,  so we need to address the issue of data-fragmentation.
By representing symmetry information using standard crystallographic notations, such as Hermann–Mauguin notation or Wyckoff position labels \citep{hahn1983international}, we are faced with many crystals and site symmetries that have a low frequency in the training data. To address this problem, we introduce a novel representation of symmetries as binary matrices, which enables information-sharing and generalization across both crystal and site symmetries.


The main contributions of this work are as follows:
\textbf{I)} We demonstrate a novel approach to generating crystals through the unconstrained generation of asymmetric units, along with their symmetry information. 
\textbf{II)} We introduce a physically-motivated representation for crystallographic site symmetries that generalizes across space groups. 
\textbf{III)} We experimentally evaluate our method, finding that it performs on par with previous methods at generating stable structures, while offering significantly improved computational efficiency due to our representation.
\textbf{IV)} We analyse the symmetry and diversity of crystal structures generated by existing generative models.


\section{Related Work}
There has been a growing body of work in developing machine-learning methods for crystal structure modeling, including the development of datasets and benchmarks \citep{jain2013commentary,saal2013materials,chanussot2021open, miret2023the, lee2023matsciml,choudhary2024jarvis}. Recent work has also focused on developing
architectures that are equivariant to various symmetries \citet{duval2023hitchhiker} or are specifically designed to include inductive biases useful for crystal structures \citep{xie2018crystal,kaba2022equivariant, goodall2022,yan2022periodic,yan2024space}.

In addition to structure-based modeling, prior work has also generated full-atom crystal structures, in which all atoms of the three-dimensional structure are generated.
A range of generation methods including VAEs \citep{noh2019inverse,xie2022crystal}, GANs \citep{nouira2018crystalgan,kim2020generative}, reinforcement learning \citep{govindarajan2023learning}, diffusion models \citep{zeni2023mattergen, yang2023scalable,jiao2023crystal,klipfel2024vector}, flow-matching models \citep{millerflowmm}, and active learning based discovery \citep{merchant2023scaling} have been used.
 These follow similar works in 3D molecule generation \citep{hoogeboom2022equivariant, garcia2021n,  xu2022geodiff}, but extend them by incorporating crystal periodicity.
In addition to full-atom crystal generation, prior work has also applied text-based methods to understand and generate crystals using language models \citep{flam2023language,gruverfine, alampara2024mattext}.

Other works have pointed out the importance of symmetry of the generated structures. DiffCSP++ \citep{jiao2024space}, does so by using predefined structural templates from the training data and learning atomic types and coordinates compatible with the templates. While this is an interesting solution, we show that predefining the templates in this way severely limits the diversity and novelty of the generated samples. CrystalGFN \citep{ai4science2023crystal} incorporates constraints on the lattice parameters and composition based on space groups but does not guarantee that the atomic positions respect the desired symmetry. Finally, the concurrent works CrystalFormer \citep{cao2024space} and WyCryst 
\citep{zhu2024wycryst}  generate symmetric crystals by predicting atom symmetries. However, they directly use the labels of Wyckoff positions to encode symmetries, which does not enable generalization across groups. The methods are therefore limited to generating from space groups that are common in the dataset. By contrast, our method generalizes across groups and can generate valid crystals even from groups that are rare in the dataset.


\section{Background}
\label{sec:background}
\paragraph{Lattices and unit cells} 
Crystals are macroscopic atomic systems characterized by a periodic structure. A crystal can be described as an infinite 3-dimensional \textit{lattice} of identical \textit{unit cells}, each containing atoms in set positions.
We can represent a crystal with the tuple $\gC = (\rmL, \rmX, \rmA)$, where  $\rmL = (\rvl_1, \rvl_2, \rvl_3) \in \R^{3 \times 3}$ is a matrix of \emph{lattice vectors}, $\rmX \in [0,1)^{3 \times N}$ represents the \emph{fractional} coordinates of $N$ atoms within a unit cell, and $\rmA \in \{0,1\}^{Z \times N}$ is a matrix of one-hot vectors of $Z$ possible elements for each atom.
The lattice describes the tiling of unit cells: the cartesian coordinates of atoms can be given by $\rmX^c = \rmL \rmX$, and if $\rvx_i^c$ is the cartesian coordinate of an atom in a unit cell, then the crystal will also contain an identical atom at $\rvx_i^c + \rmL \vj, \forall \vj \in \mathbb{Z}^{3}$.

\paragraph{Crystal symmetries} 
In addition to the translational symmetry of the lattice, crystals typically have many other symmetries.
Understanding these symmetries is fundamental in characterizing crystals and directly relates to many of the properties of these materials.
The \textit{space group} $G$ of a crystal is the group of all Euclidean transformations that leave the crystal invariant, i.e., that simply permutes atoms of the same type. As space groups are subgroups of the Euclidean group, their elements can be represented as $\pr{\v{O}, \v{t}}$, where $\v{O} \in O\pr{n}$ and $\v{t} \in \mathbb{R}^3$, with action on $\v{x}\in \mathbb{R}^3$ defined as $\pr{\v{O}, \v{t}} \v{x} = \v{O} \v{x} + \v{t}$.
The operations that are part of a space group can be generally understood as belonging to different types: translations, rotations, inversions, reflections, screw axes (combinations of rotations and translations), and glide planes (combinations of mirroring and translation).

Two space groups belong to the same \textit{type} if all their operations can be mapped to each other by an orientation-preserving Euclidean transformation (coordinate change).
We denote the set of all space group types as $\mathcal{G}$. In 3 dimensions, there are only 230 unique space group types. By choosing a canonical coordinate system, we can in general work only with space group types.
The \textit{point group} $P$ of a space group $G$ is the image of the homomorphism $\pr{\v{O}, \v{t}} \mapsto \v{O}$, i.e the group obtained by keeping only the orthogonal parts of $G$. By contrast with space groups, any point group must at least preserve a single point, that is the origin. By a similar procedure to space groups, we can classify point groups and find that there are 32 crystallographic point group types, consisting of inversions, rotations, and reflections. We denote the set of all point group types as $\mathcal{P}$.

\paragraph{Wyckoff positions}
Having classified symmetry groups, we can now also classify points of space using symmetry considerations. This will be important to our method, as we will seek to use these semantically meaningful classes to guide the generation process.
Given a space group $G$, we say that two points $\rvx, \rvx'\in \R^3$ are part of the same \textit{crystallographic orbit} if there is a $\pr{\rmO, \rvt}\in G$ such that $\pr{\rmO, \rvt} \v{x} = \v{x}'$. 
The orbits form a partition of $\mathbb{R}^3$; they can be understood as the finest level of classification under $G$.
We define the \textit{site symmetry group} of a point $\v{x}$, $S_{\v{x}} = \cbrace{\pr{\v{O}, \v{t}}\in G \mid \pr{\v{O}, \v{t}} \v{x} = \v{x}}$ as the subgroup of $G$ that leaves \v{x} invariant. It is clear that the site symmetry must be a point group (since translations do not preserve any point), and is a subgroup of $P$. From the orbit-stabilizer theorem (see e.g. \citet{dummit2004abstract}), we can find that the number of points in the orbit $\v{x}$ and in the unit cell is given by $\abs{P}/\abs{S_{\v{x}}}$. Points in highly symmetric positions, therefore, result in smaller orbits. A point is in a \textit{general position} if its site symmetry group is trivial. In this case, there is a one-to-one correspondence between points in the orbit and group members. If the site symmetry is non-trivial, a point is said to be in a \textit{special position}.

Points in the same orbit have conjugate site symmetry groups. Therefore, site symmetry groups related by conjugation can be understood as equivalent.
This motivates a coarser level of classification that will be very useful. Two points $\v{x}, \v{x}'\in \mathbb{R}^3$ are part of the same \textit{Wyckoff position} if their site symmetry group is conjugate.
Wyckoff positions have a clear meaning: they classify regions of space in terms of their type of symmetry.
The \emph{multiplicity} of a Wyckoff position is the number of equivalent atoms that must occupy that position and is equal to the $\abs{P}/\abs{S_{\v{x}}}$ ratio introduced earlier.

\paragraph{Asymmetric Units}
The unit cell of a crystal can further be reduced into an \emph{asymmetric unit}, which is a small part of the unit cell that contains no symmetry but can be used to generate the whole unit cell by applying the symmetry transformations of the space group.
An asymmetric unit will only contain a single atom from each orbit.


\section{Method: Symmetric Crystal Diffusion (SymmCD)}
\subsection{Representation of crystals with Wyckoff positions}
\label{subsec:crystal}

As explained in the previous section, a crystal structure can in general be represented by the tuple $\gC = \pr{\v{L}, \v{X}, \v{A}}$. This representation has been used in previous generative models for crystals \citep{xie2022crystal, jiao2023crystal, luo2023towards, zeni2023mattergen}. However, a fundamental limitation of a model based on this representation is that it does not leverage the inductive bias of crystal symmetry and offers no guarantees for the crystal to satisfy anything but a trivial space group.

We introduce an alternative representation that respects symmetry in addition to having many desirable properties. First, we explicitly specify the space group type of the crystal $G\in \mathcal{G}$ in the representation. Given the space group, instead of representing each of the $N$ atoms individually with $\v{X}\in \mathbb{R}^{3 \times N}$ and $\v{A} \in \mathbb{R}^{Z \times N}$, we represent the $M$ crystallographic orbits; replicating the atoms within the orbit then creates the crystal. %; using their Wyckoff positions. 
As explained in \cref{sec:background}, the Wyckoff position identifies a set of orbits by site symmetries. Therefore, specifying the site symmetry and an arbitrary orbit representative is sufficient to identify a crystallographic orbit. 
This corresponds to a representation of an asymmetric unit within the unit cell.
We thus define the set of orbit representatives with their Wyckoff positions as the tuple $\gC' = \pr{\rvk, \v{X}', \rmS, \v{A}'}$, where $\rvk$ is a parametrization of the lattice (to be explained later), $\v{X}' = \br{\v{x}'_1, \dots, \v{x}'_M} \in \mathbb{R}^{3 \times M}$ are the representative's fractional coordinates in the asymmetric unit, $\rmS = \br{S_{\v{x}'_1}, \dots, S_{\v{x}'_M}} \in \mathcal{P}^{M}$ are the site symmetry groups and $\v{A}' = \br{\v{a}'_1, \dots, \v{a}'_M} \in \mathbb{R}^{Z \times M}$ are the atomic types.

From the set of representatives, we can go back to the representation $\v{X}$ and $\v{A}$ in a unique way. This is done by generating the orbits using the \textit{}{replication} operation that depends on the group $G$ and the site symmetry $\rmS$.
The replication operation essentially consists of applying all of the symmetry operations of the space group except for the ones included in the site symmetry group. The details of this operation are included in \cref{app:replication}.
Finally, the lattice $\rmL$ can be constrained to be compatible with the space group in a convenient way using the vector $\v{k}\in \mathbb{R}^6$ \citep{jiao2024space}:
$ \log(\rmL) = \sum_i^6 k_i \v{B}_i$,
where the $\v{B}_i\in \mathbb{R}^{3\times 3}$ is a standard basis over symmetric matrices. This basis and the constraints on $\v{k}$ for each space group are described in \cref{app:lattice_rep}.



Our representation of crystals that explicitly takes into account symmetry is therefore given by the tuple $\mathcal{C}' = \pr{G, \v{k}, \v{X}', \v{S}, \v{A}'}$. We convert crystal structures to this representation using the \textsc{spglib} symmetry finding algorithm \citep{togo2018spglib} provided by \textsc{Pymatgen} \citep{pymatgen}.

In addition to accounting for the symmetry, this representation of a crystal
provides two important advantages compared to existing methods. First, it provides the generative model with a powerful physically-motivated inductive bias. It is known from crystallography that atoms are typically not located in arbitrary positions in the unit cell \citep{aroyo2013}. Rather, it is energetically more favourable for atoms to occupy positions of high symmetry, e.g. special Wyckoff positions. The representation in terms of positions $\v{X}$ does not make this explicit. The representation using Wyckoff positions $\pr{\v{X}', \v{S}'}$ provides explicit supervision to the model and guides the generation process: the model decides in {which} \textit{type} of high-symmetry position an atom should be located and generates a position compatible with that type. Second, the representation in terms of Wyckoff positions is much more compact than the representation that operates on individual atoms. $M$ is  often significantly smaller than $N$. In the MP-20 dataset (a subset of the Materials Project dataset \citep{jain2013commentary}) for example, the average number of orbits is $\bar{M} = 4.7$ whereas the average number of atoms per unit cells is $\bar{N} = 18.9$, representing a fourfold difference
\footnote{This is using the conventional unit cell, not the primitive unit cell. A conventional cell may be twice or four times as big as a primitive cell.}. We therefore eliminate the redundant information from the representation and increase the computational efficiency of our method.

\label{app:hmnotation}
\begin{figure}[t]
\centering
\vspace{-4ex}
\includegraphics[width=0.95\linewidth]{images/axes_2.pdf}
  \caption{\textbf{Crystal symmetry axes.} The different axes describe the directions along which symmetry operations can occur. For each of the 15 axes, there are 13 possible symmetry operations.}
  \label{fig:axes}
\end{figure}
\vspace{-1ex}

\subsection{Symmetry Representation}  \label{sec:sg_rep}
\label{sec:sitesymm}
A key component of our representation of crystals with Wyckoff positions is the encoding of the space group $G$ and site symmetry groups $\v{S}'$.
While there are many existing methods to encode these symmetries, they generally do not make explicit the commonalities between the site symmetries of Wyckoff positions in the same space group, and the commonalities between different space groups across crystal systems. This is an important limitation: because there are 230 space groups, not having a representation that is common across space groups results in dividing the effective amount of data the model is trained on by a large amount. For example, in the MP-20 dataset \citep{jain2013commentary, xie2018crystal} 113 space groups out of 169 in the training set have fewer than a hundred samples associated with them, and specific Wyckoff positions in each group have even fewer samples.
%Furthermore, they fail to be injective: that is, there are multiple valid encodings for a given symmetry group, and the chosen encoding is just a matter of convention. 
We propose a method to represent the site symmetries of different Wyckoff positions and to encode the symmetries of space groups to address this shortcoming.

We represent atom site symmetries using a binary representation based on the oriented site symmetry symbol used by the International Tables for Crystallography to describe Wyckoff positions \citep{hahn1983international, donnay1974tables}.
The oriented site symmetry symbols denote generators of the site symmetry group along different possible axes, illustrated in \cref{fig:axes}.
In total, there are 15 possible axes of symmetry in a crystal, corresponding to each of the Cartesian axes, along with body and face diagonals.


Examples of possible symmetry operations along each axis include rotations and roto-inversions, as well as mirror symmetry along a plane perpendicular to the axis. There are 13 possible symmetries along each axis.
Listing out the site symmetry operation along each axis yields a $15\times 13$ binary matrix, or equivalently 15 different one-hot vectors.
There is an injective mapping between site symmetries and site symmetry matrix representations, so a representative atom can be replicated to produce a full orbit using this representation.

The space group $G$ can also be encoded into a binary representation using a similar scheme, by listing out the 15 possible axes of symmetry and listing out the possible symmetry operations along each axis.
Unlike the point group symmetries of atoms, these space group symmetry operations may involve translations and so include screw and glide transformations, leading to 26 possible symmetry operations. Further details are included in Appendix \ref{app:hmnotation}.
As a part of this project, both the site symmetry representations and the space group representations have been incorporated as functions in the PyXtal software library \citep{pyxtal}.

\subsection{Diffusion Model}
We can now describe the generative model and training process. In SymmCD, the space group and the number of orbit representatives are first sampled from separate distributions obtained from data, such that the distribution over crystal structures is $p\pr{\mathcal{C}} = p\pr{\v{k}, \v{X}', \v{S}, \v{A}' \mid M, G} p\pr{M\mid G} p\pr{G}$. We will seek to model the conditional distribution $p\pr{\v{k}, \v{X}', \v{S}, \v{A}' \mid M, G}$ with a denoising diffusion model \citep{sohl2015deep,ho2020denoising}.

We leverage our binary representation for incorporating crystal symmetry information (described in \cref{sec:sitesymm}) and perform joint diffusion over lattice representation ($\rvk$), fractional coordinates of atoms ($\v{X}'$), their types ($\v{A}'$), and the associated binary representation of site symmetry ($\v{S}$).


\begin{figure}[t]
\centering
\vspace{-4ex}
\includegraphics[width=0.80\linewidth]{images/pipeline_v3.pdf}
  \caption{\textbf{SymmCD training and sampling pipeline.} For training (green), the crystal structures are pre-processed to find the space group $G$ along with the site symmetries $\v{S}$ and a set of orbit representatives inside the asymmetric unit. The denoising model is a GNN with fully connected graphs, followed by a decoder. For sampling (blue), the positions are projected to the closest one compatible with their site symmetry. Then, the asymmetric unit is replicated to obtain the unit cell.}
\label{fig:pipeline}
\vspace{-1ex}
\end{figure}

\paragraph{Diffusion process}
We consider a separate diffusion process over the different components of the crystal representation. We apply discrete diffusion from \citet{austin2021structured} for site symmetries and atom types.
Rather than adding Gaussian noise as in conventional diffusion, we add noise to categorical features by multiplying probability vectors by a transition matrix and sampling from the new probabilities.
Inspired by \cite{vignac2023digress}, the transition matrices are parameterized so that the process converges to the marginals from the data distribution for atom types and site symmetries. The loss function used for discrete diffusion on atomic types is
\begin{equation}
     \mathcal{L}_{\v{A}'} = 
     \mathbb{E}_{\rva_t \sim \mathrm{Cat}(\rva_0^\top \bar{\rmQ}_t), t \sim \mathrm{U}(1, T)}
     \sum_{i=1}^{M} \mathrm{CrossEntropy}(\v{a}_i, \hat{\v{a}}_{i}),
\end{equation}
where $\rva_0$ is the initial one-hot encoding of the atom types for a single representative and $\bar{\mathbf{Q}}_t = \prod_{i=1}^{t} \mathbf{Q}_i \in \R^{Z \times Z}$ is the cumulative product of transition matrices between timesteps, and $\hat{\rva}_i$ are the predicted denoised probabilities. The same loss function is used for site symmetries.

Continuous diffusion is used for fractional coordinates and lattice parameters, similar to \cite{jiao2023crystal}. The loss function for the continuous diffusion on lattice parameters is
\begin{equation*}
    \mathcal{L}_\rvk = \mathbb{E}_{\epsilon_{\rvk} \sim \mathcal{N}(0, \mathbf{I}), t \sim \mathrm{U}(1, T)}\left[\vert \vert m \odot \epsilon_{\rvk} - \hat{\epsilon}_{\rvk}(\gC'_{t}, t) \vert \vert_{2}^{2}\right],
\end{equation*}
where $m$ is a space group-dependent mask, and $\hat{\epsilon}_{\rvk}$ is the predicted denoising vector.
The same loss function is used for the fractional coordinates, except that to capture their periodic nature, we use a wrapped normal distribution $\mathcal{WN}(0, 1)^{3 \times M}$. We provide more details in \cref{apd:diffusion}.

\paragraph{Denoising network}

The architecture of the denoiser is a message-passing neural network that operates on a fully connected graph of representatives, based on \cite{jiao2023crystal}.
Features for each representative $\rvh_i$ are initialized using an embedding of their atom types $\rva_i$ and their site symmetries $\rmS_i$, along with the graph-level features of the diffusion timestep $t$, the lattice features $\rvk$, and an embedding of the space group $G$.
At each layer, messages $\rvm_{ij}$ are computed between representatives $i$ and $j$ by applying an MLP to $\rvh_i, \rvh_j$, and a Fourier embedding of the vector $\rvx_i - \rvx_j$ to respect periodic invariance.
These messages are then used to update $\rvh_i$. More details on the architecture are included in \cref{app:architecture}. Note that the denoising network is not equivariant. It is not necessary since the unit cell axes provide a canonical reference system \citep{kaba2023equivariance}. We also found that using an equivariant denoising network like EGNN \cite{satorras2021n} did not work well in part due to the fact that since we use periodic encodings, the crystal structure input has a translational symmetry. An equivariant model may not be able to break that symmetry \citep{kaba2023symmetry} resulting in a inability to output correct positions in the asymmetric unit (or unit cell).

\paragraph{Putting it all together}

The algorithm for training our diffusion model is outlined in \cref{alg:crystal_training}.
We use different loss coefficients $\lambda_{\rvk}, \lambda_{\rmX'}, \lambda_{\rmA'}$ and $\lambda_{\rmS}$ to weigh the importance of the different components of the model.
The algorithm for sampling from the diffusion model is shown in \cref{alg:crystal_sampling}. The full pipeline is summarized in \cref{fig:pipeline}. Since both the diffusion and the denoising process both operate only on the asymmetric unit, they fully preserve the symmetry of the crystal.


\begin{algorithm}[h]
\caption{Training SymmCD}
\label{alg:crystal_training}
\begin{algorithmic}[1]
\State \textbf{Input:} Dataset of crystals $\mathcal{D}$
\While{not converged}
    \State Sample a crystal $\mathcal{C} = (\v{L}, \v{X}, \v{A})$ from dataset $\mathcal{D}$, and  a timestep $t \sim \mathrm{Uniform}(1, T)$  
    \State Derive the asymmetric representation $\mathcal{C}' = (G, \rvk, \v{X}', \v{A}', \v{S})$ from $\mathcal{C}$
    \State Add noise to $\v{k}$, $\v{X}'$, $\v{A}'$, and $\v{S}'$:
    \State \quad $\v{k}_t = \sqrt{\bar{\alpha}_t} \v{k}_0 + \sqrt{1 - \bar{\alpha}_t} \epsilon_{\v{k}}$, \quad $\epsilon_{\v{k}} \sim \mathcal{N}(0, \mathbf{I})$
    \State \quad $\v{X}'_t = \sqrt{\bar{\alpha}_t} \v{X}'_0 + \sqrt{1 - \bar{\alpha}_t} \epsilon_{\v{X}'}$, \quad $\epsilon_{\v{X}'} \sim \mathcal{W}\mathcal{N}(0, \mathbf{I})$
    \State \quad $\v{A}'_t \sim  \mathrm{Cat}(\rmA \bar{\rmQ}_{a,t})$
    \State \quad $\v{S}_{u,t} \sim  \mathrm{Cat}(\rmS \bar{\rmQ}_{u,G,t})$

    
    \State Use denoising network $\phi$ to predict $\hat{\epsilon}_{\v{k}}, \hat{\epsilon}_{\v{X}'}, \hat{\rmA}', \hat{\v{S}}$ from noisy $\mathcal{C}_t = (G, \v{k}_t, \v{X}'_t, \v{A}'_t, \v{S}_t)$, $t$
    
    \State Compute losses $\mathcal{L}_{\v{k}},\mathcal{L}_{\v{X}'}, \mathcal{L}_{\v{A}'}, \mathcal{L}_{\v{S}'}$

    \State Update the denoising network $\phi$ using total loss:
    \State \quad $\mathcal{L} = \lambda_{\v{k}}\mathcal{L}_{\v{k}} + \lambda_{\v{X}'}\mathcal{L}_{\v{X}'} + \lambda_{\v{A}'}\mathcal{L}_{\v{A}'} + \lambda_{\v{S}}\mathcal{L}_{\v{S}'}$
\EndWhile
\end{algorithmic}
\end{algorithm}

\vspace{-1em}
\begin{algorithm}[h]
\caption{Sampling from SymmCD}
\label{alg:crystal_sampling}
\begin{algorithmic}[1]
\State \textbf{Input:} Target space group $G$, Number of representatives $M$
\State \textbf{Initialize:} 
\State \quad Sample $\v{k}_T \sim \mathcal{N}(0, \mathbf{I})$ 
\State \quad Sample $\v{X}_T' \sim \mathcal{U}(0, 1)^{3 \times M}$ 
\State \quad Sample $\v{A}_T' \sim p_{\text{marginal}}(\v{A}')$ 
\State \quad Sample $\v{S}_T' \sim p_{\text{marginal}}(\v{S}' | G)$ (site symmetries)
\For{$t = T$ to $1$}
    \State Compute $\hat{\epsilon}_{\v{k}}, \hat{\epsilon}_{\v{X}'}, \hat{\v{A}}', \hat{\v{S}}$ using denoising network $\phi(\cdot)$
    \State Sample  $\v{k}_{t-1}$, $\v{X}'_{t-1}$, $\v{A}'_{t-1}$, $\v{S}'_{t-1}$ using  $\hat{\epsilon}_{\v{k}}, \hat{\epsilon}_{\v{X}'}, \hat{\v{A}}', \hat{\v{S}}$.
\EndFor
\State Project $\rmS_0'$ onto nearest valid point group
\State Project $\v{X}'_0$ onto nearest Wyckoff position with that site symmetry
\State Replicate representative atoms $\v{X}'_0$ using site symmetries $\v{S}'_0$ to generate full crystal $\v{X}_0$
\State \textbf{Output:} Crystal structure $\v{X}_0$, Atom types $\v{A}_0$, lattice $\rmL_0$
\end{algorithmic}
\end{algorithm}
\vspace{-1ex}


\section{Experiments}
We test our model on \emph{de novo} crystal generation using the MP-20 dataset \citep{xie2022crystal}, a subset of the Materials Project \citep{jain2013commentary} consisting of 40,476 crystals, each with up to 20 atoms per primitive unit cell. The data is preprocessed to use the conventional unit cell rather than the primitive unit cell, as the former has more conveniently expressed symmetries and constraints. A conventional unit cell may be larger than a primitive unit cell, which results in up to 80 atoms in the unit cell.
We withhold 20\% of the dataset as a validation set, and 20\% as a test set.

We empirically demonstrate our contributions, particularly in ensuring we generate crystals with desired symmetries while being competitive with existing baselines.
We compare our proposed method with four recent strong baselines: CDVAE \citep{xie2022crystal}, DiffCSP \citep{jiao2023crystal}, DiffCSP++ \citep{jiao2024space} and FlowMM \citep{millerflowmm}.
We retrained each method according to their given hyperparameters, and generated 10,000 crystals each.
We also consider a variant of our model (10 SGs) where we only sample from the 10 most common space groups in the MP-20 dataset, similar to \citep{cao2024space}
\footnote{These space groups are numbered:  2,  12,  14,  62,  63, 139, 166, 194, 221, 225}
. This is to provide a more nuanced comparison with other methods, which are not constrained in matching the space group distribution. This choice still captures a large portion of the data distribution, since these are the most prevalent space groups.


\subsection{Symmetry and structural diversity}
\label{sec:results_symm}
First, we evaluate the different methods on their ability to generate crystals with diverse structures and space groups. This aspect has not been investigated yet for the considered baselines, yet it is significant in understanding if they generate realistic structures.

\begin{figure}[t]
\vspace{-8ex}
    \centering
    \includegraphics[width=0.95\linewidth]{images/sgs_bar_chart_full.pdf}
\vspace{-2ex}
        \caption{Proportion of space group symmetries of the dataset, and each method. The width of each color segment represents the proportion of crystals with that symmetry. From left to right, the first few space groups are: P1, Fm$\bar{3}$m, Cm, P$\bar{1}$, C2/m, I4/mmm, Pm$\bar{3}$m, P$6_3$/mmc, and Pm.}
        \label{fig:sg_composition}
\end{figure}
\vspace{-1ex}


\begin{wraptable}{R}{0.45\textwidth}  % 'r' for right alignment, adjust the width as needed
\small{

    \centering
\vspace{-1em}
    \caption{Template statistics for each model. \label{tab:templates}}
    \vspace{-1em}
    \begin{tabular}{@{}llll@{}}
    \toprule
%                  & \multicolumn{3}{c}{Templates}                  \\ \midrule
           Method       & \# Unique        & \% in Train & \# New        \\ \midrule
    Training Set  & 3318          & 100            & -           \\
    CDVAE         & 797           & \textbf{28.7}  & 568           \\
    DiffCSP       & 1347          & 43.2           & 764           \\
    DiffCSP++     & 1905          & 94.2           & 110           \\
    FlowMM        & 1291          & 41.7           & 753           \\
     SymmCD & \textbf{2794} & 40.8           & \textbf{1654} \\ 
\bottomrule
    \end{tabular}
}
\end{wraptable}
\vspace{-0.8em}
\paragraph{Space groups}To detect the space group of the generated structures, we use spglib's symmetry finding method \citep{spglibv1,pymatgen} with a tolerance of 0.1{\AA}.
%This is applied to 10,000 crystals sampled from each model.
The distribution of space groups of the generated structures is shown in \cref{fig:sg_composition}. It can be observed that while SymmCD matches the highly diverse data distribution, CDVAE mostly generates crystals with trivial $P1$ symmetry, and DiffCSP and FlowMM generate many crystals with low symmetry and generally have lower diversity of space groups.
We also consider a new quantitative metric to characterize the space group distribution, $d_{\mathrm{sg}}$, which is calculated as the Jensen-Shannon distance between the distribution of space groups of the generated structures and the test set. We report it for the different methods in the rightmost column of \cref{tab:results}. The results confirm that SymmCD and DiffCSP++ are the only methods that accurately match the distribution of space groups in the dataset.


\vspace{-0.8em}
\paragraph{Unique Templates}
We also evaluate the ability of the different methods to generate diverse crystal structures. 
We define a structural \emph{template} to be a combination of a space group and a multiset of occupied Wyckoff positions, regardless of the atomic types in the Wyckoff position.
Templates, also known as Wyckoff sequences, are used in practice to classify crystals by their symmetry. They have the advantage of providing a notion of a structure that is highly flexible, while being robust to perturbations of coordinates that do not change the position of atoms with respect to symmetry elements.
Most potential templates have not yet been experimentally observed, motivating the development of methods that can discover materials with new templates \citep{hornfeck2022combinatorics}.



The training dataset contains 3318 such unique templates.
We examine the templates for the 10,000 crystals generated by each method, and report results in \cref{tab:templates}.
We find that SymmCD performs best out of all models, proposing unique and novel templates.
This highlights an important limitation of DiffCSP++. While it can produce diverse space groups and to a certain extent diverse templates, since it uses pre-defined templates it fails to generate structures with \emph{novel} templates. Our method does not suffer from this problem since it learns to generate templates.


\begin{wraptable}{R}{0.5\textwidth}  % 'r' for right alignment, adjust the width as needed
\small{

    \centering
\vspace{-1em}
\caption{Percent of stable and S.U.N. samples produced from an initial set of 10,000 generated crystals for each method.\label{tab:sun}}
    \vspace{-1em}

\begin{tabular}{@{}llll@{}}
\toprule
          & Initial  & Relaxed & Relaxed \\
          & Stable &  Stable & S.U.N. \\  \midrule
CDVAE       & 0.24\%             & 4.42\%             & 4.26\%             \\
DiffCSP     & 7.82\%    & 11.32\%            & 8.92\%    \\
DiffCSP++   & 6.99\%             & 11.36\%   & 8.62\%             \\
FlowMM      & 4.26\%             & 9.05\%             & 6.49\%             \\
SymmCD (All SGs)     & 4.96\%             & 9.34\%             & 6.86\%            \\ 
SymmCD (10 SGs) & 6.85\%             & 10.92\%            & 7.59\%            \\
\bottomrule
\end{tabular}
\vspace{-0.5em}
}
\end{wraptable}


\subsection{Stable, unique and novel (S.U.N.) structures}
Regardless of their target application, generative models for crystals should produce sets of crystals that are thermodynamically stable, unique (not duplicated within the predicted set), and novel (not already in the training data), or S.U.N.
To this end, we adapt the evaluation procedure 
of
\cite{millerflowmm} to assess the capability of our model to generate S.U.N. materials.
Thermodynamic stability is determined by estimating the energy of a material with respect to a \emph{convex hull}.
The convex hull gives linear combinations of known phases that represent the lowest-energy mixtures of materials; if a material has an energy above the hull, it is energetically favorable for it to decompose into a combination of stable phases and is therefore thermodynamically unstable.
We assess the stability of generated crystals by estimating their energies using a pretrained CHGNet model \citep{deng2023chgnet}, and comparing that to a convex hull computed for Materials Project \citep{riebesell2024matbenchdiscoveryframework}.


We predict the stability of the 10,000 samples generated by each method, and then use CHGNet to compute relaxed structures for each crystal, which results in higher stability.
Finally, we check whether the stable relaxed crystals are also unique and novel.
Details of this procedure are included in \cite{millerflowmm}.
The results are shown in \cref{tab:sun}. We see that SymmCD performs on par with the baselines. Sampling over the most common space groups results in more stable structures.






\subsection{Validation with density functional theory relaxations}

We carried out electronic structure calculations as a more accurate way to evaluate the crystal structures generated by the different methods. Since these computations are significantly more expensive than the ones with CHGNet, we performed them on 100 structures sampled from each model. Concretely, these involved using the \texttt{CP2K} \citep{kuhneCP2KElectronicStructure2020} suite of programs to perform cell and geometry relaxations to assess the quality of generated structures based on their distances from ``true'' local minima. We expect a better method to produce structures with less distance traveled, smaller per-atom forces (i.e. energy gradient with respect to positions), and with fewer iterations. 


In these calculations, we find that the convergence rates of methods are not significantly different (see \cref{fig:max-grad-ecdf}).
Comparing expectation values of the maximum force after optimization, however, we see that SymmCD is significantly more successful in generating structures that are readily optimized.
The full results of this analysis, as well as the parameters used for CP2K can be found in \Cref{app:dft}. 

\subsection{Proxy metrics}
Although ultimately we care about the stability, novelty, and properties of crystals after structural relaxation, we also compare the different methods using the proxy metrics established by \cite{xie2022crystal}, as they are cheap enough to compute over a large set of generated samples and demonstrate the ability of different methods to capture the properties of a target distribution.
These metrics include heuristics of validity, coverage of the test set, and the Wasserstein distances between the distributions of three properties of the generated samples and the test set: atomic densities $d_{\rho}$, number of unique elements $d_{\mathrm{elem}}$, and predicted formation energy $d_{\mathrm{E}}$.
We also include $d_{\mathrm{sg}}$, the Jensen-Shannon distance between space group distributions.
Further details are included in \Cref{app:proxy}.

For each method, we retrained a model with 5 different seeds, generating 10,000 samples for evaluation per seed.
 The results are shown in \Cref{tab:results}. Although SymmCD performs similarly to other methods for most metrics, it is more likely to generate structurally invalid crystals, possibly because it cannot easily see distances between atoms.
We also note the large variance in the results across different seeds for each method.

\begin{table}[h]
\vspace{-5.5ex}
\caption{Results for comparing the validity, coverage, and property distribution metrics.}
\label{tab:results}
\resizebox{1.\textwidth}{!}{
\centering
\begin{tabular}{@{}l|ll|ll|lllll@{}}
                 & \multicolumn{2}{c|}{Validity (\%) ($\uparrow$)}          & \multicolumn{2}{c|}{Coverage (\%) ($\uparrow$)}                           & \multicolumn{4}{c}{Property Distribution ($\downarrow$)} \\
    MP-20             & Struct.     & Comp.      & Recall        & Precision       & $d_\rho$               &         $d_E$  &         $d_{\mathrm{elem}}$ &         $d_{\mathrm{sg}}$ &          \\
\midrule
CDVAE            &$ 99.97_{\pm 0.03 }$& $85.61_{\pm 1.20 }$&$ 99.31_{\pm .06 }$&$ 99.47_{\pm 0.19 }$&$ 0.70 _{\pm .10}$&$ 0.24_{\pm .06}$&$ 1.28_{\pm .06}$&$ 0.69_{\pm .007  }$&  \\
DiffCSP          &$ 97.43_{\pm 3.10 }$& $82.50_{\pm 1.34 }$&$ 99.55_{\pm .08 }$&$ 98.73_{\pm 1.34 }$&$ 0.18_{\pm .08}$&$ 0.14_{\pm .05}$&$ 0.56_{\pm .07}$&$ 0.44_{\pm .009  }$&  \\
DiffCSP++        &$ 99.44_{\pm 0.06 }$& $86.50_{\pm 0.85 }$&$ 99.72_{\pm .06 }$&$ 99.61_{\pm 0.08 }$&$ 0.12_{\pm .04}$&$ 0.05_{\pm .01}$&$ 0.33_{\pm .04}$&$ 0.16_{\pm .009  }$&  \\
FlowMM           &$ 96.67_{\pm 0.57 }$& $83.25_{\pm 0.13 }$&$ 99.49_{\pm .05 }$&$ 99.58_{\pm 0.10 }$&$ 0.23_{\pm .10}$&$ 0.09_{\pm .02}$&$ 0.08_{\pm .02}$&$ 0.50_{\pm .011  }$&  \\
%\begin{tabular}[c]{@{}l@{}}SymmCD\\ {\tiny(All SGs)}\end{tabular}
SymmCD$_{\text{All SGs}}$
                &$ 90.34_{\pm 3.39 }$& $85.81_{\pm 0.87 }$&$ 99.58_{\pm .08 }$&$ 97.76_{\pm 0.85  }$&$ 0.23_{\pm .06}$&$ 0.21_{\pm .04}$&$ 0.40_{\pm .06}$&$ 0.164_{\pm .003  }$&  \\
%\begin{tabular}[c]{@{}l@{}}SymmCD\\ {\tiny(10 SGs)}\end{tabular} 
SymmCD$_{\text{10 SGs}}$
                &$ 92.30_{\pm 6.10 }$& $87.13_{\pm 0.62 }$&$ 97.33_{\pm .59 }$&$ 98.78_{\pm 0.69  }$&$ 0.53_{\pm .23}$&$ 0.21_{\pm .09}$&$ 0.16_{\pm .02}$&$ 0.469_{\pm .002  }$&  \\
\midrule
\end{tabular}
}
\vspace{-1.5em}
\end{table}

\newpage
\subsection{Computational efficiency}

\begin{wraptable}{R}{0.6\textwidth}
\vspace{-1em}
\small{    
    \centering
    \vspace{-0em}
    \caption{Computational efficiency of our representation\label{tab:mem}}
    \begin{tabular}{@{}lll@{}} 
    \toprule
    & Asymmetric & Conventional \\ 
    & Unit (ours) & Unit Cell \\ \midrule
    Maximum batch size ($\uparrow$) & \textbf{8192} & 512 \\
    Memory for 512 batch size ($\downarrow$) & \textbf{3.6 GB} & 31 GB  \\
    Time for 1 training epoch ($\downarrow$) & \textbf{27 sec.} & 52 sec. \\
\bottomrule
\end{tabular}}
    \vspace{-0.5em}
\end{wraptable}

We demonstrate significant computational efficiency gains and reduced memory footprint due to using a more compact representation based on crystallographic orbits.
We compare our model to an equivalent model that looks at a full unit cell, rather than just the asymmetric unit. It also uses a fully connected graph to represent the atoms in the unit cell, but does not predict site symmetry representations. This makes the model essentially equivalent to DiffCSP  \citep{jiao2023crystal}, but with the same architecture and hyperparameters as SymmCD for consistent comparison. 
We compare the two representations for one epoch of training using 40GB of RAM and a single NVIDIA MIG A100
and report the results in \cref{tab:mem}.
These results highlight SymmCD's memory efficiency and faster training capabilities.

\subsection{Scaling up to MPTS-52}
To validate that SymmCD can scale up to datasets of larger crystals thanks to its compact representation, we also validate our model by training it on the more challenging  MPTS-52 dataset \citep{baird2024matbench}, which contains crystals with up to 52 atoms per primitive unit cell, and includes more chemical elements. 
Further details of this dataset along with the results are included in \Cref{app:mpts}.

We note that none of the baselines we compare against (CDVAE, DiffCSP, FlowMM, and DiffCSP++) present results for de-novo generation on this dataset. We can see from these results that SymmCD is able to scale to much larger crystals than those in the MP-20 dataset and is still capable of producing valid, stable, and novel crystals that match the training distribution of the dataset.
The metrics reported are worse than those for MP-20, as this is a more difficult dataset.


% \vspace{-1em}
\section*{Conclusion}
In this paper, we introduced a novel approach for generating crystals with precise symmetry properties. We proposed to leverage asymmetric units and site symmetry representations within a diffusion model framework. This approach ensures that the generated crystals inherently preserve desired symmetries while allowing greater diversity, computational efficiency, and flexibility in the generation process.
To encode crystal and site symmetries we introduced a new representation of crystal symmetries that enables information sharing across space groups, improving generalization when learning with a diverse set of crystal symmetries. Our results indicate that this method produces stable, novel, and structurally diverse crystals, with improved computational efficiency, showing promise for discovery in materials science. In this work, we focused on inorganic crystals, but SymmCD could potentially be promising for applications on molecular crystals and co-crystals, which also have non-trivial symmetries.
Beyond materials, other data types such as molecules and graphs often exhibit complex symmetries, and future work could investigate if symmetry constraints could also be useful in generative models for these modalities.

A limitation of our framework is that it makes it more challenging to perform crystal structure prediction given a composition since it relies on sampling a space group first, and then a composition conditioned on the space group. Finally, an important area of future work in generative models for crystals is also to go beyond single crystals, and consider the generation of polycrystalline materials. These types of materials are common in applications, yet not suited to generation using single unit cells or asymmetric units. 

\subsubsection*{Acknowledgments}

This project is supported by Intel Labs, CIFAR and the NSERC Discovery grant. S.-O. K.’s research is also supported by IVADO and the DeepMind Scholarships, and D.L.’s research is partly supported by the FRQNT. Computational resources were provided by Mila and Intel Labs. We are thankful to Alexandra Volokhova, Victor Schmidt, Alex Hernandez-Garcia, Alexandre Duval, and Félix Therrien for helpful discussions.


\bibliography{biblio}
\bibliographystyle{iclr2025_conference}
\newpage
\appendix

\section{Replication}\label{app:replication}
We define the replication operator as
$\mathsf{R}: \mathcal{G} \times \mathcal{P} \times \mathbb{R}^3 \to 2^{\mathbb{R}^3}$.
This operation is defined by considering the group $S_{\v{x}} \ltimes T_{\v{S}}$, with $T_{\v{S}}$ being the group of translations defined by the lattice.
$S_{\v{x}} \ltimes T_{\v{S}}$ is the set of operations that preserve the position of $\v{x}$ \textit{within} the unit cell as opposed to within the crystal. We can then consider the coset decomposition of the space group with respect to that group $G/\pr{S_{\v{x}} \ltimes T_{\v{S}}}$. Then, we denote by $\br{G/\pr{S_{\v{x}} \ltimes T_{\v{S}}}}_{\v{0}}$ a system of coset representatives where the translation parts are chosen to move only within the unit cell. This defines the set of operations that move a position $\v{x}$ within its orbit and the unit cell. The replication operation then simply consists of applying all these operations:
\begin{align*}
\mathsf{R}\pr{G, S_{\v{x}}, \v{x}} = \pr{\pr{\v{O}, \v{t}}\v{x} \mid \pr{\v{O}, \v{t}} \in \br{G/\pr{S_{\v{x}} \ltimes T_{\v{S}}}}_{\v{0}}}
\end{align*}
The representation in terms of individual atoms is then:
\begin{align}
\v{X} &= \bigoplus_i^M \mathsf{R}\pr{G, S_{ \v{x}'_i}, \v{x}'_i}\\
\v{A} &= \bigoplus_i^M \mathrm{repeat}\pr{\v{a}_i, \br{G : \pr{S_{\v{x}} \ltimes T_{\v{S}}}}}
\end{align}
where $\mathrm{repeat}\pr{\v{a}, n}$ repeats the vector $\v{a}$ $n$ times and $\br{G : \pr{S_{\v{x}} \ltimes T_{\v{S}}}}$ is the multiplicity of the orbit.

In our diffusion model, our predicted site symmetries $\hat{\rmS}$ do not always necessarily correspond to a valid crystallographic point group.
To get around this, we project $\hat{\rmS}$ to the nearest point group that is a subgroup of the given space group, as measured by the Frobenius Norm of their difference.
Once a point group is chosen, the PyXtal \texttt{search\_closest\_wp} function is used to get the nearest coordinates to $\rmX'$ that correspond to a Wyckoff position with the given site symmetry, and $\rmX'$ is updated to be placed on those coordinates \citep{pyxtal}.
Finally, the representative atoms at the Wyckoff position are replicated, using operations implemented in PyXtal.



\section{Lattice Representation}\label{app:lattice_rep}
We use the lattice representations derived by \cite{jiao2024space}, as they are useful for constraining lattices to respect the symmetries of a given space group.
The authors found that any lattice matrix $\rmL$ can be written as $\rmL = \rmQ \exp(\rmS)$ for some orthogonal $\rmQ$ (which we can ignore, as orthogonal transformations do not change the lattice), and symmetric $\rmS$.
The matrix $\rmS$ can then be decomposed into a sum of the following basis lattices:

\[
\mathbf{B}_1 = \begin{pmatrix}
0 & 1 & 0 \\
1 & 0 & 0 \\
0 & 0 & 0
\end{pmatrix}, \quad
\mathbf{B}_2 = \begin{pmatrix}
0 & 0 & 1 \\
0 & 0 & 0 \\
1 & 0 & 0
\end{pmatrix}, \quad
\mathbf{B}_3 = \begin{pmatrix}
0 & 0 & 0 \\
0 & 0 & 1 \\
0 & 1 & 0
\end{pmatrix},
\]
\[
\mathbf{B}_4 = \begin{pmatrix}
1 & 0 & 0 \\
0 & -1 & 0 \\
0 & 0 & 0
\end{pmatrix}, \quad
\mathbf{B}_5 = \begin{pmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & -2
\end{pmatrix}, \quad
\mathbf{B}_6 = \begin{pmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & 1
\end{pmatrix}.
\]
with $\rmS = \sum_{i=1}^6 k_i \rmB_i$.
They derive constraints on $k_i$ depending on the space groups that a crystal belongs to:
\begin{itemize}
    \item Triclinic: $\rvk = (k_1, k_2, k_3, k_4, k_5, k_6)$
    \item Monoclinic: $\rvk = (0, k_2, 0, k_4, k_5, k_6)$
    \item Orthorhombic: $\rvk = (0, 0, 0, k_4, k_5, k_6)$
    \item Tetragonal: $\rvk = (0, 0, 0, 0, k_5, k_6)$
    \item Hexagonal: $\rvk = (-\log(3)/4, 0, 0, 0, k_5, k_6)$
    \item Cubic: $\rvk = (0, 0, 0, 0, 0, k_6)$
\end{itemize}


\section{Site Symmetry Representation}

The 15 possible symmetry axes of crystals are:
{[}001{]}, {[}010{]}, {[}100{]},  {[}111{]}, {[}1$\bar{1}$1{]}, {[}$\bar{1}$11{]}, {[}$\bar{1}$$\bar{1}$1],  {[}110{]}, {[}1$\bar{1}$0{]}, {[}101{]}, {[}10$\bar{1}${]}, {[}011{]}, {[}01$\bar{1}${]}, {[}210{]}, {[}120{]}, {[}1$\bar{1}$0{]}.
These axes are written in short form: for example, [1$\bar{1}$0] denotes the direction of the vector $(1, -1, 0)$. They are shown in \Cref{fig:axes}.
The axes depend on the symmetries of the crystal system: for example, in an orthorhombic crystal (a rectangular prism whose side lengths are not necessarily equal), a crystal may have different site symmetries oriented around the x, y, or z-axes.
Conversely, in a tetragonal crystal (a rectangular prism with a square base), any site symmetry oriented along the x-axis must also be along the y-axis, there may be additional symmetries along the diagonal of the x-y plane.

The possible set of symmetry elements along each axis for a site symmetry group correspond to the identity $1$; an inversion $\bar{1}$; rotations of different orders 2, 3, 4, and 6; rotoinversions $\bar{2}$ (equivalent to a mirror symmetry $m$ across a plane perpendicular to the axis), $\bar{3}$, $\bar{4}$, and $\bar{6}$; and combinations of rotations and mirror reflections $2/m$, $4/m$, and $6/m$.
This enumeration yields 13 possible symmetries along each axis.

The possible symmetry elements along each axis for a space group correspond to the identity $1$; an inversion $\bar{1}$; rotations of different orders 2, 3, 4, and 6; rotoinversions $\bar{2}$ (equivalent to a mirror symmetry $m$ across a plane perpendicular to the axis), $\bar{3}$, $\bar{4}$, and $\bar{6}$; screws $2_1$, $3_1$, $3_2$, $4_1$, $4_2$, $4_3$, $6_1$, $6_2$, $6_3$, $6_4$, $6_5$, and glides $a, b, c, n, d, e$.

To encode a space group, an additional 7-dimensional one-hot encoding is used to denote the Bravais lattice to which the space group belongs. This yields a $(26 \times 15) + 7 = 397$ dimensional binary representation of space group.

 The representations can now be accessed using the \texttt{symmetry} module of PyXtal \citep{pyxtal}.


\section{Diffusion and denoising process details}
\label{apd:diffusion}
\paragraph{Diffusion on lattice parameters $\rvk$} Inspired by \cite{jiao2024space}, we perform diffusion over $\rvk$, the $O(3)$-invariant lattice representation.
The forward noising process is given by $q(\rvk_t \vert \rvk_0) \sim \mathcal{N}(\rvk_t \vert \sqrt{\Bar{\alpha}_{t}} \rvk_0, (1 - \Bar{\alpha}_{t})\mathbf{I})$, where $\rvk_t$ is the noised version of $\rvk_0$ at timestep $t$. Here, similar to \citet{nichol2021improved}$, \Bar{\alpha}_{t} = \Pi_{j=1}^{t}(1 - \beta_{j})$, where $\beta_{j} \in (0, 1)$ determines variance in each step controlled by the cosine scheduler. During the generation process, we start with $\rvk_T \sim \mathcal{N}(0, \mathbf{I})$ and use learned denoising network to generate $\rvk_{t-1}$ from $\rvk_t$:
\begin{align*}
    &p_{\theta}(\rvk_{t-1} \vert \gC'_t) = \mathcal{N}\Big( \rvk_{t-1} \vert \mu_{\rvk}(t), \sigma(t) \mathbf{I} \Big ),\\
    &\mu_{\rvk}(t) = \frac{1}{\sqrt{\Bar{\alpha}_t}} \Big( \rvk_t - \frac{\beta_t}{\sqrt{1 - \Bar{\alpha}_t}} \hat{\epsilon}_{\rvk}(\gC'_t, t) \Big), \sigma(t) = \beta_t \frac{1 - \Bar{\alpha}_{t-1}}{1 - \Bar{\alpha}_{t}}.
\end{align*}

Here, $\mathcal{C}'_t$ is the noised crystal and $\hat{\epsilon}_{k}(\mathcal{C}'_{t}, t)$ is the predicted denoising term predicted from a denoising network $\phi(\gC'_t, t)$.
We also use a mask $m$ to only implement diffusion over unconstrained dimensions of $\rvk_t$, since depending upon space groups, certain dimensions have fixed values (\cref{app:lattice_rep}). The mask can be represented as $m \in \{0, 1\}^6$ and $m_i = 1$ indicates that $i^{th}$ index of $\rvk$ is unconstrained. The corresponding loss used to train the denoising network is:
\begin{equation*}
    \mathcal{L}_\rvk = \mathbb{E}_{\epsilon_{\rvk} \sim \mathcal{N}(0, \mathbf{I}), t \sim \mathrm{U}(1, T)}[\vert \vert m \odot \epsilon_{\rvk} - \hat{\epsilon}_{\rvk}(\gC'_{t}, t) \vert \vert_{2}^{2}]
\end{equation*}

where $\odot$ is the elementwise product and $U(1, T)$ is a uniform distribution over timesteps.
%\todo{what is M_t?}
% diffusion for coords
\paragraph{Diffusion over representative fractional coordinates $\rmX'$}
We perform diffusion over the fractional coordinates using the same method as \cite{jiao2023crystal}.
Due to the periodicity of fractional coordinates, the noising process $q(\rmX_{t} | \rmX_{0})$ is determined by a Wrapped Normal distribution rather than a Gaussian distribution, and we initialize the fractional coordinates $\rmX_{T}$ with the uniform distribution $U(0, 1)$ when sampling.

% diffusion for atom types
\paragraph{Diffusion on atom types $\v{A}'$}
We use discrete diffusion from \cite{austin2021structured} to sample the atom types of each representative. If $\v{a}_0 \in \{0,1\}^{Z}$ is the one-hot encoding of atom types for a single representative, then we can noise it as: $q(\v{a}_t | \v{a}_0) = \mathrm{Cat}(\v{a}_t; \v{p} =  \v{a}_0^{\top} \bar{\mathbf{Q}}_t )$, where $\bar{\mathbf{Q}}_t = \prod_{i=1}^{t} \mathbf{Q}_i \in \R^{Z \times Z}$ is the cumulative product of transition matrices between timesteps.
Inspired by \cite{vignac2023digress}, the transition matrix can be parametrized as $\mathbf{Q}_t = \alpha_t \v{I} + \beta_t \v{m}_{a}$, where $\v{m}_{a}$ are the marginals over the atom types in the data, and $\alpha_t$ and $\beta_t$ are scheduling parameters.
The effect of this noising scheme is that regardless of $\v{a}_0$, the fully noised $\v{a}_T = \v{a}_0^\top  \mathbf{Q}_T = \v{m}_{a}$, so we can sample from the prior distribution $\v{m}_{a}$, which is close to the data distribution.
The discrete diffusion model is trained using a cross-entropy loss:  %\todo{Elaborate}
\begin{equation}
     \mathcal{L}_{\v{A}'} = 
     \mathbb{E}_{\rva_t \sim \mathrm{Cat}(\rva_0^\top \bar{\rmQ}_t), t \sim \mathrm{U}(1, T)}
     \sum_{i=1}^{M} \mathrm{CrossEntropy}(\v{a}'_i, \hat{\v{a}}'_{i}),
\end{equation}
where $\hat{\rva}_i$ are the probabilities predicted by the model $\phi(\gC'_t, t)$. 
To sample from the discrete diffusion model, we sample from the marginal distribution over atom types $\v{m}_{a}$, then progressively denoise using:
\begin{equation}
    q(\v{a}_{t-1} | \v{a}_t, \v{a}_0) = \mathrm{Cat}\left( \v{a}_{t-1} ; \v{p} = \frac{\v{a}_t^\top\mathbf{Q}_t^\top \odot \v{a}_0^\top \bar{\mathbf{Q}}_{t-1}}{\v{a}_0^\top \bar{\mathbf{Q}}_t \v{a}_t} \right)
\end{equation}
More details of this implementation can be seen in \cite{vignac2023digress}.

\paragraph{Diffusion for site symmetries $\rmS$}
The site symmetry representation matrices described in Section \ref{sec:sitesymm} can be thought of as 15 separate 13-dimensional categorical variables: one site symmetry operation per axis.
Our diffusion model over site symmetries is almost identical to the method for atom types, applying discrete diffusion  separately over each of the axes.
Because the site symmetries depend strongly on the space group, we use transition matrices that are different for each space group: $\mathbf{Q}_{t, i, G} = \alpha_t \v{I} + \beta_t \v{m}_{S_{\alpha}, G}$, where $\v{m}_{S_u, G}$ denotes the marginals over site symmetry operations for axis $S_{u}$ given space group $G$. For each representative node, we average the cross-entropy loss over each of the axes.

\section{Architecture Details} 
\subsection{Denoising Model}\label{app:architecture}
We use a graph neural network based on the architecture of \cite{jiao2023crystal}.
We embed the timestep $t$ using sinusoidal embeddings, $\psi_t(t)$.
We embed our space group representation from \cref{sec:sg_rep} using an MLP, $\phi_G(G)$.
We embed our site symmetries by separately embedding each axis using the same network, and feeding the resulting embeddings into a secondary MLP: $\phi_S(\bigoplus_{u=1}^{15} \phi_{U}(S_u))$. 
These are all used to initialize the node embeddings $\rvh_i$.
\begin{equation*}
    \rvh_i \gets \phi_h(\rva_i, \rvx_i, \phi_S\left(\bigoplus_{u=1}^{15} \phi_{U}(S_u)\right), \phi_G(G), \psi_t(t)).
\end{equation*}
As noted earlier, we directly use coordinates $\rvx$, because we are working a conventional or canonical lattice, and so Euclidean symmetries are not necessarily useful here.

At each layer we compute messages and use them to update node embeddings:
\begin{align*}
    \rvm_{ij} & \gets \phi_{m}(\rvh_i, \rvh_j, \rvk,  \psi(\rvx_i - \rvx_j)) \\
    \rvh_i &\gets \rvh_i + \phi_{h}(\rvh_i, \sum_{j}^{M} \rvm_{ij})
\end{align*}
Here, $\psi$ is a Fourier embedding, $\phi_m$ and $\phi_h$ are MLPs acting on edges and nodes respectively. We use a SiLU activation function for each MLP.
Finally, we output predicted  $ \hat{\epsilon}_{\v{X}'}, \hat{\v{A}}'$ and $\hat{\v{S}}$  using the node embeddings $\rvh_i$, and $\hat{\epsilon}_{\v{k}}$ using $\sum_i^M \rvh_i$.

\subsection{Model Hyperparameters} \label{app:hparams}

The graph neural network has 8 layers, and we use a representation dimension of 1024 for $\rvh_i$.
We encode distances between nodes using a sinusoidal embedding, with 128 different frequencies.
We encode the timestep $t$ into a 10 dimensional vector. We apply layer normalization at each layer of the GNN.
The loss coefficients selected were $\lambda_{\rvk} = 5, \lambda_{\rmX'} = 1, \lambda_{\rmA'} = 0.1$ and $\lambda_{\rmS} = 10$.

We performed two hyperparameter sweeps: we first tested each combination of 
$\lambda_{\rvk}$, $\lambda_{\rmA'}$ and $\lambda_{\rmS}$ set to values in $\{0.1, 0.5, 1, 5, 10\}$, while keeping $\lambda_{\rmX'}$ fixed at 1, and then selected the loss coefficients that lead to the highest structural validity. Next, we performed a random sweep of other architecture parameters, running 150 different hyperparameter combinations and choosing a model that had high performance on  structural validity, compositional validity, and $d_E$.
We varied the number of GNN layers in $\{6, 8, 12, 16\}$, representation dimension in $\{256, 512, 1024\}$, time embedding dimension in $\{10, 64, 256\}$, and varied whether layer normalization was used.


\section{Extended Results}

\subsection{MPTS 52 Dataset \label{app:mpts}}

\begin{figure}[t]
\vspace{-8ex}
    \centering
    \includegraphics[width=0.95\linewidth]{images/mpts52_sgs.png}
\vspace{-2ex}
        \caption{Proportion of space group symmetries of the MPTS-52 dataset. From left to right, the first few space groups are: Pnma, P2$_1$/c, Fm$\bar{3}$m, I4/mmm, P6$_3$/mmc, Pm$\bar{3}$m, C2/m,  C2/c, $\bar{1}$, and Cmcm.}
        \label{fig:sg_composition_mpts52}
\end{figure}
\vspace{-1ex}


In addition to MP-20, we also trained SymmCD on the MPTS-52 dataset \citep{baird2024matbench}, a more challenging subset of the Materials Project that contains materials with up to 52 atoms per primitive unit cell. Unlike MP-20, it does not filter out materials containing radioactive elements.
The dataset contains 40,476 samples with a train/validation/test split of 27,380/5,000/8,096 crystals.
The splits are in chronological order, with the materials in the test set having been discovered most recently, and the materials in the training set having been discovered earliest.
The distribution of space groups found in the dataset are shown in \Cref{fig:sg_composition_mpts52}.
None of the diffusion and flow-based methods we compared against (CDVAE, DiffCSP, DiffCSP++, or FlowMM) have reported de-novo generation results on this dataset.

We trained SymmCD on MPTS-52 using all of the same hyperparameters as were used for the MP-20 dataset, but trained for 1500 epochs. We sampled 10,000 crystals, and checked the same proxy metrics. We also relaxed the generated crystals using CHGNet and checked for whether the generated crystals were S.U.N.
The unique templates (as described in \Cref{sec:results_symm}) of the dataset and of our generated crystals are shown in \Cref{tab:templates_mpts}.
The results for the proxy metrics are shown in \Cref{tab:mpts52_proxy} and stability results are shown in \Cref{tab:mpts52_sun}.

\begin{table}
\begin{minipage}{.5\linewidth}
\small{

    \centering
\vspace{-1em}
    \caption{Template statistics for MPTS-52 \label{tab:templates_mpts}}
    \vspace{-1em}
    \begin{tabular}{@{}llll@{}}
    \toprule
%                  & \multicolumn{3}{c}{Templates}                  \\ \midrule
           Method       & \# Unique        & \% in Train & \# New        \\ \midrule
    Training Set  & 4452          & 100            & -           \\
     SymmCD & 2772 & 48.3           & 1432 \\ 
\bottomrule
    \end{tabular}
}

\end{minipage}
\begin{minipage}{.5\linewidth}
    \small{

    \centering
\vspace{-1em}
\caption{Percent of stable and S.U.N. samples produced from an initial set of 10,000 generated crystals for SymmCD trained on the MPTS-52 dataset.\label{tab:sun_mpts}}
    \vspace{-1em}
\begin{tabular}{@{}llll@{}}
\toprule
          & Initial  & Relaxed & Relaxed \\
          & Stable &  Stable & S.U.N. \\  \midrule
       & 1.72\%             & 5.97\%             & 4.62\%    \\  
\bottomrule
\label{tab:mpts52_sun}
\end{tabular}}
\end{minipage}
\\
\begin{minipage}{\linewidth}
\caption{The validity, coverage, and property distribution metrics for SymmCD trained on the MPTS-52 dataset.}
\label{tab:mpts52_proxy}
%\resizebox{1.\textwidth}{!}{
\centering
\begin{tabular}{@{}ll|ll|lllll@{}}
                  \multicolumn{2}{c|}{Validity (\%) ($\uparrow$)}          & \multicolumn{2}{c|}{Coverage (\%) ($\uparrow$)}                           & \multicolumn{4}{c}{Property Distribution ($\downarrow$)} \\
                 Struct.     & Comp.      & Recall        & Precision       & $d_\rho$               &         $d_E$  &         $d_{\mathrm{elem}}$ &         $d_{\mathrm{sg}}$ &          \\
\midrule

                $ 90.1$& $79.2$&$99.6$&$ 96.3$&$ 0.844 $&$0.549$&$0.317$&$ 0.274$&  \\
\midrule
\end{tabular}
%}
\end{minipage}
\end{table}


\subsection{Number of atoms}

\begin{figure}[ht]
    \centering
    %\vspace*{-4em}
    \includegraphics[width=0.50\textwidth]{images/multiplicity.png}
    \vspace{-1em}
    \caption{Histogram of the number of atoms in crystals from MP-20 and generated by SymmCD when trained on MP-20.}
    \label{fig:multiplicity}

\end{figure}
To demonstrate that SymmCD is able to correctly predict reasonable site symmetries, we show here that the distribution of number of atoms per crystal matches the dataset it is trained on.
This is not a trivial task, as the model needs to learn the multiplicity of different possible site symmetries, which depends on both the different symmetry elements of the site symmetry and the space group that it belongs to.
The comparison for MP-20 is shown in \Cref{fig:multiplicity}, and the comparison for MPTS-52 is shown in \Cref{fig:multiplicity2}.
\begin{figure}%{R}{1.\linewidth}
    \centering
    %\vspace*{-4em}
    \includegraphics[width=1.\textwidth]{images/symmcd_mpts52_n_atoms_wide.png}
    \vspace{-1em}
    \caption{Histogram of the number of atoms in crystals from MPTS-52 and generated by SymmCD when trained on MPTS-52.}
    \label{fig:multiplicity2}
\end{figure}



\subsection{Property Prediction task}
\label{subsec:property-prediction-task}
\begin{wraptable}{R}{5.5cm}
 \caption{Mean average error when predicting crystal formation energy. 
    The input could be the asymmetric unit or a multi-graph, and the site symmetry information can be encoded or ignored. We observe that our encoding of site symmetry helps predict the target property.}
\begin{tabular}{@{}l|ll@{}}
\toprule
             & Multigraph & Asymm. Unit \\ \midrule
W/out $\rmS$ & 0.0214     & 0.0711      \\
With $\rmS$  & 0.0212     & 0.0490      \\ \bottomrule
\end{tabular}
\label{tab:test-mae-form-energy}
\end{wraptable} 
We test the usefulness of our site symmetry representation using a regression experiment. 
%The objective of this experiment is to demonstrate the usefulness of our site symmetry representation.
%Since we cannot remove this information from our generative model for the purpose of an ablation, we consider
%a regression task instead.
%Property prediction is a regression task that accurately predicts specific properties of an input crystal. 
We selected formation energy per atom as the target property to predict. 

We use DimeNet++ \citep{gasteiger2020directional, gasteiger2020fast} as a base model to perform ablation over the type of input graph and encoding site symmetry information per node. 

One input format is a multi-graph \citep{xie2022crystal}, which describes the unit cell as a graph with nodes as atoms and edges between them according to a cutoff radius. These edges could potentially span to neighbouring unit cells.
The other input format is the asymmetric unit that we use in SymmCD.
Under these two inputs, we test the effects of including a site symmetry encoding for each node.
We report the Mean Absolute Error (MAE) for the test set in Table \ref{tab:test-mae-form-energy}.
We see that the effect of including site symmetry information is minimal when we have access to the full graph.
However, we see that when we are restricted to only using the asymmetric unit, having access to the site symmetry info greatly helps, showing that we can recover some geometric information lost when using just an asymmetric unit by also including symmetry.

\subsection{Examples}\label{app:examples}
In \cref{fig:examples}, we include 6 randomly sampled crystals generated by SymmCD along with their respective space groups.
% \section{You \emph{can} have an appendix here.}

% You can have as much text here as you want. The main body must be at most $8$ pages long.
% For the final version, one more page can be added.
% If you want, you can use an appendix like this one.  

% The $\mathtt{\backslash onecolumn}$ command above can be kept in place if you prefer a one-column appendix, or can be removed if you prefer a two-column appendix.  Apart from this possible change, the style (font size, spacing, margins, page numbering, etc.) should be kept the same as the main body.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%


\begin{figure}[h!]
    \centering
    % First row
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\linewidth]{images/examples/PaTi3-Pm-3m.png}
        \caption{PaTi$_3$\quad Pm$\bar{3}$m}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\linewidth]{images/examples/CeSiGe2Os-I4mm.png}
        \caption{CeSiGe$_{2}$Os\quad I4mm}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\linewidth]{images/examples/Cs2CuO4-I4_mmm.png}
        \caption{Cs$_2$CuO$_4$ \quad I4$_{\textrm{m}}$mm}
    \end{subfigure}
    
    % Second row
    \vspace{0.5cm}
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\linewidth]{images/examples/SrYO3-I4_mcm.png}
        \caption{SrYO$_3$ \quad I4$_{\textrm{m}}$cm}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\linewidth]{images/examples/Ta2Nb4V4CoMo2C-Pmmm.png}
        \caption{Ta$_2$Nb$_4$V$_4$CoMo$_2$C \hskip0.5em Pmmm}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.3\textwidth}
        \includegraphics[width=\linewidth]{images/examples/TbInAu2-Fm-3m.png}
        \caption{TbInAu$_2$ \quad  Fm$\bar{3}$}
    \end{subfigure}

    \caption{Example materials generated by SymmCD, along with their chemical formulate and space groups symmetries.}
    \label{fig:examples}
\end{figure}

\begin{comment}
   

\end{comment}
\subsection{Proxy Metrics}\label{app:proxy}
We compare the different methods using the metrics established by \cite{xie2022crystal}, measuring the validity, coverage, and property statistics of the generated crystals.
We measure the validity by checking structural validity, defined as whether no two atoms are closer than 0.5 {\AA} apart, and compositional validity, defined as whether the charges are balanced as determined by SMACT \citep{davies2019smact}. It should be noted that the compositional validity of the MP-20 dataset is only 92\%.
To determine coverage, we examine the CrystalNN structural fingerprints \citep{zimmermann2020local} and Magpie compositional fingerprints \citep{ward2016general} of the valid generated crystals, and look at their distances to the fingerprints of the crystals in the test set.
If the distance is under some cutoff, then the crystals are matched, giving both recall and precision metrics.
We look at the distances between the properties of the valid generated crystals and the crystals from the test set to compare the ability of each model to match the data distribution.
We specifically compare the Wasserstein distances between the atomic densities $d_{\rho}$, number of unique elements $d_{\mathrm{elem}}$, and the formation energy $d_{\mathrm{E}}$ predicted by a pretrained DimeNet++ model \citep{gasteiger2020fast}.
We also look at the Jensen-Shannon distance between the space groups of the generated valid structures and the space groups of the crystals in the test set, denoted by  $d_{\mathrm{sg}}$.
The coverage and property statistics are computed only for a random subset of 1000 valid crystals per method. For each method, we train 5 different models with different random seeds so that we could see the variance for each of the metrics.


\subsection{Density functional theory}\label{app:dft}

We performed cell and geometry relaxation calculations using the PBE functional, \texttt{DZVP-MOLOPT-SR-GTH} basis set, and \texttt{GTH-PBE} pseudopotential with the \texttt{QUICKSTEP} program from \texttt{CP2K} \citep{perdewGeneralizedGradientApproximation1996, kuhneCP2KElectronicStructure2020}. \cref{tab:dftsettings} shows the settings---particularly convergence thresholds---used for performing the relaxations. Values were generally tuned to balance between a feasible computational budget and a fair benchmark between methods: as an example, we allow relaxations to attempt to continue even with poorly convergent SCF in the hopes that optimization trajectories will still have a chance of finding a local minimum. With that in mind, we note that the convergence thresholds are also generally set to relatively ``lax'' values, and for end property values stricter convergence thresholds may be necessary.

\cref{fig:atom-displacement} shows distributions of the cumulative atom displacement, averaged over structures for each method: in other words, the total distance the average atom travels over the full course of the relaxation. Naturally, the less atom displacement, the more likely a given generative method produces high fidelity crystal structure samples. We see that DiffCSP++ and both treatments of SymmCD produce samples with displacements that peak close to zero, while other methods peak closer to ${\sim}4.5$\AA. The relatively long tails out to high cumulative displacements seen with CDVAE and FlowMM are attributed to trajectories that do not converge after the specified number of relaxation steps. From this, we can conclude that with the exception of SymmCD and DiffCSP++, the tested generative methods demonstrate a similar degree of fidelity requiring some degree of optimization.

\cref{fig:max-grad-ecdf} shows empirical distribution functions of the maximum gradient value at the end of the relaxation trajectory, regardless of the state of convergence: the smaller the maximum gradient is, the closer the relaxation ended in a local minimum. The first observation is that across all methods, a significant portion (${\sim}$60\%) of trajectories fail to converge (the portion to the right of the dashed line)---the majority of sampled structures fail to converge, based on our naive attempt to relax them using our reasonable choice of method, basis set, and pseudopotential. Another observation is the long tail towards low values for the 10 space group treatment of SymmCD, which provides compelling evidence for extremely high fidelity samples being produced by SymmCD.
The expected values of the maximum gradient for each method are shown in \Cref{tab:expecvalues}, where we can observe that SymmCD tends to have a lower maximum gradient after relaxation.

\begin{table}[]
    \centering
    \caption{Configuration settings for CP2K. Settings that are omitted from this table assume their default values.}
    \begin{tabular}{l | r}
        \toprule
         Parameter & Value \\   
         \midrule
         \multicolumn{2}{c}{Base SCF settings} \\
         \texttt{EPS\_SCF} & $10^{-7}$ \\
         \texttt{MAX\_SCF} & $300$ \\
         \texttt{MAX\_ITER\_LUMO} & $400$ \\
         \texttt{IGNORE\_CONVERGENCE\_FAILURE} & \texttt{T} \\
         \multicolumn{2}{c}{Orbital transformation} \\
         Orbital transformation method & \texttt{IRAC} \\
         \texttt{ENERGY\_GAP} & $10^{-3}$ \\
         \texttt{MINIMIZER} & \texttt{DIIS} \\
         \texttt{LINESEARCH} & \texttt{2PNT} \\
         \texttt{PRECONDITIONER} & \texttt{FULL\_ALL} \\
         \multicolumn{2}{c}{Outer SCF settings} \\
         \texttt{MAX\_SCF} & $20$ \\
         \texttt{EPS\_SCF} & $10^{-6}$ \\
         \multicolumn{2}{c}{Cell optimization} \\
         \texttt{TYPE} & \texttt{DIRECT\_CELL\_OPT} \\
         \texttt{MAX\_ITER} & $100$ \\
         \texttt{OPTIMIZER} & \texttt{BFGS} \\
         \multicolumn{2}{c}{Geometry optimization} \\
         \texttt{MAX\_DR} & $3\times10^{-3}$ \\
         \texttt{MAX\_FORCE} & $9\times10^{-4}$ \\
         \texttt{RMS\_DR} & $1.5\times10^{-3}$ \\
         \texttt{RMS\_FORCE} & $6\times10^{-4}$ \\
         \texttt{MAX\_ITER} & $100$ \\
         \texttt{OPTIMIZER} & \texttt{BFGS} \\
         BFGS \texttt{TRUST\_RADIUS} & $0.25$ \\
         \bottomrule
    \end{tabular}
    \label{tab:dftsettings}
\end{table}

\begin{figure}
    \centering
    \includegraphics[width=0.8\linewidth]{images/atom_displacement.pdf}
    \caption{Distribution of total atom displacements over the course of relaxation. Displacements are averaged over structures for a given method.}
    \label{fig:atom-displacement}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.8\linewidth]{images/final_max_grad_ecdf.pdf}
    \caption{Empirical cumulative distribution plots for the maximum, absolute value of the gradient across atoms after relaxation, regardless of convergence. The dashed line indicates the convergence threshold stated in \cref{tab:dftsettings}.}
    \label{fig:max-grad-ecdf}
\end{figure}

\begin{table}[]
    \centering
    \caption{Expected values of the maximum gradient for each method from integrating the curves in \cref{fig:max-grad-ecdf}.}
    \begin{tabular}{l | c}
    \toprule
         Method & $\mathbb{E}[\vert \nabla \vert_\mathrm{max}]$ ($\downarrow$) \\
         \midrule
         DiffCSP & 0.000494 \\
         CDVAE & 0.000235 \\
         FlowMM & 0.000083 \\
         DiffCSP++ & 0.000072 \\
         SymmCD (All groups) & 0.000057 \\
         SymmCD (10 SGs) & 0.000038 \\
         \bottomrule
    \end{tabular}
    \label{tab:expecvalues}
\end{table}

\end{document}
