\section{Formal Definition}\label{sec:formaldef}

This section presents the formal definitions corresponding to our framework. For a discussion about the various choices made here, see \cref{sec:walkthrough}.

\pj{\Cref{sec:notation} contains a glossary of the notation we use, \Cref{sec:def-incoherent-predictor} formally defines the notion of \emph{incoherence} that we measure, \cref{sec:def-demcoh} defines what it means for an algorithm to be \emph{demographically incoherent}, and \Cref{sec:def-coherence-enforcing} defines what it means for a data curation algorithm to be \emph{coherence enforcing}.} 

\subsection{Notation}\label{sec:notation}

\ifnum\usenix=1
\begin{itemize}[leftmargin=*,itemsep=0pt]
\else
\begin{itemize}
\fi
    \item We define a data universe $\univ = (\zo^* \cup \perp)^*$, where each feature of the data can also take the value $\perp$ (a.k.a. null).
    
    \item We denote a dataset consisting of $n$ records from $\univ$ by dataset $X \in \univ^n$. \footnote{In a real-world scenario, $X$ might be sampled from some underlying population, but our definition does not require this and makes no assumptions about how it might be done.}

    \item We consider a collection $\cC$ of sub-populations $C \subseteq \univ$.

    \item For any dataset $X$ and sub-population $C \in \cC$, we define $X|_C \defeq X \cap C$ to be the restriction of $X$ to the sub-population $C$, \ie the members of the dataset $X$ that belong to sub-population $C$. 

    \item We define a lens $\selection$ as a set of features from $\univ$.
    
    \item For a lens $\selection$, we define $\restrict{X}{\selection}$ to be the data in $X$ restricted to the features in the lens. That is, for every feature represented by $\selection$, the sets $\restrict{X}{\selection}$ and $X$ are exactly the same, and for features not represented by $\selection$, the entries in $\restrict{X}{\selection}$ always have the value $\perp$. 
    
    \item For any fixed predictor $h: \univ \to [-1,1]$, define the distribution $h(X)$ as the uniform distribution over the predictions of $h$ on $X$. That is, the distribution $h(X)$ has cumulative distribution function
    $$cdf_{h(X)}(p) = \underset{x \setrandomly X}{\Pr}[h(x) \leq p].$$
\end{itemize}

\subsection{Measuring Demographic Incoherence of Predictors}\label{sec:def-incoherent-predictor}

\pj{In this section we define the notion of \emph{incoherence} that we measure over predictors. This measurement is used informally in the demographic coherence experiment $\coherenceExp$ (\cref{fig:coherenceExp}).}

\begin{definition}[Demographically Incoherent Predictor]\label{def:incoherent-predictor}
    Let $\univ$ be a data universe, let $X_a, X_b \in \univ^{n/2}$ be datasets consisting of $n/2$ data entries each, let $\cC$ be a collection of sub-populations $C \subseteq \univ$, let the lens $\selection$ be a set of features from $\univ$, and let $h: \univ \to [-1,1]$ be a confidence rated predictor. Let $d(\cdot,\cdot)$ represent some metric distance between probability distributions.
    
     \medskip\noindent
     We say that the $h$ has \emph{$\alpha$-incoherent predictions} with respect to $X_a$, $X_b$, $\selection$, and $\cC$, if for some $C \in \cC$, 
     \[ d\Big(h(\restrict{X_a|_C}{\selection}),\, h(\restrict{X_b|_C}{\selection})\Big) > \alpha \] 
    
    \medskip\noindent
    (In contrast, $h$ has \emph{$\alpha$-coherent predictions} with respect to $X_a$, $X_b$, $\selection$, and $\cC$, if for all $C \in \cC$, it satisfies $d\Big(h(\restrict{X_a|_C}{\selection}),\, h(\restrict{X_b|_C}{\selection})\Big) \leq \alpha$)
\end{definition}

\medskip\noindent
In other words, the predictions of $h$ are incoherent if there is some sub-population $C$ that witnesses a big distance between its predictions on two sets $X_a$, and $X_b$. Note that this definition distills a notion of `incoherence' only once we fix some assumptions on $X_a,X_b$, perhaps that they are drawn from similar distributions. 

\subsection{Demographic Coherence}\label{sec:def-demcoh}

Consider a data universe $\univ$, an algorithm $\cL: \univ^{n/2}\to (\univ \to [-1,1])$ which uses a dataset of size $n/2$ to produce a confidence-rated predictor $h: \univ \to [-1,1]$. Let $\cC$ be a collection of sub-populations $C \subseteq \univ$, let the lens $\selection$ be a set of features from $\univ$,  Let $\dist(\cdot,\cdot)$ represent some metric distance between probability distributions.

\pj{In this section, we formally define when the algorithm $\cL$ is \emph{demographically coherent}. We start by defining the demographic coherence experiment $\coherenceExp$ which checks the demographic coherence of $\cL$ with respect to on a specific dataset $X$, a collection $\cC$, a lens $\rho$, and a distance metric $\dist(\cdot,\cdot)$. This experiment works similarly to the description under \emph{our approach} in \cref{sec:detecting-incoheret-algorithms}, expect we are testing the coherence of an algorithm that gets the dataset in the clear. In \cref{sec:def-coherence-enforcing}, we will use the notion of demographic coherence to define when a data curator is \emph{coherence enforcing}. 

In the $\coherenceExp$ experiment, the input dataset $X$ is split into sets $X_a, X_b$ where $X_b$ is held in reserve as a ``test'' set. Then the algorithm $\cL$, with input $X_a$, is used to produce a predictor $h$. Finally, the predictor $h$ is checked for \emph{demographic incoherence} (Def~\ref{def:incoherent-predictor}) with respect to $X_a,X_b,\rho$, and $\cC$.}

\input{figs/fig-coherence-exp}

\medskip\noindent
A natural formalization of the intuition we developed in \cref{sec:walkthrough} would say that an algorithm $\cL$ produces $(\alpha,\beta)$-demographically coherent predictions with respect to collections $\cC$ and lens $\selection$ if the following holds for all datasets $X$:
 \[\Pr[\coherenceExp_{\cL,X,\cC,\selection}(\alpha) = 0] \leq \beta.\]
However, this definition cannot be realized with respect to arbitrary categories $C$ and all datasets, because the sampling experiment in and of itself introduces some incoherence. For example, consider a category $C$ that is men over 60, and a dataset that contains only two people in this category. There exists a predictor that predicts $-1$ on one of them and $1$ on the other. With probability $1/2$, these two men end up in $X_a$ and $X_b$ respectively, and the Wasserstein distance between the predictors' distributions on $X_a|_C$ and $X_b|_C$ is $2$. Hence, for our definition to be meaningful and achievable, we need that the datasets considered are sufficiently representative that the incoherence due to sampling does not dominate. Thus, in order to make the definition achievable, we define demographic coherence with respect to a size constraint. 

\pj{To remove the need for the parameter $\gamma$, one could redefine $X_a|_C$ by ``zeroing out'' members of $X_a$ that are not in $C$ instead of taking the intersection $X_a\cap C$. This would effectively result in asking the predictor $h$ in \cref{def:incoherent-predictor}, and \cref{fig:coherenceExp} to make ``dummy'' predictions, with no information, for every member of $X_a$ and $X_b$ not belonging to $C$. While such a definition may be more mathematically elegant, we believe that the explicit failure point represented by $\gamma$ in our defintion is important for interpretability and ease of use---especially by non-experts. For the same reason, it is important to have an explicit collection $\cC$, and lens $\rho$, even though the eventual theorems one can prove may only hold for large choices of $\gamma$, $\cC$, and $\rho$. \mb{I reworded this slightly, but I didn't understand what you meant by big $\rho$. Shouldn't ``small'' $\rho$ make it easier to prove things?}\pjnote{Where did I say big $\rho$?}}

\begin{restatable}{definition}{DefCoherence}\label{def:coherence}
    {\normalfont(Demographic Coherence)\textbf{.}}
    Consider a data universe $\univ$, and an algorithm $\cL: \univ^{n/2}\to (\univ \to [-1,1])$ which uses a dataset of size $n/2$ to produce a fixed confidence-rated predictor $h: \univ \to [-1,1]$. Let $\cC$ be a collection of sub-populations $C \subseteq \univ$, let the lens $\selection$ be a set of features from $\univ$,  Let $\dist(\cdot,\cdot)$ represent some metric distance between probability distributions. 
    We say that \emph{$\cL$ produces $(\alpha,\beta)$-demographically coherent predictions} with respect to collection $\cC$, size-constraint $\gamma$, and lens $\selection$ if the following holds:

    \medskip\noindent 
    For all $X \in \cX^n$, $\cC^*= \{C\in\cC \mid\, |C\cap X| \geq \gamma\}$
    \[\Pr[\coherenceExp_{\cL,X,\cC^*,\selection}(\alpha) = 0] \leq \beta.\]
\end{restatable}

\subsection{Coherence Enforcing Algorithms}\label{sec:def-coherence-enforcing}

We finally define \emph{coherence-enforcing} algorithms by reference to the definition of \emph{demographic coherence} (\cref{def:coherence}). \pj{Specifically, a data curator $\alg$ is \emph{coherence enforcing} if, any algorithm $\cL$ can be rendered \emph{\coherent} simply by filtering its inputs through the data curator $\alg$, without many any changes to the algorithm itself.}

\begin{restatable}{definition}{DefCoherenceEnforcing}\label{def:coherenceEnforcing}
    {\normalfont(Coherence Enforcing Algorithms)\textbf{.}}
    Consider data universes $\univ, \mathcal{Y}$, a collection $\cC$ of sub-populations $C \subseteq \univ$, a lens $\selection$, and an algorithm $\alg:\univ^{n/2} \to \mathcal{Y}$. Let $\dist(\cdot,\cdot)$ represent some metric distance between probability distributions. 

    \medskip\noindent
    We say that $\alg$ enforces $(\alpha,\beta)$-demographic coherence with respect to collection $\cC$, size-constraint $\gamma$, and lens $\selection$ if:

    \medskip\noindent
    For any algorithm $\cL:\mathcal{Y}\to(\cX\to[-1,1])$, the combined algorithm $\cL\circ\alg:\univ^{n/2} \to (\univ \to [-1,1])$ satisfies $(\alpha,\beta)$-demographic coherence with respect to  the collection $\cC$, size-constraint $\gamma$,  and lens $\selection$.
\end{restatable}

\subsection{Instantiating Demographic Coherence with a Metric}

In the definitions above, we do not use a specific metric. The metric we will use to instantiate these definitions in the following sections is the Wasserstein-1 metric defined below.

\begin{definition}\label{def:wasserstein-distance}
    Let $P,Q$ represent distributions over a discrete subset $S \subseteq \mathbb{R}$. Then, the $1$-Wasserstein distance between $P,Q$ is defined as    
    $$\wass(P,Q) = \inf_\pi \sum_{i \in S} \sum_{j \in S} \|x_i - x_j \|_1 \pi(x_i,x_j),$$
   where the infimum is over all joint distributions $\pi$ on the product space $S \times S$ with marginals $P$ and $Q$ respectively. 
\end{definition}

If an algorithm is $(\alpha, \beta)$-demographically-coherent as per \Cref{def:coherence} with this Wasserstein metric instantiation, we say that it is \emph{$(\alpha, \beta)$-Wasserstein-demographically-coherent} (or $(\alpha,\beta)$-Wasserstein-coherent for short.) Similarly, if an algorithm enforces $(\alpha, \beta)$-demographic-coherence as per \Cref{def:coherenceEnforcing} with this Wasserstein metric, then we say it \emph{enforces $(\alpha, \beta)$-Wasserstein-demographic-coherence} (or it enforces $(\alpha, \beta)$-Wasserstein-coherence for short.)