\documentclass[a4paper,USenglish,cleveref,autoref,thm-restate]{lipics-v2021}
%This is a template for producing LIPIcs articles. 
%See lipics-v2021-authors-guidelines.pdf for further information.
%for A4 paper format use option "a4paper", for US-letter use option "letterpaper"
%for british hyphenation rules use option "UKenglish", for american hyphenation rules use option "USenglish"
%for section-numbered lemmas etc., use "numberwithinsect"
%for enabling cleveref support, use "cleveref"
%for enabling autoref support, use "autoref"
%for anonymousing the authors (e.g. for double-blind review), add "anonymous"
%for enabling thm-restate support, use "thm-restate"
%for enabling a two-column layout for the author/affilation part (only applicable for > 6 authors), use "authorcolumns"
%for producing a PDF according the PDF/A standard, add "pdfa"

\pdfoutput=1 %uncomment to ensure pdflatex processing (mandatatory e.g. to submit to arXiv)
\hideLIPIcs  %uncomment to remove references to LIPIcs series (logo, DOI, ...), e.g. when preparing a pre-final version to be uploaded to arXiv or another public repository

%\graphicspath{{./graphics/}}%helpful if your graphic files are in another directory

\nolinenumbers

\bibliographystyle{plainurl}% the mandatory bibstyle

\title{A Program Logic for Under-approximating Worst-case Resource Usage} %TODO Please add

%\titlerunning{Dummy short title} %TODO optional, please use if title is longer than one line

\author{Ziyue Jin}{Peking University}{zyjin@stu.pku.edu.cn}{}{}
\author{Di Wang}{Peking University}{wangdi95@pku.edu.cn}{}{}

\authorrunning{Z. Jin and D. Wang}

%\author{Jane {Open Access}}{Dummy University Computing Laboratory, [optional: Address], Country \and My second affiliation, Country \and \url{http://www.myhomepage.edu} }{johnqpublic@dummyuni.org}{https://orcid.org/0000-0002-1825-0097}{(Optional) author-specific funding acknowledgements}%TODO mandatory, please use full name; only 1 author per \author macro; first two parameters are mandatory, other parameters can be empty. Please provide at least the name of the affiliation and the country. The full address is optional. Use additional curly braces to indicate the correct name splitting when the last name consists of multiple name parts.

%\author{Joan R. Public\footnote{Optional footnote, e.g. to mark corresponding author}}{Department of Informatics, Dummy College, [optional: Address], Country}{joanrpublic@dummycollege.org}{[orcid]}{[funding]}

%\authorrunning{J. Open Access and J.\,R. Public} %TODO mandatory. First: Use abbreviated first/middle names. Second (only in severe cases): Use first author plus 'et al.'

%\Copyright{Jane Open Access and Joan R. Public} %TODO mandatory, please use full first names. LIPIcs license is "CC-BY";  http://creativecommons.org/licenses/by/3.0/

\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10003752.10003790.10003806</concept_id>
<concept_desc>Theory of computation~Programming logic</concept_desc>
<concept_significance>500</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Theory of computation~Programming logic}
%TODO mandatory: Please choose ACM 2012 classifications from https://dl.acm.org/ccs/ccs_flat.cfm 

\keywords{Under-approximation, Incorrectness logic, Worst-case Resource Bounds} %TODO mandatory; please add comma-separated list of keywords

%\category{} %optional, e.g. invited paper

%\relatedversion{} %optional, e.g. full version hosted on arXiv, HAL, or other respository/website
%\relatedversiondetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93]{Classification (e.g. Full Version, Extended Version, Previous Version}{URL to related version} %linktext and cite are optional

%\supplement{}%optional, e.g. related research data, source code, ... hosted on a repository like zenodo, figshare, GitHub, ...
%\supplementdetails[linktext={opt. text shown instead of the URL}, cite=DBLP:books/mk/GrayR93, subcategory={Description, Subcategory}, swhid={Software Heritage Identifier}]{General Classification (e.g. Software, Dataset, Model, ...)}{URL to related version} %linktext, cite, and subcategory are optional

%\funding{(Optional) general funding statement \dots}%optional, to capture a funding statement, which applies to all authors. Please enter author specific funding statements as fifth argument of the \author macro.

%\acknowledgements{I want to thank \dots}%optional

%\nolinenumbers %uncomment to disable line numbering



%Editor-only macros:: begin (do not touch as author)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\EventEditors{John Q. Open and Joan R. Access}
%\EventNoEds{2}
%\EventLongTitle{42nd Conference on Very Important Topics (CVIT 2016)}
%\EventShortTitle{CVIT 2016}
%\EventAcronym{CVIT}
%\EventYear{2016}
%\EventDate{December 24--27, 2016}
%\EventLocation{Little Whinging, United Kingdom}
%\EventLogo{}
%\SeriesVolume{42}
%\ArticleNo{23}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\usepackage{amsmath}
\usepackage{mathpartir}
\usepackage{mathtools}
\usepackage{dsfont}
\usepackage{xcolor}
\usepackage{MnSymbol}
\usepackage{graphicx}
\usepackage{stmaryrd}
\usepackage{anyfontsize}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{shortcuts}
\usepackage{cleveref}
\usepackage{booktabs}
\crefname{theorem}{Thm.}{Thms.}
\crefname{lemma}{Lem.}{Lemmas}
\crefname{corollary}{Cor.}{Cors.}
\crefname{figure}{Fig.}{Figs.}
\crefname{definition}{Defn.}{Defns.}
\crefname{table}{Tab.}{Tabs.}
\crefformat{section}{\S#2#1#3}
\crefmultiformat{section}{\S#2#1#3}{ and~\S#2#1#3}{, \S#2#1#3}{ and~\S#2#1#3}
\crefname{example}{Ex.}{Exs.}
\crefname{item}{item}{items}
\crefname{footnote}{footnote}{footnotes}
\crefname{observation}{Obs.}{Obs.}
\crefname{remark}{Remark}{Remarks}
\crefname{proposition}{Prop.}{Props.}
\crefname{equation}{Eqn.}{Eqns.}
\crefname{counterexample}{Counterexample}{Counterexamples}
\crefname{property}{Property}{Properties}
\crefname{algorithm}{Algorithm}{Algorithms}
\usepackage{subcaption}

\newcommand{\Blue}[1]{\textcolor{blue}{#1}}
\newcommand{\Red}[1]{\textcolor{red}{#1}}
\newcommand{\Gray}[1]{\textcolor{gray}{#1}}

\renewcommand{\dagger}{\text{\textdagger}}

\newcommand{\QBUAd}{QBUA\textsuperscript{$\Diamond$}\ }
\newcommand{\Bd}{B\textsuperscript{$\Diamond$}}

\newcommand{\pjudge}[3]{\vdash\left\{#1\right\}#2\left\{#3\right\}}

\newcommand{\Judge}[3]{\vDash\left[#1\right]#2\left[#3\right]}
\newcommand{\judge}[3]{\vdash\left[#1\right]#2\left[#3\right]}

\newcommand{\bjudge}[3]{\vdash_{\mathsf{B}}\left[#1\right]#2\left[#3\right]}
\newcommand{\fjudge}[3]{\vdash_{\mathsf{F}}\left[#1\right]#2\left[#3\right]}
\newcommand{\ajudge}[3]{\vdash_{\dagger}\left[#1\right]#2\left[#3\right]}
\newcommand{\djudge}[3]{\vdash^{\Diamond}_{\mathsf{B}}\left[#1\right]#2\left[#3\right]}
\newcommand{\bJudge}[3]{\vDash_{\mathsf{B}}\left[#1\right]#2\left[#3\right]}
\newcommand{\fJudge}[3]{\vDash_{\mathsf{F}}\left[#1\right]#2\left[#3\right]}
\newcommand{\dJudge}[3]{\vDash^{\Diamond}_{\mathsf{B}}\left[#1\right]#2\left[#3\right]}

\newcommand{\bbjudge}[5]{\vdash_{\mathsf{B}}\left[\left.#1\right|#2\right]#3\left[\left.#4\right|#5\right]}
\newcommand{\ffjudge}[5]{\vdash_{\mathsf{F}}\left[\left.#1\right|#2\right]#3\left[\left.#4\right|#5\right]}
\newcommand{\aajudge}[5]{\vdash_{\dagger}\left[\left.#1\right|#2\right]#3\left[\left.#4\right|#5\right]}
\newcommand{\ddjudge}[5]{\vdash^{\Diamond}_{\mathsf{B}}\left[\left.#1\right|#2\right]#3\left[\left.#4\right|#5\right]}
\newcommand{\AAjudge}[5]{\vdash_{\text{\textdaggerdbl}}\left[\left.#1\right|#2\right]#3\left[\left.#4\right|#5\right]}

\newcommand{\bigstep}[6]{\left\langle#1,#2,#3\right\rangle\Downarrow^{#4}\left\langle#5,#6\right\rangle}
\newcommand{\bigstepp}[5]{\left\langle#1,#2,#3\right\rangle\Downarrow\left\langle#4,#5\right\rangle}
\newcommand{\bigstepl}[5]{\left\langle#1,#2,#3\right\rangle\Downarrow^{\le 0}\left\langle#4,#5\right\rangle}

\newcommand{\eval}[2]{\left\llbracket#1\right\rrbracket#2}

\newcommand{\post}[2]{\mathrm{post}\left\llbracket#1\right\rrbracket\left(#2\right)}
\newcommand{\pre}[2]{\mathrm{pre}\left\llbracket#1\right\rrbracket\left(#2\right)}
\newcommand{\prel}[2]{\mathrm{pre}^{\le 0}\left\llbracket#1\right\rrbracket\left(#2\right)}

\newcommand{\Skip}{\textsf{skip}}
\newcommand{\Assign}[2]{#1\coloneqq#2}
\newcommand{\Assume}[1]{\textsf{assume}~#1}
\newcommand{\Tick}[1]{\textsf{tick}~#1}
\newcommand{\Seq}[2]{#1;#2}
\newcommand{\Choice}[2]{#1+#2}
\renewcommand{\Loop}[1]{#1^*}
\newcommand{\Ite}[3]{\textsf{if}~#1~\textsf{then}~#2~\textsf{else}~#3}
\newcommand{\IfB}[1]{\textsf{if}~#1~\textsf{then}}
\renewcommand{\Else}{\textsf{else}}
\renewcommand{\While}[2]{\textsf{while}~#1~\textsf{do}~#2}
\newcommand{\WhileB}[1]{\textsf{while}~#1~\textsf{do}}
\newcommand{\Local}[2]{\textsf{local}~#1~\textsf{in}~#2}
\newcommand{\Localx}[1]{\textsf{local}~#1~\textsf{in}}

\newcommand{\SR}[2]{\left[\left.#1\right|#2\right]} %Spec and Resource

\newcommand{\Fv}{\mathrm{fv}}
\newcommand{\Mod}{\mathrm{mod}}

\newcommand{\Rinf}{\mathbb{R}^{\pm\infty}}
\newcommand{\Sup}{\mathop{\scalebox{-1}[1]{\textsf{S}}}}
\newcommand{\Inf}{\mathop{\scalebox{-1}[1]{\textsf{J}}}}

\newcommand{\true}{\mathsf{true}}
\newcommand{\false}{\mathsf{false}}

\newcommand{\Null}{\mathsf{null}}
\newcommand{\Val}{\mathsf{val}}
\newcommand{\Next}{\mathsf{next}}
\newcommand{\Lson}{\mathsf{lchild}}
\newcommand{\Rson}{\mathsf{rchild}}

\newcommand{\Time}[1]{#1_{\mathrm{time}}}

\algdef{SE}[SUBALG]{Indent}{EndIndent}{}{\algorithmicend\ }%
\algtext*{Indent}
\algtext*{EndIndent}

\sloppy

\begin{document}

\maketitle

%TODO mandatory: add short abstract of the document
\begin{abstract}
% State the problem
% Say why it's an interesting problem
% Say what your solution achieves
% Say what follows from your solution
%
Understanding and predicting the worst-case resource usage is crucial for software quality; however, existing methods either over-approximate with potentially loose bounds or under-approximate without asymptotic guarantees.
%
This paper presents a program logic to under-approximate worst-case resource usage, adapting incorrectness logic (IL) to reason quantitatively about resource consumption.
%
We propose \underline{q}uantitative \underline{f}orward and \underline{b}ackward \underline{u}nder-\underline{a}pproximate (QFUA and QBUA) triples, which generalize IL to identify execution paths leading to high resource usage.
%
We also introduce a variant of QBUA that supports reasoning about high-water marks.
%
Our logic is proven sound and complete with respect to a simple IMP-like language, and we demonstrate its utility through case studies involving arrays, pointers, and procedure calls.
%
%This work offers a formal, compositional framework for deriving lower bounds on resource usage, allowing for the identification of performance bottlenecks and security vulnerabilities in programs.
\end{abstract}

\input{intro}
\input{overview}
\input{technical}
\input{case-study}
\input{related}
\input{conclusion}

\bibliography{db}

\appendix
\newpage

%\section{Formalization}
%
%\begin{align*}
%  C\Coloneqq&\Skip\mid\Assign{x}{e}\mid\Tick{e}\mid\Seq{C}{C}\mid\Ite{B}{C}{C}\mid\While{B}{C}\mid\Local{x}{C}
%\end{align*}
%
%% $\Judge{P}{C}{Q}$ holds iff for all $\tau$ such that $\Time{\tau}\le Q(\tau)$, there exists a $\sigma$ such that $\Time{\sigma}\le P(\sigma)$ and $(\sigma,\tau)\in\llbracket C\rrbracket$. If $\Judge{P}{C}{Q}$ holds, then the worst-case running time of $C$ is at least $\sup_{\tau}\{Q(\tau)\}-\sup_{\sigma}\{P(\sigma)\}$.
%
%\begin{mathpar}
%  P\curlywedge Q=\lambda\sigma.\min\{P(\sigma),Q(\sigma)\}
%  \hva\and
%  P\curlyvee Q=\lambda\sigma.\max\{P(\sigma),Q(\sigma)\}
%  \hva\and
%  \Sup x.P=\lambda\sigma.\sup_v\{P(\sigma[x\mapsto v])\}
%  \hva\and
%  \Inf x.P=\lambda\sigma.\inf_v\{P(\sigma[x\mapsto v])\}
%  \hva\and
%  [B]=\lambda\sigma.\begin{cases}+\infty&\text{if }B(\sigma)\text{ is true}\\-\infty&\text{otherwise}\end{cases}
%  \hva\and
%  P\preceq Q\quad\text{iff}\quad\forall\sigma\in\Sigma.P(\sigma)\leq Q(\sigma)
%\end{mathpar}

%\section{QFUA Logic}



%\section{QBUA Logic}



%\section{\QBUAd Triple}



\section{Proofs}

\begin{table}[t!]
\centering
\caption{Correspondence between Boolean and Quantitative Operators}
\label{fig:correspondence}
\begin{tabular}{lccc}
\toprule
&Boolean&QFUA&QBUA\\
\midrule
Conjunction&$P\land Q$&$P\curlyvee Q$&$P\curlywedge Q$\\
Disjunction&$P\lor Q$&$P\curlywedge Q$&$P\curlyvee Q$\\
Existential&$\exists x.P$&$\Inf x.P$&$\Sup x.P$\\
Implication&$P\Rightarrow Q$&$P\preceq Q$&$Q\preceq P$\\
Boolean Predicate&$B$&$[\neg B]$&$[B]$\\
\bottomrule
\end{tabular}
\end{table}

\begin{figure}
\begin{mathpar}
  \inferrule[(BS:Skip)]{}{\bigstep{\Skip}{\sigma}{p}{p}{\sigma}{p}}
  \hva\and
  \inferrule[(BS:Assign)]{}{\bigstep{\Assign{x}{e}}{\sigma}{p}{p}{\sigma[x\mapsto\eval{e}{\sigma}]}{p}}
  \hva\and
  \inferrule[(BS:Assume)]{\eval{B}{\sigma}=\true}{\bigstep{\Assume{B}}{\sigma}{p}{p}{\sigma}{p}}
  \hva\and
  \inferrule[(BS:Tick)]{}{\bigstep{\Tick{e}}{\sigma}{p}{\min\{p,p-\eval{e}{\sigma}\}}{\sigma}{p-\eval{e}{\sigma}}}
  \hva\and
  \inferrule[(BS:Seq)]{\bigstep{C_1}{\sigma}{p}{l_1}{\rho}{r} \\ \bigstep{C_2}{\rho}{r}{l_2}{\tau}{q}}{\bigstep{\Seq{C_1}{C_2}}{\sigma}{p}{\min\{l_1,l_2\}}{\tau}{q}}
  \hva\and
  \inferrule[(BS:ChoiceL)]{\bigstep{C_1}{\sigma}{p}{l}{\tau}{q}}{\bigstep{\Choice{C_1}{C_2}}{\sigma}{p}{l}{\tau}{q}}
  \hva\and
  \inferrule[(BS:ChoiceR)]{\bigstep{C_2}{\sigma}{p}{l}{\tau}{q}}{\bigstep{\Choice{C_1}{C_2}}{\sigma}{p}{l}{\tau}{q}}
  \hva\and
%  \inferrule[(BS:Loop)]{\bigstep{C^n}{\sigma}{p}{l}{\tau}{q}}{\bigstep{\Loop{C}}{\sigma}{p}{l}{\tau}{q}}
%  \hva\and
  \inferrule[(BS:LoopZero)]{}{\bigstep{\Loop{C}}{\sigma}{p}{p}{\sigma}{p}}
  \hva\and
  \inferrule[(BS:Loop)]{\bigstep{\Seq{C}{\Loop{C}}}{\sigma}{p}{l}{\tau}{q}}{\bigstep{\Loop{C}}{\sigma}{p}{l}{\tau}{q}}
  \hva\and
  \inferrule[(BS:Local)]{\bigstep{C}{\sigma}{p}{l}{\tau}{q}}{\bigstep{\Local{x}{C}}{\sigma[x\mapsto v]}{p}{l}{\tau[x\mapsto v]}{q}}
\end{mathpar}
\caption{Rules for the Big-step Semantics}
\label{fig:fullsemantics}
\end{figure}

\cref{fig:fullsemantics} shows the complete rules for the big-step semantics.
%
We also write $\bigstepp{C}{\sigma}{p}{\tau}{q}$ to denote $\exists l.\bigstep{C}{\sigma}{p}{l}{\tau}{q}$, and $\bigstepl{C}{\sigma}{p}{\tau}{q}$ to denote $\exists l\le 0.\bigstep{C}{\sigma}{p}{l}{\tau}{q}$.

\begin{lemma}\label{lem:relax}
  For all $C,\sigma,p,\tau,q,l,f$, if $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$, then $\bigstep{C}{\sigma}{p+f}{l+f}{\tau}{q+f}$.
\end{lemma}

\begin{proof}
  By induction on the derivation.
  \begin{itemize}
    \item \textbf{Case} \textsc{(BS:Skip)}, \textsc{(BS:Assign)}, \textsc{(BS:Assume)}:\\
      Immediate by the corresponding rule.
    \item \textbf{Case} \textsc{(BS:Tick)}:\\
      By (BS:Tick), we have $\bigstep{\Tick{e}}{\sigma}{p+f}{\min\{p+f,p-\eval{e}{\sigma}+f\}}{\sigma}{p-\eval{e}{\sigma}+f}$. Since $\min\{p+f,p-\eval{e}{\sigma}+f\}=\min\{p,p-\eval{e}{\sigma}\}+f$, the conclusion holds.
    \item \textbf{Case} \textsc{(BS:Seq)}:\\
      By the induction hypothesis, we have $\bigstep{C_1}{\sigma}{p+f}{l_1+f}{\rho}{r+f}$ and $\bigstep{C_2}{\rho}{r+f}{l_2+f}{\tau}{q+f}$. Then by (BS:Seq), we have $\bigstep{\Seq{C_1}{C_2}}{\sigma}{p+f}{\min\{l_1+f,l_2+f\}}{\tau}{q+f}$. Since $\min\{l_1+f,l_2+f\}=\min\{l_1,l_2\}+f$, the conclusion holds.
    \item \textbf{Case} \textsc{(BS:ChoiceL)}:\\
      By the induction hypothesis, we have $\bigstep{C_1}{\sigma}{p+f}{l+f}{\tau}{q+f}$. Then by (BS:ChoiceL), we have $\bigstep{\Choice{C_1}{C_2}}{\sigma}{p+f}{l+f}{\tau}{q+f}$.
    \item \textbf{Case} \textsc{(BS:ChoiceR)}:\\
      This case is similar to the previous case.
    \item \textbf{Case} \textsc{(BS:LoopZero)}:\\
      Immediate by the rule (BS:LoopZero).
    \item \textbf{Case} \textsc{(BS:Loop)}:\\
      By the induction hypothesis, we have $\bigstep{\Seq{C}{\Loop{C}}}{\sigma}{p+f}{l+f}{\tau}{q+f}$. Then by (BS:Loop), we have $\bigstep{\Loop{C}}{\sigma}{p+f}{l+f}{\tau}{q+f}$.
    \item \textbf{Case} \textsc{(BS:Local)}:\\
      By the induction hypothesis, we have $\bigstep{C}{\sigma}{p+f}{l+f}{\tau}{q+f}$. Then by (BS:Local), we have $\bigstep{\Local{x}{C}}{\sigma[x\mapsto v]}{p+f}{l+f}{\tau[x\mapsto v]}{q+f}$.
  \end{itemize}
\end{proof}

\begin{definition}[Semantics]
  The semantics of QFUA triple, QBUA triple, and \QBUAd triple are defined as follows:
  \begin{itemize}
    \item $\fJudge{P}{C}{Q}$ holds iff for all $\tau$ and $q$ such that $q\ge Q(\tau)$, there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and $\bigstepp{C}{\sigma}{p}{\tau}{q}$.
    \item $\bJudge{P}{C}{Q}$ holds iff for all $\sigma$ and $p$ such that $p\le P(\sigma)$, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstepp{C}{\sigma}{p}{\tau}{q}$.
    \item $\dJudge{P}{C}{Q}$ holds iff for all $\sigma$ and $p$ such that $p\le P(\sigma)$, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstepl{C}{\sigma}{p}{\tau}{q}$.
  \end{itemize}
\end{definition}

\begin{definition}[Predicate Transformer] The $\mathrm{pre}$ and $\mathrm{post}$ transformers are defined as follows:
  \begin{itemize}
    \item $\pre{C}{Q}\coloneqq\lambda\sigma.\sup\{p:\exists\tau,q.q\le Q(\tau)\land\bigstepp{C}{\sigma}{p}{\tau}{q}\}$.
    \item $\prel{C}{Q}\coloneqq\lambda\sigma.\sup\{p:\exists\tau,q.q\le Q(\tau)\land\bigstepl{C}{\sigma}{p}{\tau}{q}\}$.
    \item $\post{C}{P}\coloneqq\lambda\tau.\inf\{q:\exists\sigma,p.p\ge P(\sigma)\land\bigstepp{C}{\sigma}{p}{\tau}{q}\}$.
  \end{itemize}
\end{definition}

\begin{proposition}\label{prop:const}
  For all $P,C$ such that $\Fv(P)\cap\Mod(C)=\emptyset$, for all $\sigma,p,\tau,q,l$, if $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$, then $P(\sigma)=P(\tau)$.
\end{proposition}

%\begin{proposition}\label{prop:porg-const}
%  For all $C,\sigma,p,\tau,q,l$ such that $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$, for all $x\notin\Fv(C)$ and $v$, $\bigstep{C}{\sigma[x\mapsto v]}{p}{l}{\tau[x\mapsto v]}{q}$.
%\end{proposition}
%
%\begin{proposition}\label{prop:pred-const}
%  For all $P,\sigma$, for all $x\notin\Fv(P)$ and $v$, $P(\sigma)=P(\sigma[x\mapsto v])$.
%\end{proposition}

\begin{proposition}\label{prop:subst}
  For all $C,\sigma,p,\tau,q,l$ such that $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$, for all $x,y,v$, if $y\notin\Fv(C)$, then $\bigstep{C[y/x]}{\sigma[x\mapsto v][y\mapsto\eval{x}{\sigma}]}{p}{l}{\tau[x\mapsto v][y\mapsto\eval{x}{\tau}]}{q}$.
\end{proposition}

\begin{figure}
\begin{mathpar}
  \inferrule[(F:Skip)]{}{\fjudge{P}{\Skip}{P}}
  \hva\and
  \inferrule[(F:Assign)]{}{\fjudge{P}{\Assign{x}{e}}{\Inf x'.P[x'/x]\curlyvee[x\ne e[x'/x]]}}
  \hva\and
  \inferrule[(F:Assume)]{}{\fjudge{P\curlyvee[\neg B]}{\Assume{B}}{P\curlyvee[\neg B]}}
  \hva\and
  \inferrule[(F:Tick)]{}{\fjudge{P}{\Tick{e}}{P-e}}
  \hva\and
  \inferrule[(F:Seq)]{\fjudge{P}{C_1}{R} \\ \fjudge{R}{C_2}{Q}}{\fjudge{P}{\Seq{C_1}{C_2}}{Q}}
  \hva\and
  \inferrule[(F:ChoiceL)]{\fjudge{P}{C_1}{Q}}{\fjudge{P}{\Choice{C_1}{C_2}}{Q}}
  \hva\and
  \inferrule[(F:ChoiceR)]{\fjudge{P}{C_2}{Q}}{\fjudge{P}{\Choice{C_1}{C_2}}{Q}}
  \hva\and
  \inferrule[(F:Loop)]{\forall n<k.\fjudge{P(n)}{C}{P(n+1)}}{\fjudge{P(0)}{\Loop{C}}{P(k)}}
  \hva\and
  \inferrule[(F:Local)]{\fjudge{P}{C}{Q}}{\fjudge{\Inf x.P}{\Local{x}{C}}{\Inf x.Q}}
  \hva\and
  \inferrule[(F:Disj)]{\forall i\in I.\fjudge{P_i}{C}{Q_i}}{\fjudge{\bigcurlywedge_{i\in I}P_i}{C}{\bigcurlywedge_{i\in I}Q_i}}
  \hva\and
  \inferrule[(F:Constancy)]{\fjudge{P}{C}{Q}\\\Fv(B)\cap\Mod(C)=\emptyset}{\fjudge{P\curlyvee[B]}{C}{Q\curlyvee[B]}}
  \hva\and
  \inferrule[(F:Relax)]{\fjudge{P}{C}{Q}\\\Fv(F)\cap\Mod(C)=\emptyset}{\fjudge{P+F}{C}{Q+F}}
  \hva\and
  \inferrule[(F:Cons)]{P\preceq P'\\\fjudge{P'}{C}{Q'}\\Q'\preceq Q}{\fjudge{P}{C}{Q}}
  \hva\and
  \inferrule[(F:Subst)]{\fjudge{P}{C}{Q}\\y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)}{\fjudge{P[y/x]}{C[y/x]}{Q[y/x]}}
\end{mathpar}
\caption{Proof Rules for QFUA Triples}
\label{fig:fullqfua}
\end{figure}

\cref{fig:fullqfua} shows the complete proof rules for QFUA triples.

\begin{theorem}[QFUA Soundness]\label{thm:qfua-sound}
  For all $P$, $C$, $Q$, if $\fjudge{P}{C}{Q}$ is derivable, then $\fJudge{P}{C}{Q}$ holds.
\end{theorem}

\begin{proof}
  By induction on the derivation.
  \begin{itemize}
    \item \textbf{Case} \textsc{(F:Skip)}:\\
      Let $P$ be arbitrary such that $\fjudge{P}{\Skip}{P}$. For any $\tau$ and $q$ satisfying $q\ge P(\tau)$, take $\sigma=\tau$ and $p=q$. Then we have $p\ge P(\sigma)$ and $\bigstep{\Skip}{\sigma}{p}{q}{\tau}{q}$ by \textsc{(BS:Skip)}.
    \item \textbf{Case} \textsc{(F:Assign)}:\\
      Let $P$ be arbitrary such that $\fjudge{P}{\Assign{x}{e}}{Q}$, where $Q=\Inf x'.P[x'/x]\curlyvee[x\ne e[x'/x]]$. For any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, notice that
      \begin{align*}
        Q(\tau)
        &=\inf_v\left\{(P[x'/x]\curlyvee[x\ne e[x'/x]])(\tau[x'\mapsto v])\right\}\\
        &=\inf_v\{\max\{P[x'/x](\tau[x'\mapsto v]),[x\ne e[x'/x]](\tau[x'\mapsto v])\}\}\\
        &=\inf_v\{\max\{P(\tau[x\mapsto v]),[\eval{x}{\tau}\ne\eval{e}{\tau[x\mapsto v]}]\}\}.
      \end{align*}
      Thus, there exists a $v$ such that $q\ge P(\tau[x\mapsto v])$ and $\eval{x}{\tau}=\eval{e}{\tau[x\mapsto v]}$. Take $\sigma=\tau[x\mapsto v]$ and $p=q$, then we have $p\ge P(\sigma)$ and $\tau=\sigma[x\mapsto\eval{e}{\sigma}]$. Therefore, $\bigstep{\Assign{x}{e}}{\sigma}{p}{q}{\sigma}{q}$ holds by \textsc{(BS:Assign)}.
    \item \textbf{Case} \textsc{(F:Assume)}:\\
      Let $P$ be arbitrary such that $\fjudge{P\curlyvee[\neg B]}{\Assume{B}}{P\curlyvee[\neg B]}$. For any $\tau$ and $q$ satisfying $q\ge(P\curlyvee[\neg B])(\tau)$, we have $q\ge P(\tau)$ and $\eval{B}{\tau}=\true$. Take $\sigma=\tau$ and $p=q$. Then we have $p\ge(P\curlyvee[\neg B])(\sigma)$ and $\bigstep{\Assume{B}}{\sigma}{p}{q}{\sigma}{q}$ by \textsc{(BS:Assume)}.
    \item \textbf{Case} \textsc{(F:Tick)}:\\
      Let $P$ be arbitrary such that $\fjudge{P}{\Tick{e}}{P-e}$. For any $\tau$ and $q$ satisfying $q\ge (P-e)(\tau)=P(\tau)-\eval{e}{\tau}$, take $\sigma=\tau$ and $p=q+\eval{e}{\tau}$. Then we have $p\ge P(\sigma)$ and $\bigstep{\Tick{e}}{\sigma}{p}{\min\{p,p-\eval{e}{\sigma}\}}{\tau}{q}$ by \textsc{(BS:Tick)}.
    \item \textbf{Case} \textsc{(F:Seq)}:\\
      Let $P,Q,R,C_1,C_2$ be arbitrary such that $\fjudge{P}{C_1}{R}$ and $\fjudge{R}{C_2}{Q}$. By induction hypothesis, we have $\fJudge{P}{C_1}{R}$ and $\fJudge{R}{C_2}{Q}$. For any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, there exists a $\rho$ and an $r$ such that $r\ge R(\rho)$ and $\bigstep{C_2}{\rho}{r}{l_2}{\tau}{q}$ for some $l_2$. Then, there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and $\bigstep{C_1}{\sigma}{p}{l_1}{\rho}{r}$ for some $l_1$. Hence, $\bigstep{\Seq{C_1}{C_2}}{\sigma}{p}{\min\{l_1,l_2\}}{\tau}{q}$ holds by \textsc{(BS:Seq)}.
    \item \textbf{Case} \textsc{(F:ChoiceL)}:\\
      Let $P,Q,C_1,C_2$ be arbitrary such that $\fjudge{P}{C_1}{Q}$. By induction hypothesis, we have $\fJudge{P}{C_1}{Q}$. For any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and $\bigstep{C_1}{\sigma}{p}{l}{\tau}{q}$ for some $l$. Hence, $\bigstep{\Choice{C_1}{C_2}}{\sigma}{p}{l}{\tau}{q}$ holds by \textsc{(BS:ChoiceL)}.
    \item \textbf{Case} \textsc{(F:ChoiceR)}:\\
      This case is similar to the previous one.
    \item \textbf{Case} \textsc{(F:Loop)}:\\
      Let $P,C$ be arbitrary such that $\forall n<k.\fjudge{P(n)}{C}{P(n+1)}$. By induction hypothesis, we have $\forall n<k.\fJudge{P(n)}{C}{P(n+1)}$. We will inductively prove that for all $0\le i\le k$, $\fJudge{P(k-i)}{\Loop{C}}{P(k)}$ holds:
      \begin{itemize}
        \item \textbf{Base case} $i=0$:\\
          Let $\tau$ and $q$ be arbitrary such that $q\ge P(k)(\tau)$. Take $\sigma=\tau$ and $p=q$. Then we have $p\ge P(k)(\sigma)$ and $\bigstep{\Loop{C}}{\sigma}{p}{p}{\sigma}{p}$ by \textsc{(BS:LoopZero)}. It follows that $\fJudge{P(k)}{\Loop{C}}{P(k)}$.
        \item \textbf{Inductive step} $i\to i+1$:\\
          Assume that $\fJudge{P(k-i)}{\Loop{C}}{P(k)}$ holds. Let $\tau$ and $q$ be arbitrary such that $q\ge P(k)(\tau)$. By the assumption, there exists a $\rho$ and an $r$ such that $r\ge P(k-i)(\rho)$ and $\bigstep{\Loop{C}}{\rho}{r}{l_1}{\tau}{q}$ for some $l_1$. Besides, $\fJudge{P(k-(i+1))}{C}{P(k-i)}$ implies that there exists a $\sigma$ and a $p$ such that $p\ge P(k-(i+1))(\sigma)$ and $\bigstep{C}{\sigma}{p}{l_2}{\rho}{r}$ for some $l_2$. Thus, $\bigstep{\Seq{C}{\Loop{C}}}{\sigma}{p}{l}{\tau}{q}$ holds by \textsc{(BS:Seq)} for $l=\min\{l_1,l_2\}$, and then $\bigstep{\Loop{C}}{\sigma}{p}{l}{\tau}{q}$ holds by \textsc{(BS:Loop)}. It follows that $\fJudge{P(k-(i+1))}{\Loop{C}}{P(k)}$.
      \end{itemize}
      Taking $i=k$, we have $\fJudge{P(0)}{\Loop{C}}{P(k)}$.
    \item \textbf{Case} \textsc{(F:Local)}:\\
      Let $P,Q,C$ be arbitrary such that $\fjudge{P}{C}{Q}$. By induction hypothesis, we have $\fJudge{P}{C}{Q}$. For any $\tau$ and $q$ satisfying $q\ge (\Inf x.Q)(\tau)=\inf_v\{Q(\tau[x\mapsto v])\}$, there exists a $v$ such that $q\ge Q(\tau[x\mapsto v])$. Since $\fJudge{P}{C}{Q}$, there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and $\bigstep{C}{\sigma}{p}{l}{\tau[x\mapsto v]}{q}$ for some $l$. This implies that $p\ge (\Inf x.P)(\sigma[x\mapsto\eval{x}{\tau}])$ and $\bigstep{\Local{x}{C}}{\sigma[x\mapsto\eval{x}{\tau}]}{p}{l}{\tau}{q}$ by \textsc{(BS:Local)}. It follows that $\fJudge{\Inf x.P}{\Local{x}{C}}{\Inf x.Q}$.
    \item \textbf{Case} \textsc{(F:Disj)}:\\
      Let $C$ be arbitrary. And for $i\in I$, let $P_i$ and $Q_i$ be arbitrary such that $\fjudge{P_i}{C}{Q_i}$. By induction hypothesis, we have $\fJudge{P_i}{C}{Q_i}$. For any $\tau$ and $q$ satisfying $q\ge\left(\bigcurlywedge_{i\in I}Q_i\right)(\tau)$, there exists an $i\in I$ such that $q\ge Q_i(\tau)$. Since $\fJudge{P_i}{C}{Q_i}$, there exists a $\sigma$ and a $p$ such that $p\ge P_i(\sigma)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$ for some $l$. Therefore, we have $p\ge\left(\bigcurlywedge_{i\in I}P_i\right)(\sigma)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$.
    \item \textbf{Case} \textsc{(F:Constancy)}:\\
      Let $P,Q,B,C$ be arbitrary such that $\fjudge{P}{C}{Q}$ and $\Fv(B)\cap\Mod(C)=\emptyset$. By induction hypothesis, we have $\fJudge{P}{C}{Q}$. For any $\tau$ and $q$ satisfying $q\ge (Q\curlyvee[B])(\tau)$, we have $q\ge Q(\tau)$ and $\eval{\neg B}{\tau}=\true$. Then there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$ for some $l$. By proposition \ref{prop:const}, we have $\eval{\neg B}{\sigma}=\true$, and then $p\ge (P\curlyvee[B])(\sigma)$. It follows that $\fJudge{P\curlyvee[B]}{C}{Q\curlyvee[B]}$.
    \item \textbf{Case} \textsc{(F:Relax)}:\\
      Let $P,Q,F,C$ be arbitrary such that $\fjudge{P}{C}{Q}$ and $\Fv(F)\cap\Mod(C)=\emptyset$. By induction hypothesis, we have $\fJudge{P}{C}{Q}$. For any $\tau$ and $q$ satisfying $q\ge (Q+F)(\tau)=Q(\tau)+F(\tau)$, we have $q-F(\tau)\ge Q(\tau)$. Then there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q-F(\tau)}$ for some $l$. By lemma \ref{lem:relax} and proposition \ref{prop:const}, we have $\bigstep{C}{\sigma}{p+F(\sigma)}{l+F(\sigma)}{\tau}{q}$. Since $p+F(\sigma)\ge P(\sigma)+F(\sigma)=(P+F)(\sigma)$, we have $\fJudge{P+F}{C}{Q+F}$.
    \item \textbf{Case} \textsc{(F:Cons)}:\\
      Let $P,P',Q,Q',C$ be arbitrary such that $P\preceq P'$, $Q'\preceq Q$ and $\fjudge{P'}{C}{Q'}$. By induction hypothesis, we have $\fJudge{P'}{C}{Q'}$. For any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, we have $q\ge Q'(\tau)$. Then there exists a $\sigma$ and a $p$ such that $p\ge P'(\sigma)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$ for some $l$. Since $P(\sigma)\le P'(\sigma)$, we have $p\ge P(\sigma)$. It follows that $\fJudge{P}{C}{Q}$.
    \item \textbf{Case} \textsc{(F:Subst)}:\\
      Let $P,Q,C$ be arbitrary such that $\fjudge{P}{C}{Q}$, and let $x,y$ by arbitrary such that $y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)$. By induction hypothesis, we have $\fJudge{P}{C}{Q}$. For any $\tau$ and $q$ satisfying $q\ge Q[y/x](\tau)=Q(\tau[x\mapsto\eval{y}{\tau}])$, we have $q\ge Q(\tau')$ since $y\notin\Fv(Q)$, where $\tau'=\tau[x\mapsto\eval{y}{\tau}][y\mapsto\eval{x}{\tau}]$. Then there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and $\bigstep{C}{\sigma}{p}{l}{\tau'}{q}$ for some $l$. By proposition \ref{prop:subst}, we have $\bigstep{C[y/x]}{\sigma'}{p}{l}{\tau}{q}$, where $\sigma'=\sigma[x\mapsto\eval{x}{\tau}][y\mapsto\eval{x}{\sigma}]$. Since $y\notin\Fv(P)$, weh have $p\ge P(\sigma)=P[y/x](\sigma')$. It follows that $\fJudge{P[y/x]}{C[y/x]}{Q[y/x]}$.
  \end{itemize}
\end{proof}

\begin{figure}
\begin{mathpar}
  \inferrule[(B:Skip)]{}{\bjudge{P}{\Skip}{P}}
  \hva\and
  \inferrule[(B:Assign)]{}{\bjudge{P}{\Assign{x}{e}}{\Sup x'.P[x'/x]\curlywedge[x=e[x'/x]]}}
  \hva\and
  \inferrule[(B:Assume)]{}{\bjudge{P\curlywedge[B]}{\Assume{B}}{P\curlywedge[B]}}
  \hva\and
  \inferrule[(B:Tick)]{}{\bjudge{P}{\Tick{e}}{P-e}}
  \hva\and
  \inferrule[(B:Seq)]{\bjudge{P}{C_1}{R} \\ \bjudge{R}{C_2}{Q}}{\bjudge{P}{\Seq{C_1}{C_2}}{Q}}
  \hva\and
  \inferrule[(B:ChoiceL)]{\bjudge{P}{C_1}{Q}}{\bjudge{P}{C_1+C_2}{Q}}
  \hva\and
  \inferrule[(B:ChoiceR)]{\bjudge{P}{C_2}{Q}}{\bjudge{P}{C_1+C_2}{Q}}
  \hva\and
%  \inferrule[(Loop0)]{}{\bjudge{P}{C^\star}{P}}
%  \hva\and
%  \inferrule[(Loop)]{\bjudge{P}{\Seq{C^\star}{C}}{Q}}{\bjudge{P}{C^\star}{Q}}
%  \hva\and
  \inferrule[(B:Loop)]{\forall n<k.\bjudge{P(n)}{C}{P(n+1)}}{\bjudge{P(0)}{C^\star}{P(k)}}
  \hva\and
  \inferrule[(B:Local)]{\bjudge{P}{C}{Q}}{\bjudge{\Sup x.P}{\Local{x}{C}}{\Sup x.Q}}
  \hva\and
  \inferrule[(B:Disj)]{\forall i\in I.\bjudge{P_i}{C}{Q_i}}{\bjudge{\bigcurlyvee_{i\in I}P_i}{C}{\bigcurlyvee_{i\in I}Q_i}}
  \hva\and
  \inferrule[(B:Constancy)]{\bjudge{P}{C}{Q}\\\Fv(B)\cap\Mod(C)=\emptyset}{\bjudge{P\curlywedge[B]}{C}{Q\curlywedge[B]}}
  \hva\and
  \inferrule[(B:Relax)]{\bjudge{P}{C}{Q}\\\Fv(F)\cap\Mod(C)=\emptyset}{\bjudge{P+F}{C}{Q+F}}
  \hva\and
  \inferrule[(B:Cons)]{P\preceq P' \\ \judge{P'}{C}{Q'} \\ Q'\preceq Q}{\judge{P}{C}{Q}}
  \hva\and
  \inferrule[(B:Subst)]{\bjudge{P}{C}{Q}\\y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)}{\bjudge{P[y/x]}{C[y/x]}{Q[y/x]}}
\end{mathpar}
\caption{Proof Rules for QBUA Triples}
\label{fig:fullqbua}
\end{figure}

\cref{fig:fullqbua} shows the complete proof rules for QBUA triples.

\begin{theorem}[QBUA Soundness]\label{thm:qbua-sound}
  For all $P$, $C$, $Q$, if $\bjudge{P}{C}{Q}$ is derivable, then $\bJudge{P}{C}{Q}$ holds.
\end{theorem}

\begin{proof}
  By induction on the derivation.
  \begin{itemize}
    \item \textbf{Case} \textsc{(B:Skip)}:\\
      Let $P$ be arbitrary such that $\bjudge{P}{\Skip}{P}$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, take $\tau=\sigma$ and $q=p$. Then we have $q\le P(\tau)$ and $\bigstep{\Skip}{\sigma}{p}{p}{\tau}{q}$ by \textsc{(BS:Skip)}.
    \item \textbf{Case} \textsc{(B:Assign)}:\\
      Let $P$ be arbitrary such that $\bjudge{P}{\Assign{x}{e}}{Q}$, where $Q=\Sup x'.P[x'/x]\curlywedge[x=e[x'/x]]$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, take $\tau=\sigma[x\mapsto\eval{e}{\sigma}]$ and $q=p$. Notice that
      \begin{align*}
        Q(\tau)
        &=\sup_v\{(P[x'/x]\curlywedge[x=e[x'/x]])(\tau[x\mapsto v])\}\\
        &=\sup_v\{\min\{(P[x'/x])(\tau[x\mapsto v]),[x=e[x'/x]](\tau[x\mapsto v])\}\}\\
        &=\sup_v\{\min\{P(\tau[x\mapsto v]),[\eval{x}{\tau}=\eval{e}{\tau[x\mapsto v]}]\}\}\\
        &\ge\min\{P(\tau[x\mapsto\eval{x}\sigma]),[\eval{x}{\tau}=\eval{e}{\tau[x\mapsto\eval{\sigma}{x}]}]\}\\
        &=P(\sigma).
    \end{align*}
    Combining with $\bigstep{\Assign{x}{e}}{\sigma}{p}{p}{\tau}{q}$ by \textsc{(BS:Assign)}, we have $\bJudge{P}{\Assign{x}{e}}{Q}$.
    \item \textbf{Case} \textsc{(B:Assume)}:\\
      Let $P$ be arbitrary such that $\bjudge{P\curlywedge[B]}{\Assume{B}}{P\curlywedge[B]}$. For any $\sigma$ and $p$ satisfying $p\le (P\curlywedge[B])(\sigma)$, we have $p\le P(\sigma)$ and $\eval{B}{\sigma}=\true$. Take $\tau=\sigma$ and $q=p$. Then we have $q\le (P\curlywedge[B])(\tau)$ and $\bigstep{\Assume{B}}{\sigma}{p}{p}{\tau}{q}$ by \textsc{(BS:Assume)}.
    \item \textbf{Case} \textsc{(B:Tick)}:\\
      Let $P$ be arbitrary such that $\bjudge{P}{\Tick{e}}{P-e}$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, take $\tau=\sigma$ and $q=p-\eval{e}{\sigma}$. Then we have $q\le (P-e)(\tau)$ and $\bigstep{\Tick{e}}{\sigma}{p}{\min\{p,p-\eval{e}{\sigma}\}}{\tau}{q}$ by \textsc{(BS:Tick)}.
    \item \textbf{Case} \textsc{(B:Seq)}:\\
      Let $P,Q,R,C_1,C_2$ be arbitrary such that $\bjudge{P}{C_1}{R}$ and $\bjudge{R}{C_2}{Q}$. By induction hypothesis, we have $\bJudge{P}{C_1}{R}$ and $\bJudge{R}{C_2}{Q}$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists a $\rho$ and an $r$ such that $r\le R(\rho)$ and $\bigstep{C_1}{\sigma}{p}{l_1}{\rho}{r}$ for some $l_1$. Then, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C_2}{\rho}{r}{l_2}{\tau}{q}$ for some $l_2$. Hince, $\bigstep{\Seq{C_1}{C_2}}{\sigma}{p}{\min\{l_1,l_2\}}{\tau}{q}$ holds by \textsc{(BS:Seq)}.
    \item \textbf{Case} \textsc{(B:ChoiceL)}:\\
      Let $P,Q,C_1,C_2$ be arbitrary such that $\bjudge{P}{C_1}{Q}$. By induction hypothesis, we have $\bJudge{P}{C_1}{Q}$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C_1}{\sigma}{p}{l}{\tau}{q}$ for some $l$. Hence, $\bigstep{\Choice{C_1}{C_2}}{\sigma}{p}{l}{\tau}{q}$ holds by \textsc{(BS:ChoiceL)}.
    \item \textbf{Case} \textsc{(B:ChoiceR)}:\\
      This case is similar to the previous one.
    \item \textbf{Case} \textsc{(B:Loop)}:\\
      Let $P,C$ be arbitrary such that $\forall n<k.\bjudge{P(n)}{C}{P(n+1)}$. By induction hypothesis, we have $\forall n<k.\bJudge{P(n)}{C}{P(n+1)}$. We will inductively prove that for all $0\le i\le k$, $\bJudge{P(k-i)}{\Loop{C}}{P(k)}$ holds:
      \begin{itemize}
        \item \textbf{Base case} $i=0$:\\
          Let $\sigma$ and $p$ be arbitrary such that $p\le P(k)(\sigma)$. Take $\tau=\sigma$ and $q=p$. Then we have $q\le P(k)(\tau)$ and $\bigstep{\Loop{C}}{\sigma}{p}{p}{\tau}{q}$ by \textsc{(BS:LoopZero)}. It follows that $\bJudge{P(k)}{\Loop{C}}{P(k)}$.
        \item \textbf{Inductive step} $i\to i+1$:\\
          Assume that $\bJudge{P(k-i)}{\Loop{C}}{P(k)}$ holds. Let $\sigma$ and $p$ be arbitrary such that $p\le P(k-(i+1))(\sigma)$. By $\bJudge{P(k-(i+1))}{C}{P(k-i)}$, there exists a $\rho$ and an $r$ such that $r\le P(k-i)(\rho)$ and $\bigstep{C}{\sigma}{p}{l_1}{\rho}{r}$ for some $l_1$. Besides, $\bJudge{P(k-i)}{\Loop{C}}{P(k)}$ implies that there exists a $\tau$ and a $q$ such that $q\le P(k)(\tau)$ and $\bigstep{\Loop{C}}{\rho}{r}{l_2}{\tau}{q}$ for some $l_2$. Thus, $\bigstep{\Seq{C}{\Loop{C}}}{\sigma}{p}{l}{\tau}{q}$ holds by \textsc{(BS:Seq)} for $l=\min\{l_1,l_2\}$, and then $\bigstep{\Loop{C}}{\sigma}{p}{l}{\tau}{q}$ holds by \textsc{(BS:Loop)}. It follows that $\bJudge{P(k-(i+1))}{\Loop{C}}{P(k)}$.
        \end{itemize}
        Taking $i=k$, we have $\bJudge{P(0)}{\Loop{C}}{P(k)}$.
    \item \textbf{Case} \textsc{(B:Local)}:\\
      Let $P,Q,C$ be arbitrary such that $\bjudge{P}{C}{Q}$. By induction hypothesis, we have $\bJudge{P}{C}{Q}$. For any $\sigma$ and $p$ satisfying $p\le (\Sup x.P)(\sigma)=\sup_v\{P(\sigma[x\mapsto v])\}$, there exists a $v$ such that $p\le P(\sigma[x\mapsto v])$. Since $\bJudge{P}{C}{Q}$, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C}{\sigma[x\mapsto v]}{p}{l}{\tau}{q}$ for some $l$. This implies that $q\le(\Sup x.Q)(\tau[x\mapsto\eval{x}{\sigma}])$ and $\bigstep{\Local{x}{C}}{\sigma}{p}{l}{\tau[x\mapsto\eval{x}{\sigma}]}{q}$ by \textsc{(BS:Local)}. It follows that $\bJudge{\Sup x.P}{\Local{x}{C}}{\Sup x.Q}$.
    \item \textbf{Case} \textsc{(B:Disj)}:\\
      Let $C$ be arbitrary. And for $i\in I$, let $P_i$ and $Q_i$ be arbitrary such that $\bjudge{P_i}{C}{Q_i}$. By induction hypothesis, we have $\bJudge{P_i}{C}{Q_i}$. For any $\sigma$ and $p$ satisfying $p\le\left(\bigcurlyvee_{i\in I}P_i\right)(\sigma)$, there exists an $i\in I$ such that $p\le P_i(\sigma)$. Since $\bJudge{P_i}{C}{Q_i}$, there exists a $\tau$ and a $q$ such that $q\le Q_i(\tau)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$ for some $l$. Therefore, we have $q\le\left(\bigcurlyvee_{i\in I}Q_i\right)(\tau)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$.
    \item \textbf{Case} \textsc{(B:Constancy)}:\\
      Let $P,Q,B,C$ be arbitrary such that $\bjudge{P}{C}{Q}$ and $\Fv(B)\cap\Mod(C)=\emptyset$. By induction hypothesis, we have $\bJudge{P}{C}{Q}$. For any $\sigma$ and $p$ satisfying $p\le (P\curlywedge[B])(\sigma)$, we have $p\le P(\sigma)$ and $\eval{B}{\sigma}=\true$. Then there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$ for some $l$. By proposition \ref{prop:const}, we have $\eval{B}{\tau}=\true$, and then $q\le (Q\curlywedge[B])(\tau)$. It follows that $\bJudge{P\curlywedge[B]}{C}{Q\curlywedge[B]}$.
    \item \textbf{Case} \textsc{(B:Relax)}:\\
      Let $P,Q,F,C$ be arbitrary such that $\bjudge{P}{C}{Q}$ and $\Fv(F)\cap\Mod(C)=\emptyset$. By induction hypothesis, we have $\bJudge{P}{C}{Q}$. For any $\sigma$ and $p$ satisfying $p\le (P+F)(\sigma)=P(\sigma)+F(\sigma)$, we have $p-F(\sigma)\le P(\sigma)$. Then there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C}{\sigma}{p-F(\sigma)}{l}{\tau}{q}$ for some $l$. By lemma \ref{lem:relax} and proposition \ref{prop:const}, we have $\bigstep{C}{\sigma}{p}{l+F(\tau)}{\tau}{q+F(\tau)}$. Since $q+F(\tau)\le Q(\tau)+F(\tau)=(Q+F)(\tau)$, we have $\bJudge{P+F}{C}{Q+F}$.
    \item \textbf{Case} \textsc{(B:Cons)}:\\
      Let $P,P',Q,Q',C$ be arbitrary such that $P\preceq P'$, $Q'\preceq Q$ and $\bjudge{P'}{C}{Q'}$. By induction hypothesis, we have $\bJudge{P'}{C}{Q'}$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, we have $p\le P'(\sigma)$. Then there exists a $\tau$ and a $q$ such that $q\le Q'(\tau)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$ for some $l$. Since $Q'(\tau)\le Q(\tau)$, we have $q\le Q(\tau)$. It follows that $\bJudge{P}{C}{Q}$.
    \item \textbf{Case} \textsc{(B:Subst)}:\\
      Let $P,Q,C$ be arbitrary such that $\bjudge{P}{C}{Q}$, and let $x,y$ be arbitrary such that $y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)$. By induction hypothesis, we have $\bJudge{P}{C}{Q}$. For any $\sigma$ and $p$ satisfying $p\le P[y/x](\sigma)=P(\sigma[x\mapsto\eval{y}{\sigma}])$, we have $p\le P(\sigma')$ since $y\notin\Fv(P)$, where $\sigma'=\sigma[x\mapsto\eval{y}{\sigma}][y\mapsto\eval{x}{\sigma}]$. Then there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C}{\sigma'}{p}{l}{\tau}{q}$ for some $l$. By proposition \ref{prop:subst}, we have $\bigstep{C[y/x]}{\sigma}{p}{l}{\tau'}{q}$, where $\tau'=\tau[x\mapsto\eval{x}{\sigma}][y\mapsto\eval{x}{\tau}]$. Since $y\notin\Fv(Q)$, we have $q\le Q(\tau)=Q[y/x](\tau')$. It follows that $\bJudge{P[y/x]}{C[y/x]}{Q[y/x]}$.
  \end{itemize}
\end{proof}

\begin{figure}
\begin{mathpar}
  \inferrule[(\Bd:Skip)]{P\preceq 0}{\djudge{P}{\Skip}{P}}
  \hva\and
  \inferrule[(\Bd:Assign)]{P\preceq 0}{\djudge{P}{\Assign{x}{e}}{\Sup x'.P[x'/x]\curlywedge[x=e[x'/x]]}}
  \hva\and
  \inferrule[(\Bd:Assume)]{P\preceq 0}{\djudge{P\curlywedge[B]}{\Assume{B}}{P\curlywedge[B]}}
  \hva\and
  \inferrule[(\Bd:Tick)]{P\curlywedge P-e\preceq 0}{\djudge{P}{\Tick{e}}{P-e}}
  \hva\and
  \inferrule[(\Bd:SeqL)]{\djudge{P}{C_1}{R} \\ \bjudge{R}{C_2}{Q}}{\djudge{P}{\Seq{C_1}{C_2}}{Q}}
  \hva\and
  \inferrule[(\Bd:SeqR)]{\bjudge{P}{C_1}{R} \\ \djudge{R}{C_2}{Q}}{\djudge{P}{\Seq{C_1}{C_2}}{Q}}
  \hva\and
  \inferrule[(\Bd:ChoiceL)]{\djudge{P}{C_1}{Q}}{\djudge{P}{C_1+C_2}{Q}}
  \hva\and
  \inferrule[(\Bd:ChoiceR)]{\djudge{P}{C_2}{Q}}{\djudge{P}{C_1+C_2}{Q}}
  \hva\and
%  \inferrule[(Loop0)]{P\preceq 0}{\djudge{P}{C^\star}{P}}
%  \hva\and
%  \inferrule[(Loop)]{\djudge{P}{\Seq{C^\star}{C}}{Q}}{\djudge{P}{C^\star}{Q}}
%  \hva\and
  \inferrule[(\Bd:LoopZero)]{P\preceq 0}{\djudge{P}{C^\star}{P}}
  \hva\and
  \inferrule[(\Bd:Loop)]{\forall n<k.\bjudge{P(n)}{C}{P(n+1)} \\ \exists m<k.\djudge{P(m)}{C}{P(m+1)}}{\djudge{P(0)}{C^\star}{P(k)}}
  \hva\and
  \inferrule[(\Bd:Local)]{\djudge{P}{C}{Q}}{\djudge{\Sup x.P}{\Local{x}{C}}{\Sup x.Q}}
  \hva\and
  \inferrule[(\Bd:Disj)]{\forall i\in I.\djudge{P_i}{C}{Q_i}}{\djudge{\bigcurlyvee_{i\in I}P_i}{C}{\bigcurlyvee_{i\in I}Q_i}}
  \hva\and
  \inferrule[\Bd:Constancy)]{\djudge{P}{C}{Q}\\\Fv(B)\cap\Mod(C)=\emptyset}{\djudge{P\curlywedge[B]}{C}{Q\curlywedge[B]}}
  \hva\and
  \inferrule[(\Bd:Relax)]{\djudge{P}{C}{Q}\\\Fv(F)\cap\Mod(C)=\emptyset\\F\preceq 0}{\djudge{P+F}{C}{Q+F}}
  \hva\and
  \inferrule[(\Bd:Cons)]{P\preceq P' \\ \djudge{P'}{C}{Q'} \\ Q'\preceq Q}{\djudge{P}{C}{Q}}
  \hva\and
  \inferrule[(\Bd:Subst)]{\djudge{P}{C}{Q}\\y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)}{\djudge{P[y/x]}{C[y/x]}{Q[y/x]}}
%  \hva\and
%  \inferrule[(\Bd:Weaken)]{\djudge{P}{C}{Q}}{\bjudge{P}{C}{Q}}
\end{mathpar}
\caption{Proof Rules for \QBUAd Triples}
\label{fig:fullqbuad}
\end{figure}

\cref{fig:fullqbuad} shows the complete proof rules for \QBUAd triples.

\begin{theorem}[\QBUAd Soundness]\label{thm:qbuad-sound}
  For all $P$, $C$, $Q$, if $\djudge{P}{C}{Q}$ is derivable, then $\dJudge{P}{C}{Q}$ holds.
\end{theorem}

\begin{proof}
  By induction on the derivation.
  \begin{itemize}
    \item \textbf{Case} \textsc{(\Bd:Skip)}:\\
      Let $P$ be arbitrary such that $P\preceq 0$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)\le 0$, take $\tau=\sigma$ and $q=p$. Then we have $q\le P(\tau)$ and $\bigstep{\Skip}{\sigma}{p}{p}{\tau}{q}$ by \textsc{(BS:Skip)} for $p\le 0$. It follows that $\dJudge{P}{\Skip}{P}$.
    \item \textbf{Case} \textsc{(\Bd:Assign)}:\\
      Let $P$ be arbitrary such that $P\preceq 0$, and let $Q=\Sup x'.P[x'/x]\curlywedge[x=e[x'/x]]$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, take $\tau=\sigma[x\mapsto\eval{e}{\sigma}]$ and $q=p$. Notice that
      \begin{align*}
        Q(\tau)
        &=\sup_v\{(P[x'/x]\curlywedge[x=e[x'/x]])(\tau[x\mapsto v])\}\\
        &=\sup_v\{\min\{(P[x'/x])(\tau[x\mapsto v]),[x=e[x'/x]](\tau[x\mapsto v])\}\}\\
        &=\sup_v\{\min\{P(\tau[x\mapsto v]),[\eval{x}{\tau}=\eval{e}{\tau[x\mapsto v]}]\}\}\\
        &\ge\min\{P(\tau[x\mapsto\eval{x}\sigma]),[\eval{x}{\tau}=\eval{e}{\tau[x\mapsto\eval{\sigma}{x}]}]\}\\
        &=P(\sigma).
    \end{align*}
    Combining with $\bigstep{\Assign{x}{e}}{\sigma}{p}{p}{\tau}{q}$ by \textsc{(BS:Assign)} and $p\le P(\sigma)\le 0$, we have $\dJudge{P}{\Assign{x}{e}}{Q}$.
    \item \textbf{Case} \textsc{(\Bd:Assume)}:\\
      Let $P$ be arbitrary such that $P\preceq 0$. For any $\sigma$ and $p$ satisfying $p\le (P\curlywedge[B])(\sigma)\le 0$, we have $p\le P(\sigma)\le 0$ and $\eval{B}{\sigma}=\true$. Take $\tau=\sigma$ and $q=p$. Then we have $q\le (P\curlywedge[B])(\tau)$ and $\bigstep{\Assume{B}}{\sigma}{p}{p}{\tau}{q}$ by \textsc{(BS:Assume)} for $p\le 0$. It follows that $\dJudge{P\curlywedge[B]}{\Assume{B}}{P\curlywedge[B]}$.
    \item \textbf{Case} \textsc{(\Bd:Tick)}:\\
      Let $P$ be arbitrary such that $(P\curlywedge P-e)\preceq 0$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, take $\tau=\sigma$ and $q=p-\eval{e}{\sigma}$. Then we have $q\le (P-e)(\tau)$ and $\bigstep{\Tick{e}}{\sigma}{p}{\min\{p,p-\eval{e}{\sigma}\}}{\tau}{q}$ by \textsc{(BS:Tick)}. Since $\min\{p,p-\eval{e}{\sigma}\}=(P\curlywedge P-e)(\sigma)\le 0$, we have $\dJudge{P}{\Tick{e}}{P-e}$.
    \item \textbf{Case} \textsc{(\Bd:SeqL)}:\\
      Let $P,Q,R,C_1,C_2$ be arbitrary such that $\djudge{P}{C_1}{R}$ and $\bjudge{R}{C_2}{Q}$. By induction hypothesis, we have $\dJudge{P}{C_1}{R}$ and by theorem \ref{thm:qbua-sound} we have $\bJudge{R}{C_2}{Q}$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists a $\rho$ and an $r$ such that $r\le R(\rho)$ and $\bigstep{C_1}{\sigma}{p}{l_1}{\rho}{r}$ for some $l_1\le 0$. Then there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C_2}{\rho}{r}{l_2}{\tau}{q}$ for some $l_2$. Hence, $\bigstep{\Seq{C_1}{C_2}}{\sigma}{p}{\min\{l_1,l_2\}}{\tau}{q}$ holds by \textsc{(BS:Seq)}. Since $l_1\le 0$, we have $\min\{l_1,l_2\}\le 0$. It follows that $\dJudge{P}{\Seq{C_1}{C_2}}{Q}$.
    \item \textbf{Case} \textsc{(\Bd:SeqR)}:\\
      This case is similar to the previous one.
    \item \textbf{Case} \textsc{(\Bd:ChoiceL)}:\\
      Let $P,Q,C_1,C_2$ be arbitrary such that $\djudge{P}{C_1}{Q}$. By induction hypothesis, we have $\dJudge{P}{C_1}{Q}$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C_1}{\sigma}{p}{l}{\tau}{q}$ for some $l\le 0$. Hence, $\bigstep{\Choice{C_1}{C_2}}{\sigma}{p}{l}{\tau}{q}$ holds by \textsc{(BS:ChoiceL)} for $l\le 0$. It follows that $\dJudge{P}{\Choice{C_1}{C_2}}{Q}$.
    \item \textbf{Case} \textsc{(\Bd:ChoiceR)}:\\
      This case is similar to the previous one.
    \item \textbf{Case} \textsc{(\Bd:LoopZero)}:\\
      Let $P$ be arbitrary such that $P\preceq 0$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)\le 0$, take $\tau=\sigma$ and $q=p$. Then we have $q\le P(\tau)$ and $\bigstep{\Skip}{\Loop{C}}{p}{p}{\tau}{q}$ by \textsc{(BS:LoopZero)} for $p\le 0$. It follows that $\dJudge{P}{\Loop{C}}{P}$.
    \item \textbf{Case} \textsc{(\Bd:Loop)}:\\
      Let $P,C$ be arbitrary such that $\bjudge{P(n)}{C}{P(n+1)}$ for all $n<k$ and $\djudge{P(m)}{C}{P(m+1)}$ for some $m<k$. By theorem \ref{thm:qbua-sound} we have $\bJudge{P(n)}{C}{P(n+1)}$ for all $n<k$ and by induction hypothesis we have $\dJudge{P(m)}{C}{P(m+1)}$. Notice that $\forall m+1\le n<k. \bjudge{P(n)}{C}{P(n+1)}$, so by \textsc{(B:Loop)} we can derive $\bjudge{P(m+1)}{\Loop{C}}{P(k)}$. Thus, we have $\bJudge{P(m+1)}{\Loop{C}}{P(k)}$ by theorem \ref{thm:qbua-sound}.\\
      Therefore, we can proof $\dJudge{P(m)}{\Loop{C}}{P(k)}$ as follows: for any $\sigma$ and $p$ satisfying $p\le P(m)(\sigma)$, by $\dJudge{P(m)}{C}{P(m+1)}$, there exists a $\rho$ and an $r$ such that $r\le P(m+1)(\rho)$ and $\bigstep{C}{\sigma}{p}{l_1}{\rho}{r}$ for some $l_1\le 0$. Then, by $\bJudge{P(m+1)}{\Loop{C}}{P(k)}$, there exists a $\tau$ and a $q$ such that $q\le P(k)(\tau)$ and $\bigstep{\Loop{C}}{\rho}{r}{l_2}{\tau}{q}$ for some $l_2$. Hence, $\bigstep{\Seq{C}{\Loop{C}}}{\sigma}{p}{\min\{l_1,l_2\}}{\tau}{q}$ holds by \textsc{(BS:Seq)}, and consequently $\bigstep{\Loop{C}}{\sigma}{p}{\min\{l_1,l_2\}}{\tau}{q}$ holds by \textsc{(BS:Loop)}. Since $l_1\le 0$, we have $\min\{l_1,l_2\}\le 0$. It follows that $\dJudge{P(m)}{\Loop{C}}{P(k)}$.\\
      The remain thing is to inductively prove that for all $0\le i\le m$, $\dJudge{P(m-i)}{\Loop{C}}{P(k)}$ holds:
      \begin{itemize}
        \item \textbf{Base case} $i=0$:\\
          $\dJudge{P(m)}{\Loop{C}}{P(k)}$ is already proved.
        \item \textbf{Inductive step} $i\to i+1$:\\
          Assume $\dJudge{P(m-i)}{\Loop{C}}{P(k)}$ holds. Let $\sigma$ and $p$ be arbitrary such that $p\le P(m-(i+1))(\sigma)$. By $\bJudge{P(m-(i+1))}{C}{P(m-i)}$, there exists a $\rho$ and an $r$ such that $r\le P(k-i)(\rho)$ and $\bigstep{C}{\sigma}{p}{l_1}{\rho}{r}$ for some $l_1$. Besides, $\dJudge{P(m-i)}{\Loop{C}}{k}$ implies that there exists a $\tau$ and a $q$ such that $q\le P(k)(\tau)$ and $\bigstep{\Loop{C}}{\rho}{r}{l_2}{\tau}{q}$ for some $l_2\le 0$. Hence, $\bigstep{\Seq{C}{\Loop{C}}}{\sigma}{p}{\min\{l_1,l_2\}}{\tau}{q}$ holds by \textsc{(BS:Seq)}, and consequently $\bigstep{\Loop{C}}{\sigma}{p}{\min\{l_1,l_2\}}{\tau}{q}$ holds by \textsc{(BS:Loop)}. Since $l_2\le 0$, we have $\min\{l_1,l_2\}\le 0$. It follows that $\dJudge{P(m-(i+1))}{\Loop{C}}{P(k)}$.
      \end{itemize}
      Taking $i=m$, we have $\dJudge{P(0)}{\Loop{C}}{P(k)}$.
    \item \textbf{Case} \textsc{(\Bd:Local)}:\\
      Let $P,Q,C$ be arbitrary such that $\djudge{P}{C}{Q}$. By induction hypothesis, we have $\dJudge{P}{C}{Q}$. For any $\sigma$ and $p$ satisfying $p\le (\Sup x.P)(\sigma)=\sup_v\{P(\sigma\mapsto v)\}$, there exists a $v$ such that $p\le P(\sigma[x\mapsto v])$. Since $\dJudge{P}{C}{Q}$, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C}{\sigma[x\mapsto v]}{p}{l}{\tau}{q}$ for some $l\le 0$. This implies that $q\le (\Sup x.Q)(\tau[x\mapsto\eval{x}{\sigma}]$ and $\bigstep{\Local{x}{C}}{\sigma}{p}{l}{\tau[x\mapsto\eval{x}{\sigma}]}{q}$ by \textsc{(BS:Local)} for $l\le 0$. It follows that $\dJudge{(\Sup x.P)}{\Local{x}{C}}{(\Sup x.Q)}$.
    \item \textbf{Case} \textsc{(\Bd:Constancy)}:\\
      Let $P,Q,B,C$ be arbitrary such that $\djudge{P}{C}{Q}$ and $\Fv(B)\cap\Mod(C)=\emptyset$. By induction hypothesis, we have $\dJudge{P}{C}{Q}$. For any $\sigma$ and $p$ satisfying $p\le (P\curlywedge[B])(\sigma)$, we have $p\le P(\sigma)$ and $\eval{B}{\sigma}=\true$. Then there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$ for some $l\le 0$. By proposition \ref{prop:const}, we have $\eval{B}{\tau}=\true$, and then $q\le (Q\curlywedge[B])(\tau)$. It follows that $\dJudge{P\curlywedge[B]}{C}{Q\curlywedge[B]}$.
    \item \textbf{Case} \textsc{(\Bd:Relax)}:\\
      Let $P,Q,F,C$ be arbitrary such that $\djudge{P}{C}{Q}$, $\Fv(F)\cap\Mod(C)=\emptyset$ and $F\preceq 0$. By induction hypothesis, we have $\dJudge{P}{C}{Q}$. For any $\sigma$ and $p$ satisfying $p\le (P+F)(\sigma)=P(\sigma)+F(\sigma)$, we have $p-F(\sigma)\le P(\sigma)$. Then there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C}{\sigma}{p-F(\sigma)}{l}{\tau}{q}$ for some $l\le 0$. By lemma \ref{lem:relax} and proposition \ref{prop:const}, we have $\bigstep{C}{\sigma}{p}{l+F(\tau)}{\tau}{q+F(\tau)}$. Since $l\le 0$ and $F\preceq 0$, we have $l+F(\tau)\le 0$. It follows that $\dJudge{P+F}{C}{Q}$.
    \item \textbf{Case} \textsc{(\Bd:Cons)}:\\
      Let $P,P',Q,Q',C$ be arbitrary such that $P\preceq P'$, $Q'\preceq Q$ and $\djudge{P'}{C}{Q'}$. By induction hypothesis, we have $\dJudge{P'}{C}{Q'}$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, we have $p\le P'(\sigma)$. Then there exists a $\tau$ and a $q$ such that $q\le Q'(\tau)$ and $\bigstep{C}{\sigma}{p}{l}{\tau}{q}$ for some $l\le 0$. Since $Q'(\tau)\le Q(\tau)$, we have $q\le Q(\tau)$. It follows that $\dJudge{P}{C}{Q}$.
    \item \textbf{Case} \textsc{(\Bd:Subst)}:\\
      Let $P,Q,C$ be arbitrary such that $\djudge{P}{C}{Q}$, and let $x,y$ be arbitrary such that $y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)$. By induction hypothesis, we have $\dJudge{P}{C}{Q}$. For any $\sigma$ and $p$ satisfying $p\le P[y/x](\sigma)=P(\sigma[x\mapsto\eval{y}{\sigma}])$, we have $p\le P(\sigma')$ since $y\notin\Fv(P)$, where $\sigma'=\sigma[x\mapsto\eval{y}{\sigma}][y\mapsto\eval{x}{\sigma}]$. Then there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstep{C}{\sigma'}{p}{l}{\tau}{q}$ for some $l\le 0$. By proposition \ref{prop:subst}, we have $\bigstep{C[y/x]}{\sigma}{p}{l}{\tau'}{q}$ for $l\le 0$, where $\tau'=\tau[x\mapsto\eval{x}{\sigma}][y\mapsto\eval{x}{\tau}]$. Since $y\notin\Fv(Q)$, we have $q\le Q(\tau)=Q[y/x](\tau')$. It follows that $\dJudge{P[y/x]}{C[y/x]}{Q[y/x]}$.
  \end{itemize}
\end{proof}

\begin{lemma}\label{lem:loop-unroll}
  For all $C,\sigma,p,l,\tau,q$, if $\bigstep{\Loop{C}}{\sigma}{p}{l}{\tau}{q}$, then there exists an $n\ge 0$ such that $\bigstep{C^n}{\sigma}{p}{l}{\tau}{q}$.
\end{lemma}

\begin{proof}
  By induction on the derivation of $\bigstep{\Loop{C}}{\sigma}{p}{l}{\tau}{q}$.
  \begin{itemize}
    \item \textbf{Case} \textsc{(BS:LoopZero)}:\\
      In this case, we have $\sigma=\tau$ and $p=l=q$, so we can take $n=0$.
    \item \textbf{Case} \textsc{(BS:Loop)}:\\
      Suppose $\bigstep{\Seq{C}{\Loop{C}}}{\sigma}{p}{l}{\tau}{q}$, then there exist $\rho,r,l_1,l_2$ such that $\bigstep{C}{\sigma}{p}{l_1}{\rho}{r}$, $\bigstep{\Loop{C}}{\rho}{r}{l_2}{\tau}{q}$, and $l=\min\{l_1,l_2\}$. By induction hypothesis, there exists an $n'\ge 0$ such that $\bigstep{C^n}{\rho}{r}{l_2}{\tau}{q}$. Taking $n=n'+1$, we have $\bigstep{C^n}{\sigma}{p}{l}{\tau}{q}$.
  \end{itemize}
\end{proof}

%\begin{lemma}\label{lem:local}
%  For all $C,x,y$ such that $x\ne y$ and $y\notin\Fv(C)$, $\Local{x}{C}$ and $\Local{y}{C[y/x]}$ are semantically equivalent. That is, for all $\sigma,p,\tau,q,l$, $\bigstep{\Local{x}{C}}{\sigma}{p}{l}{\tau}{q}$ if and only if $\bigstep{\Local{y}{C[y/x]}}{\sigma}{p}{l}{\tau}{q}$.
%\end{lemma}
%
%\begin{proof}
%  We only need to prove the forward direction since $C=C[y/x][x/y]$. Let $\sigma,p,\tau,q,l$ be arbitrary such that $\bigstep{\Local{x}{C}}{\sigma}{p}{l}{\tau}{q}$. Then from the semantics of $\Local{x}{C}$, there exists $\sigma',\tau',v$ such that $\sigma=\sigma'[x\mapsto v]$, $\tau=\tau'[x\mapsto v]$, and $\bigstep{C}{\sigma'}{p}{l}{\tau'}{q}$. By proposition \ref{prop:porg-const}, we have $\bigstep{C}{\sigma'[y\mapsto v]}{p}{l}{\tau'[y\mapsto v]}{q}$, and consequently we have $\bigstep{C[y/x]}{\sigma'[x\mapsto v][y\mapsto\eval{x}{\sigma'}]}{p}{l}{\tau'[x\mapsto v][y\mapsto\eval{x}{\tau'}]}{q}$ by proposition \ref{prop:subst}. Using \textsc{(BS:Local)} and instantiating $v=\eval{y}{\sigma'}=\eval{y}{\tau'}$, we have $\bigstep{\Local{y}{C[y/x]}}{\sigma}{p}{l}{\tau}{q}$.
%\end{proof}

\begin{theorem}[QFUA Completeness]\label{thm:qfua-complete}
  For all $P,C,Q$, if $\fJudge{P}{C}{Q}$ holds, then $\fjudge{P}{C}{Q}$ is derivable.
\end{theorem}

\begin{proof}
  By induction on the structure of $C$.
  \begin{itemize}
    \item \textbf{Case} $\Skip$:\\
      Let $P,Q$ be arbitrary such that $\fJudge{P}{\Skip}{Q}$. From the semantics of the QFUA triple and $\Skip$, we have $P\preceq Q$. Then we can derive $\fjudge{P}{\Skip}{Q}$ using \textsc{(F:Skip)} and \textsc{(F:Cons)}.
    \item \textbf{Case} $\Assign{x}{e}$:\\
      Let $P,Q$ be arbitrary such that $\fJudge{P}{\Assign{x}{e}}{Q}$. From the semantics of the QFUA triple and $\Assign{x}{e}$, we have that for any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, there exists a $\sigma$ such that $q\ge P(\sigma)$ and $\tau=\sigma[x\mapsto\eval{e}{\sigma}]$. Taking $x'=\eval{x}{\sigma}$, we have $q\ge P(\tau[x\mapsto x'])$ and $\eval{x}{\tau}=\eval{e}{\sigma}=\eval{e[x'/x]}{\tau}$. This implies that $q\ge Q'(\tau)$, where $Q'(\tau)=\Inf x'.P[x'/x]\curlyvee[x\ne e[x'/x]]$. Since $q$ is arbitrary, we have $Q'\preceq Q$, and consequently $\fjudge{P}{\Assign{x}{e}}{Q}$ is derivable by \textsc{(F:Assign)} and \textsc{(F:Cons)}.
    \item \textbf{Case} $\Assume{B}$:\\
      Let $P,Q$ be arbitrary such that $\fJudge{P}{\Assume{B}}{Q}$. From the semantics of the QFUA triple and $\Assume{B}$, we have $P\preceq P\curlyvee[\neg B]\preceq Q$. Then we can derive $\fjudge{P}{\Assume{B}}{Q}$ using \textsc{(F:Assume)} and \textsc{(F:Cons)}.
    \item \textbf{Case} $\Tick{e}$:\\
      Let $P,Q$ be arbitrary such that $\fJudge{P}{\Tick{e}}{Q}$. From the semantics of the QFUA triple and $\Tick{e}$, we have $P-e\preceq Q$. Then we can derive $\fjudge{P}{\Tick{e}}{Q}$ using \textsc{(F:Tick)} and \textsc{(F:Cons)}.
    \item \textbf{Case} $\Seq{C_1}{C_2}$:\\
      Let $P,Q$ be arbitrary such that $\fJudge{P}{\Seq{C_1}{C_2}}{Q}$. From the semantics of the QFUA triple and $\Seq{C_1}{C_2}$, we have that for any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, there exists $\sigma,p,\rho,r$ such that $p\ge P(\sigma)$, $\bigstepp{C_1}{\sigma}{p}{\rho}{r}$, and $\bigstepp{C_2}{\rho}{r}{\tau}{q}$. We take $R=\post{C_1}{P}$, then $\fJudge{P}{C_1}{R}$ and $\fJudge{R}{C_2}{Q}$ holds. By induction hypothesis, we have $\fjudge{P}{C_1}{R}$ and $\fjudge{R}{C_2}{Q}$. Thus, we can derive $\fjudge{P}{\Seq{C_1}{C_2}}{Q}$ using \textsc{(F:Seq)}.
    \item \textbf{Case} $\Choice{C_1}{C_2}$:\\
      Let $P,Q$ be arbitrary such that $\fJudge{P}{\Choice{C_1}{C_2}}{Q}$. From the semantics of the QFUA triple and $\Choice{C_1}{C_2}$, we have that for any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and either $\bigstepp{C_1}{\sigma}{p}{\tau}{q}$ or $\bigstepp{C_2}{\sigma}{p}{\tau}{q}$. So we can divide $Q$ into $Q=Q_1\curlywedge Q_2$, where $Q_i(\tau)=\inf\{q:q\ge Q(\tau)\land\exists\sigma,p.p\ge P(\sigma)\land\bigstepp{C_i}{\sigma}{p}{\tau}{q}\}$ for $i\in\{1,2\}$. By definition, $\fJudge{P}{C_i}{Q_i}$ holds for $i\in\{1,2\}$, which implies that $\fjudge{P}{C_i}{Q_i}$ using induction hypothesis. Then we can derive $\fjudge{P}{\Choice{C_1}{C_2}}{Q}$ using \textsc{(F:Choice)} and \textsc{(F:Disj)}.
    \item \textbf{Case} $\Loop{C}$:\\
      Let $P,Q$ be arbitrary such that $\fJudge{P}{\Loop{C}}{Q}$. From the semantics of the QFUA triple and by lemma \ref{lem:loop-unroll}, we have that for any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, there exists $\sigma,p,n$ such that $p\ge P(\sigma)$ and $\bigstepp{C^n}{\sigma}{p}{\tau}{q}$. So we can divide $Q$ into $Q=\bigcurlywedge_{n\ge 0}Q_n$, where $Q_n(\tau)=\inf\{q:q\ge Q(\tau)\land\exists\sigma,p.p\ge P(\sigma)\land\bigstepp{C^n}{\sigma}{p}{\tau}{q}\}$. In this case, $\fJudge{P}{C^n}{Q_n}$ holds for all $n\ge 0$.\\
      For each $n\ge 0$, let $R_n(i)=\post{C^i}{P}$ for $0\le i<n$ and $R_n(n)=Q_n$.\footnote{By the associativity of sequential composition, $C^i$ can be read as left-associative.} Thus, we have $\fJudge{R_n(i)}C{R_n(i+1)}$ for all $0\le i<n-1$ by definition and $\fJudge{R_n(n-1)}C{R_n(n)}$ by $\fJudge{P}{C^n}{Q_n}$. From induction hypothesis, we have $\fjudge{R_n(i)}C{R_n(i+1)}$ for all $0\le i<n$. Then we can derive $\fjudge{P}{\Loop{C}}{Q_n}$ using \textsc{(F:Loop)}. Finally, we can derive $\fjudge{P}{\Loop{C}}{Q}$ using \textsc{(F:Disj)}.
    \item \textbf{Case} $\Local{x}{C}$:\\
      Let $P,Q$ be arbitrary such that $\fJudge{P}{\Local{x}{C}}{Q}$. Pick $y$ be a fresh variable such that $y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)$, and let $Q'=\post{C[y/x]}{P}$. We have $\fJudge{P}{C[y/x]}{Q'}$.
      By induction hypothesis,\footnote{Since $C[y/x]$ is not a subterm of $\Local{x}{C}$, we should use a stronger induction hypothesis: $\fJudge{P}{C}{Q}[\overrightarrow{y}/\overrightarrow{x}]$ implies $\fjudge{P}{C}{Q}[\overrightarrow{y}/\overrightarrow{x}]$, same as incorrectness logic~\cite{POPL:OHearn20}. Similar strengthen applies to the proof of QBUA and \QBUAd completeness.} we have $\fjudge{P}{C[y/x]}{Q'}$, so we can derive $\fjudge{\Inf y.P}{\Local{x}{C}}{\Inf y.Q'}$ using \textsc{(F:Local)}.\\
      Next, we will prove that $\Inf y.Q'\preceq Q$. For any $\tau$ and $q$ satisfying $q\ge Q(\tau)$, since $\fJudge{P}{\Local{x}{C}}{Q}$ holds, there exists a $\sigma$ and a $p$ such that $p\ge P(\sigma)$ and $\bigstepp{\Local{x}{C}}{\sigma}{p}{\tau}{q}$. From the semantics of $\Local{x}{C}$, there exists $\sigma',\tau',v$ such that $\sigma=\sigma'[x\mapsto v]$, $\tau=\tau'[x\mapsto v]$, and $\bigstepp{C}{\sigma'}{p}{\tau'}{q}$. Then we have $\bigstepp{C[y/x]}{\sigma''}{p}{\tau''}{q}$ by proposition \ref{prop:subst}, where $\sigma''=\sigma[y\mapsto\eval{x}{\sigma'}]$ and $\tau''=\tau[y\mapsto\eval{x}{\tau'}]$. Since $y$ is fresh, we have $P(\sigma'')=P(\sigma)$, then we have $q\ge Q'(\tau'')$ from $\bigstepp{C[y/x]}{\sigma''}{p}{\tau''}{q}$. This implies that $q\ge\Inf y.Q'(\tau)$, and consequently $\Inf y.Q'\preceq Q$.\\
      Finally, since $\Inf y.P=P$ by the freshness of $y$, we can derive $\fjudge{P}{\Local{x}{C}}{Q}$ using \textsc{(F:Cons)}.
  \end{itemize}
\end{proof}

\begin{theorem}[QBUA Completeness]\label{thm:qbua-complete}
  For all $P,C,Q$, if $\bJudge{P}{C}{Q}$ holds, then $\bjudge{P}{C}{Q}$ is derivable.
\end{theorem}

\begin{proof}
  By induction on the structure of $C$.
  \begin{itemize}
    \item \textbf{Case} $\Skip$:\\
      Let $P,Q$ be arbitrary such that $\bJudge{P}{\Skip}{Q}$. From the semantics of the QBUA triple and $\Skip$, we have $P\preceq Q$. Then we can derive $\bjudge{P}{\Skip}{Q}$ using \textsc{(B:Skip)} and \textsc{(B:Cons)}.
    \item \textbf{Case} $\Assign{x}{e}$:\\
      Let $P,Q$ be arbitrary such that $\bJudge{P}{\Assign{x}{e}}{Q}$. Denote $Q'=\Sup x'.P[x'/x]\curlywedge[x=e[x'/x]]$. We will prove that $Q'\preceq Q$. For seek of contradiction, suppose there exists $\tau$ such that $Q'(\tau)>Q(\tau)$. Then there exists $v$ such that $\eval{x}{\tau}=\eval{e}{\tau[x\mapsto v]}$ and $P(\tau[x\mapsto v])>Q(\tau)$. Therefore, take $\sigma=\tau[x\mapsto v]$ and $p=P(\sigma)$. From the semantics of $\bJudge{P}{\Assign{x}{e}}{Q}$, we have $p\le Q(\tau)$, which leads to a contradiction. Thus, we have $Q'\preceq Q$, and consequently $\bjudge{P}{\Assign{x}{e}}{Q}$ is derivable by \textsc{(B:Assign)} and \textsc{(B:Cons)}.
    \item \textbf{Case} $\Assume{B}$:\\
      Let $P,Q$ be arbitrary such that $\bJudge{P}{\Assume{B}}{Q}$. From the semantics of the QBUA triple and $\Assume{B}$, we have $P=P\curlywedge[B]\preceq Q$. Then we can derive $\bjudge{P}{\Assume{B}}{Q}$ using \textsc{(B:Assume)} and \textsc{(B:Cons)}.
    \item \textbf{Case} $\Tick{e}$:\\
      Let $P,Q$ be arbitrary such that $\bJudge{P}{\Tick{e}}{Q}$. From the semantics of the QBUA triple and $\Tick{e}$, we have $P-e\preceq Q$. Then we can derive $\bjudge{P}{\Tick{e}}{Q}$ using \textsc{(B:Tick)} and \textsc{(B:Cons)}.
    \item \textbf{Case} $\Seq{C_1}{C_2}$:\\
      Let $P,Q$ be arbitrary such that $\bJudge{P}{\Seq{C_1}{C_2}}{Q}$. From the semantics of the QBUA triple and $\Seq{C_1}{C_2}$, we have that for any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists $\tau,q,\rho,r$ such that $q\le Q(\tau)$, $\bigstepp{C_1}{\sigma}{p}{\rho}{r}$, and $\bigstepp{C_2}{\rho}{r}{\tau}{q}$. We take $R=\pre{C_2}{Q}$, then $\bJudge{P}{C_1}{R}$ and $\bJudge{R}{C_2}{Q}$ holds. By induction hypothesis, we have $\bjudge{P}{C_1}{R}$ and $\bjudge{R}{C_2}{Q}$. Thus, we can derive $\bjudge{P}{\Seq{C_1}{C_2}}{Q}$ using \textsc{(B:Seq)}.
    \item \textbf{Case} $\Choice{C_1}{C_2}$:\\
      Let $P,Q$ be arbitrary such that $\bJudge{P}{\Choice{C_1}{C_2}}{Q}$. From the semantics of the QBUA triple and $\Choice{C_1}{C_2}$, we have that for any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and either $\bigstepp{C_1}{\sigma}{p}{\tau}{q}$ or $\bigstepp{C_2}{\sigma}{p}{\tau}{q}$. So we can divide $P$ into $P=P_1\curlyvee P_2$, where $P_i(\sigma)=\sup\{p:p\le P(\sigma)\land\exists\tau,q.q\le Q(\tau)\land\bigstepp{C_i}{\sigma}{p}{\tau}{q}\}$ for $i\in\{1,2\}$. By definition, $\bJudge{P_i}{C_i}{Q}$ holds for $i\in\{1,2\}$, which implies that $\bjudge{P_i}{C_i}{Q}$ using induction hypothesis. Then we can derive $\bjudge{P}{\Choice{C_1}{C_2}}{Q}$ using \textsc{(B:Choice)} and \textsc{(B:Disj)}.
    \item \textbf{Case} $\Loop{C}$:\\
      Let $P,Q$ be arbitrary such that $\bJudge{P}{\Loop{C}}{Q}$. From the semantics of the QBUA triple and by lemma \ref{lem:loop-unroll}, we have that for any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists $\tau,q,n$ such that $q\le Q(\tau)$ and $\bigstepp{C^n}{\sigma}{p}{\tau}{q}$. So we can divide $P$ into $P=\bigcurlyvee_{n\ge 0}P_n$, where $P_n(\sigma)=\sup\{p:p\le P(\sigma)\land\exists\tau,q.q\le Q(\tau)\land\bigstepp{C^n}{\sigma}{p}{\tau}{q}\}$. In this case, $\bJudge{P_n}{C^n}{Q}$ holds for all $n\ge 0$.\\
      For each $n\ge 0$, let $R_n(i)=\pre{C^{n-i}}{Q}$ for $0<i\le n$ and $R_n(0)=P_n$. Thus, we have $\bJudge{R_n(i-1)}C{R_n(i)}$ for all $1<i\le n$ by definition and $\bJudge{R_n(0)}C{R_n(1)}$ by $\bJudge{P_n}{C^n}{Q}$. From induction hypothesis, we have $\bjudge{R_n(i-1)}C{R_n(i)}$ for all $0<i\le n$. Then we can derive $\bjudge{P_n}{\Loop{C}}{Q}$ using \textsc{(B:Loop)}. Finally, we can derive $\bjudge{P}{\Loop{C}}{Q}$ using \textsc{(B:Disj)}.
    \item \textbf{Case} $\Local{x}{C}$:\\
      Let $P,Q$ be arbitrary such that $\bJudge{P}{\Local{x}{C}}{Q}$. Pick $y$ be a fresh variable such that $y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)$, and let $P'=\pre{C[y/x]}{Q}$. We have $\bJudge{P'}{C[y/x]}{Q}$. By induction hypothesis, we have $\bjudge{P'}{C[y/x]}{Q}$, so we can derive $\bjudge{\Sup y.P'}{\Local{x}{C}}{\Sup y.Q}$ using \textsc{(B:Local)}.\\
      Next, we will prove that $P\preceq\Sup y.P'$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, since $\bJudge{P}{\Local{x}{C}}{Q}$ holds, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstepp{\Local{x}{C}}{\sigma}{p}{\tau}{q}$. From the semantics of $\Local{x}{C}$, there exists $\sigma',\tau',v$ such that $\sigma=\sigma'[x\mapsto v]$, $\tau=\tau'[x\mapsto v]$, and $\bigstepp{C}{\sigma'}{p}{\tau'}{q}$. Then we have $\bigstepp{C[y/x]}{\sigma''}{p}{\tau''}{q}$ by proposition \ref{prop:subst}, where $\sigma''=\sigma[y\mapsto\eval{x}{\sigma'}]$ and $\tau''=\tau[y\mapsto\eval{x}{\tau'}]$. Since $y$ is fresh, we have $Q(\tau'')=Q(\tau)$, then we have $p\le P'(\sigma'')$ from $\bigstepp{C[y/x]}{\sigma''}{p}{\tau''}{q}$. This implies that $p\le\Sup y.P'(\sigma)$, and consequently $P\preceq\Sup y.P'$.\\
      Finally, since $\Sup y.Q=Q$ by the freshness of $y$, we can derive $\bjudge{P}{\Local{x}{C}}{Q}$ using \textsc{(B:Cons)}.
  \end{itemize}
\end{proof}

\begin{theorem}[\QBUAd Completeness]\label{thm:qbuad-complete}
  For all $P,C,Q$, if $\dJudge{P}{C}{Q}$ holds, then $\djudge{P}{C}{Q}$ is derivable.
\end{theorem}

\begin{proof}
  By induction on the structure of $C$.
  \begin{itemize}
    \item \textbf{Case} $\Skip$:\\
      Let $P,Q$ be arbitrary such that $\dJudge{P}{\Skip}{Q}$. From the semantics of the \QBUAd triple and $\Skip$, we have $P\preceq Q$ and $P\preceq 0$. Then we can derive $\djudge{P}{\Skip}{Q}$ using \textsc{(\Bd:Skip)} and \textsc{(\Bd:Cons)}.
    \item \textbf{Case} $\Assign{x}{e}$:\\
      Let $P,Q$ be arbitrary such that $\dJudge{P}{\Assign{x}{e}}{Q}$. Denote $Q'=\Sup x'.P[x'/x]\curlywedge[x=e[x'/x]]$. We will prove that $Q'\preceq Q$. For seek of contradiction, suppose there exists $\tau$ such that $Q'(\tau)>Q(\tau)$. Then there exists $v$ such that $\eval{x}{\tau}=\eval{e}{\tau[x\mapsto v]}$ and $P(\tau[x\mapsto v])>Q(\tau)$. Therefore, take $\sigma=\tau[x\mapsto v]$ and $p=P(\sigma)$. From $\dJudge{P}{\Assign{x}{e}}{Q}$, we have $p\le Q(\tau)$, which leads to a contradiction. Thus, we have $Q'\preceq Q$. Besides, we also have $P\preceq 0$ from $\dJudge{P}{\Assign{x}{e}}{Q}$, so $\djudge{P}{\Assign{x}{e}}{Q}$ is derivable by \textsc{(\Bd:Assign)} and \textsc{(\Bd:Cons)}.
    \item \textbf{Case} $\Assume{B}$:\\
      Let $P,Q$ be arbitrary such that $\dJudge{P}{\Assume{B}}{Q}$. From the semantics of the \QBUAd triple and $\Assume{B}$, we have $P=P\curlywedge[B]\preceq Q$ and $P\preceq 0$. Then we can derive $\djudge{P}{\Assume{B}}{Q}$ using \textsc{(\Bd:Assume)} and \textsc{(\Bd:Cons)}.
    \item \textbf{Case} $\Tick{e}$:\\
      Let $P,Q$ be arbitrary such that $\dJudge{P}{\Tick{e}}{Q}$. From the semantics of the \QBUAd triple and $\Tick{e}$, we have $P-e\preceq Q$ and $P\curlywedge P-e\preceq 0$. Then we can derive $\djudge{P}{\Tick{e}}{Q}$ using \textsc{(\Bd:Tick)} and \textsc{(\Bd:Cons)}.
    \item \textbf{Case} $\Seq{C_1}{C_2}$:\\
      Let $P,Q$ be arbitrary such that $\dJudge{P}{\Seq{C_1}{C_2}}{Q}$. From the semantics of the \QBUAd triple and $\Seq{C_1}{C_2}$, we have that for any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists $\tau,q,\rho,r$ such that one of the following holds:
      \begin{itemize}
        \item[(1)] $q\le Q(\tau)$, $\bigstepl{C_1}{\sigma}{p}{\rho}{r}$, and $\bigstepp{C_2}{\rho}{r}{\tau}{q}$;
        \item[(2)] $q\le Q(\tau)$, $\bigstepp{C_1}{\sigma}{p}{\rho}{r}$, and $\bigstepl{C_2}{\rho}{r}{\tau}{q}$.
      \end{itemize}
      So we can divide $P$ into $P=P_1\curlyvee P_2$, where $P_i(\sigma)=\sup\{p:p\le P(\sigma)\land\text{ there exists }\tau,q,\rho,r\text{ such that (}i\text{) holds}\}$ for $i\in\{1,2\}$.
      \begin{itemize}
        \item For the case (1), let $R_1=\pre{C_2}{Q}$, then $\dJudge{P_1}{C_1}{R_1}$ and $\bJudge{R_1}{C_2}{Q}$ holds. By induction hypothesis and theorem \ref{thm:qbua-complete}, we have $\djudge{P_1}{C_1}{R_1}$ and $\bjudge{R_1}{C_2}{Q}$. Thus, we can derive $\djudge{P_1}{\Seq{C_1}{C_2}}{Q}$ using \textsc{(\Bd:SeqL)}.
        \item For the case (2), let $R_2=\prel{C_2}{Q}$, then $\bJudge{P_2}{C_1}{R_2}$ and $\dJudge{R_2}{C_2}{Q}$ holds. By theorem \ref{thm:qbua-complete} and induction hypothesis, we have $\bjudge{P_2}{C_1}{R_2}$ and $\djudge{R_2}{C_2}{Q}$. Thus, we can derive $\djudge{P_2}{\Seq{C_1}{C_2}}{Q}$ using \textsc{(\Bd:SeqR)}.
      \end{itemize}
      Finally, we can derive $\djudge{P}{\Seq{C_1}{C_2}}{Q}$ using \textsc{(\Bd:Disj)}.
    \item \textbf{Case} $\Choice{C_1}{C_2}$:\\
      Let $P,Q$ be arbitrary such that $\dJudge{P}{\Choice{C_1}{C_2}}{Q}$. From the semantics of the \QBUAd triple and $\Choice{C_1}{C_2}$, we have that for any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and either $\bigstepl{C_1}{\sigma}{p}{\tau}{q}$ or $\bigstepl{C_2}{\sigma}{p}{\tau}{q}$. So we can divide $P$ into $P=P_1\curlyvee P_2$, where $P_i(\sigma)=\sup\{p:p\le P(\sigma)\land\exists\tau,q.q\le Q(\tau)\land\bigstepl{C_i}{\sigma}{p}{\tau}{q}\}$ for $i\in\{1,2\}$. By definition, $\dJudge{P_i}{C_i}{Q}$ holds for $i\in\{1,2\}$, which implies that $\djudge{P_i}{C_i}{Q}$ using induction hypothesis. Then we can derive $\djudge{P}{\Choice{C_1}{C_2}}{Q}$ using \textsc{(\Bd:Choice)} and \textsc{(\Bd:Disj)}.
    \item \textbf{Case} $\Loop{C}$:\\
      Let $P,Q$ be arbitrary such that $\dJudge{P}{\Loop{C}}{Q}$. From the semantics of the \QBUAd triple and $\Loop{C}$, we have that for any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, there exists $\tau,q,n$ such that $q\le Q(\tau)$ and $\bigstepl{C^n}{\sigma}{p}{\tau}{q}$. So we can divide $P$ into $P=\bigcurlyvee_{n\ge 0}P_n$, where $P_n(\sigma)=\sup\{p:p\le P(\sigma)\land\exists\tau,q.q\le Q(\tau)\land\bigstepl{C^n}{\sigma}{p}{\tau}{q}\}$. In this case, $\dJudge{P_n}{C^n}{Q}$ holds for all $n\ge 0$.\\
      For $n=0$, we have $P_0\preceq 0$ and then $\djudge{P_0}{\Loop{C}}{Q}$ is derivable by \textsc{(\Bd:LoopZero)} and \textsc{(\Bd:Cons)}.
      For each $n>0$, similar to the sequential composition, we can divide $P_n$ into $P_n=\bigcurlyvee_{0\le m<n}P_{n,m}$, where $P_{n,m}(\sigma)=\sup\{p:p\le P_n(\sigma)\land\exists\tau,q,\rho_1,r_1,\rho_2,r_2.q\le Q(\tau)\land\bigstepp{C^m}{\sigma}{p}{\rho_1}{r_1}\land\bigstepl{C}{\rho_1}{r_1}{\rho_2}{r_2}\land\bigstepp{C^{n-m-1}}{\rho_2}{r_2}{\tau}{q}\}$. For each $0\le m<n$, let
      \begin{align*}
        R_{n,m}(i)=\begin{cases}
          P_{n,m} & \text{if }i=0,\\
          \pre{C^{m-i}}{\prel{C}{\pre{C^{n-m-1}}{Q}}} & \text{if }0<i\le m,\\
          \pre{C^{n-i}}{Q} & \text{if }m<i\le n.\\
        \end{cases}
      \end{align*}
      Then we have $\bJudge{R_{n,m}(i)}{C}{R_{n,m}{i+1}}$ for all $i<n$ and $\dJudge{R_{n,m}(m)}{C}{R_{n,m}(m+1)}$. By theorem \ref{thm:qbua-complete} and induction hypothesis, we have $\bjudge{R_{n,m}(i)}{C}{R_{n,m}(i+1)}$ for all $i<n$ and $\djudge{R_{n,m}(m)}{C}{R_{n,m}(m+1)}$. Thus, we can derive $\djudge{P_{n,m}}{C^m}{Q}$ using \textsc{(\Bd:Loop)}, and then derive $\djudge{P_n}{C^n}{Q}$ using \textsc{(\Bd:Disj)}.\\
      Finally, we can derive $\djudge{P}{\Loop{C}}{Q}$ using \textsc{(\Bd:Disj)}.
    \item \textbf{Case} $\Local{x}{C}$:\\
      Let $P,Q$ be arbitrary such that $\dJudge{P}{\Local{x}{C}}{Q}$. Pick $y$ be a fresh variable such that $y\notin\Fv(P)\cup\Fv(Q)\cup\Fv(C)$, and let $P'=\prel{C[y/x]}{Q}$. We have $\dJudge{P'}{C[y/x]}{Q}$. By induction hypothesis, we have $\djudge{P'}{C[y/x]}{Q}$, so we can derive $\djudge{\Sup y.P'}{\Local{x}{C}}{\Sup y.Q}$ using \textsc{(\Bd:Local)}.\\
      Next, we will prove that $P\preceq\Sup y.P'$. For any $\sigma$ and $p$ satisfying $p\le P(\sigma)$, since $\dJudge{P}{\Local{x}{C}}{Q}$ holds, there exists a $\tau$ and a $q$ such that $q\le Q(\tau)$ and $\bigstepl{\Local{x}{C}}{\sigma}{p}{\tau}{q}$. From the semantics of $\Local{x}{C}$, there exists $\sigma',\tau',v$ such that $\sigma=\sigma'[x\mapsto v]$, $\tau=\tau'[x\mapsto v]$, and $\bigstepl{C}{\sigma'}{p}{\tau'}{q}$. Then we have $\bigstepl{C[y/x]}{\sigma''}{p}{\tau''}{q}$ by proposition \ref{prop:subst}, where $\sigma''=\sigma[y\mapsto\eval{x}{\sigma'}]$ and $\tau''=\tau[y\mapsto\eval{x}{\tau'}]$. Since $y$ is fresh, we have $Q(\tau'')=Q(\tau)$, then we have $p\le P'(\sigma'')$ from $\bigstepl{C[y/x]}{\sigma''}{p}{\tau''}{q}$. This implies that $p\le\Sup y.P'(\sigma)$, and consequently $P\preceq\Sup y.P'$.\\
      Finally, since $\Sup y.Q=Q$ by the freshness of $y$, we can derive $\djudge{P}{\Local{x}{C}}{Q}$ using \textsc{(\Bd:Cons)}.
  \end{itemize}
\end{proof}

%We introduce the following derived triples to simplify the presentation of our case studies.
%\begin{mathpar}
%  \ffjudge{P_S}{P_R}{C}{Q_S}{Q_R}\quad\text{iff}\quad\fjudge{[\neg P_S]\curlyvee P_R}{C}{[\neg Q_S]\curlyvee Q_R}
%  \hva\and
%  \bbjudge{P_S}{P_R}{C}{Q_S}{Q_R}\quad\text{iff}\quad\bjudge{[P_S]\curlywedge P_R}{C}{[Q_S]\curlywedge Q_R}
%%  \\
%%  \Blue{\SR{Spec}{Res}}\coloneqq[\neg Spec]\curlyvee Res
%%  \hva\and
%%  \Red{\SR{Spec}{Res}}\coloneqq[Spec]\curlywedge Res
%\end{mathpar}
%%
%\cref{fig:fullderived} shows the complete proof rules for the derived triples.
%
%\begin{figure}
%\begin{mathpar}
%  \inferrule[(Skip)]{}{\aajudge{P_S}{P_R}{\Skip}{P_S}{P_R}}
%  \hva\and
%  \inferrule[(Assign)]{x\notin\Fv(P_R)}{\aajudge{P_S}{P_R}{\Assign{x}{e}}{\exists x'.P_S[x'/x]\land x=e[x'/x]}{P_R}}
%  \hva\and
%  \inferrule[(Assume)]{}{\aajudge{P_S\land B}{P_R}{\Assume{B}}{P_S\land B}{P_R}}
%  \hva\and
%  \inferrule[(Tick)]{}{\aajudge{P_S}{P_R}{\Tick{e}}{P_S}{P_R-e}}
%  \hva\and
%  \inferrule[(Seq)]{\aajudge{P_S}{P_R}{C_1}{Q_S}{Q_R}\\\aajudge{R_S}{R_R}{C_2}{Q_S}{Q_R}}{\aajudge{P_S}{P_R}{\Seq{C_1}{C_2}}{Q_S}{Q_R}}
%  \hva\and
%  \inferrule[(IfTrue)]{\aajudge{P_S\land B}{P_R}{C_1}{Q_S}{Q_R}}{\aajudge{P_S}{P_R}{\Ite{B}{C_1}{C_2}}{Q_S}{Q_R}}
%  \hva\and
%  \inferrule[(IfFalse)]{\aajudge{P_S\land\neg B}{P_R}{C_2}{Q_S}{Q_R}}{\aajudge{P_S}{P_R}{\Ite{B}{C_1}{C_2}}{Q_S}{Q_R}}
%  \hva\and
%  \inferrule[(WhileFalse)]{}{\aajudge{P_S\land\neg B}{P_R}{\While{B}{C}}{P_S\land\neg B}{P_R}}
%  \hva\and
%  \inferrule[(WhileSubvar)]{\forall n<k-1.\aajudge{P_S(n)\land B}{P_R(n)}{C}{P_S(n+1)\land B}{P_R(n+1)} \\ \aajudge{P_S(k-1)\land B}{P_R(k-1)}{C}{P_S(k)\land\neg B]}{P_S(k)}}{\aajudge{P_S(0)\land B}{P_R(0)}{\While{B}{C}}{P_S(k)\land\neg B}{P_R(k)}}
%  \hva\and
%  \inferrule[(Local)]{\aajudge{P_S}{P_R}{C}{Q_S}{Q_R}\\x\notin\Fv(P_S)\cup\Fv(Q_S)}{\aajudge{\exists x.P_S}{P_R}{\Local{x}{C}}{\exists x.Q_S}{Q_R}}
%  \hva\and
%  \inferrule[(Disj)]{\forall i\in I.\aajudge{P_S(i)}{P_R}{C}{Q_S(i)}{Q_R}}{\aajudge{\bigvee_{i\in I}P_S(i)}{P_R}{C}{\bigvee_{i\in I}Q_S(i)}{Q_R}}
%  \hva\and
%  \inferrule[(Constancy)]{\aajudge{P_S}{P_R}{C}{Q_S}{Q_R}\\\Fv(B)\cap\Mod(C)=\emptyset}{\aajudge{P_S\land B}{P_R}{C}{Q_S\land B}{Q_R}}
%  \hva\and
%  \inferrule[(Relax)]{\aajudge{P_S}{P_R}{C}{Q_S}{Q_R}\\\Fv(F)\cap\Mod(C)=\emptyset}{\aajudge{P_S}{P_R+F}{C}{Q_S}{Q_R+F}}
%  \hva\and
%  \inferrule[(ConsF)]{P_S'\subseteq P_S\\\ffjudge{P_S'}{P_R}{C}{Q_S'}{Q_R}\\Q_S\subseteq Q_S'}{\ffjudge{P_S}{P_R}{C}{Q_S}{Q_R}}
%  \hva\and
%  \inferrule[(ConsB)]{P_S\subseteq P_S'\\\bbjudge{P_S'}{P_R}{C}{Q_S'}{Q_R}\\Q_S'\subseteq Q_S}{\bbjudge{P_S}{P_R}{C}{Q_S}{Q_R}}
%  \hva\and
%  \inferrule[(ConsRes)]{P_R\preceq P_R'\\\aajudge{P_S}{P_R'}{C}{Q_S}{Q_R'}\\Q_R'\preceq Q_R}{\aajudge{P_S}{P_R}{C}{Q_S}{Q_R}}
%  \hva\and
%  \inferrule[(Subst)]{\aajudge{P_S}{P_R}{C}{Q_S}{Q_R}\\y\notin\Fv(P_S)\cup\Fv(P_R)\cup\Fv(C)\cup\Fv(Q_S)\cup\Fv(Q_R)}{\aajudge{P_S[y/x]}{P_R[y/x]}{C[y/x]}{Q_S[y/x]}{Q_R[y/x]}}
%\end{mathpar}
%\caption{Derived Rules}
%\label{fig:fullderived}
%\end{figure}

%\input{example}

\end{document}
