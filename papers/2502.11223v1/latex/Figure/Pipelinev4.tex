% \documentclass[11pt]{article}
% \usepackage{tikz}
% \usetikzlibrary{positioning, shapes.multipart, fit, calc, shapes.geometric, shapes.misc}

% \begin{document}

\begin{figure*}[htbp]
\begingroup
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{backgrounds}
\usetikzlibrary{arrows.meta}
\definecolor{tiffanyblue}{RGB}{129,216,208}
\definecolor{bangdiblue}{RGB}{0,149,182}
\definecolor{kleinblue}{RGB}{0,47,167}
\definecolor{kabuliblue}{RGB}{26,85,153}
\definecolor{purple}{RGB}{138,43,226}

    \centering

      \tikzset{global scale/.style={
    scale=#1,
    every node/.append style={scale=#1}
  }
}


\begin{tikzpicture}[global scale=0.65]
    \newlength{\moduleintervaly}
    \setlength{\moduleintervaly}{1.8em}    
    \newlength{\moduleintervalx}
    \setlength{\moduleintervalx}{-7em}
    \newlength{\blockintervalx}
    \setlength{\blockintervalx}{30em}
    
    \tikzstyle{circlenode}=[draw, circle,minimum size=4pt,inner sep=0, fill=red!30];
    
    \tikzstyle{moduleode}=[draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small, scale=0.8];
    
    \tikzstyle{layernode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small,fill=yellow!20];
    
    \tikzstyle{attentionnode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{querynode}=[draw,minimum height=1.5em,minimum width=2em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{attnmapnode}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=10em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partialattnmapnode}=[fill=tiffanyblue!40,draw,minimum height=2.5em,minimum width=12em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partialattnmapnode1}=[fill=red!20,draw,minimum height=2.5em,minimum width=12em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{GRLattnmapnode}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=8em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{StandardFFNnode}=[fill=red!20,draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{Concatenode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{subspace_block}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=8em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partial_subspace_block}=[fill=red!20,draw,minimum height=2.5em,minimum width=11.0em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{global_partial_subspace_block}=[fill=pink!20,draw,minimum height=2.5em,minimum width=6.5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{space_block}=[fill=blue!20,draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small];
    
    \tikzstyle{Encoder_block}=[draw,minimum height=8.8*\moduleintervaly,minimum width=20em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{GRL_block}=[draw,minimum height=7em,minimum width=8.8*\moduleintervaly,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{Partial_Encoder_block}=[draw,minimum height=7.7*\moduleintervaly,minimum width=25em,inner sep=.0em,thick,rounded corners=.2em, font=\small];
    
    \tikzstyle{Graph_structure_learning}=[draw,minimum height=1.6em,minimum width=2.5em,inner sep=.0em,thick,rounded corners=.2em, font=\small,fill=orange!20];

    
    \tikzstyle{recnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];

    \tikzstyle{recnodewhite}=[rectangle,rounded corners=5pt,minimum height=2.2em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small];

    
    % added node
    % \tikzstyle{datanode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];
    \tikzstyle{datanode}=[cylinder,rounded corners=5pt,draw,minimum height=1.2em,minimum width=1.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];
    \tikzstyle{modelnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=green!20];
    \tikzstyle{tasknode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=blue!20];
    \tikzstyle{mergenode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=15.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=yellow!20];
    \tikzstyle{mergemodelnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=15.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=green!20];
    
    \tikzstyle{databanknode}=[rectangle,rounded corners=5pt,draw,minimum height=3.0em,minimum width=15.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!10];
    \tikzstyle{basemodel}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=17.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=green!18];
    \tikzstyle{loranode}=[rectangle,rounded corners=5pt,draw,minimum height=1.7em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=lime!20];
    \tikzstyle{longloranode}=[rectangle,rounded corners=5pt,draw,minimum height=1.7em,minimum width=13.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=lime!20];

    
    \tikzstyle{groupnode}=[cylinder,rounded corners=5pt,draw,minimum height=1.0em,minimum width=3.1em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];
    \def\nodehsep{3em}
    \def\nodewsep{3.5em}

    % First pic 1
    \begin{scope}[xshift=0in,yshift=0.0in]
        
        \node[datanode,anchor=south](data1_01) at (0, 2) {En-De};
        \node[datanode,anchor=south](data1_02) at ([yshift=-1.8\nodehsep]data1_01.south) {De-En};
        \node[datanode,anchor=west](data2_01) at ([xshift=\nodehsep]data1_01.east) {En-Zh};
        \node[datanode,anchor=west](data2_02) at ([xshift=\nodehsep]data1_02.east) {Zh-En};        
        \node[align=center,thick, scale=2] (omit1_01) at ([xshift=\nodehsep]data2_01.center) {...};
        \node[align=center,thick, scale=2] (omit1_02) at ([xshift=\nodehsep]data2_02.center) {...};
        \node[datanode,anchor=west](data3_01) at ([xshift=\nodehsep]data2_01.east) {En-Fr};
        \node[datanode,anchor=west](data3_02) at ([xshift=\nodehsep]data2_02.east) {Fr-En};


        \node[datanode,anchor=south](data1_11) at ([yshift=-2.5\nodehsep]data1_02.south) {En-De};
        \node[datanode,anchor=west](data2_11) at ([xshift=\nodehsep]data1_11.east) {Zh-En};
        \node[align=center,thick, scale=2] (omit2_1) at ([xshift=\nodehsep]data2_11.center) {...};
        \node[datanode,anchor=west](data3_11) at ([xshift=\nodehsep]data2_11.east) {En-Fr};
        

        \node[basemodel,anchor=north](basemodel) at ([xshift=0.1\nodehsep,yshift=-3.1\nodehsep]data2_11.north) {Base Model};
        \draw[->,thick] (data1_11.south) -- ([xshift=-6.7\nodehsep]basemodel.north);
        \draw[->,thick] (data2_11.south) -- ([xshift=-0.1\nodehsep]basemodel.north);
        \draw[->,thick] (data3_11.south) -- ([xshift=6.5\nodehsep]basemodel.north);
        
        \node[loranode,anchor=north](lora1) at ([yshift=-4.6\nodehsep]data1_11.south) {$\mathrm{LoRA}_1$};
        \node[loranode,anchor=north](lora2) at ([yshift=-4.6\nodehsep]data2_11.south) {$\mathrm{LoRA}_2$};
        \node[align=center,thick, scale=2] (omit2) at ([xshift=\nodehsep]lora2.center) {...};
        \node[loranode,anchor=north](lora3) at ([yshift=-4.6\nodehsep]data3_11.south) {$\mathrm{LoRA}_n$}; 
        
        \node(plus1) at ([yshift=0.6\nodehsep]lora1.north) {\textbf{\(+\)}};
        \node(plus2) at ([yshift=0.6\nodehsep]lora2.north) {\textbf{\(+\)}};
        \node(plus3) at ([yshift=0.6\nodehsep]lora3.north) {\textbf{\(+\)}};
         % \draw[+,thick] (basemodel.south) -- (model2.north);
        % \draw[->,thick] (data2.south) -- (model2.north);
        % \draw[->,thick] (data3.south) -- (model3.north);
        

        \node[tasknode,anchor=north](task1) at ([yshift=-1.5\nodehsep]lora1.south) {$\mathrm{Task}_1$};
        \node[tasknode,anchor=north](task2) at ([yshift=-1.5\nodehsep]lora2.south) {$\mathrm{Task}_2$};
        \node[align=center,thick, scale=2] (omit3) at ([xshift=\nodehsep]task2.center) {...};
        \node[tasknode,anchor=north](task3) at ([yshift=-1.5\nodehsep]lora3.south) {$\mathrm{Task}_n$}; 


        \draw[->,thick] (lora1.south) -- (task1.north);
        \draw[->,thick] (lora2.south) -- (task2.north);
        \draw[->,thick] (lora3.south) -- (task3.north);

        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=\nodehsep*5.6,minimum width=19.5em,fill=gray!4,rounded corners=5pt,dotted,draw](background) at ([yshift=-16.1em]data2_01.north) {};
            \node[anchor=south,minimum height=1.4*\nodehsep,minimum width=17.2em,fill=orange!8,rounded corners=5pt,draw](databank1) at ([yshift=-3.9em]data2_01.north) {};
        \end{pgfonlayer}
        
        \node[anchor=south,font=\Large](l1) at ([xshift=.5em,yshift=-3em]background.south) {(a) Separate Training};
    \end{scope}

    % second pic
    \begin{scope}[xshift=3.5in,yshift=0.0in]
        \node[datanode,anchor=south](data1_01b) at (0, 2) {En-De};
        \node[datanode,anchor=south](data1_02b) at ([yshift=-1.8\nodehsep]data1_01b.south) {De-En};
        \node[datanode,anchor=west](data2_01b) at ([xshift=\nodehsep]data1_01b.east) {En-Zh};
        \node[datanode,anchor=west](data2_02b) at ([xshift=\nodehsep]data1_02b.east) {Zh-En};        
        \node[align=center,thick, scale=2] (omit1_01b) at ([xshift=\nodehsep]data2_01b.center) {...};
        \node[align=center,thick, scale=2] (omit1_02b) at ([xshift=\nodehsep]data2_02b.center) {...};
        \node[datanode,anchor=west](data3_01b) at ([xshift=\nodehsep]data2_01b.east) {En-Fr};
        \node[datanode,anchor=west](data3_02b) at ([xshift=\nodehsep]data2_02b.east) {Fr-En};
        
        \node[mergenode,anchor=north](datamixture) at ([xshift=0.1\nodehsep,yshift=-1.1\nodehsep]data2_02b.south) {Data Mixture};
       
        
        \node[basemodel,anchor=north](basemodel2) at ([yshift=-3.1\nodehsep]datamixture.north) {Base Model};
        \draw[->,thick] (datamixture.south) -- (basemodel2.north);

        
       \node[longloranode,anchor=north](lora2b) at ([yshift=-7.1\nodehsep]data2_02b.south) {$\mathrm{LoRA}$};
        \node(plus2b) at ([yshift=0.5\nodehsep]lora2b.north) {\textbf{\(+\)}};
        

        \node[tasknode,anchor=north](task1b) at ([yshift=-10.5\nodehsep]data1_02b.south) {$\mathrm{Task}_1$};
        \node[tasknode,anchor=north](task2b) at ([yshift=-10.5\nodehsep]data2_02b.south) {$\mathrm{Task}_2$};
        \node[align=center,thick, scale=2] (omit3) at ([xshift=\nodehsep]task2b.center) {...};
        \node[tasknode,anchor=north](task3b) at ([yshift=-10.5\nodehsep]data3_02b.south) {$\mathrm{Task}_n$}; 


        \draw[->,thick] ([xshift=-6.0\nodehsep]lora2b.south) -- (task1b.north);
        \draw[->,thick] (lora2b.south) -- (task2b.north);
        \draw[->,thick] ([xshift=6.0\nodehsep]lora2b.south) -- (task3b.north);

        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=\nodehsep*5.6,minimum width=19.5em,fill=gray!4,rounded corners=5pt,dotted,draw](backgroundb) at ([yshift=-16.1em]data2_01b.north) {};
            \node[anchor=south,minimum height=1.4*\nodehsep,minimum width=17.2em,fill=orange!8,rounded corners=5pt,draw](databank2) at ([yshift=-3.9em]data2_01b.north) {};
        \end{pgfonlayer}
         \draw[thick, -{Latex[round]}] (databank2.south) -- ([xshift=-0.12em]datamixture.north);
         
        \node[anchor=south,font=\Large](l2) at ([xshift=.5em,yshift=-3em]backgroundb.south) {(b) Multilingual};
    \end{scope}

    % picture c
    \begin{scope}[xshift=7.0in,yshift=-0.2in]
        \node[groupnode,anchor=south](group1) at (0, 2) {$\mathrm{Group}_1$};
        \node[groupnode,anchor=west](group2) at ([xshift=1.0\nodehsep]group1.east) {$\mathrm{Group}_2$};
        \node[align=center,thick, scale=2] (omitc) at ([xshift=1.06*\nodehsep]group2.center) {...};
        \node[groupnode,anchor=west](group3) at ([xshift=1.6\nodehsep]group2.east) {$\mathrm{Group}_n$};


        \node[mergenode,anchor=north](dataselectionc) at ([xshift=0.1\nodehsep,yshift=-1.1\nodehsep]group2.south) {Data Selection};
        
        \node[basemodel,anchor=north](basemodelc) at ([yshift=-3.1\nodehsep]dataselectionc.north) {Base Model};
        \draw[->,thick] (dataselectionc.south) -- (basemodelc.north);
        
        \node[loranode,anchor=north](lora1c) at ([yshift=-7.2\nodehsep]group1.south) {$\mathrm{LoRA}_{G1}$};
        \node[loranode,anchor=north](lora2c) at ([yshift=-7.2\nodehsep]group2.south) {$\mathrm{LoRA}_{G2}$};
        \node[align=center,thick, scale=2] (omit2) at ([xshift=\nodehsep]lora2c.center) {...};
        \node[loranode,anchor=north](lora3c) at ([yshift=-7.2\nodehsep]group3.south) {$\mathrm{LoRA}_{Gn}$}; 
        
        \node(plus1c) at ([yshift=0.6\nodehsep]lora1c.north) {\textbf{\(+\)}};
        \node(plus2c) at ([yshift=0.6\nodehsep]lora2c.north) {\textbf{\(+\)}};
        \node(plus3c) at ([yshift=0.6\nodehsep]lora3c.north) {\textbf{\(+\)}};
         % \draw[+,thick] (basemodel.south) -- (model2.north);
        % \draw[->,thick] (data2.south) -- (model2.north);
        % \draw[->,thick] (data3.south) -- (model3.north);
        

        \node[tasknode,anchor=north](task1c) at ([yshift=-1.5\nodehsep]lora1c.south) {$\mathrm{Task}_{G1}$};
        \node[tasknode,anchor=north](task2c) at ([yshift=-1.5\nodehsep]lora2c.south) {$\mathrm{Task}_{G2}$};
        \node[align=center,thick, scale=2] (omit3c) at ([xshift=\nodehsep]task2c.center) {...};
        \node[tasknode,anchor=north](task3c) at ([yshift=-1.5\nodehsep]lora3c.south) {$\mathrm{Task}_{Gn}$}; 


        \draw[->,thick] (lora1c.south) -- (task1c.north);
        \draw[->,thick] (lora2c.south) -- (task2c.north);
        \draw[->,thick] (lora3c.south) -- (task3c.north);

        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=\nodehsep*5.6,minimum width=19.5em,fill=gray!4,rounded corners=5pt,dotted,draw](backgroundc) at ([yshift=-16.1em]group2.north) {};
            \node[anchor=south,minimum height=1.4*\nodehsep,minimum width=17.2em,fill=orange!8,rounded corners=5pt,draw](databankc) at ([yshift=-3.8em]group2.north) {};
        \end{pgfonlayer}
        
         \draw[thick, -{Latex[round]}] (databankc.south) -- ([xshift=-0.12em]dataselectionc.north);
        \node[anchor=south,font=\Large](l3) at ([xshift=.5em,yshift=-3em]backgroundc.south) {(c) Group Training};
    \end{scope}
    
\end{tikzpicture}
    
    
    \caption{(a) Seperate Training. (b) Multilingual. (c) Group Training (d) Model Merging }
    \label{fig:architecture}
    \vspace{-1em}
% \end{figure*}
\endgroup

\label{fig:comparison-merge}
\end{figure*}

% \end{document}
