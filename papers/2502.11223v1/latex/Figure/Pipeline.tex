% \documentclass[11pt]{article}
% \usepackage{tikz}
% \usetikzlibrary{positioning, shapes.multipart, fit, calc, shapes.geometric, shapes.misc}

% \begin{document}

\begin{figure*}[htbp]

\begingroup
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{backgrounds}
\definecolor{tiffanyblue}{RGB}{129,216,208}
\definecolor{bangdiblue}{RGB}{0,149,182}
\definecolor{kleinblue}{RGB}{0,47,167}
\definecolor{kabuliblue}{RGB}{26,85,153}
\definecolor{purple}{RGB}{138,43,226}

    \centering

      \tikzset{global scale/.style={
    scale=#1,
    every node/.append style={scale=#1}
  }
}


\begin{tikzpicture}[global scale=0.64]
    \newlength{\moduleintervaly}
    \setlength{\moduleintervaly}{1.8em}    
    \newlength{\moduleintervalx}
    \setlength{\moduleintervalx}{-7em}
    \newlength{\blockintervalx}
    \setlength{\blockintervalx}{30em}
    
    \tikzstyle{circlenode}=[draw, circle,minimum size=4pt,inner sep=0, fill=red!30];
    
    \tikzstyle{moduleode}=[draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small, scale=0.8];
    
    \tikzstyle{layernode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small,fill=yellow!20];
    
    \tikzstyle{attentionnode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{querynode}=[draw,minimum height=1.5em,minimum width=2em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{attnmapnode}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=10em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partialattnmapnode}=[fill=tiffanyblue!40,draw,minimum height=2.5em,minimum width=12em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partialattnmapnode1}=[fill=red!20,draw,minimum height=2.5em,minimum width=12em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{GRLattnmapnode}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=8em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{StandardFFNnode}=[fill=red!20,draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{Concatenode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{subspace_block}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=8em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partial_subspace_block}=[fill=red!20,draw,minimum height=2.5em,minimum width=11.0em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{global_partial_subspace_block}=[fill=pink!20,draw,minimum height=2.5em,minimum width=6.5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{space_block}=[fill=blue!20,draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small];
    
    \tikzstyle{Encoder_block}=[draw,minimum height=8.8*\moduleintervaly,minimum width=20em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{GRL_block}=[draw,minimum height=7em,minimum width=8.8*\moduleintervaly,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{Partial_Encoder_block}=[draw,minimum height=7.7*\moduleintervaly,minimum width=25em,inner sep=.0em,thick,rounded corners=.2em, font=\small];
    
    \tikzstyle{Graph_structure_learning}=[draw,minimum height=1.6em,minimum width=2.5em,inner sep=.0em,thick,rounded corners=.2em, font=\small,fill=orange!20];

    
    \tikzstyle{recnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];

    \tikzstyle{recnodewhite}=[rectangle,rounded corners=5pt,minimum height=2.2em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small];

    
    % added node
    % \tikzstyle{datanode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];
    \tikzstyle{datanode}=[cylinder,rounded corners=5pt,draw,minimum height=1.2em,minimum width=1.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];
    \tikzstyle{modelnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=green!20];
    \tikzstyle{tasknode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=blue!20];
    \tikzstyle{mergenode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=15.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=yellow!20];
    \tikzstyle{mergemodelnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=15.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=green!20];
    
    \tikzstyle{databanknode}=[rectangle,rounded corners=5pt,draw,minimum height=3.0em,minimum width=15.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!10];
    \tikzstyle{basemodel}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=17.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=green!18];
    \tikzstyle{loranode}=[rectangle,rounded corners=5pt,draw,minimum height=1.7em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=lime!20];
    \tikzstyle{longloranode}=[rectangle,rounded corners=5pt,draw,minimum height=1.7em,minimum width=13.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=lime!20];

    \tikzstyle{groupnode}=[cylinder,rounded corners=5pt,draw,minimum height=1.0em,minimum width=3.1em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];

     \tikzstyle{longdatabanknode}=[cylinder,rounded corners=5pt,draw,minimum height=10.0em,minimum width=1.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!13];
    \def\nodehsep{3em}
    \def\nodewsep{3.5em}


    % picture a
    \begin{scope}[xshift=0.0in,yshift=0.0in]
        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=\nodehsep*5.7,minimum width=19.5em,fill=gray!4,rounded corners=5pt,dotted,draw](backgroundc) at (0, 0) {};
            % \node[anchor=south,minimum height=\nodehsep*6.5,minimum width=39.6em,fill=gray!4,rounded corners=5pt,dotted,draw](backgroundd) at (0,0) {};
        \end{pgfonlayer}

        \node[datanode,anchor=south](data1_01) at ([xshift=-2.2*\nodehsep, yshift=14.8em]backgroundc.south) {En-De};
        \node[datanode,anchor=south](data1_02) at ([yshift=-1.8\nodehsep]data1_01.south) {De-En};
        
        \node[datanode,anchor=west](data2_01) at ([xshift=\nodehsep]data1_01.east) {En-Zh};
        \node[datanode,anchor=west](data2_02) at ([xshift=\nodehsep]data1_02.east) {Zh-En};        
        
        \node[align=center,thick, scale=2] (omit1_01) at ([xshift=\nodehsep]data2_01.center) {...};
        \node[align=center,thick, scale=2] (omit1_02) at ([xshift=\nodehsep]data2_02.center) {...};
        
        \node[datanode,anchor=west](data3_01) at ([xshift=\nodehsep]data2_01.east) {En-Fr};
        \node[datanode,anchor=west](data3_02) at ([xshift=\nodehsep]data2_02.east) {Fr-En};

        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=1.4*\nodehsep,minimum width=17.2em,fill=orange!8,rounded corners=5pt,draw](databank1) at ([yshift=-3.9em]data2_01.north) {};
        \end{pgfonlayer}
        

        \node[mergenode,anchor=north](dataselectionc) at ([xshift=0.1\nodehsep,yshift=-1.6\nodehsep]data2_02.south) {Data Selection};
        \draw[thick, ->] (databank1.south) -- ([xshift=-0.12em]dataselectionc.north);
        % \draw[thick, ->] (databank1.south) -- ([xshift=-0.12em]dataselectionc.north);
        % \draw[thick, ->] (databank1.south) -- ([xshift=-0.12em]dataselectionc.north);
        
        \node[basemodel,anchor=north](basemodelc) at ([yshift=-3.1\nodehsep]dataselectionc.north) {Base Model};
        \draw[->,thick] (dataselectionc.south) -- (basemodelc.north);
        
        \node[loranode,anchor=north](lora1c) at ([yshift=-7.8\nodehsep]data1_02.south) {$\mathrm{LoRA}_{1}$};
        \node[loranode,anchor=north](lora2c) at ([yshift=-7.8\nodehsep]data2_02.south) {$\mathrm{LoRA}_{2}$};
        \node[align=center,thick, scale=2] (omit2) at ([xshift=\nodehsep]lora2c.center) {...};
        \node[loranode,anchor=north](lora3c) at ([yshift=-7.8\nodehsep]data3_02.south) {$\mathrm{LoRA}_{N}$}; 
        
        \node(plus1c) at ([yshift=0.6\nodehsep]lora1c.north) {\textbf{\(+\)}};
        \node(plus2c) at ([yshift=0.6\nodehsep]lora2c.north) {\textbf{\(+\)}};
        \node(plus3c) at ([yshift=0.6\nodehsep]lora3c.north) {\textbf{\(+\)}};
        

        \node[tasknode,anchor=north](task1c) at ([yshift=-1.2\nodehsep]lora1c.south) {$\mathrm{Task}_{1}$};
        \node[tasknode,anchor=north](task2c) at ([yshift=-1.2\nodehsep]lora2c.south) {$\mathrm{Task}_{2}$};
        \node[align=center,thick, scale=2] (omit3c) at ([xshift=\nodehsep]task2c.center) {...};
        \node[tasknode,anchor=north](task3c) at ([yshift=-1.2\nodehsep]lora3c.south) {$\mathrm{Task}_{N}$}; 


        \draw[->,thick] (lora1c.south) -- (task1c.north);
        \draw[->,thick] (lora2c.south) -- (task2c.north);
        \draw[->,thick] (lora3c.south) -- (task3c.north);

         
        \node[anchor=south,font=\Large](l3) at ([xshift=0.3em,yshift=-3em]backgroundc.south) {(a) Seperate/Multilingual/Group Training};
        % \node[anchor=north,font=\Large](l3) at ([xshift=0.3em,yshift=-1em]backgroundc.south) {\parbox{6cm}{\centering (a) Separate/Multilingual/ \\ Group Training}};
        % \node[anchor=south,font=\Large](l4) at ([xshift=.5em,yshift=-3em]backgroundd.south) {(d) Model Merging};
    \end{scope}

    % picture b
     \begin{scope}[xshift=4.9in,yshift=0in]
        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=\nodehsep*5.7,minimum width=39.6em,fill=gray!4,rounded corners=5pt,dotted,draw](backgroundd) at (0,0) {};
        \end{pgfonlayer}

        \node[datanode,anchor=south](data11d) at ([xshift=-2.2*\nodehsep, yshift=14.8em]backgroundd.south) {En-De};
        \node[datanode,anchor=south](data12d) at ([yshift=-1.8\nodehsep]data11d.south) {De-En};
        
        \node[datanode,anchor=west](data21d) at ([xshift=\nodehsep]data11d.east) {En-Zh};
        \node[datanode,anchor=west](data22d) at ([xshift=\nodehsep]data12d.east) {Zh-En};        
        
        \node[align=center,thick, scale=2] (omit11d) at ([xshift=\nodehsep]data21d.center) {...};
        \node[align=center,thick, scale=2] (omit12d) at ([xshift=\nodehsep]data22d.center) {...};
        
        \node[datanode,anchor=west](data31d) at ([xshift=\nodehsep]data21d.east) {En-Fr};
        \node[datanode,anchor=west](data32d) at ([xshift=\nodehsep]data22d.east) {Fr-En};

        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=1.4*\nodehsep,minimum width=17.2em,fill=orange!8,rounded corners=5pt,draw](databank1d) at ([yshift=-3.9em]data21d.north) {};
        \end{pgfonlayer}

        \node[mergenode,anchor=north](dataselectiond) at ([xshift=-3.5*\nodehsep,yshift=-0.2*\nodehsep]databank1d.south) {Group Selection};
        
        \node[basemodel,anchor=north](basemodeldleft) at ([yshift=-0.7\nodehsep]dataselectiond.south) {Base Model};
        \draw[->,thick] (dataselectiond.south) -- (basemodeldleft.north);

        \node[loranode,anchor=north](lora1dleft) at ([xshift=-5.5\nodehsep, yshift=-1.6\nodehsep]basemodeldleft.south) {$\mathrm{LoRA}_{1}$};
        \node[loranode,anchor=north](lora2dleft) at ([yshift=-1.6\nodehsep]basemodeldleft.south) {$\mathrm{LoRA}_{2}$};
        \node[align=center,thick, scale=2] (omit2d) at ([xshift=0.9*\nodehsep]lora2dleft.center) {...};
        \node[loranode,anchor=north](lora3dleft) at ([xshift=5.5\nodehsep,yshift=-1.6\nodehsep]basemodeldleft.south) {$\mathrm{LoRA}_{N_G}$}; 

        \node(plus1dleft) at ([yshift=0.72\nodehsep]lora1dleft.north) {\textbf{\(+\)}};
        \node(plus2dleft) at ([yshift=0.72\nodehsep]lora2dleft.north) {\textbf{\(+\)}};
        \node(plus3dleft) at ([yshift=0.72\nodehsep]lora3dleft.north) {\textbf{\(+\)}};
        
         \node[tasknode,anchor=north](task1dleft) at ([yshift=-1.6\nodehsep]lora1dleft.south) {$\mathrm{Task}_{1}^{\mathrm{enxx}}$};
        \node[tasknode,anchor=north](task2dleft) at ([yshift=-1.6\nodehsep]lora2dleft.south) {$\mathrm{Task}_{2}^{\mathrm{enxx}}$};
        \node[align=center,thick, scale=2] (omit3dleft) at ([xshift=0.9*\nodehsep]task2dleft.center) {...};
        \node[tasknode,anchor=north](task3dleft) at ([yshift=-1.6\nodehsep]lora3dleft.south) {$\mathrm{Task}_{N_G}^{\mathrm{enxx}}$}; 

        \draw[->,thick] (lora1dleft.south) -- (task1dleft.north);
        \draw[->,thick] (lora2dleft.south) -- (task2dleft.north);
        \draw[->,thick] (lora3dleft.south) -- (task3dleft.north);

        \begin{pgfonlayer}{background}
            % \node[anchor=north,minimum height=0.9*\nodehsep,minimum width=17.2em,fill=orange!8,rounded corners=5pt,draw](databankd2) at ([xshift=0.5em,yshift=-0.9em]dataxxen.south) {};
            \node[anchor=south,minimum height=1.9*\nodehsep,minimum width=18.2em,fill=green!8,rounded corners=5pt,draw,dotted,thick](modelmerge) at ([xshift=9.5em,yshift=-6.2em]databank1d.south) {};
        \end{pgfonlayer}

        \node[basemodel,anchor=north](basemodeldright) at ([yshift=1.8*\nodehsep]modelmerge.south) {Base Model};

        
        \node[loranode,anchor=north](lora2dright) at ([yshift=-1.3\nodehsep]basemodeldright.south) {$\mathrm{LoRA}_{2}$};
        \node[loranode,anchor=west](lora1dright) at ([xshift=-6.6\nodehsep]lora2dright.west) {$\mathrm{LoRA}_{1}$};
        \node[align=center,thick, scale=2] (omit2dright) at ([xshift=\nodehsep]lora2dright.center) {...};
        \node[loranode,anchor=east](lora3dright) at ([xshift=6.6\nodehsep]lora2dright.east) {$\mathrm{LoRA}_{N_L}$}; 
        
        \node(plus1dright) at ([yshift=0.6\nodehsep]lora1dright.north) {\textbf{\(+\)}};
        \node(plus2dright) at ([yshift=0.6\nodehsep]lora2dright.north) {\textbf{\(+\)}};
        \node(plus3dright) at ([yshift=0.6\nodehsep]lora3dright.north) {\textbf{\(+\)}};


        \node[mergemodelnode,anchor=north](mergedmodel) at ([yshift=-1.4\nodehsep]lora2dright.south) {Group-wise Merged Model};
        \draw[thick, ->] (modelmerge.south) -- (mergedmodel.north);
        
        \node[tasknode,anchor=north](task1dright) at ([yshift=-4.3\nodehsep]lora1dright.south) {$\mathrm{Task}_1^{\mathrm{xxen}}$};
        \node[tasknode,anchor=north](task2dright) at ([yshift=-4.3\nodehsep]lora2dright.south) {$\mathrm{Task}_2^{\mathrm{xxen}}$};
        \node[align=center,thick, scale=2] (omit3dright) at ([xshift=1.1*\nodehsep]task2dright.center) {...};
        \node[tasknode,anchor=north](task3dright) at ([yshift=-4.3\nodehsep]lora3dright.south) {$\mathrm{Task}_{N_G}^{\mathrm{xxen}}$}; 

        \draw[->,thick] ([xshift=-5.0\nodehsep]mergedmodel.south) -- (task1dright.north);
        \draw[->,thick] (mergedmodel.south) -- (task2dright.north);
        \draw[->,thick] ([xshift=6.0\nodehsep]mergedmodel.south) -- (task3dright.north);

        \draw[->,thick] (databank1d.west) -- (dataselectiond.north) node[midway, left] {En$\rightarrow$XX};
        \draw[->,thick] (databank1d.east) -- ([xshift=0.1*\nodehsep]modelmerge.north) node[midway, right] {XX$\rightarrow$En};

        
        \node[anchor=south,font=\Large](l4) at ([xshift=.5em,yshift=-3em]backgroundd.south) {(b) Direction-aware Training with Group-wise Model Merging};
        
    \end{scope}

    
\end{tikzpicture}
    
    % \vspace{-1em}
    \vspace{-0.5em}
    % \caption{(a) Seperate/Multilingual/Group multilingual training; In seperate  (b) Group-wise model merging}
    \caption{(a)  \textbf{Separate Training ($N$ = $N_L$)}: Each translation task is trained independently using different datasets for different language pairs, with distinct LoRA model weights fine-tuned separately;
    \textbf{Multilingual Training ($N$ = $1$)}: All language pairs are combined to fine-tune a single model with shared LoRA weights;
    \textbf{Group Multilingual Training ($N$ = $N_G$)}: Language pairs are grouped as specified in Table \ref{tab:languages1}-\ref{tab:languages2}, with an adapter trained for each group.
    (b) \textbf{Group-wise model merging}: For XX$\rightarrow$En translation, separate training is applied to each language pair. For En$\rightarrow$XX translation, group training is applied, where different tasks share LoRA weights within language groups.}
    \label{fig:architecture}
    \vspace{-1.1em}
% \end{figure*}
\endgroup

\label{fig:comparison-merge}
\end{figure*}

% \end{document}
