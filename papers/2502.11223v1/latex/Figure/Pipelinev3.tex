% \documentclass[11pt]{article}
% \usepackage{tikz}
% \usetikzlibrary{positioning, shapes.multipart, fit, calc, shapes.geometric, shapes.misc}

% \begin{document}

\begin{figure*}[htbp]

\begingroup
\usetikzlibrary{shapes.geometric}
\usetikzlibrary{backgrounds}
\usetikzlibrary{arrows.meta}
\definecolor{tiffanyblue}{RGB}{129,216,208}
\definecolor{bangdiblue}{RGB}{0,149,182}
\definecolor{kleinblue}{RGB}{0,47,167}
\definecolor{kabuliblue}{RGB}{26,85,153}
\definecolor{purple}{RGB}{138,43,226}

% \begin{figure}[ht!]
    \centering

      \tikzset{global scale/.style={
    scale=#1,
    every node/.append style={scale=#1}
  }
}


\begin{tikzpicture}[global scale=0.69]
    \newlength{\moduleintervaly}
    \setlength{\moduleintervaly}{1.8em}    
    \newlength{\moduleintervalx}
    \setlength{\moduleintervalx}{-7em}
    \newlength{\blockintervalx}
    \setlength{\blockintervalx}{30em}
    
    
    
    \tikzstyle{circlenode}=[draw, circle,minimum size=4pt,inner sep=0, fill=red!30];
    
    \tikzstyle{moduleode}=[draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small, scale=0.8];
    
    \tikzstyle{layernode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small,fill=yellow!20];
    
    \tikzstyle{attentionnode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{querynode}=[draw,minimum height=1.5em,minimum width=2em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{attnmapnode}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=10em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partialattnmapnode}=[fill=tiffanyblue!40,draw,minimum height=2.5em,minimum width=12em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partialattnmapnode1}=[fill=red!20,draw,minimum height=2.5em,minimum width=12em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{GRLattnmapnode}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=8em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{StandardFFNnode}=[fill=red!20,draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{Concatenode}=[draw,minimum height=1.5em,minimum width=5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{subspace_block}=[fill=yellow!20,draw,minimum height=2.5em,minimum width=8em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{partial_subspace_block}=[fill=red!20,draw,minimum height=2.5em,minimum width=11.0em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{global_partial_subspace_block}=[fill=pink!20,draw,minimum height=2.5em,minimum width=6.5em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{space_block}=[fill=blue!20,draw,minimum height=2.5em,minimum width=23em,inner sep=.0em,thick,rounded corners=.2em, font=\small];
    
    \tikzstyle{Encoder_block}=[draw,minimum height=8.8*\moduleintervaly,minimum width=20em,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{GRL_block}=[draw,minimum height=7em,minimum width=8.8*\moduleintervaly,inner sep=.0em,thick,rounded corners=.2em, font=\small];

    \tikzstyle{Partial_Encoder_block}=[draw,minimum height=7.7*\moduleintervaly,minimum width=25em,inner sep=.0em,thick,rounded corners=.2em, font=\small];
    
    \tikzstyle{Graph_structure_learning}=[draw,minimum height=1.6em,minimum width=2.5em,inner sep=.0em,thick,rounded corners=.2em, font=\small,fill=orange!20];

    
    \tikzstyle{recnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];

    \tikzstyle{recnodewhite}=[rectangle,rounded corners=5pt,minimum height=2.2em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small];

    % added node
    % \tikzstyle{datanode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];
    \tikzstyle{datanode}=[cylinder,rounded corners=5pt,draw,minimum height=1.2em,minimum width=1.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=orange!20];
    \tikzstyle{modelnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=green!20];
    \tikzstyle{tasknode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=3.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=blue!20];
    \tikzstyle{mergenode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=15.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=yellow!20];
    \tikzstyle{mergemodelnode}=[rectangle,rounded corners=5pt,draw,minimum height=1.8em,minimum width=15.5em,inner sep=0em,thick,rounded corners=0.2em,font=\small,fill=green!20];
    
    \def\nodehsep{3em}
    \def\nodewsep{3.5em}

    % Firstpic
    \begin{scope}[]
        \node[datanode,anchor=south](data1) at (0, 2) {En-De};
        \node[datanode,anchor=west](data2) at ([xshift=\nodehsep]data1.east) {Zh-En};
        \node[align=center,thick, scale=2] (omit) at ([xshift=\nodehsep]data2.center) {...};
        \node[datanode,anchor=west](data3) at ([xshift=\nodehsep]data2.east) {En-Fr};
        
        \node[modelnode,anchor=north](model1) at ([yshift=-4.0\nodehsep]data1.south) {$\mathrm{Model}_1$};
        \node[modelnode,anchor=north](model2) at ([yshift=-4.0\nodehsep]data2.south) {$\mathrm{Model}_2$};
        \node[align=center,thick, scale=2] (omit2) at ([xshift=\nodehsep]model2.center) {...};
        \node[modelnode,anchor=north](model3) at ([yshift=-4.0\nodehsep]data3.south) {$\mathrm{Model}_3$}; 
        
        \draw[->,thick] (data1.south) -- (model1.north);
        \draw[->,thick] (data2.south) -- (model2.north);
        \draw[->,thick] (data3.south) -- (model3.north);


        \node[tasknode,anchor=north](task1) at ([yshift=-4.0\nodehsep]model1.south) {$\mathrm{Task}_1$};
        \node[tasknode,anchor=north](task2) at ([yshift=-4.0\nodehsep]model2.south) {$\mathrm{Task}_2$};
        \node[align=center,thick, scale=2] (omit3) at ([xshift=\nodehsep]task2.center) {...};
        \node[tasknode,anchor=north](task3) at ([yshift=-4.0\nodehsep]model3.south) {$\mathrm{Task}_3$}; 


        \draw[->,thick] (model1.south) -- (task1.north);
        \draw[->,thick] (model2.south) -- (task2.north);
        \draw[->,thick] (model3.south) -- (task3.north);

        \begin{pgfonlayer}{background}
            % \node[anchor=south,minimum height=\nodehsep*4.9,minimum width=19.5em,fill=black!4,rounded corners=5pt,dotted,draw](b1) at ([yshift=-2.3em]task2.north) {};
            \node[anchor=south,minimum height=\nodehsep*4.9,minimum width=19.5em,fill=black!4,rounded corners=5pt,dotted,draw](b2) at ([yshift=-14.3em]data2.north) {};
        \end{pgfonlayer}
        
        \node[anchor=south,font=\Large](l1) at ([xshift=.5em,yshift=-3em]task2.south) {(a) Separate Training};
    \end{scope}


    % second pic2
    \begin{scope}[xshift=4.2in,yshift=0.0in]
        \node[datanode,anchor=south](data2_1) at (0, 2) {En-De};
        \node[datanode,anchor=west](data2_2) at ([xshift=\nodehsep]data2_1.east) {Zh-En};
        \node[align=center,thick, scale=2] (omit2_1) at ([xshift=\nodehsep]data2_2.center) {...};
        \node[datanode,anchor=west](data2_3) at ([xshift=\nodehsep]data2_2.east) {En-Fr};
        
        \node[mergenode,anchor=north](dataselection) at ([xshift=0.1\nodehsep,yshift=-1.1\nodehsep]data2_2.south) {Data Selection};

        \draw[->,thick] (data2_1.south) -- ([xshift=-6.7\nodehsep]dataselection.north);
        % \draw[->,thick] (data2_1.south) |-  (dataselection.north);
        \draw[->,thick] (data2_2.south) -- (dataselection.north);
        \draw[->,thick] (data2_3.south) -- ([xshift=6.4\nodehsep]dataselection.north);
        
        \node[modelnode,anchor=north](model2_1) at ([yshift=-4.0\nodehsep]data2_1.south) {$\mathrm{Model}_1$};
        \node[modelnode,anchor=north](model2_2) at ([yshift=-4.0\nodehsep]data2_2.south) {$\mathrm{Model}_2$};
        \node[align=center,thick, scale=2] (omit2_2) at ([xshift=\nodehsep]model2_2.center) {...};
        \node[modelnode,anchor=north](model2_3) at ([yshift=-4.0\nodehsep]data2_3.south) {$\mathrm{Model}_3$}; 
        
        \draw[->,thick] ([xshift=-6.0\nodehsep]dataselection.south)  --  (model2_1.north);
        \draw[->,thick] (dataselection.south)  --  (model2_2.north);
        \draw[->,thick] ([xshift=6.0\nodehsep]dataselection.south)  --  (model2_3.north);
        
        \node[mergenode,anchor=north](mixtureofexpert) at ([xshift=0.1\nodehsep,yshift=-1.1\nodehsep]model2_2.south) {Mixture of Experts (MoE)};

        \draw[->,thick] (model2_1.south) -- ([xshift=-5.7\nodehsep]mixtureofexpert.north);
        \draw[->,thick] (model2_2.south) -- (mixtureofexpert.north);
        \draw[->,thick] (model2_3.south) -- ([xshift=5.7\nodehsep]mixtureofexpert.north);
        
        \node[tasknode,anchor=north](task2_1) at ([yshift=-4.0\nodehsep]model2_1.south) {$\mathrm{Task}_1$};
        \node[tasknode,anchor=north](task2_2) at ([yshift=-4.0\nodehsep]model2_2.south) {$\mathrm{Task}_2$};
        \node[align=center,thick, scale=2] (omit3) at ([xshift=\nodehsep]task2_2.center) {...};
        \node[tasknode,anchor=north](task2_3) at ([yshift=-4.0\nodehsep]model2_3.south) {$\mathrm{Task}_3$}; 

        \draw[->,thick] ([xshift=-6.0\nodehsep]mixtureofexpert.south)  --  (task2_1.north);
        \draw[->,thick] (mixtureofexpert.south)  --  (task2_2.north);
        \draw[->,thick] ([xshift=6.0\nodehsep]mixtureofexpert.south)  --  (task2_3.north);


        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=\nodehsep*4.9,minimum width=19.5em,fill=black!4,rounded corners=5pt,dotted,draw](b2) at ([yshift=-14.3em]data2_2.north) {};
        \end{pgfonlayer}
        
        \node[anchor=south,font=\Large](l2) at ([xshift=.5em,yshift=-3em]task2_2.south) {(b) Mixture of Experts};
    \end{scope}

    % pic c
    \begin{scope}[xshift=0in,yshift=-2.6in]
        \node[datanode,anchor=south](data3_1) at (0, 2) {En-De};
        \node[datanode,anchor=west](data3_2) at ([xshift=\nodehsep]data3_1.east) {Zh-En};
        \node[align=center,thick, scale=2] (omit2_1) at ([xshift=\nodehsep]data3_2.center) {...};
        \node[datanode,anchor=west](data3_3) at ([xshift=\nodehsep]data3_2.east) {En-Fr};
        
        \node[mergenode,anchor=north](dataselection3) at ([xshift=0.1\nodehsep,yshift=-1.1\nodehsep]data3_2.south) {Group Selection};

        \draw[->,thick] (data3_1.south) -- ([xshift=-6.7\nodehsep]dataselection3.north);
        % \draw[->,thick] (data2_1.south) |-  (dataselection.north);
        \draw[->,thick] (data3_2.south) -- (dataselection3.north);
        \draw[->,thick] (data3_3.south) -- ([xshift=6.4\nodehsep]dataselection3.north);
        
        \node[modelnode,anchor=north](model3_1) at ([yshift=-4.0\nodehsep]data3_1.south) {$\mathrm{Model}_1$};
        \node[modelnode,anchor=north](model3_2) at ([yshift=-4.0\nodehsep]data3_2.south) {$\mathrm{Model}_2$};
        \node[align=center,thick, scale=2] (omit3_2) at ([xshift=\nodehsep]model3_2.center) {...};
        \node[modelnode,anchor=north](model3_3) at ([yshift=-4.0\nodehsep]data3_3.south) {$\mathrm{Model}_3$}; 
        
        \draw[->,thick] ([xshift=-6.0\nodehsep]dataselection3.south)  --  (model3_1.north);
        \draw[->,thick] (dataselection3.south)  --  (model3_2.north);
        \draw[->,thick] ([xshift=6.0\nodehsep]dataselection3.south)  --  (model3_3.north);
        
        % \node[mergenode,anchor=north](mixtureofexpert) at ([xshift=0.1\nodehsep,yshift=-1.1\nodehsep]model3_2.south) {Mixture of Experts (MoE)};

        % \draw[->,thick] (model3_1.south) -- ([xshift=-5.7\nodehsep]mixtureofexpert.north);
        % \draw[->,thick] (model3_2.south) -- (mixtureofexpert.north);
        % \draw[->,thick] (model3_3.south) -- ([xshift=5.7\nodehsep]mixtureofexpert.north);
        
        \node[tasknode,anchor=north](task3_1) at ([yshift=-4.0\nodehsep]model3_1.south) {$\mathrm{Group}_1$};
        \node[tasknode,anchor=north](task3_2) at ([yshift=-4.0\nodehsep]model3_2.south) {$\mathrm{Group}_2$};
        \node[align=center,thick, scale=2] (omit3_3) at ([xshift=\nodehsep]task3_2.center) {...};
        \node[tasknode,anchor=north](task3_3) at ([yshift=-4.0\nodehsep]model3_3.south) {$\mathrm{Group}_3$}; 

        % \draw[->,thick] ([xshift=-6.0\nodehsep]mixtureofexpert.south)  --  (task3_1.north);
        % \draw[->,thick] (mixtureofexpert.south)  --  (task3_2.north);
        % \draw[->,thick] ([xshift=6.0\nodehsep]mixtureofexpert.south)  --  (task3_3.north);

        \draw[->,thick] (model3_1.south)  --  (task3_1.north);
        \draw[->,thick] (model3_2.south)  --  (task3_2.north);
        \draw[->,thick] (model3_3.south)  --  (task3_3.north);

        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=\nodehsep*4.9,minimum width=19.5em,fill=black!4,rounded corners=5pt,dotted,draw](b3) at ([yshift=-14.3em]data3_2.north) {};
        \end{pgfonlayer}
        
        \node[anchor=south,font=\Large](l3) at ([xshift=.5em,yshift=-3em]task3_2.south) {(c) Group Training};
    \end{scope}

    % pic d
    \begin{scope}[xshift=4.2in,yshift=-2.6in]
        \node[datanode,anchor=south](data4_1) at (0, 2) {En-De};
        \node[datanode,anchor=west](data4_2) at ([xshift=\nodehsep]data4_1.east) {Zh-En};
        \node[align=center,thick, scale=2] (omit4_1) at ([xshift=\nodehsep]data4_2.center) {...};
        \node[datanode,anchor=west](data4_3) at ([xshift=\nodehsep]data4_2.east) {En-Fr};
        
        \node[mergenode,anchor=north](dataselection4) at ([xshift=0.1\nodehsep,yshift=-1.1\nodehsep]data4_2.south) {Data Selection};

        \draw[->,thick] (data4_1.south) -- ([xshift=-6.7\nodehsep]dataselection4.north);
        % \draw[->,thick] (data2_1.south) |-  (dataselection.north);
        \draw[->,thick] (data4_2.south) -- (dataselection4.north);
        \draw[->,thick] (data4_3.south) -- ([xshift=6.4\nodehsep]dataselection4.north);
        
        \node[modelnode,anchor=north](model4_1) at ([yshift=-4.0\nodehsep]data4_1.south) {$\mathrm{Model}_1$};
        \node[modelnode,anchor=north](model4_2) at ([yshift=-4.0\nodehsep]data4_2.south) {$\mathrm{Model}_2$};
        \node[align=center,thick, scale=2] (omit4_2) at ([xshift=\nodehsep]model4_2.center) {...};
        \node[modelnode,anchor=north](model4_3) at ([yshift=-4.0\nodehsep]data4_3.south) {$\mathrm{Model}_3$}; 
        
        \draw[->,thick] ([xshift=-6.0\nodehsep]dataselection4.south)  --  (model4_1.north);
        \draw[->,thick] (dataselection4.south)  --  (model4_2.north);
        \draw[->,thick] ([xshift=6.0\nodehsep]dataselection4.south)  --  (model4_3.north);
        
        \node[mergemodelnode,anchor=north](finalmodel) at ([xshift=0.1\nodehsep,yshift=-1.1\nodehsep]model4_2.south) {Merged Model};

        % \draw[->,thick] (model4_1.south) -- ([xshift=-5.7\nodehsep]finalmodel.north);
        % \draw[->,thick] (model4_2.south) -- (finalmodel.north);
        % \draw[->,thick] (model4_3.south) -- ([xshift=5.7\nodehsep]finalmodel.north);
        
        \node[tasknode,anchor=north](task4_1) at ([yshift=-4.0\nodehsep]model4_1.south) {$\mathrm{Task}_1$};
        \node[tasknode,anchor=north](task4_2) at ([yshift=-4.0\nodehsep]model4_2.south) {$\mathrm{Task}_2$};
        \node[align=center,thick, scale=2] (omit4_3) at ([xshift=\nodehsep]task4_2.center) {...};
        \node[tasknode,anchor=north](task4_3) at ([yshift=-4.0\nodehsep]model4_3.south) {$\mathrm{Task}_3$}; 

        \draw[->,thick] ([xshift=-6.0\nodehsep]finalmodel.south)  --  (task4_1.north);
        \draw[->,thick] (finalmodel.south)  --  (task4_2.north);
        \draw[->,thick] ([xshift=6.0\nodehsep]finalmodel.south)  --  (task4_3.north);


        \begin{pgfonlayer}{background}
            \node[anchor=south,minimum height=\nodehsep*4.9,minimum width=19.5em,fill=black!4,rounded corners=5pt,dotted,draw](b4) at ([yshift=-14.3em]data4_2.north) {};
            \node[anchor=south,minimum height=\nodehsep*0.9,minimum width=17.5em,fill=blue!4,rounded corners=5pt,thick,dotted,draw](bmerge) at ([yshift=-2.3em]model4_2.north) {};
        \end{pgfonlayer}

        
        \draw[thick, -{Latex[round]}] (bmerge.south) -- ([xshift=-0.1em]finalmodel.north);
        
        \node[anchor=south,font=\Large](l4) at ([xshift=.5em,yshift=-3em]task4_2.south) {(d) Model Merging};
    \end{scope}
\end{tikzpicture}
    
    
    \caption{(a) Seperate Training. (b) Mixture of Experts. (c) Group Training (d) Model Merging }
    \label{fig:architecture}
    \vspace{-1em}
% \end{figure*}
\endgroup

\label{fig:comparison-merge}
\end{figure*}

% \end{document}
