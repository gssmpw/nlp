% Final results
\section{MEDDxAgent Architecture}
\begin{figure*}[h]
	\centering
    \includegraphics[trim={0.5cm 1.0cm 0cm 0cm},clip,width=\textwidth]{img/Overview_framework_details_v3.pdf}
    %\vspace{-0.9em}
    \caption{The architecture of the MEDDxAgent framework. MEDDxAgent comprises a unifying orchestrator (DDxDriver), a simulator (\textcolor{yellow-history}{\textbf{History Taking}}) and two agents (\textcolor{blue-retrieval}{\textbf{Knowledge Retrieval}}, \textcolor{green-diagnosis}{\textbf{Diagnosis Strategy}}).}
    %\vspace{-1.2em}
    \label{fig:overview_framework}
\end{figure*}

\section{Details of DDx Benchmark}
\label{app:ddx_benchmark_details}
\input{table/01-table_datasets}
    \paragraph{Datasets.}
    % \cc{I'm not sure is iCraft-MD or CRAFT-MD, do you refer to one of the following papers? \citep{johri2024craft, johri2025craftmd},
    % The paper modified the original CraftMD to an iterative setup - iCraft-MD \citep{li2024mediq}}
    % Standardize the format, covering a wide range of diseases, beneficial as a resource for future studies and expansion!
    %\cc{need to give details to differentiate as the figure 4 in mediq paper (appendix?)!}
    To address the limitation of existing work, which often evaluates on a \textit{single} dataset and diagnoses in a \textit{single} turn, we construct a comprehensive DDx benchmark sourced from three datasets: DDxPlus, iCraft-MD, and RareBench, covering \textit{respiratory}, \textit{skin}, and \textit{rare} diseases, respectively. The statistics of each dataset are presented in~\autoref{tab:datasets_overview}. DDxPlus~\citep{fansi2022ddxplus} is a large-scale synthetic dataset, spanning 1.3 million patient cases across 49 respiratory-related pathologies, focusing on conditions where the chief complaint is related to cough, sore through, or breathing issues. As one of the largest structured DDx datasets, it provides both ground-truth diagnoses \textit{and} ground truth ranked differential diagnosis lists, enabling effective few shot examples as well as a direct evaluation of predicting and refining DDx rankings. iCraft-MD (or interactive Craft-MD)~\citep{li2024mediq} adapts static dermatological clinical vignettes from original Craft-MD dataset~\citep{johri2024craft, johri2025craftmd} into an interactive setting. It consists of 140 dermatology cases, with 100 sourced from an online medical question bank and 40 designed by expert clinicians. RareBench~\citep{chen2024rarebench} further expands the diagnostic landscape by extending DDxPlus to include 421 rare diseases. We specifically select three regional subsets from Rarebench -- RAMEDIS (Europe), MME (Canada), and PUMCH (China) -- to ensure diversity in rare disease regional representation. Each of these datasets includes patient profiles with two core components: (1) symptom/antecedent data and (2) ground-truth pathology/disease.

    \paragraph{Benchmark Compilation.}
    
    To enable a consistent evaluation across datasets, we normalize each dataset into a structured format, each dataset is converted to include: (i) Optional initial information of the patient (e.g., age, sex, chief complaint); (ii) full patient profile (complete list of symptoms and medical history); (iii) full set of possible diseases for differential diagnosis. 

For DDxPlus, we inherit the format from StreamBench~\citep{wu2024streambench}. In iCraft-MD, the initial information of the patient is provided as initial case details, whereas in Rarebench no initial patient information is available. We process iCraft-MD and RareBench to extract the full patient profile. One of the major challenges in iCraft-MD and Rarebench is the lack of predefined differential diagnosis options and the presence of redundant disease names. To address this, we iterate through all patient records and employ GPT-4o to generate a unique, non-redundant disease set for each patient case. As a result, we obtain 394 unique dermatological conditions for iCraft-MD and 102 rare diseases for the RareBench subset. This refinement step ensures that each patient’s diagnostic process operates within a well-defined differential diagnosis structure, reducing ambiguity and improving evaluation reliability.

\begin{example}{\textbf{DDxPlus}}
\textbf{Initial Patient Profile:}\\
Age: 41\\
Sex: F\\
Chief Complaint: nasal congestion\\
\textbf{Complete Patient Profile: }\\
Sex: Male, Age: 39\\
- I am currently being treated or have recently been treated with an oral antibiotic for an ear infection.\\
- I have pain somewhere related to my reason for consulting.\\
- I have a fever (either felt or measured with a thermometer).\\
- I have nasal congestion or a clear runny nose.\\
- My vaccinations are up to date.\\
- On a scale of 0-10, the pain intensity is 6\\
- On a scale of 0-10, the pain's location precision is 8\\
- On a scale of 0-10, the pace at which the pain appear is 2\\
- The pain is:\\
* sensitive\\
* sharp\\
- The pain locations are:\\
* ear(R)\\
- The pain radiates to these locations:\\
* nowhere\\
\textbf{Ground Truth Pathology: } Acute otitis media \\
\textbf{Ground Truth DDx:} \\
1. Acute otitis media\\
2. URTI\\
3. Chagas
\end{example}
\newpage
\begin{example}{\textbf{iCraft-MD}}
\textbf{Initial Patient Profile: }\\
Age: 61 years\\
Sex: male\\
Chief Complaint: A 61-year-old man presents with a 7-month history of lesions on his hands and arms\\
\textbf{Complete Patient Profile: } \\
- A 61-year-old man presents with a 7-month history of lesions on his hands and arms\\
- His medical history includes depression, hypertension, and hyperlipidemia\\
- He has no personal or family history of skin problems\\
- His skin lesions are not painful or itchy, and he is not bothered by their appearance\\
- He has not tried any treatments for the lesions\\
- Physical examination reveals a number of pink, annular plaques with smooth raised borders on the patient’s dorsal forearms and hands\\
- On close inspection, small discrete papules are seen within the plaques.\\
\textbf{Ground Truth Pathology: } Localized granuloma annulare
\end{example}

\begin{example}{\textbf{RareBench}}
\textbf{Initial Patient Profile: } \\
N/A\\
\textbf{Complete Patient Profile: }
- Hematuria \\
- Slurred speech \\
- Abnormality of the liver \\
- Dysphagia \\
- Drooling \\
- Abnormal caudate nucleus morphology \\
- Hand tremor \\
- Poor appetite \\
- Decreased circulating ceruloplasmin concentration \\
- Increased urinary copper concentration \\
- Kayser-Fleischer ring \\
\textbf{Ground Truth Pathology: } Wilson disease
\end{example}
\newpage
\section{Prompt Design}
We present the prompt design for history taking simulator, knowledge retrieval agent, diagnosis strategy agent, and DDxDriver in this section.
%\cc{@Danny: system prompt, for history taking simulator, knowledge retrieval agent, and diagnosis strategy agent}

\begin{prompt}{\textbf{History Taking Simulator: Doctor}}
\textbf{System Prompt:}\\
\verb|<SPECIALIST_PREFACE>|\\
Your job is to take medical history from a patient by asking them specific questions to determine their antecedents and symptoms, as well as narrow down the possible diseases they may be suffering from. \verb|[...]|\\

You may receive this additional information to guide your dialogue:\\
- Initial Patient Information: Information the patient has already self-reported, such as chief complaint, age, sex, etc.\\
- Dialogue History: The conversation you and the patient have had so far, formatted as \verb|'Doctor'| / \verb|'Patient'| turns.\\
- Suggested Conversation Goals: Specific topics or questions to try to cover in the dialogue. You may also ask questions outside of these conversation goals; do not limit yourself to these.\\

You may either start, end, or continue the conversation, as explained below:\\
\verb|[...]|\\

Response Instructions:\\
\verb|[...]|
\end{prompt}
\begin{prompt}{\textbf{History Taking Simulator: Patient}}
\textbf{System Prompt}
Act as a patient with the patient profile below engaging in a medical history taking with a doctor. \verb|[...]|\\

You may receive this additional information to guide your dialogue:\\
- Initial Patient Information: Information you as the patient have already self-reported to the doctor, such as chief complaint, age, sex, etc.\\
- Dialogue History: The conversation you and the patient have had so far, formatted as \verb|'Doctor'| / \verb|'Patient'| turns.\\

When asked for information which is explicitly present in your patient profile (including as synonyms), either respond:\\
    a.~ Positively ("Yes"...) if your patient profile explicitly indicates you have this antecedent/symptom\\
    b.~Negatively ("No"...) if your patient profile explicitly indicates that you do not have this antecedent/symptom\\

When asked for information which is not explicitly mentioned in your patient profile (including as synonyms), respond "I don't know." \\
\verb|[...]|\\

Response instructions:\\
\verb|[...]|
\end{prompt}

\begin{prompt}{\textbf{Knowledge Retrieval Agent}}
\textbf{Keywords Prompt:}\\
Your job is to assist in the creation of a differential diagnosis for a patient by searching for relevant information online. Given an input search from a user, break it up into a list of simplified keyword searches to find relevant medical information online. \\
Follow these steps:\\
\verb|[...]|\\
Format example:\\
Input search:\\
\verb|<INPUT_SEARCH>|\\
Keyword searches list:\\
\verb|[<KEYWORD_SEARCH_1>, <KEYWORD_SEARCH_2>]|\\

\textbf{Synthesis Prompt}\\
You are a helpful research assistant to a doctor creating a differential diagnosis of a patient. Concisely answer the doctor's input search by analyzing and summarizing the relevant medical content in the search results. \verb|[...]|\\

Inputs:\\
1. Doctor's Input Search: the search the doctor requested\\
- This search may contain multiple topics\\
2. Search results: the search results fetched\\
- You may only answer based on topics present in these search results\\
3. Diagnosis Options (optional): the possible diseases the patient may be suffering from\\
- If provided, use this exact terminology to refer to the diseases\\

Response Instructions:\\
\verb|[...]|
\end{prompt}

\begin{prompt}{\textbf{Diagnosis Strategy Agent}}
\textbf{System Prompt:}\\
\verb|<SPECIALIST_PREFACE>|\\
Given a patient's profile (a list of antecedents and symptoms), provide a ranked differential diagnosis of the \verb|<DDX_LENGTH>| most likely diseases. You may be provided a list of diagnosis options you can choose from. You must use this exact disease terminology when referring to the diseases. If you aren't provided the diagnosis options, consider all possible diseases. \\

Your ranked differential diagnosis should have the possible diseases ranked from most likely to least likely.\\

You will also be provided with:\\
1. Previous Ranked Differential Diagnoses: \verb|[...]|\\
2. Suggested Diagnosis Instructions (optional): \verb|[...]|\\
3. Previous Search Content (optional): \verb|[...]|\\
4. Patient profile: the known symptoms/antecedents of the patient\\
5: Patient examples (optional): \verb|[...]|\\

\verb|[...]|\\

Directly provide the ranked differential diagnosis of the \verb|<DDX_LENGTH>| most likely diseases for the patient in the following format (without additional text before or after), with one diagnosis per line (replace \verb|[DIAGNOSIS_X]| with the actual diagnosis name, and do not include the brackets themselves): \verb|[RANK_NUMBER]. [DIAGNOSIS]|. \verb|I.e.|: \\
1. \verb|[DIAGNOSIS_1]|\\
2. \verb|[DIAGNOSIS_2]|\\
...\\
Directly provide your response in the format specified, without additional text.
\end{prompt}

\begin{prompt}{\textbf{DDxDriver}}
\textbf{Fixed Iteration System Prompt:}\\
Your job is to facilitate the process of differential diagnosis of a patient by concisely prompting medical agents.\\  

You will be provided with: \\
1) Agent Descriptions. This includes:\\
a) Agent Function: A description of the function of medical agent.\\
b) Agent Prompt: A description of how to prompt the agent\\
2) Available Information: The available information you can extract from to prompt the agent. Do not invent new information. This may include: \\
    a) Patient Initial Information\\
    b) Patient Profile\\
    c) Dialogue History\\
    d) Previous RAG content\\
    - External information found about diseases the patient may be suffering from\\
    e) Previous Ranked Differential Diagnoses\\
    f) Diagnosis Options\\
    - These are the only diseases the patient may be suffering from.\\
    - You must use the exact terminology in this list when referring to the diseases\\

Follow these steps to create a prompt for the medical agent:\\
1. Analyze the description of the medical agent and its input prompt. Note whether its input prompt is optional or mandatory.\\
2. Review the current information you were provided. Determine how this information can help the agent.\\
- You should only prompt based on this current information.\\
3. Follow the agent's input prompt description and design a prompt for this agent.\\
4. Respond with your agent prompt, nothing else.
\end{prompt}

\newpage
\section{Additional Analysis}

Results of iCraft-MD (\autoref{fig:icraftmd_comparison}) and RareBench (\autoref{fig:rarebench_comparison}) compared between (a) History Taking Simulator, and (b) MEDDxAgent over the selection of max questions (5, 10, 15), and number of iterations (1, 2, 3).
\label{subsec:comparison_history_taking_iterative}
\begin{figure*}[h]
    \centering
    \begin{subfigure}{0.48\textwidth}
    \includegraphics[trim={0cm 0cm 0cm 0cm },clip, width=\textwidth]{img/icraftmd_history.pdf}
    \caption{}
    \end{subfigure}
    \begin{subfigure}{0.48\textwidth}
    \includegraphics[trim={0cm 0cm 0cm 0cm}, clip, width=\textwidth]{img/agent_iterations_plot_icraftmd.pdf}
    \caption{}
    \end{subfigure}
    \caption{Results of iCraft-MD~\citep{li2024mediq} compared between (a) History Taking Simulator, and (b) MEDDxAgent.}
    \label{fig:icraftmd_comparison}
\end{figure*}

\begin{figure*}[h]
    \centering
    \begin{subfigure}{0.48\textwidth}
    \includegraphics[trim={0cm 0cm 0cm 0cm },clip, width=\textwidth]{img/rarebench_history.pdf}
    \caption{}
    \end{subfigure}
    \begin{subfigure}{0.48\textwidth}
    \includegraphics[trim={0cm 0cm 0cm 0cm}, clip, width=\textwidth]{img/agent_iterations_plot_rarebench.pdf}
    \caption{}
    \end{subfigure}
    \caption{Results of RareBench~\citep{chen2024rarebench} compared between (a) History Taking Simulator, and (b) MEDDxAgent.}
    \label{fig:rarebench_comparison}
\end{figure*}
\newpage
\section{Additional Experiments}
\label{app:additional_experiments}
\subsection{History Taking Simulator}
\setlength{\tabcolsep}{11.6pt}
\begin{table*}[h]
    \centering
    \scriptsize{%
    \begin{tabular}{llcccccccccc}
    \toprule
     &  & \multicolumn{3}{c}{\textbf{DDxPlus}} & \multicolumn{3}{c}{\textbf{iCraft-MD}} & \multicolumn{3}{c}{\textbf{RareBench}} \\
    \cmidrule(lr){3-5} \cmidrule(lr){6-8} \cmidrule(lr){9-11}
    \textbf{Model} & \textbf{Metric} & \textbf{5} & \textbf{10} & \textbf{15} & \textbf{5} & \textbf{10} & \textbf{15} & \textbf{5} & \textbf{10} & \textbf{15} \\
    \midrule
    \multirow{4}{*}{\textbf{GPT-4o}}
    & \textbf{GTPA@1} & 0.45 & 0.59 & 0.69 & 0.40 & 0.45 & 0.46 & 0.11 & 0.24 & 0.36 \\
    & \textbf{GTPA@3} & 0.60 & 0.73 & 0.82 & 0.51 & 0.53 & 0.53 & 0.22 & 0.36 & 0.48 \\
    & \textbf{GTPA@5} & 0.72 & 0.83 & 0.88 & 0.57 & 0.57 & 0.60 & 0.35 & 0.47 & 0.59 \\

    & \textbf{Avg Rank} & 4.13 & 3.16 & 2.47 & 5.58 & 5.35 & 5.23 & 7.84 & 6.67 & 5.49 \\

    \midrule
    \multirow{4}{*}{\textbf{Llama3.1-70B}}
    & \textbf{GTPA@1} & 0.45 & 0.58 & 0.56 & 0.29 & 0.33 & 0.36 & 0.30 & 0.36 & 0.31 \\
    & \textbf{GTPA@3} & 0.65 & 0.77 & 0.76 & 0.39 & 0.49 & 0.53 & 0.42 & 0.57 & 0.59 \\
    & \textbf{GTPA@5} & 0.71 & 0.83 & 0.79 & 0.47 & 0.55 & 0.60 & 0.53 & 0.65 & 0.67 \\

    & \textbf{Avg Rank} & 4.15 & 3.12 & 3.50 & 6.48 & 5.82 & 5.36 & 6.04 & 4.51 & 4.80 \\ 
    \midrule
    \multirow{4}{*}{\textbf{UltraMedical-70B}}
    & \textbf{GTPA@1} & 0.45 & 0.52 & 0.50 & 0.23 & 0.27 & 0.22 & 0.40 & 0.43 & 0.44 \\
    & \textbf{GTPA@3} & 0.62 & 0.68 & 0.69 & 0.27 & 0.31 & 0.29 & 0.58 & 0.61 & 0.59 \\
    & \textbf{GTPA@5} & 0.70 & 0.73 & 0.73 & 0.29 & 0.34 & 0.31 & 0.61 & 0.67 & 0.67 \\
    & \textbf{Avg Rank} & 4.70 & 4.30 & 4.68 & 8.12 & 7.61 & 7.99 & 5.01 & 4.59 & 4.54 \\

    \midrule
    \multirow{5}{*}{\textbf{Llama3.1-8B}}
    & \textbf{GTPA@1} & 0.23 & 0.35 & 0.40 & 0.10 & 0.12 & 0.11 & 0.05 & 0.13 & 0.11 \\
    & \textbf{GTPA@3} & 0.37 & 0.49 & 0.53 & 0.20 & 0.23 & 0.23 & 0.21 & 0.21 & 0.18 \\
    & \textbf{GTPA@5} & 0.43 & 0.60 & 0.60 & 0.25 & 0.27 & 0.29 & 0.27 & 0.25 & 0.20 \\
    & \textbf{Avg Rank} & 6.85 & 5.46 & 5.44 & 8.78 & 8.39 & 8.3 & 8.38 & 8.25 & 8.95 \\

    \midrule
    \multirow{5}{*}{\textbf{UltraMedical3.1-8B}}
    & \textbf{GTPA@1} & 0.26 & 0.24 & 0.20 & 0.16 & 0.14 & 0.14 & 0.15 & 0.14 & 0.12 \\
    & \textbf{GTPA@3} & 0.36 & 0.35 & 0.32 & 0.22 & 0.20 & 0.21 & 0.23 & 0.25 & 0.21 \\
    & \textbf{GTPA@5} & 0.42 & 0.39 & 0.38 & 0.23 & 0.23 & 0.22 & 0.25 & 0.28 & 0.23 \\
    & \textbf{Avg Rank} & 7.00 & 7.86 & 7.73 & 8.60 & 8.78 & 8.72 & 8.44 & 8.29 & 8.46 \\

    \bottomrule
    \end{tabular}%
    }
    \caption{History taking simulator performance across different datasets (DDxPlus, iCraftMD, Rarebench) with max questions (5, 10, 15), aggregated over 100 patients.}
    \label{tab:performance_history_full}
\end{table*}
\newpage
\subsection{Knowledge Retrieval Agent}
\setlength{\tabcolsep}{15.2pt}
\begin{table*}[h]
    \centering
    \scriptsize{%
    \begin{tabular}{lllccc@{\hspace{10pt}}ccccc@{\hspace{10pt}}ccccc}
    \toprule
     & &  & \multicolumn{2}{c}{\textbf{DDxPlus}} & \multicolumn{2}{c}{\textbf{iCraft-MD}} & \multicolumn{2}{c}{\textbf{RareBench}} \\
    \cmidrule(l{.3em}r{.3em}){4-5} \cmidrule(l{.3em}r{.3em}){6-7} \cmidrule(l{.3em}r{.3em}){8-9}
     \textbf{Model}& \textbf{Source}& \textbf{Metric} & \textbf{RAG} & \textbf{Base} & \textbf{RAG} & \textbf{Base} & \textbf{RAG} & \textbf{Base} \\
    \midrule
    \multirow{8}{*}{\textbf{GPT-4o}} 
    & \multirow{4}{*}{\textbf{PubMed}} 
    & \textbf{GTPA@1} & 0.69 & 0.69 & 0.68 & 0.68 & 0.45 & 0.39 \\
    & & \textbf{GTPA@3} & 0.88 & 0.88 & 0.77 & 0.76 & 0.60 & 0.58 \\
    & & \textbf{GTPA@5} & 0.90 & 0.90 & 0.79 & 0.77 & 0.72 & 0.72 \\

    & & \textbf{Avg Rank} & 2.27 & 2.21 & 3.23 & 3.37 & 3.92 & 3.99 \\

    \cmidrule{2-9}
    & \multirow{4}{*}{\textbf{Wiki}} 
    & \textbf{GTPA@1} & 0.69 & 0.69 & 0.69 & 0.68 & 0.45 & 0.39 \\
    & & \textbf{GTPA@3} & 0.88 & 0.88 & 0.77 & 0.76 & 0.58 & 0.58 \\
    & & \textbf{GTPA@5} & 0.90 & 0.90 & 0.79 & 0.77 & 0.74 & 0.72 \\
    %& & \textbf{GTPA@10} & 0.94 & 0.94 & 0.81 & 0.79 & 0.85 & 0.85 \\
    & & \textbf{Avg Rank} & 2.24 & 2.21 & 3.22 & 3.37 & 4.00 & 3.99 \\
    %& & \textbf{DDR} & 0.49 & 0.49 & - & - & - & - \\
    %& & \textbf{DDP} & 0.44 & 0.43 & - & - & - & - \\
    %& & \textbf{DDF1} & 0.40 & 0.39 & - & - & - & - \\
    \midrule
    \multirow{8}{*}{\textbf{Llama3.1-70B}} 
    & \multirow{4}{*}{\textbf{PubMed}} 
    & \textbf{GTPA@1} & 0.56 & 0.54 & 0.44 & 0.40 & 0.38 & 0.39 \\
    & & \textbf{GTPA@3} & 0.77 & 0.74 & 0.56 & 0.56 & 0.62 & 0.59 \\
    & & \textbf{GTPA@5} & 0.79 & 0.78 & 0.63 & 0.64 & 0.75 & 0.77 \\
    %& & \textbf{GTPA@10} & 0.79 & 0.80 & 0.74 & 0.69 & 0.84 & 0.83 \\
    & & \textbf{Avg Rank} & 3.42 & 3.53 & 4.72 & 4.87 & 3.96 & 4.05 \\
    %& & \textbf{DDR} & 0.37 & 0.37 & - & - & - & - \\
    %& & \textbf{DDP} & 0.39 & 0.42 & - & - & - & - \\
    %& & \textbf{DDF1} & 0.33 & 0.34 & - & - & - & - \\
    \cmidrule{2-9}
    & \multirow{4}{*}{\textbf{Wiki}} 
    & \textbf{GTPA@1} & 0.49 & 0.54 & 0.44 & 0.40 & 0.39 & 0.39 \\
    & & \textbf{GTPA@3} & 0.74 & 0.74 & 0.59 & 0.56 & 0.59 & 0.59 \\
    & & \textbf{GTPA@5} & 0.77 & 0.78 & 0.66 & 0.64 & 0.75 & 0.77 \\
    & & \textbf{Avg Rank} & 3.60 & 3.53 & 4.71 & 4.87 & 4.09 & 4.05 \\

    \midrule
    \multirow{8}{*}{\textbf{UltraMedical-70B}} 
    & \multirow{4}{*}{\textbf{PubMed}} 
    & \textbf{GTPA@1} & 0.58 & 0.60 & 0.31 & 0.31 & 0.45 & 0.44 \\
    & & \textbf{GTPA@3} & 0.68 & 0.73 & 0.37 & 0.38 & 0.65 & 0.63 \\
    & & \textbf{GTPA@5} & 0.70 & 0.76 & 0.38 & 0.39 & 0.71 & 0.70 \\
    & & \textbf{Avg Rank} & 4.63 & 6.55 & 7.08 & 7.01 & 4.20 & 4.47 \\
    \cmidrule{2-9}
    & \multirow{4}{*}{\textbf{Wiki}} 
    & \textbf{GTPA@1} & 0.58 & 0.6 & 0.31 & 0.31 & 0.44 & 0.44 \\
    & & \textbf{GTPA@3} & 0.68 & 0.73 & 0.38 & 0.38 & 0.64 & 0.63 \\
    & & \textbf{GTPA@5} & 0.70 & 0.76 & 0.39 & 0.39 & 0.70 & 0.70 \\
    & & \textbf{Avg Rank} & 4.38 & 6.55 & 7.01 & 7.01 & 4.25 & 4.47 \\
    \midrule
    \multirow{8}{*}{\textbf{Llama3.1-8B}} 
    & \multirow{4}{*}{\textbf{PubMed}} 
    & \textbf{GTPA@1} & 0.42 & 0.48 & 0.29 & 0.27 & 0.35 & 0.33 \\
    & & \textbf{GTPA@3} & 0.58 & 0.63 & 0.38 & 0.37 & 0.55 & 0.54 \\
    & & \textbf{GTPA@5} & 0.67 & 0.69 & 0.44 & 0.43 & 0.59 & 0.57 \\
    & & \textbf{Avg Rank} & 4.50 & 5.25 & 6.93 & 7.02 & 5.33 & 5.45 \\
    \cmidrule{2-9}
    & \multirow{4}{*}{\textbf{Wiki}} 
    & \textbf{GTPA@1} & 0.43 & 0.48 & 0.29 & 0.27 & 0.36 & 0.33 \\
    & & \textbf{GTPA@3} & 0.58 & 0.63 & 0.38 & 0.37 & 0.52 & 0.54 \\
    & & \textbf{GTPA@5} & 0.67 & 0.69 & 0.44 & 0.43 & 0.67 & 0.57 \\
    & & \textbf{Avg Rank} & 4.56 & 5.25 & 6.93 & 7.02 & 4.80 & 5.45 \\
    \midrule
    \multirow{8}{*}{\textbf{UltraMedical3.1-8B}} 
    & \multirow{4}{*}{\textbf{PubMed}} 
    & \textbf{GTPA@1} & 0.27 & 0.33 & 0.19 & 0.27 & 0.21 & 0.22 \\
    & & \textbf{GTPA@3} & 0.39 & 0.48 & 0.24 & 0.37 & 0.46 & 0.35 \\
    & & \textbf{GTPA@5} & 0.46 & 0.51 & 0.26 & 0.43 & 0.48 & 0.42 \\
    & & \textbf{Avg Rank} & 6.81 & 6.88 & 8.38 & 7.02 & 6.23 & 7.02 \\
    \cmidrule{2-9}
    & \multirow{4}{*}{\textbf{Wiki}} 
    & \textbf{GTPA@1} & 0.25 & 0.33 & 0.18 & 0.18 & 0.27 & 0.22 \\
    & & \textbf{GTPA@3} & 0.38 & 0.48 & 0.23 & 0.23 & 0.44 & 0.35 \\
    & & \textbf{GTPA@5} & 0.45 & 0.51 & 0.25 & 0.25 & 0.51 & 0.42 \\
    & & \textbf{Avg Rank} & 6.90 & 6.88 & 8.42 & 8.45 & 6.37 & 7.02 \\
    \bottomrule
    \end{tabular}%
    }
    \caption{Knowledge retrieval agent performance with different datasets with varying sources (PubMed, Wikipedia) and methods, aggregated over 100 patients.}
    \label{tab:performance_rag_full}
\end{table*}
\newpage
\subsection{Diagnosis Strategy Agent}
\input{table/02_table_diagnosis}
\newpage
\subsection{Optimizing Knowledge Retrieval Agent vs. Diagnosis Strategy Agent}
\input{table/05_table_with_patient_profile_full}

\subsection{MEDDxAgent}

%Merged
\setlength{\tabcolsep}{3.4pt}
\begin{table*}[th]
    \centering
    \scriptsize
    \begin{tabular}{l l ccc ccc ccc ccc ccc ccc}
    \toprule
    & & \multicolumn{6}{c}{\textbf{DDxPlus}} & \multicolumn{6}{c}{\textbf{iCraft-MD}} & \multicolumn{6}{c}{\textbf{RareBench}} \\
    \cmidrule(lr){3-8} \cmidrule(lr){9-14} \cmidrule(lr){15-20}
    & & \multicolumn{3}{c}{\textbf{Fixed}} & \multicolumn{3}{c}{\textbf{Dynamic}} 
      & \multicolumn{3}{c}{\textbf{Fixed}} & \multicolumn{3}{c}{\textbf{Dynamic}} 
      & \multicolumn{3}{c}{\textbf{Fixed}} & \multicolumn{3}{c}{\textbf{Dynamic}} \\
    \cmidrule(lr){3-5} \cmidrule(lr){6-8} \cmidrule(lr){9-11} \cmidrule(lr){12-14} \cmidrule(lr){15-17} \cmidrule(lr){18-20}
    \textbf{Model} & \textbf{Metric} & \textbf{1} & \textbf{2} & \textbf{3} & \textbf{1} & \textbf{2} & \textbf{3} 
                                       & \textbf{1} & \textbf{2} & \textbf{3} & \textbf{1} & \textbf{2} & \textbf{3} 
                                       & \textbf{1} & \textbf{2} & \textbf{3} & \textbf{1} & \textbf{2} & \textbf{3} \\
    \midrule

    \multirow{3}{*}{\textbf{GPT-4o}} 
    & \textbf{GTPA@1}  & 0.74 & 0.78 & 0.86 & 0.74 & 0.76 & 0.81 & 0.52 & 0.54 & 0.54 & 0.44 & 0.52 & 0.52 & 0.51 & 0.56 & 0.50 & 0.35 & 0.43 & 0.46 \\

    & \textbf{Avg Rank} & 1.91 & 1.56 & 1.29 & 2.00 & 1.62 & 1.48 & 4.93 & 4.71 & 4.80 & 4.85 & 4.57 & 4.56 & 4.37 & 4.10 & 4.09 & 6.14 & 4.62 & 4.24 \\
    & \textbf{Avg Progress} & 0.00 & 0.32 & 0.32 & -0.13 & 0.04 & 0.01 & 0.00 & 0.26 & 0.17 & 0.14 & -0.06 & 0.01 & 0.00 & 0.13 & 0.16 & -0.23 & -0.15 & -0.39 \\
    \midrule

    \multirow{3}{*}{\textbf{Llama3.1-70B}} 
    & \textbf{GTPA@1}  & 0.61 & 0.71 & 0.68 & 0.53 & 0.61 & 0.60 & 0.29 & 0.37 & 0.42 & 0.24 & 0.30 & 0.31 & 0.39 & 0.48 & 0.48 & 0.32 & 0.37 & 0.46 \\

    & \textbf{Avg Rank} & 2.91 & 2.20 & 2.30 & 2.96 & 2.89 & 2.73 & 7.05 & 6.26 & 6.31 & 7.08 & 6.77 & 6.82 & 5.05 & 4.48 & 4.30 & 5.44 & 4.66 & 4.19 \\
    & \textbf{Avg Progress} & 0.00& 0.41 & 0.17 & 0.00& 0.04 & 0.02 & 0.00& 0.07 & 0.26 & 0.10 & 0.02 & 0.00& 0.00& 0.75 & 0.44 & -0.06 & 0.00& 0.07 \\
    \midrule

    \multirow{3}{*}{\textbf{Llama3.1-8B}} 
    & \textbf{GTPA@1}  & 0.34 & 0.56 & 0.58 & 0.47 & 0.58 & 0.54 & 0.11 & 0.14 & 0.12 & 0.03 & 0.04 & 0.04 & 0.08 & 0.09 & 0.07 & 0.06 & 0.10 & 0.18   \\

    & \textbf{Avg Rank} & 5.25 & 3.59 & 3.10 & 5.00 & 3.82 & 3.92 & 9.38 & 9.22 & 9.07 & 10.11 & 9.95 & 9.91 & 8.47 & 8.11 & 8.56 & 8.01 & 7.54 & 7.21 \\
    & \textbf{Avg Progress} & 0.00& 1.73 & 1.23 & 0.00& 0.00& 0.00& 0.00& 0.22 & 0.17 & 0.00& 0.00& 0.00& 0.00& 0.44 & 0.38 & 0.00& 0.00& 0.00\\
    
\bottomrule
    \end{tabular}
    \caption{Iterative experiment performance compared between fixed iteration and dynamic iteration with 3 datasets.}
    \label{tab:choice_merged}
\end{table*}


