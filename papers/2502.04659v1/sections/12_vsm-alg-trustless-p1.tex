\algblock{Variables}{EndVariables}


\begin{algorithm}[H]
    \small
    \caption{Validator Smart Contract: Concrete 2PC}
    \label{alg:vsm-trustless-p1}
    \begin{algorithmic}[1] %

        \Variables
            \State \{$\vsmid, \dst{}, \idx, \dstemp{} $\}; $\pstat \in \{\free, \paired \};$
            \State \{$\troot{}', \aroot{}', \snonce{}', \enonce{}'$\};
            \State $\decisions$: mapping $\idx \Rightarrow \commit/\abort$
        \EndVariables
        
        \Statex
        \Function{IsLocal}{$\dstt{}, \locevd$}
            \State $(\roots, \nonces, \attproofs) \gets \locevd$
            \State $\textproc{VerAttributes}(\dst{}, \dstt{}, \roots, \nonces, \attproofs)$
            \State $\troot{}, \aroot{},  \troot{}', \aroot{}' \gets \roots$
            \State $\snonce{}', \enonce{}' \gets \nonces$
            \State Store $(\troot{}', \aroot{}', \snonce{}', \enonce{}')$
            \State \Return $(\troot{} = \troot{}') \And (\aroot{} = \aroot{}')$
        \EndFunction
        
        \Statex
        \Function{VerPreComEvd}{$\dstt{}, \pcevd$}
            \State $(\ovsm, \attproofs, \dstt{O}) \gets \pcevd$
            \State \Call{VerAttributesWithBridge}{$\ovsm, \attproofs$}
            \State $\idx \gets \Call{GetIndex}{\dst{}, \dstt{}', \ovsm.\dst{}, \dstt{O}}$
            \State $\leader \gets \Call{GetLeader}{\idx}$
            \If{$\leader = \vsmid$} \; \require $\ovsm.\pstat = \free $
            \Else
                \State \require $\ovsm.\pstat = \paired $ 
                \State \require $\ovsm.\idx = \idx$
            \EndIf
            
        \EndFunction    

        \Statex

        \Function{VerComEvd}{$\cevd$}
            \State $(\ovsm, \attproofs) \gets \cevd$
            \State \Call{VerAttributesWithBridge}{$\ovsm, \attproofs$}
            \State $\leader \gets \Call{GetLeader}{\idx}$
            \If{$\leader = \vsmid$}
                \State \require $\ovsm.\pstat = \paired$ 
                \State \require $\ovsm.\idx = \idx$
                \State \require $\troot{}' = \ovsm.\aroot{}'$
                \State \require $\aroot{}' = \ovsm.\troot{}'$
                \State \require $\enonce{}' + \ovsm.\enonce{}' = \snonce{}'$
            \Else \; \require $\ovsm.\decisions[\idx] = \commit$
            \EndIf
            \State \Return $\true$
        \EndFunction
        \Statex
        \Function{VerAbEvd}{$\dstt{}, \abevd$}
            \State $(\ovsm, \attproofs) \gets \abevd$
            \State \Call{VerAttributesWithBridge}{$\ovsm, \attproofs$}
            \State $\leader \gets \Call{GetLeader}{\idx}$
            \If{$\leader = \vsmid$}
                \If{$\big( (\ovsm.\pstat = \paired)$ $\And$  $(\ovsm.\idx = \idx) \big)$}
                    \State \require {$(\troot{}', \aroot{}') \neq (\ovsm.\aroot{}', \ovsm.\troot{}')$}
                \EndIf
                \State $\decisions[\idx] \gets \abort$
            \Else
                \State \require ($\ovsm.\decisions[\idx] = \abort$)
            \EndIf
        \EndFunction
        


    \end{algorithmic}
\end{algorithm}



