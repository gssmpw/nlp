
\begin{lstlisting}[language=Solidity]
contract XFlashLoan {

    GeneralSystemContract public gsc;
    bool public isBusy;
    Token public token;
    address public otherFLAddr;

    modifier onlyGSC() {
        require(msg.sender == address(gsc), "FlashLoan: only GSC");
        _;
    }

    function setup(address _otherFLAddr) public {
        otherFLAddr = _otherFLAddr;
    }

    // on rollup 1
    function init(uint256 amount, address target, bytes memory cdTarget) public {
        address borrower = msg.sender;
        require (!isBusy);
        isBusy = true;
        uint256 balBefore = token.balanceOf(address(this));
        token.transfer(borrower, amount);

        (bool status, ) = target.call(cdTarget);
        require(status == true);

        bytes memory cdReact = abi.encodeWithSignature(
            "react(address,address,uint256)", 
            address(this), borrower, balBefore
        );
        gsc.trigger(otherFLAddr, cdReact, 10_000);
    }

    // on rollup 2
    function react(address oFLAddr, address borrower, uint256 balBefore) onlyGSC public {
        require(gsc.xSender() == otherFLAddr);
        require (!isBusy);
        bytes memory cdComplete = abi.encodeWithSignature(
            "complete(address,uint256)", 
            borrower, balBefore
        );
        gsc.trigger(oFLAddr, cdComplete, 10_000);
    }

    // on rollup 1
    function complete(address borrower, uint256 balBefore) onlyGSC public {
        require(gsc.xSender() == otherFLAddr);
        require (isBusy);
        uint256 balAfter = token.balanceOf(address(this));
        require(balAfter >= balBefore);
        isBusy = false;
    }
}
\end{lstlisting}

