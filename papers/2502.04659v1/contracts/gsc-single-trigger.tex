\begin{algorithm}[ht]
    \small
    \caption{General System Contract}
    \label{alg:gsc-single-trigger}
    \begin{algorithmic}[1]

    \Function{\textcolor{chain}{startSession}}{\textcolor{chain}{$\addr{}, \cdata$}}
            \State \textcolor{chain}{ \require ($\Not \; \acalled{}$) }
            \State \textcolor{chain}{ $\enonce{} \gets \enonce{} + 1$ }
            \State \textcolor{chain}{ $\snonce{} \gets \snonce{} + 1$ }
            \State \textcolor{chain}{ $\sactive{} \gets \true$ }
            \State \textcolor{chain}{ $\tcalled{} \gets \false$ }
            \State \textcolor{chain}{ \Call{triggerInternal}{$\msgsender, \addr{}, \cdata$} }
    \EndFunction
    \Function{\textcolor{chain}{checkSessionID}}{\textcolor{chain}{$\sid{}$}}
        \If{\textcolor{chain}{ $\sid{} = \snonce{}$ } } 
            \State \textcolor{chain}{ \require ($\sactive{}$) }
        \ElsIf{\textcolor{chain}{ $\sid{} = \snonce{} + 1$} }
            \State \textcolor{chain}{ $\sactive{} \gets \true$ }
            \State \textcolor{chain}{ $\snonce{} \gets \snonce{} + 1$ }
        \Else
            \; \textcolor{chain}{ \textbf{Revert} }
        \EndIf
    \EndFunction
    \Function{triggerInternal}{$\sender, \addr{}, \cdata$}
        \State  \textcolor{chain}{ \require ($\Not \; \tcalled{}$) \textcolor{comment}{\Comment{Only one trigger per tx}} }
        \State \textcolor{chain}{$\tcalled{} \gets \true$}
        \State \textcolor{chain}{$\sid{} \gets \snonce{}$}
        \State $\tnonce{} \gets \tnonce{} + 1$
        \State $ \msghash \gets \hash(\sender, \addr{}, \cdata, \tnonce{}, \textcolor{chain}{\sid{}})$
        \State \textbf{emit T}($\sender, \addr{}, \cdata, \tnonce{}$)
        \State $\ttree.\insertt(\msghash)$
    \EndFunction
    \Function{trigger}{$\addr{}, \cdata$}
        \State \textcolor{chain}{ \Call{triggerInternal}{$\msgsender, \addr{}, \cdata$} }
    \EndFunction
    \Function{action}{$\sender, \addr{}, \cdata, \textcolor{chain}{\sid{}}$}
        \State \textcolor{chain}{$\acalled{} \gets \true$}
        \State \textcolor{chain}{\Call{checkSessionId}{$\sid{}$}}
        \State \textcolor{chain}{$\tcalled{} \gets \false$}
        \State (status, \_) $\gets \addr{}.\call(\cdata)$ \textcolor{comment}{\Comment{execute triggered action} }
        \State \require (status)
        \State $\anonce{} \gets \anonce{} + 1$
        \State $ \msghash \gets \hash(\sender, \addr{}, \cdata, \anonce{}, \textcolor{chain}{\sid{}}) $
        \State $\atree.\insertt(\msghash)$
        \If{\textcolor{chain}{ ($\Not \; \tcalled{}$) } }
            \textcolor{chain}{ $\sactive{} \gets \false$ }
        \EndIf
        \State \textcolor{chain}{$\acalled{} \gets \false$}
        
    \EndFunction
    \end{algorithmic}
\end{algorithm}
