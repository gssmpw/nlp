\begin{algorithm}[t!]
    \caption{Generalized Contrastive Alignment (GCA)\label{alg:example}}
\begin{algorithmic}
        \State \textbf{Input:} Encoder $f_\theta$, projector $g_\theta$, data $\{\x_k\}_{k=1}^N$, batch size $B$, cost function $c(x,y)$, entropy parameter $\varepsilon$, constant $\tau$, total iterations $T$, marginal constraints $\mu$ and $\nu$, relax items $d_1, d_2$ and constant $\delta_{\text{eps}}$, some divergence $d_M$ and $d_\Gamma$ (could be KL or WDM),
        \For{sampled minibatch $\{\x_k\}_{k=1}^{B}$}
            \State Generate two views $(\z'_{k}, \z''_{k})$ using $f_\theta$, $g_\theta$ with randomly sampled augmentations.
        \EndFor
        \State $\mathbf{u}^{(0)} = \mathbbm{1}$, $\mathbf{v}^{(0)}=\mathbbm{1}$, $f=0$, $g=0$, $\C_{ij} = c(\z'_i , \z_j'')$
        \State $d_1 \gets d_1/ (d_1 + \varepsilon)$, $d_2 \gets d_2/ (d_2 + \varepsilon)$, $\K=\exp(C_{ij}/\varepsilon^{-1})$  
        \For{$i=1$ {\bfseries to} $T$}
            \State $\delta f \leftarrow \exp{ -f/(\varepsilon + d_1)}$, $\delta g \leftarrow \exp{ -g/(\varepsilon + d_2)}$ 
            \State $\mathbf{u} \leftarrow \delta f \cdot \text{Prox}_\mathcal{F}(K\mathbf{v}+\delta_{\text{eps}})^{fi}$
            \State $\mathbf{v} \leftarrow \delta g \cdot \text{Prox}_\mathcal{G}(K^T\mathbf{u}+\delta_{\text{eps}})^{fi}$
            \If {$\mathbf{u} > \tau$ \Or $\mathbf{v}>\tau$}
                \State $f\leftarrow f+\varepsilon \cdot \log(\max(\mathbf{u}))$, $g\leftarrow g+\varepsilon \cdot \log(\max(\mathbf{v}))$
                \State $K \leftarrow \exp{(f+g-\C)}/\varepsilon$, $\mathbf{v}=\mathbbm{1}$
            \EndIf
        \EndFor
        \State $\log \mathbf{u} \gets f /  (\varepsilon+\mathbf{u})$, $\log \mathbf{v} \gets g / (\varepsilon+\mathbf{v})$
        \State Compute transport plan as:
        \State $\PP \gets \exp (\log \mathbf{u}+\log \mathbf{v} - C/\varepsilon)$
        \State Normalize $\PP_{u}^{(T)}$ by its column sums. 
        \State Loss: $\mathcal{L}_{GCA} = d_M ( {\bf \mu\otimes\nu}, \PP_{u}^{(T)} )$
        \State Update networks $f_\theta$ and $g_\theta$ to minimize $\mathcal{L}_{GCA}$
    \end{algorithmic}
\end{algorithm}




