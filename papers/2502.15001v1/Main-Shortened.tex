\documentclass{article}[dvipsnames, 11pt]
\usepackage[a4paper, margin=1.5in]{geometry}
\usepackage[utf8]{inputenc}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{float}
\usepackage{graphicx}
\usepackage{titlesec}
\usepackage{placeins}
\usepackage{enumitem}
\usepackage{csquotes}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{bbm}
\usepackage{enumitem}
\usepackage{booktabs}
\usepackage[range-phrase={\text{\ensuremath{-}}}]{siunitx}
\usepackage{subfig}
\usepackage{colortbl}
\usepackage{tikz}
\usepackage{tablefootnote}
\usepackage{makecell}
\usepackage{hyperref}
\usepackage[resetlabels]{multibib}
\newcites{AC}{References}
\newcites{AD}{References}
\newcites{AE}{References}
\bibliographystyle{myama}

\usepackage{authblk}

\usepackage{array}
\usepackage{multirow}

\usepackage{longtable}
\usetikzlibrary{shapes.geometric, arrows, fit}

\setcounter{secnumdepth}{4}

\titleformat{\paragraph}
{\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
\titlespacing*{\paragraph}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}

\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
% TODO NOTES
\usepackage[textsize=footnotesize]{todonotes}

\newcommand{\BS}[1]{\todo[color=red!20]{Bart: #1}}
\newcommand{\BSil}[1]{\todo[color=red!20,inline]{Bart: #1}}
\newcommand{\HF}[1]{\todo[color=blue!20]{Hans: #1}}
\newcommand{\HFil}[1]{\todo[color=blue!20,inline]{Hans: #1}}
\newcommand{\FS}[1]{\todo[color=blue!20]{Frits: #1}}
\newcommand{\FSil}[1]{\todo[color=blue!20,inline]{Frits: #1}}

\newcommand{\WO}{ETKAS}
\newcommand{\WOP}[0]{\WO\ point system}

\usepackage{setspace}
\onehalfspacing

\usepackage{array}

\def\Plus{\texttt{+}}

\title{The ETKidney simulator: a discrete event simulator to assess the impact of alternative kidney allocation rules in Eurotransplant}
\author[a,b]{H.C. de Ferrante\thanks{Corresponding author. Emails: h.c.d.ferrante@tue.nl; h.deferrante@eurotransplant.org}}
\author[b]{R. Laguna Goya}
\author[a]{B.M.L. Smeulders}
\author[a]{F.C.R. Spieksma}
\author[b]{I. Tieken}
\affil[a]{Department of Mathematics and Computer Science, Eindhoven University of Technology (Postal address: De Groene Loper 5, Eindhoven, the Netherlands)}
\affil[b]{Eurotransplant International Foundation (Postal address: Haagse Schouwweg 6, Leiden, the Netherlands)}

\date{February 2025}
\renewcommand\Affilfont{\fontsize{9}{10.8}\itshape}



\date{February 2025}
\renewcommand\Affilfont{\fontsize{9}{10.8}\itshape}
\begin{document}


\maketitle


\begin{abstract}	
	Over 10,000 candidates wait for a kidney transplantation in Eurotransplant, and are prioritized for transplantation based on the allocation rules of the Eurotransplant Kidney Allocation System (ETKAS) and Eurotransplant Senior Program (ESP). These allocation rules have not changed much since ETKAS and ESP's introductions in 1996 and 1999, respectively, despite identification of several areas of improvement by the Eurotransplant Kidney Advisory Committee (ETKAC). A barrier to modernizing ETKAS and ESP kidney allocation rules is that Eurotransplant lacks tools to quantitatively assess the impact of policy changes.
	\par
	We present the ETKidney simulator, which was developed for this purpose. This tool simulates kidney allocation according to the actual ETKAS and ESP allocation rules, and implements Eurotransplant-specific allocation mechanisms such as the system which is used to balance the international exchange of kidneys. The ETKidney simulator was developed in close collaboration with medical doctors from Eurotransplant, and was presented to ETKAC and other major stakeholders. To enhance trust in the ETKidney simulator, the simulator is made publicly available with synthetic data, and is validated by comparing simulated to actual ETKAS and ESP outcomes between 2021 and 2024.	
	\par
	We also illustrate how the simulator can contribute to kidney policy evaluation with three clinically motivated case studies. We anticipate that the ETKidney simulator will be pivotal in modernizing ETKAS and ESP allocation rules by enabling informed decision-making on kidney allocation rules together with national competent authorities.
\end{abstract}

\newpage
\section{Introduction}
Over 10,000 patients wait for a kidney transplantation in the countries served by Eurotransplant (Austria, Belgium, Croatia, Germany, Hungary, Luxembourg, the Netherlands, and Slovenia). Eurotransplant is responsible for the allocation of kidneys from deceased donors to these patients, and places most kidneys through two programs: the Eurotransplant Kidney Allocation System (ETKAS) for kidneys from donors aged under 65 \cite{demeesterNewEurotransplantKidney1998, Mayer2005} and the Eurotransplant Senior Program (ESP) for kidneys from donors aged 65 and older \cite{smitsEvaluationEurotransplantSenior2002}.
%ETKAS is used by Eurotransplant to allocate kidneys from donors aged below 65 to candidates of any age, and prioritizes candidates with a point system. This point system emphasizes Human Leucocyte Antigen (HLA) matching between the donor and candidate to ensure that kidney transplant recipients have good outcomes after transplantation. ETKAS also awards mismatch probability points for the time a candidate has spent on dialysis to limit the waiting times of candidates for whom a high quality HLA match is rare, and points for the candidate's country of listing to maintain a balance in the international exchange of kidneys \cite{demeesterNewEurotransplantKidney1998}.
%\par
%ESP is used by Eurotransplant to offer kidneys from donors aged 65 and older to candidates aged 65 and older. Aims of ESP were to expedite the placement of kidneys from older donors to increase usage rates of such kidneys, and limit waiting times for older candidates \cite{smitsEvaluationEurotransplantSenior2002, Frei2008}. ESP attained these goals by offering kidneys in ESP only to candidates who are located in the vicinity of the donor, with priority based on the time a candidate has spent on dialysis (and not HLA matching) \cite{smitsEvaluationEurotransplantSenior2002,Frei2008}.
\par
Changes to ETKAS and ESP are regularly proposed, and are often based on medical insights or ethical considerations. An example of a medical insight is that the point system that forms the basis of ETKAS places equal emphasis on Human Leucocyte Antigen (HLA) matching on the A, B, and DR loci, which has been described to lead to additional mismatches on the DR locus \cite{demeesterNewEurotransplantKidney1998, vereerstraetenExperienceWujciakOpelzAllocation1998}. Based on findings that HLA-DR mismatches are most deleterious to graft survival \cite{Roberts2004, johnsonFactorsInfluencingOutcome2010}, proposals have been made to instead emphasize DR matching in ETKAS \cite{vereerstraetenAllocationCadaverKidneys1999, Doxiadis2004}. Other proposals are to make candidates under age 65 eligible for ESP \cite{Ssal2020}, to introduce HLA-DR matching in ESP \cite{deFijter2023}, to introduce candidate-donor age matching \cite{vonsamson-himmelstjernaContinuousDonorrecipientAge2024}, epitope matching \cite{Niemann2021}, and to give extra priority to candidates who are immunized, but do not meet entry for the Acceptable Mismatch (AM) program which is Eurotransplant's special program for highly immunized candidates \cite{ziemannUnacceptableHumanLeucocyte2017, zecherImpactSensitizationWaiting2022a, deferranteImmunizedPatientsFace2023}. 
\par
Within Eurotransplant, such areas of improvement are regularly discussed by the Eurotransplant Kidney Advisory Committee (ETKAC), which consists of an abdominal surgeon, an immunologist, and nephrologists who represent the Eurotransplant member countries. Despite ETKAC discussions on these topics, ETKAS and ESP have not changed much since their initiations in 1996 and 1999, respectively. An important barrier to updating the kidney allocation rules is that Eurotransplant has lacked tools which would enable Eurotransplant to quantitatively assess the effects of policy changes. Eurotransplant needs such tools to assess the adequacy of proposed rule changes, and to give national competent authorities insight into the negative consequences a policy change may have.
\par
Computer simulations of the kidney allocation system can fulfill this need, and are routinely used by other organ exchange organizations to introduce new allocation policies. For instance, in the United States, the Kidney-Pancreas Simulated Allocation Model (KPSAM) \cite{israniNewNationalAllocation2014} was used to revise allocation rules in 2014 \cite{israniNewNationalAllocation2014}, and this tool continues to be used for the proposal of further changes to allocation \cite{israniNewKidneyPancreas2021, mankowskiAcceleratingKidneyAllocation2019}. The allocation policies in France and the United Kingdom were also updated on the basis of bespoke computer simulations in 2015 and 2019, respectively \cite{jacquelinetChangingKidneyAllocation2006a, Audry2022, Mumford2018}. ETKAS itself was also originally designed based on computer simulations in 1993 \cite{wujciakComputerAnalysisCadaver1993,wujciakProposalImprovedCadaver1993a}.
\par 
This motivated us to develop a simulation toolbox which enables Eurotransplant and other stakeholders to quantify the impact of changes to ETKAS and ESP allocation rules. This tool, which we refer to as the ETKidney simulator, uses Discrete Event Simulation (DES) to mimic kidney allocation within Eurotransplant. The simulator was developed in close collaboration with medical doctors from Eurotransplant and presented to ETKAC, which has welcomed the ETKidney simulator as a tool to help inform policy discussions on kidney allocation. The Python code of the simulator is made publicly available together with synthetic data to enable collaborations with policymakers and scientists in evaluating alternative ETKAS and ESP allocation rules.\footnote{ \url{https://github.com/hansdeferrante/Eurotransplant_ETKidney_simulator}} In this paper, we describe how kidneys are allocated within Eurotransplant (Section \ref{sec:kidney_alloc}) and how this process is approximated by the simulator (Sections \ref{sec:design} and \ref{sec:modules}). Furthermore, we give insight into how closely the simulator approximates outcomes of ETKAS and ESP with input-output validation (Section \ref{sec:validation}). We also demonstrate how the ETKidney simulator can contribute to policy evaluation with three case studies (section \ref{sec:case_studies}). %Finally, we conclude and discuss in Section \ref{sec:discussion}.
%\par
%Despite such indications, the ETKAS point system has remained largely unchanged after its implemented in 1996 \cite{demeesterNewEurotransplantKidney1998}.
%\par
%The Eurotransplant Senior Program (ESP) was introduced in 1999 by Eurotransplant. Aims of this program were to prevent extensive waiting times in older candidates, to reduce cold ischemia times for older donor kidneys in order to improve kidney usage rates of such kidneys \cite{smitsEvaluationEurotransplantSenior2002, Frei2008}. The ESP achieved these goals by only offering kidneys to candidates located in close proximity to the donor, and prioritizing candidates solely based on accrued waiting time (and not the HLA match). Since ESP's initiation in 1999, the Eurotransplant donor population has aged substantially, with currently almost 30 percent of kidneys allocated via ESP compared to only 10 percent in 1999 \cite{Frei2008}. Especially in Germany, there are concerns that reserving these old-age donors for old-age candidates has led to disparities in waiting times. For instance, in Germany the median waiting time in ETKAS has grown to 6.9 years compared to only 3.7 years in ESP \cite{Kolbrink2024}. There have also been discussions on including HLA matching in the ESP program \cite{Fritsche2003}, in particular for the DR locus \cite{deFijter2023}. Despite such issues, ESP has also remained largely unchanged since its implementation in 1999.
%\par


\section{Kidney allocation within Eurotransplant}
\label{sec:kidney_alloc}
Figure \ref{fig:flowchart_kidney_allocation} shows how Eurotransplant allocates the deceased-donor kidneys which become available for kidney-only transplantation.\footnote{In case a multi-organ donor is reported to Eurotransplant, the donor's kidneys may first be accepted by candidates who wait for a combined transplantation of a kidney with another organ (heart, lung, pancreas, liver, or intestine). Such combined transplantations account for 7\% of all transplanted kidneys in Eurotransplant \cite{statlibrary2152P_AllET_Kidney}} Three standard allocation programs are used to place these kidneys: the Acceptable Mismatch (AM) program, ETKAS (\ref{subsection:etkas}), and ESP (\ref{subsection:esp}) (see Figure \ref{fig:flowchart_kidney_allocation}). Through which program Eurotransplant offers the kidney(s) is determined by the age of the donor. Kidneys from donors aged below 65 are first offered for transplantation through the AM program \cite{Heidt2015}, Eurotransplant's program for highly immunized candidates which accounted for 3\% of kidney-only transplantations between 2014 and 2023, and then through ETKAS, which accounted for 69\% of kidney-only transplantations. Kidneys from donors aged 65 and older are offered via ESP, which accounted for 16\% of kidney-only transplantations \cite{etStatsLibrary2072P}.
\par 
The remaining 11\% of kidney-only transplantations between 2014 and 2023 were the result of recipient-oriented extended allocation or competitive rescue allocation, which Eurotransplant refers to as \enquote{\textit{non-standard allocation}} mechanisms. Eurotransplant switches to these mechanisms under specific circumstances to prevent the loss of transplantable kidney(s) (see the Eurotransplant kidney manual \cite{manualKidney}). In either mechanism, centers located in the vicinity of the kidney(s) receive a \textit{center offer}, in which centers can propose candidates for transplantation. In extended allocation, centers have 60 minutes to propose candidates, and the proposed candidate(s) with the highest rank(s) on the original ETKAS or ESP match list receives the kidney(s) for transplantation. In rescue allocation, offers are competitive which means that the first center that responds receives the kidney.
\par
Not all kidneys offered by Eurotransplant are eventually transplanted. In fact, approximately 24\% of kidneys offered for transplantation between 2014 and 2023 were discarded \cite{etreport_1132P}.
\FloatBarrier
\begin{figure}[h]
	\centering
	\resizebox{\linewidth}{!}{%
		\includegraphics{figures/fig1-flowchart_kidney_allocation.pdf}
		%
	}
	\caption{Flow chart on how Eurotransplant offers kidneys for kidney-only transplantation. The percentages shown represent the proportion of kidney-only transplantations performed through each mechanism between 2014 and 2023 \cite{etStatsLibrary2072P}. Kidneys declined in ESP by all candidates were re-allocated via ETKAS until March 2021. Since March 2021, an extended allocation is triggered to place such kidneys.}
	\label{fig:flowchart_kidney_allocation}
\end{figure}
\subsection{Allocation based on match lists}
\label{subsection:matchlist_allocation}
Eurotransplant uses \textit{match lists} to determine which candidate receives a kidney offer at what moment. The composition and ordering of candidates on match lists are determined by program-specific \textit{eligibility}, \textit{filtering}, and \textit{ranking criteria}. A complete description of the program-specific criteria can be found in the Eurotransplant kidney manual \cite{manualKidney}, and a comprehensive summary is included in Appendix \ref{app:allocation rules}. % In this paper, we briefly describe how these criteria are used in Eurotransplant kidney allocation (criteria are summarized in Appendix \ref{app:allocation rules}). 
\par 
Firstly, eligibility criteria determine whether a candidate is allowed to be included on the match list according to Eurotransplant rules. Examples of eligibility criteria are that the candidate must have the same blood group as the donor, and that the donor's HLA typing cannot include an HLA antigen which the center has reported as unacceptable for the candidate. Such \enquote{\textit{unacceptable antigens}} are used by centers to indicate that their candidate has a pre-existing immunization against specific HLA antigens, for instance because of a prior blood transfusion, pregnancy, or transplantation. Centers want to avoid offers with such antigens, because transplantation in the presence of a pre-existing immunization is likely to result in an early loss of the transplanted kidney.
\par 
The filtering criteria are specified by the transplantation centers, and determine whether Eurotransplant contacts the center to make an offer for the transplantation of a specific candidate. The filtering criteria can be distinguished into:
\begin{enumerate}[noitemsep]
	\itemsep0em
	\item \textit{allocation profiles}, with which centers can indicate that their patient does not want to receive offers from donors with certain characteristics (for instance, donors above a certain age, virology, etc.), and
	\item \textit{HLA mismatch criteria}, with which centers can specify minimal requirements for the HLA match quality between the donor and candidate on the HLA-A, -B and -DR loci.
\end{enumerate}
\par
Finally, ranking criteria determine the position of a candidate on the match list. This match list order determines the sequence in which candidates receive an offer. To determine this order, candidates are first grouped in match \textit{tiers} based on medical and ethical criteria (for instance, 0 HLA mismatches, pediatric status, and the location of the candidate relative to the donor). Candidates ranked in higher tiers receive absolute priority over candidates in lower tiers. Within tiers, candidates are ranked by points. The specific ranking criteria for ETKAS and ESP are described in Section \ref{section:match_list_and_matchpoints}.
 %For ETKAS, the two most important ranking criteria are whether the candidate has zero mismatches with the donor on the A, B, and DR loci, and the number of points awarded to the candidate based on candidate, donor, and candidate-donor match characteristics (see Section \ref{subsection:etkas}). For ESP, important ranking criteria are the location of the candidate relative to the donor, and candidate waiting time (based on received dialysis time).
\par 
In allocating kidneys, Eurotransplant starts by contacting centers with offers for specific, named candidates. Such offers are only made to candidates who appear on the \textit{filtered match list}, which means that candidates must meet the program's eligibility and filtering criteria. %The sequence in which Eurotransplant contacts centers is based on the rank at which the candidate appears on the match list. 
In extended allocation, centers are additionally allowed to select candidates from \textit{unfiltered match list}, which means that candidates only have to meet the program's eligibility criteria. In competitive rescue allocation, centers are also allowed to propose blood group compatible candidates who did not appear on the match list.

%\subsection{The Acceptable Mismatch (AM) program}
%\label{subsection:am}
%Kidneys from donors under age 65 are first offered via the Acceptable Mismatch (AM) program. This program is organized and supervised by the Eurotransplant Reference Laboratory (ETRL), which is situated in the Leiden University Medical Center. Candidates eligible for the AM program have a high degree of pre-existing immunization which makes these candidates unlikely to obtain a kidney transplant through ETKAS or ESP. AM candidates are therefore given absolute international priority to kidneys whose HLA antigens are all pre-specified as acceptable by the transplantation center \cite{Heidt2021}. Simulation of this AM program is beyond the scope of the ETKidney simulator, because definition of acceptable antigens is based on an individualized risk-benefit analysis which requires specialized immunological knowledge.

\subsection{The ETKAS program}
\label{subsection:etkas}
In ETKAS, kidneys from donors aged below 65 are offered to candidates of any age. The point system of ETKAS was designed based on computer simulations in 1993 \cite{wujciakComputerAnalysisCadaver1993, wujciakProposalImprovedCadaver1993a}, and penalizes HLA mismatches between the donor and the candidate because of its negative impact on kidney graft survival \cite{demeesterNewEurotransplantKidney1998}. To avoid extensive waiting times for candidates for whom a high-quality HLA match is rare, the \WOP\ also awards mismatch probability points and points for the time a candidate has waited on dialysis. Distance points are awarded to promote local and domestic transplantations, and balance points are awarded to maintain a balance in the international exchange of kidneys \cite{demeesterNewEurotransplantKidney1998}. Finally, the point system awards points to sensitive patient groups: pediatric candidates receive HLA bonus points and pediatric points, and candidates with the High Urgency (HU) status receive HU points. 
%Since 01-04-2019, the balances have become separated by the age group of the donor (0-17 years, 18-49 years, 50-64 years, and 65 and older years of age) \cite{manualKidney}.

\subsection{The Eurotransplant Senior Program (ESP)}
\label{subsection:esp}
ESP was initiated as an old-for-old program in 1999, is used to offer kidneys from donors aged 65 and older with priority to candidates aged 65 and older. The aims behind ESP were (i) to increase the number of donors aged 65 and older, (ii) to improve quality of life for older candidates, and (iii) to decrease the cold ischemia times for older donor kidneys \cite{eurotransplantinternationalfoundationMinutesETKACMeeting1998}. These aims were achieved by only offering kidneys to candidates located in the vicinity of the donor, and prioritizing candidates solely based on accrued dialysis time \cite{smitsEvaluationEurotransplantSenior2002,Frei2008}. 
\par
Since the program's introduction in 1999, ESP has changed in several ways. One change is that prospective HLA typing of the donor was not performed in ESP in order to maximally reduce cold ischemia times \cite{smitsEvaluationEurotransplantSenior2002}. Because this meant that the donor's HLA typing was unknown at time of allocation, candidates were transplanted without regard to HLA match quality and immunized candidates were not eligible to receive offers via ESP. Since 21-01-2025, all Eurotransplant countries require the donor's HLA typing to be available before kidneys can be allocated via ESP. This has made it possible to also offer kidneys to immunized candidates via ESP. Another important change is that kidneys not accepted on the filtered match list in ESP were re-allocated via ETKAS. This resulted in extended allocation times, because most such offers were declined because of geographical distances and/or age mismatch. Since March 2021, unplaced ESP kidneys are therefore instead allocated via non-standard allocation based on the \textit{unfiltered} ESP match list. To ensure that non-local candidates and candidates aged below 65 still have access ESP kidneys, such candidates can appear on the unfiltered ESP match list since March 2021 (see Appendix \ref{app:allocation rules}).

\section{Purpose and design of the ETKidney Simulator}
\label{sec:design}
The purpose of the ETKidney simulator is to enable Eurotransplant to assess the impact of changes to ETKAS and ESP allocation rules on waiting list outcomes. To meet this goal, we use Discrete Event Simulation (DES) to simulate kidney allocation according to the actual ETKAS and ESP allocation rules implemented in March 2021. Simulation of the AM program is beyond the scope of the ETKidney simulator, because definition of acceptable antigens is based on an individualized risk-benefit analysis which requires specialized immunological knowledge. The simulator was also not designed for the analysis of kidney discard rates.
\par
Relevant system states are (i) the statuses of candidates who wait in ETKAS or ESP for a kidney-only transplantation, and (ii) the export balances of Eurotransplant member countries, which affect a candidate's rank on ETKAS match lists because of Eurotransplant's balance point system (see Section \ref{subsection:etkas}). In DES, we study how such system states evolve in response to a series of discrete events. For the ETKidney simulator, we distinguish between three types of events:
\begin{enumerate}[noitemsep]
	\item updates to candidate states, which are changes to a candidate's waiting list status (transplantable, non-transplantable, HU, removed, transplanted, or waiting list death), their allocation profile, their unacceptable antigens, their HLA mismatch criteria, the reporting of an antibody screening, or a choice for ETKAS or ESP in Germany (see Appendix \ref{app:allocation rules}),
	\item the arrivals of donors with one or two kidneys available for kidney-only transplantation through ETKAS or ESP, which generally results in a transplantation, and 
	\item transplantations across country borders through allocation programs other than ETKAS and ESP (AM and combined transplantations), which count towards an Eurotransplant member country's export balance.
\end{enumerate}
\par
\noindent
%Simulations in the ETKidney simulator are data-driven, and require end-users to specify data input streams. To closely approximate ETKAS / ESP outcomes, these input streams are expected to contain realistic donor and realistic transplantation candidate information. Requirements for the input streams are discussed in Section \ref{subsection:input_streams}. How the system states are initialized based on the input streams is described in Section \ref{subsection:initialization}, and how the simulation proceeds after initialization is described in Section \ref{subsection:overview}.
%For initialization of the system state and events, the ETKidney simulator requires external input streams. These input streams have to include information on donors whose kidneys become available for allocation via ETKAS or ESP, and information on the candidates which wait for a transplantation via ETKAS or ESP. We point out that centers regularly update the information of candidates while they wait for a kidney transplantation. For instance, centers have to report an updated antibody screening every 180 days for their candidates to appear on ETKAS/ESP match lists, centers can indicate that a candidate is temporarily unavailable for transplantation, and centers can update the candidate's set of unacceptable antigens, allocation profile or minimal HLA match criteria. Which status updates are done for which candidate also has to be pre-specified in input streams.
%\par
% Eligibility, filtering and ranking criteria determine when and on what rank a candidate appears on the match list. Whether and when a candidate would be transplanted is additionally determined by stochastic processes. These include the kidney offer acceptance behavior by the transplantation centers, the switching from standard to non-standard allocation, and the listing of candidates for a repeat kidney transplantation. The modules which approximate these stochastic processes are described in Section \ref{section:modules}.

\subsection{Input data required for the ETKidney simulator}
\label{subsection:input_streams}
Users of the ETKidney simulator have to specify the input streams which define the candidate and donor events. Furthermore, an input stream of international transplantations can be specified, which is used to initialize ETKAS balances and to define balance update events. These input streams can be based on historic data, synthetic data, or combinations thereof.
\par
For candidates and donors, the data in the input streams must include all administrative and medical information required by the eligibility, filtering, and ranking criteria. %The HLA typing for candidates and donors has to be provided in the form of ETRL match determinants \cite{Heidt2024}.
Additional information may be required by the graft offer acceptance module to simulate kidney offer acceptance behavior, and by the post-transplant module to simulate post-transplant survival.
\par 
For candidates, the input streams must include complete information on what would happen to each candidate until they exit the waiting list because of a waiting list removal or a waiting list death. An implication of this requirement is that candidate input streams cannot be solely based on historic registry data: after all, waiting list removals or waiting list deaths are not observed for candidates who were transplanted via ETKAS or ESP.
\par
For simulations done in this paper, we use input streams based on historic data. A counterfactual status imputation procedure is used to impute what would have happened on the waiting list to candidates who were transplanted through ETKAS or ESP. This imputation procedure was modified from a procedure originally devised for development of the ELAS simulator, a simulator developed for Eurotransplant liver allocation \cite{deferranteELASSimulator2023}. In summary, the procedure consists of:
\begin{enumerate}[noitemsep]
	\item constructing a risk set of candidates who are similar to the transplanted candidate in background characteristics and expected remaining survival time, but who are still waiting for a transplantation,
	\item randomly sampling a candidate from this risk set, and copying over their future status updates to the transplanted candidate.
\end{enumerate}
By repeating this procedure, several potential status update trajectories can be constructed for a candidate. We describe this counterfactual status imputation procedure in detail in Appendix \ref{app:imp_proc}.

\subsection{Initialization of the ETKidney simulator's system state}
\label{subsection:initialization}
A simulation settings file is used to specify a simulation start and end date (which jointly define the simulation window), paths to the input streams, and paths where outcomes of the simulation (transplantation, patient states) are written to when the simulation terminates. The system states are initialized based on these simulation settings.
%Certain policy parameters, such as the attributes for which the \WOP\ awards points as well as the number of points awarded, are stored in the simulation settings file to facilitate simulation of ETKAS under alternative point systems.
\par
The balance system is initialized by loading and processing all international transplantations which occurred before the simulation start date from this input stream. Additionally, the simulator schedules a balance update event for cross-border transplantations which occur within the simulation window via combined transplantations or via the AM program. This ensures that ETKAS may be simulated under realistic kidney balances.
\par 
From candidate input streams, the simulator loads all candidates who have an active waiting list status within the simulation window. Listings of repeat transplantation candidates whose initial transplantation falls within the simulation window are excluded, which is necessary to ensure that a candidate cannot simultaneously wait for a primary and repeat transplantation in ETKidney simulation runs. % Post-transplant survival is instead simulated by the post-transplant module (see subsection \ref{section:posttransplant}).
Status updates of candidates which occurred before the simulation start date are processed as part of the initialization procedure, which ensures that the state of candidates coincides with the candidate's actual state on the simulation start date. Finally, for each candidate a single patient event is scheduled in the Future Event Set (FES) timed at the first available status update of the candidate.
\par 
From donor input streams, all donors reported during the simulation window are loaded. For each donor, a donor event is scheduled in the FES on the date the donor was reported to Eurotransplant.

\subsection{Overview of the simulation}
\label{subsection:overview}
Figure \ref{fig:eventhandling_flowchart} illustrates how events are processed in the simulation. Balance events encode an international transplantation external to ETKAS or ESP, and are handled by simply updating the import/export balances of involved countries. Patient events encode a change to the state of a patient, and the simulator handles such events by updating the state of the corresponding candidate. Handling of donor events is more elaborate, because allocation of the kidney(s) through ETKAS or ESP has to be approximated by the simulator.

\begin{figure}[h]
	\centering
	
	%\hspace*{-.05\linewidth}
	\resizebox{1\linewidth}{!}{%
		\includegraphics{figures/fig2-event_handling_flowchart.pdf}
		%
	}
	\caption{Event handling flowchart for the ETKidney simulator. Inputs and parameters are represented using parallelograms. In case a kidney was declined by all candidates, simulation settings determine whether a discard is recorded or whether a candidate is forced to accept the kidney for transplantation. FES: Future Event Set.}
	\label{fig:eventhandling_flowchart}
\end{figure}
\par
To approximate such kidney-only allocation, the ETKidney simulator's \textit{match list module} was developed (see Section \ref{section:match_list_and_matchpoints}). This module first creates, depending on the age of the donor, an unfiltered ETKAS or ESP match list. This match list contains for each candidate who meets the corresponding program's eligibility criteria a \textit{match record}. The ESP / ETKAS match list is automatically ordered based on the respective program's ranking criteria, with the number of points awarded to each match record determined by the \textit{point score module} (see Section \ref{section:match_list_and_matchpoints}). %For ETKAS, the number of points is by default set to the number of points awarded by the \WO\ point system. For ESP, the number of points is set to the waiting time the candidate has accrued, defined based on dialysis. %The parameters for this point score module are stored in the simulation settings, which facilitates evaluation of alternative prioritization policies. %Match lists are automatically sorted based on the program's ranking criteria, which are stored in external files to facilitate evaluation of alternative prioritization policies. 
\par
Based on the ordered match list, the \textit{graft offering} module simulates which candidate accepts the kidney(s) (see Section \ref{section:acceptance}). In rare cases, all candidates who appear on the match list are simulated to decline the kidney offer. In case this happens for an ESP match list, the graft offering module will try to place the kidneys through non-standard ESP allocation (which is how Eurotransplant places kidneys from donors aged 65 and older since March 2021, see Section \ref{subsection:esp}). In the very rare case that kidney(s) remain unplaced, the graft offering module can either (i) record a discard for the kidney(s), or (ii) force transplantation of the candidate who had the highest predicted probability of accepting the offer. For the simulations in this paper, option (ii) is used because the donor input stream used for simulation consists only of donors whose kidneys were actually transplanted through ETKAS and ESP.
\par
Transplantations are then recorded for candidates who were simulated to accept the kidneys, and the kidney balances are updated in case of a cross-border transplantation. The \textit{post-transplant module} simulates post-transplant outcomes for transplant recipients, and schedules for candidates who are simulated to list for repeat transplantation before the simulation termination date a \textit{synthetic re-listing} (see Section \ref{section:synthetic_re-registration}).
\FloatBarrier
\section{Modules of the ETKidney simulator}
\label{sec:modules}
The section describes key modules of the ETKidney simulator: the HLA system module (Section \ref{section:hla_system}), the balance system module (Section \ref{section:balance_system}), the match list and point system module (Section \ref{section:match_list_and_matchpoints}), the graft offering module (Section \ref{section:acceptance}), and the post-transplant module (Section \ref{section:posttransplant}).
\label{section:modules}

\subsection{The HLA system module}
\label{section:hla_system}
The HLA system module implements all mechanisms through which Eurotransplant prioritizes HLA matching. These procedures are (i) determining how many mismatches there are at HLA loci of interest, (ii) calculation of virtual Panel-Reactive Antibodies (vPRA) on the basis of unacceptable antigens, and (iii) calculation of mismatch probability points. 
%\BSil{Are there easy to set alternate options?}
%\HFil{???}
\subsubsection{Calculation of HLA mismatches}
\label{subsection:hla_mm}
The HLA system module can determine for a given patient HLA and given donor HLA how many antigen mismatches there are per locus (0, 1, or 2). At which loci HLA mismatches are to be determined is stored in the simulation settings file. By default, the module only counts mismatches for the HLA-A, -B, and -DR loci, because the current \WOP\ only awards points for such mismatches. HLA-A and HLA-B mismatches are determined at the level of broad antigens, HLA-DR mismatches at the level of split antigens (see \cite{manualKidney}).

\subsubsection{Virtual Panel-Reactive Antibodies (vPRA)}
\label{subsection:vpra}
Transplantation centers can report HLA antigens as unacceptable for their patients. With unacceptable antigens, patients have fewer transplantation opportunities because they will be ineligible for kidney offers from donors with unacceptable antigens. The relative restriction in access is quantified by Eurotransplant with virtual Panel-Reactive Antibodies (vPRA), which is defined as the percentage of the donor pool whose HLA typing includes unacceptable antigens. The vPRA affects a candidate's position on the match list, because the vPRA is used to calculate a candidate's mismatch probability, for which ETKAS awards points. For allocation, the vPRA is quantified against the ETRL donor panel, which is a database of 10,000 donors which were recently reported in the Eurotransplant area, which is maintained by the Eurotransplant Reference Laboratory (ETRL). The HLA system module can also quantify the vPRA against a user-specified input database of 10,000 donor HLAs.

\subsubsection{Calculation of the Eurotransplant mismatch probability (MMP)}
\label{subsection:mmp}
The mismatch probability quantifies for each candidate the chance that among the next 1,000 donors reported to Eurotransplant there is at least one donor who is favorably matched with the candidate. Such a favorably matched donor is defined as a donor who (i) is blood group identical with the candidate, (ii) has no HLAs unacceptable for the candidate, and (iii) has at most 1 HLA-ABDR mismatch with the candidate \cite{wujciakMatchabilityImportantFactor1997}. Eurotransplant calculates this mismatch probability analytically as:
$$\texttt{MMP} = \Big[1 - f_{BG}\cdot (1-\texttt{vPRA})\cdot p_{\leq1mm}\Big]^{1000},$$
where $f_{BG}$ is the candidate's blood group frequency and $p_{\leq1mm}$ is a quantification of the probability that a donor has at most 1 HLA-ABDR mismatch with the candidate. Candidates with a higher mismatch probability thus have relatively fewer favorably matched donors. To compensate candidates for this, the \WOP\ awards points based on this mismatch probability.
\par
We point out that $p_{\leq1mm}$ is calculated analytically based on HLA frequencies \cite{manualKidney}, which ignores haplotype linkage disequilibrium \cite{wujciakMatchabilityImportantFactor1997}. This was implemented as the default option for the HLA system module, but the module can also quantify $p_{\leq1mm}$ by counting the fraction of donors with at most 1 HLA-ABDR mismatch among the same donor pool of 10,000 donors used to calculate vPRAs. We refer to this latter quantity as the \enquote{\textit{1-ABDR HLA mismatch frequency}} (and use this quantity in the second case study, see section \ref{sec:application_vpra}).

\subsection{The balance system module}
\label{section:balance_system}
Eurotransplant's member countries have varying organ donation rates. To ensure that countries with higher organ donation rates also have increased access to transplants, Eurotransplant strives towards a balance in the international exchange of organs. For kidneys, Eurotransplant keeps track of the \textit{net kidney export balances} of the member countries, and awards points in ETKAS based on these balances.\footnote{The number of balance points awarded is calculated by subtracting from each member country's export balance the export balance of the country which is the largest importer (a negative number), and multiplying the outcome by the balance weight} Within Austria, an additional regional balance system exists to ensure that the Austrian centers benefit equally from cross-border transplantations \cite{manualKidney}.
\par
The balance system module implements both these national and regional balance systems for the ETKidney simulator. Initialization of the net exports is possible, and can be based on historic data. By default, separate balances are maintained for each donor age group (0-17 years, 18-49 years, 50-64 years, or 65+), which coincides with the balance system introduced on 01-04-2019 \cite{manualKidney}. %The balance system is necessary to calculate the number of balance points awarded to candidates by the \WOP\ (see Section \ref{section:match_list_and_matchpoints}).


\subsection{The match list module \& point system module}
\label{section:match_list_and_matchpoints}
The match list module is used to create ETKAS or ESP match lists, which serve as input for the graft offering module. Only candidates who meet the corresponding program's eligibility criteria appear on match lists, with the rank of a candidate based on \textit{tiers} and \textit{points}. Candidates ranked in higher tiers receive absolute priority over candidates in lower tiers. Within tiers, candidates are ranked by points. In ETKAS, tiers are in order of descending priority:
\begin{enumerate}[noitemsep]
	\item candidates with 0 HLA-ABDR mismatches with the donor,
	\item offers of pediatric kidneys to pediatric candidates,
	\item all other candidates.
\end{enumerate}
The point system for ETKAS awards:
\begin{enumerate}[noitemsep]
	\item 33.33 points per year of accrued dialysis time,
	\item 400 minus 66.66 points per HLA-ABDR mismatch. These points are doubled if the candidate is pediatric,
	\item 100 points if the candidate is pediatric,
	\item 500 points if the candidate has the High Urgency (HU) status, 
	\item up to 100 mismatch probability points,
	\item balance points, the amount of which is based on net export balances,
	\item up to 300 distance points if the candidate is located in the same country as the donor (the specific amount depends on the country, see \cite{manualKidney}).
\end{enumerate}
\par
ESP has used nine tiers since March 2021, which are defined based on the location of the candidate relative to the donor and whether the candidate is aged 65 and older. Within ESP tiers, points are awarded based on accrued dialysis time (see Appendix \ref{app:allocation rules} and \cite{manualKidney}).

\subsection{The graft offering module}
\label{section:acceptance}
The graft offering module mimics how Eurotransplant offers kidneys to centers for transplantation, and returns based on a match list which candidates accept the kidney for transplantation (if any). How kidney offers are simulated in the ETKidney simulator is illustrated in Figure \ref{fig:flowchart_graft_offering}. To mimic Eurotransplant's allocation process, the module first simulates based on the donor how many offers are maximally made in standard allocation (see Section \ref{subsubsection:extended_or_rescue}). We denote this maximum number of offers by $k$. The module then makes kidney offers to candidates in order of their ranking on the \textit{filtered} match list, either until $k$ offers have been made or until all available kidneys have been accepted for transplantation. How center offer acceptance behavior is simulated is described in Section \ref{subsubsection:two_stage_acceptance}. 
\par 
\begin{figure}[h]
	\centering
	\resizebox{.9\linewidth}{!}{%
		\includegraphics{figures/fig3-graft_offering_diagram.pdf}
		%
	}
	\caption{Summary of how Eurotransplant's kidney offering process is approximated by the ETKidney simulator.}
	\label{fig:flowchart_graft_offering}
\end{figure}
\par
If not all kidneys have been accepted after $k$ offers in standard allocation, the module re-orders match lists with absolute priority for candidates who are located in the vicinity of the donor. This procedure was implemented to approximate the outcomes of non-standard allocation. At this point, the module also makes offers to candidates who appear only on the \textit{unfiltered} match list, because centers can select such candidates in extended and rescue allocation (see Section \ref{subsection:matchlist_allocation}). Offers in non-standard allocation are made until all kidneys have been accepted, or until the match list is exhausted. The module then returns the patients who have accepted the kidneys, as well as how many kidneys were not successfully placed.
\par
In particular circumstances, centers are allowed to accept both kidneys for transplantation. The graft offer acceptance module also simulates whether such dual kidney transplantations are performed when a kidney is accepted (see Section \ref{subsubsection:dkt}).

\subsubsection{Triggering of non-standard allocation}
\label{subsubsection:extended_or_rescue}
The graft offering module switches to non-standard allocation after $k$ declines. We modelled $K$ with a Cox proportional hazards model with adjustment for donor characteristics (donor age, hepatitis, death cause, last creatinine, diabetes, smoking, proteinuria, blood group, and extended donor criteria). Cox models were stratified by the program (ETKAS / ESP), and within ETKAS additionally by the donor country. 
%The number of declines is a proxy for the time taken to make offers and receive responses.
%\BSil{New line, happy with it?}\HFil{I deleted the line, because for kidney, rescue is not based on allocation time but on the number of medical declines (after 5, they switch). Sometimes fewer offers have been made e.g. in case of a late medical rejection so it occurs also after 0-4 offers. But \# offers seems more important than elapsed time for kidney.} The graft offering module counts as a decline (i) declines at the center level, and (ii) declines at the patient level (except when more than five candidates have previously declined the organ within the center).
Default parameters and baseline hazards to simulate from this model are made available with the ETKidney simulator. These parameters were estimated on match lists from 01-01-2014 to 01-01-2024. ESP match lists from before March 2021 were excluded for estimation of these parameters, because 2021 changes to the ESP program (see Section \ref{subsection:esp}) have substantially increased the frequency of non-standard allocation in ESP.

\subsubsection{A two-staged kidney offer acceptance procedure}
\label{subsubsection:two_stage_acceptance}
Transplantation centers frequently decline offers received from Eurotransplant, for instance because of concerns about donor or kidney quality, logistical reasons, or recipient reasons. When centers receive a kidney offer from Eurotransplant in standard allocation for a specific candidate, the center can decide to (i) accept the kidney for the transplantation of the named candidate, (ii) decline the kidney for the named candidate while remaining open for offers to other candidates, or (iii) decline the kidney for the entire center. 
\par 
To approximate this decision-making process in the graft offering module, a two-staged offer acceptance procedure was implemented. This procedure:
\begin{enumerate}[noitemsep]
	\itemsep0em
	\item simulates \textit{center-level} decisions based on donor characteristics (donor death cause, age, last creatinine, blood group, heart-beating or non-heart-beating donation, and extended donor criteria) and center characteristics (country, distance to the donor). These models simulate whether a center is willing to accept the kidney(s) for transplantation for any candidate in the center, and
	\item simulates \textit{patient-level} decisions to determine whether the center accepts a kidney offer for a specific candidate. These decisions are simulated only if the center is willing to accept the donor, and are simulated based on donor characteristics (see above), candidate characteristics (age, pediatric status, HU status, vPRA, dialysis time, prior kidney transplantation), and match characteristics (HLA match, geographic distance, candidate-donor age difference).
\end{enumerate}
Logistic models are used to simulate both these decisions. Because HLA match quality has historically been ignored in ESP and because ESP and ETKAS have different donor and patient populations, we anticipated that kidney offer acceptance behavior would differ between ETKAS and ESP. Therefore, separate models are used to simulate offer acceptance decisions within ETKAS and ESP.
\par
The odds ratios used for simulations are made publicly available with the ETKidney simulator, and were estimated on historic ETKAS / ESP match lists with mixed effect logistic regressions. For ETKAS, odds ratios were estimated on historical data between 01-01-2012 and 01-01-2021. For ESP, odds ratios were estimated between 01-01-2018 to 01-01-2024. We included data from after 2021 to estimate the ESP odds ratios because ESP offers can only be made to candidates younger than 65 and across country borders since March 2021 (see Section \ref{subsection:esp}). Odds ratios were estimated with random effects to account for within-donor, within-candidate and within-center correlations in organ offer acceptance decisions. %To simulate offer acceptance behavior with these random effects, variance components can be specified in simulation input files. \BSil{These are included in the statistical model, to accurately assess tFhe overall effects, but not in the simulation as we did not want to simulate center behaviour, correct?}\HFil{Not the specific values of a center, but one can specify these varaince components. Effects are minor. } \BSil{Are the currently any of these components in the default simulation? If so, based on historical data?}\HFil{Variance component can be entered in the simulation input file settings. I have done all sims with specifying these variance components. E.g., if it's 2 then you draw a random number from N(0,2). Low number would mean that the patient is more risk-averse in this specific simulation run, higher number would mike them more risk-seeking. This number is randomly drawn per simulation run. Overall, it makes not much of a difference (compared it a few months ago) so would rather just leave it be?}\HFil{Maybe i'll just remove the last sentence because it raises questions.}



\subsubsection{Simulation of dual kidney transplantations}
\label{subsubsection:dkt}
Annually, approximately 20 to 30 candidates receive a dual kidney transplantation, which is allowed in specific circumstances (for instance, because of anatomical reasons, see \cite{manualKidney}). The graft offering module simulates whether such a dual kidney transplantation is performed based on donor and patient characteristics (candidate age, donor age, country of listing, and rescue allocation). For this, a logistic model is used. The odds ratios made available with the ETKidney simulator were estimated on kidney offers made between 01-01-2018 and 01-01-2024 where both kidneys were still available for transplantation.

\subsection{The post-transplant module}
\label{section:posttransplant}
In total 13\% of candidates registered on the kidney transplantation waiting list have had a prior kidney transplantation, and nearly 3\% of kidney transplant recipients enlist for a repeat kidney transplantation within 1 year of transplantation \cite{eurotransplantinternationalfoundationWaitingListRegistrations2024}. To simulate such post-transplant survival and listing for repeat transplantation, the post-transplant module was implemented. This module simulates a post-transplant failure time $t$ and potential time-to-relisting $r$ relative to $t$ for each transplant recipient (section \ref{section:failure_and_re-registration_time}). If the candidate is simulated to enlist for a repeat transplantation before the simulation end date, the module creates a synthetic re-listing for transplant recipients who enlist for a repeat transplantation within the simulation window (see section \ref{section:synthetic_re-registration}).

\subsubsection{Simulation of post-transplant failure time and a potential re-listing date}
\label{section:failure_and_re-registration_time}
For each kidney transplantation, the post-transplant module simulates a patient failure time $t$ based on donor characteristics (age, non-heart-beating donation, last creatinine, death cause, extended donor criteria), patient characteristics (age, dialysis time, repeat kidney transplantation, country of listing), and match characteristics (HLA match, acceptance reason, year of transplantation, international transplantation). This failure time is defined as a post-transplant death or a repeat kidney transplantation, whichever occurred first. We modelled $T$ with a Weibull model based on recipient, donor, and transplantation characteristics. Details on this model is included in Appendix \ref{app:posttxp}. The scale and shape parameters supplied with the ETKidney simulator were estimated based on ETKAS and ESP transplantations from 01-01-2011 and 01-01-2021.
\par
Most transplant recipients enlist for a repeat kidney transplantation before a patient failure would materialize. The ETKidney simulator approximates this by also simulating a time-to-relisting $r$. Because a potential re-registration logically has to occur before a patient death or re-transplantation, we simulate the time-to-relisting $r$ based on the empirical distribution of $R$ relative to $T$. We stratified these distributions by candidate age groups and time-until-failure $t$ (details are included in  Appendix \ref{app:posttxp}). 
 %\BSil{This is confusing. Is R a distribution, or a specific time? Why not just use the time $T$ in the first place?} \HFil{re-registration time necessarily has to occur before a failure time? It necessarily has to occur before T, and we indeed draw a number from this distribution.}\HFil{Tried to clarfiy?} 
\subsubsection{Creating synthetic re-listings}
\label{section:synthetic_re-registration}
In case transplant recipients are simulated to enlist for a repeat transplantation before the simulation end date, the post-transplant module creates a \textit{synthetic re-listing} for this candidate. This synthetic re-listing is created by combining the static information from the transplant recipient with the dynamic candidate status updates from an actually re-listed candidate. The actually re-listed candidate is chosen such that they are similar to transplant recipient in terms of background characteristics as well as in time-to-failure $t$. Details on this procedure are included in Appendix \ref{app:posttxp}.
\par
A challenge for creating a synthetic re-listing is that kidney transplantation is a strongly immunizing event \cite{Lopes2015}. Many repeat transplantation candidates will therefore have developed de novo Donor-Specific Antibodies (dnDSAs), which centers can report as unacceptable. Candidates who are listed for repeat transplantation therefore tend to have increased vPRAs and reduced access to kidneys. It is not clear how to simulate such de novo immunization, because (i) HLAs are cross-reactive, which means that centers frequently also report HLAs as unacceptable which were not present in the donor \cite{Lucas2015}, (ii) the immunogenicity of donor HLAs also depends on the patient's own HLA \cite{Lucas2015}, and (iii) HLA laboratories and transplantation centers have different attitudes in labeling HLAs of the initial donor as unacceptable \cite{Ssal2013, Ziemann2022}. 
\par 
Accurate simulation of de novo immunization is thus beyond the scope of the ETKidney simulator. Instead, a very simple procedure was implemented, which is to assume that candidates have a fixed probability of becoming immunized against any mismatched donor antigen. By default, this probability is set to 20\%. This probability was chosen because having one additional mismatch per locus increases the probability of reporting unacceptable antigens against that specific locus on average with 10 to 25\% (depending on the locus) \cite{Isaacson2022}.

\input{validation}

\section{Case studies: the impact of modifying ETKAS allocation rules}
\label{sec:case_studies}
\input{case_studies}

\section{Discussion and conclusion}
\label{sec:discussion}
Eurotransplant recognized the importance of computer simulations for allocation development already in the 1998 one-year evaluation of ETKAS, in which it was stressed that  \textit{\enquote{introduction of a change must be preceded by a computer simulation study}} \cite{demeesterNewEurotransplantKidney1998}. However, Eurotransplant has only recently started the development of tools required for such simulation studies; in 2022, a liver simulator was developed which informed updating of Eurotransplant's liver allocation policy \cite{deferranteELASSimulator2023}, and in 2024, the thoracic committee recommended development of a simulation tool for heart and lung allocation. Within this line of research, we present the ETKidney simulator.
\par
Such simulators are used routinely to update allocation rules in other geographic regions \cite{Pritsker1995,Mumford2018,jacquelinetChangingKidneyAllocation2006a}. The most prominent simulator is the Kidney-Pancreas Simulated Allocation Model (KPSAM), which is developed and maintained by the SRTR U.S. kidney allocation, and publicly available for research. KPSAM differs from the ETKidney simulator in several aspects. Firstly, KPSAM users have to manually specify in simulation inputs when a candidate would list for a repeat transplantation, as well as how their status updates would evolve. In the ETKidney simulator, simulation of re-listings is instead based on historical data. Secondly, graft offer acceptance behavior is simulated according to a single, patient-level logistic regression in KPSAM, whereas the ETKidney simulator additionally includes logistic regressions at the center level to capture that centers regularly decline kidneys for all their candidates. Thirdly, available kidneys are discarded in KPSAM after a fixed number of offers, whereas the ETKidney simulator has functionality to model the maximum number of offers made in standard allocation based on donor characteristics. Once this number is reached, the ETKidney simulator can also switch to non-standard allocation, whereas such out-of-sequence offering is not simulated in KPSAM.
\par 
More important than these technical differences is that the ETKidney simulator is a bespoke model for Eurotransplant, which implements Eurotransplant-specific allocation mechanisms such as mismatch probability points and the balance system. Eurotransplant needs such a bespoke model in communication with national competent authorities, who are interested not only in the overall effects of policies, but also in the specific effects that a policy change has on their national waiting list population. 
\par 
To build trust in the simulator, we have used input-output validation to show that the simulator can closely approximate contemporary transplantation patterns of ETKAS and ESP. Results of this validation exercise were discussed with medical doctors from Eurotransplant, and presented at the Eurotransplant Annual Meeting to other major stakeholders, such as nephrologists, immunologists, and transplantation coordinators from the Eurotransplant's kidney transplantation centers, as well as representatives from the national competent authorities. In the views many of these stakeholders, the simulator has become a useful tool for kidney allocation policy development.
\par
We acknowledge that the ETKidney simulator also has limitations. Firstly, the graft offer acceptance and post-transplant survival models are calibrated to historical data. These models may lack external validity for future post-transplant survival and future offer acceptance behavior. An example of this, encountered during input-output validation, is that the simulator appears to underestimate the number of transplantations in immunized candidates after introduction of the virtual crossmatch in January 2023. This limitation could be addressed by refitting the organ acceptance models in the future on more contemporary data. A second limitation validation was only based on historic input-output validation. Ideally, we would have been able to also observe ETKAS and ESP outcomes under alternative sets of allocation rules, and study whether the simulator would be able to capture simulated outcomes under these alternative rules \cite{sargent2020}. However, this was not feasible because ETKAS and ESP allocation rules have changed little since their introductions in 1996 and 1999, respectively. A final limitation is that Eurotransplant is not allowed to publicly release information which could potentially identify its donors and candidates, which precludes exact reproduction of our simulations by external parties. We have tried to address this limitation by making synthetic data available, on which kidney allocation could be simulated.
\par
Overall, we are confident that the ETKidney simulator is a valuable tool for quantifying the impact of kidney allocation policy changes in Eurotransplant, as we demonstrated with three clinical case studies. We anticipate that the simulator can play a pivotal role in modernizing ETKAS and ESP allocation rules, in collaboration with subject-matter experts from ETKAC, ETRL, and national competent authorities.

\newpage


%%%%% References %%%%%%
\newpage
\bibliography{refs}
\newpage

%%%%%%%%% Appendices %%%%%%%%
\appendix
\renewcommand\thefigure{\thesection\arabic{figure}}
\renewcommand{\thetable}{\Alph{section}\arabic{table}}
\setcounter{figure}{0}
\setcounter{table}{0}
% \input{appendices}

\section{ETKAS and ESP Allocation Rules} 
\label{app:allocation rules}
\input{allocation_rules}


\section{Details to the future status update imputation procedure}
\label{app:imp_proc}
\setcounter{table}{0}
\input{future_status_imputation}

\section{Simulating post-transplant mortality and re-listing and re-transplantations}
\label{app:posttxp}
\setcounter{table}{0}
\input{posttransplantmodule}
\newpage
\section{Supplementary Tables}
\label{app:supp}


\begin{table}[h]
	\caption{Input-output validation of the number of transplantations by vPRA, before and after introduction of the virtual crossmatch on 24-01-2023.}
	\resizebox{\linewidth}{!}{
	\input{tables/validation/2025-01-09/tb_vxm.tex}
	}
	\label{tab:vpra_vxm}
\end{table}


\begin{table}[h]
	\caption{Input-output validation of the number of transplantations of ESP donors in candidates aged below 65 by country.}
	\resizebox{\linewidth}{!}{
		\input{tables/validation/2025-01-09/tb_esp.tex}
	}
	\label{tab:esp}
\end{table}

\end{document} 