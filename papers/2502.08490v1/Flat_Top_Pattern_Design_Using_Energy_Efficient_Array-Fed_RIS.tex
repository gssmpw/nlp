%\documentclass[conference]{IEEEtran}
%\documentclass[a4]{IEEEtran}
\documentclass[a4,journal]{IEEEtran}
%\documentclass[lettersize,journal]{IEEEtran}
\usepackage{amsmath,amssymb,dsfont,stfloats,color,url,mathtools}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows}
\tikzstyle{startstop} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm,text centered, draw=black, fill=red!30]
\tikzstyle{process} = [rectangle, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=blue!30]
\tikzstyle{decision} = [diamond, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=green!30]
\tikzstyle{arrow} = [thick,->,>=stealth]
\usepackage[]{graphicx}
\usepackage{wasysym,esint}
%\usepackage{subfigure}
\usepackage{cite}
\usepackage{caption}
\usepackage{subcaption}
%\captionsetup{compatibility=false}
\usepackage{gensymb} 
%\usepackage{natbib} 
%\usepackage{algorithm2e}
\usepackage[boxruled,linesnumbered]{algorithm2e}
\usepackage{algorithm2e}
%\usepackage[retainorgcmds]{IEEEtrantools}
\usepackage{lipsum}
%\usepackage [latin1]{inputenc}
%\textheight=230mm
%\textwidth=185mm
%\hoffset=-10mm

\DeclareGraphicsExtensions{.eps,.pdf,.png,.jpg,.gif,.jpeg,.pstex}
%\input{epsf.sty}
%\usepackage[pdftex]{epsfig}
% definitions.
% --------------------
\newtheorem{thm}{Theorem}
\newtheorem{prop}{Proposition}
\newtheorem{lem}{Lemma}
\newtheorem{cor}{Corollary}
\newtheorem{ex}{Example}
\newtheorem{proper}{Property}
\newtheorem{defi}{Definition}
\newtheorem{rem}{Remark}
\newtheorem{example}{Example}
\newtheorem{fact}{Fact}
\DeclareMathOperator*{\argmax}{arg\,max}
%\DeclareMathOperator{\taninv}{tan\,inverse}
\newcommand{\taninv}{\tan^{-1}}

%\usepackage{fancyhdr}
%\pagestyle{fancy}
%\lhead{This work has been submitted to the IEEE for possible publication. \\Copyright may be transferred without notice, after which this version may no longer be %accessible.}

\input{macros}

\renewcommand{\arg}{{\rm arg}}

\title{Flat-Top Beamforming with Efficient Array-Fed RIS}

\author{\IEEEauthorblockN{Krishan Kumar Tiwari\IEEEauthorrefmark{1}, \emph{Senior Member, IEEE}, and Giuseppe Caire\IEEEauthorrefmark{1}, \emph{Fellow, IEEE}} \thanks{\IEEEauthorrefmark {1}Technical University of Berlin, Germany. Email ids: lastname@tu-berlin.de. 
Work of G. Caire was supported by BMBF Germany in the program of ``Souver√§n. Digital. Vernetzt.'' Joint Project 6G-RIC (Project IDs 16KISK030).
}}

\begin{document}

\bstctlcite{BSTcontrol} 

%\date{10 November 2021}
\maketitle
%\thispagestyle{fancy}

\begin{abstract}
Flat-top beam designs are essential for uniform power distribution over a wide angular sector for applications such as 5G/6G networks, satellite communications, radar systems, etc. Low sidelobe levels with steep transitions allow negligible cross sector illumination. Active array designs requiring amplitude taper suffer from poor power amplifier utilization. Phase only designs, e.g., Zadoff-Chu or generalized step chirp polyphase sequence methods, often require large active antenna arrays which in turns increases the hardware complexity and reduces the energy efficiency. In our recently proposed novel array-fed reflective intelligent surface (RIS) architecture, the small ($2 \times 2$) active array has uniform (principal eigenmode) amplitude weighting. We now present a pragmatic flat-top pattern design method for practical array (RIS) sizes, which outperforms current state-of-the-art in terms of design superiority, energy efficiency, and deployment feasibility. This novel design holds promise for advancing sustainable wireless technologies in next-generation communication systems while mitigating the environmental impact of high-energy antenna arrays.
\end{abstract} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{IEEEkeywords}
Flat-top beam shaping, array-fed RIS, hardware- and energy-efficient antenna array architectures, pragmatic designs.
\end{IEEEkeywords}

%\vspace{-0.5cm}
\section{Introduction}  
\label{sec:intro}

\IEEEPARstart{F}{lat} top power radiation patterns from antenna arrays have been a subject of intense research for several decades. Finite impulse response (FIR) filter based techniques for active arrays \cite{firpm} require amplitude taper across the active array, which in turn means poor power amplifier (PA) utilization and lower energy efficiency. Therefore, phase-only techniques have been proposed \cite{GSC} which work well for large active arrays, in the sense that the passband ripple is not very attractive for small to medium array sizes, e.g., we get about 6-7 dB ripple for $40$ elements linear and 14 dB for $40 \times 40 ~(= 1600)$ planar configurations! However, very large active arrays are not very energy efficient due to the fact that the PA output power of individual antenna elements becomes very low, requiring the use of power splitting networks with their own insertion losses! 

The energy efficiency would be the best if we could use uniformly weighted small active arrays (for good PA utilization) and at the same time the enhanced gain, degrees-of-freedom, and agile performance capabilities of larger antenna arrays. In this direction, we had proposed passive (reflect/transmit)arrays (a.k.a. reflective intelligent surfaces (RIS)) fed by a small active multi-antenna feeder (AMAF) \cite{VTC2022, ICC2023, VTC2024, SPAWC2024}, see Fig. \ref{fig:sysmo}. Recall that due to the inherent symmetry of the center feed geometry, the $2 \times 2$ AMAF principal eigenmode will always be the (practically) uniform weighting for maximum AMAF-RIS power transfer, resulting in the best PA utilization. The AMAF-RIS matrix $\Tm \in \CC^{N_p \times N_a}$ is given by
\begin{equation}
\label{eq:T}
\centering
T_{n,m} = \frac{\sqrt{E_A(\theta_{n,m})E_R(\phi_{n,m}})~ \exp(j\pi r_{n,m})}{2\pi r_{n,m}},
\end{equation}
where $E_A, ~E_R, ~\theta_{n,m},~ \phi_{n,m}, ~ \text{and}~r_{n,m}$ are AMAF element power radiation pattern, RIS element power radiation pattern, angle of departure from an AMAF element $m$ to a RIS element $n$ measured from the AMAF element boresight, angle of arrival from the AMAF element $m$ to the RIS element $n$ measured from the RIS element boresight, and the distance (normalized by $\lambda/2$) between the AMAF element $m$ and the RIS element $n$, respectively, and $j=\sqrt{-1}$.

%\vspace{-12pt}
\begin{figure}[t!]
\centerline{\includegraphics[width=8.25cm]{ICCF.pdf}}
	\caption{RIS fed by an AMAF placed in its near field. $F/D < 1$.}
	\label{fig:sysmo}
\end{figure}

The synthesis of flat-top beams from such an AMAF-RIS architecture is a very difficult problem due to the following constraints: i) the passive RIS elements have only phase control and no amplitude control, ii) the principal eigenmode (PEM) profile at the RIS (both amplitude and phase) depends on the F/D ratio, is obtained from the singular value decomposition (SVD) of the AMAF-RIS propagation matrix $\Tm$, and therefore cannot be represented in closed form, iii) the PEM amplitude taper \cite[Fig. 2]{ICC2023} makes it difficult to apply algebraic phase-only techniques \cite{GSC} for constant modulus polyphase sequences, and iv) from a mathematical optimization vantage point, it's a very high-dimensional, non-convex, non-trivial problem with very low probability of success, in the sense that useless local optima are far more numerous than useful local optima!

In Section \ref{sec:flat_top_beam_design}, we present a pragmatic method for getting the RIS phases for obtaining flat-top beams from AMAF-RIS principal eigenmode\footnote{Note that any joint AMAF-RIS optimization which deviates from the PEM leads to a loss in the AMAF-RIS power transfer. Therefore, the PEM is recommended to maintain the maximum AMAF-RIS power transfer.}, which are a good starting point for further improved flat-top beams using mathematical optimization. In Section \ref{sec:examples}, we present full 3D design examples and ground footprints of beam so obtained for (pico)cellular applications. Section \ref{sec:ee_comp} provides the energy efficiency comparison against active arrays. Section \ref{sec:CONC} concludes the paper.

%{\bf Mathematical Notations:} $\mathbb{R}$ and $\mathbb{C}$ denote the sets of all real and all complex numbers, respectively. $\text{x}^*$ denotes conjugate of a complex scalar, $\|\xv\|$ is the Euclidean norm of a vector $\xv$, $[\cdot]^{\circ2}$ denotes Hadamard (elementwise) square, $[\cdot]^\transp$ is transpose, $[\cdot]^\herm$ is the Hermitian transpose, $|\xv|$ and $\angle \xv$ denote vectors containing the magnitudes and the angles (phases) of the elements in $\xv$, respectively. $|\Xm|$ is a matrix containing the magnitudes of the elements in $\Xm$, and $\text{diag}(\xv)$ denotes a square diagonal matrix whose diagonal elements are given by $\xv$. $\lceil . \rceil$ denotes the ceiling function. $j=\sqrt{-1}.$ %All lengths/distances are normalized by $\lambda/2$, unless specified otherwise.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Pragmatic Design of Flat-Top Beams} 
\label{sec:flat_top_beam_design}

In order to mitigate the difficulty due to the high-dimension, non-convex nature of the problem for planar arrays, we obtain the phase-only beamforming weights for standard linear arrays (SLAs) and then use the straightforward Kronecker product for planar array designs, and thus recommend to tackle the problem in the lower-dimensional space of linear arrays instead of dealing directly with the complexity of planar arrays as in \cite{ghanem2022optimization}. 

The proposed sequential method has the following steps:
\begin{enumerate}
    \item For linear AMAF ($N_a=2$) and RIS ($N_p=40$) arrays, choose the F/D ratio such that the PEM magnitude taper is suitable, e.g., matches well to the envelope/main lobe of
the amplitude profile obtained from a flat-top beam shape obtained from ``firpm'' based design for active arrays. For example, typically
F/D = 0.235.
   \item Evenly about the RIS center, choose suitable RIS elements groupings for binary phases ($0$ or $\pi$ rad), e.g., nearest integer to 0.15 to 0.18 of the linear size $N_p$. We denote this vector as $\wv_{\rm binary}$. This will yield a flat-top beam. In general, the width of the so obtained flat-top beam is not widely tunable because expansion in one Fourier domain is compression in another Fourier domain and vice versa. The RIS taper is fixed for a given F/D ratio.
   \item Use the beam widening function \cite{R1-1611929, R1-1700772} or equivalently the phase perturbation function (PPF)
\begin{equation} \label{eq:phase_perturbation_function}
    f(n) = \left| 4 \pi c \left( \frac{0.5}{N_p-1} + \frac{n - 0.5N_p}{N_p-1} \right)^p \right|,
\end{equation}
where $c$, $N_p$, and $n \in [0,N_p-1]$ are the scaling parameter for the phase perturbation, the number of antenna elements, and the antenna element index, respectively. The parameter $p$ controls the exponent power applied to the position-dependent term. The beam broadening vector $\wv_{\rm PPF}$ is then
\begin{equation} \label{eq:widening_phases}
w_{\rm PPF}(n) = \exp(jf(n)). %\exp (jf(n)). e^{j f(n)}
\end{equation}
In \eqref{eq:phase_perturbation_function}, increasing $c$ results in a broader beam for a fixed $p$, whereas decreasing $p$ widens the beam for a fixed $c$.
Thus, the linear RIS phase configuration (for the template flat-top beam at the boresight) is obtained as 
\begin{equation} \label {eq:linear_RIS_phases}
 \wv = \wv_{\rm PPF} \odot \wv_{\rm binary} \odot \widetilde{\wv},
\end{equation}
where $\widetilde{\wv}=\left [ \exp(-j \angle \uv_1) \right ]$ is a vector of phase shifts such that $|\uv_1|=\widetilde{\wv} \odot \uv_1 \in \RR_+^{N_p}$, $\odot$ is Hadamard (elementwise) product, $\angle \uv_1$ is the vector of phases of $\uv_1$, $\exp$ is applied componentwise, 
and $\uv_1$ is first column vector of $\Um \in \CC^{N_p \times N_p}$ obtained from the SVD of $\Tm=\Um\Sm\Vm^\herm$.% where $\Um \in \CC^{N_p \times N_p}$ and $\Vm \in \CC^{N_a \times N_a}$ are unitary matrices and $\Sm \in \CC^{N_p \times N_a}$ is a diagonal matrix containing ordered singular values $\sigma_1, \sigma_2, \twodots, \sigma_{N_a}$. 

Steps 1 to 3 provide an indispensable sequence of steps to obtain flat-top beam shapes with steep main lobe transition and low sidelobes. Furthermore, $\wv$ so obtained serves as a good starting point for the mathematical optimization algorithm in \cite{ghanem2022optimization}. We have verified that any violation of these steps 1-3, i.e., any other initialization does not seem to work.

\item The optimization algorithm in \cite{ghanem2022optimization} can be used to obtain optimized phase-only vectors $\wv_{\rm opt}$ for further improved beam shapes. In particular, it is possible to tune the flat-top beam width by specifying the optimization grid boundary. The only difference in our case from \cite{ghanem2022optimization} is that we consider the linear arrays and the array gain takes into account the principal eigenmode taper $|\uv_1|$, which is the vector containing the magnitudes of the elements of $\uv_1$ as seen in Fig. \ref{fig:step1}. Note that the given modulus constraint $|\uv_1|$ (principal eigenmode) makes the problem more difficult and non-trivial compared to constant modulus problems! For example, there is no specific restriction on the initial starting point for constant modulus problems as evident from the random initialization in \cite[Algorithm 1, step 1]{ghanem2022optimization}.

\end{enumerate}

\section{Design Examples} 
\label{sec:examples}

\subsection{Linear Arrays}

\begin{figure}[h!]
\centerline{\includegraphics[width=7cm]{firpm_ref.pdf}}
	\caption{Matching RIS PEM magnitude  profile to that from ``firpm'' FIR filter for flat top beam shape.}
	\label{fig:step1}
\end{figure}

Step 1: We consider standard linear array RIS with $N_p=40$ elements fed by a standard linear array AMAF with $N_a = 2$ elements at the focal length $F=9.4$. The resulting RIS magnitude profile is shown in Fig. \ref{fig:step1}.

\begin{figure*}[ht] \vspace{-0.3cm}
    \centering
 \begin{subfigure}[b]{0.428\textwidth}
        \includegraphics[width=\textwidth]{Step_2_Step_3.pdf}
        \caption{Flat top beams obtained from steps 2 and 3.}
        \label{fig:step2}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.451\textwidth}
        \includegraphics[width=\textwidth]{Post_Opt_Wide_Narrow.pdf}
        \caption{Tunable width flat top beams obtained from optimization.}
        \label{fig:step4}
    \end{subfigure}
    \caption{Comparison of beam patterns: (a) beams from steps 2 and 3, and (b) tunable width flat-top beams from step 4.}
    \label{fig:combined}
\end{figure*}
\begin{figure}[t]
    \centering
   
\end{figure}

Step 2: Choose suitable groupings of RIS elements for binary phases, e.g., in this example the grouping of 7 RIS elements with $\wv_{\rm binary}= [1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,\\
  1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1]^\transp$ has been empirically chosen to obtain the beam shape shown in Fig. \ref{fig:step2} for binary phases.

%\begin{figure}[h!]
%\centerline{\includegraphics[width=8cm]{Step_2_Step_3.pdf}}
%	\caption{Flat top beams obtained from steps 2 and 3.}
%	\label{fig:step2}
%\end{figure}

Step 3: Apply the PPF obtained from \eqref{eq:phase_perturbation_function} and \eqref{eq:widening_phases} with $c=2$ and $p=1$ to obtain the widened flat top beam of Fig. \ref{fig:step2}.

Step 4: Use the optimization algorithm of \cite{ghanem2022optimization} to obtain tunable width flat-top beams as shown in Fig. \ref{fig:step4}, where we see that the passband ripple is only 1.2 dB and 0.3 dB for the wider and narrower beam shapes, respectively. Such results are not generally obtainable from \cite{GSC} because the array length tends to infinity for smooth (continuous) passbands for Zadoff-Chu or generalized step-chirp sequences. We also get better sidelobes than \cite{GSC}. 

%\begin{figure}[h!]
%\centerline{\includegraphics[width=8cm]{Post_Opt_Wide_Narrow.pdf}}
%	\caption{Tunable width flat top beams obtained from optimization with the initialization from step 3 result, the wider and the narrower beams are optimized for $+/- 22.5\degree$ and $+/-11.5\degree$, respectively.}
%	\label{fig:step4}
%\end{figure}

\begin{rem} \label{rem1}
When the desired flat-top sector is discretized with 5 grid points, we do not get a useful result even though the optimization algorithm converges. However, when the sector is discretized with 15 grid points, we get the useful results, shown above, in just three iterations. Furthermore, any other initialization does not seem to provide a good, useful optimization result.  \hfill $\lozenge$
\end{rem}

\subsection{Planar Arrays and Ground Footprints}

\begin{figure*}[hb!] \vspace{0cm}
    \centering
    \begin{subfigure}[b]{0.32\textwidth}
        \includegraphics[width=5cm]{No_Opt_Widening.pdf}
        \caption{Confined flat top beam from Step 2}
        \label{fig:confined_step_2}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.32\textwidth}
        \includegraphics[width=5cm]{Opt_Widening_Az.pdf}
        \caption{Az. widened flat top beam from Step 4}
        \label{fig:azimuth_step_4}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.32\textwidth}
        \includegraphics[width=5cm]{Opt_Widening_El.pdf}
        \caption{El. widened flat top beam from Step 4}
        \label{fig:elevation_step_4}
    \end{subfigure}
    \caption{Ground footprints of flat-top beams from steps 2 and 4}
    \label{fig:gnd_flat_tops}
\vspace{0cm} \end{figure*}

The phase values for the planar $40 \times 40$ RIS fed by $2 \times 2$ AMAF at the $F=9.4$ is obtained by the straightforward Kronecker product of any desired combinations of $\wv$, $\wv_{\rm PPF}\odot\wv_{\rm binary}\odot \widetilde{\wv}$, or $\wv_{\rm binary}\odot \widetilde{\wv}$, e.g., if we want to widen the flat-top beam in both azimuth and elevation, only in the azimuth, or only in the elevation.
Denoting the azimuth and the elevation beamforming vectors as $\wv_{\rm az}$ and $\wv_{\rm el}$, the full planar RIS beamforming weight matrix is $\Wm = \wv_{\rm el} \wv_{\rm az}^\herm$. Using the picocell specifications of \cite[Section IV]{SPAWC2024} with the only difference of RIS size $40 \times 40$ and the focal length $F=9.4$, Fig. \ref{fig:gnd_flat_tops} shows ground footprints of flat-top beams obtained from $(\wv_{\rm binary}\odot \widetilde{\wv})(\wv_{\rm binary}\odot \widetilde{\wv})^\herm$ , $(\wv_{\rm binary}\odot \widetilde{\wv}) \wv_{\rm opt}^\herm$, and $\wv_{\rm opt} (\wv_{\rm binary}\odot \widetilde{\wv})^\herm$ in Figs. \ref{fig:confined_step_2}, \ref{fig:azimuth_step_4}, and \ref{fig:elevation_step_4}, respectively.

\section{Energy Efficiency Comparison}  
\label{sec:ee_comp}

We now present an energy efficiency comparison for the case where we obtain the same flat-top beam gain from an active array with the constant modulus constraint \cite{GSC} and from the proposed AMAF-RIS configuration with the given modulus constraint of the principal eigenmode (i.e., $|\uv_1|$ which is the vector containing the magnitudes of the elements of $\uv_1$ as seen in Fig. \ref{fig:step1}). For the running example from \cite[Section IV]{SPAWC2024}, let us take the RF power of $P_{\rm RF}=20~{\rm dBm}$.

For the AMAF-RIS architecture, $\vv_1=[0.5, 0.5, 0.5,0.5]$. Hence, the maximum AMAF PA output power  
is given by $P^{(1)}_{\rm pa-max}={\rm max}|v_{1i}|^2P_{\rm RF}=-6~\text{dB}+20~\text{dBm}=14~\text{dBm}=25.1~\text{mW}$. We assume that all the PAs in the (AMAF) array are developed in the same semiconductor technology, and are all biased with the same DC power dictated by the maximum requested RF power. Considering Indium Phosphide (InP) PAs with efficiency $\eta=0.3$ \cite{ETH_PA_Survey, PAlimits},  the AMAF-RIS DC power consumption, $P^{(1)}_{\rm DC} = N_a P^{(1)}_{\rm pa-max}/\eta = 4 \times 25.1~\text{mW}/0.3 = 335~\text{mW}$.

For the $40 \times 40$ active array, uniform element weight, $1/1600=-32~{\rm dB}$. PA output power, $P^{(2)}_{\rm pa-too-low} = 20~{\rm dBm}-~32\text{dB}=-12~\text{dBm}$, which is too low! Therefore, we consider a power splitter network with two stages of 4-way splitters, each output of which is fed to another splitter network with two stages of 10-way splitter, with each stage having a nominal insertion loss of 1 dB, i.e., the combined insertion loss of the overall power split is 4 dB. 
Thus, the splitter network input-to-per-output-port power ratio, $\Lc = 4 + 32 = 36~{\rm dB}$. This is driven by a single PA with requested RF power $P^{(2)}_{\rm pa}/\Lc=P^{(2)}_{\rm pa-too-low}$ giving $P^{(2)}_{\rm pa}=-12~\text{dBm}+36~\text{dB}=24~\text{dBm}=251.2~\text{mW}$.
It follows that the constant modulus active array DC power consumption, $P^{(2)}_{\rm DC} = P^{(2)}_{\rm pa}/\eta=251.2~\text{mW}/0.3=837~\text{mW}>335~\text{mW}=P^{(1)}_{\rm DC}$. Thus, for the same flat-top beam gain and the same link budget, the AMAF-RIS scheme is significantly more energy efficient than constant modulus active arrays (which in turn have obviously better PA utilization and power efficiency than power tapered active arrays).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\vspace{-0.4cm}
\section{Conclusion}  
\label{sec:CONC}
%\vspace{-0.2cm}

We presented a pragmatic flat-top beam shaping method for the AMAF-RIS (or, equivalently, array-fed array) architecture. It achieves better beam shapes for moderate (RIS) array sizes than active arrays using polyphase sequences. The proposed method avoids the challenges associated with high-dimensional and non-convex optimization. Also, by virtue of the fact that the AMAF active array is of minimal size and uniformly weighted, the AMAF-RIS scheme is more energy efficient than constant modulus active arrays for the same system requirements, contributing to the evolution of sustainable and high-performance wireless connectivity.  


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\vspace{-0.5cm}
\bibliographystyle{IEEEtran} 
\bibliography{WD-bibliography}

\end{document} 