\begin{figure*}[t]
    \centering
    \includegraphics[width=0.99\textwidth]{figures/overview_4.pdf}
    \vspace{-2mm}
    \caption{Overview of \model: \model\ first processes raw  points on a trajectory $T$ into multi-grained sub-views and generates sub-view embeddings $\mathbf{X}$ by a Sub-view Encoder. The embeddings are fed into a Trajectory Encoder to generate embeddings $\mathbf{h}$. \model\ is optimized by the MSE loss $\mathcal{L}_{mse}$ and our $k$NN-guided loss $\mathcal{L}_{knn}$, learning both exact similarity values and relative similarity between trajectories.}\label{fig:overview}
    \vspace{-2mm}
\end{figure*}


\section{Preliminaries}\label{sec:preliminary}



\paragraph{Trajectory}
A trajectory $T= [p_1, p_2, \cdots, p_n]$ is a sequence of $n$ location points, where $p_i$ is the $i$-th point (represented by a pair of coordinates), and
$\overline{p_i p_j}$ is the segment from $p_i$ to $p_j$.

\paragraph{Trajectory Similarity Query}
Given a trajectory dataset $\mathcal{D}$, a query trajectory $T_q$, and query parameter $k$, and a trajectory similarity measure $f$, a trajectory similarity query (a.k.a. trajectory $k$NN query) returns a set $\mathcal{S} \subseteq \mathcal{D}$ with $|\mathcal{S}| = k$ such that $\forall T\in\mathcal{S}$ and $\forall T'\in\mathcal{D}\setminus \mathcal{S}, f(T, T_q) \geqslant f(T', T_q)$. 


\paragraph{Problem Statement}
Given a trajectory similarity measure $f$ and a trajectory dataset $\mathcal{D}$, our aim is to learn a trajectory encoder model $g: T \rightarrow \textbf{h}$, where $\textbf{h} \in \mathbb{R}^d$ is a $d$-dimensional embedding vector, with the following two \emph{Goals}:

(1)~For trajectories $T_i, T_j \in \mathcal{D}$, the difference between the ground-truth similarity value $f(T_i, T_j)$ and the predicted value by the model $f'(T_i, T_j)$ is minimized, where $f'(T_i, T_j) = 1- \text{dist}(g(T_i), g(T_j))$ and
$\text{dist}(\cdot)$ is a simple distance metric such as $L_1$ or $L_2$ norm distances.

(2)~For any $T_i \in \mathcal{D}$ as the query trajectory, the difference between the ground-truth trajectory similarity query result set $\mathcal{S}$ and the computed result set $\mathcal{S}'$ is minimized, 
where $\mathcal{S}'$ is obtained by applying $f'$ as the similarity measure.

\paragraph{Discussion}
Existing studies mainly focus on Goal~1, i.e., minimizing the errors in similarity approximation. 
However, such a training goal does not provide sufficient signals for trajectory similarity learning. Based on the similarity values, we further exploit Goal~2 to learn the relative similarity between trajectories for more accurate similarity approximation.

