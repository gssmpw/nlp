\section{Full Results of Failure Case}\label{app:failure case}
\begin{figure*}[!t]
\begin{center}
\includegraphics[width=0.5\textwidth]{figs/accuracy_comparison.pdf}
\end{center}
  \vspace{-.1in}\caption{Average absolute accuracy for all methods across 44 ID-OOD dataset pairs. The red dashed line indicates the performance of ZS-CLIP.
}
  \label{fig:absolute_acc}
  \vspace{-10pt}
\end{figure*}

Besides evaluating different TTA methods using the rank distribution in Figure~\ref{fig:violin}, we also evaluate them using the absolute accuracy in Figure~\ref{fig:absolute_acc}. Most TTA methods perform worse than ZS-CLIP under the ZS-NTTA setting, and our method still performs best.


\subsection{Three Model Adaptation Pipelines}\label{app:failure case-classification}
Table~\ref{app:failure_case_study_cifar100_acc} and Table~\ref{app:failure_case_study_others_CUB} presents the performance of the three model adaptation pipelines using different datasets as the ID.  
For comprehensive evaluation, we also include AUROC and FPR95 metrics for different datasets in Table~\ref{app:failure_case_study_cifar_auc} and Table~\ref{app:failure_case_study_others}. Higher AUROC and lower FPR95 scores indicate superior performance. Note that AUROC and FPR95 cannot be calculated at test-time and can only be determined after evaluating all samples.
The above results show that for most datasets, the model performance degrades as the number of noisy samples used for model updates increases.

\begin{table}[th!]
\caption{Failure case study of existing TTA methods with CIFAR-100 as ID dataset. \textcolor{teal}{Green} indicates an improvement over ZS-CLIP in average $\text{Acc}_\text{H}$, while \textcolor{red}{red} indicates the opposite.}\label{app:failure_case_study_cifar100_acc}
\centering{
\setlength\tabcolsep{5pt} 
\resizebox{\linewidth}{!}{
\begin{tabular}{lccc|ccc|ccc|ccc|ccc}
\toprule
\multirow{2}*{Method}&\multicolumn{3}{c}{SVHN}&\multicolumn{3}{c}{LSUN}&\multicolumn{3}{c}{Texture}&\multicolumn{3}{c}{Places}&\multicolumn{3}{c}{Avg}\\
\cmidrule{2-16}
&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$\\
\cmidrule(lr){2-4}\cmidrule(lr){5-7}\cmidrule(lr){8-10}\cmidrule(lr){11-13}\cmidrule(lr){14-16}
ZS-CLIP
& 48.52 & 97.58 & 64.81 & 49.29 & 94.97 & 64.90 & 46.76 & 81.58 & 59.45 & 45.36 & 64.52 & 53.27 & 47.48 & 84.66 & 60.61\\
Tent~(GT)
& 62.11 & 92.92 & 74.45 & 61.28 & 89.73 & 72.83 & 60.24 & 80.42 & 68.88 & 58.55 & 65.11 & 61.66 & 60.55 & 82.05 & 69.45~\textcolor{teal}{(+8.85\%)}\\
Tent~(Normal)
& 55.39 & 42.41 & 48.04 & 60.06 & 83.37 & 69.82 & 59.31 & 79.13 & 67.80 & 57.52 & 62.24 & 59.79 & 58.07 & 66.79 & 61.36~\textcolor{teal}{(+0.75\%)}\\
Tent~(All-update)
& 52.41 & 29.85 & 38.04 & 54.74 & 59.92 & 57.21 & 58.91 & 75.83 & 66.31 & 57.98 & 61.08 & 59.49 & 56.01 & 56.67 & 55.26~\textcolor{red}{(-5.35\%)}\\
SoTTA~(GT)
& 61.28 & 94.23 & 74.26 & 60.64 & 91.56 & 72.96 & 59.37 & 81.91 & 68.84 & 57.49 & 66.47 & 61.65 & 59.70 & 83.54 & 69.43~\textcolor{teal}{(+8.82\%)}\\
SoTTA~(Normal)
& 60.56 & 89.24 & 72.15 & 60.28 & 88.89 & 71.84 & 58.79 & 81.56 & 68.33 & 57.01 & 65.73 & 61.06 & 59.16 & 81.36 & 68.34~\textcolor{teal}{(+7.74\%)}\\
SoTTA~(All-update)
& 60.77 & 89.61 & 72.42 & 60.23 & 88.37 & 71.64 & 58.93 & 81.48 & 68.39 & 57.17 & 65.93 & 61.24 & 59.28 & 81.35 & 68.42~\textcolor{teal}{(+7.81\%)}\\
TPT~(GT)
& 54.07 & 98.11 & 69.72 & 54.77 & 95.52 & 69.62 & 52.32 & 82.86 & 64.14 & 51.20 & 67.43 & 58.20 & 53.09 & 85.98 & 65.42~\textcolor{teal}{(+4.81\%)}\\
TPT~(Normal)
& 46.09 & 97.87 & 62.67 & 46.90 & 95.36 & 62.88 & 43.87 & 83.10 & 57.42 & 42.48 & 66.86 & 51.95 & 44.84 & 85.80 & 58.73~\textcolor{red}{(-1.88\%)}\\
TPT~(All-update)
& 52.35 & 84.64 & 64.69 & 53.84 & 87.67 & 66.71 & 51.01 & 62.39 & 56.13 & 49.87 & 39.74 & 44.23 & 51.77 & 68.61 & 57.94~\textcolor{red}{(-2.67\%)}\\
\bottomrule
\end{tabular}}
}
\end{table}


\begin{table}[th!]
\caption{Failure case study of existing TTA methods. \textcolor{teal}{Green} indicates an improvement over ZS-CLIP in average $\text{Acc}_\text{H}$, while \textcolor{red}{red} indicates the opposite.}\label{app:failure_case_study_others_CUB}
\centering{
\setlength\tabcolsep{5pt} 
\resizebox{\linewidth}{!}{
\begin{tabular}{llccc|ccc|ccc|ccc|ccc}
\toprule
\multirow{2}*{ID}&\multirow{2}*{Method}&\multicolumn{3}{c}{iNaturalist}&\multicolumn{3}{c}{SUN}&\multicolumn{3}{c}{Texture}&\multicolumn{3}{c}{Places}&\multicolumn{3}{c}{Avg}\\
\cmidrule{3-17}
&&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$&$\text{Acc}_\text{S}$&$\text{Acc}_\text{N}$&$\text{Acc}_\text{H}$\\
\cmidrule(lr){3-5}\cmidrule(lr){6-8}\cmidrule(lr){9-11}\cmidrule(lr){12-14}\cmidrule(lr){15-17}
\multirow{10}*{CUB-200-2011}
& ZS-CLIP
& 38.13 & 88.06 & 53.22 & 38.10 & 87.86 & 53.15 & 37.56 & 79.11 & 50.94 & 38.00 & 87.81 & 53.04 & 37.95 & 85.71 & 52.59\\
& Tent~(GT)
& 42.98 & 84.67 & 57.02 & 43.46 & 87.74 & 58.13 & 43.19 & 80.96 & 56.33 & 43.27 & 87.02 & 57.80 & 43.23 & 85.10 & 57.32~\textcolor{teal}{(+4.73\%)}\\
& Tent~(Normal)
& 37.02 & 46.95 & 41.40 & 38.61 & 55.55 & 45.56 & 34.98 & 41.77 & 38.07 & 40.41 & 74.83 & 52.48 & 37.75 & 54.78 & 44.38~\textcolor{red}{(-8.21\%)}\\
& Tent~(All-update)
& 32.90 & 28.23 & 30.39 & 34.95 & 46.81 & 40.02 & 34.11 & 43.92 & 38.40 & 36.27 & 57.90 & 44.60 & 34.56 & 44.22 & 38.35~\textcolor{red}{(-14.23\%)}\\
& SoTTA~(GT)
& 42.16 & 86.33 & 56.65 & 42.63 & 88.67 & 57.58 & 42.45 & 82.75 & 56.11 & 42.48 & 88.48 & 57.40 & 42.43 & 86.56 & 56.93~\textcolor{teal}{(+4.35\%)}\\
& SoTTA~(Normal)
& 41.67 & 84.37 & 55.79 & 42.08 & 86.83 & 56.69 & 41.44 & 77.58 & 54.02 & 42.04 & 86.52 & 56.59 & 41.81 & 83.82 & 55.77~\textcolor{teal}{(+3.19\%)}\\
& SoTTA~(All-update)
& 41.69 & 84.24 & 55.78 & 41.98 & 86.77 & 56.58 & 41.30 & 77.12 & 53.79 & 41.86 & 86.49 & 56.42 & 41.71 & 83.66 & 55.64~\textcolor{teal}{(+3.05\%)}\\
& TPT~(GT)
& 48.38 & 90.78 & 63.12 & 48.48 & 91.00 & 63.26 & 48.29 & 82.99 & 61.05 & 48.53 & 90.42 & 63.16 & 48.42 & 88.80 & 62.65~\textcolor{teal}{(+10.06\%)}\\
& TPT~(Normal)
& 37.41 & 89.57 & 52.78 & 37.49 & 89.67 & 52.87 & 36.88 & 81.67 & 50.81 & 37.44 & 89.45 & 52.79 & 37.30 & 87.59 & 52.31~\textcolor{red}{(-0.27\%)}\\
& TPT~(All-update)
& 46.67 & 65.10 & 54.37 & 46.34 & 64.86 & 54.06 & 46.69 & 58.51 & 51.94 & 46.62 & 64.55 & 54.14 & 46.58 & 63.25 & 53.63~\textcolor{teal}{(+1.04\%)}\\

\midrule

\multirow{10}*{STANFORD-CARS}
& ZS-CLIP
& 50.25 & 96.59 & 66.11 & 53.28 & 98.81 & 69.23 & 53.49 & 99.09 & 69.48 & 53.22 & 98.08 & 69.00 & 52.56 & 98.14 & 68.45\\
& Tent~(GT)
& 52.14 & 95.00 & 67.33 & 55.22 & 98.21 & 70.69 & 55.42 & 98.25 & 70.87 & 55.16 & 97.48 & 70.45 & 54.48 & 97.23 & 69.83~\textcolor{teal}{(+1.38\%)}\\
& Tent~(Normal)
& 44.12 & 52.33 & 47.88 & 54.27 & 94.51 & 68.95 & 54.60 & 97.37 & 69.97 & 54.33 & 96.65 & 69.56 & 51.83 & 85.22 & 64.09~\textcolor{red}{(-4.36\%)}\\
& Tent~(All-update)
& 41.25 & 40.75 & 41.00 & 42.71 & 54.01 & 47.70 & 39.10 & 33.10 & 35.85 & 44.96 & 66.23 & 53.56 & 42.01 & 48.52 & 44.53~\textcolor{red}{(-23.93\%)}\\
& SoTTA~(GT)
& 52.20 & 95.86 & 67.59 & 55.05 & 98.39 & 70.60 & 55.19 & 98.64 & 70.78 & 55.02 & 97.74 & 70.41 & 54.37 & 97.66 & 69.84~\textcolor{teal}{(+1.39\%)}\\
& SoTTA~(Normal)
& 51.51 & 92.84 & 66.26 & 54.81 & 97.57 & 70.19 & 55.06 & 98.50 & 70.64 & 54.75 & 96.96 & 69.98 & 54.03 & 96.47 & 69.27~\textcolor{teal}{(+0.81\%)}\\
& SoTTA~(All-update)
& 51.32 & 92.79 & 66.09 & 54.75 & 97.66 & 70.16 & 55.08 & 98.50 & 70.65 & 54.70 & 96.78 & 69.90 & 53.96 & 96.43 & 69.20~\textcolor{teal}{(+0.75\%)}\\
& TPT~(GT)
& 58.16 & 97.52 & 72.86 & 60.08 & 99.00 & 74.78 & 59.81 & 99.26 & 74.64 & 59.81 & 98.50 & 74.43 & 59.47 & 98.57 & 74.18~\textcolor{teal}{(+5.72\%)}\\
& TPT~(Normal)
& 49.24 & 96.97 & 65.31 & 52.40 & 98.83 & 68.49 & 52.75 & 99.27 & 68.89 & 52.42 & 98.39 & 68.40 & 51.70 & 98.36 & 67.77~\textcolor{red}{(-0.68\%)}\\
& TPT~(All-update)
& 55.90 & 81.32 & 66.26 & 58.08 & 89.74 & 70.52 & 59.00 & 95.38 & 72.90 & 58.13 & 90.14 & 70.68 & 57.78 & 89.14 & 70.09~\textcolor{teal}{(+1.64\%)}\\

\midrule

\multirow{10}*{Food-101}
& ZS-CLIP
& 80.63 & 94.79 & 87.14 & 80.72 & 95.98 & 87.69 & 80.50 & 93.10 & 86.34 & 80.65 & 94.59 & 87.07 & 80.62 & 94.62 & 87.06\\
& Tent~(GT)
& 83.30 & 91.89 & 87.38 & 83.41 & 93.33 & 88.09 & 83.22 & 90.78 & 86.84 & 83.33 & 91.95 & 87.43 & 83.31 & 91.99 & 87.44~\textcolor{teal}{(+0.38\%)}\\
& Tent~(Normal)
& 75.83 & 25.09 & 37.70 & 82.86 & 85.10 & 83.97 & 82.54 & 87.03 & 84.73 & 82.26 & 80.13 & 81.18 & 80.87 & 69.34 & 71.90~\textcolor{red}{(-15.16\%)}\\
& Tent~(All-update)
& 74.39 & 21.10 & 32.88 & 71.45 & 55.31 & 62.35 & 71.60 & 56.89 & 63.40 & 74.72 & 52.35 & 61.57 & 73.04 & 46.41 & 55.05~\textcolor{red}{(-32.01\%)}\\
& SoTTA~(GT)
& 82.49 & 93.22 & 87.53 & 82.63 & 94.93 & 88.35 & 82.42 & 91.52 & 86.73 & 82.59 & 93.40 & 87.66 & 82.53 & 93.27 & 87.57~\textcolor{teal}{(+0.51\%)}\\
& SoTTA~(Normal)
& 81.84 & 84.09 & 82.95 & 82.49 & 93.34 & 87.58 & 82.05 & 90.10 & 85.89 & 82.44 & 91.62 & 86.79 & 82.20 & 89.79 & 85.80~\textcolor{red}{(-1.26\%)}\\
& SoTTA~(All-update)
& 81.59 & 82.76 & 82.17 & 82.47 & 92.98 & 87.41 & 81.99 & 89.35 & 85.51 & 82.34 & 91.25 & 86.57 & 82.10 & 89.09 & 85.41~\textcolor{red}{(-1.64\%)}\\
& TPT~(GT)
& 84.36 & 95.11 & 89.41 & 84.42 & 96.24 & 89.94 & 84.32 & 93.55 & 88.70 & 84.43 & 95.02 & 89.41 & 84.38 & 94.98 & 89.37~\textcolor{teal}{(+2.31\%)}\\
& TPT~(Normal)
& 79.70 & 94.93 & 86.65 & 79.92 & 96.19 & 87.30 & 79.70 & 93.86 & 86.20 & 79.76 & 95.14 & 86.77 & 79.77 & 95.03 & 86.73~\textcolor{red}{(-0.33\%)}\\
& TPT~(All-update)
& 83.60 & 71.41 & 77.03 & 83.79 & 80.42 & 82.07 & 83.84 & 81.36 & 82.58 & 83.95 & 78.85 & 81.32 & 83.80 & 78.01 & 80.75~\textcolor{red}{(-6.31\%)}\\

\midrule

\multirow{10}*{Oxford-IIIT Pet}
& ZS-CLIP
& 78.58 & 88.31 & 83.16 & 79.77 & 87.26 & 83.35 & 80.12 & 91.17 & 85.29 & 79.56 & 84.30 & 81.86 & 79.51 & 87.76 & 83.42\\
& Tent~(GT)
& 81.15 & 86.49 & 83.73 & 82.16 & 86.05 & 84.06 & 82.38 & 89.99 & 86.02 & 82.01 & 83.45 & 82.72 & 81.92 & 86.49 & 84.13~\textcolor{teal}{(+0.72\%)}\\
& Tent~(Normal)
& 80.07 & 78.09 & 79.07 & 81.19 & 68.30 & 74.19 & 81.48 & 74.72 & 77.95 & 80.64 & 62.51 & 70.43 & 80.84 & 70.91 & 75.41~\textcolor{red}{(-8.01\%)}\\
& Tent~(All-update)
& 77.58 & 70.76 & 74.01 & 79.32 & 62.61 & 69.98 & 78.60 & 61.46 & 68.98 & 79.02 & 54.96 & 64.83 & 78.63 & 62.45 & 69.45~\textcolor{red}{(-13.97\%)}\\
& SoTTA~(GT)
& 80.72 & 86.37 & 83.45 & 82.09 & 86.37 & 84.18 & 82.51 & 90.42 & 86.28 & 81.79 & 83.47 & 82.62 & 81.78 & 86.66 & 84.13~\textcolor{teal}{(+0.72\%)}\\
& SoTTA~(Normal)
& 80.07 & 83.54 & 81.77 & 81.78 & 83.83 & 82.79 & 82.09 & 87.52 & 84.72 & 81.49 & 81.25 & 81.37 & 81.36 & 84.03 & 82.66~\textcolor{red}{(-0.75\%)}\\
& SoTTA~(All-update)
& 79.96 & 83.52 & 81.70 & 81.55 & 83.63 & 82.58 & 81.97 & 87.64 & 84.71 & 81.37 & 81.28 & 81.32 & 81.21 & 84.02 & 82.58~\textcolor{red}{(-0.84\%)}\\
& TPT~(GT)
& 83.39 & 89.99 & 86.56 & 83.96 & 88.41 & 86.13 & 83.82 & 92.31 & 87.86 & 83.83 & 85.41 & 84.61 & 83.75 & 89.03 & 86.29~\textcolor{teal}{(+2.88\%)}\\
& TPT~(Normal)
& 77.56 & 89.71 & 83.19 & 78.87 & 89.82 & 83.99 & 79.17 & 92.26 & 85.22 & 78.62 & 87.32 & 82.74 & 78.56 & 89.78 & 83.78~\textcolor{teal}{(+0.37\%)}\\
& TPT~(All-update)
& 82.77 & 58.09 & 68.27 & 83.43 & 62.39 & 71.39 & 83.26 & 70.69 & 76.46 & 83.13 & 59.06 & 69.06 & 83.15 & 62.56 & 71.30~\textcolor{red}{(-12.12\%)}\\

\midrule
\multirow{10}*{ImageNet}
& ZS-CLIP
& 54.01 & 86.46 & 66.49 & 53.32 & 83.87 & 65.19 & 52.66 & 78.69 & 63.10 & 53.25 & 80.40 & 64.07 & 53.31 & 82.35 & 64.71\\
& Tent~(GT)
& 56.15 & 79.49 & 65.81 & 55.93 & 78.31 & 65.25 & 55.34 & 72.69 & 62.84 & 55.81 & 75.31 & 64.11 & 55.81 & 76.45 & 64.50~\textcolor{red}{(-0.21\%)}\\
& Tent~(Normal)
& 48.56 & 35.74 & 41.18 & 55.44 & 75.54 & 63.95 & 54.94 & 70.93 & 61.92 & 55.76 & 73.98 & 63.59 & 53.67 & 64.05 & 57.66~\textcolor{red}{(-7.05\%)}\\
& Tent~(All-update)
& 48.08 & 31.28 & 37.90 & 53.25 & 72.27 & 61.32 & 54.25 & 68.27 & 60.46 & 54.27 & 72.20 & 61.96 & 52.46 & 61.00 & 55.41~\textcolor{red}{(-9.30\%)}\\
& SoTTA~(GT)
& 55.51 & 75.20 & 63.87 & 55.32 & 75.54 & 63.87 & 54.91 & 73.13 & 62.72 & 55.25 & 73.63 & 63.13 & 55.25 & 74.38 & 63.40~\textcolor{red}{(-1.32\%)}\\
& SoTTA~(Normal)
& 53.15 & 62.68 & 57.52 & 53.16 & 68.76 & 59.96 & 53.64 & 68.05 & 59.99 & 53.60 & 69.16 & 60.39 & 53.39 & 67.16 & 59.47~\textcolor{red}{(-5.25\%)}\\
& SoTTA~(All-update)
& 53.06 & 61.97 & 57.17 & 52.89 & 67.70 & 59.39 & 53.59 & 66.80 & 59.47 & 53.00 & 68.06 & 59.59 & 53.14 & 66.13 & 58.91~\textcolor{red}{(-5.81\%)}\\
& TPT~(GT)
& 61.95 & 88.28 & 72.81 & 61.81 & 85.44 & 71.73 & 61.26 & 80.43 & 69.55 & 61.54 & 82.33 & 70.43 & 61.64 & 84.12 & 71.13~\textcolor{teal}{(+6.42\%)}\\
& TPT~(Normal)
& 52.58 & 88.93 & 66.09 & 51.91 & 86.09 & 64.77 & 51.11 & 80.01 & 62.38 & 51.80 & 82.89 & 63.76 & 51.85 & 84.48 & 64.25~\textcolor{red}{(-0.46\%)}\\
& TPT~(All-update)
& 60.85 & 61.41 & 61.13 & 60.97 & 62.85 & 61.90 & 60.33 & 57.91 & 59.10 & 60.70 & 61.99 & 61.34 & 60.71 & 61.04 & 60.87~\textcolor{red}{(-3.85\%)}\\

\midrule

\multirow{10}*{ImageNet-K}
& ZS-CLIP
& 34.14 & 83.35 & 48.44 & 33.32 & 81.16 & 47.24 & 32.66 & 75.53 & 45.60 & 33.37 & 77.12 & 46.58 & 33.37 & 79.29 & 46.97\\
& Tent~(GT)
& 37.40 & 75.98 & 50.13 & 37.14 & 75.43 & 49.77 & 36.39 & 68.41 & 47.51 & 37.07 & 72.19 & 48.99 & 37.00 & 73.00 & 49.10~\textcolor{teal}{(+2.13\%)}\\
& Tent~(Normal)
& 30.46 & 26.86 & 28.55 & 36.57 & 71.82 & 48.46 & 36.37 & 66.63 & 47.06 & 36.87 & 70.32 & 48.38 & 35.07 & 58.91 & 43.11~\textcolor{red}{(-3.85\%)}\\
& Tent~(All-update)
& 31.15 & 28.84 & 29.95 & 35.38 & 69.67 & 46.93 & 35.94 & 65.09 & 46.31 & 36.00 & 69.07 & 47.33 & 34.62 & 58.17 & 42.63~\textcolor{red}{(-4.34\%)}\\
& SoTTA~(GT)
& 37.69 & 72.29 & 49.55 & 37.60 & 75.21 & 50.14 & 36.93 & 70.68 & 48.51 & 37.51 & 71.81 & 49.28 & 37.43 & 72.50 & 49.37~\textcolor{teal}{(+2.40\%)}\\
& SoTTA~(Normal)
& 36.18 & 61.70 & 45.61 & 36.28 & 67.19 & 47.12 & 35.91 & 65.31 & 46.34 & 36.57 & 67.09 & 47.34 & 36.23 & 65.32 & 46.60~\textcolor{red}{(-0.36\%)}\\
& SoTTA~(All-update)
& 35.49 & 59.76 & 44.53 & 36.29 & 66.56 & 46.97 & 35.96 & 63.72 & 45.97 & 36.38 & 66.50 & 47.03 & 36.03 & 64.13 & 46.12~\textcolor{red}{(-0.84\%)}\\
& TPT~(GT)
& 39.52 & 86.67 & 54.29 & 39.34 & 83.88 & 53.56 & 38.95 & 78.30 & 52.02 & 39.21 & 80.42 & 52.72 & 39.26 & 82.32 & 53.15~\textcolor{teal}{(+6.18\%)}\\
& TPT~(Normal)
& 32.16 & 86.52 & 46.89 & 31.55 & 83.86 & 45.85 & 30.74 & 77.39 & 44.00 & 31.56 & 80.05 & 45.27 & 31.50 & 81.95 & 45.50~\textcolor{red}{(-1.46\%)}\\
& TPT~(All-update)
& 38.25 & 59.33 & 46.51 & 38.45 & 60.41 & 46.99 & 37.96 & 54.98 & 44.91 & 38.33 & 59.67 & 46.68 & 38.25 & 58.60 & 46.27~\textcolor{red}{(-0.69\%)}\\

\midrule

\multirow{10}*{ImageNet-A}
& ZS-CLIP
& 34.73 & 80.69 & 48.56 & 34.20 & 78.83 & 47.70 & 33.97 & 76.60 & 47.07 & 33.96 & 75.11 & 46.77 & 34.22 & 77.81 & 47.53\\
& Tent~(GT)
& 35.51 & 79.29 & 49.05 & 34.99 & 77.60 & 48.23 & 34.75 & 75.80 & 47.65 & 34.73 & 74.24 & 47.32 & 34.99 & 76.73 & 48.06~\textcolor{teal}{(+0.55\%)}\\
& Tent~(Normal)
& 34.99 & 77.19 & 48.15 & 34.83 & 77.05 & 47.97 & 34.36 & 75.19 & 47.17 & 34.60 & 73.83 & 47.12 & 34.70 & 75.81 & 47.60~\textcolor{teal}{(+0.09\%)}\\
& Tent~(All-update)
& 34.85 & 77.48 & 48.08 & 34.07 & 76.71 & 47.18 & 33.72 & 74.89 & 46.50 & 34.11 & 73.75 & 46.65 & 34.19 & 75.71 & 47.10~\textcolor{red}{(-0.41\%)}\\
& SoTTA~(GT)
& 37.09 & 78.79 & 50.44 & 36.73 & 77.72 & 49.88 & 36.25 & 76.52 & 49.19 & 36.37 & 74.36 & 48.85 & 36.61 & 76.85 & 49.59~\textcolor{teal}{(+2.06\%)}\\
& SoTTA~(Normal)
& 36.85 & 76.83 & 49.81 & 36.47 & 77.08 & 49.51 & 35.60 & 75.37 & 48.36 & 36.07 & 73.87 & 48.47 & 36.25 & 75.79 & 49.04~\textcolor{teal}{(+1.51\%)}\\
& SoTTA~(All-update)
& 36.87 & 76.93 & 49.85 & 36.55 & 77.00 & 49.57 & 35.80 & 75.08 & 48.48 & 36.37 & 73.79 & 48.72 & 36.40 & 75.70 & 49.16~\textcolor{teal}{(+1.63\%)}\\
& TPT~(GT)
& 45.37 & 82.39 & 58.52 & 44.60 & 80.80 & 57.47 & 44.67 & 79.19 & 57.12 & 44.45 & 77.51 & 56.50 & 44.77 & 79.97 & 57.40~\textcolor{teal}{(+9.88\%)}\\
& TPT~(Normal)
& 34.12 & 81.17 & 48.04 & 33.20 & 80.23 & 46.97 & 33.12 & 79.92 & 46.83 & 33.05 & 77.00 & 46.25 & 33.37 & 79.58 & 47.02~\textcolor{red}{(-0.50\%)}\\
& TPT~(All-update)
& 43.31 & 56.05 & 48.86 & 43.05 & 53.93 & 47.88 & 43.68 & 58.71 & 50.09 & 42.99 & 52.81 & 47.40 & 43.26 & 55.38 & 48.56~\textcolor{teal}{(+1.03\%)}\\
\midrule

\multirow{10}*{ImageNet-V2}
& ZS-CLIP
& 48.05 & 85.77 & 61.59 & 47.43 & 83.33 & 60.45 & 46.72 & 77.70 & 58.35 & 47.45 & 79.44 & 59.41 & 47.41 & 81.56 & 59.95\\
& Tent~(GT)
& 48.89 & 82.71 & 61.45 & 48.16 & 80.94 & 60.39 & 47.54 & 75.31 & 58.29 & 48.14 & 77.72 & 59.45 & 48.18 & 79.17 & 59.89~\textcolor{red}{(-0.06\%)}\\
& Tent~(Normal)
& 47.94 & 76.98 & 59.08 & 48.28 & 80.50 & 60.36 & 47.56 & 74.47 & 58.05 & 48.34 & 77.37 & 59.50 & 48.03 & 77.33 & 59.25~\textcolor{red}{(-0.70\%)}\\
& Tent~(All-update)
& 47.51 & 73.10 & 57.59 & 47.52 & 79.52 & 59.49 & 47.47 & 73.93 & 57.82 & 47.87 & 76.55 & 58.90 & 47.59 & 75.78 & 58.45~\textcolor{red}{(-1.50\%)}\\
& SoTTA~(GT)
& 48.80 & 82.74 & 61.39 & 48.23 & 80.61 & 60.35 & 47.63 & 76.11 & 58.59 & 48.22 & 77.03 & 59.31 & 48.22 & 79.12 & 59.91~\textcolor{red}{(-0.04\%)}\\
& SoTTA~(Normal)
& 48.24 & 78.59 & 59.78 & 47.80 & 78.67 & 59.47 & 47.27 & 74.82 & 57.94 & 48.26 & 76.05 & 59.05 & 47.89 & 77.03 & 59.06~\textcolor{red}{(-0.89\%)}\\
& SoTTA~(All-update)
& 48.06 & 78.74 & 59.69 & 47.71 & 78.64 & 59.39 & 47.49 & 74.42 & 57.98 & 48.10 & 75.97 & 58.90 & 47.84 & 76.94 & 58.99~\textcolor{red}{(-0.96\%)}\\
& TPT~(GT)
& 55.52 & 87.89 & 68.05 & 55.37 & 85.12 & 67.10 & 54.95 & 79.99 & 65.15 & 55.44 & 81.84 & 66.10 & 55.32 & 83.71 & 66.60~\textcolor{teal}{(+6.65\%)}\\
& TPT~(Normal)
& 46.63 & 88.37 & 61.05 & 46.12 & 85.58 & 59.94 & 45.21 & 79.14 & 57.55 & 46.02 & 81.95 & 58.94 & 46.00 & 83.76 & 59.37~\textcolor{red}{(-0.58\%)}\\
& TPT~(All-update)
& 54.50 & 60.62 & 57.40 & 54.65 & 62.15 & 58.16 & 54.00 & 56.35 & 55.15 & 54.46 & 61.48 & 57.76 & 54.40 & 60.15 & 57.12~\textcolor{red}{(-2.83\%)}\\

\midrule

\multirow{10}*{ImageNet-R}
& ZS-CLIP
& 61.96 & 94.43 & 74.82 & 61.77 & 88.98 & 72.92 & 60.92 & 77.08 & 68.05 & 61.69 & 84.81 & 71.43 & 61.59 & 86.33 & 71.81\\
& Tent~(GT)
& 65.48 & 92.13 & 76.55 & 65.32 & 86.94 & 74.60 & 64.63 & 75.81 & 69.77 & 65.17 & 82.68 & 72.89 & 65.15 & 84.39 & 73.45~\textcolor{teal}{(+1.65\%)}\\
& Tent~(Normal)
& 65.22 & 91.45 & 76.14 & 65.06 & 85.61 & 73.93 & 63.33 & 69.99 & 66.49 & 64.93 & 82.38 & 72.62 & 64.64 & 82.36 & 72.30~\textcolor{teal}{(+0.49\%)}\\
& Tent~(All-update)
& 64.66 & 90.75 & 75.52 & 63.73 & 84.00 & 72.47 & 62.22 & 67.19 & 64.61 & 64.30 & 81.49 & 71.88 & 63.73 & 80.86 & 71.12~\textcolor{red}{(-0.69\%)}\\
& SoTTA~(GT)
& 67.58 & 91.75 & 77.83 & 67.66 & 86.68 & 76.00 & 66.98 & 76.52 & 71.43 & 67.45 & 82.49 & 74.22 & 67.42 & 84.36 & 74.87~\textcolor{teal}{(+3.06\%)}\\
& SoTTA~(Normal)
& 66.78 & 86.98 & 75.55 & 66.71 & 83.99 & 74.36 & 65.92 & 72.69 & 69.14 & 66.60 & 80.53 & 72.91 & 66.50 & 81.05 & 72.99~\textcolor{teal}{(+1.19\%)}\\
& SoTTA~(All-update)
& 66.63 & 85.68 & 74.96 & 66.90 & 83.64 & 74.34 & 65.92 & 71.65 & 68.67 & 66.63 & 80.06 & 72.73 & 66.52 & 80.26 & 72.68~\textcolor{teal}{(+0.87\%)}\\
& TPT~(GT)
& 70.39 & 95.01 & 80.87 & 70.24 & 89.87 & 78.85 & 69.81 & 77.91 & 73.64 & 70.24 & 85.76 & 77.23 & 70.17 & 87.14 & 77.65~\textcolor{teal}{(+5.84\%)}\\
& TPT~(Normal)
& 60.95 & 94.80 & 74.20 & 60.85 & 89.98 & 72.60 & 59.98 & 77.79 & 67.73 & 60.67 & 85.79 & 71.08 & 60.61 & 87.09 & 71.40~\textcolor{red}{(-0.40\%)}\\
& TPT~(All-update)
& 69.10 & 72.12 & 70.58 & 69.14 & 66.38 & 67.73 & 68.64 & 56.45 & 61.95 & 68.85 & 63.42 & 66.02 & 68.93 & 64.59 & 66.57~\textcolor{red}{(-5.24\%)}\\

\bottomrule
\end{tabular}}
}
\end{table}



\begin{table}[th!]
\caption{Failure case study of existing TTA methods with CIFAR-10/100 as ID datasets. \textcolor{teal}{Green} indicates an improvement over ZS-CLIP in average $\text{Acc}_\text{H}$, while \textcolor{red}{red} indicates the opposite.}\label{app:failure_case_study_cifar_auc}
\centering{
\setlength\tabcolsep{5pt} 
\resizebox{\linewidth}{!}{
\begin{tabular}{llcc|cc|cc|cc|cc}
\toprule
\multirow{2}*{ID}&\multirow{2}*{Method}&\multicolumn{2}{c}{SVHN}&\multicolumn{2}{c}{LSUN}&\multicolumn{2}{c}{Texture}&\multicolumn{2}{c}{Places}&\multicolumn{2}{c}{Avg}\\
\cmidrule{3-12}
&&AUROC$\uparrow$&FPR95$\downarrow$&AUROC$\uparrow$&FPR95$\downarrow$&AUROC$\uparrow$&FPR95$\downarrow$&AUROC$\uparrow$&FPR95$\downarrow$&AUROC$\uparrow$&FPR95$\downarrow$\\
\cmidrule(lr){3-4}\cmidrule(lr){5-6}\cmidrule(lr){7-8}\cmidrule(lr){9-10}\cmidrule(lr){11-12}
\multirow{10}*{CIFAR-10}
& ZS-CLIP
& 98.45  & 6.75 & 97.75  & 10.64 & 94.75  & 28.08 & 87.47  & 50.18 & 94.60 & 23.91\\
& Tent~(GT)
& 99.17  & 3.55 & 98.37  & 8.28 & 97.36  & 12.99 & 92.25  & 31.91 & 96.79~\textcolor{teal}{(+2.18\%)} & 14.18~\textcolor{teal}{(-9.73\%)}\\
& Tent~(Normal)
& 74.35  & 50.27 & 89.47  & 31.18 & 96.85  & 15.95 & 87.75  & 45.57 & 87.10~\textcolor{red}{(-7.50\%)} & 35.74~\textcolor{red}{(+11.83\%)}\\
& Tent~(All-update)
& 62.78  & 65.12 & 73.23  & 54.20 & 95.80  & 22.24 & 82.53  & 56.35 & 78.59~\textcolor{red}{(-16.02\%)} & 49.48~\textcolor{red}{(+25.56\%)}\\
& SoTTA~(GT)
& 99.24  & 3.13 & 98.51  & 7.24 & 97.44  & 11.89 & 92.17  & 31.41 & 96.84~\textcolor{teal}{(+2.24\%)} & 13.42~\textcolor{teal}{(-10.50\%)}\\
& SoTTA~(Normal)
& 95.77  & 20.74 & 97.57  & 11.68 & 97.27  & 13.02 & 91.43  & 33.91 & 95.51~\textcolor{teal}{(+0.91\%)} & 19.84~\textcolor{teal}{(-4.08\%)}\\
& SoTTA~(All-update)
& 93.29  & 30.24 & 97.46  & 12.79 & 97.21  & 13.76 & 91.47  & 33.75 & 94.86~\textcolor{teal}{(+0.25\%)} & 22.63~\textcolor{teal}{(-1.28\%)}\\
& TPT~(GT)
& 99.28  & 3.07 & 98.93  & 4.61 & 96.94  & 14.88 & 91.21  & 35.75 & 96.59~\textcolor{teal}{(+1.98\%)} & 14.58~\textcolor{teal}{(-9.34\%)}\\
& TPT~(Normal)
& 98.48  & 6.76 & 97.61  & 10.67 & 94.19  & 28.26 & 85.37  & 50.18 & 93.91~\textcolor{red}{(-0.69\%)} & 23.97~\textcolor{red}{(+0.05\%)}\\
& TPT~(All-update)
& 98.28  & 7.50 & 96.15  & 23.66 & 91.20  & 50.48 & 81.46  & 69.41 & 91.77~\textcolor{red}{(-2.83\%)} & 37.76~\textcolor{red}{(+13.85\%)}\\

\midrule

\multirow{10}*{CIFAR-100}
& ZS-CLIP
& 85.11  & 86.42 & 85.88  & 72.58 & 71.09  & 95.35 & 58.47  & 98.97 & 75.14 & 88.33\\
& Tent~(GT)
& 92.11  & 40.90 & 89.09  & 52.30 & 82.14  & 67.79 & 72.01  & 87.97 & 83.84~\textcolor{teal}{(+8.70\%)} & 62.24~\textcolor{teal}{(-26.09\%)}\\
& Tent~(Normal)
& 46.39  & 79.90 & 84.91  & 62.45 & 80.28  & 73.90 & 68.92  & 91.80 & 70.12~\textcolor{red}{(-5.01\%)} & 77.01~\textcolor{teal}{(-11.32\%)}\\
& Tent~(All-update)
& 37.15  & 94.38 & 63.31  & 80.78 & 77.80  & 79.30 & 68.91  & 91.43 & 61.79~\textcolor{red}{(-13.35\%)} & 86.47~\textcolor{teal}{(-1.86\%)}\\
& SoTTA~(GT)
& 92.29  & 41.42 & 89.60  & 51.31 & 81.96  & 69.89 & 71.43  & 89.36 & 83.82~\textcolor{teal}{(+8.68\%)} & 63.00~\textcolor{teal}{(-25.33\%)}\\
& SoTTA~(Normal)
& 88.72  & 51.10 & 87.95  & 54.48 & 81.45  & 70.58 & 70.60  & 90.18 & 82.18~\textcolor{teal}{(+7.04\%)} & 66.59~\textcolor{teal}{(-21.74\%)}\\
& SoTTA~(All-update)
& 88.99  & 49.96 & 87.76  & 55.49 & 81.40  & 71.23 & 70.66  & 89.85 & 82.20~\textcolor{teal}{(+7.06\%)} & 66.63~\textcolor{teal}{(-21.70\%)}\\
& TPT~(GT)
& 88.66  & 76.97 & 89.25  & 63.17 & 76.87  & 90.57 & 66.27  & 97.82 & 80.26~\textcolor{teal}{(+5.12\%)} & 82.13~\textcolor{teal}{(-6.20\%)}\\
& TPT~(Normal)
& 84.80  & 86.43 & 85.37  & 72.58 & 69.62  & 95.34 & 55.59  & 98.97 & 73.84~\textcolor{red}{(-1.29\%)} & 88.33~\textcolor{teal}{(0.00\%)}\\
& TPT~(All-update)
& 75.97  & 94.94 & 82.55  & 81.02 & 62.82  & 95.60 & 48.79  & 98.87 & 67.53~\textcolor{red}{(-7.61\%)} & 92.61~\textcolor{red}{(+4.28\%)}\\
\bottomrule
\end{tabular}}
}
\end{table}


\begin{table}[th!]
\caption{Failure case study of existing TTA methods. \textcolor{teal}{Green} indicates an improvement over ZS-CLIP in average $\text{Acc}_\text{H}$, while \textcolor{red}{red} indicates the opposite.}\label{app:failure_case_study_others}
\centering{
\setlength\tabcolsep{5pt} 
\resizebox{\linewidth}{!}{
\begin{tabular}{llcc|cc|cc|cc|cc}
\toprule
\multirow{2}*{ID}&\multirow{2}*{Method}&\multicolumn{2}{c}{SVHN}&\multicolumn{2}{c}{LSUN}&\multicolumn{2}{c}{Texture}&\multicolumn{2}{c}{Places}&\multicolumn{2}{c}{Avg}\\
\cmidrule{3-12}
&&AUROC$\uparrow$&FPR95$\downarrow$&AUROC$\uparrow$&FPR95$\downarrow$&AUROC$\uparrow$&FPR95$\downarrow$&AUROC$\uparrow$&FPR95$\downarrow$&AUROC$\uparrow$&FPR95$\downarrow$\\
\cmidrule(lr){3-4}\cmidrule(lr){5-6}\cmidrule(lr){7-8}\cmidrule(lr){9-10}\cmidrule(lr){11-12}
\multirow{10}*{CUB-200-2011}
& ZS-CLIP
& 80.79  & 59.31 & 80.18  & 61.71 & 72.79  & 69.44 & 79.84  & 62.83 & 78.40 & 63.32\\
& Tent~(GT)
& 81.24  & 59.61 & 84.05  & 55.01 & 79.18  & 61.47 & 83.31  & 56.86 & 81.94~\textcolor{teal}{(+3.54\%)} & 58.24~\textcolor{teal}{(-5.09\%)}\\
& Tent~(Normal)
& 46.85  & 82.59 & 55.06  & 80.18 & 40.14  & 91.71 & 69.92  & 75.90 & 52.99~\textcolor{red}{(-25.41\%)} & 82.59~\textcolor{red}{(+19.27\%)}\\
& Tent~(All-update)
& 29.60  & 91.45 & 46.45  & 86.77 & 41.22  & 93.95 & 54.73  & 85.76 & 43.00~\textcolor{red}{(-35.40\%)} & 89.48~\textcolor{red}{(+26.16\%)}\\
& SoTTA~(GT)
& 81.80  & 58.61 & 84.00  & 55.12 & 79.76  & 59.37 & 83.41  & 56.69 & 82.24~\textcolor{teal}{(+3.84\%)} & 57.45~\textcolor{teal}{(-5.88\%)}\\
& SoTTA~(Normal)
& 79.75  & 62.44 & 81.98  & 58.85 & 74.79  & 68.23 & 81.37  & 61.23 & 79.47~\textcolor{teal}{(+1.07\%)} & 62.69~\textcolor{teal}{(-0.64\%)}\\
& SoTTA~(All-update)
& 79.54  & 62.84 & 81.89  & 59.22 & 74.44  & 69.00 & 81.31  & 61.23 & 79.30~\textcolor{teal}{(+0.89\%)} & 63.07~\textcolor{teal}{(-0.25\%)}\\
& TPT~(GT)
& 90.36  & 41.25 & 90.37  & 43.41 & 85.78  & 53.15 & 90.03  & 43.84 & 89.13~\textcolor{teal}{(+10.73\%)} & 45.41~\textcolor{teal}{(-17.91\%)}\\
& TPT~(Normal)
& 80.52  & 59.54 & 80.19  & 61.41 & 73.62  & 68.26 & 79.97  & 62.60 & 78.57~\textcolor{teal}{(+0.17\%)} & 62.95~\textcolor{teal}{(-0.37\%)}\\
& TPT~(All-update)
& 72.08  & 75.99 & 71.29  & 79.66 & 68.31  & 79.48 & 71.40  & 79.71 & 70.77~\textcolor{red}{(-7.63\%)} & 78.71~\textcolor{red}{(+15.39\%)}\\

\midrule

\multirow{10}*{STANFORD-CARS}
& ZS-CLIP
& 94.15  & 27.03 & 98.18  & 8.26 & 98.29  & 8.64 & 97.71  & 9.79 & 97.08 & 13.43\\
& Tent~(GT)
& 93.95  & 27.11 & 98.06  & 8.62 & 98.10  & 8.91 & 97.67  & 9.82 & 96.95~\textcolor{red}{(-0.14\%)} & 13.62~\textcolor{red}{(+0.19\%)}\\
& Tent~(Normal)
& 55.00  & 65.81 & 95.13  & 17.17 & 97.10  & 13.56 & 96.75  & 13.39 & 86.00~\textcolor{red}{(-11.09\%)} & 27.48~\textcolor{red}{(+14.05\%)}\\
& Tent~(All-update)
& 43.67  & 77.60 & 58.11  & 63.76 & 39.69  & 77.72 & 68.48  & 58.33 & 52.49~\textcolor{red}{(-44.59\%)} & 69.35~\textcolor{red}{(+55.92\%)}\\
& SoTTA~(GT)
& 94.47  & 26.05 & 98.10  & 8.43 & 98.28  & 8.70 & 97.75  & 9.80 & 97.15~\textcolor{teal}{(+0.07\%)} & 13.25~\textcolor{teal}{(-0.18\%)}\\
& SoTTA~(Normal)
& 91.62  & 34.06 & 97.31  & 11.47 & 98.09  & 9.24 & 97.37  & 11.08 & 96.10~\textcolor{red}{(-0.98\%)} & 16.46~\textcolor{red}{(+3.03\%)}\\
& SoTTA~(All-update)
& 91.40  & 33.99 & 97.45  & 10.56 & 97.93  & 9.90 & 97.24  & 11.59 & 96.01~\textcolor{red}{(-1.08\%)} & 16.51~\textcolor{red}{(+3.08\%)}\\
& TPT~(GT)
& 97.41  & 13.87 & 99.17  & 3.78 & 99.25  & 4.01 & 98.99  & 4.52 & 98.70~\textcolor{teal}{(+1.62\%)} & 6.54~\textcolor{teal}{(-6.89\%)}\\
& TPT~(Normal)
& 93.99  & 26.57 & 97.92  & 8.48 & 98.29  & 8.84 & 97.66  & 9.52 & 96.97~\textcolor{red}{(-0.12\%)} & 13.35~\textcolor{teal}{(-0.08\%)}\\
& TPT~(All-update)
& 87.21  & 45.63 & 93.42  & 22.78 & 97.10  & 12.61 & 93.80  & 21.41 & 92.88~\textcolor{red}{(-4.20\%)} & 25.61~\textcolor{red}{(+12.18\%)}\\
\midrule

\multirow{10}*{Food-101}
& ZS-CLIP
& 97.71  & 11.36 & 98.10  & 10.16 & 96.52  & 13.09 & 97.60  & 13.05 & 97.48 & 11.91\\
& Tent~(GT)
& 97.57  & 13.26 & 98.04  & 11.55 & 96.44  & 14.66 & 97.59  & 13.90 & 97.41~\textcolor{red}{(-0.07\%)} & 13.34~\textcolor{red}{(+1.43\%)}\\
& Tent~(Normal)
& 39.44  & 80.04 & 95.00  & 21.35 & 95.08  & 20.90 & 91.77  & 27.63 & 80.32~\textcolor{red}{(-17.16\%)} & 37.48~\textcolor{red}{(+25.57\%)}\\
& Tent~(All-update)
& 35.67  & 85.78 & 67.60  & 56.23 & 72.00  & 56.92 & 69.85  & 58.67 & 61.28~\textcolor{red}{(-36.20\%)} & 64.40~\textcolor{red}{(+52.49\%)}\\
& SoTTA~(GT)
& 97.78  & 12.00 & 98.22  & 10.28 & 96.57  & 14.13 & 97.74  & 12.94 & 97.58~\textcolor{teal}{(+0.10\%)} & 12.34~\textcolor{red}{(+0.42\%)}\\
& SoTTA~(Normal)
& 94.51  & 24.94 & 97.81  & 12.34 & 95.97  & 16.73 & 97.31  & 15.01 & 96.40~\textcolor{red}{(-1.08\%)} & 17.26~\textcolor{red}{(+5.34\%)}\\
& SoTTA~(All-update)
& 93.96  & 27.45 & 97.71  & 13.12 & 95.78  & 17.53 & 97.17  & 15.76 & 96.16~\textcolor{red}{(-1.33\%)} & 18.46~\textcolor{red}{(+6.55\%)}\\
& TPT~(GT)
& 98.68  & 7.07 & 98.91  & 5.65 & 97.77  & 8.43 & 98.65  & 7.22 & 98.50~\textcolor{teal}{(+1.02\%)} & 7.09~\textcolor{teal}{(-4.82\%)}\\
& TPT~(Normal)
& 97.18  & 11.73 & 97.84  & 10.42 & 96.49  & 13.24 & 97.33  & 13.07 & 97.21~\textcolor{red}{(-0.27\%)} & 12.12~\textcolor{red}{(+0.20\%)}\\
& TPT~(All-update)
& 93.04  & 38.70 & 95.20  & 28.53 & 94.64  & 26.53 & 94.88  & 29.09 & 94.44~\textcolor{red}{(-3.04\%)} & 30.71~\textcolor{red}{(+18.80\%)}\\
\midrule

\multirow{10}*{Oxford-IIIT Pet}
& ZS-CLIP
& 94.16  & 30.78 & 94.46  & 21.68 & 96.44  & 16.79 & 93.48  & 26.51 & 94.64 & 23.94\\
& Tent~(GT)
& 94.80  & 28.92 & 94.91  & 21.39 & 96.69  & 16.87 & 94.07  & 26.07 & 95.12~\textcolor{teal}{(+0.48\%)} & 23.31~\textcolor{teal}{(-0.63\%)}\\
& Tent~(Normal)
& 90.22  & 42.32 & 85.35  & 42.35 & 89.68  & 37.86 & 81.56  & 50.01 & 86.70~\textcolor{red}{(-7.93\%)} & 43.13~\textcolor{red}{(+19.19\%)}\\
& Tent~(All-update)
& 86.45  & 55.78 & 80.66  & 50.18 & 80.20  & 55.53 & 75.25  & 58.32 & 80.64~\textcolor{red}{(-14.00\%)} & 54.95~\textcolor{red}{(+31.01\%)}\\
& SoTTA~(GT)
& 94.44  & 29.92 & 94.78  & 20.98 & 96.71  & 16.27 & 93.85  & 25.80 & 94.94~\textcolor{teal}{(+0.31\%)} & 23.24~\textcolor{teal}{(-0.70\%)}\\
& SoTTA~(Normal)
& 93.13  & 35.13 & 93.64  & 24.75 & 95.79  & 19.91 & 92.52  & 29.94 & 93.77~\textcolor{red}{(-0.87\%)} & 27.43~\textcolor{red}{(+3.49\%)}\\
& SoTTA~(All-update)
& 92.91  & 36.18 & 93.56  & 25.16 & 95.71  & 20.33 & 92.51  & 30.18 & 93.67~\textcolor{red}{(-0.96\%)} & 27.96~\textcolor{red}{(+4.02\%)}\\
& TPT~(GT)
& 97.80  & 13.57 & 97.60  & 12.25 & 98.59  & 8.25 & 97.19  & 16.12 & 97.80~\textcolor{teal}{(+3.16\%)} & 12.55~\textcolor{teal}{(-11.39\%)}\\
& TPT~(Normal)
& 93.54  & 30.85 & 94.57  & 21.05 & 96.23  & 16.26 & 93.36  & 24.59 & 94.43~\textcolor{red}{(-0.21\%)} & 23.19~\textcolor{teal}{(-0.75\%)}\\
& TPT~(All-update)
& 89.66  & 53.33 & 90.17  & 43.58 & 93.48  & 34.00 & 88.89  & 47.78 & 90.55~\textcolor{red}{(-4.09\%)} & 44.67~\textcolor{red}{(+20.73\%)}\\

\midrule
\multirow{10}*{ImageNet}
& ZS-CLIP
& 86.64  & 50.48 & 83.89  & 58.14 & 79.53  & 64.25 & 81.86  & 60.39 & 82.98 & 58.31\\
& Tent~(GT)
& 83.71  & 58.57 & 82.26  & 59.91 & 77.43  & 67.63 & 80.57  & 62.80 & 80.99~\textcolor{red}{(-1.99\%)} & 62.23~\textcolor{red}{(+3.91\%)}\\
& Tent~(Normal)
& 44.17  & 85.40 & 80.35  & 63.64 & 75.98  & 69.87 & 79.70  & 64.76 & 70.05~\textcolor{red}{(-12.93\%)} & 70.92~\textcolor{red}{(+12.60\%)}\\
& Tent~(All-update)
& 40.42  & 88.23 & 76.97  & 71.66 & 73.99  & 74.25 & 77.68  & 69.64 & 67.27~\textcolor{red}{(-15.72\%)} & 75.94~\textcolor{red}{(+17.63\%)}\\
& SoTTA~(GT)
& 81.37  & 62.61 & 80.75  & 63.16 & 78.29  & 66.61 & 79.70  & 64.89 & 80.03~\textcolor{red}{(-2.95\%)} & 64.32~\textcolor{red}{(+6.00\%)}\\
& SoTTA~(Normal)
& 71.13  & 77.69 & 75.14  & 71.50 & 73.72  & 73.10 & 75.81  & 71.74 & 73.95~\textcolor{red}{(-9.03\%)} & 73.51~\textcolor{red}{(+15.19\%)}\\
& SoTTA~(All-update)
& 70.64  & 78.51 & 74.42  & 72.73 & 73.32  & 73.59 & 75.12  & 72.88 & 73.38~\textcolor{red}{(-9.61\%)} & 74.43~\textcolor{red}{(+16.11\%)}\\
& TPT~(GT)
& 92.46  & 37.37 & 90.62  & 43.32 & 87.41  & 51.49 & 89.38  & 46.77 & 89.97~\textcolor{teal}{(+6.99\%)} & 44.74~\textcolor{teal}{(-13.58\%)}\\
& TPT~(Normal)
& 85.80  & 49.83 & 83.83  & 57.09 & 79.05  & 64.33 & 81.89  & 59.53 & 82.64~\textcolor{red}{(-0.34\%)} & 57.70~\textcolor{teal}{(-0.62\%)}\\
& TPT~(All-update)
& 77.46  & 67.63 & 79.04  & 67.53 & 75.26  & 74.62 & 78.47  & 68.83 & 77.56~\textcolor{red}{(-5.42\%)} & 69.65~\textcolor{red}{(+11.34\%)}\\

\midrule

\multirow{10}*{ImageNet-K}
& ZS-CLIP
& 75.13  & 78.60 & 71.38  & 83.15 & 66.30  & 85.24 & 69.02  & 82.68 & 70.46 & 82.42\\
& Tent~(GT)
& 74.04  & 77.74 & 73.11  & 77.83 & 66.63  & 83.49 & 70.89  & 78.90 & 71.17~\textcolor{teal}{(+0.71\%)} & 79.49~\textcolor{teal}{(-2.93\%)}\\
& Tent~(Normal)
& 28.86  & 93.52 & 69.55  & 81.79 & 64.34  & 86.03 & 68.69  & 82.37 & 57.86~\textcolor{red}{(-12.60\%)} & 85.93~\textcolor{red}{(+3.51\%)}\\
& Tent~(All-update)
& 31.41  & 93.29 & 66.33  & 86.45 & 62.78  & 87.26 & 66.81  & 85.18 & 56.83~\textcolor{red}{(-13.62\%)} & 88.05~\textcolor{red}{(+5.63\%)}\\
& SoTTA~(GT)
& 72.08  & 77.26 & 73.44  & 76.55 & 68.62  & 81.10 & 71.41  & 77.44 & 71.39~\textcolor{teal}{(+0.93\%)} & 78.09~\textcolor{teal}{(-4.33\%)}\\
& SoTTA~(Normal)
& 61.84  & 85.96 & 65.98  & 84.10 & 63.25  & 85.66 & 66.28  & 84.24 & 64.34~\textcolor{red}{(-6.12\%)} & 84.99~\textcolor{red}{(+2.57\%)}\\
& SoTTA~(All-update)
& 60.37  & 86.86 & 65.73  & 84.49 & 62.59  & 86.17 & 65.93  & 84.55 & 63.66~\textcolor{red}{(-6.80\%)} & 85.52~\textcolor{red}{(+3.10\%)}\\
& TPT~(GT)
& 83.51  & 69.23 & 80.76  & 74.80 & 76.34  & 79.50 & 78.80  & 76.23 & 79.85~\textcolor{teal}{(+9.40\%)} & 74.94~\textcolor{teal}{(-7.48\%)}\\
& TPT~(Normal)
& 74.55  & 78.10 & 71.52  & 82.15 & 65.70  & 85.08 & 69.18  & 82.05 & 70.24~\textcolor{red}{(-0.22\%)} & 81.84~\textcolor{teal}{(-0.57\%)}\\
& TPT~(All-update)
& 63.59  & 86.87 & 65.12  & 85.90 & 60.34  & 90.42 & 64.26  & 87.02 & 63.33~\textcolor{red}{(-7.13\%)} & 87.55~\textcolor{red}{(+5.13\%)}\\
\midrule

\multirow{10}*{ImageNet-A}
& ZS-CLIP
& 76.23  & 68.27 & 72.73  & 76.64 & 70.65  & 78.17 & 70.04  & 78.07 & 72.41 & 75.29\\
& Tent~(GT)
& 75.68  & 69.65 & 72.53  & 77.04 & 70.41  & 78.79 & 70.08  & 78.47 & 72.17~\textcolor{red}{(-0.24\%)} & 75.99~\textcolor{red}{(+0.70\%)}\\
& Tent~(Normal)
& 73.67  & 72.67 & 71.90  & 77.77 & 69.71  & 79.51 & 69.53  & 79.07 & 71.20~\textcolor{red}{(-1.21\%)} & 77.25~\textcolor{red}{(+1.97\%)}\\
& Tent~(All-update)
& 73.75  & 72.64 & 71.38  & 79.05 & 69.10  & 80.17 & 69.22  & 79.60 & 70.86~\textcolor{red}{(-1.55\%)} & 77.87~\textcolor{red}{(+2.58\%)}\\
& SoTTA~(GT)
& 76.00  & 69.33 & 73.66  & 75.27 & 72.01  & 76.83 & 71.11  & 76.89 & 73.20~\textcolor{teal}{(+0.78\%)} & 74.58~\textcolor{teal}{(-0.71\%)}\\
& SoTTA~(Normal)
& 74.29  & 71.40 & 73.00  & 75.65 & 70.84  & 78.63 & 70.41  & 77.28 & 72.14~\textcolor{red}{(-0.28\%)} & 75.74~\textcolor{red}{(+0.45\%)}\\
& SoTTA~(All-update)
& 74.29  & 71.84 & 73.00  & 75.48 & 70.73  & 78.73 & 70.42  & 77.60 & 72.11~\textcolor{red}{(-0.30\%)} & 75.91~\textcolor{red}{(+0.62\%)}\\
& TPT~(GT)
& 84.33  & 58.37 & 81.88  & 67.53 & 80.45  & 68.52 & 79.71  & 71.19 & 81.59~\textcolor{teal}{(+9.18\%)} & 66.40~\textcolor{teal}{(-8.88\%)}\\
& TPT~(Normal)
& 74.46  & 68.41 & 71.32  & 76.63 & 70.66  & 77.85 & 69.01  & 78.23 & 71.36~\textcolor{red}{(-1.05\%)} & 75.28~\textcolor{teal}{(-0.01\%)}\\
& TPT~(All-update)
& 64.16  & 87.03 & 63.25  & 86.79 & 66.39  & 83.79 & 61.68  & 89.65 & 63.87~\textcolor{red}{(-8.54\%)} & 86.81~\textcolor{red}{(+11.53\%)}\\
\midrule

\multirow{10}*{ImageNet-V2}
& ZS-CLIP
& 83.54  & 60.57 & 80.49  & 67.14 & 75.84  & 72.67 & 78.36  & 69.03 & 79.56 & 67.35\\
& Tent~(GT)
& 82.25  & 62.78 & 79.93  & 67.93 & 75.18  & 73.55 & 77.94  & 69.41 & 78.83~\textcolor{red}{(-0.73\%)} & 68.42~\textcolor{red}{(+1.06\%)}\\
& Tent~(Normal)
& 77.74  & 68.87 & 79.65  & 67.76 & 74.68  & 73.93 & 77.75  & 69.90 & 77.45~\textcolor{red}{(-2.10\%)} & 70.12~\textcolor{red}{(+2.76\%)}\\
& Tent~(All-update)
& 75.04  & 72.01 & 78.67  & 71.31 & 74.11  & 75.03 & 77.09  & 71.47 & 76.23~\textcolor{red}{(-3.33\%)} & 72.45~\textcolor{red}{(+5.10\%)}\\
& SoTTA~(GT)
& 82.30  & 63.32 & 79.58  & 68.54 & 75.83  & 73.04 & 77.80  & 70.07 & 78.88~\textcolor{red}{(-0.68\%)} & 68.74~\textcolor{red}{(+1.39\%)}\\
& SoTTA~(Normal)
& 78.71  & 69.58 & 78.31  & 70.26 & 74.67  & 74.84 & 76.99  & 72.12 & 77.17~\textcolor{red}{(-2.39\%)} & 71.70~\textcolor{red}{(+4.35\%)}\\
& SoTTA~(All-update)
& 78.72  & 69.89 & 78.15  & 70.67 & 74.62  & 75.14 & 76.96  & 72.11 & 77.11~\textcolor{red}{(-2.45\%)} & 71.95~\textcolor{red}{(+4.60\%)}\\
& TPT~(GT)
& 89.97  & 48.36 & 87.98  & 54.92 & 84.31  & 61.75 & 86.48  & 57.28 & 87.19~\textcolor{teal}{(+7.63\%)} & 55.58~\textcolor{teal}{(-11.77\%)}\\
& TPT~(Normal)
& 82.67  & 60.16 & 80.43  & 66.19 & 75.24  & 72.61 & 78.39  & 68.48 & 79.18~\textcolor{red}{(-0.38\%)} & 66.86~\textcolor{teal}{(-0.49\%)}\\
& TPT~(All-update)
& 73.47  & 75.07 & 75.18  & 74.93 & 70.93  & 81.09 & 74.53  & 75.83 & 73.53~\textcolor{red}{(-6.03\%)} & 76.73~\textcolor{red}{(+9.38\%)}\\
\midrule

\multirow{10}*{ImageNet-R}
& ZS-CLIP
& 90.99  & 49.03 & 87.88  & 56.24 & 79.39  & 70.05 & 85.26  & 58.80 & 85.88 & 58.53\\
& Tent~(GT)
& 91.08  & 48.73 & 88.46  & 54.89 & 80.91  & 68.98 & 85.94  & 57.86 & 86.60~\textcolor{teal}{(+0.72\%)} & 57.62~\textcolor{teal}{(-0.91\%)}\\
& Tent~(Normal)
& 90.45  & 51.24 & 87.60  & 57.99 & 77.01  & 73.38 & 85.41  & 59.69 & 85.12~\textcolor{red}{(-0.76\%)} & 60.58~\textcolor{red}{(+2.05\%)}\\
& Tent~(All-update)
& 89.59  & 55.75 & 85.96  & 61.95 & 74.76  & 76.14 & 84.51  & 62.67 & 83.70~\textcolor{red}{(-2.17\%)} & 64.13~\textcolor{red}{(+5.60\%)}\\
& SoTTA~(GT)
& 91.36  & 47.40 & 89.30  & 50.67 & 82.60  & 63.73 & 86.63  & 54.50 & 87.47~\textcolor{teal}{(+1.59\%)} & 54.07~\textcolor{teal}{(-4.46\%)}\\
& SoTTA~(Normal)
& 88.40  & 57.05 & 87.46  & 55.56 & 79.79  & 69.31 & 85.09  & 58.76 & 85.19~\textcolor{red}{(-0.69\%)} & 60.17~\textcolor{red}{(+1.64\%)}\\
& SoTTA~(All-update)
& 87.64  & 59.58 & 87.37  & 56.37 & 79.50  & 69.86 & 84.93  & 59.50 & 84.86~\textcolor{red}{(-1.02\%)} & 61.33~\textcolor{red}{(+2.80\%)}\\
& TPT~(GT)
& 95.13  & 28.09 & 93.09  & 37.64 & 86.96  & 53.23 & 91.08  & 40.58 & 91.56~\textcolor{teal}{(+5.69\%)} & 39.89~\textcolor{teal}{(-18.64\%)}\\
& TPT~(Normal)
& 90.58  & 49.41 & 87.30  & 56.40 & 78.51  & 69.69 & 84.51  & 59.32 & 85.22~\textcolor{red}{(-0.66\%)} & 58.70~\textcolor{red}{(+0.17\%)}\\
& TPT~(All-update)
& 84.12  & 71.49 & 82.01  & 72.54 & 75.36  & 78.05 & 79.35  & 75.21 & 80.21~\textcolor{red}{(-5.67\%)} & 74.32~\textcolor{red}{(+15.79\%)}\\
\bottomrule
\end{tabular}}
}
\end{table}


\subsection{Score Difference}\label{app:anaylsis-TPT}
\begin{figure*}[t]
\centering
\begin{subfigure}{0.28\textwidth}
\centering
\includegraphics[width=\textwidth]{figs/ZS-CLIP_CIFAR-10_ViT-B_16_SVHN_1.0_normal_mode_bs_1_adaptive.pdf}
\caption{ZS-CLIP}
\end{subfigure}
\hfill
\begin{subfigure}{0.28\textwidth}
\centering
\includegraphics[width=\textwidth]{figs/TPT_CIFAR-10_ViT-B_16_SVHN_1.0_normal_mode_bs_64_adaptive.pdf}
\caption{TPT}
\end{subfigure}
\hfill
\begin{subfigure}{0.35\textwidth}
\centering
\includegraphics[width=\textwidth]{figs/TPT_CIFAR-10_ViT-B_16_SVHN_1.0_normal_mode_bs_64_adaptive_diff.pdf}
\caption{Score difference: TPT - ZS-CLIP}
\end{subfigure}
\caption{Failure case analysis of TPT~\citep{shu2022test} in ZS-NTTA. \textbf{(a)} and \textbf{(b)} show the score distributions of ZS-CLIP and TPT, respectively. ID dataset: CIFAR-10; OOD dataset: SVHN.
}\label{app-fig: failure-case-tpt}
\vspace{-10pt}
\end{figure*}


The score distributions for TPT under the \texttt{Normal} pipeline are shown in Figures~\ref{app-fig: failure-case-tpt}. Since TPT resets the model after updating each sample, the impact of unfiltered noisy samples is limited to the current step and does not accumulate. Despite this, the score of some noisy samples may increase, while the score of some ID samples may decrease, leading to a decline in performance.


\subsection{Gradient Analysis}\label{app:fail-gradient}
Figure~\ref{app-fig:fail-gradient} shows the impact of clean and noisy samples on the gradients in Tent. To present a clear view, Figure~\ref{app-fig:fail-gradient} only displays the portion of the gradient magnitudes less than $0.0010$.


\begin{figure*}[!t]
\centering
\begin{subfigure}{0.9\textwidth}
\centering
\includegraphics[width=\textwidth]{figs/gradient_clean.pdf}
\caption{Clean samples}\label{fig:failure_case_score-grad-clean}
\end{subfigure}
\hfill
\begin{subfigure}{0.9\textwidth}
\centering
\includegraphics[width=\textwidth]{figs/gradient_noisy.pdf}
\caption{Noisy samples}\label{fig:failure_case_score-grad-nosiy}
\end{subfigure}

\caption{The impact of clean and noisy samples on the gradients.
Note that the gradient magnitudes of clean and noisy samples are not on the same scale; for clarity, the figure does not show gradients with magnitudes greater than $0.0010$. The gradients of noisy samples are substantially larger in the first and second stages. The model effectively filters out noisy samples in the first stage but gradually struggles to distinguish between clean and noisy samples.
ID set: CIFAR-10; OOD set: SVHN.}\label{app-fig:fail-gradient}
\vspace{-10pt}
\end{figure*}