\newcommand{\Xmark}{\ding{56}}
\newcommand{\Cmark}{\ding{52}}
\newcommand\thingap{\kern 0.2pt}

% Color settings
\def \GuidanceColor             {violet}
    \def \GuidanceDrawColor     {\GuidanceColor!85}
    \def \GuidanceFillColor     {\GuidanceColor!15}
\def \TipColor                  {violet}
    \def \TipDrawColor          {\TipColor!85}
    \def \TipFillColor          {\TipColor!15}
\def \TaskColor                 {BurntOrange}
    \def \TaskDrawColor         {\TaskColor!78!black}
    \def \TaskFillColor         {\TaskColor!10}
\def \AgentActionColor          {NavyBlue}
    \def \AgentActionDrawColor  {\AgentActionColor!90}
    \def \AgentActionFillColor  {\AgentActionColor!10}
\def \ObservationColor          {black}
    \def \ObservationDrawColor  {\ObservationColor!60}
    \def \ObservationFillColor  {\ObservationColor!10}

\tikzset{
    guidance colors/.style={
        fill=\GuidanceFillColor,
        draw=\GuidanceDrawColor,
    },
    tip colors/.style={
        fill=\TipFillColor,
        draw=\TipDrawColor,
    },
    task colors/.style={
        fill=\TaskFillColor,
        draw=\TaskDrawColor,
    },
    action colors/.style={
        fill=\AgentActionFillColor,
        draw=\AgentActionDrawColor,
    },
    observation colors/.style={
        fill=\ObservationFillColor,
        draw=\ObservationDrawColor,
    },
}

\newcommand{\Agent}[1]{
    % #1 = options for the scope
    
    \def\bodyWidth{16pt}
    \def\bodyHeight{3pt}
    \def\headWidth{13pt}
    \def\headOffset{3pt}
    \def\fillColor{NavyBlue!70!gray}
    
    \begin{scope}[#1]
    
        \draw[fill=\fillColor, draw=\fillColor, rounded corners=0.25pt] 
            (0.5pt,0) 
            rectangle (\bodyWidth - 0.5pt, \bodyHeight);
      
        \draw[fill=\fillColor, draw=white, semithick]
            (0, \bodyHeight - 0.05pt) 
            arc [start angle=180, end angle=0, radius=\bodyWidth/2];

        \draw[fill=\fillColor, draw=white, semithick] 
            (\bodyWidth/2, \bodyHeight + \bodyWidth/2 + \headOffset) 
            circle (\headWidth / 2);
        
    \end{scope}
}

\newcommand{\Teacher}[1]{
    \def\BoardOffsetX{-15pt}
    \def\BoardOffsetY{5pt}
    \def\BoardWidth{22pt}
    \def\BoardHeight{18pt}
    \def\PointerColor{Apricot!80!black}

    
    \begin{scope}[#1]
        \draw[fill=black!80, draw=Apricot!80!black, ultra thick, rounded corners]
            (\BoardOffsetX, \BoardOffsetY)
            rectangle (\BoardOffsetX + \BoardWidth, \BoardOffsetY + \BoardHeight);
        \Agent{}
        \draw[fill=\PointerColor, draw=white, ultra thin, shift={(4pt, 2pt)}] 
            (0,0) -- (-12pt,12pt) -- (1pt,1pt) -- cycle;
    \end{scope}
}

\newcommand{\Reviewer}[1]{
    \def\bodyWidth{16pt}
    \def\BridgeWidth{1.5pt}
    \def\BridgeOffsetY{0.8pt}
    \def\FrameOuterRad{2.3pt}
    \def\FrameThickness{0.9pt}
    \def\ArmLength{1.9pt}
    \def\GlassesOffsetX{\bodyWidth/2 - \FrameOuterRad - \BridgeWidth}
    \def\GlassesOffsetY{10.5pt}
    \def\FrameColor{black!80}
    \def\GlassColor{TealBlue!30}

    
    \begin{scope}[#1]
        \Agent{}
        
        \draw[
            fill=\FrameColor,
            draw=none,
            ultra thin,
            shift={(4pt, 2pt)}
        ] (\GlassesOffsetX - \BridgeWidth/2, \GlassesOffsetY) circle (\FrameOuterRad);
            
        \draw[
            fill=\GlassColor,
            draw=none,
            ultra thin,
            shift={(4pt, 2pt)}
        ] (\GlassesOffsetX - \BridgeWidth/2, \GlassesOffsetY) 
            circle (\FrameOuterRad - \FrameThickness);
        
        \draw[
            fill=\FrameColor,
            draw=none,
            ultra thin,
            shift={(4pt, 2pt)},
        ] (\GlassesOffsetX + \FrameOuterRad*2 + \BridgeWidth/2, \GlassesOffsetY)
            circle (\FrameOuterRad);

        \draw[
            fill=\GlassColor,
            draw=none,
            ultra thin,
            shift={(4pt, 2pt)},
        ] (\GlassesOffsetX + \FrameOuterRad*2 + \BridgeWidth/2, \GlassesOffsetY)
            circle (\FrameOuterRad - \FrameThickness);

        % Bridge
        \draw[
            fill=\FrameColor,
            draw=none,
            ultra thin,
        ]   (\GlassesOffsetX  + \FrameOuterRad*2 + \BridgeOffsetY/2, \GlassesOffsetY + \FrameOuterRad + \BridgeOffsetY)
            arc[start angle=135, end angle=45, radius=2pt]
            -- ++(0, -\FrameThickness)
            arc[start angle=45, end angle=135, radius=2pt]
            -- cycle;

        % Arm
        % Ð¡alculations are a mess here
        \draw[
            fill=\FrameColor,
            draw=none,
            ultra thin,
        ]   (\GlassesOffsetX + \FrameThickness*2, \GlassesOffsetY + \FrameOuterRad + \BridgeOffsetY)
            -- ++(-\ArmLength, \ArmLength)
            arc[start angle=45, end angle=180, radius=\FrameOuterRad/2 + \FrameThickness*(1.41/5)]
            % -- ++(\FrameThickness, 0)
            arc[start angle=180, end angle=360, radius=\FrameThickness/2]
            arc[start angle=180, end angle=45, radius=\FrameOuterRad/2 - \FrameThickness/1.6]
            -- ++(\ArmLength, -\ArmLength)
            -- cycle;
        
    \end{scope}
}

\newcommand{\Star}[1]{
    \def\InnerRad{1.5pt}
    \def\OuterRad{3.8pt}
    
    \path[#1] 
        (0  :\OuterRad) -- ( 36:\InnerRad) 
        -- (72 :\OuterRad) -- (108:\InnerRad)
        -- (144:\OuterRad) -- (180:\InnerRad)
        -- (216:\OuterRad) -- (252:\InnerRad)
        -- (288:\OuterRad) -- (324:\InnerRad)--cycle;}


% \newcommand{\oldOverviewFigure}{
    
%     \begin{tikzpicture}[
%         box/.style={
%             draw=black,
%             semithick,
%             rounded corners,
%             font=\scriptsize,
%             align=center,
%             minimum width=20pt,
%         },
%         message/.style={
%             box,
%             text width=43pt,
%         },
%         grade/.style={box, outer xsep=2pt},
%         traj line/.style={
%             thick, rounded corners
%         },
%         prompt/.style={
%             ->, traj line
%         },
%     ]
%         % ========
%         % PHASE 1
%         % ========
            
%         % Prompt
%         \node[
%             message,
%             guidance colors,
%         ] (guidance) {guidance};
%         \node[message, below=5pt of guidance] (task) {\vphantom{p} task};
%         \draw[traj line] (task) -- (guidance);
%         \node[above=8pt of guidance] (phase one) {\vphantom{p} \bfseries \shortstack{Phase 1:\\training data}};
        
%         % Teacher
%         \Teacher{local bounding box=teacher, shift={($(task.south)+(-0.5pt,-34pt)$)}};
%         \node[below=-1pt of teacher] (teacher label) {\scriptsize teacher};
%         \draw[prompt] (task) -- ($(teacher.north)+(0, 2pt)$);

%         % Teacher trajectory
%         \node[message, below=55pt of task]       (t1) {action$\thingap _0$};
%         \node[message, below=6pt of t1]          (t2) {observation$\thingap _1$};
%         \node[message, below=6pt of t2]          (t3) {\ldots};
%         \node[message, below=6pt of t3]          (t4) {observation$\thingap _n$};
%         \node[message, below=6pt of t4]          (t5) {action$\thingap _n$};
%         \node[
%             fit=(t1)(t2)(t3)(t4)(t5),
%             box,
%             densely dashed,
%             inner sep=4pt,
%         ] (teacher traj) {};
%         \draw[>-, traj line]                    (teacher.south) ++ (0pt, -11.5pt) -- (t1);
%         \draw[traj line]                        (t1) -- (t2);
%         \draw[traj line]                        (t2) -- (t3);
%         \draw[traj line]                        (t3) -- (t4);
%         \draw[traj line]                        (t4) -- (t5);

%         % ========
%         % PHASE 2
%         % ========
        
%         % Prompt
%         \node[
%             message,
%             right=52pt of guidance,
%             guidance colors,
%         ] (guidance) {guidance};
%         \node[message, below=5pt of guidance] (task) {\vphantom{p} task};
%         \node[message, below=7pt of task] (t1) {action$\thingap _0$};
%         \node[message, below=5pt of t1] (t2) {\ldots};
%         \node[message, below=5pt of t2] (t3) {observation$\thingap _i$};
%         \node[message, below=5pt of t3] (t4) {action$\thingap _i$};
%         \node[
%             fit=(t1)(t2)(t3)(t4),
%             densely dashed,
%             draw=black,
%             semithick,
%             rounded corners
%         ] (trunk traj) {};
%         \draw[traj line] (task) -- (t1);
%         \draw[traj line] (t1) -- (t2);
%         \draw[traj line] (t2) -- (t3);
%         \draw[traj line] (t3) -- (t4);
%         \draw[traj line, densely dashed, semithick, rounded corners] 
%             (teacher traj.north east) ++ (0, -10pt) 
%             -- ++ (12pt, 0) 
%             |- node[above, anchor=south east, pos=1.02]{\tiny $i=1 \ldots n$} 
%             ($(trunk traj.west)+(0, 0)$);

%         \node[above=8pt of guidance] (phase two) {\vphantom{p} \bfseries \shortstack{Phase 2:\\distillation}};
        
%         % Agents
%         \Agent{local bounding box=student, shift={($(trunk traj.south)+(-42pt,-40pt)$)}};
%         \node[below=-1pt of student] (student label) {\scriptsize student};
%         \draw[prompt]
%             (t4.west) 
%             -| ($(student.north)+(0, 2pt)$);

%         \Teacher{local bounding box=teacher, shift={($(trunk traj.south)+(39pt,-40pt)$)}};
%         \node[below=-1pt of teacher] (teacher label) {\scriptsize teacher};
%         \draw[prompt]
%             (t4.east) 
%             -| ($(teacher.north)+(-2.5pt, 2pt)$);
%         \draw[prompt, draw=\GuidanceDrawColor]
%             (guidance.east)
%             -| ($(teacher.north)+(2.5pt, 2pt)$);

%         % Logits
%         \node[box, below=28pt of student] (student logits) {logits};
%         \draw[prompt, ->] 
%             (student.south) ++ (0pt, -10.5pt) 
%             -- ($(student logits.north)+(0pt, 2pt)$);
%         \node[
%             box,
%             below=28pt of teacher,
%             guidance colors,
%         ] (teacher logits) {logits};
%         \draw[prompt, ->, draw=\GuidanceDrawColor] 
%             (teacher.south) ++ (0pt, -10.5pt) 
%             -- ($(teacher logits.north)+(0pt, 2pt)$);

%         % Loss
%         \node[fit=(student logits)(teacher logits)] (logits) {};
%         \node[box, below=0pt of logits, inner sep=8pt] (loss) {KL Loss};
%         \draw[prompt] (student logits) |- (loss);
%         \draw[prompt, draw=\GuidanceDrawColor] (teacher logits) |- (loss);
%         \draw[prompt, draw=\GuidanceDrawColor] 
%             (loss) |- node[above, pos=0.6] {\scriptsize back-prop} 
%             ($(student.east)+(4pt, 0)$);
%         \Star{
%             draw=\GuidanceColor!70,
%             ultra thin,
%             fill=\GuidanceColor!70,
%             shift={($(student.east)+(11pt, -6pt)$)},
%         }

%         % ========
%         % PHASE 3
%         % ========
        
%         % Reviewer prompt
%         \node[
%             box,
%             right=94pt of guidance.north, 
%             anchor=north,
%         ] (mistake description) {\shortstack{mistake\\description}};

%          % Student prompt
%         \node[
%             message,
%             right=55pt of mistake description.north,
%             anchor=north,
%         ] (task) {\vphantom{p} task};

%         \node[above=10pt of task] (phase three) {\bfseries \shortstack{Phase 3:\\ mistake correction}};
        
%         % Reviewer
%         \Reviewer{
%             local bounding box=reviewer,
%             shift={($(mistake description.south)+(-8pt,-34pt)$)}
%         };
%         \node[below=-1pt of reviewer] (student label) 
%             {\scriptsize \shortstack{LLM-powered\\reviewer}};
%         \draw[prompt] (mistake description) -- ($(reviewer.north)+(0, 2pt)$);
        
%         % Trained student
%         \Agent{local bounding box=student, shift={($(reviewer.south)+(47pt, 0pt)$)}};
%         \Star{
%             draw=white,
%             ultra thin,
%             fill=\GuidanceColor!70,
%             shift={($(student.east)+(-3.5pt, -6pt)$)},
%         };
%         \node[below=-1pt of student] (student label) 
%             {\scriptsize \shortstack{trained\\student}};
%         \draw[prompt] (task) -- ($(student.north)+(0, 2pt)$);

        
%         % Trajectory with mistakes
%         \node[message, below=72pt of task]       (s1) {action$\thingap_0$};
%         \node[message, below=6pt of s1]          (s2) {\ldots};
%         \node[message, below=6pt of s2]          (s3) {observation$\thingap_k$};
%         \node[
%             box,
%             below=14pt of s3,
%             xshift=-20pt,
%             draw=Mahogany!80!Red,
%             fill=Mahogany!10,
%             thick, align=center,
%         ] (s4) {\shortstack{\vphantom{t}wrong\\action$\thingap_k$}};
%         \node[message, below=14pt of s4, xshift=20pt]          (s5) {\ldots};
%         \node[message, below=6pt of s5]          (s6) {action$\thingap_m$};
%         \node[
%             fit=(s1)(s2)(s3),
%             box,
%             dashed,
%             inner sep=4pt,
%             draw=none,
%         ] (student traj) {};
        
%         \draw[>-, traj line]                    (student.south) ++ (0pt, -19.5pt) -- (s1);
%         \draw[traj line]                        (s1) -- (s2);
%         \draw[traj line]                        (s2) -- (s3);
%         \draw[traj line]  
%             (s3.south) -- ++ (0, -5pt) -| (s4);
%         \draw[traj line]                        
%             (s4.south) -- ++ (0, -9pt) -| (s5);
%         \draw[traj line]                        (s5) -- (s6);

%         % Reviewer evaluation
%         \node[grade] (e1) at (mistake description |- s1) {\color{ForestGreen}\Cmark};
%         \node[grade] (e2) at (mistake description |- s2) {\ldots};
%         \node[grade] (e3) at (mistake description |- s3) {\color{ForestGreen}\Cmark};
%         \node[
%             grade,
%             draw=Mahogany!80!Red,
%             thick,
%         ] (e4) at (mistake description |- s4) {\color{Mahogany!80!Red}\Xmark};
%         \node[grade] (e5) at (mistake description |- s5) {\ldots};
%         \node[grade] (e6) at (mistake description |- s6) {\color{ForestGreen}\Cmark};

%         \draw[>-, traj line, dotted]  (reviewer.south) ++ (0pt, -20.5pt) -- (e1);
%         \draw[traj line, dotted] (e1) -- (e2);
%         \draw[traj line, dotted] (e2) -- (e3);
%         \draw[traj line, dotted] (e3) -- (e4);
%         \draw[traj line, dotted] (e4) -- (e5);
%         \draw[traj line, dotted] (e5) -- (e6);

%         \draw[prompt] (s1) -- (e1) ;
%         \draw[prompt] (s2) -- (e2);
%         \draw[prompt] (s3) -- (e3);
%         \draw[prompt] (s4) -- (e4);
%         \draw[prompt] (s5) -- (e5);
%         \draw[prompt] (s6) -- (e6);

%         % Teacher
%         \Teacher{local bounding box=teacher, shift={($(student.south)+(56pt, -82pt)$)}};
%         \Star{
%             draw=white,
%             ultra thin,
%             fill=\GuidanceColor!70,
%             shift={($(teacher.east)+(-3.5pt, -6pt)$)},
%         };
%         \node[below=-1.0pt of teacher, xshift=-0pt] (teacher label) 
%             {\scriptsize \shortstack{teacher}};
%         \draw[prompt] (s3) -- ($(s3 -| teacher.west) + (-3pt, 0)$);

%         % Corrected action
%         \node[
%             box,
%             right=3pt of s4,
%             outer sep=4pt,
%             tip colors,
%             thick,
%         ] (corrected) {\shortstack{\vphantom{p}improved\\action$\thingap_k$}};
%         \draw[prompt, -] 
%             ($(teacher label.south) + (-4pt, 0.5pt)$) 
%             |- ($(corrected.east) + (-4pt, 0)$); 

%         \draw[
%             draw=black,
%             densely dashed,
%             semithick, 
%             rounded corners,
%         ]
%             (student traj.north west) 
%             -- (student traj.south west |- corrected.north west)
%             -- (corrected.north west)
%             -- (corrected.south west)
%             -- (corrected.south east)
%             -- (corrected.north east)
%             -- (student traj.south east |- corrected.north east)
%             -- (student traj.north east) 
%             -- (student traj.north west);

%         % Tip
%         \node[
%             box,
%             above=32pt of teacher label,
%             xshift=-4pt,
%             tip colors,
%         ] (tip) {\shortstack{tip}};
%         \draw[prompt, rounded corners=3pt] (tip.south) -- ++ (0, -3pt)
%         -| ($(teacher label.north)+(-4pt, 25pt)$);

%         % ========
%         % PHASE 4
%         % ========

%         % Student trajectory
%         \node[message, right=92pt of task]    (s1) {action$\thingap _0$};
%         \node[message, below=6pt of s1]    (s2) {\ldots};
%         \node[message, below=6pt of s2]    (s3) {observation$\thingap _k$};
%         \node[
%             message,
%             below=8pt of s3,
%             tip colors,
%             thick,
%         ] (corrected copy) {\shortstack{improved\\action$\thingap _k$}};
%         \node[
%             box,
%             right=14pt of corrected copy,
%             tip colors,
%         ] (tip) {\strut tip};
%         \node[
%             fit=(s1)(s2)(s3)(corrected copy),
%             box,
%             densely dashed,
%             inner sep=4pt,
%         ] (traj) {};
%         \draw[densely dashed, semithick, rounded corners] 
%             (student traj.east) ++ (0, 22pt)
%             -- ++ (8pt,0pt)
%             |- ($(traj.west)+(0,-16pt)$);

%         \draw[traj line]        (s1) -- (s2);
%         \draw[traj line]        (s2) -- (s3);
%         \draw[traj line]        (s3) -- (corrected copy);

%         \node[above=8pt of s1] (phase four) {\vphantom{p} \bfseries \shortstack{Phase 4:\\distilling corrections}};
        
%         % Agents
%         \Agent{local bounding box=student, shift={($(corrected copy.south)+(-42pt,-40pt)$)}};
%         \Star{
%             draw=white,
%             ultra thin,
%             fill=\GuidanceColor!70,
%             shift={($(student.east)+(-3.5pt, -6pt)$)},
%         }
%         \node[below=-1pt of student] (student label) {\scriptsize student};
%         \draw[prompt]
%             (corrected copy.west) 
%             -| ($(student.north)+(0, 2pt)$);

%         \Teacher{local bounding box=teacher, shift={($(corrected copy.south)+(39pt,-40pt)$)}};
%         \Star{
%             draw=white,
%             ultra thin,
%             fill=\GuidanceColor!70,
%             shift={($(teacher.east)+(-3.5pt, -7pt)$)},
%         }
%         \node[below=-1pt of teacher] (teacher label) {\scriptsize teacher};
%         \draw[prompt]
%             (corrected copy.east) 
%             -| ($(teacher.north)+(-5.5pt, 2pt)$);
%         \draw[prompt, draw=\TipDrawColor]
%             (tip.south) -- ++ (0, -6pt)
%             -| ($(teacher.north)+(-0.5pt, 2pt)$);

%         % Logits
%         \node[box, below=28pt of student] (student logits) {logits};
%         \draw[prompt, ->] 
%             (student.south) ++ (0pt, -10.5pt) 
%             -- ($(student logits.north)+(0pt, 2pt)$);
%         \node[
%             box,
%             below=28pt of teacher,
%             tip colors,
%         ] (teacher logits) {logits};
%         \draw[prompt, ->, draw=\TipDrawColor] 
%             (teacher.south) ++ (0pt, -10.5pt) 
%             -- ($(teacher logits.north)+(0pt, 2pt)$);

%         % Loss
%         \node[fit=(student logits)(teacher logits)] (logits) {};
%         \node[box, below=0pt of logits, inner sep=7pt] (loss) {KL Loss};
%         \draw[prompt] (student logits) |- (loss);
%         \draw[prompt, draw=\TipDrawColor] (teacher logits) |- (loss);
%         \draw[prompt, draw=\TipDrawColor] 
%             (loss) |- node[above, pos=0.6] {\scriptsize back-prop} 
%             ($(student.east)+(4pt, 0)$);
        
        
%     \end{tikzpicture}
% }

\newcommand{\roundOne}{
    
    \begin{tikzpicture}[
        box/.style={
            draw=black,
            semithick,
            rounded corners,
            font=\scriptsize,
            align=center,
            minimum width=20pt,
        },
        message/.style={
            box,
            text width=33pt,
        },
        grade/.style={box, outer xsep=2pt},
        traj line/.style={
            thick, rounded corners
        },
        prompt/.style={
            ->, traj line
        },
    ]
        % ========
        % PHASE 1
        % ========
            
        % Prompt
        \node[
            message,
            guidance colors,
            thick,
        ] (guidance) {initial hint};
        \node[message, below=4pt of guidance] (task) {\vphantom{p} task};
        \draw[traj line] (task) -- (guidance);
        \node[above=0pt of guidance] (phase one) {\vphantom{p} \small\bfseries \shortstack{Agent collects\\training data}};
        
        % Teacher trajectory
        \node[message, below=2pt of task]       (t1) {$a_1$};
        \node[message, below=2pt of t1]          (t2) {$o_1$};
        \node[message, below=2pt of t2]       (t21) {$a_2$};

        \node[below=2pt of t21, outer ysep=3pt]          (t22) {\ldots};
        \node[message, below=2pt of t22]          (t23) {$o_{t-1}$};
        \node[
            message,
            below=4pt of t23,
            guidance colors,
            thick,
        ]          (t24) {$a_t$};

        \node[below=2pt of t24, outer ysep=2pt]          (t3) {\ldots};
        % \node[message, below=2pt of t3]          (t4) {$o_{n-1}$};
        \node[message, below=2pt of t3]          (t5) {$a_n$};
        \node[
            fit=(task)(t1)(t2)(t21)(t22)(t23),
            box,
            densely dashed,
            inner sep=2pt,
        ] (teacher traj) {};
        \draw[traj line]                        (task) -- (t1);
        \draw[traj line]                        (t1) -- (t2);
        \draw[traj line]                        (t2) -- (t21);
        \draw[traj line, line cap=round]        (t21) -- (t22);
        \draw[traj line, line cap=round]        (t22) -- (t23);
        \draw[traj line]                        (t23) -- (t24);
        \draw[traj line, line cap=round]        (t24) -- (t3);
        % \draw[traj line, line cap=round]        (t3) -- (t4);
        \draw[traj line]                        (t3) -- (t5);

        % ========
        % PHASE 2
        % ========
        
        % Prompt
        \node[
            message,
            right=52pt of guidance,
            guidance colors,
            thick,
        ] (guidance) {initial hint};
        \node[message, below=4pt of guidance] (task) {\vphantom{p} task};
        \node[message, below=2pt of task] (t1) {$a_1$};
        \node[below=2pt of t1, outer ysep=2pt] (t2) {\ldots};
        \node[message, below=2pt of t2] (t4) {$o_{t-1}$};
        \node[
            fit=(task)(t1)(t2)(t4),
            densely dashed,
            draw=black,
            semithick,
            rounded corners,
            inner sep=2pt,
        ] (trunk traj) {};
        \draw[traj line] (task) -- (t1);
        \draw[traj line, line cap=round] (t1) -- (t2);
        \draw[traj line, line cap=round] (t2) -- (t4);
        \draw[traj line, densely dashed, semithick, rounded corners] 
            (teacher traj.north east |- task.west) 
            -- node[above, anchor=south east, pos=0.9]{\tiny $t=1 ... n$} 
            (trunk traj.west |- task.west);

        \node[above=0pt of guidance] (phase two) {\vphantom{p} \small\bfseries \shortstack{Training to\\internalize hints}};
        
        % Agents
        \Agent{local bounding box=student, shift={($(trunk traj.south)+(-42pt,-30pt)$)}};
        \node[below=-1pt of student] (student label) {\scriptsize student};
        \draw[prompt]
            (trunk traj.west |- t4.west) 
            -| ($(student.north)+(0, 2pt)$);

        \Teacher{local bounding box=teacher, shift={($(trunk traj.south)+(39pt,-30pt)$)}};
        \node[below=-1pt of teacher] (teacher label) {\scriptsize teacher};
        \draw[prompt]
            (trunk traj.east |- t4.east) 
            -| ($(teacher.north)+(-2.5pt, 2pt)$);
        \draw[prompt, draw=\GuidanceDrawColor]
            (guidance.east)
            -| ($(teacher.north)+(2.5pt, 2pt)$);

        % Logits
        \node[box, below=22pt of student] (student logits) {$a_t$};
        \draw[prompt, ->] 
            (student.south) ++ (0pt, -10.5pt) 
            -- ($(student logits.north)+(0pt, 2pt)$);
        \node[
            box,
            below=22pt of teacher,
            guidance colors,
            thick,
        ] (teacher logits) {$a_t$};
        \draw[prompt, ->, draw=\GuidanceDrawColor] 
            (teacher.south) ++ (0pt, -10.5pt) 
            -- ($(teacher logits.north)+(0pt, 2pt)$);

        % Loss
        \node[fit=(student logits)(teacher logits)] (logits) {};
        \node[box, below=-4pt of logits, inner sep=4pt] (loss) {Loss};
        \draw[prompt] (student logits) |- (loss);
        \draw[prompt, draw=\GuidanceDrawColor] (teacher logits) |- (loss);
        \draw[prompt, draw=\GuidanceDrawColor] 
            (loss) |- node[above, pos=0.7] {\scriptsize back-prop} 
            ($(student.east)+(4pt, -4pt)$);
        % \Star{
        %     draw=\GuidanceColor!70,
        %     ultra thin,
        %     fill=\GuidanceColor!70,
        %     shift={($(student.east)+(11pt, -6pt)$)},
        % }

    \end{tikzpicture}

}


\newcommand{\roundTwo}{
    
    \begin{tikzpicture}[
        box/.style={
            draw=black,
            semithick,
            rounded corners,
            font=\scriptsize,
            align=center,
            minimum width=20pt,
        },
        message/.style={
            box,
            text width=33pt,
        },
        grade/.style={outer xsep=2pt},
        traj line/.style={
            thick, rounded corners
        },
        prompt/.style={
            ->, traj line
        },
    ]

        % Reviewer prompt
        \node[
            box,
            % right=94pt of guidance.north, 
            anchor=north,
        ] (mistake description) {\shortstack{mistake\\description}};

         % Student prompt
        \node[
            message,
            right=46pt of mistake description.north,
            % shift={($(0pt,-54pt)$)},
            anchor=north,
        ] (task) {\vphantom{p} task};

        \node[above=10pt of task] (phase three) {\small\bfseries \shortstack{Mistake detection\\ \vphantom{p}}};
        
        % Reviewer
        \Reviewer{
            local bounding box=reviewer,
            shift={($(mistake description.south)+(-8pt,-34pt)$)}
        };
        \node[below=-1pt of reviewer] (reviewer label) 
            {\scriptsize \shortstack{reviewer}};
        \draw[prompt] (mistake description) -- ($(reviewer.north)+(0, 2pt)$);
        
        
        % Trajectory with mistakes
        \node[message, below=2pt of task]       (s1) {$a_1$};
        \node[message, below=2pt of s1]       (s11) {$o_1$};
        \node[message, below=2pt of s11]       (s12) {$a_2$};
        \node[below=2pt of s12, outer ysep=2pt]          (s2) {\ldots};
        \node[message, below=2pt of s2]          (s3) {$o_{t-1}$};
        \node[
            message, below=26pt of s3,
            task colors,
            thick,
        ] (s4) {\vphantom{hp}bad $a_t$};
        \node[below=2pt of s4, outer ysep=2pt]          (s5) {\ldots};
        % \node[message, below=6pt of s5]          (s6) {$a_n$};
        \node[
            fit=(task)(s1)(s11)(s12)(s3),
            box,
            densely dashed,
            inner sep=2pt,
        ] (teacher traj) {};
        
        \draw[traj line]                        (task) -- (s1);
        \draw[traj line]                        (s1) -- (s11);
        \draw[traj line]                        (s11) -- (s12);
        \draw[traj line, line cap=round]        (s12) -- (s2);
        \draw[traj line, line cap=round]        (s2) -- (s3);
        \draw[traj line]                        (s3) -- (s4);
        \draw[traj line, line cap=round]        (s4) -- (s5);
        % \draw[traj line]                      (s5) -- (s6);

        \draw[traj line, ->] 
            (reviewer label.south) |- node[below, pos=0.75] {\scriptsize locates}
            ($(s4.west) + (-4pt, 0)$);

        % Teacher
        \Teacher{local bounding box=teacher, anchor=south, shift={($(s3.south)+(50pt, -5pt)$)}};
        \node[below=-1.0pt of teacher, xshift=-2pt] (teacher label) 
            {\scriptsize \shortstack{teacher}};
        \draw[prompt] 
            (teacher traj.east |- s3) 
            -- ($(s3 -| teacher.west) + (-3pt, 0)$);

        % Corrected action
        \node[
            message,
            right=4pt of s4,
            outer sep=3pt,
            tip colors,
            thick,
        ] (corrected) {\vphantom{p}better $a_t$};
        \draw[prompt, ->] 
            (corrected |- teacher label.south) -- (corrected); 

        % Tip
        \node[
            box,
            above=32pt of teacher label,
            xshift=-2pt,
            tip colors,
            thick,
        ] (tip) {\shortstack{corrective\\hint}};
        \draw[prompt, rounded corners=3pt] (tip.south)
        -- ($(teacher label.north)+(-2pt, 25pt)$);

        % ========
        % PHASE 4
        % ========

        % Student trajectory
        \node[message, right=88pt of task]       (task) {task};
        \node[message, below=2pt of task]    (s1) {$a_1$};
        \node[below=2pt of s1, outer ysep=2pt]    (s2) {\ldots};
        \node[message, below=2pt of s2]    (s3) {$o_{t-1}$};
        \node[
            box,
            right=15.0pt of s2,
            yshift=-1.3pt,
            tip colors,
            thick,
        ] (tip) {\shortstack{corrective\\hint}};
        \node[
            fit=(task)(s1)(s2)(s3),
            box,
            densely dashed,
            inner sep=2pt,
        ] (traj) {};
        \draw[densely dashed, semithick] 
            (teacher traj.north east |- task.west)
            -- (traj.west |- task.west);

        \draw[traj line]        (task) -- (s1);
        \draw[traj line, line cap=round]        (s1) -- (s2);
        \draw[traj line, line cap=round]        (s2) -- (s3);

        \node[above=8pt of task] (phase four) {\vphantom{p} \small\bfseries \shortstack{Training to\\internalize hints}};
        
        % Agents
        \Agent{local bounding box=student, shift={($(s3.south)+(-42pt,-32pt)$)}};
        \node[below=-1pt of student] (student label) {\scriptsize student};
        \draw[prompt]
            (traj.west |- s3.west) 
            -| ($(student.north)+(0, 2pt)$);

        \Teacher{local bounding box=teacher, shift={($(s3.south)+(39pt,-32pt)$)}};
        \node[below=-1pt of teacher] (teacher label) {\scriptsize teacher};
        \draw[prompt]
            (traj.east |- s3.east) 
            -| ($(teacher.north)+(-2.5pt, 2pt)$);
        \draw[prompt, draw=\TipDrawColor]
            (tip.south) -- ($(teacher.north)+(2.5pt, 2pt)$);

        % Logits
        \node[box, below=22pt of student] (student logits) {$a_t$};
        \draw[prompt, ->] 
            (student.south) ++ (0pt, -10.5pt) 
            -- ($(student logits.north)+(0pt, 2pt)$);
        \node[
            message,
            below=22pt of teacher,
            tip colors,
            thick,
        ] (teacher logits) {better $a_t$};
        \draw[prompt, ->, draw=\TipDrawColor] 
            (teacher.south) ++ (0pt, -10.5pt) 
            -- ($(teacher logits.north)+(0pt, 2pt)$);

        % Loss
        \node[fit=(student logits)(teacher logits)] (logits) {};
        \node[box, below=70pt of s3, inner sep=4pt] (loss) {Loss};
        \draw[prompt] (student logits) |- (loss);
        \draw[prompt, draw=\TipDrawColor] (teacher logits) |- (loss);
        \draw[prompt, draw=\TipDrawColor] 
            (loss) |- node[above, pos=0.7] {\scriptsize back-prop} 
            ($(student.east)+(4pt, -4pt)$);
        
        
    \end{tikzpicture}
}


\newcommand{\trainingCycle}{
    \begin{tikzpicture}[
        box/.style={
            thick,
            draw=black,
            rounded corners,
            inner sep=5pt,
            outer sep=3pt,
            font=\footnotesize,
            minimum width=74pt,
        },
        connection/.style={
            ->,
            thick,
            bend right=22,
        },
        node distance = 30pt,
    ]

        \def \radius {75pt}
        \def \offset {0.08}

        \node[box] (1) {
            \shortstack{Teacher agent solves\\tasks with hints}
        };
        \node[box, above=of 1] (2) {
            \shortstack{Student agent\\internalizes hints}
        };
        \node[box, left=of 2] (3) {
            \shortstack{Agent solves\\tasks without hints}
        };
        \node[box, below=of 3] (4) {
            \shortstack{Human analysis\\of mistakes}
        };

        \path (1) edge[connection] node[right] {\shortstack{training\\data}} (2);
        \path (2) edge[connection] node[above] {\shortstack{improved\\agent}} (3);
        \path (3) edge[connection] node[left] {\shortstack{trajectories}} (4);
        \path (4) edge[connection] node[below] {\shortstack{hints}} (1);
        
    \end{tikzpicture}
}


\newcommand{\mistakeAndHintExample}{
    \begin{tikzpicture}[
        message/.style={
            rounded corners,
            very thick,
            inner sep=4pt,
            outer sep=0pt,
            align=left,
            text width=0.208 * \textwidth, font=\scriptsize
        },
    ]
        \pgfdeclarelayer{background}
        \pgfsetlayers{background,main}
        
        % Prompt
        \node[
            message,
            text width=0.44 * \textwidth,
            task colors,
            % align=center,
        ] (task) {What institutions participated in the study of '2D-FRFT ENCRYPTION' in the DBLP citation network?};

        \node[
            message,
            below=4pt of task,
            text width=0.44 * \textwidth,
            action colors,
            % align=center,
        ] (inner monologue) {I should load the graph using the \texttt{load\_graph()} tool, then use the \texttt{check\_nodes()} tool to get the attributes of this paper in the PaperNet graph.};
        \begin{pgfonlayer}{background}
            \draw[ultra thick, draw=black!60] 
                (task) -- (inner monologue);
        \end{pgfonlayer}

        \node[
            message,
            below=4pt of inner monologue,
            text width=0.44 * \textwidth,
            action colors,
            font=\scriptsize \ttfamily,
        ] (action) {
            GRAPH\_DATA = load\_graph() \\
            data = check\_nodes(GRAPH\_DATA, 'PaperNet', '2D-FRFT ENCRYPTION')
        };
        \begin{pgfonlayer}{background}
            \draw[ultra thick, draw=black!60] 
                (inner monologue) -- (action);
        \end{pgfonlayer}

         % Good trajectory
        \node[
            message,
            below=4pt of action.south east,
            tip colors,
            anchor=north east,
        ] (r1) {Remember to remove duplicate institutions.};
        \begin{pgfonlayer}{background}
            \draw[ultra thick, draw=black!60] (r1.north) 
                -- (r1.north |- action.south);
        \end{pgfonlayer}

        \node[
            message,
            below=4pt of r1,
            action colors,
        ] (r2) {I can extract the 'org' fields from each author's information and store them in a set structure to prevent duplicate entries.};
        \begin{pgfonlayer}{background}
            \draw[ultra thick, draw=black!60] (r2) -- (r1);
        \end{pgfonlayer}

        \node[
            message,
            below=4pt of r2,
            action colors,
            font=\scriptsize \ttfamily
        ] (r3) {
            \textbf{orgs = set()} \\
            for author in data['authors']: \\
            \quad orgs.append(author['org']) \\
            \vphantom{p}\\
            answer = ';'.join(orgs) \\
            complete\_task(<report>, answer)
        };
        \begin{pgfonlayer}{background}
            \draw[ultra thick, draw=black!60] (r3) -- (r2);
        \end{pgfonlayer}

        \node[
            align=center,
            text width=0.25 * \textwidth,
            below=4pt of r3,
            inner sep=0pt,
            % scale=0.9,
            % draw=red,
        ] {\scriptsize \bfseries uses set to remove duplicates};

        % Bad trajectory
        \node[
            message,
            below=4pt of action.south west,
            action colors,
            anchor=north west,
        ] (l1) {I can extract the institutions from the 'org' field of the authors.};
        \begin{pgfonlayer}{background}
            \draw[ultra thick, draw=black!60] (l1.north) 
            -- (l1.north |- action.south);
        \end{pgfonlayer}

        \node[
            message,
            below=4pt of l1,
            action colors,
            font=\scriptsize \ttfamily,
        ] (l2) {
            orgs = [] \\
            for author in data['authors']: \\
            \quad orgs.append(author['org']) \\
            \vphantom{p}\\
            answer = ';'.join(orgs) \\
            complete\_task([<report>], answer)
        };
        \begin{pgfonlayer}{background}
            \draw[ultra thick, draw=black!60]
                (l2.north) -- (l1.south);
        \end{pgfonlayer}

        \node[
            align=center,
            % draw=red,
            inner sep=0pt,
            text width=0.22 * \textwidth,
            below=5pt of l2,
            % scale=0.9,
        ] {\scriptsize \bfseries forgets to remove duplicates};

    \end{tikzpicture}
}

\newcommand{\exampleTrajectoryDiagram}{
    \begin{tikzpicture}[
        legend item/.style={very thick, minimum height=10pt, minimum width=10pt},
        message/.style={font=\scriptsize, rounded corners, very thick, inner sep=4pt, outer sep=0, align=left, text width = 0.44 * \textwidth},
        fancy title/.style={font=\scriptsize\bfseries, rounded corners=3pt, right=12pt, text=white, inner xsep=3pt, inner ysep=1.5pt, scale=0.9},
        node distance=7pt,
    ]
        % Task description 
        \node[message, task colors] (m1) {\vphantom{A} \\ [-7pt]
        Please calculate the 17th number in the Fibonacci sequence.};
        \node[fancy title, fill=\TaskDrawColor] at (m1.north west) (t1) {task description};

        % Guidance
        \node[message, tip colors, below=of m1] (m2) {\vphantom{A} \\ [-7pt]
        You can use the \texttt{\footnotesize complete\_task(report: str, answer: Any)} method to return your result.};
        \node[fancy title, fill=\TipDrawColor] at (m2.north west) (t2) {hints};
        \draw[line width=2.0pt, draw=black!60] (m1) -- (m2);

        % Inner monologue 1
        \node[message, action colors, below=of m2] (m3) {\vphantom{A} \\ [-7pt] 
        My objective is to calculate the seventeenth Fibonacci number. To find the 17th Fibonacci number, I need to implement a simple function that calculates Fibonacci numbers.};
        \node[fancy title, fill=\AgentActionDrawColor, right=-12pt, anchor=east] at (m3.north east) (t3) {inner monologue};
        \draw[line width=2.0pt, draw=black!60] (m2) -- (m3);

        % Python 1
        \node[message, font=\footnotesize\ttfamily, action colors, below=of m3] (m4) {\vphantom{A} \\ [-8pt] 
        def fib(n):\\
        \quad return n if n < 2 else fib(n-1) + fib(n-2)\\
        % \vphantom{A}\\
        print(fib(17))};
        \node[fancy title, fill=\AgentActionDrawColor, right=-12pt, anchor=east] at (m4.north east) (t4) {python action};
        \draw[line width=2.0pt, draw=black!60] (m3) -- (m4);

         % Output 1
        \node[message, font=\footnotesize\ttfamily, draw=black!80, fill=black!10, below=of m4] (m5) {\vphantom{A} \\ [-7pt] 
        cell output: 1597};
        \node[fancy title, fill=black!80] at (m5.north west) (t5) {\vphantom{p}observation};
        \draw[line width=2.0pt, draw=black!60] (m4) -- (m5);

        % Inner monologue 2
        \node[message, draw=NavyBlue!90, fill=NavyBlue!10, below=of m5] (m6) {\vphantom{A} \\ [-7pt] 
        I have successfully calculated the 17th Fibonacci number, which is 1597. The task is complete, and now I need to finalize the project by reporting the result using \texttt{\footnotesize complete\_task}.};
        \node[fancy title, fill=NavyBlue!90, right=-12pt, anchor=east] at (m6.north east) (t6) {inner monologue};
        \draw[line width=2.0pt, draw=black!60] (m5) -- (m6);

        % Python 2
        \node[message, action colors, below=of m6, font=\footnotesize\ttfamily] (m7) {\vphantom{A} \\ [-8pt] 
            complete\_task("17th Fibonacci number found", 1597)};
        \node[fancy title, fill=\AgentActionDrawColor, right=-12pt, anchor=east] at (m7.north east) (t7) {python action};
        \draw[line width=2.0pt, draw=black!60] (m6) -- (m7);
        
    \end{tikzpicture}
}



