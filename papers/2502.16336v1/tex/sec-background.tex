% !TEX root = ../main.tex
  
  Consider a regression problem that aims to estimate a $d$-dimensional response vector $y \in \mathcal{Y} = \mathbb{R}^d$ based on a feature vector $x \in \mathcal{X} \subseteq \R^p$ to predict. We emphasize that one of the main goals of our work is the case of $d > 1$. We denote by $\textup{P}_{X,Y}$ over $\mathcal{X} \times \mathcal{Y}$ the joint distribution of $(X,Y)$. %We have access to a data set $\mathcal{D} = \{(X^{(j)}, Y^{(j)})\}_{j=1}^n$ where $(X^{(j)}, Y^{(j)}) \overset{\text{i.i.d.}}{\sim} \textup{P}_{X,Y}$. 

  Construction of prediction regions for regression problems is often based on distributional regression that focuses on fully characterizing the conditional distribution of a response variable given a covariate~\cite{klein2024distributional}. This approach improves uncertainty quantification and decision-making~\cite{Berger2019-ju}. From the conditional predictive distribution, prediction regions can be derived to capture values likely to occur with a given probability. However, these regions rely heavily on the predictive model's quality, and poorly estimated models can result in unreliable predictions. 
  %To address this, conformal prediction~\citep[CP,][]{angelopoulos2023conformal,Angelopoulos2024-dr} provides a framework for generating more reliable prediction regions, even when the predictive model is misspecified or inaccurate.
  In the following, we present split-conformal prediction~\citep[SCP;][]{papadopoulos2002inductive}, a computationally efficient variant of conformal prediction framework that allows to generate reliable prediction regions, even when the predictive model is misspecified or inaccurate.


\paragraphformat{Split conformal prediction (SCP).}
  %Let $g\colon \mathcal{X} \to \mathcal{S}$ represent a regression model that maps a covariate $x \in \mathcal{X}$ to a prediction space $\mathcal{S}$. For example, if $g(x)$ estimates the conditional mean or quantile of $Y$ given $X = x$, then $\mathcal{S} = \mathcal{Y}$. If $g(x)$ instead estimates the conditional probability density function (PDF) of $Y$ given $X = x$, $\mathcal{S}$ corresponds to the space of PDFs over $\mathcal{Y}$.
  %
  Given a possibly misspecified predictive model $g(x)$, for any input $x \in \mathcal{X}$, SCP~\cite{papadopoulos2002inductive} generates a prediction set $\mathcal{C}_{\alpha}(x)$ at a user-specified confidence level $\alpha \in (0, 1)$ with \textit{marginal validity}~\cite{papadopoulos2008inductive}:
  \begin{equation}
  \label{eq:ge:coverage}
    \prob\bigl(Y \in \mathcal{C}_{\alpha}(X)\bigr) \ge 1-\alpha.
  \end{equation}
  %
  To do so, SCP relies on the so-called \textit{conformity score} function, $V\colon \XC \times \YC \to \R$, which should assign larger value to worse agreement between $g(X)$ and $Y$. Let $\{(X_k,Y_k)\}_{k=1}^{\tcount}$ be a calibration set, with $\XC \subseteq \mathbb{R}^p$ and $\YC \subseteq \mathbb{R}^d$. SCP generates a prediction set $\mathcal{C}_{\alpha}(x)$ by computing an empirical quantile of the conformity scores $V(X_k, Y_k), k = 1, \dots, \tcount$:
  \begin{equation}\label{eq:split_conformal}
    \resizebox{0.9\hsize}{!}{$
    \mathcal{C}_{\alpha}(x)
    = \ac{
      y\colon V(x, y) \le \q{1-\alpha}\pr{\sum_{k=1}^{\tcount} \frac{\delta_{V(X_k, Y_k)}}{\tcount+1} + \frac{\delta_{\infty}}{\tcount+1} }
    }
    $},
  \end{equation}
  where $\delta_v$ is the Dirac mass at $v$, and $\q{1-\alpha}\pr{\textup{P}}$ denote the $(1-\alpha)$-quantile for any distribution $\textup{P}$ on $\R$.

\paragraphformat{Towards conditional validity of CP methods.}  
  In many applications, conditional validity is a natural requirement, i.e., for all $x \in \XC$,
  \begin{equation}
  \label{eq:def:conditional-validity}
    \prob\pr{Y \in \mathcal{C}_{\alpha}(X) \mid X = x} \ge 1 - \alpha.
  \end{equation}
  %
  Conditional coverage~\eqref{eq:def:conditional-validity} is stronger and implies marginal coverage~\eqref{eq:ge:coverage}. While classical conformal methods provide marginal validity~\eqref{eq:ge:coverage}, they do not ensure conditional validity. 

  Let us denote the conditional distribution \(\textup{P}_{\mathbf{V}|X=x}\) with $\mathbf{V}$ being a shorthand for $V(X, Y)$. The following oracle prediction set
  \begin{align}
    &\mathcal{C}_{\alpha}(x) = \bigl\{y \in \YC\colon V(x, y) \leq Q_{1-\alpha}(\textup{P}_{\mathbf{V}|X=x})\bigr\}
  \label{eq:oracle_cc}
  \end{align}
  trivially satisfies conditional coverage~\eqref{eq:def:conditional-validity} by the definition of conditional quantile \(Q_{1-\alpha}(\textup{P}_{\mathbf{V}|X=x})\). However, exact conditional validity is not achievable within conformal prediction framework~\cite{foygel2021limits}. In what follows we will present a new conformal prediction method that will achieve approximate conditional validity while satisfying exact marginal guarantees. 
