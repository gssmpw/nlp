%!TEX root = catuscia.tex

%% file probabilistic.tex

\section{Branching {\bisimilarity} for probabilistic processes} 
\label{sec-bpb}

In this section we define branching {\bisimilarity}
for probabilistic processes.

Following~\cite{BS01:icalp}, we start with adapting the syntax of
processes, now distinguishing non-deterministic processes~$E \in
\calE$ and probabilistic processes~$P \in \calP$.

\begin{definition}[Syntax]
  The classes $\calE$ and~$\calP$ of non-deterministic and
  probabilistic processes over~$\calA$, respectively, ranged over by
  $E$ and~$P$, are given by
  \begin{align*}
    E & \bnfeq \bfzero \mid \alpha \pref P \mid E + E \\
    P & \bnfeq \partial(E) \mid P \oplusr P 
  \end{align*}
  with actions~$\alpha$ from~$\calA$ where $r \in (0,1)$.
\end{definition}

\noindent
The probabilistic process $P_1 \oplusr P_2$ executes the behavior
of~$P_1$ with probability~$r$ and the behavior~$P_2$ with
probability~$1-r$. By convention, $P \probc1 Q$ denotes~$P$ and $P
\probc0 Q$ denotes~$Q$.

We again introduce the complexity measure~$c$, now for
non-deterministic and probabilistic processes, based on the depth of a
process.  The complexity measure $c : \calE\cup \calP \to \bbbn$
is given by $c(\bfzero) = 0$, $c(\alpha \pref P) = c(P) + 1$, $c(E+F)
= c(E)+c(F)$, and~$c(\partial(E)) = c(E) + 1$, $c(P \oplusr Q) = c(P) +
c(Q)$.

\blankline

\noindent
As usual SOS semantics for $\calE$ and~$\calP$ makes use of two types
of transition relations~\cite{HJ90:rtss,BS01:icalp}.

\pagebreak[3]

\begin{definition}[Operational semantics]
  \label{def-pr-transition-relation} \mbox{}
  \begin{itemize}
    \item [(a)] The transition relations ${\rightarrow} \subseteq
      \calE \times \calA \times \Distr(\calE)$ and ${\mapsto}
      \subseteq \calP \times \Distr(\calE)$ are given by\vspace{-2.5ex}
      \begin{displaymath}
        \begin{array}{c}
          \sosrule{P \mapsto \mu}{\alpha \pref P \arrow{\alpha} \mu}
          \: \textsc{\small (pref)}
          \medskip \\
          \sosrule{E_1 \arrow{\alpha} \mu_1}{E_1 + E_2 \arrow{\alpha}
            \mu_1}
          \: \textsc{\small (nd-choice\,1)}
          \qquad
          \sosrule{E_2 \arrow{\alpha} \mu_2}{E_1 + E_2 \arrow{\alpha}
            \mu_2}
          \: \textsc{\small (nd-choice\,2)}
          \bigskip \\
          \sosrule{}{\partial(E) \mapsto \delta(E)}
          \: \textsc{\small (Dirac)}
          \qquad
          \sosrule{P_1 \mapsto \mu_1 \quad P_2 \mapsto
            \mu_2}{P_1 \oplusr P_2 \mapsto \mu_1 \oplusr \mu_2}
          \: \textsc{\small (p-choice)}
        \end{array}
      \end{displaymath}
    \item [(b)] The transition relation ${\rightarrow}
      \subseteq \DistrE \times \calA \times \DistrE$ is such that $\mu
      \alphaarrow \mu'$ whenever $\mu = \bigoplusiinI \: p_i * E_i$,
      $\mu' = \bigoplusiinI \: p_i * \mu'_i $, and $E_i \alphaarrow
      \mu'_i$ for all $i \in I$.
      \vspace{-.5ex}
  \end{itemize}
\end{definition}

\noindent
With $\den{P}$, for $P\in\calP$, we denote the unique distribution $\mu$ such that $P\mapsto\mu$.

The transition relation~$\rightarrow$ on distributions allows for a
probabilistic combination of non-deterministic alternatives resulting
in a so-called combined transition,
cf.~\cite{SL94:concur,Seg95:thesis}. For example, for $E \equiv a
\pref (P \probc{1/2} Q) + a \pref (P \probc{1/3} Q)$, the Dirac
process $\delta(E) \equiv \delta( a \pref (P \probc{1/2} Q) + a \pref
(P \probc{1/3} Q) )$ provides an $a$-transition to $\den{P \probc{1/2} Q}$
as well as an $a$-transition to $\den{P \probc{1/3} Q}$. However, since for
distribution~$\delta(E)$ it holds that $\delta(E) = \frac12 \delta(E)
\oplus \frac12 \delta(E)$ there is also a transition
\begin{displaymath}
  \delta(E) 
  = \half \delta(E) \oplus \half \delta(E)
  \arrow{a} \half \den{P \probc{1/2\mkern1mu} Q} \oplus \half \den{P
  \probc{1/3\mkern1mu} Q} = \den{P \probc{5/12\mkern2mu} Q}.
\end{displaymath}
As noted in~\cite{Sto02:phd}, the ability to combine transitions is
crucial for obtaining transitivity of probabilistic process
equivalences that take internal actions into account.

Referring to the example in the introduction, the processes of $t_0$
and~$u_0$ will be identified.  However, without the splitting of the
source distribution~$\mu$ as provided by
Definition~\ref{def-pr-transition-relation}, we are not able to relate
$t_0$ and~$u_0$ directly, or rather their direct derivatives, while
meeting the natural transfer conditions (see
Definition~\ref{def-probabilistically-branching-bisimilar}).  The
difficulty arises when both $P$ and $Q$ can do a $\tau$-transition to
non-bisimilar processes.

In preparation to the definition of the notion of branching
probabilistic {\bisimilarity} below we introduce some notation.

\begin{definition}
  For $\mu, \mu' \mathbin\in \DistrE$ and $\alpha \mathbin\in \calA$ we write
  $\mu \alphahidearrow \mu'$ iff (i)~$\mu \alphaarrow \mu'$, or
  (ii)~$\alpha = \tau$ and $\mu = \mu_1 \oplusr \mu_2$,
  $\mu' = \mu'_1 \oplusr \mu'_2$ such that $\mu_1 \arrow{\tau} \mu_1'$
  and $\mu_2 = \mu'_2$ for some $r \in [0,1]$. We use
  $\Arrow{}$ to denote the reflexive transitive closure of
  $\arrow{(\tau)}$.
\end{definition}

\noindent
Thus, for example,\vspace{-1ex}
\begin{gather*}
  \myfrac13 \delta( \tau \pref (P \probc{1/2} Q)) \oplus
  \myfrac23 \den{ P \probc{1/2} Q } \  \arrow{(\tau)} \   \den{P \probc{1/2} Q} 
  \quad \text{and} \\
  \myfrac12 \delta( \tau \pref \partial ( \tau \pref P )) \oplus
  \myfrac13 \delta( \tau \pref P ) \oplus \myfrac16 \den{P}
  \Arrow{} \den{P}.
\end{gather*}


We are now in a position to define strong probabilistic {\bisimilarity}
and branching probabilistic {\bisimilarity}. Note that the notion of strong
probabilistic {\bisimilarity} is the variant with combined transitions as defined in 
\cite{SL94:concur,BS01:icalp}. 

\begin{definition}[Strong and branching probabilistic {\bisimilarity}]
  \label{def-probabilistically-branching-bisimilar}
  \begin{itemize}
  \item [(a)] A symmetric relation $\calR \subseteq \DistrE \times
    \DistrE$ is called \textit{decomposable} iff for all $\mu, \nu \in
    \DistrE$ such that $\mu \mopcalR \nu$ and $\mu = \bigoplusiinI \:
    p_i * \mu_i$ there are $\nu_i \in \DistrE$, for~$i \in I$,
    such that
    \begin{displaymath}
      \nu  = \bigoplusiinI \: p_i * \nu_i \ 
      \text{and} \ 
      \mu_i \mopcalR \nu_i 
      \ \text{for all~$i \in I$.}
    \end{displaymath}

  \item [(b)] A decomposable relation $\calR \subseteq \DistrE \times
    \DistrE$ is called a \emph{strong probabilistic bisimulation
    relation} iff for all $\mu, \nu \in \DistrE$ such that $\mu
    \mopcalR \nu$ and $\mu \arrow{\alpha} \mu'$ there is a $\nu'
    \in \DistrE$ such that
    \begin{displaymath}
      \nu \alphaarrow \nu' \ \text{and} \ 
      \mu' \mopcalR \nu'.
    \end{displaymath}

  \item [(c)] A symmetric relation $\calR \subseteq \DistrE \times
    \DistrE$ is called \textit{weakly decomposable} iff for all $\mu,
    \nu \in \DistrE$ such that $\mu \mopcalR \nu$ and $\mu =
    \bigoplusiinI \: p_i * \mu_i$ there are $\nubar, \nu_i \in
    \DistrE$, for~$i \in I$, such that
    \begin{displaymath}
      \nu \Arrow{} \nubar,\ 
      \mu \mopcalR \nubar,\  
      \nubar = \bigoplusiinI \: p_i * \nu_i,\ 
      \text{and} \ 
      \mu_i \mopcalR \nu_i 
      \ \text{for all~$i \in I$.}
    \end{displaymath}

  \item [(d)] A weakly decomposable relation $\calR \subseteq \DistrE
    \times \DistrE$ is called a \emph{branching} probabilistic
    bisimulation relation iff for all $\mu, \nu \in \DistrE$ such
    that $\mu \mopcalR \nu$ and $\mu \arrow{\alpha} \mu'$, there are
    $\nubar, \nu' \in \DistrE$ such that
    \begin{displaymath}
      \nu \Arrow{} \nubar, \ 
      \nubar \alphahidearrow \nu', \ 
      \mu \mopcalR \nubar, \ \text{and} \ 
      \mu' \mopcalR \nu'.
    \end{displaymath}

  \item [(e)] Strong probabilistic {\bisimilarity}, denoted by~${\bisim}
    \subseteq \DistrE \times \DistrE$, and branching probabilistic
    {\bisimilarity}, written as~${\brbisim} \subseteq \DistrE \times
    \DistrE$, are respectively defined as the largest strong
    probabilistic bisimulation relation on~$\DistrE$ and as the
    largest branching probabilistic bisimulation relation
    on~$\DistrE$.
  \end{itemize}
\end{definition}

\noindent
By comparison, on finite processes, as used in this paper,
the branching probabilistic bisimilarity of Segala \&
Lynch~\cite{SL94:concur} can be defined in our framework exactly as in
(d) and~(e) above, but taking a decomposable instead of a weakly
decomposable relation. This yields a strictly finer equivalence,
distinguishing the processes $s_0$, $t_0$ and $u_0$ from the
introduction.

The notion of decomposability has been adopted from~\cite{Hen12:facj}
and weak decomposability from~\cite{LV16}. The underlying idea stems
from \cite{DGHM09}. These notions provide a convenient dexterity to
deal with behavior of sub-distributions, e.g., to distinguish
$\myfrac12 \partial( a \pref \partial(\bfzero)) \oplus \myfrac12
\partial( b \pref \partial(\bfzero))$ from $\partial(\bfzero)$, as
well as combined behavior.


\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
    \node[shape=circle,draw,inner sep=0.5pt] (char) {#1};}}

Our definition of branching probabilistic {\bisimilarity} is based on
distributions rather than on states and has similarity with the notion
of weak distribution {\bisimilarity} proposed by Eisentraut et
al.\ in~\cite{EHKTZ13:qest}. Consider the running example
of~\cite{EHKTZ13:qest}, reproduced in Figure~\ref{PA-of-Eisentraut}
and reformulated in terms of the process language at hand. The states
\circled{1} and~\circled{6} are identified with respect to weak
distribution {\bisimilarity} as detailed
in~\cite{EHKTZ13:qest}. Correspondingly, putting
\begin{displaymath}
  \begin{array}{rcl}
  E_1 & = & \tau \pref \bigl(
  \partial\dg( 
    \tau \pref \partial\dor( \tau \pref P + c \pref Q + \tau \pref R
    \dor) + 
    c \pref Q + \tau \pref R \dg) 
  \probc{1/2}
  {} \\ & & \phantom{\tau \pref \bigl( {}}
  \partial\dg( \tau \pref \mg(
    \partial\dor( \tau \pref P + c \pref Q + \tau \pref R \dor)
    \probc{1/2}
    \partial( \bfzero ) \mg) \dg)
  \bigr) \smallskip \\  
  E_6 & = & \tau \pref ( \partial\dor( \tau \pref P + c \pref Q + \tau \pref
  R \dor) \probc{3/4} \partial( \bfzero ) )
  \end{array}
\end{displaymath}
the non-deterministic processes
$E_1$ and~$E_6$ are identified with respect to branching probabilistic
{\bisimilarity}.

\begin{figure}
  \input{example02}
  \vspace*{-0.50cm}
  \caption{Probabilistic automaton of~\cite{EHKTZ13:qest}}
  \label{PA-of-Eisentraut}
\end{figure}

Note that strong and branching probabilistic {\bisimilarity} are
well-defined since any union of strong or branching probabilistic
bisimulation relations is again a strong or branching probabilistic
bisimulation relation. In particular, (weak) decomposability is
preserved under arbitrary unions.

\blankline

\noindent
As we did for the non-deterministic setting, we introduce a notion of
rooted branching probabilistic {\bisimilarity} for distributions over
processes. 

\begin{definition}
  \label{rooted-bpb}
  A symmetric and decomposable relation $\calR \mathbin\subseteq \DistrE
  \times \DistrE$ is called a rooted branching probabilistic
  bisimulation relation iff for all $\mu, \nu \in \DistrE$ such that
  $\mu \mopcalR \nu$ it holds that if $\mu \arrow{\alpha} \mu'$
  for~$\alpha \in \calA$, $\mu' \in \DistrE$ then $\nu \arrow{\alpha}
  \nu'$ and $\mu' \brbisim \nu'$ for some~$\nu' \in \DistrE$. Rooted
  branching probabilistic bisimilarity, denoted by ${\rootedbrbisim}
  \subseteq \DistrE \times \DistrE$, is defined as the largest rooted
  branching probabilistic bisimulation relation.
\end{definition}

\noindent
  Since any union of rooted branching probabilistic bisimulation
  relations is again a rooted branching probabilistic bisimulation
  relation, rooted branching probabilistic
  {\bisimilarity}~$\rootedbrbisim$ is well-defined.

  Note, the two probabilistic processes
  \begin{displaymath}
    P = \partial( \tau \pref \partial(\astop)) \probc{1/2} \partial(\bstop)
    \quad \text{and} \quad
    Q = \partial(\astop) \probc{1/2} \partial(\bstop)
  \end{displaymath}
  are \emph{not} rooted branching probabilistically bisimilar. Any
  rooted branching probabilistic bisimulation relation is by
  decomposability required to relate the respective probabilistic
  components $\partial( \tau \pref \partial(\astop))$ and
  $\partial(\astop)$, which clearly do not meet the transfer
  condition. Thus, since $\partial( \tau \pref \partial(\astop))
  \nrootedbrbisim \partial(\astop)$ also~$P \nrootedbrbisim Q$.

Two non-deterministic processes are considered to be strongly, rooted
branching, or branching probabilistically bisimilar iff their Dirac
distributions are, i.e., $E \bisim F$ iff $\delta(E) \bisim \delta(F)$,
$E \rootedbrbisim F$ iff $\delta(E) \rootedbrbisim \delta(F)$, and $E
\brbisim F$ iff $\delta(E) \brbisim \delta(F)$. 
%%
Two probabilistic processes are considered to be strongly, rooted
branching, or branching probabilistically bisimilar iff their
associated distributions over~$\calE$ are.

We show that branching probabilistic bisimilarity, although not a
congruence for non-deterministic choice, is a congruence for
probabilistic choice. We first need a technical result.

  \begin{lemma}
    \label{flexibelDelen}
    Let $I$ and~$J$ be finite index sets, $p_i,q_j\in[0,1]$ and
    $\xi, \mu_i,\nu_j \in \DistrE$, for $i \in I$ and $j \in J$, with
    $\xi = \bigoplusiinI\: p_i*\mu_i$ and
    $\xi =\bigoplusjinJ \: q_j * \nu_j$. Then there are
    $r_{ij} \in [0,1]$ and $\varrho_{ij} \in \DistrE$ such that
    $\sum_{i\in I} \: r_{ij}=q_j$, $\sum_{j\in J} \: r_{ij}=p_i$,
    \begin{math}
      p_i * \mu_i = \bigoplusjinJ \: r_{ij} * \varrho_{ij}
      \textrm{ for all}~i \in I,
      \textrm{ and } 
      q_j * \nu_j = \bigoplusiinI \: r_{ij} * \varrho_{ij}
      \textrm{ for all}~j \in J.
    \end{math}
\end{lemma}

\begin{proof}
  Let
  \begin{math}\displaystyle
    r_{ij} = \sum_{E\in \mathit{spt}(\xi)} \:
    \frac{\rule[-3pt]{0pt}{10pt} p_i\mu_i(E) \, q_j
      \nu_j(E)}{\rule{0pt}{7pt} \xi(E)}
  \end{math}
  for all $i \in I$ and $j \in J$.
  In case $r_{ij}=0$ choose $\varrho_{ij}\in\DistrE$ arbitrarily.
  Otherwise, define for all $E \in \cal{E}$, $i \in I$, $j \in J$:
  \begin{displaymath}
    \varrho_{ij}(E) =
    \left\lbrace
      \begin{array}{cl}
        \displaystyle\frac
        {\rule[-3pt]{0pt}{10pt} p_i\mu_i(E) \, q_j \nu_j(E)}
        {\rule{0pt}{7pt} r_{ij} \, \xi(E)} \quad &
        \textrm{if } \xi(E)>0, \\
        0 & \textrm{otherwise.}
      \end{array}
    \right.
  \end{displaymath}
  With these definitions it is straightforward to check the
  required properties.
\end{proof}

\begin{lemma}
  \label{unrooted congruence}
  Let $\mu_1,\mu_2,\nu_1,\nu_2\in \DistrE$ and $r\in(0,1)$. If $\mu_1
  \brbisim \nu_1$ and $\mu_2 \brbisim \nu_2$ then $\mu_1 \probc{r}
  \mu_2 \brbisim \nu_1 \probc{r} \nu_2$.
\end{lemma}

\begin{proof}
  Suppose $\mu_1 \brbisim \nu_1$ and $\mu_2 \brbisim \nu_2$ through
  branching probabilistic bisimulation relations $\calR_1$
  and~$\calR_2$. We show that the relation $\calR = \lc \langle \xi'
  \probc{s} \xi'' , \eta' \probc{s} \eta'' \rangle \mid \xi'
  \mathop{\calR_1} \eta' ,\, \xi'' \mathop{\calR_2} \eta'' ,\, {s \in
    (0,1)} \rc$ is a branching probabilistic bisimulation relation
  relating $\mu_1 \probc{r} \mu_2$ with $\nu_1 \probc{r} \nu_2$.
  
  Symmetry is straightforward. We show that $\calR$ is weakly
  decomposable. So, assume $\xi \mopcalR \eta$ and $\xi =
  \bigoplusiinI \: p_i * \xi_i$. Thus, $\xi = \xi' \probc{s} \xi''$
  and $\eta = \eta' \probc{s} \eta''$ with $\xi' \mathop{\calR_1}
  \eta'$ and $\xi'' \mathop{\calR_2} \eta''$ for suitable $\xi',
  \xi'', \eta', \eta'' \in \DistrE$. By Lemma~\ref{flexibelDelen}
  there must be $s'_i, s''_i \geqslant 0$ and $\xi'_i, \xi''_i \in
  \DistrE$, for $i \in I$, such that
  \begin{displaymath}
    \begin{array}{lcl}
      \xi' & = & \bigoplusiinI \: s'_i/s * \xi'_i \, , 
      \smallskip \\ 
      \xi''  & = & \bigoplusiinI \: s''_i/(1{-}s) * \xi''_i
      \, , 
      \smallskip \\ 
      \xi_i & = & ( s'_i/p_i * \xi'_i ) \oplus ( s''_i/p_i * \xi''_i )
      \quad \text{for all $i\in I$\,,}
    \end{array}
  \end{displaymath}
  $\sum_{i\in I}s'_i = s$, $\sum_{i\in I}s''_i = 1{-}s$,
  and $s'_i + s''_i = p_i$ for all $i \in I$.
  Since $\calR_1$ and~$\calR_2$ are weakly decomposable, there are
  $\etabar', \etabar'', \eta'_i, \eta''_i \in \DistrE$ for~$i \in I$
  such that
  \begin{displaymath}
    \begin{array}{lclclcl}
      \eta' \Arrow{} \etabar' & \quad &
      \xi' \mathop{\calR_1} \etabar' , & \quad &
      \etabar' \, = \bigoplusiinI \:
      {s'_i}/{s} * \eta'_i , & \quad &
      \xi'_i \mathop{\calR_1} \eta'_i
      , \smallskip \\ 
      \eta'' \Arrow{} \etabar'' &&
      \xi'' \mathop{\calR_2} \etabar'' &&
      \etabar'' = \bigoplusiinI \:
      {s''_i}/{(1{-}s)} * \eta''_i &&
      \xi''_i \mathop{\calR_1} \eta''_i 
  \end{array}
  \end{displaymath}
  for all $i \in I$. Therefore, we can conclude that 
  \begin{displaymath}
    \eta' \probc{s} \eta'' \Arrow{} \etabar' \probc{s} \etabar''
    \quad \text{and} \quad
    ( \xi' \probc{s} \xi'' ) \mopcalR \mkern1mu ( \etabar'
    \probc{s} \etabar'' )
    \, .
  \end{displaymath}
  Moreover, 
  \begin{displaymath}
    \begin{array}{rcl}
      \etabar' \probc{s} \etabar'' & = &
      \bigl( \bigoplusiinI \: {s'_i}/{s} * \eta'_i \bigr)
      \probc{s} 
      \bigl( \bigoplusiinI \: {s''_i}/{(1{-}s)} * \eta''_i \bigr) 
      \smallskip \\
      & = &
      \bigl( \bigoplusiinI \: s'_i * \eta'_i \bigr)
      \oplus 
      \bigl( \bigoplusiinI \: s''_i * \eta''_i \bigl)
      \smallskip \\ & = & \phantom{\bigl(}
      \bigoplusiinI \: p_i * ( \eta'_i \probc{s'_i/p_i} \eta''_i )
    \end{array}
  \end{displaymath}
  and $\xi_i = ( \xi'_i \probc{s'_i/p_i} \xi''_i ) \mopcalR
  \mkern1mu ( \eta'_i \probc{s'_i/p_i} \eta''_i )$ for all $i \in I$.
  This finishes the argument that $\calR$ is decomposable.
  
  Next, we show that $\calR$ satisfies the transfer property for
  bisimulations. Suppose we have $(\xi_1 \probc{r} \xi_2) \calR
  (\eta_1 \probc{r} \eta_2)$, thus $\xi_1 \calR_1 \xi_2$ and $\eta_1
  \calR_2 \eta_2$. If $\xi_1 \probc{r} \xi_2 \alphaarrow \xi'$ then
  $\xi_1 \alphaarrow \xi'_1$, $\xi_2 \alphaarrow \xi'_2$ and $\xi' =
  \xi'_1 \probc{r} \xi'_2$ for suitable $\xi'_1, \xi'_2 \in
  \DistrE$.\vspace{1pt} By assumption, $\bar\eta_1,\eta'_1$
  and~$\bar\eta_2, \eta'_2$ exist such that $\eta_1 \Arrow{} \etabar_1
  \alphahidearrow \eta'_1$, $\eta_2 \Arrow{} \etabar_2 \alphahidearrow
  \eta'_2$, $\xi_1 \mathop{\calR_1} \etabar_1$, $\xi_2
  \mathop{\calR_2} \etabar_2$, $\xi'_1 \mathop{\calR_1} \eta'_1$,
  and~$\xi'_2 \mathop{\calR_2} \eta'_2$. From this we obtain $\eta_1
  \probc{r} \eta_2 \Arrow{} \etabar_1 \probc{r} \etabar_2\linebreak[3]
  \alphahidearrow \eta'$, $\xi_1 \probc{r} \xi_2 \mopcalR
  \etabar_1 \probc{r} \etabar_2$ and~$\xi' \mopcalR \eta'$ for
  $\eta' = \eta'_1 \probc{r} \eta'_2$.
\end{proof}

\noindent
A direct consequence of the previous lemma is that if $P_1 \brbisim
Q_1$ and $P_2 \brbisim Q_2$ then $P_1 \probc{r} P_2 \brbisim Q_1
\probc{r} Q_2$.


\begin{lemma} [Congruence]
  \label{lemma-congruence-prob}
  The relations $\bisim$, $\rootedbrbisim$, and~$\brbisim$ on $\calE$
  and~$\calP$ are equivalence relations, and the relations $\bisim$ and
  $\rootedbrbisim$ are congruences on $\calE$ and~$\calP$.
\end{lemma}

\begin{proof}
  The proof of $\bisim$, $\rootedbrbisim$, and~$\brbisim$ being
  equivalence relations involves a number of straightforward auxiliary
  results, in particular for the case of transitivity, and are omitted
  here.

  Regarding congruence the interesting cases are for non-deterministic
  and probabilistic choice with respect to rooted branching probabilistic
  {\bisimilarity}.
%
  Suppose $E_1 \rootedbrbisim F_1$ and $E_2 \rootedbrbisim F_2$. Then
  $\calR = \singleton{ \langle \delta(E_1+E_2) , \delta(F_1+F_2)
    \rangle }^\dagger$ is a rooted branching probabilistic
  bisimulation relation. Clearly, $\calR$~is symmetric and
  decomposable. Moreover, if $\delta(E_1+E_2) \arrow{\alpha} \mu'$,
  then either $\delta(E_1) \alphaarrow \mu'$, $\delta(E_2) \alphaarrow
  \mu'$, or $\delta(E_1) \alphaarrow \mu'_1$, $\delta(E_2) \alphaarrow
  \mu'_2$ and $\mu' = \mu'_1 \probc{r} \mu'_2$ for suitable $\mu'_1,
  \mu'_2 \in \DistrE$ and~$r \in (0,1)$. We only consider the last
  case, as the first two are simpler.  Hence, we can find $\nu'_1,
  \nu'_2 \in \DistrE$ such that $\delta(F_1) \alphaarrow \nu'_1$,
  $\delta(F_2) \alphaarrow \nu'_2$, $\mu'_1 \brbisim \nu'_1$,
  and~$\mu'_2 \brbisim \nu'_2$. From this it follows that
  $\delta(F_1+F_2) \alphaarrow \nu'$ and~$\mu' \brbisim \nu'$
  for~$\nu' = \nu'_1 \probc{r} \nu'_2$ using Lemma \ref{unrooted
    congruence}.

  Suppose $P_1 \rootedbrbisim Q_1$ and $P_2 \rootedbrbisim Q_2$ with
  $\calR_1$ and~$\calR_2$ rooted branching probabilistic bisimulation
  relations relating $\den{P_1}$ with~$\den{Q_1}$, and $\den{P_2}$
  with~$\den{Q_2}$, respectively, and fix some~$r\in(0,1)$. Then
  $\calR = \lc \langle {\mu}_1 \probc{r} {\mu}_2 , \nu_1 \probc{r}
  \nu_2 \rangle \mid {\mu}_1 \calR_1 \nu_1 ,\, {\mu}_2 \calR_2 \nu_2
  \rc$ is a rooted branching probabilistic bisimulation relation
  relating $\den{P_1 \probc{r} P_2}$ with~$\den{Q_1 \probc{r} Q_2}$.
%
  Symmetry is straightforward and decomposability can be shown along the lines
    of the proof of weak decomposability for Lemma~\ref{unrooted congruence}. 
    
  So we are left to prove the transfer property. 
%
  Suppose $({\mu}_1 \probc{r} {\mu}_2) \calR (\nu_1 \probc{r}
  \nu_2)$, thus $\mu_1 \calR_1 \mu_2$ and $\nu_1 \calR_2 \nu_2$. If
  $\mu_1 \probc{r} {\mu}_2 \alphaarrow {\mu'}$ then ${\mu}_1
  \alphaarrow \mu'_1$, $\mu_2 \alphaarrow \mu'_2$ and $\mu' = \mu'_1
  \probc{r} \mu'_2$ for suitable $\mu'_1, \mu'_2 \in \DistrE$. By
  assumption, $\nu'_1$ and~$\nu'_2$ exist such that $\nu_1 \alphaarrow
  \nu'_1$, $\nu_2 \alphaarrow \nu'_2$, $\mu'_1 \brbisim \nu'_1$,
  and~$\mu'_2 \brbisim \nu'_2$. From this we obtain $\nu_1 \probc{r}
  \nu_2 \alphaarrow \nu'$ and by Lemma~\ref{unrooted congruence}~$\mu'
  \brbisim \nu'$ for $\nu' = \nu'_1 \probc{r} \nu'_2$.
\end{proof}

\section{A few fundamental properties of branching bisimilarity}
\label{fundamental}

In this section we show two fundamental properties of branching probabilistic
bisimilarity that we need further on: the stuttering property, known
from~\cite{GW96:jacm} for non-deterministic processes, and
cancellativity of probabilistic choice with respect to ${\brbisim} \mkern1mu$.

\begin{lemma}[Stuttering Property]
  \label{stuttering}
  If $\mu \Arrow{} \bar\mu \Arrow{} \nu$ and $\mu\brbisim\nu$
  then $\mu\brbisim\bar\mu$.
\end{lemma}

\begin{proof}
  We show that the relation ${\brbisim} \mkern1mu \cup \{
  (\mu,\bar\mu), (\bar\mu,\mu) \}$ is a branching probabilistic
  bisimulation.

  First suppose $\mu \arrow\alpha \mu'$. Then there are
    $\nubar, \nu' \in \DistrE$ such that
    \begin{displaymath}
      \nu \Arrow{} \nubar, \ 
      \nubar \alphahidearrow \nu', \ 
      \mu \brbisim \nubar, \ \text{and} \ 
      \mu' \brbisim \nu'.
    \end{displaymath}
  Since $\bar\mu \Arrow{} \nu$, we have $\bar\mu \Arrow{} \nubar$,
  which had to be shown. 
%
  Now suppose $\bar\mu \arrow\alpha \mu'$.
  Then certainly $\mu \Arrow{}\bar\mu\arrow\alpha \mu'$.

  To show weak decomposability, suppose 
  $\mu = \bigoplusiinI \: p_i * \mu_i$.
  Then there are $\nubar, \nu_i \in \DistrE$, for~$i \in I$, such that
    \begin{displaymath}
      \nu \Arrow{} \nubar,\ 
      \mu \mopcalR \nubar,\  
      \nubar = \bigoplusiinI \: p_i * \nu_i,\ 
      \text{and} \ 
      \mu_i \mopcalR \nu_i 
      \ \text{for all~$i \in I$.}
    \end{displaymath}
  Again it suffices to point out that $\bar\mu \Arrow{} \nubar$.
%
  Conversely, suppose $\bar\mu = \bigoplusiinI \: p_i * \bar\mu_i$.
  Then $\mu  \Arrow{} \bar\mu = \bigoplusiinI \: p_i * \bar\mu_i$.
\end{proof}

\noindent
For $S \subseteq\calE$ and $\mu\in\DistrE$, define
$\mu(S)=\sum_{E\in\calE}\mu(E)$. Now two distributions $\mu$ and~$\nu$
are strong probabilistic bisimilar iff for each bisimulation
equivalence class $S\subseteq\calE$ one has $\mu(S)=\nu(S)$. The proof
is essentially the same as that of Lemma~\ref{decomp} below. However,
such a property does not hold for branching probabilistic
bisimilarity, due to the use of weak decomposability instead of
decomposability. But it does hold when restricting attention to a
class of processes on which weak decomposability reduces to
decomposability.

Call a distribution $\mu\in\DistrE$ \emph{$\brbisim$-stable} iff, for
all $\bar\mu\in\DistrE$, 
\begin{equation}\label{stable}
  \mu \Arrow{} \bar\mu \ \text{and} \ \mu \mathrel{\brbisim} \bar\mu
  \ \text{implies} \ \bar\mu = \mu\;,
\end{equation}
i.e., if it cannot perform internal activity without leaving its
branching bisimulation equivalence class. Note that if a distribution
$\mu \oplusr \nu$ with $r \in (0,1)$ is $\brbisim$-stable, then so are
$\mu$ and~$\nu$.

\begin{lemma}
  \label{decomp}
  If $\mu$ and $\nu$ are $\brbisim$-stable then $\mu\brbisim\nu$ iff
  $\mu(S)=\nu(S)$ for each $\brbisim$-equivalence class~$S$.
\end{lemma}

\begin{proof} Suppose $\mu\brbisim \nu$.
  Let $\mu = \bigoplus_{i\in I_1} \: p_i * E_i$. By weak
  decomposability, $\nu \Arrow{} \bar\nu = \bigoplusiinI \: p_i *
  \nu_i$ with $\nu \mathrel{\brbisim} \bar\nu$ and $\delta(E_i)
  \brbisim \nu_i$ for all $i\in I$.  By (\ref{stable}), as $\nu
  \brbisim \nubar$, we have $\bar\nu = \nu$.

  Let, for each $i\in I$, $\nu_i = \bigoplus_{j\in J_i} \: p_{ij} *
  F_{ij}$. Note, $\sum_{j \in J_i} \: p_{ij} = 1$.
  By weak decomposability, there are $\mu_{ij} \in \DistrE$,
  for~$j \in J_i$, such that $\delta(E_i) \Arrow{} \bar\mu_i {:=}
  \bigoplus_{i\in J_i} \: p_{ij} * \mu_{ij}$,
  $\nu_i \brbisim \bar\mu_i$ and $\mu_{ij} \brbisim
  \delta(F_{ij})$ for all~$j \in J_i$. By~(\ref{stable}) and
  $\brbisim$-stability of~$\delta(E_i)$, it follows that $\delta(E_i)
  = \bar\mu_i$ and hence $\mu_{ij} = \delta(E_i)$.
%
  Writing $E_{ij} {:=} E_i$, $q_{ij}:=p_i \cdot p_{ij}$ and $K = \lc
  ij \mid i \in I \land j\in J_i \rc$ we obtain
  \begin{displaymath}
    \mu = \bigopluskinK \: q_k * E_k \, ,\
    \nu = \bigopluskinK \: q_{k} * F_{k} \, , \ 
    \text{and} \ 
    \delta(E_k) \mopcalR \delta(F_k)
    \ \text{for all~$k \in K$.}
    \end{displaymath}
  Now, for any $\brbisim$-equivalence class $S \subseteq
    \calE$ it holds that $E_k\in S \Leftrightarrow F_k\in S$ for all
  $k\in K$. So, 
  \begin{displaymath}
    \mu(S) = \textstyle{\sum_{k \in K ,\, E_k \in S}} \: q_k = 
    \textstyle{\sum_{k \in K ,\, F_k \in S}} \: q_k = \nu(S) \, .
  \end{displaymath}
  The reverse direction of
  Lemma~\ref{decomp} is straightforward with Lemma~\ref{unrooted
    congruence}.
\end{proof}

\noindent
The next lemma holds because in this paper we consider finite
processes only.

\begin{lemma}
  \label{stabilizing}
  For each $\mu \in \DistrE$ there is a $\brbisim$-stable
  $\mu' \brbisim \mu$ with $\mu \Arrow{} \mu'$.
\end{lemma}

\begin{trivlist}
  \item[\hspace{\labelsep}\textbf{Proof Sketch:}] \hspace{-.6pt}Define the
    \emph{weight} of a distribution by $w(\mu) \mathbin=
    \sum_{E \in \calE} \: \mu(E)\cdot \mkern1mu c(E)$, i.e.,\ the weighted
    average of the complexities of the states in its support.  Now $E
    \arrow\alpha \mu$ implies $w(\mu) < w(\delta(E))$, and thus $\mu
    \arrow\alpha \mu'$ implies $w(\mu')< w(\mu)$, and $\mu \mathbin{\Arrow{}}
    \mu'$ implies $w(\mu') \mathbin\leqslant w(\mu)$. For $\mu \mathbin\in \DistrE$ let
    $T_\mu {:=} \lc \mu' \mid \mu' \brbisim \mu \land \mu \mathbin{\Arrow{}}
    \mu' \rc$ and define
    \begin{displaymath}
      sw(\mu) \: {:=} \: \textstyle{\inf_{\mu' \in T_\mu}} \: w(\mu') \, .
    \end{displaymath}
    In~\cite{DGHM09} it is shown that for any $\mu\in\DistrE$, the set
    $\lc \mu' \mid \mu \Arrow{} \mu' \rc$ is compact. This concept is
    defined by regarding a probability distribution over a finite set
    of $n$~states as a point in the $n$-dimensional Euclidean
    space~$\bbbr^n$. Similarly it can be shown that the set $T_\mu$~is
    compact. This is a consequence of the finitary nature of the space
    under consideration. The infimum over the compact set will be
    reached, and therefore there exists a derivation $\mu \Arrow{} \mu'$
    with $\mu' \brbisim \mu$ and $w(\mu') =
    sw(\mu)$. By construction $\mu'$ must be $\brbisim$-stable.  \qed
\end{trivlist}


\begin{lemma}[Cancellativity]
  \label{cancellative}
  Let $\mu, \mu', \nu, \nu' \in \DistrE$. If $\mu \oplusr \nu \brbisim
  \mu'\oplusr \nu'$ with $r \in (0,1]$ and $\nu\brbisim\nu'$, then
    $\mu \brbisim \mu'$.
\end{lemma}

\begin{proof}
  Let $\mu\oplusr\nu \brbisim \mu'\oplusr \nu'$ with
  $r \mathbin\in (0,1]$ and $\nu\brbisim\nu'$. By
  Lemma~\ref{stabilizing} there is a $\brbisim$-stable distribution
  $\xi \brbisim \mu \oplusr \nu$ with $\mu \oplusr \nu \Arrow{} \xi$.
  By weak decomposability, there are $\bar\xi \brbisim \xi$, $\bar\mu
  \brbisim \mu$ and $\bar\nu \brbisim \nu$ with $\xi \Arrow{} \bar\xi
  = \bar\mu \oplusr \bar\nu$. By the $\brbisim$-stability of $\xi$ we
  have $\bar\xi=\xi$.  Likewise there are distributions
  $\bar\mu'\brbisim\mu'$ and $\bar\nu'\brbisim \nu'$ such that
  $\bar\mu'\oplusr\bar\nu'$ is $\brbisim$-stable, $\mu'\oplusr \nu'
  \brbisim \bar\mu' \oplusr \bar\nu'$ and $\mu' \oplusr \nu' \Arrow{}
  \bar\mu'\oplusr \bar\nu'$.

  Since $\bar\mu \oplusr \bar\nu \brbisim \bar\mu'\oplusr \bar\nu'$,
  and using the $\brbisim$-stability of $\bar\mu \oplusr \bar\nu$ and
  $\bar\mu'\oplusr \bar\nu'$, it follows by Lemma~\ref{decomp} that
  $(\bar\mu \oplusr \bar\nu)(S) = (\bar\mu' \oplusr\bar\nu')(S)$
  for every $\brbisim$-equivalence class of states~$S$.
%%
  Since $\bar\nu \brbisim \bar\nu'$, we likewise
  have $\bar\nu(S) = \bar\nu'(S)$. Using that $(\bar\mu\oplusr
  \bar\nu)(S) = r\cdot \bar\mu(S) + (1{-}r)\cdot\bar\nu(S)$,
  \begin{displaymath}
    \bar\mu(S) = 
    \frac{(\bar\mu\oplusr \bar\nu)(S) - (1{-}r)\cdot\bar\nu(S)}r
    = \frac{(\bar\mu'\oplusr\bar\nu')(S) - \bar\nu'(S)}r = 
    \bar\mu'(S).
  \end{displaymath}
  Thus, by Lemma~\ref{decomp}, $\bar\mu \brbisim \bar\mu'$,
  and consequently $\mu \brbisim \mu'$.
\end{proof}

\section{Completeness: the probabilistic case}

\label{sec-prob}

In this section we provide a sound and complete equational
characterization of rooted branching probabilistic bisimilarity.  The
completeness result is obtained along the same lines as the
corresponding result for branching {\bisimilarity} for the
non-deterministic processes in Section~\ref{sec-nondet}.  We extend
and adapt the non-deterministic theories $\AXd$ and~$\AXdb$ of
Section~\ref{sec-nondet}.

\begin{definition}[Axiomatization of $\bisim$ and~$\rootedbrbisim$]
  The theory~$\AXp$ is given by the axioms A1 to~A4, the axioms P1
  to~P3 and C listed in
  Table~\ref{table-axiomatization-of-probabilistic-branching-bisimulation}. 
  The theory~$\AXpb$ contains in addition the axioms~\hyperlink{BP}{BP}
  and~\hyperlink{G}{G}.
\end{definition}

\noindent
The axioms A1--A4 for non-deterministic processes are as before. Regarding
probabilistic processes, for the axioms P1 and~P2 dealing with
commutativity and associativity, we need to take care of the
probabilities involved. For~P2, it follows from the given restrictions
that also $(1{-}r)s = (1{-}r')s'$, i.e., the probability for~$Q$ to
execute is equal for the left-hand and right-hand side of the
equation. Axiom~P3 expresses that a probabilistic choice between equal
processes can be eliminated.
%
Axiom~C expresses that any two nondeterministic transitions can
be executed in a combined fashion: one with probability~$r$ and one
with the complementary probability~$1{-}r$.

The axioms P1 and P2 allow us to write each probabilistic
process~$P$ as 
\begin{displaymath}
  \partial(E_1)\probc{r_1}(\partial(E_2)\probc{r_2}(\partial(E_3)\probc{r_3}\cdots))   
\end{displaymath}
for non-deterministic processes $E_i$. In the sequel we denote such a
process by $\bigoplusiinI \: p_i * E_i$ with
$p_i=r_i\prod_{j=1}^{i-1}(1-r_j)$.
%%
More specifically, if a probabilistic process~$P$ corresponds to a
distribution $\bigoplusiinI \: p_i * E_i$, then we have $\AXp \vdash P
= \bigoplusiinI \: p_i * E_i$, as can be shown by induction on the
structure of~$P$.

For axioms~\hyperlink{BP}{BP} and~\hyperlink{G}{G} of
Table~\ref{table-axiomatization-of-probabilistic-branching-bisimulation}
we introduce the notation~$E \sqsubseteq P$ for $E \in \calE$, $P \in
\calP$. We define
\begin{displaymath}
  E \sqsubseteq P
  \quad \text{iff} \quad
  \begin{array}[t]{l}
    \forall \alpha \in \calA , \, \mu \in \DistrE \colon
    E \arrow{\alpha} \mu \quad \Longrightarrow
    \smallskip \\
    \qquad\qquad\qquad
    \exists \mkern1mu \nu \in \DistrE \colon
    \den{P}  \arrow{(\alpha)} \nu \land \mu \brbisim \nu \, .
  \end{array}
\end{displaymath}
Thus, we require that every transition of the non-deterministic
process~$E$ can be directly matched by the probabilistic process~$P$.
%
Note, if $E \sqsubseteq P$ \vspace{1pt} and
$\delta(E) \arrow{\alpha} \mu$, then $\den{P} \alphahidearrow \nu$ for
some $\nu \in \DistrE$ such that $\mu \brbisim \nu \mkern1mu$: If
$\delta(E) \arrow\alpha \mu$, then
$\mu = \bigoplusiinI \: p_i * \mu_i$ and $E \arrow\alpha \mu_i$ for
suitable $p_i \geqslant 0$, $\mu_i \in \DistrE$. \vspace{1pt} Since
$E \sqsubseteq P$, we have for each~$i \in I$ that
$\den{P} \alphahidearrow \nu_i$ for some $\nu_i \in \DistrE$
satisfying $\mu_i \brbisim \nu_i$. Hence
$\den{P} \alphahidearrow \nu \, {:=} \, \bigoplusiinI \: p_i * \nu_i$ and
$\mu \brbisim \nu$ by Lemma~\ref{unrooted congruence}.

Axiom~\hyperlink{BP}{BP} is an adaptation of axiom~\hyperlink{B}{B} of
the theory~$\AXdb$ to the probabilistic setting of~$\AXpb$.  In the
setting of non-deterministic processes the implication $F
\arrow{\alpha} F'$ $\Longrightarrow$ $E \arrow{\alpha} E'$ $\land$ $F'
\brbisim E'$ for some $E'$ is captured by $E + F
\mathrel{\rootedbrbisim} E$. If we reformulate axiom~\hyperlink{B}{B}
as $E + F = E$ $\Longrightarrow$ $\alpha \pref ( F + \tau \pref E ) =
\alpha \pref E$, then it becomes more similar to
axiom~\hyperlink{BP}{BP} in
Table~\ref{table-axiomatization-of-probabilistic-branching-bisimulation}.

As to~\hyperlink{BP}{BP}, in the context of a preceding
action~$\alpha$ and a 
probabilistic process~$Q$, a non-deterministic alternative~$E$ that is
also offered by a probabilistic process after a $\tau$-prefix can be
dispensed with, together with the prefix~$\tau$. In a formulation
without the prefix~$\alpha$ and the probabilistic alternative~$Q$, but
with the specific condition $E \sqsubseteq P$, and retaining the
$\tau$-prefix on the right-hand side, the axiom~\hyperlink{BP}{BP} shows similarity
with axioms~T2 and~T3 in~\cite{FG19:jlamp} which, in turn, are
reminiscent of axioms T1 and~T2 of~\cite{DP07:tcs}; these axioms stem
from Milner's second $\tau$-law~\cite{Mil89:phi}.

\begin{table}
  \centering
  \def\arraystretch{1.1}
  \begin{tabular}{|@{\;}l@{\ \;}l|}
    \hline
    A1 & $E + F = F + E$ \rule{0pt}{12pt} \\
    A2 & $(E + F) + G = E +(F + G)$ \\
    A3 & $E + E = E$ \\
    A4 & $E + \bfzero = E$ 
    \rule[-5pt]{0pt}{12pt}
    \\ \hline
    P1 & $P \oplusr Q = Q \probc{1{-}r} P$ \rule{0pt}{12pt} \\
    P2 & $P \oplusr ( Q \probc{s} R ) = (P \probc{\bar{r}} Q)
    \probc{\bar{s}} R$ \\
    & \small 
    \qquad
    where $r = \bar{r} \mkern1mu \bar{s}$ and $(1{-}r)(1{-}s) =
    1{-}\bar{s}$ \quad \\ 
    P3  & $P \oplusr P = P$
    \rule[-5pt]{0pt}{12pt}
    \\ \hline
    \rule{0pt}{12pt}%    
    \hypertarget{C}{C}
    & $\alpha \pref P + \alpha \pref Q = \alpha \pref P + \alpha
    \pref ( P \oplusr Q ) + \alpha \pref Q$   
    \rule[-5pt]{0pt}{12pt}
   \\ \hline
    \hypertarget{BP}{BP} & if $E \sqsubseteq P$ then    
    \rule{0pt}{12pt}\\
    &
    \qquad
    $\alpha \pref \bigl (
    \partial ( \, E + \tau \pref P \, ) 
    \oplusr Q \bigr ) = 
    \alpha \pref \bigl ( P \oplusr Q \bigr )$
    \rule[-5pt]{0pt}{12pt}
    \\
    \hypertarget{G}{G} &  if $E \sqsubseteq \partial(F)$ then    
    \rule{0pt}{12pt}\\
    &
    \qquad
      $\alpha\pref (\partial(E+F) \oplusr Q) =
      \alpha\pref (\partial(F) \oplusr Q)$
    \rule[-5pt]{0pt}{12pt} \\
    \hline
  \end{tabular}
  \def\arraystretch{1.0}

  \medskip

  \caption{Axioms for strong and rooted branching probabilistic {\bisimilarity}}
  \label{table-axiomatization-of-probabilistic-branching-bisimulation}
\end{table}

Let us illustrate the working of axiom~\hyperlink{BP}{BP}. Consider the
non-deterministic process $E = \bstop$ and the probabilistic process
$P = \partial( \astop + \bstop ) \probc{1/2} \partial( \bstop)$. Then we
have $E \sqsubseteq P$, i.e.\ 
\begin{displaymath}
  \bstop \sqsubseteq 
  \partial( \astop + \bstop ) \probc{1/2} \partial( \bstop ).
\end{displaymath}
Therefore, we have by application of axiom~\hyperlink{BP}{BP} the
provable equality
\begin{displaymath}
  \begin{array}{l}
    \AXpb \vdash
    \alpha \pref \bigl( \partial \dg( {\bstop} + \tau \pref \mg( 
    \partial\dor( \astop + \bstop \dor) \probc{1/2}
    \rule{0pt}{9.5pt}\partial\dor( 
    \bstop \dor) \mg) 
     \dg) \oplusr Q \bigr)
    = {} \smallskip \\ \hspace{94pt}
    \alpha \pref \bigl( \dg(\rule{0pt}{9.5pt}
    \partial\dor( \astop + \bstop \dor) \probc{1/2} \partial\dor( \bstop \dor)
    \dg) \oplusr Q \bigr) \; .
  \end{array}
\end{displaymath}
Another example is
$a \pref (P_1\oplusr P_2) \sqsubseteq \partial\dg(b\pref R + a\pref
P_1\dg)\oplusr\partial\dg(c\pref S + a\pref P_2\dg)$, 
so
\begin{displaymath}
  \begin{array}{l}
    \AXpb \vdash
    \alpha \pref \bigl(\partial\mg(
    a\pref(P_1\oplusr P_2) + \tau \pref \dor( \partial\dg( b \pref R
    + 
    a \pref P_1\dg)\oplusr\partial\dg(c\pref S + a\pref P_2\dg) \dor) 
     \mg) \oplusr Q\bigr)
    = {} \smallskip \\ \hspace{121pt}
    \alpha \pref \bigl( \dor( \partial\dg(b\pref R + a\pref P_1 \dg) \oplusr
    \partial\dg(c\pref S + a\pref P_2\dg) \dor)
     \oplusr Q
    \bigr) \;.
  \end{array}
\end{displaymath}
An example illustrating the use of $(\alpha)$, rather than
$\alpha$, as label of the matching transition of~$\den{P}$ in the
definition of $\sqsubseteq$ is
\begin{displaymath}
  \tau \pref \mg(\partial(b \pref P + \tau \pref Q)\oplusr Q\mg)
  \sqsubseteq  \partial(b \pref P + \tau \pref Q)
\end{displaymath}
from which we obtain
\begin{displaymath}
  \begin{array}{l}
    \AXpb \vdash
    \alpha \pref \left(\partial\rule{0pt}{9.5pt}\big(
    \tau \pref \mg(\partial(b \pref P + \tau \pref Q)\oplusr Q\mg)
    + \tau \pref \mg( \partial(b \pref P + \tau \pref Q) \mg) 
    \big)\oplusr R \right)
    = {} \smallskip \\ \hspace{173pt}
    \alpha \pref\big( \mg( \partial(b \pref P + \tau \pref Q) \mg)\oplusr R\big)\;.
  \end{array}
\end{displaymath}
The axiom \hyperlink{G}{G} roughly is a variant of \hyperlink{BP}{BP}
without the $\tau$ prefixing the process $P$. A typical example,
matching the one above, is
\begin{displaymath}
  \begin{array}{l}
    \AXpb \vdash
    \alpha \pref \left(\partial\rule{0pt}{9.5pt}\big(
    \tau \pref \mg(\partial(b \pref P + \tau \pref Q)\oplusr Q \mg)
    + \mg( b \pref P + \tau \pref Q \mg) 
    \big)\oplusr R \right) 
    = {} \smallskip \\ \hspace{153pt}
    \alpha \pref \big( \mg( \partial(b \pref P + \tau \pref Q)
    \mg) \oplusr R \big) \; . 
  \end{array}
\end{displaymath}
The occurrences of the prefix $\alpha \pref {\_}$
in~\hyperlink{BP}{BP} and~\hyperlink{G}{G} are related to the
root condition for non-deterministic processes,
cf.\ axiom~\hyperlink{B}{B} in Section~\ref{sec-nondet}.

\begin{lemma}
  \label{simpleBP}
  The following simplifications of the axiom \hyperlink{BP}{BP} are derivable:
  \begin{displaymath}
    \def\arraystretch{1.2}
    \begin{array}{rl}
      (i) &
      \AXpb\vdash \alpha \pref 
      \partial ( \, E + \tau \pref P \, ) = 
      \alpha \pref  P \quad \text{if $E \sqsubseteq P$,} \\
      (ii) &
      \AXpb\vdash \alpha \pref 
      (\partial ( \, \tau \pref P) \oplusr R \, ) = 
      \alpha \pref   (P \oplusr R) \textrm{ and} \\
      (iii) &
      \AXpb\vdash \alpha \pref 
      \partial ( \, \tau \pref P)  = 
      \alpha \pref   P \, .
    \end{array}
    \def\arraystretch{1.0}
  \end{displaymath}
\end{lemma}

\begin{proof}
  The proof of the first equality requires an application of~P3:
  \[
  \def\arraystretch{1.2}
  \begin{array}{ll}
    \AXpb \vdash &
    \alpha \pref 
    \partial ( E + \tau \pref P ) ~\stackrel{\textrm{P3}}{=} \\
    & \alpha \pref  \bigl( 
    \partial ( E + \tau \pref P ) \probc{\frac12}
    \partial ( E + \tau \pref P ) \bigr)
    ~\stackrel{\textrm{\hyperlink{BP}{BP}}}{=} \\
    & \alpha \pref 
    \bigl( 
    P \probc{\frac12} \partial ( E + \tau \pref P )
    \bigr)
    ~\stackrel{\textrm{P1}}{=} \\
    & \alpha \pref 
    \bigl(
    \partial ( E + \tau \pref P ) \probc{\frac12} P
    \bigr )
    ~\stackrel{\textrm{\hyperlink{BP}{BP}}}{=} \\
    & \alpha \pref 
    \bigl( P \probc{\frac12} P \bigr )
    ~\stackrel{\textrm{P3}}{=}  
    \alpha \pref P \, .
  \end{array}
  \def\arraystretch{1.0}\]
%%
  The proof of the second equality uses A4:
  \[
  \def\arraystretch{1.2}
  \begin{array}{ll}
    \AXpb \vdash &
    \alpha \pref \bigl(
    \partial ( \tau \pref P ) \oplusr R  
    \bigr) ~\stackrel{\textrm{A4}}{=} \\
    & \alpha \pref \bigl(
    \partial ( {\bfzero} + \tau \pref P ) \oplusr R  
    \bigr) ~\stackrel{\textrm{\hyperlink{BP}{BP}}}{=} \\
    &\alpha \pref \bigl( 
    P \oplusr R  
    \bigr) 
\end{array}\]
The last equation can be proven in a similar way as the first
property, using the second one.
\end{proof}

\noindent
Similar simplifications of axiom \hyperlink{G}{G} can be found.

Using the properties in the lemma above the process identities
mentioned in the introduction can easily be proven. Returning to the
processes $E_1$ and~$E_6$ related to Figure~\ref{PA-of-Eisentraut}, we
have
\begin{displaymath}
  \def\arraystretch{1.2}
  \begin{array}{rcl}
    \AXpb \vdash 
    E_1 & = & \tau \pref \bigl(
  \partial\dg( 
    \tau \pref \partial\dor( \tau \pref P + c \pref Q + \tau \pref R \dor) +
    c \pref Q + \tau \pref R \dg) 
    \\ & & \phantom{\tau \pref \bigl( {}} 
  {} \probc{1/2}
  \partial\dg( \tau \pref \mg(
    \partial\dor( \tau \pref P + c \pref Q + \tau \pref R \dor)
    \probc{1/2}
    \partial( \bfzero ) \mg) \dg)
  \bigr) \\
  & \stackrel{\text{\hyperlink{BP}{BP}}}{=} & 
  \tau \pref \bigl(
  \partial\dor( 
    \tau \pref P + c \pref Q + \tau \pref R \dor) 
  \\ & & \phantom{\tau \pref \bigl( {}} 
  {} \probc{1/2}
  \partial\dg( \tau \pref \mg(
    \partial\dor( \tau \pref P + c \pref Q + \tau \pref R \dor)
    \probc{1/2}
    \partial( \bfzero ) \mg) \dg)
  \bigr) \\
%% 
  & \stackrel{\text{\ref{simpleBP} $(ii)$, P1}}{=} & 
  \tau \pref \bigl(
  \partial\dor( \tau \pref P + c \pref Q + \tau \pref R \dor) 
  \\ & & \phantom{\tau \pref \bigl( {}} 
  {} \probc{1/2}
  \mg(
    \partial\dor( \tau \pref P + c \pref Q + \tau \pref R \dor)
    \probc{1/2}
    \partial( \bfzero )  \mg)
  \bigr) \\
  & \stackrel{\text{P2}}{=} & 
  \tau \pref \bigl(
   \mg(\partial\dor(\tau\pref P + c \pref Q + \tau \pref R \dor) 
  \probc{2/3}\\
&&  \phantom{\tau \pref \bigl( ({}}  \partial\dor( \tau \pref P + c \pref Q + \tau \pref R \dor)\mg)
  \probc{3/4}
  \partial( \bfzero ) 
  \bigr)
  \\
  & \stackrel{\text{P3}}{=} & 
  \tau \pref ( \partial\dor( \tau \pref P + c \pref Q + \tau \pref R \dor) 
  \probc{3/4} \partial( \bfzero ) )
  = E_6 \, .
  \end{array}
  \def\arraystretch{1.0}
\end{displaymath}

\noindent
Soundness of the theory~$\AXp$ for strong probabilistic {\bisimilarity}
and of the theory~$\AXpb$ for rooted branching probabilistic
{\bisimilarity} is straightforward.

\begin{lemma} [Soundness]
  \label{lemma-soundness}
  For all $P,Q \in \calP$, if $\AXp \vdash P = Q$ then $P \bisim Q$,
  and if $\AXpb \vdash P = Q$ then $P \rootedbrbisim Q$.
\end{lemma}

\begin{proof}
  As usual, in view of $\bisim$ and~$\rootedbrbisim$ being
  congruences, one only needs to prove the left-hand and right-hand
  sides of the axioms to be strongly or rooted branching
  probabilistically bisimilar. We only treat the cases
  of the axioms~\hyperlink{BP}{BP} and~\hyperlink{G}{G}
  with respect to rooted branching probabilistic bisimilarity.

  For \hyperlink{BP}{BP}, by Definition~\ref{rooted-bpb} and
  Lemma~\ref{unrooted congruence}, it suffices to show that
  $P \brbisim \partial(E + \tau \pref P)$ if~$E \sqsubseteq
  P$. Suppose $\delta( E + \tau \pref P ) \alphaarrow \mu$. We
  distinguish two cases: (i)~%
  $\delta(E) \alphaarrow \mu$; (ii)~$\alpha = \tau$,
  $\delta(E) \arrow{\tau} \mu'$ and $\mu = \den{P} \probc{r} \mu'$ for
  some~$r \in (0,1]$. For~(i), by definition of~$E \sqsubseteq P$, we
  have $\den{P} \arrow{(\alpha)} \nu$ and $\mu \brbisim \nu$ for
  suitable~$\nu \in \DistrE$. For~(ii), again
  by~$E \mathbin\sqsubseteq P$, we have $\den{P} \arrow{(\tau)} \nu'$
  and $\mu' \brbisim \nu'$. Thus
  $\den{P} \mathbin= \den{P} \!\probc{r}\! \den{P} \arrow{(\tau)} \nu$
  \linebreak[3] and $\mu \brbisim \nu$ for
  $\nu = \den{P} \probc{r} \nu'$, as was to be shown.
%
  Conversely, $\den{P} \alphaarrow \mu$ trivially implies that
  $\delta(E + \tau \pref P) \Arrow{} \den{P} \alphahidearrow \mu$.
  The requirement on weak decomposability also holds trivially.

  For \hyperlink{G}{G}, by Definition~\ref{rooted-bpb} and
  Lemma~\ref{unrooted congruence}, it suffices to show that $E+F
  \brbisim F$ if $E \sqsubseteq \partial(F)$. Put $\calR = \singleton{
    \langle E+F , F \mkern1mu \rangle }^\dagger \cup {\brbisim}
  \mkern1mu$. We verify that $\calR$ is a branching probabilistic
  bisimulation. Naturally, $\delta(E) \alphaarrow \mu$ implies
  $\delta(E+F) \alphaarrow \mu$, and also weak decomposability is
  easy. Finally, suppose $\delta(E+F) \alphaarrow \mu$. Since $E
  \sqsubseteq \partial(F)$ \vspace{2pt} now we have $\delta(E)
  \alphahidearrow \nu$ for some~$\nu$ with $\mu \brbisim \nu$.
\end{proof}

\noindent
As for the process language with non-deterministic processes only, we
aim at a completeness proof that is built on completeness of strong
{\bisimilarity} and the notion of a concrete process.
%%
Equational characterization of strong probabilistic {\bisimilarity}
has been addressed by various authors. The theory~$\AXp$ provides a
sound and complete theory. For a proof, see e.g.~\cite{Hen12:facj}.

\begin{lemma}
  \label{lemma-completeness-for-strong-probabilistic-bisimulation}
  The theory $\AXp$ is sound and complete for strong {\bisimilarity}.
\end{lemma}

\noindent
The next lemma provides a more state-based characterization of strong
probabilistic bisimilarity.

\begin{lemma}\label{state based}
  Let $\calR \subseteq \DistrE \times \DistrE$ be a decomposable
  relation such that 
  \begin{equation}
    \label{cong}
    \mu_1 \mopcalR \nu_1 \ \text{and} \ \mu_2 \mopcalR \nu_2
    \quad  \text{implies} \quad
    (\mu_1 \oplusr \mu_2) \mopcalR (\nu_1 \oplusr \nu_2)
  \end{equation}
  and for each pair $E,F \in \calE$ 
  \begin{equation}
    \label{diamond}
    \delta(E) \mopcalR \delta(F)
    \ \text{and} \
    E \arrow{\alpha} \mu'
    \quad \text{implies} \quad
    \delta(F) \alphaarrow \nu'
    \ \text{and} \ 
    \mu' \mopcalR \nu'
  \end{equation}
  for a suitable $\nu' \in \DistrE$.
  Then $\mu \mopcalR \nu$ implies $\mu\bisim \nu$.
\end{lemma}

\begin{proof}
  We show that $\calR$ is a strong probabilistic bisimulation relation.
%
  So, let $\mu, \nu \in \DistrE$ such that $\mu \mopcalR \nu$ and
  $\mu \arrow{\alpha} \mu'$.  By
  Definition~\ref{def-pr-transition-relation}(b) we have
  $\mu = \bigoplusiinI \: p_i * E_i$,
  $\mu' = \bigoplusiinI \: p_i * \mu'_i $, and
  $E_i \alphaarrow \mu'_i$ for all $i \in I$.  Since $\calR$ is
  decomposable, there are $\nu_i \in \DistrE$, for~$i \in I$, such
  that
    \begin{displaymath}
      \nu  = \bigoplusiinI \: p_i * \nu_i
      \quad \text{and} \quad
      \delta(E_i) \mopcalR \nu_i 
      \ \text{for all~$i \in I$.}
    \end{displaymath}
    Let, for each $i\in I$,
    $\nu_i = \bigoplus_{j\in J_i} \: p_{ij} * F_{ij}$.  Since $\calR$
    is decomposable, there are $\mu_{ij} \in \DistrE$,
    for~$j \in J_i$, such that
    \begin{displaymath}
      \delta(E_i)  = \textstyle\bigoplus_{i \in J_i} \: p_{ij} * \mu_{ij}
      \quad \text{and} \quad 
      \mu_{ij} \mopcalR \delta(F_{ij})
      \ \text{for all~$j \in J_i$.}
    \end{displaymath}
    Here $\mu_{ij} = \delta(E_i)$.  Writing $E_{ij} \, {:=} \, E_i$,
    $q_{ij} \, {:=} \, p_i\cdot p_{ij}$ and
    $K = \lc (i,j) \mid i \in I \land j \in J_i \rc$ we obtain
    \begin{displaymath}
      \mu= \bigopluskinK \: q_k * E_k \ ,\
      \nu = \bigopluskinK \: q_{k} * F_{k}
      \quad \text{and} \quad
      \delta(E_k) \mopcalR \delta(F_k)
      \ \text{for all~$k \in K$.}
    \end{displaymath}
    Let $\mu'_{ij} {:=} \mu'_i$ for all $i \in I$ and $j \in
    J_i$. Then $\mu' = \bigopluskinK \: q_{k} * \mu'_k$. Using
    that $E_k \arrow{\alpha} \mu'_k$ for all $k \in K$, there must be
    distributions~$\nu'_k$ for $k \in K$ such that
    \begin{displaymath}
      \delta(F_k) \alphaarrow \nu'_k
      \quad \text{and} \quad
      \mu'_k \mopcalR \nu'_k.
    \end{displaymath}
    By Definition~\ref{def-pr-transition-relation}(b) this implies
    $\nu \alphaarrow \nu'$, for
    $\nu' \, {:=} \, \bigopluskinK \: q_{k} * \nu'_k$.  Moreover,
    (\ref{cong})~yields $\mu' \mopcalR \nu'$.
\end{proof}

\noindent
The following technical lemma expresses that two rooted branching
probabilistically bisimilar processes can be represented in a similar
way.

\begin{lemma}
  \label{lemma-form-of-probabilistic-branching-processes}
  For all $Q, R \in \calP$, if $Q \rootedbrbisim R$ then there are an
  index set~$I$ as well as for all $i\in I$ suitable $p_i > 0$ and
  $F_i, G_i \in \calE$ such that $F_i \rootedbrbisim G_i$, $\AXp \vdash Q =
  \bigoplusiinI \: p_i * F_i$ and $\AXp \vdash R = \bigoplusiinI \:
  p_i * G_i$.
\end{lemma}

\begin{proof}
  Suppose $\AXp \vdash Q = \bigoplusjinJ \: q_j * F'_j$. Since
  $Q \rootedbrbisim R$ and $\rootedbrbisim$ is decomposable, the
  process~$R$ can be written as $\bigoplusjinJ \: q_j * R_j$ with
  $R_j \in \calP$ for $j \in J$, such that
  $\partial(F_j) \rootedbrbisim R_j$. Therefore, each
  distribution~$R_j$ can be written as
  $\bigoplus_{k {\in} K_j} \: r_{jk} * G_{jk}$ where
  $\partial(F'_j) \rootedbrbisim \partial(G_{jk})$ for all $j \in J$
  and $k \in K_j$. We now define $F_{jk} = F'_j$ for $j \in J$ and
  $k \in K_j$. Then, using the axioms P1, P2 and P3 we can derive
  \begin{displaymath}
    \begin{array}{l}
    \AXp \vdash Q = \bigoplusjinJ \, \bigoplus_{k {\in} K_j} \: q_j r_{jk}  * F_{jk}
    \smallskip \\ 
    \AXp \vdash R = \bigoplusjinJ \, \bigoplus_{k {\in} K_j} \: q_j r_{jk}  *
    G_{jk}
    \end{array}
  \end{displaymath}
   with $F_{jk} \brbisim G_{jk}$ for $j \in J$ and $k \in K_j$. This
   proves the lemma. 
\end{proof}

\noindent
Similar to the non-deterministic case, a transition $E \arrow{\tau}
\mu$ is called \textit{inert} iff $\delta(E) \brbisim \mu$. Typical
cases of inert transitions include
\begin{displaymath}
  \begin{array}{c}
    \tau \pref P \  \arrow{\tau} \  \den{P} \;, \\[2pt]
    E + \tau \pref \partial(E) \  \arrow{\tau} \  \delta(E) \;.
  \end{array}
\end{displaymath}
Furthermore, a transition $E \arrow{\tau} \mu_1\oplusr \mu_2$ with
$r \in (0,1]$ and $\delta(E) \brbisim \mu_1$ is called
\emph{partially inert}. A typical case is
\begin{displaymath}
  \begin{array}{c}
    \tau \pref (\partial(b \pref P + \tau \pref Q)\oplusr Q)
    + b \pref P + \tau \pref Q
    \  \arrow{\tau} \
    \delta(b \pref P + \tau \pref Q)\oplusr \den{Q} \;.
  \end{array}
\end{displaymath}
Here $\delta \big( \tau \pref (\partial(b
\pref P + \tau \pref Q)\oplusr Q) + b \pref P + \tau \pref Q \big)
\brbisim \delta(b \pref P + 
\tau \pref Q)$ because\linebreak $\delta(b \pref P + \tau \pref Q)
\tauhidearrow \delta(b \pref P + \tau \pref Q)\oplusr \den{Q}$.

In Section~\ref{sec-nondet} a process is called concrete if it does
not exhibit an inert transition. In the setting with probabilistic
choice we need to be more careful. For example, we also want to
exclude processes of the form
\begin{displaymath}
  \partial( \tau \pref P ) \probc{1/2} \partial( a \pref Q ) )
  \quad \text{and} \quad
  \partial( a \pref P ) \probc{1/2} \partial( b \pref \bigl(
  \partial( \tau \pref Q ) \probc{1/3} Q
  \bigr))
\end{displaymath}
from being concrete, although they cannot
perform a transition by themselves at all. Therefore, we define
the \emph{derivatives} $\der(P)\subseteq\calE$ of a probabilistic
process $P\in\calP$ by
\begin{displaymath}
  \begin{array}{r@{~:=~}l}
    \der(P \oplusr Q) & \der(P) \cup \der(Q) 
    \smallskip \\
    \der(\partial(\sum_{i\in I}\alpha_i\cdot P_i)) &
    \{ \, \sum_{i\in I} \: \alpha_i\cdot P_i \, \} \cup 
    \bigcup_{i\in I} \: \der(P_i)
  \end{array}
\end{displaymath}
and define a process~$\Pbar \in \calP$ to be \emph{concrete} iff none
of its derivatives can perform a partially inert transition, i.e., if
there is no transition $E \arrow{\tau} \mu_1\oplusr \mu_2$ with $E \in
\der(\Pbar)$, $r \in (0,1]$ and $\delta(E) \brbisim \mu_1$. A
non-deterministic process~$\Ebar$ is called concrete if the
probabilistic process~$\partial(\Ebar)$ is. Moreover, we define two
sets of concrete processes:
\begin{displaymath}
  \calEconc = \lc \Ebar \in \calE \mid \text{$\Ebar$ is concrete} \rc
  \quad \text{and} \quad \calPconc = \lc \Pbar \in \calP \mid
  \text{$\Pbar$ is concrete} \rc.
\end{displaymath}
Furthermore, we call a process $E \in \DistrE$ \emph{rigid} iff there
is no inert transition $E \arrow\tau \mu$, and write $\calE_r = \lc
\Ebar \in \calE \mid \text{$\Ebar$ is rigid} \rc$. Naturally,
$\calEconc \subseteq \calE_r$.

We use concrete and rigid processes to build the proof of the
completeness result for rooted branching probabilistic {\bisimilarity}
on top of the completeness proof of strong probabilistic
{\bisimilarity}. The following lemma lists all properties of concrete
and rigid processes we need in our completeness proof.

\begin{lemma}
  \label{cc}
  \begin{enumerate}[(a)]
  \item If $E = \sumiinI \: \alpha_i \cdot P_i$ with $P_i \in
    \calPconc$ and, for all $i \in I$, $\alpha_i \neq \tau$ or $\den{P_i}$
    cannot be written as $\mu_1 \oplusr \mu_2$ with $r
    \mathbin \in (0,1]$ and $\delta(E) \brbisim \mu_1$, then $E \in
      \calEconc$.
  \item If $P_1,P_2\in\calPconc$ then $P_1 \oplusr P_2\in\calPconc$.
  \item If $\mu = \bigoplusiinI \: p_i * \mu_i \in \Distr(\calEconc)$
    with each $p_i>0$, then each $\mu_i\in\DistrEconc$.
  \item If $\mu\in\Distr(\calEconc)$ and $\mu \alphahidearrow \mu'$
    then $\mu'\in\DistrEconc$. 
  \item If $\mu \in \Distr(\calE_r)$ and $\mu \,\Arrow{}\, \mu'$ with
    $\mu \brbisim \mu'$ then $\mu = \mu'$.
  \item If $E \mathbin\in \calEconc$, $F \mathbin\in \calE$, and
    $\mu,\nu \mathbin\in \DistrE$ are such that \vspace{2pt} $E
    \brbisim F$, 
    $E \arrow{\alpha} \mu$, $\delta(F) \arrow{(\alpha)} \nu$ and
    $\mu \brbisim \nu$, then $\delta(F) \arrow{\alpha} \nu$.
  \item If $\mu \brbisim \bigoplusiinI \: p_i * \nu_i$ for $\mu \in
    \Distr(\calE_r)$ then $\mu = \bigoplusiinI \: p_i*\mu_i$ for
    certain $\mu_i \brbisim \nu_i$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  Properties (a), (b), (c) and~(d) follow immediately from the
  definitions, in the case of~(d) also using
  Definition~\ref{def-pr-transition-relation}(b).

  For (e), let $\mu\mathbin\in\Distr(\calE_r)$ and $\mu \Arrow{} \mu'$
  with $\mu\brbisim\mu'$. Towards a contradiction, suppose
  $\mu\neq\mu'$.  Then there must be a distribution $\bar\mu\neq\mu$
  such that $\mu \tauhidearrow \bar\mu$ and $\bar\mu \Arrow{} \mu'$.
  We may even choose $\bar\mu$ such that the transition
  $\mu \tauhidearrow \bar\mu$ acts on only one (rigid) state in
  the support of $\mu$, i.e.\ there are $E \in \calE$,
  {$r \in (0,1]$} and $\rho,\nu \in \DistrE$ such
  that $\mu = \delta(E) \oplusr \rho$, $E \arrow\tau \nu$ and
  $\bar\mu = \nu \oplusr \rho$. By Lemma~\ref{stuttering}
  $\delta(E) \oplusr \rho = \mu \brbisim \bar\mu = \nu \oplusr \rho$.
  Hence by Lemma~\ref{cancellative} $\delta(E) \brbisim \nu$. So the
  transition $E \arrow\tau \nu$ is inert, contradicting $E \in \calE_r$.

  To establish (f), suppose $E \in \calEconc$, $F \in \calE$, and
  $\mu,\nu \in \DistrE$ are such that $E \brbisim F$,
  $E \arrow{\alpha} \mu$, $\delta(F) \arrow{(\alpha)} \nu$ and
  $\mu \brbisim \nu$. Assume $\alpha = \tau$, for otherwise the
  statement is trivial. Then $\delta(F) \tauarrow \nu_1$ and
  $\nu = \nu_1 \oplusr \delta(F)$ for some $\nu_1 \in \DistrE$ and
  $r \in [0,1]$. Since $\brbisim$ is weakly
  decomposable, there are $\bar\mu, \mu_1, \mu_2 \in \DistrE$ such
  that $\mu \Arrow{} \bar\mu$, $\mu \brbisim \bar\mu$,
  $\bar\mu= \mu_1 \oplusr \mu_2$, $\mu_1 \brbisim \nu_1$ and
  $\mu_2 \brbisim \delta(F)$. Since $\mu$ is concrete, using case~(d)
  of the lemma, $\bar\mu = \mu$ by case~(e). Thus
  $E \arrow{\tau} \mu_1\oplusr \mu_2$ with
  $\delta(E) \brbisim \delta(F) \brbisim \mu_2$.  Since $E$~is
  concrete, this transition cannot be partially inert. Thus, we
    must have~$r = 1$. It follows that
  $\delta(F) \arrow{\alpha} \nu$.

  Regarding~(g), if $\mu \brbisim \bigoplusiinI \: p_i * \nu_i$ for
  $\mu \mathbin\in \Distr(\calE_r)$, then $\mu \Arrow{} \bar\mu :=
  \bigoplusiinI \: p_i * \mu_i$ with $\mu_i \brbisim \nu_i$
  by weak decomposability of~$\brbisim \mkern1mu$.
  By~(e) we have $\bar\mu = \mu$.
\end{proof}

\begin{lemma}
  \label{lemma-equal-for-concrete-processes}
  For all $\Pbar,\Qbar \in \calPconc$, if $\Pbar \brbisim \Qbar$ then
  $\Pbar \bisim \Qbar$ and $\AXp \vdash \Pbar = \Qbar$.
\end{lemma}

\begin{proof}
  Let $\calR \, {:=} \, {\brbisim} \cap (\Distr(\calEconc) \times
  \Distr(\calEconc))$.  Then, by Lemma~\ref{cc}(c)--(d), $\calR$ is a
  branching probabilistic bisimulation relation relating $\Pbar$
  and~$\Qbar$.  We show that $\calR$ moreover satisfies the conditions
  of Lemma~\ref{state based}.  Condition~(\ref{cong}) is a direct
  consequence of Lemmas~\ref{unrooted congruence} and~\ref{cc}(b).
  That $\calR$ is decomposable follows since it is weakly
  decomposable, in combination with Lemma~\ref{cc}(e). Now, in
    order to verify condition~(\ref{diamond}), suppose
  $\delta(E) \mopcalR \delta(F)$ and $E\alphaarrow \mu$.  Then
  $\delta(F) \Arrow{} \nubar \alphahidearrow \nu$ for some
  $\nubar,\nu\in\calP$ with $\delta(E) \mopcalR \nubar$ and
  $\mu \mopcalR \nu$. By Lemma~\ref{cc}(e) we
  have~$\nubar = \delta(F)$.
%
  Thus $\delta(F) \arrow{(\alpha)} \nu$. Hence, using Lemma~\ref{cc}(f)
  it follows that $\delta(F) \arrow{\alpha} \nu$.
  %
  With $\calR$ satisfying conditions (\ref{cong}) and~(\ref{diamond}),
  Lemma~\ref{state based} yields $\Pbar \bisim \Qbar$. By
  Lemma~\ref{lemma-completeness-for-strong-probabilistic-bisimulation}
  we obtain $\AXp \vdash \Pbar = \Qbar$.
\end{proof}

\noindent
Before we are in a position to prove our main result we need one more
technical lemma. Here we write $\AXpb \vdash P_1 \approx P_2$ as
  a shorthand for
  \begin{displaymath}
    \forall \alpha \in \calA \,
    \forall Q \in\calP \,
    \forall r \in (0,1) \colon
    \AXpb \vdash \alpha \pref (P_1 \oplusr Q) =
    \alpha \pref (P_2 \oplusr Q) \, .
  \end{displaymath}
For example, using axiom \hyperlink{BP}{BP}, if $E\sqsubseteq P$ then
$\AXpb \vdash \partial (E + \tau \pref P ) \approx P$.  Likewise,
using \hyperlink{G}{G}, if $E \sqsubseteq\partial(F)$ then
$\partial(E+F)\approx\partial(F)$.  As in the proof of
Lemma~\ref{simpleBP}(i), from $\AXpb \vdash P_1 \approx P_2$ it also
follows that $\AXpb \vdash \alpha \pref P_1 \approx \alpha \pref P_2$
for all $\alpha \in \calA$.
In the proof of the lemma we rely on the axioms
\hyperlink{BP}{BP} and~\hyperlink{G}{G}.

\begin{lemma}
  \label{lemma-prob-technical}
  \mbox{}
  \begin{itemize}
  \item [(a)] For each non-deterministic process $E \in \calE$ there
    is a concrete probabilistic process $\Pbar \in \calPconc$ such
    that $\AXpb \vdash \partial(E) \approx \Pbar$.

  \item [(b)] For each probabilistic process $P \in \calP$ there is a
    concrete probabilistic process $\Pbar \in \calPconc$ such that
    $\AXpb \vdash { \alpha \pref P =
      \alpha \pref \Pbar }$ for all $\alpha \in \calA$.

  \item [(c)] For all probabilistic processes $Q,R \in \calP$, if $Q
    \brbisim R$ then $\AXpb \vdash { \alpha \pref Q = \alpha \pref R
    }$ for all~$\alpha \in \calA$.
  \end{itemize}
\end{lemma}

\begin{proof}
  By simultaneous induction on $c(E)$, $c(P)$, and
  $\max \lbrace c(Q), c(R) \rbrace$. The base case, which applies to
  case (a) only, is clear, since the process $\bfzero+\cdots+\bfzero$
  is concrete. \pagebreak[3]

  Case (a) for $c(E) > 0$. The process~$E$ can be written as $\sumiinI
  \: \alpha_i \pref P_i $ for some index set~$I$ and suitable~$\alpha_i
  \in \calA$ and $P_i \in \calP$. Pick by the induction
  hypothesis~(b), for each $i \in I$, a concrete probabilistic
  process~$\Pbar_i \mathbin\in \calPconc$ with
  $\AXpb \vdash { \alpha_i \pref \Pbar_i = \alpha_i \pref P_i }$.
  Now $\AXp \vdash E = \bar{E}$ for $\bar{E} := \sumiinI \:
    \alpha_i \pref \Pbar_i$. We distinguish two cases.

  \medskip

  (i)~First suppose that for some $i_0\in I$ we have
  $\alpha_{i_0}=\tau$ and $\Pbar_{i_0} \brbisim \partial(\bar
  E)$. Then $\AXpb \vdash E = H + \tau.\Pbar_{i_0}$, where \plat{$H :=
    \sum_{i \in I \setminus \{i_0\}} \: \alpha_i \pref \Pbar_i$}. It
  now suffices to show that \plat{$H \sqsubseteq \Pbar_{i_0}$},
  because then axiom~\hyperlink{BP}{BP} yields $\AXpb \vdash
  \partial(E) \approx \Pbar_{i_0}$.
%
  So, suppose $H \arrow{\alpha}\mu$.  Then $\Ebar
    \arrow{\alpha} \mu$. Since $\partial(\Ebar) \brbisim
  \Pbar_{i_0}$, we have $\den{\Pbar_{i_0}} \Arrow{} {\nubar}
  \alphahidearrow \nu$ where $\delta(\Ebar) \brbisim {\nubar}$ and
  $\mu \brbisim \nu$.  Because $\Pbar_{i_0}$ is concrete,
  $\den{\Pbar_{i_0}} = \nubar$ by Lemma~\ref{cc}(e).  Thus
  $\den{\Pbar_{i_0}}\alphahidearrow\nu$, which was to be shown.

  \medskip

  (ii)~Next suppose that $\alpha_i\neq\tau$ or
  $P_i \nbrbisim \partial(\Ebar)$, for
  all $i \in I$, i.e., $\Ebar$ is rigid. We will show that there
  is a concrete process $\Cbar\in\calEconc$ such that
  $\AXpb \vdash \partial(\Ebar) \approx
  \partial(\Cbar)$. We proceed with induction on the number of indices
  $k\in I$ such that $\alpha_{k}\mathbin=\tau$ and $\den{P_{k}}$ can
  be written as $\mu_1\oplusr\mu_2$ with $r\mathbin\in (0,1)$ and
  $\delta(\Ebar)\brbisim\mu_1$. As $\Ebar$ is rigid, there are no
  such indices with~$r=1$.

  \smallskip

  \noindent
  \emph{Base case:} If there are no such~$k$, then $\bar C := \Ebar
  \in \calEconc$ by Lemma~\ref{cc}(a).

  \smallskip

  \noindent
  \emph{Induction step:} Let $i_0 \in I$ be an index such that
  $\alpha_{i_0} = \tau$ and $\den{P_{i_0}}$ can be written as $\mu_1
  \oplusr \mu_2$ with $r \in (0,1)$ and $\delta(\Ebar) \brbisim
  \mu_1$. First we show that it is possible to write $\den{P_{i_0}}$
  in such way while ensuring that $\mu_2$ itself cannot be written as
  $\nu_1 \probc{s} \nu_2$ with $s\in (0,1)$ and $\delta(\bar E)
  \brbisim \nu_1$. Namely, when $\mu_1 = \bigoplusjinJ \: p_j*F_j$,
  then by Lemma~\ref{cc}(g), using that $\Ebar \in \calE_r$,
  $\delta(\Ebar) = \bigoplusjinJ \: p_j*\xi_j$ with
  $\delta(F_j) \brbisim \xi_j$. So $\xi_j = \delta(\Ebar)$ for all
  $j \in J$. Now we split 
  $\den{P_{i_0}}$ in such a way between $\mu_1$ and~$\mu_2$, that for
  all $F \in \mathit{spt}(\mu_1)$ we have $F \brbisim \Ebar$ and for
  all $G \in \mathit{spt}(\mu_2)$ we have $G \nbrbisim \Ebar$. This
  ensures that $\mu_1 \brbisim \delta(\bar E)$, while $\mu_2$ cannot
  be written as $\nu_1 \probc{s} \nu_2$ with $s \in (0,1)$ and
  $\delta(\Ebar) \brbisim \nu_1$, since on the one hand
    $\mathit{spt}(\nu_1) \subseteq \mathit{spt}(\mu_2)$ and on the
    other hand $G \brbisim \Ebar$ for all $G \in
    \mathit{spt}(\nu_1)$.

   Let \plat{$H := \sum_{i\in I\setminus\{i_0\}} \: \alpha_i \pref
     \Pbar_i$}. \vspace{1pt} Then $\bar E = \tau \pref P_{i_0} + H$.
   By induction, there is a $\Cbar \in \calEconc$ with
   $\AXpb \vdash \partial(H) \approx \partial(\Cbar)$. So
   it suffices to show that $\AXpb \vdash \partial(\bar E)
   \mathbin\approx \partial(H)$. This time, this follows
   by axiom~\hyperlink{G}{G}, as soon as we obtain $\tau \pref P_{i_0}
   \mathbin\sqsubseteq \partial(H)$.
%
  By axioms P1--3, there are $P,P' \in \calPconc$, such that
  (a)~$\AXp\vdash P_{i_0} = P' \oplusr P$, (b)~for all $F\in
  \mathit{spt}(\den{P'})$ we have $F \brbisim \bar E$ and
  (c)~$\den{P}$ cannot be written as $\nu_1 \probc{s} \nu_2$ with $s
  \in (0,1)$ and $\delta(\bar E) \brbisim \nu_1$. Furthermore,
    by Lemma~\ref{lemma-equal-for-concrete-processes}, all $F \in
    \mathit{spt}(\den{P'})$ can be proven equal using~$\AXp$. Thus
  $\AXp\vdash P_{i_0} =\partial(F) \oplusr P$.

  We claim that $\delta(F)\arrow\tau \mu'$ for some~$\mu'$ with
    $\mu'\brbisim \den{P}$. This can be shown as follows: Since
  $\Ebar \arrow\tau \delta(F) \oplusr \den{P}$ and $\Ebar \brbisim F$,
  \vspace{1pt} we have $\delta(F) \tauhidearrow \mu$ for some $\mu
  \brbisim {\delta(F)\oplusr \den P}$. Applying the definition of
  $\tauhidearrow$, we obtain $\delta(F) \arrow\tau \mu'$ for
  some~$\mu'$ with $\mu=\partial(F) \probc{s} \mu'$ and $s \in
    [0,1]$.  Moreover, by Lemma~\ref{cc}(g), using that $\mu$ is
  concrete and thus rigid, $\mu = \eta_1\oplusr \eta_2$ with $\eta_1
  \brbisim \delta(F)$ and $\eta_2 \brbisim \den{P}$.  Since $F \in
  \calEconc$, no fraction of the distribution $\mu'$ can be branching
  bisimilar to~$\delta(F)$. Likewise, no fraction of~$\eta_2$ can be
  bisimilar to~$\delta(F)$, for then by Lemma~\ref{cc}(g) a fraction
  of~$\den{P}$ would be bisimilar to~$\delta(E)$, contradicting~(c)
  above.  Thus $s = r$ and $\mu' = \eta_2 \brbisim
  \den{P}$. This proves $\delta(F) \arrow\tau \mu'$ for some $\mu'$
  with $\mu' \brbisim \den{P}$ as claimed.

  Next, we show that $\Ebar \brbisim H \brbisim F$.
  Let $\calR$ be the smallest symmetric relation that contains $\brbisim$
  as well as $\{(\delta(H),\delta(\Ebar)), (\delta(H),\delta(F))\}$,
  and moreover satisfies $\mu_1 \mopcalR \nu_1 \land \mu_2 \mopcalR \nu_2
    \, \Longrightarrow \, (\mu_1 \oplusr \mu_2) \mopcalR (\nu_1
    \oplusr \nu_2)$. We show that $\calR$ is a branching
  bisimulation. Weak decomposability is fairly
  straightforward---compare the proof of Lemma~\ref{unrooted
    congruence}. Also trivially, it suffices to check the transfer
  condition for the pairs $(\delta(H),\delta(\Ebar))$,
  $(\delta(H),\delta(F))$, $(\delta(F),\delta(\bar H))$ and
  $(\delta(\Ebar),\delta(H))$.

  For $\delta(H) \mopcalR \delta(\Ebar)$, assume $\delta(H)
  \arrow\alpha \varrho$.  Then also $\delta(\Ebar) \arrow\alpha
  \varrho$.
%
  For $\delta(H)\mopcalR \delta(F)$, assume $\delta(H)
  \arrow\alpha \varrho$.  Then also $\delta(\Ebar) \arrow\alpha
  \varrho$, and since $E \brbisim F$ this move can be matched
  by~$\delta(F)$.

  For $\delta(F)\mopcalR\delta(H)$, assume $\delta(F)
  \arrow\alpha \varrho$.  Since $\Ebar\brbisim F$, we have
  $\delta(\Ebar) \alphahidearrow \eta$ for some $\eta \brbisim
  \varrho$.  Here we immediately applied Lemma~\ref{cc}(e), using that
  $\Ebar$ is rigid.  Since $F$ is concrete, no fraction of the
  distribution $\varrho$ can be branching bisimilar to $\delta(F)$, or
  to $\delta(E)$. Using that $\varrho$ is concrete, applying
  Lemma~\ref{cc}(g), this implies that no fraction of $\eta$ can be
  branching bisimilar to $\delta(E)$. Consequently, we in fact have
  $\delta(\Ebar) \alphaarrow \eta$.
  Moreover, no fraction of the transition $\delta(\Ebar)
  \alphaarrow \eta$ can stem from the transition $\Ebar \arrow\tau
  \den{P_{i_0}} = \delta(F) \oplusr \den{P}$.  It follows that
  $\delta(H) \alphaarrow \eta$ with $\eta \brbisim \varrho$.

  For $\delta(\Ebar) \mopcalR \delta(H)$, let $\delta(\Ebar)
  \arrow\alpha \varrho$.  In case $\alpha \neq \tau$, trivially
  $\delta(H) \arrow\alpha \varrho$ and we are done.  So assume~$\alpha
  = \tau$, First consider the case that $\varrho = \delta(F) \oplusr
  \den{P}$. For this case, we have shown above that
  $\delta(F) \arrow\tau \mu'$ for some~$\mu'$ with $\mu' \brbisim
  \den{P}$. Hence, by the previous case, $\delta(H) \arrow\tau \eta$
  for some~$\eta$ with $\eta \brbisim \mu' \brbisim
  \den{P}$. Consequently, $\delta(H) \tauhidearrow \delta(H)\oplusr
  \eta$. Furthermore, $\varrho = (\delta(F) \oplusr
  \den{P}) \mopcalR (\delta(H) \oplusr \eta)$.
%
  The more general case is that $\varrho = (\delta(F) \oplusr \den{P})
  \probc{s} \varrho'$ and $H \arrow\tau \varrho'$ for some $s \in
  [0,1]$. Now $\delta(H) \tauhidearrow (\delta(H) \oplusr \eta)
  \probc{s} \varrho'$ and $\varrho \mopcalR (\delta(H) \oplusr
  \eta) \probc{s} \varrho'$.

  Finally, we can show that  $\tau \pref P_{i_0} \mathbin\sqsubseteq
  \partial(H)$, where $\den{P_{i_0}} = \delta(F) \oplusr \den{P}$.
  This follows because $\delta(H) \tauhidearrow \delta(H) \oplusr
  \eta$ for some $\eta \brbisim \den{P}$, as argued above.
  Using that $\delta(F) \brbisim \delta(H)$, one has
  $\den{P_{i_0}}\brbisim\delta(H)\oplusr \eta$. 

  Case~(b). Suppose $P = \bigoplusiinI \: p_i * E_i$.\vspace{1pt} By case~(a) we
  can choose concrete~$\Pbar_i$ for each index $i \in I$, such that
  \plat{$\AXpb \vdash \partial(E_i) \approx \Pbar_i$}. Put $\Pbar = \bigoplusiinI \:
  p_i * \Pbar_i$. Then $\Pbar \in \calPconc$ by
  Lemma~\ref{cc}(b). By the definition of~$\approx$ it follows that
  \plat{$\AXpb \vdash {\alpha \pref P} = {\alpha \pref \Pbar}$} for
  arbitrary $\alpha \in \calA$.

  Case (c). By the proof of
  part (b) we can find concrete $\Qbar,\bar{R}\in\calPconc$ such that
  \plat{$\AXpb\vdash \alpha \pref
  Q=\alpha\pref \Qbar$} and \plat{$\AXpb\vdash \alpha\pref R = \alpha \pref
  \bar{R}$} for all $\alpha\in\calA$. Using soundness
  (Lemma~\ref{lemma-soundness}) this implies
  $\alpha\pref Q\rootedbrbisim\alpha\pref \Qbar$ and 
  $\alpha\pref R\rootedbrbisim \alpha\pref \bar{R}$,
  and hence $Q\brbisim\Qbar$ and $R\brbisim \bar{R}$.
  By Lemma \ref{lemma-equal-for-concrete-processes} we obtain from $\Qbar
  \brbisim \bar{R}$ that $\AXp\vdash \Qbar = \bar{R}$ and hence $\AXpb
  \vdash \alpha \pref \Qbar =\alpha \pref \bar{R}$ for $\alpha \in
  \calA$. This implies \plat{$\AXpb \vdash \alpha \pref Q =\alpha \pref R $}
  for $\alpha \in \calA$ and finishes the proof.
\end{proof}

\noindent
By now we have gathered all ingredients for showing that the
theory~$\AXpb$ is an equational characterization of rooted branching
probabilistic {\bisimilarity}.
It is noted that in the proof of the theorem we exploit
axiom~\hyperlink{C}{C}.

\begin{theorem}[$\!\AXpb$ sound and complete for $\rootedbrbisim$]\!
  \label{theorem-prob-completeness}
  For all non-deterministic processes $E, F \in \calE$ and all
  probabilistic processes $P,Q \in \calP$ it holds that $E
  \rootedbrbisim F$ iff $\AXpb \vdash {E = F}$ and $P \rootedbrbisim
  Q$ iff $\AXpb \vdash {P = Q}$. 
\end{theorem}

\begin{proof}
  As we have settled the soundness of~$\AXpb$ in
  Lemma~\ref{lemma-soundness}, it remains to show that \plat{$\AXpb$}
  is complete.  So, let $E, F \in \calE$ such that $E \rootedbrbisim
  F$.  Suppose $E = \sumiinI \: \alpha_i \pref P_i$ and $F = \sumjinJ
  \: \beta_j \pref Q_j$ for suitable index sets~$I, J$,
  actions~$\alpha_i, \beta_j$, and probabilistic processes~$P_i, Q_j$.

  Since, for each~$i \in I$, $E \arrow{\alpha_i}\den{P_i}$ we have
  $\delta(F) \arrow{\alpha_i} \bigoplus_{j \in J_i} \: q_{ij} * Q_j$
  and $P_i \brbisim \bigoplus_{j \in J_i} \: q_{ij} * Q_j$ for some
  subset $J_i \subseteq J$ and suitable $q_{ij} \geqslant
  0$. \vspace{2pt} Similarly, there exist for $j \in J$ a subset $I_j
  \subseteq I$ and $p_{ij} \geqslant 0$ such that $\delta(E)
  \arrow{\beta_j} \bigoplus_{i \in I_j} \: p_{ij} * P_i$ and $Q_j
  \brbisim \bigoplus_{i \in I_j} \: p_{ij} * P_i$.  By $|J| + |I|$
  series of applications of axiom~C we obtain
  \begin{align}
    & \AXp \vdash E = 
    \sumiinI \: \alpha_i \pref P_i + 
    \sumjinJ \: \beta_j \pref ( \bigoplus_{i \in I_j} \: p_{ij} * P_i )
    \text{, and} \smallskip \label{eq4} \\
    & \AXp \vdash F = \sumjinJ \: \beta_j \pref Q_j + 
    \sumiinI \alpha_i \pref ( \bigoplus_{j \in J_i} \: q_{ij} * Q_j )
    \, . 
    \label{eq5}
  \end{align}
  Since $P_i \brbisim \bigoplus_{j \in J_i} \: q_{ij} * Q_j$ and $Q_j
  \brbisim \bigoplus_{i \in I_j} \: p_{ij} * P_i$ we obtain by
  Lemma~\ref{lemma-prob-technical}
  \begin{displaymath}
    \AXpb \vdash \alpha_i \pref P_i = 
    \alpha_i \pref \textstyle\bigoplus_{j \in J_i} \: q_{ij} * Q_j 
    \  \text{and} \ 
    \AXpb \vdash \beta_j \pref Q_j = 
    \beta_j \pref\textstyle\bigoplus_{i \in I_j} \: p_{ij} * P_i 
  \end{displaymath}
  for $i \in I$, $j \in J$. Combining this with Equations (\ref{eq4})
  and~(\ref{eq5}) yields $\AXpb \vdash E = F$.

  Now, let $P, Q \in \calP$ such that $P \rootedbrbisim Q$. By
  Lemma~\ref{lemma-form-of-probabilistic-branching-processes} we have
  \begin{displaymath}
    \AXp \vdash { P = \bigoplusiinI \, p_i * E_i }
    \qquad
    \AXp \vdash { Q = \bigoplusiinI \, p_i * F_i }
    \qquad
    \forall i \in I \colon E_i \rootedbrbisim F_i
  \end{displaymath}
  for a suitable index set~$I$, $p_i > 0$, $E_i, F_i \in \calE$,
  for~$i \in I$. By the conclusion of the first paragraph of this
  proof we have $\AXpb \vdash { E_i = F_i }$ for~$i \in
  I$. Hence $\AXpb \vdash { P = Q }$.
\end{proof}
