import json
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt

sns.set(font_scale=4)

def plot_model(model_id):
    data = raw_results[f'GSRBench100-{model_id}']

    # Extracting and preparing data
    results = []
    for repo, stages in data.items():
        for stage, commands in stages.items():
            for command in commands:
                initial_success = command['initial_execution']['return_code'] == 0
                analyzer_success = any(entry['return_code'] == 0 for entry in command['with_analyzer']) if command['with_analyzer'] else False
                ragger_success = any(entry['return_code'] == 0 for entry in command['with_ragger']) if command['with_ragger'] else False
                searcher_success = any(entry['return_code'] == 0 for entry in command['with_searcher']) if command['with_searcher'] else False
                
                results.append({
                    'repo': repo,
                    'stage': stage,
                    'initial_success': initial_success,
                    'analyzer_success': initial_success or analyzer_success,
                    'ragger_success': initial_success or analyzer_success or ragger_success,
                    'searcher_success': initial_success or analyzer_success or ragger_success or searcher_success
                })

    # Create DataFrame
    df = pd.DataFrame(results)
    print(df.shape)

    # Aggregating success rates
    agg_success = df.groupby(['stage']).agg({
        'initial_success': 'mean',
        'analyzer_success': 'mean',
        'ragger_success': 'mean',
        'searcher_success': 'mean'
    }).reset_index()

    # Melting the DataFrame for easier plotting
    agg_success_melted = agg_success.melt(id_vars='stage', value_vars=['initial_success', 'analyzer_success', 'ragger_success', 'searcher_success'], var_name='exec_type', value_name='success_rate')

    # Dictionary for renaming stages
    stage_rename_dict = {
        '# Environment Setup / Requirement / Installation': 'Setup',
        '# Data / Checkpoint / Weight Download (URL)': 'Data/Checkpoint Download',
        '# Training': 'Training',
        '# Inference / Demonstration': 'Inference/Demo',
        '# Testing / Evaluation': 'Testing/Eval'
    }
    stage_order = ['Setup', 'Data/Checkpoint Download', 'Training', 'Inference/Demo', 'Testing/Eval']

    # Renaming stages in the melted DataFrame
    agg_success_melted['stage'] = agg_success_melted['stage'].replace(stage_rename_dict)

    # Plotting with Seaborn
    sns.set(style="whitegrid")

    plt.figure(figsize=(14, 8))
    sns.barplot(x='stage', y='success_rate', hue='exec_type', data=agg_success_melted, order=stage_order)

    # TODO
    # plt.title(f'{model_id}: Cumulative Success Rates of Commands Across Stages and Execution Types')

    plt.xticks(rotation=0, fontsize=18)  # Increase x labels' font size
    plt.ylabel('Cumulative Success Rate', weight='bold', fontsize=18)  # Increase y label font size
    plt.xlabel('Deployment Stage', weight='bold', fontsize=18)  # Increase x label font size
    
    # Set legend with correct labels matching the hue values and increase legend font size
    handles, labels = plt.gca().get_legend_handles_labels()
    plt.legend(handles, ['Initial Execution', 'With Analyzer Only', 'With Analyzer and Ragger', 'With Analyzer, Ragger, and Searcher'], title='Execution Type', fontsize=16, title_fontsize=18)
    
    plt.tight_layout()
    plt.savefig(f'../assets/agg/{model_id}.pdf', format='pdf')
    return agg_success, agg_success_melted
