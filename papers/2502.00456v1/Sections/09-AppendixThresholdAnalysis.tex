\section{Threshold Analysis}

\subsection{Threshold Analysis}

In this section we study edge cases in the MNIST training dataset: given a class e.g. 0, minimum distance from class centroid, being classified as another class e.g. 0 classified as 6, to other class centroids, and minimum distance to to class centroid 0 from other classes misclassified as 0 e.g. 6 misclassified as 0.


\begin{figure}[ht]
    \centering
    \includegraphics[width=0.99\columnwidth]{Figures/ThresholdAnalysis/threshold_comparison_MNIST_train_misclassified.png}
    \caption{Minimum distances to centroid, in cyan, true misclassified as other class, in red, other class misclassified as true class.}
\label{fig:threshold_comparison_MNIST_train_misclassified}
\end{figure}

% THRESHOLD TABLE %

%% Code
% %% hypersphere.py
% # Compute statistics
% stats = compute_classification_statistics(train_data_with_distances, thresholds_same, thresholds_different)
% # Generate table
% latex_table = generate_threshold_table(stats)
% print(latex_table)

\begin{table}[h]
\centering
\begin{tabular}{|l|c|c|c|c|c|c|c|c|c|c|}
\hline
\multicolumn{11}{|c|}{Thresholds} \\
\hline
Digit & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 \\
\hline
Total & 5923 & 6742 & 5958 & 6131 & 5842 & 5421 & 5918 & 6265 & 5851 & 5949 \\
\hline
Incorrect & 33 & 38 & 99 & 112 & 87 & 82 & 34 & 66 & 270 & 105 \\
\hline
Correct & 5890 & 6704 & 5859 & 6019 & 5755 & 5339 & 5884 & 6199 & 5581 & 5844 \\
\hline
Correct \% & 99.44\% & 99.44\% & 98.34\% & 98.17\% & 98.51\% & 98.49\% & 99.43\% & 98.95\% & 95.39\% & 98.23\% \\
\hline
Correct Above T1 & 2 & 0 & 1 & 3 & 0 & 5 & 2 & 2 & 12 & 1 \\
\hline
Correct Above T1 \% & 0.03\% & 0.00\% & 0.02\% & 0.05\% & 0.00\% & 0.09\% & 0.03\% & 0.03\% & 0.21\% & 0.02\% \\
\hline
Correct Below T1 & 5888 & 6704 & 5858 & 6016 & 5755 & 5334 & 5882 & 6197 & 5569 & 5843 \\
\hline
Correct Below T1 \% & 99.41\% & 99.44\% & 98.32\% & 98.12\% & 98.51\% & 98.40\% & 99.39\% & 98.91\% & 95.18\% & 98.22\% \\
\hline
Correct Below T2 & 127 & 23 & 144 & 363 & 254 & 110 & 196 & 61 & 427 & 180 \\
\hline
Correct Below T2 \% & 2.14\% & 0.34\% & 2.42\% & 5.92\% & 4.35\% & 2.03\% & 3.31\% & 0.97\% & 7.30\% & 3.03\% \\
\hline
Misclass Below T1 & 91 & 93 & 74 & 51 & 70 & 80 & 128 & 110 & 29 & 157 \\
\hline
Misclass Below T1 \% & 1.54\% & 1.38\% & 1.24\% & 0.83\% & 1.20\% & 1.48\% & 2.16\% & 1.76\% & 0.50\% & 2.64\% \\
\hline
Misclass Below T2 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 \\
\hline
\multicolumn{11}{|l|}{Total Incorrect: 926} \\
\hline
\multicolumn{11}{|l|}{Total Misclassifications Below T1: 883} \\
\hline
\end{tabular}
\caption{Classification Results}
\end{table}

%% Generated by code

% # fig = create_visualization(threshold_stats)
% # plt.show() 
% Todo invert x axys
% Somehow combine ratio
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.99\columnwidth]{Figures/ThresholdAnalysis/Threshold_Tradeoff_Analysis.png}
    \caption{Minimum distances to centroid, in cyan, true misclassified as other class, in red, other class misclassified as true class.}
\label{fig:Threshold_Tradeoff_Analysis}
\end{figure}

\begin{verbatim}

Threshold Analysis of Correct Classifications
================================================================================
Threshold  Correct      Correct % Digit-wise (count, percentage)
--------------------------------------------------------------------------------
0.80       59073        100.00    0:(5889,100.0%), 1:(6704,100.0%), 2:(5859,100.0%), 3:(6019,100.0%), 4:(5755,100.0%), 5:(5339,100.0%), 6:(5884,100.0%), 7:(6199,100.0%), 8:(5581,100.0%), 9:(5844,100.0%)
0.70       59048        99.96     0:(5888,100.0%), 1:(6703,100.0%), 2:(5858,100.0%), 3:(6016,100.0%), 4:(5755,100.0%), 5:(5334,99.9%), 6:(5881,99.9%), 7:(6197,100.0%), 8:(5575,99.9%), 9:(5841,99.9%)
0.60       58863        99.64     0:(5878,99.8%), 1:(6693,99.8%), 2:(5834,99.6%), 3:(5994,99.6%), 4:(5740,99.7%), 5:(5319,99.6%), 6:(5877,99.9%), 7:(6183,99.7%), 8:(5530,99.1%), 9:(5815,99.5%)
0.50       58626        99.24     0:(5862,99.5%), 1:(6682,99.7%), 2:(5811,99.2%), 3:(5965,99.1%), 4:(5723,99.4%), 5:(5294,99.2%), 6:(5867,99.7%), 7:(6156,99.3%), 8:(5479,98.2%), 9:(5787,99.0%)
0.40       58355        98.78     0:(5849,99.3%), 1:(6670,99.5%), 2:(5778,98.6%), 3:(5932,98.6%), 4:(5690,98.9%), 5:(5278,98.9%), 6:(5855,99.5%), 7:(6127,98.8%), 8:(5420,97.1%), 9:(5756,98.5%)
0.30       57981        98.15     0:(5833,99.0%), 1:(6644,99.1%), 2:(5725,97.7%), 3:(5887,97.8%), 4:(5656,98.3%), 5:(5252,98.4%), 6:(5838,99.2%), 7:(6093,98.3%), 8:(5349,95.8%), 9:(5704,97.6%)
0.20       57411        97.18     0:(5809,98.6%), 1:(6615,98.7%), 2:(5658,96.6%), 3:(5813,96.6%), 4:(5603,97.4%), 5:(5200,97.4%), 6:(5809,98.7%), 7:(6027,97.2%), 8:(5237,93.8%), 9:(5640,96.5%)
0.10       56219        95.17     0:(5752,97.7%), 1:(6545,97.6%), 2:(5520,94.2%), 3:(5691,94.6%), 4:(5491,95.4%), 5:(5089,95.3%), 6:(5740,97.6%), 7:(5903,95.2%), 8:(5018,89.9%), 9:(5470,93.6%)
0.05       54969        93.05     0:(5684,96.5%), 1:(6483,96.7%), 2:(5340,91.1%), 3:(5543,92.1%), 4:(5364,93.2%), 5:(4982,93.3%), 6:(5667,96.3%), 7:(5775,93.2%), 8:(4837,86.7%), 9:(5294,90.6%)
================================================================================
\end{verbatim}

\begin{verbatim}

###############################
# ENHANCED THRESHOLD ANALYSIS #
###############################
hypersphere.py

Enhanced Threshold Analysis
==============================================================================================================
Threshold  Total    Retention% Accuracy%  Correct  Incorrect CumLost  CumElim  Ratio   
--------------------------------------------------------------------------------------------------------------
0.80       59999    100.00     98.46      59073    926      1        0        64:1    
0.70       59924    99.87      98.54      59048    876      26       50       67:1    
0.60       59562    99.27      98.83      58863    699      211      227      84:1    
0.50       59194    98.66      99.04      58626    568      448      358      103:1   
0.40       58797    98.00      99.25      58355    442      719      484      132:1   
0.30       58319    97.20      99.42      57981    338      1093     588      172:1   
0.20       57653    96.09      99.58      57411    242      1663     684      237:1   
0.10       56352    93.92      99.76      56219    133      2855     793      423:1   
0.05       55056    91.76      99.84      54969    87       4105     839      632:1   
========================================================================================================================

###################################
# EXPAND TABLE WITH META ANALYSIS #
###################################

Enhanced Threshold Analysis with Meta Metrics
================================================================================================================================================================
Threshold Total  Retention% Accuracy%  Correct  Incorrect  CumLost  CumElim  Ratio    MetaThresh PointsIn   No class   % CumLost  % CumElim  % PointsIn % No Class
----------------------------------------------------------------------------------------------------------------------------------------------------------------
0.80     59999  100.00     98.46      59073    926        1        0        64:1     0.1337     0          1          0.0017%    0.00%      0.00%      0.0017%   
0.70     59924  99.87      98.54      59048    876        26       50       67:1     0.2337     0          76         0.0440%    5.40%      0.00%      0.1267%   
0.60     59562  99.27      98.83      58863    699        211      227      84:1     0.3337     5          433        0.3572%    24.51%     0.01%      0.7217%   
0.50     59194  98.66      99.04      58626    568        448      358      103:1    0.4337     60         746        0.7584%    38.66%     0.10%      1.2433%   
0.40     58797  98.00      99.25      58355    442        719      484      132:1    0.5337     274        929        1.2171%    52.27%     0.46%      1.5483%   
0.30     58319  97.20      99.42      57981    338        1093     588      172:1    0.6337     889        792        1.8502%    63.50%     1.48%      1.3200%   
0.20     57653  96.09      99.58      57411    242        1663     684      237:1    0.7337     1830       517        2.8151%    73.87%     3.05%      0.8617%   
0.10     56352  93.92      99.76      56219    133        2855     793      423:1    0.8337     3214       434        4.8329%    85.64%     5.36%      0.7233%   
0.05     55056  91.76      99.84      54969    87         4105     839      632:1    0.8837     4904       40         6.9489%    90.60%     8.17%      0.0667%    
\end{verbatim}
% sanity check, row 4, 448 + 358  = 806, 60 + 746 = 806
% the sum of correct classifications above threshold (448)
% and incorrect classifications above threshold (358)
% is equal to the sum of points inside the meta centroid hypersphere (60)
% and the number of points neither in the class centroid nor in the
% meta centroid (hypersphere). 

% Revised Table
% Threshold	Total	Retention%	Accuracy%	Correct	Incorrect	CumLost	CumElim	Ratio	% CumLost	% CumElim	MetaThresh	PointsIn	% PointsIn	No class	% No Class
% 0.80	59,999	100.00	98.46	59,073	926	1	0	64:1	0.0017%	0.00%	0.1337	0	0.00%	1	0.0017%
% 0.70	59,924	99.87	98.54	59,048	876	26	50	67:1	0.044%	5.40%	0.2337	0	0.00%	76	0.127%
% 0.60	59,562	99.27	98.83	58,863	699	211	227	84:1	0.36%	24.51%	0.3337	5	0.008%	433	0.722%
% 0.50	59,194	98.66	99.04	58,626	568	448	358	103:1	0.76%	38.66%	0.4337	60	0.10%	746	1.243%
% 0.40	58,797	98.00	99.25	58,355	442	719	484	132:1	1.22%	52.27%	0.5337	274	0.46%	929	1.548%
% 0.30	58,319	97.20	99.42	57,981	338	1,093	588	172:1	1.85%	63.50%	0.6337	889	1.48%	792	1.320%
% 0.20	57,653	96.09	99.58	57,411	242	1,663	684	237:1	2.81%	73.87%	0.7337	1,830	3.05%	517	0.862%
% 0.10	56,352	93.92	99.76	56,219	133	2,855	793	423:1	4.83%	85.64%	0.8337	3,214	5.36%	434	0.723%
% 0.05	55,056	91.76	99.84	54,969	87	4,105	839	632:1	6.94%	90.60%	0.8837	4,904	8.17%	40	0.067%


% # Generate and print LaTeX code
% latex_code = generate_latex_table(expanded_table)
% print(latex_code)    

\begin{table}[ht]
\centering
\caption{Enhanced Threshold Analysis with Meta Metrics. Key columns:
\textbf{Thresh}: Class threshold;
\textbf{Ret\%}: Retention percentage;
\textbf{Acc\%}: Accuracy percentage;
\textbf{Corr}: Correct predictions retained;
\textbf{Incor}: Incorrect predictions retained;
\textbf{CLost}: Cumulative correct lost;
\textbf{CElim}: Cumulative incorrect eliminated;
\textbf{Ratio}: Correct:Incorrect ratio;
\textbf{MetaT}: Meta threshold;
\textbf{PtsIn}: Points inside meta hypersphere;
\textbf{NoCls}: Points outside both class and meta hyperspheres;
\textbf{\%CLst}: Percentage of total correct lost;
\textbf{\%CEm}: Percentage of total incorrect eliminated;
\textbf{\%Pts}: Percentage of dataset inside meta hypersphere;
\textbf{\%NCl}: Percentage of dataset in no-class zone.}
\label{tab:threshold_analysis}
\begin{tabular}{r r r r r r r r r r r r r r r r}
\toprule
Thresh & Ret\% & Acc\% & Corr & Incor & CLost & CElim & Ratio & MetaT & PtsIn & NoCls & \%CLst & \%CEm & \%Pts & \%NCl \\
\midrule
0.80 & 100.00\% & 98.46\% & 59073 & 926 & 1 & 0 & 64:1 & 0.1337 & 0 & 1 & 0.0017\% & 0.00\% & 0.00\% & 0.0017\% \\
0.70 & 99.87\% & 98.54\% & 59048 & 876 & 26 & 50 & 67:1 & 0.2337 & 0 & 76 & 0.0440\% & 5.40\% & 0.00\% & 0.1267\% \\
0.60 & 99.27\% & 98.83\% & 58863 & 699 & 211 & 227 & 84:1 & 0.3337 & 5 & 433 & 0.3572\% & 24.51\% & 0.01\% & 0.7217\% \\
0.50 & 98.66\% & 99.04\% & 58626 & 568 & 448 & 358 & 103:1 & 0.4337 & 60 & 746 & 0.7584\% & 38.66\% & 0.10\% & 1.2433\% \\
0.40 & 98.00\% & 99.25\% & 58355 & 442 & 719 & 484 & 132:1 & 0.5337 & 274 & 929 & 1.2171\% & 52.27\% & 0.46\% & 1.5483\% \\
0.30 & 97.20\% & 99.42\% & 57981 & 338 & 1093 & 588 & 172:1 & 0.6337 & 889 & 792 & 1.8502\% & 63.50\% & 1.48\% & 1.3200\% \\
0.20 & 96.09\% & 99.58\% & 57411 & 242 & 1663 & 684 & 237:1 & 0.7337 & 1830 & 517 & 2.8151\% & 73.87\% & 3.05\% & 0.8617\% \\
0.10 & 93.92\% & 99.76\% & 56219 & 133 & 2855 & 793 & 423:1 & 0.8337 & 3214 & 434 & 4.8329\% & 85.64\% & 5.36\% & 0.7233\% \\
0.05 & 91.76\% & 99.84\% & 54969 & 87 & 4105 & 839 & 632:1 & 0.8837 & 4904 & 40 & 6.9489\% & 90.60\% & 8.17\% & 0.0667\% \\
\bottomrule
\end{tabular}
\end{table}

\begin{verbatim}


Properties of meta-centroids:

Arithmetic mean centroid:
[0.10043549 0.10034798 0.09953307 0.1000843  0.09995864 0.10001935
 0.10088575 0.10037279 0.09756503 0.10079759]
Sum: 1.000000

Weighted mean centroid:
[0.0999925  0.09993584 0.09968551 0.10017061 0.09987052 0.09996045
 0.10043516 0.10036814 0.09844006 0.10114123]
Sum: 1.000000

Geometric mean centroid:
[0.12057904 0.10358495 0.10405234 0.07952224 0.07645302 0.08430391
 0.07061652 0.11120123 0.10265146 0.14703529]
Sum: 1.000000

Average distances to original centroids:
Arithmetic: 0.931485
Weighted: 0.931482
Geometric: 0.933742

Medoid centroid (index 8):
[0.0032215  0.00286733 0.00458279 0.00517971 0.00143046 0.00434505
 0.00487436 0.00109274 0.96525615 0.00714991]
Sum: 1.000000
Average distance to original centroids: 1.238484

\end{verbatim}

Number of centroid pairs is given by $\binom{n}{k} = \binom{10}{2} = \frac{10!}{2!(10-2)!} = \frac{10!}{2!(8)!} = 45$ pairs

The selection of meta-centroid computation methods presents trade-offs in softmax output space for MNIST classification. The arithmetic mean centroid $\mu_A = \frac{1}{N}\sum_{i=1}^{N} c_i$ minimizes the sum of squared Euclidean distances to all class-specific softmax centroids and maintains the $\sum_{j=1}^{10} \mu_j = 1$ constraint through linear averaging. The weighted centroid $\mu_W = \sum_{i=1}^{N} w_i c_i$ where $w_i = \frac{1/d_i}{\sum_{k=1}^{N} 1/d_k}$ and $d_i$ represents mean distance to other centroids, incorporates inter-class confidence patterns while preserving the probability constraint. The geometric mean $\mu_G = \frac{\exp(\frac{1}{N}\sum_{i=1}^{N} \log(c_i))}{\sum_{j=1}^{10} \exp(\frac{1}{N}\sum_{i=1}^{N} \log(c_{ij}))}$ captures multiplicative relationships in classification confidence scores. The arithmetic and weighted approaches produce similar results (distances 0.931485 and 0.931482) suggesting uniform confidence distribution across MNIST classes, while the geometric mean (distance 0.933742) emphasizes class-specific confidence variations. The weighted approach introduces a bias that reduces the impact of classes with outlier confidence patterns through the weight function $w(d) = 1/d$. The similarity between arithmetic and weighted means indicates consistent softmax behavior across MNIST digits.

Analysis of softmax confidence distributions across MNIST digits reveals systematic variations in classification certainty. Digit 8 exhibits consistently lower confidence (86.7\% at 0.05 threshold) while digits 0, 1, and 6 maintain higher confidence ($>$96\%). The geometric mean approach for meta-centroid computation ($\mu_G = \frac{\exp(\frac{1}{N}\sum_{i=1}^{N} \log(c_i))}{\sum_{j=1}^{10} \exp(\frac{1}{N}\sum_{i=1}^{N} \log(c_{ij}))}$) captures these multiplicative variations in confidence degradation patterns. This method's sensitivity to probability drops across thresholds provides better representation of global model behavior than the uniform distributions produced by arithmetic or weighted means.

%% STOPPED HERE
%% WORK PLAN 20250128
%% 1. add repo, script name and function name to generate tables and figures
%% 2. add definition, discussion and stats related to 
%% Maximal Entropy Hypersphere
%% 3. Add definition, discussion and stats about Entropy Apex
%% and hopefully find a weight that could pull the wrong
%% predictions between T1 and T2 out of there and back into the hyphersphere
%% 4. Add definition, discussion and stats about the n-dimensional "No Man's Land", where predictions move away from the centroids but not into the hypersphere

%% Stretch goals
%% Add same discussion for CIFAR10, keeping it in the appendix.
%% Add perturbed MNIST data analysis - should be straightforward as we have all the functions
%% Add perturbed CIFAR10, probably a stretch goal too far but
%% we'll see
%% Make story coherent. The impossible we can do, miracles might take a little longer.

% Plot created manually from MNIST and CIFAR10 plots created by function plot_accuracy_vs_distance_linear_fit
\begin{figure}[ht]
    \centering
    \includegraphics[width=0.99\columnwidth]{Figures/ThresholdAnalysis/Class_0_nearest_misclassifications_label_and_prediction_with_entropy.png}
    \caption{Left to right, Softmax output for nearest training example of class 0 (id 47690) misclassified as another class (6). Softmax output of nearest of any class (6, id 494) misclassified as 0. Entropy values for both cases. Images for both cases.}
\label{fig:Class_0_nearest_misclassifications_label_and_prediction_with_entropy}
\end{figure}



