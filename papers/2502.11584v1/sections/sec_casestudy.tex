\section{Case Study}
\label{Case Study}
We developed a prototype of our runtime enforcement algorithm in Python and applied this prototype to case studies on Autonomous Vehicles (AVs) to demonstrate the efficiency and scalability of our method. Three cases were considered in the experiments. The first case addresses the property of `safe stopping of AVs', the second focuses on `safe charging of AVs', while the third focuses on `safe deceleration of AVs'. All the cases underscore the efficiency (\cref{sec:efficiency}) and scalability (\cref{sec:scala}) of our method.

%In this section, we present a case study of an Autonomous Vehicle (AV)- a self-driving car. 
%AVs operate in dynamic environments, and ensuring precise control over critical signals is essential for safety and reliability. Due to environmental noise, sometimes, the critical signals can deviate from expected behaviour, potentially compromising safety.
%To address this, one can leverage formal runtime enforcement monitors that observe these signals as the vehicle operates. By specifying formal properties for each signal, the monitor can verify whether these properties hold at every moment. If a property is violated, the monitor can immediately correct the signal, ensuring the AV continues to perform safely. %This type of runtime enforcement is particularly useful in scenarios involving speed control, where strict limits are needed for example for safe stopping.\\

%include a formulate safety properties and demonstrate the enforcement. We provide empirical evidence that our approach is scalable.

\subsection{Efficiency Evaluation}\label{sec:efficiency}

    \paragraph{Safe stopping of AVs}
    Consider a scenario in which an AV is required to decelerate to a complete stop when approaching a red light or a designated stop point. This requirement is expressed by the property \((v \le 30)\until_{[5,10]} (v=0)\). This stipulates that \textit{the speed of the vehicle must ultimately reach $0$ within a time frame of $5$ to $10$ seconds, while maintaining a speed no larger than $30$ until then}.

    \begin{figure}[h]
        \centering
        \includegraphics[width=.76\linewidth,trim={18cm 0cm 0cm 0cm}, clip]{figures/speed.png}
        \caption{Enforcement of Speed Signal against Safe Stopping Property}
        \label{fig:speed}
    \end{figure}

    The results of our experiment are depicted in \cref{fig:speed}, where the blue signal represents the output after enforcement, while the orange one is the original signal. These results demonstrate that the enforcement monitor effectively adjusted the signal to ensure compliance with the STL property, while maintaining transparency and minimal modification. Specifically, the enforcer precisely addressed the four instances where the speed exceeded $30$ (sudden speed spikes), applying only the necessary changes without superfluous adjustments to the signal.
  
    \paragraph{Safe charging of AVs}
    Consider a scenario in the battery charging systems of AVs. Normally, the current stays within a safe range throughout a specified interval. If, however, the voltage reaches a specific volts, the system switches to a charging mode designed to safely handle higher currents. This condition is formally represented by the property \((V=4.2) \release_{[2,10]} (I<10)\), which indicates that \textit{the current will not exceed $10$ within a timeframe of $2$ to $10$ seconds, unless the voltage reaches $4.2$ volts earlier}.

    \begin{figure}[t]
        \centering
        \includegraphics[width=.76\linewidth, trim={0cm 0cm 18cm 0cm}, clip]{figures/battery_corrected.png}
        \includegraphics[width=.76\linewidth, trim={17.6cm 0cm 0cm 0cm}, clip]{figures/battery_corrected.png}
        %\vspace{-2mm}
        \caption{Enforcement of Voltage and Current Signals against Safe Charge Property}
        \label{fig:battery}
    \end{figure}

    The results of our experiment are depicted in \cref{fig:battery}, where the blue signal represents the output after enforcement, and the orange signal is the original one. These results illustrate that during the interval from $2$ to $10$ seconds, the current $I$ is minimally adjusted to remain below $10$, provided that the voltage $V$ does not reach $4.2$ volts.


    \paragraph{Safe deceleration of AVs}
    Consider a scenario of coordinated deceleration for stability and safety in AVs, where both wheels and motor controls slow down together, helping avoid sudden stops or imbalances. It is a dual-redundant safety feature: The wheel subsystem must ensure that its value does not exceed 30 within the timeframe and ultimately reaches zero between 5 and 10 seconds. Simultaneously, the motor control subsystem has the same requirement. This condition is formally represented by the property $(w \leq 30)\until_{[5,10]} (w = 0) \land (m \leq 30)\until_{[5,10]} (m = 0)$, which indicates that \textit{both the wheels and motor control must ultimately reach $0$ within a time frame of $5$ to $10$ seconds while maintaining the values no larger than $30$ until then}.
    % \hscomment{@Saumya. The size of figure for the third experiment seems different from the other two, could you make the size the same?}
    \begin{figure}[t]
        \centering
        \includegraphics[width=0.83\linewidth, trim={0cm 0.5cm 0cm 0.9cm}, clip]{figures/wheel.png}
        \includegraphics[width=0.83\linewidth, trim={0cm 0.5cm 0cm 0.6cm}, clip]{figures/motor.png}
        %\vspace{-2mm}
        \caption{Enforcement of Wheel and Motor Control Signals against Safe Deceleration Property}
        \label{fig:wheel_motor}
    \end{figure}

    The results of our experiment are depicted in \cref{fig:wheel_motor}. These results illustrate that during the interval from $5$ to $10$ seconds, the wheel ($w$) and motor control ($m$) are minimally adjusted to remain below $30$, provided that these signals do not reach $0$ volts.
    
    
\subsection{Scalability Evaluation}\label{sec:scala}
    %\hscomment{The experimental results appear efficient; however, incorporating STL properties that include Boolean operators $\land$ or $\lor$ could enhance our result.}
    To assess the scalability of our approach, we conducted experiments in which we progressively increased the complexity of the signal - specifically, the number of violation points in the signal - to examine how enforcement time is affected. The results, presented in \cref{tab:performance} for the three scenarios mentioned earlier, show that the enforcement time (measured in milliseconds) increases in a piecewise linear fashion as the number of violations grows. This behavior is consistent with the predictions of our complexity analysis.
    % \hscomment{I changed the capital of the table from STL formula to the specific property name, please check which type is better.}
    \begin{table*}[t]
        \centering
            \captionsetup{font={small}}
            \caption{Experimental results with varying violation points in the signal}
            \vspace{-0.32cm}
            \label{tab:performance}
            \begin{center}
                % \begin{tabular}{c c ccc c ccc} 
                %     \toprule
                %     \multirow{2}{*}{$\#v$} &~& \multicolumn{3}{c}{$(v \leq 30)\until_{[5,10]} (v = 0)$} &~& \multicolumn{3}{c}{$(V=4.2) \release_{[2,10]} (I<10)$}\\
                %     \cmidrule{3-5}\cmidrule{7-9}
                %     && $\textsf{len}(\tword)$ &~& \textsf{time}(ms) &~& $\textsf{len}(\tword)$ &~& \textsf{time}(ms)\\
                %     \midrule
                %     2 &~& 6 &~& 0.117 &~& 5 &~& 0.086\\
                %     4 &~& 8 &~& 0.124 &~& 7 &~& 0.146\\
                %     6 &~& 10 &~& 0.14 &~& 9 &~& 0.156\\
                %     8 &~& 12 &~& 0.156 &~& 11 &~& 0.173\\
                %     10 &~& 14 &~& 0.186 &~& 13 &~& 0.19\\
                %     12 &~& 14 &~& 0.202 &~& 15 &~& 0.199\\
                %     14 &~& 18 &~& 0.237 &~& 14 &~& 0.215\\
                %     16 &~& 16 &~& 0.217 &~& 17 &~& 0.262\\
                %     18 &~& 19 &~& 0.237 &~& 19 &~& 0.265\\
                %     20 &~& 22 &~& 0.287 &~& 17 &~& 0.242\\
                %     \bottomrule
                % \end{tabular}
                \begin{tabular}{@{}ccccccccc@{}}
                    \toprule
                    %\multirow{2}{*}{$\#v$} & \multicolumn{2}{c}{$(v \leq 30)\until_{[5,10]} (v = 0)$} &~& \multicolumn{2}{c}{$(V=4.2) \release_{[2,10]} (I<10)$} &~& \multicolumn{2}{c}{$(w \leq 30)\until_{[5,10]} (w = 0) \land (m \leq 30)\until_{[5,10]} (m = 0)$} \\
                    \multirow{2}{*}{$\#v$} & \multicolumn{2}{c}{\textit{Safe stopping of AVs}} &~& \multicolumn{2}{c}{\textit{Safe charging of AVs}} &~& \multicolumn{2}{c}{\textit{Safe deceleration of AVs}} \\
                    \cmidrule{2-3} \cmidrule{5-6} \cmidrule{8-9}
                                       & $\textsf{len}(\tword)$        & \textsf{time}(ms)       &~& $\textsf{len}(\tword)$        & \textsf{time}(ms)         &~& $\textsf{len}(\tword)$        & \textsf{time}(ms)          \\ \midrule
                    2                  & 6        & 0.117     &~& 5        & 0.086      &~& 9        & 0.221      \\ 
                    4                  & 8        & 0.124     &~& 7        & 0.146      &~& 13       & 0.369      \\ 
                    6                  & 10       & 0.14      &~& 9        & 0.156      &~& 17       & 0.419      \\ 
                    8                  & 12       & 0.156     &~& 11       & 0.173      &~& 20       & 0.629      \\ 
                    10                 & 14       & 0.186     &~& 13       & 0.19       &~& 21       & 0.631      \\ 
                    12                 & 14       & 0.202     &~& 15       & 0.199      &~& 26       & 0.719      \\ 
                    14                 & 18       & 0.237     &~& 14       & 0.215      &~& 27       & 0.8        \\ 
                    16                 & 16       & 0.217     &~& 17       & 0.262      &~& 28       & 0.867      \\ 
                    18                 & 19       & 0.237     &~& 19       & 0.265      &~& 35       & 0.916      \\ 
                    20                 & 22       & 0.287     &~& 17       & 0.242      &~& 30       & 0.988      \\ \bottomrule
                    \end{tabular}
            \end{center}
            %\vspace*{-\baselineskip}
            %\vspace*{1mm}
            \small{ 
                $\textsf{len}(\tword)$: the length of time word encoded from the signal;~
                $\#v$: the number of violation points in signal
            } 
        \end{table*}

        Overall, our method demonstrates robust capabilities in runtime enforcement for signals against properties specified using STL. It ensures compliance with requirements for soundness, transparency, and minimal modification across all scenarios. Moreover, it exhibits high effectiveness in managing complex signals, indicating that the time required is minimal. %Therefore, our approach represents a high-performance method for achieving runtime enforcement.
        
% \subsection{Safe AV stopping}
% \noindent \textit{Scenario Description and Example Property: }
%     Consider a scenario where an AV must decelerate to a complete stop when approaching a red light or a designated stopping point. We specify property number (1) of Example \ref{example:Properties in STL} saying that: \textit{The value of the speed signal will be 0 between 5 to 10 seconds; until then the value of the signal is less than 30}, i.e., 
%     \begin{align*}
%         (\signal  < 30) \until_{[5,10]} (\signal = 0)
%     \end{align*}
%     %\noindent \textit{Need of Runtime Enforcement}
%     % Above specified property can be enforced on the vehicle’s speed, such that it remains below a certain threshold while it approaches the stop and comes to a complete halt within a defined time window. By enforcing this speed constraint, the AV can stop smoothly and safely at designated locations, reducing safety risks. Such a predictable stopping behaviour is essential for AVs, especially in urban settings where other road users might be around. This case study describes the above property and its enforcement process in an AV context.


%     %\noindent \textit{Generating Test Signals with Violations: } %When generating test speed signals for the AV speed, it is essential to mimic realistic behavior under conditions where the vehicle may partially deviate from specified STL constraints. A detailed approach for generating these test speed signals, ensuring they exhibit both compliance and controlled violations for effective runtime enforcement is given below:\\
%     %
%     %\noindent \textit{Setting Initial Parameters for Speed Signal Generation}:
%     %The initial speed of the vehicle at $t=0$ is set to 30. %This creates a realistic starting condition where the vehicle's speed is initially within the safe range but may approach the violation threshold as it evolves.\\
%     %\noindent \textit{Decaying Speed signal}:
%     %To model deceleration i.e., the vehicle slowing down as it approaches a red light or stop, we used a linear decay function (where the rate of deceleration is constant) to ensure that the speed goes towards 0 by $t=10$ seconds.  
%     %\noindent \textit{Adding Noise/ Controlled Violations}:
%     %To test the enforcement monitor to detect and correct violations, we added speed spikes at some random time points to create a temporary violation of $\signal<30$.
%     %
%     \begin{figure*}%[H]
%         \centering
%         \includegraphics[width=1\linewidth]{figures/speed.png}
%         \caption{Generated vs Corrected Speed signal}
%         \label{fig:speed}
%     % \end{figure*}
%     % \begin{figure*}%[htp]
%     %     \centering
%         \includegraphics[width=0.9\linewidth]{figures/battery_uncorrected.png}
%         \includegraphics[width=0.9\linewidth]{figures/battery_corrected.png}
%         \caption{Generated vs Corrected V and I signals}
%         \label{fig:battery}
%     \end{figure*}
    
%     \noindent \textit{Encoding and correcting the signals: } The original signal is given in the left plot in Figure \ref{fig:speed}. 
%     Following Section \ref{sec: Signal Encoding}, we encode the signal into a timed word, needed for enforcement. This involves recording the truth value of predicates of the STL formula at both variable points and relevant points within the signal.
%     %
%     The encoded time word $\tword$ is as follows: % [[0.0, 'a', '$not\_b$'], [5.0, 'a', '$not\_b$'], [5.1, '$not\_a$', '$not\_b$'], [5.2, 'a', '$not\_b$'], [6.3, '$not\_a$', '$not\_b$'], [6.4, 'a', '$not\_b$'], [9.7, 'a', 'b'], [10.0, 'a', 'b']] 
%     [[0.0, 'a', 'not\_b'], [0.5, 'not\_a', 'not\_b'], [0.6, 'a', 'not\_b'], [2.2, 'not\_a', 'not\_b'], [2.3, 'a', 'not\_b'], [2.8, 'not\_a', 'not\_b'], [2.9, 'a', 'not\_b'], [5.0, 'a', 'not\_b'], [9.6, 'a', 'b'], [10.0, 'a', 'b']],
%     where $a$ means $\signal< 30$ is satisfied, $not\_a$ means  $\signal< 30$ is not satisfied, $b$ means $\signal= 0$ is satisfied and $not\_b$ means  $\signal = 0$ is not satisfied by the generated speed signal. 

%     %\noindent \textit{Correcting signals: } %\subsubsection{Timed Transducer for the Until Operator}: 
%     Following Section \ref{sec: Transform STL into TA}, we construct a timed transducer model for the until operator of STL, where $p_1 \equiv \signal<30$ and $p_2 \equiv \signal=0$. %In case, the signal needs to be corrected, the transducer outputs the minimal value of the signal by which the signal is to be corrected, in the implementation.
%     Following Algorithm \ref{algorithm}, we construct the enforcer here.  
%     %
%     %\subsection{Results}
%      The enforcement monitor corrected the signal to ensure compliance with the STL property as seen in the right plot in Figure \ref{fig:speed}. The enforcer accurately corrected the three violations without unnecessary corrections to the signal.

%     \subsection{Safe battery charging of AV}
%     \noindent \textit{Scenario Description and Example Property: } Consider a scenario in battery charging systems in AVs that under normal conditions, the current remains within a safe range (below 10 amps) during a specified interval. However, if the voltage reaches 4.2 volts within this time frame, the system can recognize this as a signal to relax the current limit footnote{The voltage condition (4.2 volts) could indicate a specific state, such as a change in the charging mode, where it is safe to allow higher currents}. To ensure such safe operating conditions, one can define the following STL property:
%     \begin{align*}
%         (V==4.2) \release_{[2,10]} (I<10)
%     \end{align*}  
%     %and monitor this property in real time. Such monitoring is essential in applications like electric vehicles or electronic devices, where excessive current could lead to overheating or damage, making strict limits crucial for system safety and longevity.

%     \noindent \textit{Encoding and correcting the Signal: } The original generated signals of $V$ and $I$ are given in the top plots in Figure \ref{fig:battery}. The corresponding corrected signals are given in the bottom plots in Figure \ref{fig:battery}, where we observe that, during the interval from 2 to 10 seconds, the current $I$ is minimally adjusted to stay below 10 as long as the voltage $V$ is not equal to 4.2.
%     % \begin{figure*}[htp]
%     %     \centering
%     %     \includegraphics[width=0.9\linewidth]{figures/battery_uncorrected.png}
%     %     \includegraphics[width=0.9\linewidth]{figures/battery_corrected.png}
%     %     \caption{Generated vs Corrected V and I signals}
%     %     \label{fig:battery}
%     % \end{figure*}


% The enforcer, transducer and signal processing are all implemented in Python. 



%     \subsection{Evaluating Performances}
% To evaluate the performance of our approach to see its scalability, we conducted experiments where we linearly increased the number of violations in the signals to observe how the enforcement time changes. %Specifically, we examined whether a linear increase in violations results in a linear increase in enforcement time. 
% %These experiments were conducted with different signals and different STL formulas.
% The results, displayed in Table \ref{Tab:performance} for the above scenarios, indicate that the enforcement time (measured in ms) increases (piecewise) linearly with a linear increase in the number of violations.





% \begin{table}[]
% \begin{tabular}{@{}|l|ll|ll|@{}}
% \toprule
% \multicolumn{1}{|c|}{\multirow{2}{*}{$\#v$}} & \multicolumn{2}{c|}{$(x \leq 30)\until_{[5,10]} (x = 0)$} & \multicolumn{2}{c|}{$(x_1=4.2)\release_{[2,10]}(x_2<10)$}     \\ \cmidrule(l){2-5} 
% \multicolumn{1}{|c|}{}                   & \multicolumn{1}{c|}{$len(\sigma)$} & \multicolumn{1}{c|}{T(ms)} & \multicolumn{1}{c|}{$len(\sigma)$} & \multicolumn{1}{c|}{$T(ms)$} \\ \midrule
% 2                                        & \multicolumn{1}{l|}{6}          & 0.117                      & \multicolumn{1}{l|}{5}          & 0.086                      \\ \midrule
% 4                                        & \multicolumn{1}{l|}{8}          & 0.124                      & \multicolumn{1}{l|}{7}          & 0.146                      \\ \midrule
% 6                                        & \multicolumn{1}{l|}{10}         & 0.14                       & \multicolumn{1}{l|}{9}          & 0.156                      \\ \midrule
% 8                                        & \multicolumn{1}{l|}{12}         & 0.156                      & \multicolumn{1}{l|}{11}         & 0.173                      \\ \midrule
% 10                                       & \multicolumn{1}{l|}{14}         & 0.186                      & \multicolumn{1}{l|}{13}         & 0.19                       \\ \midrule
% 12                                       & \multicolumn{1}{l|}{14}         & 0.202                      & \multicolumn{1}{l|}{15}         & 0.199                      \\ \midrule
% 14                                       & \multicolumn{1}{l|}{18}         & 0.237                      & \multicolumn{1}{l|}{14}         & 0.215                      \\ \midrule
% 16                                       & \multicolumn{1}{l|}{16}         & 0.217                      & \multicolumn{1}{l|}{17}         & 0.262                      \\ \midrule
% 18                                       & \multicolumn{1}{l|}{19}         & 0.237                      & \multicolumn{1}{l|}{19}         & 0.265                      \\ \midrule
% 20                                       & \multicolumn{1}{l|}{22}         & 0.287                      & \multicolumn{1}{l|}{17}         & 0.242                      \\ \bottomrule
% \end{tabular}
% \caption{Eﬀect on time taken ($T(ms)$) by enforcement by varying the number of violations ($v$).}
% \label{Tab:performance}
% \end{table}


% \subsection{Discussion}
% This experimental analysis is conducted offline. We assume the entire signal is available to us upfront, allowing us to extract all significant variables and relevant points, construct an input word, and then perform enforcement on each event one by one. However, an alternative approach could involve processing the signal in real-time, constructing timed events at runtime as the signal arrives, and enforcing properties accordingly.



% \subsubsection{Timed Transducer Model of Until Operator}
%  \begin{figure*}[H]
%      \centering
%      \includegraphics[width=1\linewidth]{figures/speed_corrected.png}
%      \caption{Enforcing speed constraint}
%      % \label{fig:enter-label}
%  \end{figure*}



