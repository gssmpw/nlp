\section{Hierarchical control structure} \label{sec:controlstrategy}
In this section, a hierarchical control structure (see Fig. \ref{fig:controllayout}) is proposed, assuming a time-scale separation between the translational and orientation dynamics \cite{Bertrand2011,herisse12}. Expanding the system dynamics \eqref{eq:dotv} with the desired attitude terms yields
\begin{equation}
	m_i\dot{v}_i = -T_i (R_ie_3- R_i^* e_3) - T_i R_i^* e_3 + m_i g e_3,
\end{equation}
where $-T_iR_i^* e_3$ is a total desired force. Provided that an inner-loop attitude controller is designed to provide a fast enough convergence, the time-scale separation allows for neglecting the attitude error in the outer-loop dynamics, allowing the system to be given by  
\begin{equation}
	\dot{v}_i \approx \underbrace{- \frac{T_i}{m_i} r_{3,i}^* + g e_3}_{u_i},
	\label{eqn:double_integrator_model}
\end{equation}
where $u_i \in \mathbb{R}^3$ is a virtual acceleration input to be designed and $r_{3,i}^*:=R_i^* e_3$ is the desired z-axis of the vehicle. The total thrust $T_i$ applied to each vehicle can be computed according to
\begin{equation}
	T_i := m_i||u_i - g e_3||.
\end{equation}
%\subsection{Attitude Controller Design}
The desired z-axis of each vehicle is set as
\begin{equation}
	r_{3,i}^* := \frac{u_i - g e_3}{||u_i - g e_3||},
\end{equation}
from which $R_i^*\in SO(3)$ can be obtained by complementing $r_{3,i}^*$ with a desired yaw angle. Finally, the angular velocity used as input to the vehicle, adopted from \cite{Tang2015}, is given by
\begin{equation}\label{eq:Omega}
	\Omega_i := n_i [e_3]_{\times} R_i^\top r_{3,i}^* + \frac{m_i}{T_i} \pi_{e_3} R_i^\top [r_{3,i}^*]_{\times}\dot{u}_i,
    %\Omega_i := -n_i R_i^\top [r_{3,i}^*]_{\times} r_{3,i} -\frac{m_i}{T_i} R_i^\top [r_{3,i}^*]_{\times}\pi_{r_{3,1}^*}\dot{u}_i,
\end{equation}
where $n_i \in \mathbb{R}^{+}$ is a controller gain and $ r_{3,i}$ is the third column of $R_i$. 
\begin{figure}%[H]
	\centering
	\includegraphics[width=0.99\linewidth]{NewFigures/Inner_outer_loop.pdf}
    \vspace{-0.4cm}
	\caption{Hierarchical control structure for each quadrotor $i$.}
	\label{fig:controllayout}
    % \vspace{-0.1cm}
\end{figure}

% \begin{remark}
% 	For the implementation of this high-gain inner-loop attitude controller, it is assumed that the feedforward term $\dot{u}_i\approx\dot{u}_i^*$ to obtain zero tracking error when the trajectories of the desired formation are time-varying. As such, the desired trajectories are assumed to be thrice differentiable and have a desired jerk $\dot u_i^*$ .
% \end{remark}