%\subsection{OT Approximation Challenges for Point Cloud Generation}
% \subsection{Challenges in OT Approximation for Point Cloud Generation}

\vspace{-2mm}
\subsection{Existing OT Approximation for Point Cloud Generation}
\vspace{-1mm}
% \phil{TODO: about the subsection title... How about ``Studying OT Approximation for Point Cloud Generation'' or ``Investigating OT Approximation for Point Cloud Generation''?}
\label{subsec:points_challenges}
\input{figures/ot_analysis}
% \begin{itemize}
%     \item Introduction of Characteristics for Point Cloud. We will introduce three important characteristics of point clouds: the permutation-invariant property, the requirement of a dense point set, and their nature as sub-samples from an underlying surface. 
%     \item Analysis of challenges with existing OT coupling approximation methods. Current approaches either fail to construct a good OT coupling approximation for dense permutation-invariant sets (Minibatch OT) or are computationally too expensive for training (Equivariant OT coupling).
% \end{itemize}

%This work focuses on generating 3D shapes represented as point clouds. A point cloud $\rvx_1$ is a set of points sampled on the surface of a given shape $\mathcal{S}$, with point coordinates arranged in matrix format: $\rvx_1 \in \mathcal{R}^{N \times 3}$, where $N$ is the number of points. Unlike 2D images, point clouds have several unique properties, which pose challenges for existing OT approximation methods and motivate us to develop a new framework for efficiently computing the OT map:

We focus on generating 3D shapes represented as point clouds. A point cloud $\rvx_1 \in \mathcal{R}^{N \times 3}$ is a set of points sampled from the surface of a shape $\mathcal{S}$, where $N$ is the number of points. Unlike 2D images, point clouds have unique properties that pose challenges for existing OT methods:

\textbf{(i) Permutation Invariance.} \
A point cloud, while arranged in a matrix form, is inherently a set. Shuffling points in $\rvx_1$ should represent the same shape. Mathematically, given a permutation matrix $\rvrho(g)$, the sampling probability remains unchanged,~\ie, $q_1(\rvrho(g) \rvx_1) = q_1(\rvx_1)$.
    
\textbf{(ii) Dense Point Set.} \
Point clouds are finite samples on surfaces. However, similar to low-resolution images, sparse point sets may miss fine geometric structures and details. Thus, most works use dense point sets (say $N \geq 2048$) to accurately capture 3D shapes.

%The above two unique properties of 3D point clouds present challenges when directly applying existing Optimal Transport (OT) map approximation methods. Specifically, Minibatch OT~\cite{pooladian2023multisample,tong2023improving} fails to produce high-quality OT maps for point cloud generation, while Equivariant OT~\cite{klein2024equivariant,song2024equivariant} is computationally inefficient.

Existing approach to estimating OT maps face these challenges on point clouds:

\para{Ineffectiveness of Minibatch OT.} \
%Minibatch OT falls short of producing high-quality OT maps for point cloud data, despite its success in low-dimensional and image domains. The reason  stems from property (i) of point clouds: there are $N!$ possible matrix representations of the same point cloud. This means there are $N!$ equivalent pairs for the training pair $(\rvx_0, \rvx_1)$, by applying relative permutations $\rvrho(g)$ to $\rvx_1$,~\ie, $(\rvx_0, \rvrho(g)\rvx_1)$. An OT-sampled pair should minimize the distance function: $C(\rvx_0, \rvx_1) = \min\limits_{g \in G} C(\rvx_0, \rvrho(g) \rvx_1)$. However, Minibatch OT assignments only grow quadratically with batch size, while training pair permutations increase exponentially. This method likely yields a suboptimal pair that fails to meet the above requirement and is thus far from optimal.
%To study the quality of the approximated OT map, we measure the average OT distance of sampled training pairs $C(\rvx_0, \rvx_1)$ produced from different methods and plot the results for varying batch sizes in Figure~\ref{fig:ot_analysis} (left). Overall, Minibatch OT achieves only a negligible reduction ($\sim 1\%$) compared to the independent coupling \phil{strategy} in the original flow matching formulation, even with a batch size of 256. This demonstrates the limited effectiveness of this approach in point cloud generation.
Minibatch OT, effective in low-dimensional and image domains, fails for point clouds due to property (i). There are $N!$ equivalent representations of the same point cloud, implying $N!$ equivalent training pairs $(\rvx_0, \rvx_1)$. An OT-sampled pair should minimize the cost: $C(\rvx_0, \rvx_1) = \min_{g \in G} C(\rvx_0, \rvrho(g) \rvx_1)$. However, in Minibatch OTâ€™s with no permutation, the assignments grow quadratically with batch size, while the number of permutations grows exponentially. As shown in Figure~\ref{fig:ot_analysis} (left), Minibatch OT achieves only about $6\%$ reduction in the cost even with batch size 256, indicating limited effectiveness of this approach in point cloud generation.

\para{Inefficient OT Maps in Equivariant OT.} \
Equivariant OT produces high-quality maps, but is computationally expensive for point cloud generation. %In particular, it resolves Minibatch OT's shortcomings by modifying the cost function to account for permutations, demonstrating success in generating molecular data. As
Figure~\ref{fig:ot_analysis} (left) shows a $48.7\%$ reduction even with a batch size 1, showing the importance of aligning points and noise via permutation.
%, this modification proves effective for point cloud generation, achieving approximately $46.7\%$ reduction (orange curve) even with a batch size 1. 
%This result highlights the importance of considering the permutation-invariance of point clouds.
However, unlike molecular data, which has limited size ($N$$=$$55$ in~\cite{klein2024equivariant}), representing 3D shapes needs a larger $N$, following property (ii). 
%So, computing the modified cost function requires solving another OT problem of reordering point coordinates using the Hungarian algorithm~\cite{kuhn1955hungarian}. Given a time complexity of $O(N^3)$, it takes over 200 seconds to solve a problem instance, even for a batch size of one; see Figure~\ref{fig:ot_analysis} (right). In each training iteration, we must solve $B^2$ problem instances to evaluate the distances among all possible pairs of $\rvx_0$ and $\rvx_1$, where $B$ is the batch size.  This computational burden prohibits the practical use of this approach.
Solving the optimal transport cost takes an $O(B^2 N^3)$ computational complexity because of the quadratic number of noise and point cloud pairs in a batch of $B$ examples, and $O(N^3)$ for the the Hungarian algorithm~\cite{kuhn1955hungarian}. Figure~\ref{fig:ot_analysis} (right) shows how this grows rapidly even for a typical point cloud size ($N=2048$).
%
It takes around 2.2 seconds for the OT computation even for $B = 1$, leading to a significant bottleneck in the training process that is more than 40x slower than independent coupling.
%\ednote{our OT not-so-optimal flow can finish 1 epoch in 7 seconds, while it takes 310 seconds for Equivariant OT}

\if 0
% To evaluate effectiveness, we aim to obtain an OT map that well approximates the ground truth. We can assess the OT map's performance by measuring the average distance function $C(x_0, x_1)$ over sampled training pairs $x_0$ and $x_1$.
%
Since most existing works approximate the OT between batched training pairs, we can evaluate the average distance function across various batch sizes.
%
Figure~\ref{} illustrates the average distance function of four different methods, Flow Matching, Minibatch OT, Equivariant Flow Matching, and Our OT Approximation (detailed in Section~\ref{subsec:ot_approx}), over 32 training batches for different batch sizes.

The figure shows that flow matching exhibits the highest distance values compared to other methods, confirming that independent coupling is far from the optimal transport (OT) map.
%

% While Minibatch OT~\cite{pooladian2023multisample,tong2023improving} has shown success in the image domain, it performs poorly for point clouds, failing to reduce the distance function (compared to flow matching).
%
% This is because the number of possible permutations of training pairs grows exponentially ($N!$), whereas the combinations of assignments in Minibatch OT only increase quadratically with batch size.
% %
% This OT approximation is unlikely to locate a training pair sharing the same permutation, i.e., $C(x_0, x_1) = \min\limits_{g \in G} C(x_0, \rho(g) x_1)$, making it far from optimal transport.
% %
% Notably, in point cloud generation ($N \geq 2048$), the distance reduction is almost negligible even with a batch size of 1024.

In contrast, equivariant flow matching~\cite{klein2024equivariant} considers permutations in the matching process, significantly reducing distances even with a batch size of 1.
%
However, finding the optimal permutation between a training pair involves solving another OT problem using the points' and noises' coordinates.
%
The Hungarian algorithm, typically used to solve OT problems, has a complexity of $O(N^3)$, making it computationally expensive for point cloud training.
%
Our efficiency analysis of different OT approximation methods reveals that the processing time of equivariant flow matching is prohibitively long (around 200 seconds per batch), even for a batch size of 1.
\fi

