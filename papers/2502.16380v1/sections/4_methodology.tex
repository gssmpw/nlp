\section{Verification via Confined Boxes}
\label{sec:method}

Towards formally verifying recourse over an entire region, we formulate a \emph{mixed-integer quadratically constrained program} (MIQCP) to solve the RVP. 

\paragraph{Characterizing Regions with Boxes}
We focus on a special case of the RVP that finds the largest confined \textit{box}. A box is a set defined by simple upper and lower bound constraints on each dimension. Let $U_j = \max_{x \in {\cal R}}x_j$, $L_j = \min_{x \in {\cal R}}x_j$ be the upper and lower bound for each feature $j$ in the region. Given an upper bound, $\mathbf{u} \in \mathbb{R}^d: \mathbf{u} \leq \mathbf{U}$, and lower bound, $\mathbf{l} \in \mathbb{R}^d: \mathbf{l} \geq \mathbf{L}$, a box $B_{\cal R}(\mathbf{u},\mathbf{l})$ is defined as
$
B_{\cal R}(\mathbf{u},\mathbf{l}) = \{\mathbf{x} \in {\cal R}: \mathbf{l} \leq x \leq \mathbf{u}\}
$.
We focus on boxes due their interpretability, which can help model developers understand the source of fixed predictions. Boxes can be viewed as a type of \emph{decision rule}, which have been widely studied for their interpretability within the broader ML community (e.g., \cite{lawless2023interpretable, lawless2022interpretable, lawless2023cluster}). For ease of notation we drop the explicit dependence on ${\cal R}$ and refer to boxes as $B(\mathbf{u}, \mathbf{l})$. We define the size of a box $B(\mathbf{u},\mathbf{l})$ as the sum of the normalized ranges of each feature:%
\vspace{-0.5em}
\begin{equation} \label{def:boxsize}
\text{Size}(B(\mathbf{u}, \mathbf{l})) = \sum_{j=1}^d \frac{u_j - l_j}{U_j - L_j}
\end{equation}

\paragraph{Generating Confined Boxes}
We start by formulating the related problem of auditing whether a given box $B(\mathbf{u}, \mathbf{l})$ in region ${\cal R}$ contains any data points with recourse, which we denote the \emph{Region Recourse Existence Problem (REP)}. Let $\mathbf{x} \in \mathbb{R}^{d-q} \times \mathbb{Z}^q$ be a decision variable representing an individual, and $\mathbf{a} \in \mathbb{R}^{d-q} \times \mathbb{Z}^q$ represent an action. We assume that the region ${\cal R}$, feature space ${\cal X}$, and action set ${\cal A}$ can be represented by a set of constraints over a mixed-integer set (see \cref{fig:summary} for an example). This general assumption encompasses a variety of potential regions and feature sets. We model the REP as a mixed-integer linear program (MILP) over $\mathbf{x}$ and $\mathbf{a}$ (see Appendix \ref{app:rep_form} for details). 

Recall that the RVP can be cast as an optimization problem to find the largest confined region within ${\cal R}$. By definition the REP is infeasible for \emph{every confined box}. To certify that the REP is infeasible for a given box, and by extension certify that the box is confined, we leverage a classical result from linear optimization called Farkas' lemma: 

\begin{theorem}[\citet{farkas}]\normalfont
Let $A \in \mathbb{R}^{m \times n}$ and $b \in \mathbb{R}^m$. Then exactly one of the following two assertions is true:
\begin{enumerate}[label={\Roman*.},leftmargin=*,itemsep=0.1em]
    \item There exists $x \in \mathbb{R}^n$ such that $Ax \leq b$
    \item There exists $y \geq 0$ such that $A^T y = 0$ and $b^\top y = -1$
\end{enumerate}
\end{theorem}

Farkas' lemma states that we can certify that a system of inequalities over continuous variables $Ax \leq b$ is infeasible by finding a \emph{Farkas certificate} $y \geq 0$ such that $A^\top y = 0$ and $b^\top y = -1$. In our context, we can thus view the problem of finding a confined box as a joint problem of selecting a box and finding an associated Farkas certificate for the REP. However, Farkas' lemma only applies to \emph{continuous} variables, and the REP can include discrete variables.

We extend Farkas' certificates to the discrete setting using a simple strategy that simultaneously generates certificates for all possible continuous restrictions of the REP. A \emph{continuous restriction} of a MILP is a restricted version of the optimization problem where all discrete variables are fixed to specific values. Note that a box is confined if and only if every continuous restriction of the REP is infeasible.

Let  ${\cal C}$ be the set of continuous restrictions, where each restriction $c \in {\cal C}$ corresponds to a specific set of fixed values for the discrete variables (e.g., $x_1 = 1, x_2 = 2$ for a problem with two discrete variables $x_1, x_2 \in \mathbb{Z}^2$). Note that the set ${\cal C}$ is finite, from the assumption ${\cal R}$ is bounded and only discrete variables are fixed, but grows exponentially with respect to the number of discrete variables. If there are no discrete variables in the REP, there is a single continuous restriction representing the full problem with no fixed values. In settings where there are a large number of discrete variables, enumerating all possible continuous restrictions may become computationally intractable. However, we prove in \cref{sec:scaling} that under very general constraints and minimal assumptions we can relax many if not all of the discrete variables in the REP. Under these new theoretical results, the set of restrictions that the algorithm must consider is often incredibly small (e.g., $|{\cal C}| \leq 4$ for all the datasets and actionability constraints considered in \citet{kothari2023prediction}). 

We formulate a continuous restriction $c \in {\cal C}$ of the REP as a linear program (LP) (see Appendix \ref{app:rep_form}), which we represent in the following standard form:
\begin{align*}
C_c\mathbf{x} + D_c\mathbf{a} \leq b_c(\mathbf{u}, \mathbf{l})
\end{align*}
where where $C_c$ and $D_c$ are $m \times d$ matrices and $b_c(u,l)$ is a $m$-dimensional vector that is a linear function of the box upper and lower bounds $\mathbf{u}, \mathbf{l}$. Here $m$ represents the number of constraints in the continuous restriction of the REP.

\paragraph{MIQCP Formulation} We can now formulate the RVP as MIQCP that finds the largest box with Farkas certificates of infeasibility for every continuous restriction. Let $\mathbf{y}_c \in \mathbb{R}^{m}$ be decision variables representing the Farkas certificate for a continuous restriction $c \in {\cal C}$, and $\mathbf{u}, \mathbf{l} \in \mathbb{Z}^d$ represent the upper and lower bounds of a box. Note that there is one variable in $\mathbf{y}$ for every constraint in the continuous restriction. We can now find the largest confined box $B(\mathbf{u}, \mathbf{l})$ with associated certificates of infeasibility $y_c$ for $c \in {\cal C}$ using the \emph{Farkas Certificate Problem (FCP)}:
\begin{subequations}
\allowdisplaybreaks
\begin{align}
	\maximize_{\mathbf{y}_c, \mathbf{u}, \mathbf{l}}\quad&& \sum_d \frac{u_d - l_d}{U_d - L_d} \label{obj:f_size}\\[.1cm]
	\st\quad&& b_c(\mathbf{u}, \mathbf{l})^\top \mathbf{y}_c &= -1 ~~&& \forall c \in {\cal C} \label{const:f_neg_ray}\\
	&& C_c^\top \mathbf{y}_c &= 0 && \forall c \in {\cal C} \label{const:f_dual_feas_a} \\
	&& D_c^\top \mathbf{y}_c &= 0 && \forall c \in {\cal C}\label{const:f_dual_feas_b} \\
	&& \mathbf{y}_c &\geq 0 && \forall c \in {\cal C}\label{const:f_non_neg_y} \\
	&& \mathbf{L} \leq \mathbf{l} \leq \mathbf{u} &\leq \mathbf{U} && \label{const:f_box_bounds} \\
	&& \mathbf{u}, \mathbf{l} &\in \mathbb{Z}^d \label{const:f_ul_int}
\end{align}
\end{subequations}
The objective of the problem is to maximize the size of the box, as defined in Equation \eqref{def:boxsize}. Constraints \eqref{const:f_neg_ray}-\eqref{const:f_non_neg_y} follow from Farkas' lemma and ensure that $y_c$ is a valid certificate of infeasibility for the continuous restriction $c$ of the REP. Constraint \eqref{const:f_box_bounds} ensures the FCP generates a valid box within the region ${\cal R}$. We restrict $\mathbf{u}, \mathbf{l}$ to be integer variables to prevent numerical precision issues when solving this MIQCP in practice. This is not an onerous assumption as any continuous variable $x_j$ with a desired precision $10^{-p}$ can be re-scaled and rounded to an integer variable $10^p x_j$. The problem is quadratically constrained due to the inner product of $b_c(\mathbf{u},\mathbf{l})$ and $\mathbf{y}_c$ in constraint \eqref{const:f_neg_ray}. While MIQCPs are often more computationally demanding than MILPs, the FCP can be solved in seconds on real-world datasets using commercial solvers~\citep[e.g.,][]{achterberg2019gurobi}, as the problem scales with the number of features and actionability constraints (which are typically small) rather than the number of data points in the data set. 

When verifying recourse over a \emph{fixed} box $B(\mathbf{u}, \mathbf{l})$ the FCP can be decomposed into $|{\cal C}|$ problems (solved independently for each continuous restriction). If the FCP is infeasible for any continuous restriction $c$, then the RVP is infeasible for the box. If the FCP is feasible for all continuous restrictions $c \in {\cal C}$, then the box is responsive. Alas, when optimizing over potential boxes, the FCP cannot be decomposed as the variables $\mathbf{u}, \mathbf{l}$ link all the continuous restrictions. 

\paragraph{Generating Multiple Boxes} Solving an instance of the FCP generates a single confined box or certifies that the region is responsive. However, in practice, a given region may contain multiple confined regions. To provide model developers and stakeholders with a comprehensive view of individuals with fixed predictions, the FCP can be run sequentially to enumerate multiple (or all) confined boxes with the region. It does so by iteratively adding \emph{no-good cuts} to exclude previously discovered confined regions from ${\cal R}$ (see \cref{app:multi_boxes} for details).

\subsection{Handling Discrete Variables} \label{sec:scaling}
\begin{table*}[t]
    \centering
    \resizebox{\linewidth}{!}{
    \input{tables/linear_recourse_constraints}
    }
    \caption{Linear Recourse Constraints Classes. Variables $v_j$ used in the constraints may represent $x$ variables (i.e., constrain the region), $a$ variables (i.e., constrain the actions), or $x + a$ (i.e., constrain the resulting feature vector). This restricted set of constraints encompasses a broad set of existing actionability constraints considered in previous literature.} \label{tab:linear_recourse_const}
\end{table*}

In the preceding section, the RVP was solved by enumerating and finding Farkas' certificates for all continuous restrictions of the REP. However, this approach scales exponentially with respect to the number of discrete variables in the REP. In this section, we show that under a very broad set of actionability constraints and general assumptions we can relax all the discrete variables in the REP and still verify recourse over the entire region.

\paragraph{Linear Recourse Constraints} 
We consider a restricted set of constraints, which we call \emph{linear recourse constraints} (detailed in \cref{tab:linear_recourse_const}). These constraints include a broad class of actionability constraints such as monotonicity, categorical encodings, and immutability. They can be used to define the feature space ${\cal X}$, the region ${\cal R}$, or the action set $A$. Linear recourse constraints encompass many actionability constraints considered in previous literature including all the constraints in \citep{ustun2019actionable, russell2019efficient,kothari2023prediction}. We denote an action set comprised only of these constraints as \textit{linear recourse constraints}. %These constraints can act on either $x$ variables (i.e., constrain the region), $a$ variables (i.e., constrain the actions), or $x + a$ (i.e., constrain the resulting feature vector). Let $v_j$ represent a set of variables corresponding to feature $j$ (i.e., $x_j, a_j$, or $x_j+a_j$). 

%and all but 2 of the 100+ constraints used in the experiments of \citet{}. 
%
% \begin{assumption}[A1, Informal\label{a1:onehot}] 
% All variables participate in at most one $K$-hot constraint.
% \end{assumption}

% \begin{assumption}[A2, Informal\label{a2:directional_linkage}] 
% The set of directional linkage constraints do not imply any relationships between variables participating in $K$-hot constraints.
% \end{assumption}
%
\paragraph{Key Result} 

\cref{thm:tum} shows that we can recover the solution to the REP by solving a \emph{linear relaxation} if:
%
\begin{enumerate}[label={A.\arabic*}, itemsep=0pt]
\item 
% All variables participate in at most one $K$-hot constraint.\label{a1:onehot} 
No variable appears in more than one $K$-hot constraint.\label{a1:onehot} 
\item The directional linkage constraints do not enforce relationships between variables appearing in $K$-hot constraints.\label{a2:directional_linkage}
\item The directional linkage constraints do not imply any circular relationships between variables. \label{a3:cycles}
\end{enumerate}
%
%of the REP (i.e., the problem with only \emph{continuous variables}) is equivalent to solving the original REP. 
Practically, \cref{thm:tum} shows we can solve the FCP with a single continuous restriction (i.e., $|{\cal C}| = 1$),
relaxing all discrete variables in the problem.
%
\begin{theorem}\label{thm:tum}
Under Assumptions \ref{a1:onehot}- \ref{a3:cycles}, the linear relaxation of the REP is feasible iff the REP is feasible for any problem with linear recourse constraints.
\end{theorem}
%
For a full proof and formal definitions of the assumptions, see \cref{app:tum_pf}. The assumptions for \cref{thm:tum} are general and hold in many realistic settings. For instance, $K$-hot constraints are often used to encode categorical features (e.g., via a one-hot encoding). Assumption \ref{a1:onehot} holds in this setting as each associated variable only corresponds to one encoding (i.e., one $K$-hot constraint). Similarly, Assumption \ref{a2:directional_linkage} holds as long as there are no logical implications between the categorical features. Finally, Assumption \ref{a3:cycles} holds as long as there are no circular implications between variables. Circular implications between variables represent flaws in constructing the action set and should be caught prior to solving the RVP.

%Assumption \ref{a1:onehot} holds if $K$-hot constraints are used to encode categorical features, as each feature is only represented in one encoding (i.e., one $K$-hot constraint). Assumption \ref{a2:directional_linkage} holds as long as there are not logical implications between categorical variables encoded using $K$-hot constraints. 
%\textit{Proof Sketch.} We prove this result by showing that the polyhedron defining feasible $x$ and actions $a$ under linear recourse constraints is \emph{totally unimodular}, which means that all extreme points of the polyhedron are integral. 
%Consequently, the linear relaxation of the REP is feasible 
%if and only the discrete REP is feasible. For a full proof and formal definitions of the assumptions, see \cref{app:tum_pf}.

\cref{thm:tum} holds under linear recourse constraints
% which encompass a broad class of potential actionability constraints, 
but not under more general constraints. 
In \cref{app:relax_disc} we discuss how to extend our approach to general constraints, and provide practical guidelines on how to select continuous restrictions to include in the FCP.
