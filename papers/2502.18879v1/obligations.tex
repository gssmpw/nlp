\section{Proof Obligations for the Case Studies}
\label{ap:proof-obligations}
The proof obligations generated by our tool for each case study are shown in Figure~\ref{fig:targets-sisyphean-train}, Figure~\ref{fig:targets-crossing-the-river}, Figure~\ref{fig:targets-revisiting-ACAS-X-0}, and Figure~\ref{fig:targets-revisiting-ACAS-X}. Note that the proof obligations for the \emph{Sisyphean Train} case study and the \emph{Versatile Train} case study are the same, so we only consider the first one. Our tool automatically outputs these obligations in KeYmaera X's input language, allowing them to be directly imported for automatic or interactive proving.

All obligations are proved and all formal proofs can be found in this paper's accompanying artifact. Checking all of them using KeYmaera X currently takes about 2 minutes on a laptop. Among these 32 proof obligations, 27 can be discharged automatically or with trivial human guidance (such as providing a single term for instantiating an existential variable), while others need non-trivial guidance (marked as red).

\input{problems/sisyphean_train.tex}
\input{problems/crossing_the_river.tex}
\input{problems/revisiting_ACAS_X.tex}

\clearpage

\section{Informal Proof of the Invariant for the \emph{Sisyphean Train} Case Study}\label{ap:train-invariant-proof}
We provide an informal proof of the invariant of our train shield example from Figure~\ref{fig:overview-train-local}. We use the same notation as Figure~\ref{fig:targets-sisyphean-train}. Furthermore, we denote
{\small\[Q \equiv x + vT + (A + F)T^2/2 + \bdist{v+(A+F)T}{B - \min(F, \, y + k(vT + (A + F)T^2/2) + k \cdot \bdist{v + (A+F)T}{B-F})} \le e\]} and so we have $\Ctrl \equiv (y \dlassign \min(y, \TrainFxMax) \seq (((?Q \seq a \dlassign A) \cup (a \dlassign -B)))$. We want to prove that \[\vDash \ \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \limply [\Ctrl \seq \Plant] \Inv.\] Such a proof can be split into an \emph{acceleration case}: \[\vDash \ \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \limply [y \dlassign \min(y, \TrainFxMax) \seq a:=-B \seq \Plant] \Inv\] and a \emph{braking case}: \[\vDash \ \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \limply [y \dlassign \min(y, \TrainFxMax) \seq ?Q \seq a:=A \seq \Plant] \Inv\] Note that being in the domain constraint of the ODE, $v \ge 0$, it is trivially preserved and we focus on establishing the preservation of $y \ge f(x)$ and $x + \bdist{v}{B - \min(F, y + k \cdot \bdist{v}{B-F})} \le e$.

\subsection{Proof of the \emph{Braking Case}}
We denote $\alpha \,\equiv\, (y \dlassign \min(y, \TrainFxMax) \seq a:=-B \seq \Plant)$, and we proceed in four steps:
\begin{enumerate}
    \item $\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \limply [\alpha] (y \ge f(x))$;
    \item $\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \, \land \, y = y_0 \, \land \, v = v_0 \limply [\alpha] (y + k \cdot \bdist{v}{B-F} \le y_0 + k \cdot \bdist{v_0}{B-F})$;
    \item $\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \, \land \, y = y_0 \, \land \, v = v_0 \limply [\alpha] (x + \bdist{v}{B - \min(F, y_0 + k \cdot \bdist{v_0}{B-F})} \le e)$;
    \item $\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \limply [\alpha] (x + \bdist{v}{B - \min(F, y + k \cdot \bdist{v}{B-F})} \le e)$.
\end{enumerate}

\paragraph{Step 1} Before the execution of $\alpha$, we know that $y \ge f(x)$ and $\TrainFxMax \ge f(x)$. After the execution of $y \dlassign \min(y, \TrainFxMax)$, we still have $y \ge f(x)$. To prove that it is also preserved by the ODE, we simply use the \emph{differential invariant} rule (dI) from $\dL$\footnote{The dI rule from $\dL$ allows proving that an inequality is preserved by an ODE if its \emph{derivative} has the right sign throughout: \[
\frac{\vdash [X' \dlassign G(x)](A)' \ge (B)'}{A \ge B \vdash [X'=G(X) \, \& \, P] \, A \ge B}.
\]}. Thus, we must prove $y' \ge (f(x))'$:
\begin{itemize}
    \item[-] It is enough to prove: $k v \ge x' \times f'(x)$.
    \item[-] It is enough to prove: $k v \ge v \times f'(x)$.
    \item[-] Since $v \ge 0$, it is enough to prove that $k \ge f'(x)$, which holds since $f$ is $k$-Lipschitz.
\end{itemize}

\paragraph{Step 2} We also use dI and prove that $(y + k \cdot \bdist{v}{B-F})' \le 0$.
\begin{itemize}
    \item[-] It is enough to prove: $k v + (k v v') / (B - F) \le 0$.
    \item[-] It is enough to prove: $k v (1 + (v')/(B-F)) \le 0$.
    \item[-] It is enough to prove: $v' \le -(B-F)$.
    \item[-] It is enough to prove that $-B + f(x) \le -(B-F)$, which holds since $f$ is $F$-bounded.
\end{itemize}

\paragraph{Step 3} We also use dI and prove that $(x + \bdist{v}{B - \min(F, y_0 + k \cdot \bdist{v_0}{B-F})})' \le e$:
\begin{itemize}
    \item[-] It is enough to prove: $v' \le -B + \min(F, y_0 + k \cdot \bdist{v_0}{B-F})$.
    \item[-] It is enough to prove: $-B + f(x) \le -B + \min(F, y_0 + k \cdot \bdist{v_0}{B-F})$.
    \item[-] It is enough to prove: $f(x) \le \min(F, y_0 + k \cdot \bdist{v_0}{B-F})$.
    \item[-] It is enough to prove: $\min(F, y) \le \min(F, y_0 + k \cdot \bdist{v_0}{B-F})$, which is a consequence of step 2 since $k \cdot \bdist{v}{B-F} \ge 0$.
\end{itemize}

\paragraph{Step 4} The target is equivalent to: \[\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \, \land \, y = y_0 \, \land \, v = v_0 \limply [\alpha] (x + \bdist{v}{B - \min(F, y + k \cdot \bdist{v}{B-F})} \le e).\]
\begin{itemize}
    \item[-] It is enough to prove: $x + \bdist{v}{B - \min(F, y + k \cdot \bdist{v}{B-F})} \le x + \bdist{v}{B - \min(F, y_0 + k \cdot \bdist{v_0}{B-F})}$, because of step 3.
    \item[-] It is enough to prove: $B - \min(F, y + k \cdot \bdist{v}{B-F}) \ge B - \min(F, y_0 + k \cdot \bdist{v_0}{B-F})$.
    \item[-] It is enough to prove: $y + k \cdot \bdist{v}{B-F} \le y_0 + k \cdot \bdist{v_0}{B-F}$, which is true because of step 2.
\end{itemize}

\subsection{Proof of the \emph{Acceleration Case}}
We denote $\alpha \equiv (y \dlassign \min(y, \TrainFxMax) \seq ?Q \seq a:=A \seq \Plant)$, and we proceed in four steps:
\begin{enumerate}
    \item $\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \limply [\alpha] (y \ge f(x))$;
    \item $\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \, \land \, y = y_0 \, \land \, v = v_0 \limply [\alpha] (y + k \cdot \bdist{v}{B-F} \ge y_0 + k \cdot \bdist{v_0}{B-F})$;
    \item $\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \, \land \, v = v_0 \, \land \, y = y_0 \, \land \, v = v_0 \limply [\alpha] (v \le v_0+(A+F)t' \, \land \, x \le x_0+v_0t+((A+F)t^2)/2 \, \land \, y \le y_0+k(v_0t+((A+F)t^2)/2))$;
    \item $\Fvalid \Init \, \land \, f(x) \le \TrainFxMax \, \land \, \Inv \, \land \, Q \limply [\alpha] (x + \bdist{v}{B - \min(F, y + k \cdot \bdist{v}{B-F})} \le e)$.
\end{enumerate}

\paragraph{Step 1} Before the execution of $\alpha$, we know that $y \ge f(x)$ and $\TrainFxMax \ge f(x)$. After the execution of $y \dlassign \min(y, \TrainFxMax)$, we still have $y \ge f(x)$. To prove that it is also preserved by the ODE, we simply use dI (differential invariant). We must prove $y' \ge (f(x))'$.
\begin{itemize}
    \item[-] It is enough to prove: $k v \ge x' \times f'(x)$.
    \item[-] It is enough to prove: $k v \ge v \times f'(x)$.
    \item[-] Since $v \ge 0$, it is enough to prove that $k \ge f'(x)$, which holds since $f$ is $k$-Lipschitz.
\end{itemize}

\paragraph{Step 2} We also use dI and prove that $(y + k \cdot \bdist{v}{B-F})' \ge 0$.
\begin{itemize}
    \item[-] It is enough to prove: $k v + (k v v') / (B - F) \ge 0$.
    \item[-] It is enough to prove: $k v (1 + (v')/(B-F)) \ge 0$.
    \item[-] It is enough to prove: $v' \ge -(B-F)$.
    \item[-] It is enough to prove: $A + f(x) \ge -(B-F)$, which holds since $A+f(x) \ge 0 \ge -(B-F)$.
\end{itemize}

\paragraph{Step 3} We also use dI.
\begin{itemize}
    \item[-] For $v \le v_0+(A+F)t$, it is enough to prove that $v' \le A+F$, or $A + f(x) \le A+F$, which holds since $f$ is $F$-bounded.
    \item[-] For $x \le x_0+v_0t+((A+F)t^2)/2$, it is enough to prove that $x' \le v_0+(A+F)t$, or $v \le v_0 +(A+F)t$, which is already proved.
    \item[-] It is enough to prove: $v' \ge -(B-F)$.
    \item[-] Similarly, we can prove that $y \le y_0+k(v_0t+((A+F)t^2)/2)$.
\end{itemize}

\paragraph{Step 4} From step 3, we have upper bounds for $x$, $y$, and $v$. By montonicity, it is enough to prove $\Fvalid \Inv \, \land \, v \ge 0 \, \land \, v=v_0 \, \land \, x=x_0 \, \land \, y=y_0 \limply [\alpha] (x_0 + v_0T + (A + F)T^2/2 + \bdist{v_0+(A+F)T}{B - \min(F, \, y_0 + k(v_0T + (A + F)T^2/2) + k \cdot \bdist{v_0 + (A+F)T}{B-F})} \le e)$. This holds by definition of $?Q$.
