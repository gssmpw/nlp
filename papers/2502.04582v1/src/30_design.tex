The Mini Wheelbot needs to be small, rigid, and powerful for learning experiments.
In this section, we summarize the custom design of hardware and electronics that is necessary to achieve these design goals and meet the specifications listed in Tab.~\ref{tab:robot_specs}.
\begin{table}[hbt]
    \caption{Specifications of the Mini Wheelbot.}
    \centering
    \begin{tabular}{|l|l|}
    \hline
    \textbf{Spec.} & \textbf{Value} \\
    \hline
    \hline
    Dims. & \SI{130}{\milli\meter} (height) x \SI{87}{\milli\meter} (width) \\
    \hline
    Weight & Total \SI{0.69}{\kilo\gram}, wheels \SI{0.13}{\kilo\gram} (each), body \SI{0.43}{\kilo\gram} \\
    \hline
    Motors & T-Motor MN4006, max.~\num{8000}~rpm, \SI{0.5}{\newton\meter} \\
    \hline
    Battery & \SI{450}{\milli\ampere\hour}, \SI{22.2}{\volt}, 6S LiPo, max. cont. \SI{20}{\ampere} discharge  \\
    \hline
    Runtime & \SI{45}{\minute} when balancing\\
    \hline
    CPU & Pi CM4, BCM2711 quad-core Cortex-A72, \SI{1.5}{\giga\hertz} \\
    \hline
    Sensors & 4x Bosch BMI088 IMU, 2x AMS AS5047D 14bit encoder\\
    \hline
    System & RT-Preempt Linux, Buildroot \\
    \hline
    \end{tabular}
    \label{tab:robot_specs}
\end{table}

\subsection{Mechanical Design}

\begin{figure}[tb]
    \centering
    \input{figures/components/components.tex}
    \caption{System overview of the Mini Wheelbot.}
    \label{fig:packaging}
\end{figure}

The Mini Wheelbot is designed to be compact, rugged, and powerful.
Its size is determined by the onboard compute module (a Raspberry Pi CM4) and six battery cells.
Brass is chosen as material for the reaction wheels due to its high density and good availability at CNC job shops.
Sizing calculations of the reaction wheels were performed as described in~\cite{geist2022wheelbot} to maximize rotational inertia needed for the stand-up maneuvers.
The body is made from aluminum, which is lightweight, durable, and inexpensive to machine.
Inside the body, compute module, battery pack, and power electronics are packed tightly (see Fig.~\ref{fig:packaging}).
The packaging minimizes body mass and inertia for highly dynamic maneuvers like stand-up and flips while keeping symmetry.

\subsection{Electronics Design}
The custom electronics inside the Mini Wheelbot are designed to maximize the robots power and control performance while ensuring safety and battery runtime.
An overview of custom electronics is shown in Fig.~\ref{fig:electronicsschematic}.
Schematics for all components are available online\footnote{\label{footnote:code}\codelink}.

\begin{figure}[b]
    \centering
    \begin{subfigure}[b]{3.4in}
        \centering
        \input{figures/electronics/electronics.tex}
    \end{subfigure}
    \par\medskip %
    \begin{subfigure}[b]{3.4in}
        \centering
        \newcommand{\photoheight}{0.64in}
        \input{figures/electronics/photos/battery.tex}%
        \input{figures/electronics/photos/power_distribution.tex}%
        \input{figures/electronics/photos/compute_imu.tex}%
        \input{figures/electronics/photos/inverter.tex}%
    \end{subfigure}
    \caption{Electronics design of the Mini Wheelbot (top) and custom circuit boards (bottom).}
    \label{fig:electronicsschematic}
\end{figure}

The removable battery pack has six \SI{450}{\milli\ampere\hour} Lithium Polymer cells (three on each side of the robot) protected by two BQ77915 with overcurrent and short-circuit protection -- all safely potted in one housing (Fig.~\ref{fig:electronicsschematic}, bottom left).
The power distribution board monitores power consumption and engages a braking resistor in case recuperated current during stand-up maneuvers can not be charged back into battery or external power supply.
In addition, a~nRF24L01P communicates with a wireless emergency stop button to shut off motor controllers.
Two custom inverters based on the $\mu$Motor~\cite{lehmann2021micro} run field-oriented control (FOC) to drive T-Motor MN4006 brushless DC motors.
Current is measured low-side on all phases at FOC loop frequency of~\SI{40}{\kilo\hertz}.
Due to careful analog design and INA241A2 current sense amplifiers, the gains of the PI d-q-current controllers can be chosen as high as~\SI{10}{\kilo\hertz} bandwidth.
On-axis magnetic 14-bit AS5047 encoders are interfaced by the inverters via SPI with transfers triggered from an interrupt synchronized with the FOC loop.
The motors exhibit strong cogging with peaks of up to~\SI{20}{\milli\newton\meter} (\SI{4}{\percent} of the maximum torque).
This severely impacts balancing control.
We therefore implement cogging compensation with a lookup table of feedforward torques.
These are calibrated by sweeping through a full rotation in \num{4000} steps with a high-gain position controller and saving the average current to hold each position in flash memory on the inverter (cf.~\cite{piccoli2016anticogging} for details).
The compensation effectively reduces the cogging to less than~\SI{2.5}{\milli\newton\meter} (\SI{0.5}{\percent}).
Power distribution and inverters are commanded via CAN-FD with an MCP2517FD controller by the Raspberry Pi CM4 compute module at~\SI{1}{\kilo\hertz}.
Bosch BMI088 IMUs are directly interfaced via I2C from the CM4.

\subsection{Software}
The Mini Wheelbot runs a Buildroot Linux with real-time kernel.
The single-board computer performs all higher-level estimation and control, implemented in C++ and running inside a Docker container.
While sending CAN messages through Linux SocketCAN is almost latency free in this setup, there is significant delay (up to~\SI{10}{\milli\second}) between the kernel interrupt and receiving encoder values on the user-space socket.
This delay is due to the processing of received CAN messages by the same workers as all other networking and can be compensated in software by extrapolation.
IMUs readings are available through the Linux IIO subsystem.
