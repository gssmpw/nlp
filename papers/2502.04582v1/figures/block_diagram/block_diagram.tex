\tdplotsetmaincoords{60}{45} %
\begin{tikzpicture}[scale=1]
    
            
    \node [font={\Huge}] (USERINPUT) at (-1, 0) 
        {\textcolor{gray}{\faGamepad}};

    \draw[draw=black,fill=lightgray!20,thick, name=CTRL] (-0.2,0.85) rectangle ++(2.9,-1.8);

    \node[align=center, font={\small}] at (1.25,0.6){\textbf{Controller}};
    

    \node [rectangle, thick, draw, align=center, fill=white, text width=2.5cm, font={\small}] (LQR) at (1.25,0) 
    {Balancing};

    \node [rectangle, thick, draw, align=center, fill=white, text width=2.5cm, font={\small}] (NN) at (1.25,-0.6) 
    {Approximate MPC};
    
    \node [rectangle, thick, draw, align=center, fill=white, text width=2.5cm, font={\small}] (PC) at (1.25,-1.3) 
    {Stand-up};

    \node [rectangle, thick, draw, align=center, fill=white, text width=1.5cm, font={\small}] (UKF) at (1.25,-2) 
    {Estimator};

    \node [align=center, minimum height = 2cm, text width=1.5cm, font={\small}] (WB) at (4.5,-0.8) 
    {};

    \begin{scope}[
        every node/.style={rectangle, align=center, font={\scriptsize}},
        every edge/.style={thick, draw, line width = 0.25mm},
        every path/.style={thick, draw, line width = 0.25mm}
    ]
        \draw [->] (WB.west)++(-0.9,0) -- node [above right = 0cm, text width=0.5cm, shift={(-0.15,0)}]{$\tau_\text{D}$, $\tau_\text{R}$ } (WB.west);
        \draw [->] (PC.east) -- ++(0.5,0) |- (WB.west);
        \node [rectangle, thick, draw, align=center, fill=white, minimum height = 0.2cm, minimum width = 0.2cm] (OR) at (3.125,-0.8){};
        
        \draw [->] (4.5,0) -- (WB.225) |- node [above left, shift={(0,-0.05)}]{$a_\text{B,i}$, $\omega_\text{B,i}$}(UKF.10);
        \draw [->] (4.5,0) -- (WB.250) |- node [above left, shift={(0,-0.05)}]{$q_\text{D}$, $q_\text{R}$} (UKF.-10);
        \draw [->] (UKF.west) -| (-0.5,-0.6) -- node [above left]{$x$} (-0.2,-0.6);
        
        \draw [->] (USERINPUT) node [above=0.2cm]{$\dot{\psi}_\text{ref}$, $\dot{q}_{\text{D,ref}}$}
         -- (-0.2,0);
    \end{scope}

    \node [align=center, minimum height = 4cm, text width=4cm, font={\small}] (WB) at (4.5,-0.8) 
    {\includegraphics[width=1.5cm, trim={11cm 5cm 10.4cm 5cm}]{figures/block_diagram/rendering_assembly_color.pdf}};


    
            
    \definecolor{darkgray}{rgb}{0.4, 0.4, 0.4}
    \definecolor{lightred}{rgb}{0.8, 0.2, 0.2}
    \definecolor{lightgreen}{rgb}{0.2, 0.6, 0.2}
    \definecolor{lightblue}{rgb}{0.2, 0.4, 0.8}
    
    \tdplotsetrotatedcoords{0}{0}{0}
    \coordinate (Shift) at (4.5, -1.7, 0);
    \tdplotsetrotatedcoordsorigin{(Shift)}
    \begin{scope}[
        every node/.style={font={\scriptsize}},
        every path/.style={solid,thick, darkgray, tdplot_rotated_coords}
    ]
        \draw [lightred, -{Stealth[length=2mm]}] (0.05,0,0) -- (1, 0. ,  0) node[right] {$\mathcal{C}^\prime_\text{x}$};
        \draw [lightblue, -{Stealth[length=2mm]}] (0,0,2.1) -- (0, 0. ,  2.8) node[right] {$\mathcal{C}_\text{z}$};
    \end{scope}
    \begin{scope}[
        every node/.style={font={\scriptsize}},
        every path/.style={-{Stealth[length=0.8mm]}, darkgray, tdplot_rotated_coords}
    ]
        \tdplotdrawarc[tdplot_rotated_coords]{(0,0,2.3)}{0.15}{-20}{310}{anchor=west, shift={(0.15,0)}}{$\psi$}
    \end{scope}
    \tdplotsetthetaplanecoords{-90}
    \begin{scope}[
        every node/.style={font={\scriptsize}},
        every path/.style={-{Stealth[length=0.8mm]}, darkgray, tdplot_rotated_coords}
    ]
        \tdplotdrawarc[tdplot_rotated_coords]{(0,0,0.46)}{0.15}{-100}{225}{anchor=north east, shift={(0.15,-0.1)}}{$\phi$}
    \end{scope}

    
    \tdplotsetrotatedcoords{0}{0}{0}
    \coordinate (Shift) at (4.5, -1.26, 0);
    \tdplotsetrotatedcoordsorigin{(Shift)}
    \begin{scope}[
        every node/.style={font={\scriptsize}},
        every path/.style={solid,thick, darkgray, tdplot_rotated_coords}
    ]
        \draw [lightgreen, -{Stealth[length=2mm]}] (0,1.3,0) -- (0, 2.0 , 0) node[above] {$\mathcal{D}_\text{y}$};
    \end{scope}
    
    \tdplotsetthetaplanecoords{0}
    \begin{scope}[
        every node/.style={font={\scriptsize}},
        every path/.style={-{Stealth[length=0.8mm]}, darkgray, tdplot_rotated_coords}
    ]
        \tdplotdrawarc[tdplot_rotated_coords]{(0,0,1.5)}{0.15}{-100}{225}{anchor=north west, shift={(0,-0.15)}}{$\theta$}
    \end{scope}

    \begin{scope}[
        every node/.style={font={\scriptsize}},
        every path/.style={-{Stealth[length=0.8mm]}, darkgray, tdplot_rotated_coords}
    ]
        \tdplotdrawarc[tdplot_rotated_coords]{(0,0,0.15)}{0.5}{80}{120}{anchor=west, shift={(0,-0.1)}}{$q_\text{D}$}
    \end{scope}

    \tdplotsetrotatedcoords{0}{0}{0}
    \coordinate (Shift) at (4.5, -0.3, 0);
    \tdplotsetrotatedcoordsorigin{(Shift)}
    \tdplotsetthetaplanecoords{-90}
    \begin{scope}[
        every node/.style={font={\scriptsize}},
        every path/.style={-{Stealth[length=0.8mm]}, darkgray, tdplot_rotated_coords}
    ]
        \tdplotdrawarc[tdplot_rotated_coords]{(0,0,-0.1)}{0.5}{15}{70}{anchor=east, shift={(0,-0.1)}}{$q_\text{R}$}
    \end{scope}
    
\end{tikzpicture}
