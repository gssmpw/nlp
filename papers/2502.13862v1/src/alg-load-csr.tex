\begin{algorithm}[hbtp]
\caption{Convert per-thread Edgelists to CSR.}
\label{alg:load-csr}
\begin{algorithmic}[1]
\Require{$pcsr$: Per partition CSR (scratch)}
\Require{$pdegrees$: Per partition vertex degrees (scratch)}
\Require{$edges$: Per thread sources, targets, and weights of edges}
\Require{$counts$: Number of edges read per thread}
\Ensure{$symmetric$: Is graph symmetric?}
\Ensure{$weighted$: Is graph weighted?}
\Ensure{$\rho$: Number of partitions for counting vertex degrees}
\Ensure{$t$: Current thread}

\Statex

\Function{convertToCsr}{$pcsr, pdegrees, edges, counts$}
  \State $(\textit{poffsets}, pedgeKeys, pedgeValues) \gets pcsr$ \label{alg:csr--initialize-begin}
  \State $(sources, targets, weights) \gets edges$ \label{alg:csr--initialize-end}
  \State $\rhd$ Compute global degrees at $degrees[0]$
  \ForAll{$u \in [0, |V|)$ \textbf{in parallel}}
    \ForAll{$p \in [1, \rho)$} $degrees[0]\ \text{+=}\ degrees[p]$
    \EndFor
  \EndFor
  \State $\rhd$ Compute per-partition shifted offsets
  \ForAll{$p \in [0, \rho)$} \label{alg:csr--poffsets-begin}
    \State $M_p \gets exclusiveScan(\textit{poffsets}[p]+1, \textit{pdegrees}[p], |V|)$
    \If{$p = 0$} $M \gets M_p$
    \EndIf
  \EndFor \label{alg:csr--poffsets-end}
  \State $\rhd$ Populate per-partition CSR
  \ForAll{\textbf{threads in parallel}} \label{alg:csr--pcsr-begin}
    \State $p \gets t \bmod \rho$
    \ForAll{$i \in [0, counts[t])$}
      \State $u \gets sources[t][i]$
      \State $v \gets targets[t][i]$
      \State $j \gets atomicAdd(\textit{poffsets}[p][u+1], 1)$
      \State $pedgeKeys[p][j] \gets v$
      \If{$weighted$}
        \State $pedgeValues[p][j] \gets weights[t][i]$
      \EndIf
    \EndFor
  \EndFor \label{alg:csr--pcsr-end}
  \State $\rhd$ Combine per-partition CSR into one CSR
  \ForAll{$u \in [0, |V|)$ \textbf{in parallel}} \label{alg:csr--pcsr-combine-begin}
    \State $j \gets \textit{poffsets}[0][u+1]$
    \ForAll{$p \in [1, \rho)$}
      \State $i \gets \textit{poffsets}[p][u]$
      \State $I \gets \textit{poffsets}[p][u+1]$
      \ForAll{$i \in [i, I)$}
        \State $pedgeKeys[0][j] \gets pedgeKeys[p][i]$
        \If{$weighted$}
          \State $pedgeValues[0][j] \gets pedgeValues[p][i]$
        \EndIf
        \State $j \gets j + 1$
      \EndFor
    \EndFor
    \State $\textit{poffsets}[0][u+1] \gets j$
  \EndFor \label{alg:csr--pcsr-combine-end}
  \Return{$M$}
\EndFunction
\end{algorithmic}
\end{algorithm}
