\begin{algorithm}[hbtp]
\caption{Load a graph from an MTX format file as a CSR.}
\label{alg:load}
\begin{algorithmic}[1]
\Require{$data$: Input MTX data as string}
\Ensure{$G$: Output CSR graph}
\Ensure{$symmetric$: Is graph symmetric?}
\Ensure{$weighted$: Is graph weighted?}
\Ensure{$\rho$: Number of partitions for counting vertex degrees}
\Ensure{$t$: Current thread}

\Statex

\Function{loadGraph}{$data$}
  \State $G \gets \{\}$ \label{alg:load--init}
  \State $\rhd$ Read MTX format header
  \State $(symmetric, rows, cols, size, head) \gets readHeader(data)$ \label{alg:load--read-header}
  \State $data \gets removePrefix(data, head)$
  \State $\rhd$ Allocate space for CSR
  \State $N \gets max(rows, cols)$
  \State $M \gets 2 * size$ \textbf{if} $symmetric$ \textbf{else} $size$
  \State $G.resize(N, M)$ \label{alg:load--resize}
  \State $\rhd$ Allocate space for edges
  \State $sources \gets targets \gets weights \gets \{\}$ \label{alg:load--alloc-edges-begin}
  \ForAll{\textbf{threads in parallel}}
      \State $sources[t] \gets$ Allocate space for $M$ elements
      \State $targets[t] \gets$ Allocate space for $M$ elements
      \If{$weighted$}
          \State $weights[t] \gets$ Allocate space for $M$ elements
      \EndIf
  \EndFor \label{alg:load--alloc-edges-end}
  \State $edges \gets (sources, targets, weights)$ \label{alg:load--edges}
  \State $\rhd$ Allocate space for pdegrees, pcsr
  \State $pdegrees \gets \textit{poffsets} \gets pedgeKeys \gets \textit{pedgeValues} \gets \{\}$ \label{alg:load--alloc-pdegrees-pcsr-begin}
  \State $pdegrees[0] \gets G.degrees$
  \State $\textit{poffsets}[0] \gets G.offsets$
  \State $pedgeKeys[0] \gets G.edgeKeys$
  \If{$weighted$}
      \State $\textit{pedgeValues}[0] \gets G.edgeValues$
  \EndIf
  \State $fill(pdegrees[0], 0)$
  \ForAll{$p \in [1, \rho)$ \textbf{in parallel}}
      \State $pdegrees[p] \gets$ Allocate space for $N$ elements
      \State $\textit{poffsets}[p] \gets$ Allocate space for $N+1$ elements
      \State $pedgeKeys[p] \gets$ Allocate space for $M$ elements
      \If{$weighted$}
          \State $\textit{pedgeValues}[p] \gets$ Allocate space for $M$ elements
      \EndIf
      \State $fill(pdegrees[p], 0)$
  \EndFor \label{alg:load--alloc-pdegrees-pcsr-end}
  \State $pcsr \gets (\textit{poffsets}, pedgeKeys, \textit{pedgeValues})$
  \State $\rhd$ Read edge list and convert to CSR
  \State $counts \gets readEdgelist(pdegrees, edges, data)$ \label{alg:load--read-edgelist}
  \State $M \gets convertToCsr(pcsr, pdegrees, edges, counts)$ \label{alg:load--convert-to-csr}
  \State $\rhd$ Account for self-loops in symmetric graphs
  \If{$symmetric$} $G.resize(N, M)$ \label{alg:load--resize-symmetric}
  \EndIf
  \Return{$G$} \label{alg:load--return}
\EndFunction
\end{algorithmic}
\end{algorithm}
