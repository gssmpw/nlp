\begin{algorithm}[hbtp]
\caption{Our Directed Graph that uses CP2AA allocator.}
\label{alg:digraph1}
\begin{algorithmic}[1]
\Require{$T_K, T_W$: Datatype for vertex ID, edge weight}
\Require{$\textsc{pool\_size}_a$: Size of each memory pool (constant)}

\Statex

\State \textbf{struct} $DiGraph \langle T_K, T_W \rangle ()$ \label{alg:digraph--struct-begin}
\State \ \ $\textsc{bool\_bits} \gets 64$ \Comment{Boolean stored in 64-bit chunks}
\State \ \ $\textsc{edge\_size} \gets sizeof((T_K, T_W))$ \Comment{Size of an edge in bytes}
\State \ \ $exists \gets \{\}$ \Comment{Vertex existence flags}
\State \ \ $edges \gets \{\}$ \Comment{Outgoing edges for each vertex}
\State \ \ $degrees \gets \{\}$ \Comment{Out-degree of each vertex}
\State \ \ $capacities \gets \{\}$ \Comment{Edge capacity of each vertex}
\State \ \ $cp2aa \gets CP2AA \langle \textsc{pool\_size}_a \rangle ()$ \Comment{Memory allocator}
\State \ \ $CAP \gets 0$ \Comment{Vertex capacity (max vertex id + 1)}
\State \ \ $RES \gets 0$ \Comment{Memory reserved for vertices}
\State \ \ $N \gets 0$ \Comment{Total number of vertices}
\State \ \ $M \gets 0$ \Comment{Total number of edges} \label{alg:digraph--struct-end}

\Statex

\State $\rhd$ Check if a vertex exists in the graph
\Function{hasVertex}{$u$} \textbf{of} DiGraph \label{alg:digraph--has-vertex-begin}
  \Return{$u < CAP$ \textbf{and} $getBit(exists, u)$}
\EndFunction \label{alg:digraph--has-vertex-end}

\Statex

\State $\rhd$ Get the number of outgoing edges of a vertex
\Function{degree}{$u$} \textbf{of} DiGraph \label{alg:digraph--degree-begin}
  \Return{$u < CAP$? $degrees[u]$ : $0$}
\EndFunction \label{alg:digraph--degree-end}

\Statex

\State $\rhd$ Get the outgoing edges of a vertex
\Function{edges}{$u$} \textbf{of} DiGraph \label{alg:digraph--edges-begin}
  \Return{$u < CAP$? $edges[u][0 \dots degrees[u]]$ : \{\}}
\EndFunction \label{alg:digraph--edges-end}

\Statex

\State $\rhd$ Reserve space for a number of vertices
\Function{reserve}{$n$} \textbf{of} DiGraph \label{alg:digraph--reserve-begin}
  \State $n \gets max(n, CAP)$
  \State $\rhd$ Compute new reserved size (round up to page size)
  \State $res \gets \lceil n / \textsc{page\_size} \rceil * \textsc{page\_size}$
  \If{$n \leq CAP$ \textbf{and} $res = RES$} \ReturnInline{}
  \EndIf
  \State $\rhd$ Allocate new memory
  \State $B \gets \textsc{bool\_bits}$
  \State $exists \gets reallocate(exists, \lceil \frac{CAP}{B} \rceil, \lceil \frac{RES}{B} \rceil, \lceil \frac{n}{B} \rceil, \lceil \frac{res}{B} \rceil)$
  \State $edges \gets reallocate(edges, CAP, RES, n, res)$
  \State $degrees \gets reallocate(degrees, CAP, RES, n, res)$
  \State $capacities \gets reallocate(capacities, CAP, RES, n, res)$
  \State $\rhd$ Update vertex capacity and reserved size
  \State $CAP \gets n$ \textbf{;} $RES \gets res$
\EndFunction \label{alg:digraph--reserve-end}

\Statex

\State $\rhd$ Reallocate memory of specified size and reserved amount
\Function{reallocate}{$ptr, N_0, R_0, N_1, R_1$} \label{alg:digraph--reallocate-begin}
  \If{$R_1 = R_0$} \Comment{Desired reserved amount = old?}
    \ForAll{$i \in [N_0, N_1)$ \textbf{in parallel}} $ptr[i] \gets 0$
    \EndFor
    \Return{$ptr$}
  \EndIf
  \State $tmp \gets$ Allocate memory for $R_1$ entries
  \State $M \gets min(N_0, N_1)$
  \ForAll{$i \in [0, M)$ \textbf{in parallel}} $tmp[i] \gets ptr[i]$
  \EndFor
  \ForAll{$i \in [M, N_1)$ \textbf{in parallel}} $tmp[i] \gets 0$
  \EndFor
  \State Free memory at $ptr$
  \Return{$tmp$}
\EndFunction \label{alg:digraph--reallocate-end}
\algstore{alg:digraph12}
\end{algorithmic}
\end{algorithm}
