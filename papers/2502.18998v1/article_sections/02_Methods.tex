\label{sec:methods}

\subsection{Vapor-liquid equilibria}

% Background on vapor-liquid equilibria calculation
Vapor-liquid equilibria (VLE) is reached when the fugacity of each component $i$ in the liquid phase $L$ and the vapor phase $V$ are equal

\begin{equation}
    f_i^L = f_i^V
    \label{eq_equal_fugacities_vle}
\end{equation}

Two main approaches exist for calculating Equation \ref{eq_equal_fugacities_vle}. The first approach utilizes fugacity coefficients, $\varphi_i$, for both phases, typically derived from an equation of state and, in the case of mixtures, a set of mixing rules. The second approach employs the fugacity coefficient for the vapor phase, along with the activity coefficient, $\gamma_i$, and a standard fugacity, $f_i^0$, for the liquid phase. The standard fugacity is calculated from the fugacity coefficient of the pure liquid at saturation conditions, $\varphi^s_i$, the saturation pressure, $P^s_i$, and the Poynting factor, $\text{Poy}_i$. Therefore, by using the second approach, the VLE of mixture components can be calculated as

\begin{equation}
    x_i \gamma_i \varphi_i^s P_i^s \text{Poy}_i = y_i \varphi_i^V P
    \label{eq_vle_general}
\end{equation}

\noindent where, $x_i$ and $y_i$ refer to the liquid and vapor molar fractions, respectively, and $P$ stands for the system's pressure \cite{gmehling2019chemical}. 

At low or moderate pressures, the $\text{Poy}_i$ is typically close to unity, and for non-associating systems, the values of $\varphi_i^s$ and $\varphi_i^V$ are very similar. Therefore, for many practical applications, it is sufficient to approximate Equation \ref{eq_vle_general} with the following expression:

\begin{equation}
    x_i \gamma_i  P_i^s  \approx y_i P
    \label{eq_vle_extended_raoults_law}
\end{equation}

In this work, Equation \ref{eq_vle_extended_raoults_law} was used to estimate the VLE behavior of components in binary and ternary mixtures of small non-ionic compounds. 

We leverage the previously published GH-GNN model \cite{medina2023gibbs} for predicting infinite dilution activity coefficients (IDACs) and use the extended Margules model to extrapolate the predictions from the infinite dilution regime to finite concentrations. An early analysis of this approach was studied by \citet{medina2023solvent} in the context of solvent pre-selection for extractive distillation, but a rigorous analysis of the approach for predicting binary and ternary VLEs was not there presented. 

\subsection{Extended Margules model}

Different mathematical models have been developed to calculate the molar excess Gibbs energy, $g^E$, of a mixture. Since the concept of $g^E$ is constructed from the idea of modeling a correction to the ideal solution model, any valid $g^E$ model should just satisfy the following limiting condition:

\begin{equation}
    g_i^E \rightarrow 0, \quad \text{as} \quad x_i \rightarrow 0
    \label{eq_boundary_condition}
\end{equation}

One of the simplest approaches to this is to assume that $g^E$ is a continuous and sufficiently smooth function, which can be approximated by an n-th order Taylor series expansion. This approximation results in what is known as the extended Margules model \cite{mukhopadhyay1993discussion}.
A detail derivation is provided in the \ref{app1}.

For a binary mixture, the extended Margules model estimates $g^E$ as:

\begin{equation}
    g^E = x_i x_j (x_i w_{ji} + x_j w_{ij})
    \label{eq_ge_binary_final}
\end{equation}

\noindent where, $w_{ji} = \ln{\gamma_{ji}^\infty}$ and $w_{ij} = \ln{\gamma_{ij}^\infty}$. The activity coefficients at finite concentrations can be then calculated as:

\begin{align}
    \ln{\gamma_i} =& 2 w_{ji} x_i x_j + x_j^2 w_{ij} - 2 g^E \\
    \ln{\gamma_j} =& 2 w_{ij} x_j x_i + x_i^2 w_{ji} - 2 g^E
\end{align}

Similar expressions can be obtained for a ternary mixture, which are outline in the \ref{app1}.

\subsection{Data sources}

In this study, we utilized the open-source GH-GNN model \cite{medina2023gibbs}, trained on experimental IDAC data compiled in Volume IX of the DECHEMA Data Chemistry Series \cite{dechema}. Additionally, experimental binary VLE data sourced from the Korean Data Bank \cite{koreandatabank} was incorporated into our analysis. Both isobaric and isothermal VLE measurements were employed. Since Equation \ref{eq_vle_extended_raoults_law} was used to model the VLE behavior, only systems operating at low to medium pressure levels (i.e., $\leq 500$ kPa) were considered.

The CAS-RN and vapor pressure correlation coefficients of the pure compounds were also obtained from the Korean Data Bank \cite{koreandatabank}. The vapor pressure correlation is defined as:

\begin{equation}
    \ln{P_i^s} = A_i \ln{(T)} + \frac{B_i}{T} + C_i + D_i T^2
    \label{eq_vapor_pressure_kdb}
\end{equation}

\noindent where the pressure $P_i^s$ is expressed in kPa and the temperature $T$ in K. Mixtures containing compounds lacking vapor pressure correlation coefficients ($A_i$, $B_i$, $C_i$ and $D_i$), as well as systems with temperatures outside the correlationâ€™s valid range, were excluded from the analysis.

Additionally, 10 subsets of VLE data for ternary mixtures were collected from the literature. Table \ref{tbl:ternary_systems} describes the specifics of each subset. While limited, the inclusion of ternary VLE systems in the present analysis revels the relative performance of the graph neural networks embedded into the Margules model for multi-component systems. These mixtures include a variety of chemical classes, including aromatics, paraffinic hydrocarbons, nitriles, ketones, alcohols, as well as halogenated and sulfur-containing compounds. In total, 539 data points of ternary mixtures were analyzed.


\begin{table}[h]
\centering
  \caption{Ternary vapor-liquid equilibria data from literature analyzed in this work.}
  \label{tbl:ternary_systems}
  \small
  \begin{tabular*}{1\textwidth}{@{\extracolsep{\fill}}lccccl}
    \hline
    \textbf{Mixture (Component 1/2/3)} & \textbf{\# points} & \textbf{Condition} & \textbf{Ref.} \\
    \hline
    Acetone/Chloroform/Methanol          & 71  & 101.325 kPa  & \cite{hiak1994vapor} \\
    Hexane/Benzene/Sulpholane            & 14  & 101.325 kPa  & \cite{rawat1980isobaric} \\
    Benzene/Heptane/Dimethylformamide    & 50  & 101.325 kPa  & \cite{blanco2000vapor} \\
    Benzene/Heptane/Acetonitrile         & 12  & 101.325 kPa  & \cite{tripathi1975isobaric} \\
    Acetone/Chloroform/Benzene           & 53  & 101.325 kPa  & \cite{kojima1991isobaric} \\
    Benzene/Cyclohexane/Hexane           & 108 & 101.325 kPa  & \cite{ridgway1967physical} \\
    Acetone/Tetrachloromethane/Benzene   & 57  & 101.325 kPa  & \cite{subbarao1966isobaric} \\
    Ethanol/Benzene/Heptane              & 50  & 53.329 kPa   & \cite{nielsen1959vapor} \\
    Hexane/Methanol/Acetone              & 54  & 313.15 K     & \cite{oracz1995vapour} \\
    Chloroform/Methanol/Benzene          & 70  & 101.325 kPa  & \cite{kurihara1998vapor} \\
    \hline
  \end{tabular*}
\end{table}


\subsection{Data cleaning}

All pure components were encoded using SMILES strings retrieved either from the Korean Data Bank \cite{koreandatabank} directly or from PubChem \cite{pubchem} based on their corresponding CAS-RN. When isomeric information was available, isomeric SMILES were used; otherwise, canonical SMILES were employed. If a CAS-RN was not available from the Korean Data Bank \cite{koreandatabank}, SMILES strings were obtained using the OPSiN web tool \cite{opsin}. All data points with compounds for which the SMILES could not be determined were excluded. In total, the SMILES for 110 compounds could not be determined.

The VLE data underwent pre-processing to eliminate entries with decimal point misplacements or inaccurate composition values, such as those where the total molar fractions exceeded unity. In some cases the indexing of compounds with respect to the VLE data was reversed, this was also corrected. VLEs with suspected errors were excluded. All datasets were standardized to consistent units of measurement. Only measurements that provided both liquid and vapor molar fractions were included. Additionally, systems containing molecules with structural features not compatible with the molecular graph construction criteria used to train the GH-GNN \cite{medina2023gibbs} were excluded from the analysis.

The chemical classification of pure compounds from the Korean Data Bank was utilized in this work to evaluate the performance of the proposed framework across different mixture classes. Additionally, following the usage recommendations of the GH-GNN model \cite{medina2023gibbs}, only systems containing compounds with a Tanimoto similarity metric greater than 0.4 were considered. The specifics of this metric are detailed in the original publication \cite{medina2023gibbs} and are intended to control the expected prediction error of the GH-GNN model when applied to systems outside of its training domain.

The resulting VLE dataset of binary mixtures comprises 27,610 data points, involving 235 distinct compounds across 945 unique binary combinations. In total, 781 subsets are isobaric, 903 are isothermal, and an additional 51 subsets were collected under varying conditions. The dataset spans pressures from 0.01 to 499.50 kPa and temperatures ranging from 127.59 to 576.93 K.
 
\subsubsection{Gibbs-Helmholtz Graph Neural Network (GH-GNN)}

The GH-GNN model \cite{medina2023gibbs} represents molecules as graphs following the framework of \citet{battaglia2018relational}, incorporating node-, edge-, and global-level features. These vectorized features encode specific molecular information: atoms are described at the node level, chemical bonds at the edge level, and properties such as polarity and polarizability at the global level. This model is tailored to predict IDACs of small non-ionic compounds. However, extensions of this model have been investigated to handle polymer solutions \cite{sanchez2023gibbs}, ionic liquids \cite{medina2024systematic} and deep eutectic solvents \cite{morales2024graph}.

Graphs representing solutes and solvents are processed using a molecular-level graph neural network (GNN). This GNN updates the graph information in three sequential steps. 

First, the edge features between each pair of nodes $v$ and $w$ are updated according to:

\begin{equation}
\label{eqn:edge_update}
\mathbf{b}_{v,w}^{(l+1)} = \phi_b^{(l)}
\left(
\mathbf{a}_{v}^{(l)} \parallel \mathbf{a}_{w}^{(l)} \parallel \mathbf{b}_{v,w}^{(l)} \parallel \mathbf{u}^{(l)}
\right)
\end{equation}

\noindent where $\mathbf{b}_{v,w}^{(l+1)}$ is the updated edge feature vector, $\mathbf{a}_v^{(l)}$ and $\mathbf{a}_w^{(l)}$ are the feature vectors of nodes $v$ and $w$, respectively, $\mathbf{u}^{(l)}$ represents the global feature vector. The symbol $\parallel$ represents concatenation.

Second, after updating all edges in the graph, the node features are updated according to Equation \ref{eqn:node_update}.

\begin{equation}
   \widehat{\mathbf{b}}_{v}^{(l)} = \sum_{w \in \mathcal{N}(v)} \mathbf{b}_{v,w}^{(l+1)}
\end{equation}

\begin{equation}
\label{eqn:node_update}
   \mathbf{a}_v^{(l+1)} = \phi_a^{(l)}  
   \left( 
        \mathbf{a}_{v}^{(l)} \parallel \widehat{\mathbf{b}}_{v}^{(l)} \parallel \mathbf{u}^{(l)}
   \right)
\end{equation}

\noindent where $\widehat{\mathbf{b}}_{v}^{(l)}$ stands for the aggregated edge information of all edges connecting node $v$ to its neighbors $w \in \mathcal{N}(v)$.

Third, the global feature vector $\mathbf{u}$ is updated according to:

\begin{equation}
   \widetilde{\mathbf{a}}^{(l)} = \frac{1}{n_a} \sum_{v \in \mathcal{V}} \mathbf{a}_v^{(l+1)}
\end{equation}

\begin{equation}
   \widetilde{\mathbf{b}}^{(l)} = \frac{1}{n_b} \sum_{e \in \mathcal{E}} \mathbf{b}_{e}^{(l+1)}
\end{equation}

\begin{equation}
\label{eqn:global_update}
   \mathbf{u}^{(l+1)} = \phi_u^{(l)}  
   \left( 
        \mathbf{u}^{(l)} \parallel \widetilde{\mathbf{a}}^{(l)} \parallel \widetilde{\mathbf{b}}^{(l)}
   \right)
\end{equation}

\noindent where $\widetilde{\mathbf{a}}^{(l)}$ and $\widetilde{\mathbf{b}}^{(l)}$ represent the average node and edge embeddings, respectively. The sets $\mathcal{V}$ and $\mathcal{E}$ stand for the sets of nodes and edges in the graph, and $n_a$ and $n_b$ represent the cardinality of such sets, respectively.

The update functions for the edges $\phi_b^{(l)}$, nodes $\phi_a^{(l)}$ and global features $\phi_u^{(l)}$ are all implemented as single hidden-layer neural networks with the ReLU activation function.

After performing 2 sequential message passing transformations (described by Equations \ref{eqn:edge_update} to \ref{eqn:global_update}), the final graphs are pooled into vector embeddings. These embeddings are then combined to form a new graph representing the mixture, where nodes correspond to chemical species and edges denote hydrogen-bonding interactions. This mixture graph is subsequently passed through a second, mixture-level GNN, and the output is pooled into a vector representing the mixture. This vector embedding is finally used to estimate temperature-independent parameters in an expression derived from the Gibbs-Helmholtz equation, enabling the prediction of IDACs.

In this work, the GH-GNN model is embedded into the extended Margules model. This combination allows the GH-GNN to predict the parameters of the extended Margules model, corresponding to the respective binary IDACs, which are then used to calculate finite concentration activity coefficients. By embedding the GH-GNN into the Margules framework, we ensure that the predictions remain Gibbs-Duhem consistent. In the following sections, we analyze the performance of this combined model in predicting vapor-liquid equilibria and compare its results with those of the widely used UNIFAC-Dortmund \cite{constantinescu2016further} model.




