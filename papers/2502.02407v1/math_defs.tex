\usepackage{nicematrix}

\newcommand{\mb}{\mathbf}
\newcommand{\m}[1]{{\boldsymbol{\mathbf{#1}}}}

\newcommand{\underbraceColored}[3]{%
    \textcolor{#1}{\underbrace{\textcolor{black}{#2}}_{\textcolor{black}{#3}}}
}


\newcommand{\highlight}[1]{\textcolor{red}{#1}}
\newcommand{\highlightMeasure}[1]{\textcolor{teal}{#1}}

\newcommand{\hal}{{\textcolor{red}{\alpha}}}
\newcommand{\halSup}[1]{{\textcolor{red}{\alpha^{#1}}}}
\newcommand{\halb}{{\pmb{\hal}}}

\newcommand{\dotpr}[2]{{\langle #1,\,  #2\rangle\, }}

\newcommand{\wM}[1]{\mb W^{(#1)}}
\newcommand{\wMt}[1]{\mb W^{(#1)^\top}}
\newcommand{\ww}[2]{w_{#1}^{(#2)}}
\newcommand{\delxavg}{\overline{\delta x}}
\newcommand{\wMasupp}{\mb V}
\newcommand{\wMbsupp}{\mb W}
\newcommand{\wMa}{\mb W^{1}}
\newcommand{\wMb}{\mb W^{2}}
\newcommand{\wMsub}[1]{\mb W_{(#1)}}
\newcommand{\wMTsub}[1]{\mb W_{(#1)^\top}}
\newcommand{\wMsup}[1]{\mb W^{(#1)}} %
\newcommand{\wMTsup}[1]{\mb W^{(#1)^\top}} %

\newcommand{\bias}[1]{\mb b^{#1}}

\newcommand{\qtil}{\widehat{q}}
\newcommand{\W}{\mathbf W}
\newcommand{\w}{\mathbf w}
\newcommand{\btheta}{{\pmb \theta}}
\newcommand{\bTheta}{{\pmb \Theta}}
\newcommand{\bpsi}{{\pmb \psi}}
\newcommand{\bdel}{{\mb \delta}}
\newcommand{\bDel}{{\mb \Delta}}
\newcommand{\beps}{{\pmb \epsilon}}
\newcommand{\V}{\mathbf V}
\newcommand{\I}{\mathbf 1} 
\renewcommand{\v}{\mathbf v}
\renewcommand{\a}{\mathbf a}
\renewcommand{\b}{\mathbf b}
\newcommand{\x}{\mathbf x}
\newcommand{\y}{\mathbf y}
\newcommand{\z}{\mathbf z}
\newcommand{\funcsym}{\mathrm{F}}
\newcommand{\outersym}{\mathrm{O}}
\newcommand{\ggnsym}{\mathrm{G}}

\newcommand{\Fn}{\funcsym_{\btheta}}
\newcommand{\Fni}[1]{\funcsym_{\btheta_{#1}}}
\newcommand{\Loss}{{\mathcal{L}}}
\newcommand{\prLoss}{{\mathcal{L}_{\text{principal}}}}
\newcommand{\Reg}{{\mathcal{R}}}
\newcommand{\Om}{{\mb{\Omega}}}
\newcommand{\effparams}{\frac{\textrm{rank}}{\textrm{\#\,params}}}

\newcommand{\covx}{{\bm{\Sigma}_{\x \x}}}
\newcommand{\covyx}{{\bm{\Sigma}_{\y \x}}}
\newcommand{\covxy}{{\bm{\Sigma}_{\x \y}}}
\newcommand{\covyy}{{\bm{\Sigma}_{\y \y}}}

\newcommand{\samplecovx}{{\widehat{\bm{\Sigma}}_{\x \x}}}
\newcommand{\samplecovxy}{{\widehat{\bm{\Sigma}}_{\x \y}}}

\newcommand{\up}[1]{^{(#1)}}
\newcommand{\E}{\mathbf E \,}
\newcommand{\jacobi}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\hessian}[3]{\frac{\partial^2 #1}{\partial #2 \partial #3}}
\renewcommand{\Re}{\mathbb R}

\newcommand{\tens}[1]{\mathcal{#1}}
\newcommand{\conv}[2]{{\tens{#1}}^{(#2)}}
\newcommand{\convfibre}[3]{{\tens{#1}^{(#2)}_{(#3)\,\bullet}}}
\newcommand{\convMat}[1]{{\Wm}_{(3)}^{(#1)}}
\makeatletter








\newtheorem{faact}[theorem]{Fact}

\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator{\ricci}{Ricci}
\DeclareMathOperator{\trace}{tr}
\DeclareMathOperator{\normtrace}{\overline{\trace}}
\DeclareMathOperator{\range}{img}
\DeclareMathOperator{\rank}{rk}
\DeclareMathOperator{\rankdef}{rank-deficiency}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\softmax}{softmax}
\DeclareMathOperator{\vect}{vec}
\DeclareMathOperator{\mat}{mat}
\DeclareMathOperator{\blockd}{bdiag}
\DeclareMathOperator{\evals}{evals}
\newcommand{\Fmap}[1]{F^{#1}}
\newcommand{\Fmapt}[1]{F^{{#1}^\top}}
\newcommand{\Jmap}[1]{\mb J^{#1}}
\newcommand{\Smap}[1]{\pmb \Sigma^{#1}}
\newcommand{\Lmap}[1]{\pmb \Lambda^{#1}}

\newcommand{\cov}[2]{\text{Cov}\left[#1, #2\right]}
\newcommand*\diff{\mathop{}\!\mathrm{d}}
\newcommand{\dw}{\nabla_{\w}}
\newcommand{\fhat}{\hat{f}}
\newcommand{\tf}{\tilde{f}}
\newcommand{\Jhat}{\hat{J}}
\newcommand{\sign}{\text{sign}}
\newcommand{\sqnorm}[1]{\left\|#1\right\|^2} 
\newcommand{\tr}{\text{tr}}
\newcommand{\vectornorm}[1]{\left\|#1\right\|}
\newcommand{\norm}[1]{{}\left\| #1 \right\|}
% \newcommand{\tildetilde}[1]{\tilde{\raisebox{0pt}[0.85\height]{$\tilde{#1}$}}}
\newcommand{\HG}{\mb{H}_{\ggnsym}}
\newcommand{\HO}{\mb{H}_{\outersym}}
\newcommand{\HF}{{\mb{H}_{\funcsym}}}
\newcommand{\HOtilde}{{\tilde{\mb{H}_{\outersym}}}}
\newcommand{\HFhat}{{\widehat{\mb{H}}_{\funcsym}}}
\newcommand{\HFone}{{\mb{H}_{f_1}}}
\newcommand{\HFcol}[1]{{\mb{H}_{f}^{\bullet #1}}}
\newcommand{\HL}{{\mb{H}_{\Loss}}}
\newcommand{\HOsup}[1]{{\mb{H}^{#1}_{\outersym}}} %
\newcommand{\HFsup}[1]{{\mb{H}_{\funcsym}^{#1}}} %
\newcommand{\HFhatsup}[1]{{\widehat{\mb{H}}_{\funcsym}^{#1}}} %
\newcommand{\HLhatSup}[1]{{\widehat{\mb{H}}_{\Loss}^{#1}}}
\newcommand{\HLtildeSup}[1]{{\widetilde{\mb{H}}_{\Loss}^{#1}}}

\newcommand{\HLsup}[1]{{\mb{H}_{\Loss}^{#1}}} %
\newcommand{\Hone}[1]{{\mb{H}^{#1}_{1}}}
\newcommand{\Htwo}[1]{{\mb{H}^{#1}_{2}}}


\newcommand{\HOS}[1]{\mb{H}_{o}^{#1}}
\newcommand{\HFS}[1]{{\mb{H}_{f}^{#1}}}

\newcommand{\HLS}{{\mb{H}^S_{\mathcal{L}}}}

\newcommand{\p}{\bm p}
\newcommand{\D}{{\mathcal{D}}}
\newcommand{\est}{\widehat{\btheta}}

\newcommand{\ellbold}{\boldsymbol\ell}
\newcommand{\fbold}{{\boldsymbol{f}}}
\newcommand{\lamin}{\lambda_{\text{min}}} %
\newcommand{\lamax}{\lambda_{\text{max}}} 
\newcommand{\init}{\btheta^0}
\newcommand{\minrisk}{\sigma^2_{\text{min}}} %
\newcommand{\maxrisk}{\sigma^2_{\text{max}}} %


\newcommand{\irc}{{\overline{\delta x}}}
\newcommand{\ircd}[1]{{\overline{\delta x_{#1}}}}
\newcommand{\xavg}{{\mu}}
\newcommand{\xstd}{{\sigma}}
\newcommand{\xvar}{{\sigma^2}}


\newcommand*{\colorboxed}{}
\def\colorboxed#1#{%
	\colorboxedAux{#1}%
}
\newcommand*{\colorboxedAux}[3]{%
	\begingroup
	\colorlet{cb@saved}{.}%
	\color#1{#2}%
	\boxed{%
		\color{cb@saved}%
		#3%
	}%
	\endgroup
}

\newcommand{\coupabs}[1]{{\kappa_{\text{abs}}(#1)}}
\newcommand{\couprow}[1]{{\kappa_{\text{row}}(#1)}}
\newcommand{\coupneur}[1]{{\kappa_{\text{neur}}(#1)}}

\newcommand{\gf}[1]{{\nabla_{#1} f}}
\newcommand{\opt}{{\btheta^\star}}

\DeclareMathOperator{\reshape}{reshape}
\DeclareMathOperator{\toep}{toep}

\newcommand{\Real}{{\mathbb{R}}} %
\newcommand{\Reals}[1]{{\mathbb{R}^{#1}}} %
\newcommand{\matcol}[2]{{#1}_{\bullet\, #2}}
\newcommand{\matrow}[2]{{#1}_{#2 \, \bullet}}

\newcommand{\toepMat}[1]{{\Tm}^{#1}}
\newcommand{\tmat}[1]{{\Tm}^{(#1)}}
\newcommand{\qmat}[1]{{\Qm}^{(#1)}}
\newcommand{\wmat}[1]{{\Wm}^{(#1)}}
\newcommand{\wmatt}[1]{{\Wm}^{(#1)}{}^\top}
\newcommand{\tmatt}[1]{{\Tm}^{(#1)}{}^\top}
\newcommand{\qmatt}[1]{{\Qm}^{(#1)}{}^\top}

\newcommand{\vmat}[1]{{{\Vm}^{(#1)}}}
\newcommand{\vmatt}[1]{{\Vm}^{(#1)}{}^\top}

\newcommand{\tildeqmat}[1]{{{\widetilde{\Qm}}^{(#1)}}}
\newcommand{\tildeqmatt}[1]{{\widetilde{\Qm}}^{(#1)}{}^\top}

\newcommand{\tildeqmattop}[1]{\mbox{${\widetilde{\Qm}}^{(#1)}$}^\top}


\newcommand{\qtilmat}[1]{\widetilde{\Qm}^{(#1)}}
\newcommand{\toepSupRow}[2]{{\Tm}^{{#1}_{#2\, \bullet}}}
\newcommand{\toepSupCol}[2]{{\Tm}^{{#1}_{\bullet\, #2}}}

\newcommand{\idx}{k}
\newcommand{\vb}{{\mb v}}
\newcommand{\ub}{{\mb u}}
\newcommand{\xb}{{\mb x}}
\newcommand{\e}{{\mb e}}
\newcommand{\ab}{{\mb a}}
\newcommand{\bb}{{\mb b}}
\newcommand{\pb}{{\mb p}}

\newcommand{\Sig}{\bm{\Sigma}}
\newcommand{\kro}{%
  \mathbin{\mathop{\otimes}}%
}

\usepackage[scr=false]{rsfso}%without false compilation issue
\newcommand{\inpspace}{{\mathbb{X}}}
\newcommand{\outspace}{{\mathbb{Y}}}


\def\Am{{\bf A}}
\def\Bm{{\bf B}}
\def\Cm{{\bf C}}
\def\Dm{{\bf D}}
\def\Gm{{\bf G}}
\def\Hm{{\bf H}}
\def\Im{{\bf I}}
\def\Km{{\bf K}}
\def\Mm{{\bf M}}
\def\Nm{{\bf N}}
\def\Pm{{\bf P}}
\def\Qm{{\bf Q}}
\def\Rm{{\bf R}}
\def\Tm{{\bf T}}
\def\Wm{{\bf W}}
\def\Vm{{\bf V}}
\def\Um{{\bf U}}
\def\Zm{{\bf Z}}
\def\Ym{{\bf Y}}
\def\Xm{{\bf X}}
\usepackage{xcolor}%
\usepackage{ifmtarg}%
\usepackage{xifthen}%
\usepackage{environ}%
\usepackage{multido}%
\usepackage{lipsum}%
\usepackage{mdframed}
\usepackage{xspace}


\definecolor{colorFunc}{RGB}{200,104,16}

\definecolor{colorLogit}{RGB}{31,119,180}

\definecolor{coral}{HTML}{FF7F50}
\definecolor{peach}{HTML}{CC5500}
\definecolor{NavyBlue}{RGB}{0, 0, 128}
\definecolor{CrimsonRed}{RGB}{220, 20, 60}
\definecolor{ForestGreen}{RGB}{34, 139, 34}
\definecolor{Gold}{RGB}{204, 172, 0}
\definecolor{PaleRed}{rgb}{0.95, 0.3, 0.3}
\definecolor{MPLOrange}{rgb}{1.0, 0.6470588235294118, 0.0}
\definecolor{MPLGreen}{rgb}{0.0, 0.5019607843137255, 0.0}
\definecolor{ForestGreen}{RGB}{34,139,34}
\definecolor{OliveGreen}{RGB}{107,142,35}
\definecolor{PurplePrint}{RGB}{117, 112, 179}
\definecolor{GreenPrint}{RGB}{27, 158, 119}
\definecolor{RedPrint}{RGB}{217, 95, 2}
\definecolor{VeryLightGray}{rgb}{0.9,0.9,0.9}
\definecolor{samColor}{RGB}{214,38,40}
\definecolor{adamwColor}{RGB}{61,200,215}


\newcommand{\fcolor}[1]{\textcolor{colorFunc}{#1}}
\newcommand{\lcolor}[1]{\textcolor{colorLogit}{#1}}
\newcommand{\spcolor}[1]{\textcolor{black}{#1}}

\newcommand{\SAM}{{\textcolor{black}{\textsc{SAM}}}\xspace}
\newcommand{\SAMnonbold}{{\textsc{SAM}}\xspace}
\newcommand{\SAMbold}{\textbf{\textsc{SAM}}\xspace}
\newcommand{\adamw}{{\textsc{AdamW}}\xspace}
\newcommand{\adamwnonbold}{{\textsc{AdamW}}\xspace}
\newcommand{\funcSAM}{{\textcolor{black}{\textsc{Functional-SAM}}}\xspace}
\newcommand{\funcSAMnonbold}{{\textsc{functional-SAM}}\xspace}
\newcommand{\funcSAMbrief}{{\textsc{Func-SAM}}\xspace}
\newcommand{\precondSAM}{{\textsc{preconditioned SAM}}\xspace}
\newcommand{\precondSAMbrief}{{\textsc{precond SAM}}\xspace}
\newcommand{\precondFuncSAMbrief}{\textbf{\textsc{precond-functional-SAM}}\xspace}
\newcommand{\funcSAMprecond}{\funcSAMbrief\,\precond}
\newcommand{\penaltySAM}{{\textsc{penalty-SAM}}\xspace}
\newcommand{\precond}{{\textsc{precond}}\xspace}
\newcommand{\logitSAM}{{\textsc{Logit-SAM}}\xspace}
\newcommand{\angleSAM}{{\textsc{Angle-SAM}}\xspace}





\newcommand*{\QEDB}{\null\nobreak\hfill\ensuremath{\square}}%
\newtheorem{fact}{Fact}

\usepackage{thmtools}
\usepackage{cleveref}


\newtheorem{assump}{Assumption}
\renewcommand\theassump{A\arabic{assump}}
\renewcommand\theremark{R\arabic{remark}}




\makeatletter
\newcommand{\neutralize}[1]{\expandafter\let\csname c@#1\endcsname\count@}
\makeatother


\newenvironment{assumpprime}[1]
  {\renewcommand{\theassump}{\ref{#1}$'$}%
   \addtocounter{assump}{-1}%
   \begin{assump}}
  {\end{assump}}
