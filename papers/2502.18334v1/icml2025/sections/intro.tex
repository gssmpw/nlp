


% Remove label shifts 
% Add example of TTA

% GNN suffers from domain shifts, in particular label shifts and the induced structure shifts



\begin{figure}[ht]  
    \centering  % Centers the image on the page
    \includegraphics[trim={0.6cm 0 0 0},clip, width=0.96\columnwidth]{icml2025/figures/Pileup_example.pdf} 
    \vspace{-2mm}
    \caption{Example of the distribution shifts of neighborhood information due to different experimental conditions in the LHC experiments.
    The goal of pileup mitigation is to detect LC neutral particles.
    The particles are modeled by kNN graphs (dashed circles in the figure) to use nearby particles for drawing inference.
    The model is trained on $\gG^\gS$ but needs to generalize to $\gG^{\gT_1}$ and $\gG^{\gT_2}$ over time. 
    The inferred nodes within the circles are the LC neutral particles, but their neighborhood node label ratio changes in $\gG^{\gT_1}$, $\gG^{\gT_2}$.
    In  $\gG^{\gT_1}$ the homophily ratio changes as one of the neighbor node is an LC neutral particle.
    % In $\gG^{\gT_3}$ the neighborhood node label ratio remains unchanged but the amount of neighboring node changes.
    % Real world distribution shifts in graph data typically present as a combination of these three cases.
    Both cases represent \emph{neighborhood shift} which this work aims to address.
    A more formal definition of these shifts is discussed in Sec. \ref{Sec:Test Error Analysis}.}
    %\shikun{will revise the plot}} 
    \label{fig:pileup_example}
    % Link for Pileup figure
    %https://drive.google.com/file/d/1m7N-_RqEChCZ-vo_qYoqkUVxR24-hdoG/view?usp=sharing

    % shikun drawio link https://app.diagrams.net/#G1qnY3a9sP0vJ37JYVrVi_6bd22wDj-fjG#%7B%22pageId%22%3A%22KIHKL_-jXcYF3asLFJqd%22%7D
    \vspace{-2mm}
\end{figure}





\section{Introduction}
\label{introduction}
Graph-based methods have become indispensable in handling structured data across a wide range of real-world applications \cite{duvenaud2015convolutional, bronstein2017geometric, zhang2019deep, stokes2020deep}, achieving significant success when training and testing data originate from similar distributions.
However, these methods struggle to generalize to test-time data in a different domain, where variations in time, location, or experimental conditions result in distinct graph connection patterns. 
Although some literature on graph domain adaptation (GDA)~\cite{wu2020unsupervised,you2023graph,zhu2021shift,liu2023structural} seeks to bridge these gaps by aligning labeled source distributions with target distributions, such approaches are often infeasible in practice due to the cost of retraining and the limited availability of source data in the test time.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure*}[t]
\centering

\includegraphics[trim={0.4cm 0 0 0},clip, width=0.95\textwidth]{icml2025/figures/tsa_notta.pdf}
\vspace{-2mm}
\caption{TSA utilizes neighborhood alignment and SNR-inspired adjustment to mitigate neighborhood information discrepancy. It further adjusts the decision boundary to get refined predictions $\hat{y}$. The refined soft pseudo-labels are used to estimate parameter $\mgamma$ for neighborhood alignment and to optimize $\alpha$ for combining self representations with neighborhood aggregated representations. %The pseudo codes are presented in Algorithm \ref{alg:example}.
% https://drive.google.com/file/d/1zDMWqsX2Lwd77fAItY363V0mJtAD5Wag/view?usp=sharing
}
\label{fig:tsa}
\vspace{-2mm}
\end{figure*}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Real-world applications may operate under constraints such as lightweight computation, limited storage, and strict privacy requirements, which make reprocessing of source data generally infeasible~\cite{wang2021gnnadvisor, wu2021fedgnn}.
For example, in particle tracking based on graph learning at the Large Hadron Collider (LHC)~\cite{shlomi2020graph, highfield2008large,miao2024locality}, the connections between particles differ as experimental conditions change over time. The tracker is expected to be capable of adapting on-the-fly 
\cite{li2023semi, komiske2017pileup}.
Similarly, in fraud detection for financial networks~ \cite{clements2020sequential, wang2021review}, privacy-sensitive training data may not be accessed during testing, while transaction patterns may change between different regions
~\cite{wang2019semi, dou2020enhancing}.
These scenarios indicate the need for graph test-time domain adaptation (GTTA), which enables models to adjust to new test domains without re-accessing the source domain or incurring the overhead of full retraining.

Accurate node classification in graph-structured data relies heavily on effectively leveraging neighborhood information. Graph neural networks (GNNs) \cite{kipf2016semi, velivckovic2017graph, hamilton2017inductive, hamilton2020graph} have achieved significant success across a wide range of applications by utilizing this neighborhood context, yet they remain sensitive to distribution shifts in node neighborhoods \cite{gui2022good, ji2023drugood}. As shown in Fig.~\ref{fig:pileup_example}, shifts in LHC data can lead to distinct neighborhood connections among center particles in the same class (\emph{neighborhood shift}).
Existing methods for test-time adaptation (TTA) often focus on adjusting only the classifierâ€™s final layer \cite{iwasawa2021test}, modifying its outputs \cite{boudiaf2022parameter}, or adapting normalization statistics \cite{wang2020tent, niu2023towards}, primarily targeting image-based tasks with independently labeled data points. Consequently, they may not adequately address neighborhood shifts for node classification in graphs. While recent works on GTTA attempt to address the structural changes using graph augmentation \cite{jin2022empowering}, self-supervised learning \cite{mao2024source}. 
These approaches mainly rely on heuristics and homophily consistency, failing to fully address changes in neighboring node connections in principle.


In this work, we propose a model-agnostic framework with test-time structural alignment, named \proj, as illustrated in Fig.~\ref{fig:tsa}, and supported by theoretical analysis. We begin by examining the generalization gap in GTTA for a pretrained source model. Our theoretical findings, further validated by empirical studies on synthetic datasets, indicate the importance of aligning the label distributions of neighboring nodes among the same class of nodes across the source and target domains. In the context of training-time GDA, PairAlign \cite{liu2024pairwise} employs a neighborhood weighting strategy to recalibrate the influence of neighboring nodes during message aggregation for a similar alignment. However, extending this approach to GTTA necessitates our more nuanced investigation, leading to the following contributions:


Firstly, the weight assignment relies on knowledge of node labels, which are unavailable in the target graph under GTTA. Assigning weights based on pseudo labels may, in fact, degrade performance. To mitigate this, TSA introduces an uncertainty-aware assignment strategy that aligns only node pairs with more reliable test-time pseudo labels.

Additionally, \proj optimizes the test-time combination of self-node representations and neighborhood-aggregated representations based on their signal-to-noise ratio (SNR). For instance, when the target graph is sparse, \proj reduces reliance on neighborhood messages due to their high variance and low SNR. Conversely, as layer depth increases, it assigns greater weight to self-node representations, which become progressively denoised.

Lastly, \proj integrates non-graph TTA methods to refine the decision boundary, mitigating mismatches caused by additional label and feature shifts once neighborhood shift has been addressed.


We conduct extensive experiments on synthetic and four real-world datasets, including those from high-energy physics and citation networks, with multiple GNN backbones, to demonstrate the effectiveness of TSA.   
TSA outperforms non-graph TTA baselines by up to 12\% on synthetic datasets and surpasses all non-graph baselines. Compared to existing GTTA baselines, TSA achieves 
an average of 10\% improvement on all real-world datasets. %\proj also has the flexibility of being applied to We show the applicability of TSA under multiple GNN backbones

% \pan{how many backbones} \pan{compared with non-graph, we outperform them by xxx} \pan{compared with existing GTTA, we ourperform them by xxx}
% Across the cases, TSA consistently contributes to significant improvement. \pan{please use two sentences to specify them} % after integrating with non-graph TTAs. 
% %Additionally, TSA is model-agnostic and can be widely applied to xxx ? as it operates solely on edge weights \pan{should we say this}, 
% %and it is efficient to adapt since the improvement shown is achieved with just a single epoch update.



% In this work, we start by formally defining the components composing structure shift under test-time scenarios:
% \emph{label shift} where the node label portions differs ($\probs(Y_u)\neq\probt(Y_u)$),
% \emph{degree shift} where the node degrees within the same label differs ($\probs(D_u | Y_u)\neq\probt(D_u | Y_u)$), and 
% \emph{neighborhood shift} where the neighboring node label connections within the same class differs ($\probs(Y_v | Y_u)\neq\probt(Y_v | Y_u)$).
% We provide a theoretical analysis of the upper bound on the error gap between the source and target domains, showing how these three components can impact test error. 
% The analysis suggests principled alignment on the target graph can mitigate degree and neighborhood shift. 
% However, label shift cannot be addressed by aligning node labels, as the amount of nodes to be inferred in the target graph is fixed \pan{This sentence is unclear}.
% Combining with a toy experiment, we highlight label shift can only be addressed by adjusting the classifier itself \pan{perhaps, emphasizing too much about label shift. It reads that label shift is one fundamental component of this work. We should check if the later methodology matches this.}.
% To the best of our knowledge, we are the first work to study the effect of label shift on GTTA. \pan{We did not explain the insights how we can handle neighborhood shift, degree shift, and label shift.}




% Through the proposed theoretical justification and empirical investigation, we proposed a novel adaptation strategy, test-time structural alignment (TSA), which addresses the alignment of neighborhood information discrepancies \pan{duplication with above}.
% TSA utilizes bootstrapping on neighboring nodes to align aggregated neighborhood information with low uncertainty from the test domains to the source domains where GNNs were trained. \pan{For neighborhood shift, the writing should emphasize the difference compared to pairwise alignment}
% TSA further learns a scaling function on the aggregated neighborhood information to learn to understate noisy quality neighborhood representation entailed by degree shifts \pan{do we want to emphasize degree shifts, that much, I think the better way is to talk about SNR. In particular, if AdaRC mentioned degree shifts, we should avoid that.}.
% Once the degree and neighborhood shifts are addressed,  existing non-graph TTA methods can be integrated to further address label shifts \pan{how? unclear? do not much the emphasis of label shifts above}. 
% We conduct extensive experiments on synthetic datasets and real-world high energy physics and citation networks datasets to demonstrate the effectiveness of TSA.

% \shikun{may split into two paragraphs with more detailed discussion in experimental results and analysis}

% \shikun{here the paragraphs in intro are with main logic and structure, but the details and language still needs to be polished and modified. Also, we need to add the citations later on}