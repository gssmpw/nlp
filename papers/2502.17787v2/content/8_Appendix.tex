\clearpage
\appendix
\onecolumn


\section{Impact on Fundamental Capabilities}
\label{app: fundamental}

\begin{table}[h]
\centering
\renewcommand{\arraystretch}{1.0}
\resizebox{0.6\textwidth}{!}{
\begin{tabular}{c|ccccc|c}
\toprule
\textbf{Method} & \textbf{MMLU} & \textbf{CQA} & \textbf{NQ} & \textbf{HumanEval} & \textbf{GSM8K} & \textbf{AVG} \\
\midrule
\multicolumn{7}{l}{\textit{Results on Llama-3-8B-UltraChat}} \\
\midrule
Baseline & 64.00 & 72.97 & 29.61 & 30.49 & 57.47 & 50.90 \\
\midrule
AIR & 61.64 & \textbf{73.63} & \textbf{30.54} & 29.88 & 54.59 & 50.05 \\
\midrule
\multicolumn{7}{l}{\textit{Results on Qwen-2.5-7B-UltraChat}} \\
\midrule
Baseline & 73.64 & 82.39 & 25.68 & 52.20 & 81.65 & 63.11 \\
\midrule
AIR & 73.35 & \textbf{82.56} & \textbf{25.76} & \textbf{55.49} & \textbf{84.38} & \textbf{64.30} \\
\midrule
\multicolumn{7}{l}{\textit{Results on Llama-3-8B-Tulu}} \\
\midrule
Baseline & 65.43 & 79.44 & 32.22 & 50.61 & 64.14 & 58.36 \\
\midrule
AIR & 64.95 & \textbf{79.92} & \textbf{34.62} & \textbf{50.85} & 63.70 & \textbf{58.80} \\
\bottomrule
\end{tabular}}
\caption{Experiment results on fundamental capabilities.}
\label{table:fundamental}
\end{table}


Previous methods have shown LLMs may suffer from capability degradation during alignment~\cite{ouyang2022training}. To evaluate this concern, we tested our AIR method on MMLU \cite{hendrycks2021measuring}, CommonsenseQA (CQA) \cite{talmor-etal-2019-commonsenseqa}, Natural Questions (NQ) \cite{kwiatkowski2019natural}, HumanEval \cite{chen2021evaluatinglargelanguagemodels}, and GSM8K \cite{cobbe2021trainingverifierssolvemath}. In Table \ref{table:fundamental}, our method does not have a negative impact on fundamental capabilities. For Qwen-2.5-7B-UltraChat and Llama-3-8B-Tulu, our method even improves the average performance by 1.19 and 0.44 points, respectively. This indicates that instruction constructed from documents with evenly sampled distributions also present even distribution, which would not lead to catastrophic forgetting of fundamental capabilities.





\section{Case Study for Complete Pipeline }
\label{appendix:pipeline_case}

This section presents a detailed end-to-end demonstration of our pipeline in Figure \ref{figure:pipeline_case}. The case study provides a thorough walkthrough of each stage in our instruction generation and refinement process.


\begin{figure}[h]
\centering
\includegraphics[width=0.9\linewidth]{source/pipeline_demo.pdf}
\caption{End-to-End Pipeline Implementation Example.}
\label{figure:pipeline_case}
\end{figure}





\section{Constraint Type Taxonomy and Distribution Analysis}
\label{appendix:constraints_type}

This section provides a detailed classification of constraint types, as defined in Table \ref{table:constraint_types}. Additionally, we present a comprehensive analysis of constraint type distribution patterns observed across five iterative refinement rounds, as visualized in Figure \ref{figure:model_comparison}.

\begin{table}[h]
\centering
\renewcommand{\arraystretch}{0.95}
\resizebox{0.85\textwidth}{!}{
\begin{tabular}{>{\raggedright\arraybackslash}m{0.25\linewidth}m{0.65\linewidth}}
\toprule
\textbf{Constraint Type} & \textbf{Description} \\
\midrule
Data Format & The generated content should conform to specific data structure formats, such as JSON, Markdown, Table, CSV, etc. \\
\midrule
Document Structure & The generated content should follow specific document organization patterns, including Numbered lists (1, 2, 3 or I, II, III), Bullet points (â€¢, -, *), Custom templates with predefined sections, Tables, Headers, etc. \\
\midrule
Domain-Specific Format & Content must follow strict format rules for different industries \\
\midrule
Inclusion & Identify and list the specific elements or information that should be included in the generated content \\
\midrule
Exclusion & Identify and list the specific elements or information that should not be included in the generated content \\
\midrule
Citation & The generated content should include citations to sources, providing reliable sources and literature support; follow specific citation formats or reference styles \\
\midrule
Prior Condition & When a specific intention is met, a particular process should be followed to perform an operation or output specific content \\
\midrule
Target Audience & The generated content should target a specific audience, which affects the terminology used, the level of detail provided, and the complexity of the content \\
\midrule
Tone and Style & The generated content should adopt a specific tone and style, such as formal, polite, academic, concise, literary, romantic, or sci-fi \\
\midrule
Emotion & The generated content should express a specific emotion or mood, such as ensuring the content is positive, inspiring, or empathetic \\
\midrule
Linguistic Characteristics & Use specific linguistic features, such as metaphors, personification, and other rhetorical devices \\
\midrule
Multilingual & The generated content should be written in a specific language, such as English, Mandarin, or Spanish \\
\bottomrule
\end{tabular}}
\caption{Types of Constraints Used in Dataset Generation.}
\label{table:constraint_types}
\end{table}

% \begin{figure}[h]
% \centering
% \subfigure[Llama-3-8B-UltraChat distribution]{
%     \includegraphics[width=0.3\linewidth]{source/data_visualization/1.constraint_type_distribution_llama_ultrachat.pdf}
% }
% \subfigure[Qwen-2.5-7B-UltraChat distribution]{
%     \includegraphics[width=0.3\linewidth]{source/data_visualization/1.constraint_type_distribution_qwen_ultrachat.pdf}
% }
% \subfigure[Llama-3-8B-Tulu distribution]{
%     \includegraphics[width=0.3\linewidth]{source/data_visualization/1.constraint_type_distribution_llama_tulu.pdf}
% }
% \caption{Distribution of constraint types across all iterations.}
% \label{figure:model_comparison}
% \end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.9\linewidth]{source/data_visualization/constraint_type_distribution.pdf}
\caption{Distribution of constraint types across all iterations.}
\label{figure:model_comparison}
\end{figure}




\section{Model Training Hyper-parameters}
\label{appendix:hyper-parameters}

This section details our model training configuration based on the LlamaFactory \cite{zheng-etal-2024-llamafactory} framework. We employed Supervised Fine-Tuning (SFT) with hype-rparameters as outlined in Table \ref{table:hyperparams}.

\begin{table}[!h]
\centering
\resizebox{0.5\textwidth}{!}{
\begin{tabular}{l|cc}
\hline
\textbf{Configuration} & \textbf{Llama-3-8B}   & \textbf{Qwen-2.5-7B}   \\ \hline
max length             & 4096                  & 4096                   \\
learning rate          & 1e-5                  & 1e-5                   \\
scheduler              & cosine decay          & cosine decay           \\
training epochs        & 3                     & 3                      \\
batch size             & 64                    & 64                     \\
flash-attn             & fa2                   & fa2                  \\
numerical precision    & bf16                  & bf16                   \\
ZeRO optimizer         & stage 2               & stage 2                \\ \hline
\end{tabular}}
\caption{Hyper-parameters for Supervised Fine-Tuning.}
\label{table:hyperparams}
\end{table}



\section{Prompts for Initial Instruction Generation}
\label{appendix:prompt_iig}

This section presents the prompts used in our data generation pipeline in Initial Instruction Generation step. These prompts serve different purposes in our methodology, from initial instruction generation through back-translation (Figure \ref{figure:prompt_back_ins}) to document refining (Figure \ref{figure:prompt_document_polish}) and instruction scoring (Figure \ref{figure:prompt_ins_score}). 

\section{Prompts for Iterative Instruction Refinement}
\label{appendix:prompt_iir}

This section presents the prompts used in our data generation pipeline in Iterative Instruction Refinement step. These prompts serve different purposes in our methodology, from constraint generation (Figure \ref{figure:cons_generate}), constraint verification (Figure \ref{figure:cons_check}), and finally combines all elements into refined instructions (Figure \ref{figure:cons_combine}).


\section{Instruction Score Examples}
\label{appendix:ins_score_case}

This section presents a comprehensive analysis of instruction quality through representative examples. As illustrated in Figure \ref{figure:ins_score_case_show}, we provide a diverse set of instructions spanning the entire quality spectrum (scores 1-5). Each score category is exemplified by five carefully selected cases, where score 1 represents basic quality and score 5 demonstrates exceptional quality.



\begin{figure}[h]
\centering
\includegraphics[width=0.8\linewidth]{source/prompt/prompt_back_ins.pdf}
\caption{Prompt for generating initial instructions through back-translation.}
\label{figure:prompt_back_ins}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.8\linewidth]{source/prompt/prompt_document_polish.pdf}
\caption{Prompt for refining document content.}
\label{figure:prompt_document_polish}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.8\linewidth]{source/prompt/prompt_ins_score.pdf}
\caption{Prompt for scoring initial instructions.}
\label{figure:prompt_ins_score}
\end{figure}


\begin{figure}[h]
\centering
\includegraphics[width=0.8\linewidth]{source/prompt/cons_generate.pdf}
\caption{Prompt for generating constraints based on judge.}
\label{figure:cons_generate}
\end{figure}
\begin{figure}[h]
\centering
\includegraphics[width=0.8\linewidth]{source/prompt/cons_check.pdf}
\caption{Prompt for verifying model responses against constraints.}
\label{figure:cons_check}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.8\linewidth]{source/prompt/cons_combine.pdf}
\caption{Prompt for combining instructions with constraints.}
\label{figure:cons_combine}
\end{figure}





\begin{figure}[h]
\centering
\includegraphics[width=0.95\linewidth]{source/prompt/ins_score_case.pdf}
\caption{Examples of instructions at different score levels (1-5), where each score level is illustrated with five representative cases. Score 1 represents the lowest quality while score 5 represents the highest quality.}
\label{figure:ins_score_case_show}
\end{figure}




% \section{judge iterations analysis}
% \label{appendix:judge_iterations_analysis}

% (1) The most critical and fundamental constraints might have already been discovered in earlier iterations; (2) additional constraints begin to overlap with existing ones. 

