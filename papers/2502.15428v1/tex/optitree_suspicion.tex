\subsubsection{Suspicion Monitoring in Trees}
\label{sec:tree-suspicion}

The tree's more complex communication pattern requires adjusting how suspicions are raised.
\cref{tab:tree-suspicion} shows the adjusted conditions for raising suspicions in a tree configuration.
In a star configuration (\cref{sec:suspicion}), the leader suspects replicas that fail to reply in time~(a).
In a tree, internal nodes suspect their children if they do not respond in time \tcond{a}.
However, the root's timeout must also be adjusted to account for the time it takes the intermediate node to collect votes from its children \tcond{a'}.

Similarly, in a star configuration, replicas suspect the leader upon a view timeout (b).
In a tree configuration, we use the score of the configuration $\score(\q+\un,\tree)$ as timeout, adjusted by $\delta$. 
But only intermediate nodes directly suspect the root upon a view timeout \tcond{b}.
However, if faulty intermediate nodes prevent the root from collecting enough votes to advance the view, the root instead forwards suspicions to avoid being suspected.
If a leaf does not receive a proposal, it could be caused by the root not sending the proposal or by the intermediate node failing to forward it.
Therefore, leaf nodes do not immediately issue suspicions on view timeout; instead, they wait for the internal nodes to raise suspicions.
If no such suspicion is raised, the leaf suspects both the root and the intermediate node \tcond{b'}.
Finally, correct replicas reciprocate suspicions raised by faulty replicas (c), as in the star configuration.

\begin{table}[ht]
  \caption{Suspicion cases in a tree topology.}
  \label{tab:tree-suspicion}
  \footnotesize
  \centering
  \begin{tabular}{@{}p{0.7cm}@{}p{0.35cm}@{}p{2.6cm}@{}p{2.4cm}@{}p{1.95cm}@{}}
    \toprule
    \multicolumn{3}{@{}l}{\textbf{Condition for Suspicion}} & \textbf{Timeout}                & \textbf{Suspicion} \\
    \midrule
    \tcond{a}  & \nin:    & No response from $\nleafT$  & $\timeout{\nin}{\nleafT}$           & \suspm{Slow}{\nin}{\nleafT} \\
    \tcond{a'} & \nr:     & No response from $\nin$     & $\df{(\agt{\nin}+\lme{\nr}{\nin})}$ & \suspm{Slow}{\nr}{\nin} \\
    \tcond{b}  & \nin:    & View timeout and            & $\df{\score(\q+\un,\tree)}$             & \suspm{Slow}{\nin}{\nr} \\
    &          & no suspicion                &                                     & \\
    \tcond{b'} & \nleafT: & View timeout and            & $\df{\score(\q+\un,\tree)}$             & \suspm{Slow}{\nleafT}{\nr} \\
    &          & no suspicion during         & $\df{\score(\q+\un,\tree)}$             & $\wedge\suspm{Slow}{\nleafT}{\nin}$ \\
    \tcond{c}  & \na:     & False suspicion from $\nb$  &                                     & \suspm{False}{\na}{\nb} \\
    \bottomrule
  \end{tabular}
\end{table}

When computing a maximum independent set for candidate selection (\cref{sec:suspicion}), a single intermediate node suspected by a leaf may cause the candidate set to update and require a reconfiguration.
Faulty replicas may force $\Omega(\f^2)$ reconfigurations before they are excluded from the candidate set~\cite{jehl2019quorum}.

We use a different approach to compute $\un$ and the candidate set $\Cand$ for trees.
This method produces smaller candidate sets and requires at most $2\f$ reconfigurations, while avoiding the computational complexity of finding a maximum independent set.

We introduce two additional data structures, \MG and \T, both derived from $\G$.
\MG is a maximal set of disjoint edges in $\G$.
For every edge in \MG, at least one of the adjacent vertices is a faulty replica.
We therefore exclude both replicas from $\Cand$.
Whenever an edge is added to \G, the suspicion monitor checks if \MG is still maximal.
This check includes possibly removing one edge from \MG and adding two new ones.
We also determine $\T$, the set of vertices that are not adjacent to an edge in \MG but part of a triangle in $\G$ with an edge in \MG.
We also exclude replicas in $\T$ from $\Cand$.

Finally, we return $\Cand$ containing replicas (vertices) in $\G$ that are not in $\T$ or adjacent to an edge in \MG.
We also return the estimated number of faulty replicas $\un=|\MG|+|\T|$.

\input{images/treeexample.tex}

\cref{fig:suspicionsexample} illustrates a suspicion graph $\G$ and the resulting tree configuration with excluded nodes.
In this example, $\MG = \{(\susn{1},\susn{4}), (\susn{2},\susn{3})\}$, as adding any other suspicion would violate the disjoint property of \MG, which is already maximal.
The set $\T = \{\naT\}$ includes nodes that form a triangle with one edge in $\MG$ and two others in $\G$.
As $\nbC$ has a one-way suspicion, it is added to $\Crash$.
Since we exclude all replicas (vertices) from $\T$, $\MG$, and $\Crash$ from the configuration $\C{}$ making $\Cand = \{\cn{1},\cn{2},\cn{3},\nr\}$.
