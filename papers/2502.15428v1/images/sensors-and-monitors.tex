\def\smsize{0.6cm}
\def\smpos{1}
\def\rsize{1cm}
\def\dist{1.5}
\def\logpos{0}
\def\logh{0.5}
\def\logw{8.9}
\def\arrowspacing{4pt}
\def\legendspacing{0.28}

\definecolor{darkcola}{RGB}{140, 140, 180} %
\definecolor{cola}{RGB}{230, 230, 250} %
\definecolor{colb}{RGB}{100, 200, 100} %
\definecolor{colc}{RGB}{200, 100, 100} %
\definecolor{cold}{RGB}{100, 180, 180} %


\tikzset{
  arrow-record-a/.style={->, thick, color=#1},
  arrow-record-b/.style={->, thick, >={latex'}, color=#1},
  arrow-notify-a/.style={<-, thick, color=#1},
  arrow-notify-b/.style={<-, thick, >={latex'}, color=#1},
  arrow-local/.style={->, thick, dashed},
  arrow-sh/.style={xshift=#1*\arrowspacing},
}

\tikzset{
  label/.style={midway, yshift=-2pt, font=\scriptsize, fill=white, fill opacity=1, text opacity=1, inner sep=1.5pt},
  legend/.style={left, font=\scriptsize},
  box/.style={draw, rectangle, minimum width=\smsize, minimum height=\smsize, pattern=crosshatch, pattern color=white},
  replica/.style={draw, rectangle, minimum width=\rsize, minimum height=\smsize},
  sensor-box/.style={box, preaction={fill=#1}},
  monitor-box/.style={box, preaction={fill=#1}},
  replica-box/.style={replica, preaction={fill=#1}},
}

\begin{tikzpicture}

  \draw[thick, fill=cola] (0.5, 1.9) node[anchor=north west] {Replica \na} rectangle (\logw, \logpos+0.5);

  \node[sensor-box=light-yellow] (S1) at (1*\dist, \smpos) {$\sens{1}$};
  \node[monitor-box=light-yellow] (M1) at (2*\dist, \smpos) {$\mons{1}$};
  \node[sensor-box=light-blue] (S2) at (3*\dist, \smpos)   {$\sens{2}$};
  \node[monitor-box=light-blue] (M2) at (4*\dist, \smpos)   {$\mons{2}$};
  \node[replica-box=light-blue] (RSM) at (5.5*\dist, \smpos) {RSM};

  \draw[arrow-local] (M2.east) -- (RSM.west) node[midway, yshift=-3pt, font=\scriptsize, above] {Reconfigure};

  \draw[arrow-local] (M1) -- (S1);
  \draw[arrow-local] (M1) -- (S2);
  \draw[arrow-local] (M1.north) to[out=60, in=120, looseness=0.5] (M2.north);

  \draw[arrow-record-a=darkcola] (S1.south) -- (1*\dist, \logpos) node[label] {Record};
  \draw[arrow-record-b=darkcola] (S2.south) -- (3*\dist, \logpos) node[label, yshift=1.5pt] {Record};

  \draw[arrow-notify-a=colb] ([arrow-sh=-1.5]M1.south) -- ([arrow-sh=-1.5]2*\dist, \logpos);
  \draw[arrow-notify-a=colc] ([arrow-sh=-0.5]M1.south) -- ([arrow-sh=-0.5]2*\dist, \logpos);
  \draw[arrow-notify-a=cold] ([arrow-sh=1.5]M1.south) -- ([arrow-sh=1.5]2*\dist, \logpos);
  \draw[arrow-notify-a=darkcola] ([arrow-sh=0.5]M1.south) -- ([arrow-sh=0.5]2*\dist, \logpos) node[label, xshift=-2pt] {Notify};

  \draw[arrow-notify-b=colb] ([arrow-sh=-1.5]M2.south) -- ([arrow-sh=-1.5]4*\dist, \logpos);
  \draw[arrow-notify-b=colc] ([arrow-sh=-0.5]M2.south) -- ([arrow-sh=-0.5]4*\dist, \logpos);
  \draw[arrow-notify-b=cold] ([arrow-sh=1.5]M2.south) -- ([arrow-sh=1.5]4*\dist, \logpos);
  \draw[arrow-notify-b=darkcola] ([arrow-sh=0.5]M2.south) -- ([arrow-sh=0.5]4*\dist, \logpos) node[label, xshift=-2pt] {Notify};

  \node[replica, fill=colb] (B) at (2*\dist, \logpos-\logh-0.9) {\nb};
  \node[replica, fill=colc] (C) at (3*\dist, \logpos-\logh-0.9) {\nc};
  \node[replica, fill=cold] (D) at (4*\dist, \logpos-\logh-0.9) {\nd};

  \draw[arrow-record-a=colb] ([arrow-sh=0.5]B.north) -- ([arrow-sh=0.5]2*\dist, \logpos-\logh);
  \draw[arrow-record-a=colc] ([arrow-sh=0.5]C.north) -- ([arrow-sh=0.5]3*\dist, \logpos-\logh);
  \draw[arrow-record-a=cold] ([arrow-sh=0.5]D.north) -- ([arrow-sh=0.5]4*\dist, \logpos-\logh);
  \draw[arrow-record-b=colb] ([arrow-sh=-0.5]B.north) -- ([arrow-sh=-0.5]2*\dist, \logpos-\logh) node[label, xshift=2pt] {Record};
  \draw[arrow-record-b=colc] ([arrow-sh=-0.5]C.north) -- ([arrow-sh=-0.5]3*\dist, \logpos-\logh) node[label, xshift=2pt] {Record};
  \draw[arrow-record-b=cold] ([arrow-sh=-0.5]D.north) -- ([arrow-sh=-0.5]4*\dist, \logpos-\logh) node[label, xshift=2pt] {Record};

  \draw[thick] (0.5, \logpos) -- (\logw, \logpos) node[midway, yshift=1pt, below] {Append-only Log};
  \draw[thick] (0.5, \logpos-\logh) -- (\logw, \logpos-\logh);

  \begin{scope}[shift={(8.25, \logpos-1.5*\logh)}]
    \coordinate (legend-pos) at (0, 0);

    \node[legend] at ($(legend-pos) + (0.5, 0)$) {\textbf{Arrow Legend:}};
    \node[legend] at ($(legend-pos) - (0, \legendspacing)$) {Sensor \sens{1}};
    \draw[arrow-record-a=black] ($(legend-pos) - (0, \legendspacing)$) -- ++(0.5, 0);
    \node[legend] at ($(legend-pos) - (0, 2*\legendspacing)$) {Sensor \sens{2}};
    \draw[arrow-record-b=black] ($(legend-pos) - (0, 2*\legendspacing)$) -- ++(0.5, 0);
    \node[legend] at ($(legend-pos) - (0, 3*\legendspacing)$) {Local data};
    \draw[arrow-local] ($(legend-pos) - (0, 3*\legendspacing)$) -- ++(0.5, 0);
  \end{scope}
\end{tikzpicture}
