\begin{algorithm}[tbp]
  \caption{Multi-Faceted Fast Textual Adversarial Attack}
  \label{alg:multifaceted_fast_prompt_attack}
  {\footnotesize 
  \begin{algorithmic}[1]
    \Require
      Input toxic prompt $\mathbf{p}$.
      Target $M$ (\ie content moderator) and its Tokenizer.
      Randomly initialized adv. signature $\mathbf{p}_{\text{adv}} = [p_1, p_2, \dots, p_\ell]$ of length $\ell$.
      Token selection variables $\mathbf{S}_{\text{adv}} = [\mathbf{s}_1, \mathbf{s}_2, \dots, \mathbf{s}_\ell]$, where each $\mathbf{s}_i \in \{0,1\}^{|V|}$ is a one-hot vector over vocabulary of size $|V|$.
      Candidate adversarial prompts number $c$.
      Optimization iterations $N$.
    \For {$t = 1$ to $N$} \Comment{Optimization iterations}
      \State Compute loss: $\mathcal{L} \leftarrow M\big(\mathbf{p} + \mathbf{p}_{\text{adv}}\big)$
      \State Compute gradient of loss w.r.t. token selections:
      \\\hspace{1.5em} $\mathbf{G} \leftarrow \nabla_{\mathbf{S}_{\text{adv}}} \mathcal{L}$, where $\mathbf{G} \in \mathbb{R}^{\ell \times |V|}$
      % \If{$t = 1$ \textbf{or} $t \bmod 5 = 0$} \Comment{Discrete update every 5 iter.}
        \For{$i = 1$ to $\ell$} \Comment{For each position in the prompt}
          \State Get top-$k$ token indices with highest gradients: 
          \State $\mathbf{d}_i \leftarrow \text{TopKIndices}(\mathbf{g}_i, k)$
          \Comment{$\mathbf{d}_i \in \mathbb{N}^k$}
        \EndFor
        \State Stack indices: $\mathbf{D} \leftarrow [\mathbf{d}_1; \mathbf{d}_2; \dots; \mathbf{d}_\ell] \in \mathbb{N}^{\ell \times k}$
        \State Random selections: $\mathbf{R} \leftarrow \textbf{Rand}(1, k, \text{size=}(\ell, c))$
        % \Comment{$\mathbf{R} \in \mathbb{N}^{\ell \times c}$}
        \State Obtain candidate set: $\mathbf{T}_{\text{adv}} \leftarrow \mathbf{D}[\mathbf{R}]$
        \Comment{$\mathbf{T}_{\text{adv}} \in \mathbb{N}^{\ell \times c}$}
        \For{$j = 1$ to $c$} \Comment{For each candidate prompt}
          \State Candidate tokens: $\mathbf{t}_{\text{adv}}^{(j)} \leftarrow \mathbf{T}_{\text{adv}}[:, j]$
          \State Candidate prompt: $\mathbf{p}_{\text{adv}}^{(j)} \leftarrow \text{Tokenizer.decode}(\mathbf{t}_{\text{adv}}^{(j)})$
          \State Compute candidate loss: $\mathcal{L}_j \leftarrow M\big(\mathbf{p} + \mathbf{p}_{\text{adv}}^{(j)}\big)$
        \EndFor
        \State Find the best candidate: $j^* \leftarrow \arg\min_{j} \mathcal{L}_j$
        \State Update variables: $\mathbf{t}_{\text{adv}} \leftarrow \mathbf{t}_{\text{adv}}^{(j^*)}$, $\mathbf{S}_{\text{adv}} \leftarrow \text{OneHot}(\mathbf{t}_{\text{adv}})$, $\mathbf{p}_{\text{adv}} \leftarrow \text{Tokenizer.decode}(\mathbf{t}_{\text{adv}})$
      % \Else
        % \State ...
      % \EndIf
    \EndFor
    \Ensure Optimized adversarial signature $\mathbf{p}_{\text{adv}}$
  \end{algorithmic}}
\end{algorithm}