\documentclass[journal,onecolumn]{IEEEtran}


\usepackage[pdftex]{graphicx}
%\usepackage[dvips]{graphicx}

\usepackage[cmex10]{amsmath}
\interdisplaylinepenalty=2500
\usepackage{amsfonts,bm,amssymb}
\usepackage{array}

        % *** SUBFIGURE PACKAGES ***
        \ifCLASSOPTIONcompsoc
        \usepackage[caption=false,font=normalsize,labelfont=sf,textfont=sf]{subfig}
        \else
        \usepackage[caption=false,font=footnotesize]{subfig}
        \fi

\usepackage{graphics} % for pdf, bitmapped graphics files
 \usepackage{epsfig}
 \usepackage{pst-grad} % For gradients
 \usepackage{pst-plot} % For axes
 \usepackage{arydshln}%for dashedline in array
 \usepackage{hhline}%matrix lines
 \usepackage{resizegather}
\usepackage{color,soul}
 \usepackage{graphicx, epsfig,psfrag,color}
 \usepackage{enumerate}
% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}
\usepackage{mathtools}
\usepackage{tabularx}%used to compact equations in one line with seperate numbering
\usepackage{makecell}% two have linebreak in one cell in table
\usepackage{epsfig}
\usepackage{algorithm2e}
\usepackage{algorithmic}
\usepackage{resizegather}
\usepackage{url}

%\usepackage{auto-pst-pdf}

\usepackage{cases}%for numcase
\usepackage{arydshln}% for dashline
\usepackage{physics}% for derivatives and partial derivatives(using command \dv and \pdv)NOTE: \dv[2] only works in align environment
\usepackage{diagbox,multirow} % for diagonal line in table
\usepackage{siunitx}
\usepackage{siunitx}% for units


\usepackage{graphicx} % http://ctan.org/pkg/graphicx..... for generating totate command
\usepackage{booktabs} % http://ctan.org/pkg/booktabs.....for generating totate command
\usepackage{xparse}   % http://ctan.org/pkg/xparse....for generating totate command
% Rotation: \rot[<angle>][<width>]{<stuff>}
\NewDocumentCommand{\rot}{O{45} O{1em} m}{\makebox[#2][l]{\rotatebox{#1}{#3}}}%


\usepackage{authblk}% for the thank command

\usepackage{diagbox}
\usepackage{rotating}
\usepackage{graphicx}
\usepackage{makecell, caption, booktabs}



%for diagonal line in table:
\usepackage{diagbox}
%for tabularx, different width for the column
\usepackage{lscape}
%\newcolumntype{b}{>{\hsize=1.68\hsize}X}
\newcolumntype{s}{>{\hsize=.83\hsize}X}

\newcolumntype{L}{>{\hsize=1.4\hsize}X}%for WPs
\newcolumntype{M}{>{\hsize=.3\hsize}X}
\newcolumntype{E}{>{\hsize=1\hsize}X}%for WPs
 
\newcolumntype{D}{>{\hsize=1.7\hsize}X}
\newcolumntype{F}{>{\hsize=0.8\hsize}X}
    

\DeclareMathOperator*{\argmax}{argmax} % thin space, limits underneath in displays
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

\pagestyle{empty}

\newcommand\coolover[2]{\mathrlap{\smash{\overbrace{\phantom{%
    \begin{matrix} #2 \end{matrix}}}^{\mbox{$#1$}}}}#2}

\newcommand\coolunder[2]{\mathrlap{\smash{\underbrace{\phantom{%
    \begin{matrix} #2 \end{matrix}}}_{\mbox{$#1$}}}}#2}

\newcommand\coolleftbrace[2]{%
#1\left\{\vphantom{\begin{matrix} #2 \end{matrix}}\right.}

\newcommand\coolrightbrace[2]{%
\left.\vphantom{\begin{matrix} #1 \end{matrix}}\right\}#2}

\newcommand{\RNum}[1]{\uppercase\expandafter{\romannumeral #1\relax}}%make roman numbering


\newcounter{MYtempeqncnt}%for full column equation

\newtheorem{remark}{Remark}
\newtheorem{example}{Example}
\newtheorem{proposition}{Proposition}
\newtheorem{assumption}{Assumption}
\newtheorem{problem}{Problem}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}

\pdfminorversion=5

%\newcolumntype{E}{>{\hsize=1\hsize}X}%for WPs

\AtBeginDocument{\RenewCommandCopy\qty\SI}

\begin{document}
\title{ Optimization-based Coordination of Traffic Lights and Automated Vehicles at Intersections}

\author{ Azita Dabiri, Giray \"On\"ur, Sebastien Gros, Bart De Schutter

\small{\textbf{Correspondence:} Giray \"On\"ur (g.oenuer@tudelft.nl)}

 \thanks{ A. Dabiri, Giray \"On\"ur, and B. De Schutter are with the Delft Center for Systems and Control,  Delft University of Technology, Building 23
Stevinweg 1, 2628 CN Delft, {\tt\small a.dabiri, g.oenuer, b.deschutter@tudelft.nl}. S. Gros is with the Department of Engineering Cybernetics, Norwegian University of Science and Technology, NO-7491 Trondheim, Norway, {\tt\small  sebastien.gros@ntnu.no}.
 }}


 %The paper headers
%\markboth{Journal of \LaTeX\ Class Files,~Vol.~11, No.~4, December~2012}%
%{Shell \MakeLowercase{\textit{et al.}}: Bare Demo of IEEEtran.cls for Journals}

\maketitle
\begin{abstract}
This paper tackles the challenge of coordinating traffic lights and automated vehicles at signalized intersections, formulated as a constrained finite-horizon optimal control problem. The problem falls into the category of mixed-integer nonlinear programming, posing challenges for solving large instances. To address this, we introduce a decomposition approach consisting of an upper-level problem for traffic light timing allocation and a set of lower-level problems that generate appropriate commands for automated vehicles in each intersection movement. By leveraging solutions from the lower-level problems and employing parametric optimization techniques, we solve the upper-level problem using a standard sequential quadratic programming approach. The paper concludes by presenting an illustrative numerical example that highlights the effectiveness of our algorithm compared to scenarios where no coordination between traffic lights and vehicles exists.

\end{abstract}
\begin{IEEEkeywords}
Receding Horizon Control,  Parametric Optimization, Connected and Autonomous Vehicles, Intelligent Transportation Systems
\end{IEEEkeywords}

%Section%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}
\IEEEPARstart{I}n recent years, there have been significant advancements in communication systems, sensing technology, driver assistance systems, and automated driving technologies. These developments, coupled with methodological improvements in fields like control theory and numerical optimization, have opened up new opportunities to address the challenges of urban traffic management. Consequently, this domain has become one of the most attractive application areas for research in cyber-physical systems.

Before delving into the contributions of this work, in the remainder of this section, we provide an overview of existing approaches in the literature that aim to mitigate congestion at intersections, enhance vehicle energy efficiency, and reduce emissions. While this section is not intended to offer an exhaustive literature survey, it aims to present a snapshot of research directions that all share a common objective: achieving efficient urban mobility. These approaches are categorized into four main areas: 1) methods for efficient traffic light control at intersections, 2) methods for optimizing the trajectories of vehicles approaching signalized intersections, 3) methods for coordinating vehicles approaching intersections without traffic lights, and 4) methods for the joint optimization of traffic signal timing and vehicle trajectories. For a comprehensive literature survey, interested readers are referred to \cite{GUOsurvey}.
%%%%%%%%%%%%%%%%%%
\subsection{Traffic light control at intersections}
Control of traffic lights at intersections is a conventional approach for urban traffic control. The primary goal is to develop control strategies for signal timing with performance objectives such as reducing travel time, emissions, total queue length, or a combination of these factors. Approaches in the literature vary based on several factors, including the control strategy's nature, whether it is local~\cite{De-Schutter:1998aa, Haddad:2010aa}, centralized~\cite{Weg:2019aa}, or distributed~\cite{Islam:2017aa, Zhou:2015aa}, as well as whether they are model-based~\cite{Jamshidnejad:2018aa, Kulcsar:2015aa, Weg:2019aa, Islam:2017aa, Zhou:2015aa} or model-free~\cite{El-Tantawy:2013aa, Bazzan:2010aa, Zaidi:2016aa}.

Additionally, these approaches may employ various control methods, such as fuzzy logic~\cite{Rahman:2009aa}, model predictive control~\cite{Jamshidnejad:2018aa, Zhou:2015aa, Weg:2019aa}, and reinforcement learning~\cite{El-Tantawy:2013aa, Bazzan:2010aa}. They also utilize different traffic models, including the S-model~\cite{Jamshidnejad:2018aa, Lin:2011aa}, the link transmission model~\cite{Weg:2019aa, Hajiahmadi:2016aa}, or the cell transmission model~\cite{Lo:1999aa, Mohebifard:2019aa}.
It's important to note that many of these approaches incorporate aggregated variables such as traffic flow, traffic density, and average speed into their formulations.
%%%%%%%%%%%%%%%%%%
\subsection{Vehicular trajectory control}
Acceleration and deceleration resulting from drivers' reactions to traffic lights, as well as stop-and-go movements, lead to increased fuel consumption and emissions. With the assumption of having exact and accurate information on the phase and timing of the traffic lights, the literature offers various approaches to control vehicle trajectories effectively and minimize these economic and environmental costs. These approaches differ in control methods, control objectives, types of vehicles considered, the level of vehicle connectivity, and vehicle autonomy. For single-vehicle scenarios, methods such as model predictive control~\cite{ecodrive1, ecodrive-fastMPC}, dynamic programming~\cite{ecodrive3, ecodrive4}, and other optimization-based algorithms~\cite{ecodrive2, ecodrive-queue} have been used. With the growing market penetration of electric and hybrid electric vehicles, studies focusing on their energy efficiency in signalized urban areas have gained significant attention as well~\cite{Luo2017, Yang2019, Yu2015}.

Although control of a vehicle trajectory has been shown to reduce energy consumption or travel time effectively, vehicular trajectory control is expected to be more effective when applied to a coordinated vehicle group. Research has explored platoon-based strategies for cooperation between human-driven and automated vehicles. For instance, in \cite{Zhao2018}, model predictive control is employed to minimize fuel consumption within platoons. In \cite{Liu2016}, platoons are reorganized to maximize the number of vehicles passing the intersection during green phases, considering safety, passenger comfort, and fuel consumption. Although promising results in reducing energy consumption or travel time are obtained, these approaches rely on the availability of accurate traffic light phase and timing information without control over how the traffic signal evolves.
%%%%%%%%%%%%%%%%%%
\subsection{Coordination of connected vehicles at intersections without traffic lights}
Advancements in automated driving and connected vehicles have not only enabled researchers to envision innovative solutions~\cite{Rios-Torres:2017aa} but have also facilitated field-test validation~\cite{Hult:2019aa}. In these tests, coordination between vehicles plays the role of traffic lights, determining the right of way while avoiding collisions at intersections. This coordination problem can be framed as a constrained optimal control problem, involving finding the (sub)optimal order for vehicles to cross and their optimal trajectories, often with the aim of minimizing metrics like fuel consumption or travel time. However, due to its complexity, the problem is simplified in~\cite{Zhang:2016aa, Riegger:2016aa} by fixing the crossing order using heuristics such as a first-come-first-served policy and finding the optimal vehicle trajectories given this fixed order. A few contributions have been proposed that optimise both the trajectories and the crossing order of vehicles by formulating the problem in a mixed integer programming scheme~\cite{Bali:2018aa, Hult:2018aa}. Despite their promising outcomes, this line of research does not address the safety concerns of vulnerable road users, ensuring their safe passage at intersections.
%%%%%%%%%%%%%%%%%
\subsection{Vehicle trajectories and traffic light control  }\label{sec:vehiclelight}
Research into the joint control of vehicle trajectories and signal timing has gained traction only in recent years, resulting in a limited number of studies within this category. One of the early contributions to this field can be found in \cite{LI:2014}, where the joint optimization of signal timing and automated vehicle trajectories was explored. To simplify the problem, the study introduced a four-component trajectory with constant acceleration in each part and used enumeration techniques to find optimal signal timing and trajectories in a straightforward intersection scenario featuring two single-lane through approaches.
This enumeration-based approach, while insightful, is not applicable to more complex intersections and is not considered optimal due to the simplifications made in trajectory generation.


In \cite{Biao_xu-2019}, a cooperative control method tackles the complexity of a 4-leg intersection using a bi-level framework. In the upper level, the optimization focuses on traffic signal timing and vehicle arrival times to minimize the total travel time of all vehicles. Meanwhile, in the lower level, vehicles optimize their trajectories to minimize fuel consumption while adhering to the scheduled times from the upper level.
However, this framework assumes a fixed cycle length and relies on enumerating all possible signal timings, which becomes computationally demanding with longer cycles or smaller time discretization intervals. Additionally, because the upper-level optimization lacks explicit consideration of vehicle dynamics and inter-vehicle interactions, there is no guarantee that the planned arrival times can be upheld in the lower level, where vehicle kinematics and collision avoidance measures are taken into account.
% The cooperative control method proposed in \cite{Biao_xu-2019} addresses the problem in a more complex 4-leg intersection by proposing a bi-level framework. In the upper level, the timing of the traffic signal and the arrival time of all the vehicles are optimized such that the total travel time of all the vehicles is minimised. The vehicles optimise their trajectories to minimise their fuel consumption in the lower level respecting the time scheduled planned in the upper level.  However, in this framework, the cycle length is fixed and the optimization problem in the lower level is solved by enumerating all possible signal timing. Therefore, the solution approach is computationally demanding if the cycle length is long or the time discretisation interval is small. Moreover, since the vehicle dynamics and the interaction between the vehicles are not explicitly incorporated in the upper level optimisation problem, there is no guarantee that the planned arrival time can be respected in the lower level where the vehicle kinematic model and safety measures for collision avoidance are incorporated. 
In \cite{Niroumand2020}, an optimization problem is introduced to jointly optimize signal timing, vehicle speeds, and accelerations for mixed-autonomy traffic streams. The formulation becomes tractable due to the choice of the cost function and linearization of nonlinear constraints. It's worth noting that, in this framework, the green duration of each phase must be an integer multiple of the time step size for signal updates. Therefore, the method's performance depends on the level of granularity introduced in signal timing

Some alternative approaches have been proposed in the literature. Some of these formulations involve optimization problems with non-generalizable cost functions \cite{Yu:2018}, while others rely on heuristics to simplify vehicle trajectory generation \cite{Guo:2019, Feng:2018}. Despite these differences, all these studies have demonstrated that the coordination between traffic lights and vehicles holds promise for improving traffic operations
%%%%%%%%%%%%%%%%%
\subsection{Contribution of the work}
In this paper, we investigate the optimization-based coordination of traffic lights and vehicle trajectories at a 4-leg intersection, considering various turning options in which we have addressed the shortcomings mentioned in Section \ref{sec:vehiclelight}. Importantly, our approach is adaptable to different intersection layouts. We achieve the optimal solution by jointly optimizing signal timing and vehicle acceleration, resulting in a mixed-integer nonlinear program problem.

To tackle this complexity, we propose a two-level decomposition. The upper level addresses green time allocation, while the lower level handles vehicle trajectory optimization problems in parallel. Output from the lower level informs the upper level, and by employing parametric optimization tools, we solve the top-level optimization problem.

Within this framework:
\begin{itemize}
\item The cycle length remains flexible, and traffic signal timings aren't constrained to integer values, enabling more efficient signal timings.
\item Vehicle trajectories are generated without simplifications or heuristics.
\item There are no constraints on vehicle arrival speeds at the intersection.
\item The general formulation allows for the incorporation of various performance metrics, making it suitable for analyzing intersections with different layouts.
\end{itemize}

This coordinated approach distributes intelligence not only to individual vehicles but also to the traffic lights themselves. It brings together two key players, traffic signals and vehicles, to enhance system performance. Importantly, such a setting will allow vulnerable road users, e.g. pedestrians and cyclists, to cross the intersection in a safe manner as well.

The remainder of the paper is organised as follows. In Section \ref{sec:problem}, the problem studied in the paper is presented. Section \ref{sec:decomposition} explains the proposed decomposition method followed by the solution approach, which is detailed in Section \ref{sec:solution}. The results of applying the proposed approach are provided in Section \ref{sec:case}. %The paper concludes with the remarks given in  Section\ref{sec:remarks}.
%%%%%%%%%%%%%%%%%
\section{Problem formulation}\label{sec:problem}
In this section, we treat traffic lights and automated vehicles as agents. We create a model for the intersection scenario, encompassing traffic light and vehicle dynamics, along with constraints for each agent type. The description remains general, with specific details provided in the comparison presented in Section \ref{sec:case}. Throughout this article, we work with the following assumptions
%%%%%%%%%%%%%%%%%%%%%%%%%
\assumption Controlled zone in which the vehicles are controlled is a circle with a radius of $X$ around the intersection. 
\assumption All the vehicles are automated and when in the controlled zone they can communicate their location and speed with each other and with the traffic light.
\assumption The vehicles follow predetermined paths along the road without changing lanes.
\assumption Vehicles making right turns will use the right lane after the intersection, while those making left turns will use the left lane.\label{ass:turn}
\assumption Traffic conditions downstream of the intersection do not restrict vehicle movement, and there is no spill-back effect.\label{ass:downstream}
\subsection{Traffic light timing}
We examine a standard 4-leg signalized intersection with two lanes allocated to each of the incoming travel directions, accommodating left-turning and through/right-turning vehicles. Consequently, there are eight approaching movements at the intersection, as illustrated in Figure \ref{fig:intersection}: westbound left (movement 1), eastbound through (movement 2), northbound left (movement 3), southbound through (movement 4), eastbound left (movement 5), westbound through (movement 6), southbound left (movement 7), and northbound through (movement 8).
\begin{figure}[h]
\includegraphics[width=\linewidth]{intersectionIcogram4.pdf}
\caption{Schematic illustration of an intersection. Drawn using https://www.icograms.com}
\label{fig:intersection}
\end{figure}



\begin{figure}[h]
\begin{center}
% \usepackage[usenames,dvipsnames]{pstricks}
% \usepackage{epsfig}
% \usepackage{pst-grad} % For gradients
% \usepackage{pst-plot} % For axes
% \usepackage[space]{grffile} % For spaces in paths
% \usepackage{etoolbox} % For spaces in paths
% \makeatletter % For spaces in paths
% \patchcmd\Gread@eps{\@inputcheck#1 }{\@inputcheck"#1"\relax}{}{}
% \makeatother
% 

% \begin{pspicture}(0,-2.4469714)(7.8671427,2.4469714)
% \definecolor{colour0}{rgb}{0.0,0.4,0.2}
% \definecolor{colour1}{rgb}{0.4,0.4,0.4}
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=red, dimen=outer](3.1651816,0.24731427)(2.9241168,-0.03268573)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=red, dimen=outer](0.9755099,0.24731427)(0.7344451,-0.03268573)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=red, dimen=outer](6.5199995,0.24731427)(6.278935,-0.03268573)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour0, dimen=outer](6.2990236,0.24731427)(4.6517477,-0.03268573)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=red, dimen=outer](4.691925,0.24731427)(4.4508605,-0.03268573)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour0, dimen=outer](4.470949,0.24731427)(3.1450927,-0.03268573)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour0, dimen=outer](2.9241168,0.24731427)(0.9755099,-0.03268573)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour0, dimen=outer](0.7344451,0.24731427)(0.05142822,-0.03268573)
% \psline[linecolor=colour1, linewidth=0.04, fillstyle=solid, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(0.5414282,0.98398095)(0.17476155,0.98398095)(0.19142823,0.4006476)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(5.508095,-2.1374476)(5.5247617,-1.5755429)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(5.476728,1.017308)(5.4727955,0.40065387)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(1.5498176,0.9531051)(2.1663723,0.9648568)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(2.454478,-1.9986897)(1.8807594,-2.002396)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(0.40061858,-2.0313218)(0.72467166,-2.0323548)(0.7237842,-1.5035459)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(3.6847444,-1.6722965)(3.6820927,-2.006148)(4.2653666,-2.0041785)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(4.016049,0.64174014)(4.0161095,0.9752353)(3.4325452,0.97787446)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour0, dimen=outer](4.7290473,-1.1436381)(3.0890472,-1.4236381)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=red, dimen=outer](4.915714,-1.1436381)(4.675714,-1.4236381)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour0, dimen=outer](6.285714,-1.1436381)(4.915714,-1.4236381)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=red, dimen=outer](6.525714,-1.1436381)(6.285714,-1.4236381)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour0, dimen=outer](1.3614283,-1.1436381)(0.05142822,-1.4236381)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour0, dimen=outer](2.908095,-1.1436381)(1.5814282,-1.4236381)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=red, dimen=outer](3.1314282,-1.1436381)(2.8914282,-1.4236381)
% \psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=red, dimen=outer](1.5814282,-1.1436381)(1.3414283,-1.4236381)
% \psline[linecolor=black, linewidth=0.04, linestyle=dashed, dash=0.17638889cm 0.10583334cm](3.1414282,1.2030286)(3.158095,-2.416019)
% \psline[linecolor=black, linewidth=0.04](6.522649,1.1702044)(6.507827,-2.4165282)
% \psline[linecolor=black, linewidth=0.04](0.019999651,1.1958857)(0.034285367,-2.4184)
% \rput[bl](0.23428537,1.3673142){1}
% \rput[bl](1.8771425,1.3530285){2}
% \rput[bl](3.7342854,1.3673142){3}
% \rput[bl](5.362857,1.3530285){4}
% \rput[bl](0.3628568,-2.4184){5}
% \rput[bl](1.9057139,-2.4469714){6}
% \rput[bl](3.7485712,-2.4326856){7}
% \rput[bl](5.4199996,-2.4469714){8}
% \rput{-268.5563}(4.6972976,-1.8457768){\rput[bl](3.2485712,1.3673142){Barrier}}
% \rput[bl](6.8342853,-0.08982859){Ring 1}
% \rput[bl](6.8771424,-1.4898286){Ring 2}
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(1.8052992,0.94587946)(1.8013668,0.48636815)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(2.2366662,-2.023162)(2.253333,-1.4612571)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(5.4544783,0.815596)(4.8807592,0.81188965)
% \psline[linecolor=colour1, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(5.492675,-2.0040379)(6.1092296,-1.9922861)
% \end{pspicture}
\includegraphics[scale=0.225]{signal_phase_scheme.pdf}
\caption{Signal phase scheme}
\label{fig:phase}
\end{center}
\end{figure}


%\begin{figure}[bh]
%\begin{center}
%% \usepackage[usenames,dvipsnames]{pstricks}
%% \usepackage{epsfig}
%% \usepackage{pst-grad} % For gradients
%% \usepackage{pst-plot} % For axes
%% \usepackage[space]{grffile} % For spaces in paths
%% \usepackage{etoolbox} % For spaces in paths
%% \makeatletter % For spaces in paths
%% \patchcmd\Gread@eps{\@inputcheck#1 }{\@inputcheck"#1"\relax}{}{}
%% \makeatother
%% 
%\psscalebox{.7 .7} % Change this value to rescale the drawing.
%{
%\begin{pspicture}(0,-5.906352)(18.156553,5.906352)
%\definecolor{colour2}{rgb}{0.6,0.6,0.6}
%\psline[linecolor=white, linewidth=0.04](15.676553,1.7180517)(18.156553,1.7180517)
%\psline[linecolor=white, linewidth=0.04](6.884241,2.3306525)(6.9074206,5.9062295)
%\psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour2, dimen=outer](10.707857,1.4284865)(1.2295964,-1.510644)
%\rput{-90.15812}(6.0265894,6.1539106){\psframe[linecolor=white, linewidth=0.002, fillstyle=solid,fillcolor=colour2, dimen=outer](10.820901,1.54153)(1.3426398,-1.3976005)}
%\psline[linecolor=white, linewidth=0.064](7.354641,1.5188899)(7.3573637,1.938881)
%\psline[linecolor=white, linewidth=0.064](7.154645,1.5201864)(7.1573677,1.9401776)
%\psline[linecolor=white, linewidth=0.064](6.954649,1.521483)(6.9573717,1.9414741)
%\psline[linecolor=white, linewidth=0.064](6.7546535,1.5227801)(6.757376,1.9427712)
%\psline[linecolor=white, linewidth=0.064](6.5546575,1.5240766)(6.55738,1.9440677)
%\psline[linecolor=white, linewidth=0.064](6.354662,1.5253731)(6.3573847,1.9453642)
%\psline[linecolor=white, linewidth=0.064](6.154666,1.5266696)(6.1573887,1.9466608)
%\psline[linecolor=white, linewidth=0.064](5.9546704,1.5279661)(5.9573927,1.9479573)
%\psline[linecolor=white, linewidth=0.064](5.7546744,1.5292627)(5.757397,1.9492538)
%\psline[linecolor=white, linewidth=0.064](5.5546784,1.5305592)(5.557401,1.9505503)
%\psline[linecolor=white, linewidth=0.064](5.354683,1.5318557)(5.3574057,1.9518468)
%\psline[linecolor=white, linewidth=0.064](5.154687,1.5331522)(5.1574097,1.9531434)
%\psline[linecolor=white, linewidth=0.064](4.9546914,1.5344487)(4.9574137,1.9544399)
%\psline[linecolor=white, linewidth=0.064](4.7546954,1.5357451)(4.757418,1.9557364)
%\psline[linecolor=white, linewidth=0.056](6.154008,1.9318976)(6.178912,5.773556)
%\psline[linecolor=white, linewidth=0.04](5.39658,2.2090702)(5.4197598,4.897691)
%\psline[linecolor=white, linewidth=0.04](3.5756953,0.6553755)(0.0,0.66677624)
%\psline[linecolor=white, linewidth=0.064](4.3511214,1.2675772)(3.9311235,1.2689164)
%\psline[linecolor=white, linewidth=0.064](4.350484,1.0675782)(3.9304857,1.0689174)
%\psline[linecolor=white, linewidth=0.064](4.349846,0.8675792)(3.9298482,0.86891836)
%\psline[linecolor=white, linewidth=0.064](4.349208,0.66758025)(3.9292097,0.6689194)
%\psline[linecolor=white, linewidth=0.064](4.34857,0.46758127)(3.9285722,0.4689204)
%\psline[linecolor=white, linewidth=0.064](4.3479323,0.2675823)(3.9279344,0.26892143)
%\psline[linecolor=white, linewidth=0.064](4.347295,0.06758331)(3.9272966,0.06892245)
%\psline[linecolor=white, linewidth=0.064](4.346657,-0.13241568)(3.926659,-0.13107653)
%\psline[linecolor=white, linewidth=0.064](4.3460193,-0.33241466)(3.9260213,-0.33107552)
%\psline[linecolor=white, linewidth=0.064](4.3453817,-0.53241366)(3.9253836,-0.5310745)
%\psline[linecolor=white, linewidth=0.064](4.3447437,-0.73241264)(3.924746,-0.7310735)
%\psline[linecolor=white, linewidth=0.064](4.344106,-0.9324116)(3.9241083,-0.9310725)
%\psline[linecolor=white, linewidth=0.064](4.3434687,-1.1324106)(3.9234705,-1.1310714)
%\psline[linecolor=white, linewidth=0.064](4.3428307,-1.3324096)(3.922833,-1.3310704)
%\psline[linecolor=white, linewidth=0.06](3.9594617,-0.12537041)(0.11774203,-0.11312124)
%\psline[linecolor=white, linewidth=0.04](3.6496027,-0.7971519)(0.07396873,-0.78575116)
%\psline[linecolor=white, linewidth=0.064](4.7890873,-1.6267434)(4.7894583,-2.0467434)
%\psline[linecolor=white, linewidth=0.064](4.989087,-1.6265666)(4.989458,-2.0465665)
%\psline[linecolor=white, linewidth=0.064](5.189087,-1.6263899)(5.1894584,-2.0463898)
%\psline[linecolor=white, linewidth=0.064](5.3890867,-1.6262138)(5.389458,-2.0462136)
%\psline[linecolor=white, linewidth=0.064](5.589087,-1.626037)(5.589458,-2.0460367)
%\psline[linecolor=white, linewidth=0.064](5.789087,-1.6258602)(5.789458,-2.04586)
%\psline[linecolor=white, linewidth=0.064](5.9890866,-1.6256834)(5.989458,-2.0456831)
%\psline[linecolor=white, linewidth=0.064](6.1890864,-1.6255066)(6.189458,-2.0455065)
%\psline[linecolor=white, linewidth=0.064](6.3890867,-1.6253299)(6.3894577,-2.0453296)
%\psline[linecolor=white, linewidth=0.064](6.5890865,-1.6251531)(6.5894575,-2.045153)
%\psline[linecolor=white, linewidth=0.064](6.7890863,-1.6249763)(6.789458,-2.0449762)
%\psline[linecolor=white, linewidth=0.064](6.989086,-1.6247995)(6.9894576,-2.0447993)
%\psline[linecolor=white, linewidth=0.064](7.189086,-1.6246227)(7.1894574,-2.0446227)
%\psline[linecolor=white, linewidth=0.064](7.3890862,-1.6244459)(7.389457,-2.0444458)
%\psline[linecolor=white, linewidth=0.064](7.687157,1.295917)(8.107154,1.2944022)
%\psline[linecolor=white, linewidth=0.064](7.6864357,1.0959183)(8.106433,1.0944035)
%\psline[linecolor=white, linewidth=0.064](7.6857142,0.8959196)(8.105712,0.89440477)
%\psline[linecolor=white, linewidth=0.064](7.684993,0.6959209)(8.10499,0.6944061)
%\psline[linecolor=white, linewidth=0.064](7.684272,0.4959222)(8.104269,0.4944074)
%\psline[linecolor=white, linewidth=0.064](7.6835504,0.2959235)(8.103548,0.29440868)
%\psline[linecolor=white, linewidth=0.064](7.682829,0.09592482)(8.102826,0.09440999)
%\psline[linecolor=white, linewidth=0.064](7.6821074,-0.10407388)(8.102105,-0.10558871)
%\psline[linecolor=white, linewidth=0.064](7.6813865,-0.3040726)(8.101383,-0.3055874)
%\psline[linecolor=white, linewidth=0.064](7.680665,-0.5040713)(8.100662,-0.5055861)
%\psline[linecolor=white, linewidth=0.064](7.6799436,-0.70407)(8.099941,-0.7055848)
%\psline[linecolor=white, linewidth=0.064](7.6792216,-0.90406865)(8.099219,-0.9055835)
%\psline[linecolor=white, linewidth=0.064](7.6785,-1.1040673)(8.098497,-1.1055822)
%\psline[linecolor=white, linewidth=0.064](7.6777787,-1.3040661)(8.097776,-1.3055809)
%\psline[linecolor=white, linewidth=0.04](8.362676,0.621239)(10.807869,0.6083426)
%\psline[linecolor=white, linewidth=0.06](7.9829845,-0.102550365)(10.816003,-0.1164065)
%\psline[linecolor=white, linewidth=0.04](8.488185,-0.83133376)(10.724684,-0.8442302)
%\psline[linecolor=white, linewidth=0.04](5.4045844,-2.330671)(5.407745,-5.906322)
%\psline[linecolor=white, linewidth=0.04](6.856658,-2.3207686)(6.8598185,-5.8964195)
%\psline[linecolor=white, linewidth=0.062](6.200657,-2.0482898)(6.2040524,-5.8900275)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{<-}(8.934467,0.94248664)(9.699682,0.94057196)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(9.268072,0.94156265)(9.260686,1.37628)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(9.646988,0.40239954)(9.020901,0.40239954)(9.020901,0.08935605)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(6.617592,-3.3648658)(6.609957,-2.7388253)(6.296937,-2.7426426)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{<-}(7.0376425,-2.6256766)(7.0409856,-3.3908868)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(7.0390105,-2.9592798)(7.4736667,-2.9489067)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{<-}(3.0575929,-1.0455052)(2.2924063,-1.0386413)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(2.7240014,-1.0424235)(2.7285757,-1.4771795)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(2.34606,-0.5865839)(2.972145,-0.5850885)(2.9713974,-0.2720459)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{<-}(5.116778,2.5837893)(5.099463,3.348811)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(5.1093183,2.9173117)(4.674924,2.899004)
%\psline[linecolor=black, linewidth=0.04, arrowsize=0.05291667cm 2.0,arrowlength=1.4,arrowinset=0.0]{->}(5.670701,3.2833939)(5.6747518,2.65732)(5.9877887,2.6593451)
%\rput[bl](10.34264,0.15892127){1}
%\rput[bl](1.4904659,-1.1976005){2}
%\rput[bl](6.48177,-4.3454266){3}
%\rput[bl](4.9513354,4.4023995){4}
%\rput[bl](1.4730746,-0.5541222){5}
%\rput[bl](10.325249,0.95892125){6}
%\rput[bl](5.7513356,4.3850083){7}
%\rput[bl](7.1252484,-4.362818){8}
%\end{pspicture}
%}
%\end{center}
%\caption{Schematic illustration of the studied intersection}
%\label{fig:intersection}
%\end{figure}
To control the signal timing of each direction, we apply the dual-ring approach shown in Figure \ref{fig:phase}. According to the dual-ring approach, movements 1, 2, 3 and 4 are included in ring 1 and ring 2 includes the remaining movements. The two rings operate independently, except for the timing of the barrier that they share. On either side of the barrier, there are four movements and each of the four may
have the right-of-way simultaneously with the other two movements from the other ring. Thus, the purpose of the traffic signal control is to determine the barrier time and also the green time duration allocated to each of these movements in each cycle. In this work, we assume no phase will be skipped during a traffic light cycle, i.e., all the movements will be served during each cycle.

Let us denote the time that the green light for the movement $j \in \mathcal{J} = \{\text{1, 2, 3, 4, 5, 6, 7, 8} \}$ in the $c$-th cycle starts and ends by $t^{\mathrm{s}_c}_j$ and $t^{\mathrm{e}_c}_j$ respectively. We also collect the start and end of green light of movement $j$ in $L$ traffic light cycles with $T_j =(t^{\mathrm{s}_1}_j, \dots, t^{\mathrm{s}_L}_j, t^{\mathrm{e}_1}_j, \dots, t^{\mathrm{e}_L}_j)$ and define the stacked signal timing of all movements in $\mathcal{J} $ as $\bm{T} = (T_{1}, \dots, T_{8})$. Finally, let $\mathcal{F}$ denotes the set of all consecutive pairs of movements in each ring, e.g. $\mathcal{F}$ will include the movements pairs of (1,2) and (6,7).

According to the dual-ring approach, the allocated timing of all movements must meet certain constraints. These constraints concern the green light duration and some safety measures. To be more specific, the minimum and maximum duration of the green time of each movement in cycle $l$ should be limited with $g^\mathrm{{min}}$ and $g^\mathrm{{max}}$ respectively:
\begin{equation}
g^\mathrm{{min}} \leq t^{\mathrm{e}_l}_j - t^{\mathrm{s}_l}_j \leq g^\mathrm{{max}},\quad \forall j\in \mathcal{J}, \forall l\in \mathbb{I}_{[1,L]}. \label{eq:gmin}
\end{equation}
where $ \mathbb{I}_{[1,L]}$ collects the integer numbers in the interval of $[1,L]$.  In order to preserve safety, after the end of green light of each movement, clearance time, denoted by $ t^{\mathrm{clr}}$, should be imposed before the next movement in the ring can have the right-of-way: 
\begin{equation}
t^{\mathrm{s}_l}_{j'} - t^{\mathrm{e}_l}_j = t^{\mathrm{clr}},\quad \forall (j',j) \in \mathcal{F}.\label{eq:clearance}
\end{equation}
Moreover, the barrier time in cycle $l$ should be the same in both rings:
\begin{equation}
t_{\mathrm{6}}^{\mathrm{e}_l} = t_{2}^{\mathrm{e}_l} ,\quad \forall l\in \mathbb{I}_{[1,L]}\label{eq:barrier}
\end{equation}




Moreover,
\begin{equation}
t_{\mathrm{4}}^{\mathrm{e}_l} = t_{8}^{\mathrm{e}_l} ,\quad \forall l\in \mathbb{I}_{[1,L]}\label{eq:end}
\end{equation}
%\begin{align}
%&g_\mathrm{{min}} \leq t^j_{e_l} - t^j_{s_l} \leq g_\mathrm{{max}},\quad \forall j\in \mathcal{J}, \forall l\in \mathbb{I}_{[1,L]} \label{eq:gmin}\\
%&t^{j'}_{s_l} - t^{j}_{e_l} = t_{clr}\quad, \forall (j',j) \in \mathcal{F}\label{eq:clearance}\\
%&t^{EBT}_{e_l} = t^{WBT}_{e_l} , \forall l\in \mathbb{I}_{[1,L]}\label{eq:barrier}
%\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Vehicle dynamics}

We assume that the motion of vehicle $i$ moving in movement $j$ can be described by
\begin{align}
&\dot{x}_{i,j}^\mathrm{c}(t) = f_{i,j}\bigl(x_{i,j}^\mathrm{c}(t), u_{i,j}^\mathrm{c}(t)\bigr),\label{eq:dynamics-continuous}\\
&g^\mathrm{c}_{i,j}\bigl(x_{i,j}^\mathrm{c}(t), u_{i,j}^\mathrm{c}(t)\bigr) \leq 0\label{eq:constraint-continuous}
\end{align}
where $x^\mathrm{c}_{i,j}(t)$ and  $u^\mathrm{c}_{i,j}(t) $ denote the state and control input of the system and the function $g^\mathrm{c}_{i,j}$ captures the possible constraints on the state and the control input. The state vector collects the position, $p^\mathrm{c}_{i,j}(t)$, and speed, $v^\mathrm{c}_{i,j}(t)$, of the vehicle, i.e., $x^\mathrm{c}_{i,j}(t) = \bigl( p^\mathrm{c}_{i,j}(t), v^\mathrm{c}_{i,j}(t) \bigr)$. 

For practical reasons, we formulate the optimization problem in a discrete-time setting. Therefore, with a sampling time $t_\mathrm{s}$, the evolution of the vehicle state and control input during a fixed time horizon $t_\mathrm{f} = M t_\mathrm{s}$ is described by $ x_{i,j} = \bigl(x_{i,j}^{0}, x_{i,j}^1\dots x_{i,j}^{M}\bigr)$ and $ u_{i,j} = \bigl(u_{i,j}^{0}, u_{i,j}^{1}\dots u_{i,j}^{M}\bigr)$ respectively. For horizon $t_\mathrm{f}$, multiple shooting discretisation of  \eqref{eq:dynamics-continuous} and \eqref{eq:constraint-continuous} \cite{NumericalOpt} results in the following equations
\begin{eqnarray}
&x_{i,j}^{k+1} = F_{i,j}\bigl(x_{i,j}^{k}, u_{i,j}^{k}, t_s\bigr), \quad &k\in \mathbb{I}_{[0,M-1]}\label{eq:dynamics-dis}\\
&g_{i,j}\bigl(x_{i,j}^{k}, u_{i,j}^{k}\bigr) \leq 0, \quad &k\in \mathbb{I}_{[0,M-1]}\label{eq:constraint-dis}
\end{eqnarray}
where $x_{i,j}^{k} = (p_{i,j}^{k}, v_{i,j}^{k})$. As it will be of use in the optimization problem formulation, we define $W_j = (w_{1,j}, \dots w_{N_j,j})$ to collect the state and control input of all the $N_j$ vehicles in movement $j$, where $w_{i,j} =( x_{i,j}, u_{i,j})$. We also define $\bm{W} = (W_1, \dots, W_8)$ to collect the state and control input of all vehicles in all movements.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Collision avoidance}
For all vehicles to move safely in all directions and at all times, two sets of precautionary measures must be taken to prevent rear-end collisions for vehicles moving in the same movement and to prevent side collisions for vehicles moving in movements with conflicts within the intersection. In the following, it is explained how the former is achieved by keeping a safe headway between the vehicles, while the latter is obtained by preventing vehicles from red light running. 

In order to avoid rear-end collisions of vehicles, all vehicles must keep a safe headway $h$ with their preceding vehicle. Hence, if vehicle $i$ moves in front of vehicle $i+1$ in movement $j$, the following inequality constraint must hold for their positions:
\begin{equation}\label{eq:rear-end}
p_{i+1,j}^{k} +h \leq p_{i,j}^{k},\quad  \forall i\in\mathbb{I}_{[1,N_{j}-1]},  \forall k\in \mathbb{I}_{[0,M]}.
\end{equation}
We note here that there is no need to incorporate collision avoidance constraints for vehicles coming from different origins but moving in the same direction after the intersection:  They either will move in different lanes thanks to Assumption \ref{ass:turn}, ensuring separation, or they will move in the same lane but thanks to Assumption \ref{ass:downstream}, will have a safe enough distance from each other. Vehicles in movements 3 and 6 are an example of the former case; After the intersection, they drive in the same direction but in different lanes. Vehicles in movements 4 and 6 are an example of the latter case; they will drive in the same lane after the intersection, though there exists a gap of at least $g^\mathrm{min}+ 2t^\mathrm{clr}$ seconds between the two movements getting the right-of-the-way. Thanks to Assumption \ref{ass:downstream}, vehicles in movement 6 will be able to move far upstream of the intersection before the first vehicle in movement 4 passes the intersection. 

Vehicles moving toward the intersection should only pass the intersection when they have the right-of-way. Let $p_{i,j}(\tau,w_{i,j})$ denotes the position of vehicle $i$ moving in direction $j$ at time $\tau$ and be defined as 
\begin{equation}
p_{i,j}(\tau,w_{i,j}) \coloneqq [1, 0] \, F_{i,j}\bigl(x_{i,j}^{k}, u_{i,j}^{k}, \tau - kt_s\bigr),
\end{equation}
where $k = \floor{\frac{t}{t_s}}$ and $\floor{.}$ denotes the floor function. Note that $\tau$ does not necessarily need to be an integer multiple of $t_\mathrm{s}$. A necessary set of conditions that allows $r_j$ out of $N_j$ vehicles in movement $j$ to pass the intersection during the green light period in the the $c$-th cycle is
\begin{align}
p_{i,j}(t^{\mathrm{s}_c}_j, w_{i,j})& \leq X, \quad \forall i \in \mathbb{I}_{[1,N_j]},\label{eq:green1}\\
p_{i,j}(t^{\mathrm{e}_c}_j, w_{i,j}) &\geq X, \quad\forall i \in \mathbb{I}_{[1,r_j]}, \label{eq:green2}\\
p_{i,j}(t^{\mathrm{s}_{c+1}}_j, w_{i,j}) &\leq X, \quad\forall i \in \mathbb{I}_{[r_j+1, N_j]}. \label{eq:green3}
\end{align}
Equation \eqref{eq:green1} ensures that no vehicle in movement $j$ crosses the intersection before the corresponding light turns green. By meeting \eqref{eq:green2}, the initial $r_j$ vehicles in movement $j$ pass the intersection before the light turns red. Complying with \eqref{eq:green3} prevents the remaining vehicles from crossing the intersection until the start of movement $j$'s green light period in the next cycle.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Coordination problem}
Having all the ingredients, the optimal control formulation of the vehicles and traffic light cooperation problem reads :
\begin{subequations}\label{eq:min1}
\begin{align}
\min_{\bm{T},\bm{W},\bm{r}} \quad &O(\bm{W})\\
\text{s.t.} \quad&\eqref{eq:gmin},\eqref{eq:clearance}, \eqref{eq:barrier},\\
&\eqref{eq:dynamics-dis}, \eqref{eq:constraint-dis},\quad \forall j \in \mathcal{J}, \forall i\in\mathbb{I}_{[1,N_j-1]},\\
& \eqref{eq:rear-end}, \eqref{eq:green1}, \eqref{eq:green2},\eqref{eq:green3},\quad  \forall j \in \mathcal{J},
\end{align}
\end{subequations}
where $\bm{r} =(r_1,\dots, r_8)$ and $O(\bm{W}) = \sum_{j=1}^{8} \sum_{i=1}^{N_j} o_{i,j}(w_{i,j})$ where $o_{i,j}(w_{i,j})$ denotes the objective function of vehicle $i$ in movement $j$ and defined as
\begin{equation}
o_{i,j}(w_{i,j}) =  \sum_{k=0}^{M-1}l_{i,j}(x_{i,j}^k, u_{i,j}^k).
\end{equation}
Here, the  twice continuously differentiable function $l_{i,j}(x_{i,j}^k, u_{i,j}^k)$ describes the performance
metric of the vehicle.% and $ \phi_i^j(x_{i,M})$ is the terminal cost. 

Problem \eqref{eq:min1} is a challenging mixed-integer nonlinear program, especially for large instances. To address this challenge, we outline a decomposition method for obtaining an approximate solution to problem \eqref{eq:min1}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Decomposition}\label{sec:decomposition}
In our two-level decomposition method, the top level addresses the green time allocation problem for all movements, given $\bm{W}$ and $\bm{r}$. The lower level involves an optimization problem for each movement. Specifically, problem \eqref{eq:min1} can be decomposed as follows

\begin{subequations}\label{eq:min_decompose1}
\begin{align}
\min_{\bm{T}} \quad &\sum_{j=1}^{8}\Phi_j(T_j)\\
\text{s.t.} \quad&\eqref{eq:gmin},\eqref{eq:clearance}, \eqref{eq:barrier},
\end{align}
\end{subequations}
where $\Phi_j(T_j)$ is the solution of the following parametric optimization problem for the $j$th movement:
\begin{subequations}\label{eq:min_decompose2}
\begin{align}
\Phi_j(T_j) = \min_{r_j, W_j} \quad &\sum_{i=1}^{N_j}o_{i,j}(w_{i,j})\label{eq:min_decompose2_1}\\
\text{s.t.} \quad&\eqref{eq:dynamics-dis}, \eqref{eq:constraint-dis},\quad  \forall i\in\mathbb{I}_{[1,N_j-1]},\\
& \eqref{eq:rear-end}, \eqref{eq:green1}, \eqref{eq:green2},\eqref{eq:green3}.  
\end{align}
\end{subequations}
Note that in general, \eqref{eq:min_decompose2} remains a mixed-integer NLP problem due to the integer nature of $r_j$, representing the number of vehicles passing the current or the first upcoming green light in movement $j$. However, $\Phi_j(T_j) $ can be found equivalently by solving $N_j+1$ independent NLP problems in parallel, corresponding to all $N_j+1$ possible values that $r_j$ may take, and looking for the one that results in the minimum value of the cost. That is to say,
\begin{equation}\label{eq:minfunc}
\Phi_j(T_j) = \text{min}\left\{\tilde{\Phi}_{j_0}(T_j),\dots,\tilde{ \Phi}_{j_{N_j}}(T_j)\right\}.
\end{equation}
The cost $\tilde{\Phi}_{j_b}(T_j)$, for $b\in \mathbb{I}_{[0,N_j]}$, is the solution of the optimization problem \eqref{eq:min_decompose2} when $r_j =b$,  i.e., when $b$ vehicles in the $j$th movement pass the intersection during the corresponding green interval of the $c$-th cycle. This optimization problem reads 
\begin{subequations}\label{eq:min_decompose3}
\begin{align}
\tilde{\Phi}_{j_b}(T_j) =\nonumber\\
 \min_{ W_j} \quad &\sum_{i=1}^{N_j}o_{i,j}(w_{i,j})\\
\text{s.t.} \quad&\eqref{eq:dynamics-dis}, \eqref{eq:constraint-dis},\quad  \forall i\in\mathbb{I}_{[1,N_j-1]},\\
& \eqref{eq:rear-end}, \\
&p_{i,j}(t^{\mathrm{s}_c}_j, w_{i,j}) \leq X_j, \quad \forall i \in \mathbb{I}_{[1,N_j]},\label{eq:green1_b}\\
&p_{i,j}(t^{\mathrm{e}_c}_j, w_{i,j}) \geq X_j, \quad\forall i \in \mathbb{I}_{[1,b]}, \label{eq:green2_b}\\
&p_{i,j}(t^{\mathrm{s}_{c+1}}_j, w_{i,j}) \leq X_j, \quad\forall i \in \mathbb{I}_{[b+1, N_j]}. \label{eq:green3_b}  
\end{align}
\end{subequations}

Having the solution of problem \eqref{eq:min_decompose3} for all values of $b$, $\Phi_j(T_j)$ can be obtained using \eqref{eq:minfunc}. The resulting function will be non-smooth and hence not suitable for the gradient-based algorithm which will be used to solve \eqref{eq:min_decompose1}. Hence, \eqref{eq:minfunc} is approximated with the following smooth function:
\begin{equation}\label{eq:logapproximation}
\Phi_j(T_j) \approx -\frac{1}{\beta} \text{ log }\sum_{b=0}^{N_j}\exp\left(-\beta \,\tilde{\Phi}_{j_b}(T_j)\right),
\end{equation}
for $\beta>1$ \cite{Jamshidnejad:2018aa}.

Let us summarise the proposed decomposition method. To provide the cost function of the optimization problem in the higher level, $8(N_j+1)$ optimization problems of type \eqref{eq:min_decompose3} should be solved in the lower level. Namely, for each movement $j$ and given the initial value of $W_j$ from all vehicles in the movement, the optimization problem \eqref{eq:min_decompose3} should be solved for all possible values of $b$ in order to calculate $\Phi_j(T_j)$ using \eqref{eq:logapproximation}. Note that all of these optimization problems can be solved in parallel. We defer the discussion concerning the computational demand of the approach to Section \ref{sec:computation}.

Having $\Phi_j(T_j)$ for all $j$, the following section explains how some tools from parametric optimization method can be used in order to solve \eqref{eq:min_decompose1}.
%Before elaborating on the solution approach for solving \eqref{eq:min_decompose1}, let us make some notes on the optimality condition of problem \eqref{eq:min_decompose3}, as it will be of use in the subsequent sections.
%Under the assumption that Linear Independence Constraint Qualification (LICQ) holds \cite{}, The primal dual solution

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{solution approach}\label{sec:solution}
In this section, we explain a numerical algorithm to solve problem \eqref{eq:min_decompose1} by using sequential quadratic programming (SQP). SQP is selected due to its faster convergence compared to first-order methods and due to possibility of deriving the required derivatives in generating the SQP by deploying tools from parametric optimization. For notational convenience, let us rewrite problem \eqref{eq:min_decompose1} in a more condense form as
%%%%%%%%%%%%%
\begin{subequations}\label{eq:condense}
\begin{align}
\min_{\bm{T}} \quad &\sum_{j=1}^{8}\Phi_j(T_j),\\
\text{s.t.} \quad&C\bm{T}\leq 0,\label{eq:condense_ineq}\\
&D\bm{T} =0,\label{eq:condense_eq}
\end{align}
\end{subequations}
%%%%%%%%%%%%%
where \eqref{eq:condense_ineq} and \eqref{eq:condense_eq} respectively collect all the inequality and equality constraints associated with \eqref{eq:gmin}-\eqref{eq:barrier}. By use of the SQP algorithm, the solution to \eqref{eq:condense} is obtained through the following iterations:
%%%%%%%%%%%%%
\begin{align}
\bm{T}^{+} &=\bm{T} + \alpha \Delta \bm{T},\\
{\mu}^{+} &= (1-\alpha){\mu} + \alpha \mu^{\mathrm{QP}},\\
{\lambda}^{+} &=(1-\alpha){\lambda} + \alpha \lambda^{\mathrm{QP}},
\end{align}
%%%%%%%%%%%%%
where $(.)^{+}$ denotes the value of the corresponding variable in the next iteration, $\mu$ and $\lambda$ are the vector of multipliers associated with constraints \eqref{eq:condense_ineq} and \eqref{eq:condense_eq} respectively, $\alpha \in (0,1]$ is the step size to be adjusted using the available algorithms like line-search and $\Delta \bm{T}$, $\mu^{\mathrm{QP}}$, and $\lambda^{\mathrm{QP}}$ are the primal-dual solution of the following QP problem:
%%%%%%%%%%%%%
\begin{subequations}\label{eq:QP}
\begin{align}
\min_{\Delta\bm{ T}} \quad &\frac{1}{2}  \Delta\bm{ T}^{T}H(\bm{T},\mu, \lambda) \Delta\bm{ T}  + \bm{\Phi}(\bm{T})\Delta\bm{T}  \label{eq:QP1}     \\
\text{s.t.} \quad&C\bm{T} + C\Delta\bm{T}\leq 0,\label{eq:QP2}\\
&D\bm{T}+ D\Delta\bm{T} =0,\label{eq:QP3}
\end{align}
\end{subequations}
%%%%%%%%%%%%%
with 
\begin{equation}\label{eq:gradient}
\bm{\Phi}(\bm{T}) = [\nabla^T\Phi_1(T_1), \nabla^T\Phi_2(T_2),\dots, \nabla^T\Phi_8(T_8)].
\end{equation}
In \eqref{eq:QP1}, $H$ is the Hessian of the Lagrange function of problem \eqref{eq:condense}, which is defined as
\begin{equation}
\mathcal{L} (\bm{T},\mu, \lambda)= \sum_{j=1}^{8}\Phi_j(T_j) + \mu^{T}C\bm{T} + \lambda^TD\bm{T}.
\end{equation}
Note that since all of the constraints associated to problem \eqref{eq:condense} are linear, the Hessian $H$ is a block diagonal matrix with its $j$-th block obtained from
\begin{equation}\label{eq:hessian}
H_j = \nabla^2\Phi_j(T_j).
\end{equation}
where regularization is used when $H_j$ is not positive definite \cite{NumericalOpt}.\\
From \eqref{eq:gradient} and \eqref{eq:hessian}, it is clear that first-order and second-order derivatives of $\Phi_j(T_j)$ are required for solving the QP problem \eqref{eq:QP} and subsequently, finding the solution of \eqref{eq:condense}. The following subsection details the required steps for computing these derivatives.
%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Computing derivatives}
%Before going into detail about calculating derivatives, let us first discuss the continuity class of the functions $\Phi_j(T_j)$. {\red{...to be completed}}%From \eqref{}, it can be inferred that $\Phi^j(T^j)$ inherits the continuity class of $\Phi^j_{b}(T^j)$, which is the same for all values of $b$.

If the $o$-th entry of $T_j$ is denoted by $T^o_j$, from \eqref{eq:logapproximation} and as it is derived in Appendix \ref{app:sumlog}, the first-order and second-order derivative of  $\Phi_j(T_j)$ with respect to $T^o_j$ are given by
\begin{equation}\label{eq:exp_first_derivative}
\dv{\Phi_j(T_j)}{T^o_j} =  \displaystyle\frac{\displaystyle \sum_{b=0}^{N_j} \displaystyle   \dv{\tilde{\Phi}_{j_b}(T_{j})}{T^o_j}  \exp\left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)}{{\displaystyle\sum_{b=0}^{N_j}  \exp\left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)}},
\end{equation}
and
\begin{align}\label{eq:exp_second_derivative}
&\dv[2]{\Phi_j(T_j)}{{T^o_j}} = \displaystyle \beta \left( \frac{\displaystyle \sum_{b=0}^{N_j} \displaystyle \dv{\tilde{\Phi}_{j_b}(T_{j})}{T^o_j} \exp \left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)} {\displaystyle\sum_{b=0}^{N_j}  \exp\left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)}   \right)^2 \nonumber\\
%%%%%%%%%%%%%%
 & + \frac{ \displaystyle\! \sum_{b=0}^{N_j}\! \exp \left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right) \!\left(\! \left(\dv{\tilde{\Phi}_{j_b}(T_{j})}{T^o_j}\right)^2 \!\!-\beta \!\!    \left(\dv[2]{\tilde{\Phi}_{j_b}(T_{j})}{{T^o_j}}\right)\!\right)}             {\displaystyle\sum_{b=0}^{N_j} \! \exp \left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)}.
\end{align}
Therefore, in order to calculate the terms in \eqref{eq:exp_first_derivative} and \eqref{eq:exp_second_derivative}, the first-order and second-order derivatives of the solution of \eqref{eq:min_decompose3} with respect to $T^o_j$ (and in general $T_j$) are required.  We note here that knowing $o_{i,j}$ and constraints in \eqref{eq:min_decompose3} are twice differentiable, and assuming that in  \eqref{eq:min_decompose3}, at the solution $\bar{W}_j(T_j)$, linear independence constraint qualification (LICQ) and second-order sufficient condition (SOSC) \cite{NumericalOpt} holds $\forall T_{j}\in \mathcal{T}$, $\tilde{\Phi}_{j_b}(T_{j})$ will be piece-wise twice continuously differentiable on $\mathcal{T}$ with the undefined derivatives corresponding to the points where change in active sets occurs \cite{sensitivity}. Moreover, using primal-dual interior point algorithm and proper use of barrier parameters to solve \eqref{eq:min_decompose3} will circumvent the notion of weakly active constraints and hence the resulting $\tilde{\Phi}_{j_b}(T_{j})$ would be twice continuously differentiable $\forall T_j \in \mathcal{T}$.

\subsubsection*{First-order derivatives}For the sake of explanation, let us choose $T^o_j $ to be  $t^{s_c}_j$ . If $\mathcal{L}_{j_b}$ denotes the Lagrange function of \eqref{eq:min_decompose3}, $\bar{W}_j$ is the primal solution of \eqref{eq:min_decompose3} given a $T_j$,  $P_j(t^{s_c}_j, \bar{W}_j)$ is the stacked of constraints \eqref{eq:green1_b} for all $i$, and $\gamma$ is the vector of Lagrange multipliers associated to these constraints, then the first-order derivative of $\tilde{\Phi}_{j_1}(T_{j})$ with respect to $t^{s_c}_j$ is given by \cite{sensitivity}:

\begin{equation}\label{eq:first_derivative}
\dv{\tilde{\Phi}_{j_b}(T_{j})}{t^{s_c}_j} = \pdv{\mathcal{L}_{j_b}}{t^{s_c}_j} = \gamma^{T} \pdv{P_j(t^{s_c}_j, \bar{W}_j)}{t^{s_c}_j}.
\end{equation}
\subsubsection*{Second-order derivatives} Differentiating \eqref{eq:first_derivative} results in
 
\begin{align}\label{eq:second_derivative}
 \dv[2]{\tilde{\Phi}_{j_b}}{{t^{sc}_j}} = \left(  \dv{\gamma}{t^{sc}_j}\right)^T     \pdv{P_j}{t^{s_c}_j} +  
 \gamma^{T} \left( \pdv[2]{{P_j}}{{t^{s_c}_j}}   + \pdv{P_j}{t^{s_c}_j}{\bar{W}}  \dv{\bar{W}_j}{t^{s_c}_j}   \right)
\end{align} 
where the arguments in \eqref{eq:second_derivative} have been dropped for brevity. 

As seen in \eqref{eq:second_derivative}, calculating the second-order derivative of $\tilde{\Phi}_{j_1}$  hinges on finding the sensitivity of the primal solution ${\bar{W}_j}$ and the Lagrange multiplier ${\gamma}$ with respect to the corresponding parameter. To obtain the value of these terms, we make use of the KKT matrix in problem \eqref{eq:min_decompose3} and the KKT condition for optimality. The optimality condition is briefly explained in Appendix \ref{app:KKT}, and interested readers are referred to \cite{NumericalOpt} for more details.  

If the primal-dual solution of \eqref{eq:min_decompose3} for a given $T_j$ is denoted by $\bar{Y}(T_j) $, the KKT optimality condition at this point can be compactly written as:
\begin{equation}\label{eq:KKT}
K\left(\bar{Y}(T_j), T_j\right) = 0.
\end{equation} 
Thus, the differentiation of the KKT matrix $K$, yields a system of linear equations for the sensitivity differentials of the primal and dual solutions. For example, to find the value of  $\dv{\bar{W}_j}{t^{s_c}_j}$ and $\dv{\gamma}{t^{sc}_j}$, which are embedded in $\dv{Y}{t^{s_c}_j}$, it is sufficient to take the derivative of \eqref{eq:KKT} with respect to $t^{sc}_j$ to have
\begin{equation}\label{eq:KKT-derivative}
\dv{K}{t^{s_c}_j} = \pdv{K}{t^{s_c}_j} + \left(\nabla_Y K\right)^T \dv{Y}{t^{s_c}_j} = 0,
\end{equation} 
and solve this system of linear equations to find $\dv{Y}{t^{s_c}_j}$. Note that if \eqref{eq:min_decompose3} is solved using a second-order method, in its last iteration, the solver will have factorised the matrix $\nabla_Y K$ at the solution. Hence, evaluation of \eqref{eq:KKT-derivative} can be achieved with little additional computational cost and hence, the derivatives in \eqref{eq:first_derivative} and \eqref{eq:second_derivative} are cheap to compute.%Since for a given $T^j$, and at the optimal solution $\bar{Y}(T^j) $, the value of $ \pdv{K}{t^j_{sc}}$ and $\nabla_Y K$ are known, finding $\dv{Y}{t^j_{sc}}$, and subsequently $\dv{\bar{W}^j}{t^j_{s_c}}$ and $\dv{\gamma}{t^j_{sc}}$ amounts to solving the system of linear equations \eqref{eq:KKT-derivative}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%If there is no traffic lights nor any other vehicle,  the minimum time that takes a vehicle with initial condition $w0_i^j$ to exit the control zone can be obtained by
% ${\tau^m}_i^{j}$ = min 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Evaluation scenarios and results}\label{sec:case}
This section assesses the performance of the proposed approach through an illustrative case study and compares it to a baseline approach. We begin by introducing the motion model, primary and secondary control objectives, and the performance score used in the case studies.

\subsection{Motion model}

All controllers use the double integrator longitudinal dynamics, i.e., $f_{i,j}\big(x^\mathrm{c}_{i,j}(t),u^\mathrm{c}_{i,j}(t)\bigr)$ in \eqref{eq:dynamics-continuous} is defined as follows:
\begin{equation}
f_{i,j}\big(x^\mathrm{c}_{i,j}(t),u^\mathrm{c}_{i,j}(t)\bigr) = 
\begin{bmatrix}
\dot{p}^\mathrm{c}_{i,j}(t)\\
\dot{v}^\mathrm{c}_{i,j}(t)\\
\end{bmatrix}
=
\begin{bmatrix}
v^\mathrm{c}_{i,j}(t)\\
u^\mathrm{c}_{i,j}(t)\\
\end{bmatrix}
\end{equation}
Although the prediction model is simple, experimental results indicate that it is sufficient for similar applications \cite{Hult:2019aa}.
%%%%%%%%%%%%%%%
 \begin{table*}
 \centering
    \caption{Simulation parameters}
   % \begin{tabular}{cccccccccccccccccccc}
    \begin{tabular}{cccccccccccc}
    \hline\vspace{.1cm}
    $X(\si{m})$&$v^\mathrm{max}(\si{m/s})$&$v^\mathrm{min}(m/s)$&$v^\mathrm{d}(\si{m/s})$&$u^\mathrm{min}(\si{m/{s^2}})$&$u^\mathrm{max}$(m/${s^2}$)&$ t_s$(\si{s})&$h$(\si{m})&$t^\mathrm{cl}$(\si{s})&$g^\mathrm{max}(\si{s})\vspace{.1cm}$&$g^\mathrm{min}(s)$&$Q^\mathrm{u}$\\
   \hline\vspace{.1cm}
    200&14&0&12.27&-2&2&2&3&2&25&6&  2.5\\
   \hline\hline
    $Q^\mathrm{v}$&$m$(kg)&$A_\mathrm{f}$(\si{m^2})&$C_\mathrm{D}$&$\rho$(kg/m$^3$)&$C_\mathrm{r}$&$c_1$&$c_2$&$\eta$&$\alpha_0$&$\alpha_1$&$\alpha_2$\vspace{.1cm}\\%[5pt]
    \hline
    0.0153&1487&2.3&0.3&1.226&1.75&0.0328&4.575&0.92&4.89e-4&4.29e-5&1e-6
    % \hline
    \end{tabular}
    \label{table:parameters}
\end{table*}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Main objective function}
We aim to address the coordination of traffic lights and vehicle speeds, focusing on the conventional efficiency metric of acceleration variation while promoting comfortable cruising at a predefined desired speed

%For conventional vehicles, since over steady state operating points, i.e.\ constant torque and speed, internal combustion engines are optimized, to seek fuel consumption minimisation, we target on minimizing acceleration. Doing so, we minimize the transient engine operation that has direct benefits in fuel consumption~\cite{Malikopoulos:2018aa}. 
The corresponding objective function $o_{i,j}(w_{i,j})$ in \eqref{eq:min_decompose2_1} is therefore taken to be
\begin{equation}\label{eq:cost_fuel}
o_{i,j}(w_{i,j}) = \sum_{k=0}^{M-1} Q^\mathrm{u}(u_{i,j}^k)^2 + Q^\mathrm{v} (v_{i,j}^k - v^\mathrm{d}_{i,j})^2,
\end{equation}
Here, $Q^\mathrm{u}$ and $Q^\mathrm{v}$ are objective weights, and ${v^\mathrm{d}_{i,j}}$ represents the known desired speed of the $i$th vehicle in the $j$th movement. The second term in \eqref{eq:cost_fuel} accounts for individual vehicle preferences during trajectory optimization. The corresponding performance score for the quadratic objective \eqref{eq:cost_fuel} is calculated as the average value across all vehicles during the simulation.

\begin{equation}\label{eq:score_performance}
S^\mathrm{c} = \frac{1}{|\mathcal{N}|} \sum_{(i,j)\in \mathcal{N}}  \sum_{k=k^\mathrm{e}_{i,j}}^{k^\mathrm{l}_{i,j}}Q^\mathrm{u}(u_{i,j}^k)^2 + Q^\mathrm{v} (v_{i,j}^k - {v^\mathrm{d}}_{i,j})^2,
\end{equation}
where $\mathcal{N}$ collects the indices of all the vehicles that entered and left the control zone during the simulation time, $k^\mathrm{e}_{i,j}$ and $k^\mathrm{l}_{i,j}$ denote the time steps that the vehicle $i$ in movement $j$ enters and leaves the control zone respectively.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Secondary objective functions}
In all case studies, the objective function used in the optimization problem follows \eqref{eq:cost_fuel}. Additionally, we use total travel time and precise fuel consumption estimation as performance metrics to assess and compare the proposed control algorithm.
\subsubsection{Total travel time} We measure the total travel time of a vehicle $i$ in movement $j$ as the total time it takes the vehicle to travel through the control zone. If we denote this time with $\bar{t}_{i,j}$, the corresponding performance score reads 
\begin{equation}\label{eq:score_time}
S^\mathrm{t} = \frac{1}{|\mathcal{N}|} \sum_{(i,j)\in \mathcal{N}} \bar{t}_{i,j}
\end{equation}
Although not explicitly, the cost function in \eqref{eq:cost_fuel} indirectly incorporates travel time minimization in its second term by penalizing low velocities in case the desired velocity ${v^\mathrm{d}}_{i,j}$ takes relatively high value.\\

%%%%%%%%%%%%%%
\begin{table}
\caption{Demand  (\si{veh\per\hour\per lane}) in each movement corresponding to the Demand Profiles I, II, and III. }
\begin{center}
\begin{tabularx}{\columnwidth}{Xcccccccc}

\rot[90]{Demand Profile} &\rot[90]{Movement 1}&\rot[90]{Movement 2}& \rot[90]{Movement 3}& \rot[90]{Movement 4}&\rot[90]{Movement 5}& \rot[90]{Movement 6}& \rot[90]{Movement 7}& \rot[90]{Movement 8}\\[.02cm]\hline\hline
\rule{0pt}{1.1\normalbaselineskip} I& 800&800  &800&800&800&800&800&800 \\[.2cm]\hline
\rule{0pt}{1\normalbaselineskip} II&1000 &1000  &1000  &1000 & 1000& 1000 &1000&1000 \\
\rule{0pt}{1\normalbaselineskip} III&900 &1500  &400  &400 & 900& 1500 &400&400 \\
\end{tabularx}
\end{center}
\label{table:demand}
\end{table}
%%%%%%%%%%%%
\begin{table}
\caption{Simulation cases and their specifications }
\begin{center}
\begin{tabularx}{\columnwidth}{c>{\setlength\hsize{1\hsize}\centering}Xcc}
& The proposed control scheme & Demand Profile & Cycle length\\\hline\hline
\rule{0pt}{1.1\normalbaselineskip}Case 1& yes& I & not-fixed\\
\rule{0pt}{1.1\normalbaselineskip}Case 2& no & I & 54\\
\rule{0pt}{1.1\normalbaselineskip}Case 3& no&I&60\\
\rule{0pt}{1.1\normalbaselineskip}Case 4& yes &II& not-fixed\\
\rule{0pt}{1.1\normalbaselineskip}Case 5& no & II & 54\\
\rule{0pt}{1.1\normalbaselineskip}Case 6& no & II & 60\\
\rule{0pt}{1.1\normalbaselineskip}Case 7& yes &III& not-fixed\\
\rule{0pt}{1.1\normalbaselineskip}Case 8&no&III&54\\
\rule{0pt}{1.1\normalbaselineskip}Case 9&no&III&60\\
\end{tabularx}
\end{center}
\label{table:scenarios}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Explicit fuel consumption }
For a more accurate estimation of total fuel consumption, we employ the Virginia Tech comprehensive power-based fuel consumption model (VT-CPFM), a second-order polynomial model of the vehicle's power~\cite{VirginiaTech}. According to VT-CPFM, if the power of vehicle $i$ in movement $j$ at time $t$ is represented as $\mathcal{P}{i,j}(t)$ (kW), the fuel consumption rate of the vehicle denoted by $\mathcal{F}{i,j}(t)$ can be expressed as follows:
\begin{equation}\label{eq:VT-fuel}
\mathcal{F}_{i,j}(t) =
\begin{cases}
 \alpha_0 + \alpha_1 \mathcal{P}_{i,j}(t) + \alpha_2 \bigl(\mathcal{P}_{i,j}(t)\bigr)^2 & \forall \; \mathcal{P}_{i,j}(t) \geq 0\\\
\alpha_0 &  \forall \; \mathcal{P}_{i,j}(t) < 0
\end{cases}
\end{equation}
where $\alpha_0$, $\alpha_1$ and $\alpha_2$ are vehicle-specific model constants. The power exerted at any instant $t$ can be computed as
\begin{equation}\label{eq:VT-power}
\mathcal{P}_{i,j}(t) = \frac{R_{i,j}(t) + 1.04\, m u_{i,j}(t)}{1000 \eta}v_{i,j}(t),
\end{equation}
where $m$ is the vehicle mass (\si{kg}), and $\eta$ is the driveline efficiency. The resistance force $R_{i,j}(t)$ in \eqref{eq:VT-power} is computed as the sum of the aerodynamic, rolling, and grade resistance forces and reads
\begin{equation}\label{eq:VT-R}
R_{i,j}(t) = 0.5\, \rho\, C_\mathrm{D}A_\mathrm{f}\bigl(v_{i,j}(t)\bigr)^2 +  \frac{C_\mathrm{r}}{1000}m\,g\bigl(c_1v_{i,j}(t) + c_2\bigr) +  mg\,\tan(\theta).
\end{equation}
Here, $\rho$ represents air density (\si{kg/m^3}), $C_\mathrm{D}$ is the vehicle drag coefficient (unitless), $A_\mathrm{f}$ is the vehicle frontal area (\si{m^2}), and $g$ is the gravitational acceleration (9.8066 \si{m/s^2}). Additionally, $C_\mathrm{r}$, $c_1$, and $c_2$ are rolling resistance parameters. It's worth noting that the vehicle parameters in \eqref{eq:VT-power} and \eqref{eq:VT-R} are vehicle-specific, but for clarity, we omit indexing them in these equations. Furthermore, $\theta$ in \eqref{eq:VT-power} represents the road grade angle, which is assumed to be zero. The corresponding performance score for assessing the fuel consumption of all vehicles during the simulation time is defined as:
\begin{equation}\label{eq:score_fuel}
S^\mathrm{e} = \frac{1}{|\mathcal{N}|} \sum_{(i,j)\in \mathcal{N}}  \sum_{k=k^\mathrm{e}_{i,j}}^{k^\mathrm{l}_{i,j}} {\mathcal{F}}_{i,j}^k
\end{equation}
where ${\mathcal{F}}_{i,j}^k$ is the fuel consumption rate of vehicle $i$ in movement $j$ at time step $k$.
%In the first case study, we start with making observations on how the coordination between vehicles and traffic light may have a role in altering the vehicle's trajectories. In the second case study, we investigate the effect of the range of the control zone on the outcome.  In the third case study we benchmark the average performance of the proposed approach against an approach where there is no coordination between the traffic light timing and vehicle trajectory.
%\subsection{Arrival rate and arrival speed of vehicles}

\subsection{Computational demand}\label{sec:computation}
The algorithm requires several optimization control problems to be solved. Having said that, there exist various ways to reduce the computation time of the algorithm.
\subsubsection{Parallel computation}
Most of the optimal control problems (OCPs) formulated in Section \ref{sec:decomposition} can be solved in parallel. Specifically, the OCPs in \eqref{eq:min_decompose3}, formulated for all movements $j$ and all possible values of $b$ within each movement, are independent of each other and can be concurrently solved. Thus, neglecting the time to perform the computationally cheap step in \eqref{eq:logapproximation}, if we denote the computation time for solving the OCP of the form \eqref{eq:min_decompose3} for the pair $(j,b)$ as $\tilde{t}^j_{b}$, the time required to generate the cost function in \eqref{eq:min_decompose1} is:
%A large number of optimal control problems (OCP) formulated in Section \ref{sec:decomposition} can be solved in parallel. In particular, the OCPs in \eqref{eq:min_decompose3} formulated for all movements $j$ and all possible values of $b$ in each movement are independent of each other and hence, can be solved in parallel. Therefore, neglecting the time to perform the computationally cheap step in \eqref{eq:logapproximation}, if for the pair $(j,b)$, the computation time for solving the OCP of the form \eqref{eq:min_decompose3} is denoted by $\tilde{t}^j_{b}$, the required time for generating the cost function in \eqref{eq:min_decompose1} is  
\begin{equation}
 \max\{\tilde{t}^1_{0}, \tilde{t}^1_{1}, \dots \tilde{t}^8_{N^8}\}. 
\end{equation}

\subsubsection{Offline preparation phase}

The optimal problem in \eqref{eq:min_decompose3} is essentially a parametric NLP. The parameters include the initial value of the optimal control problem, i.e., the current speed and position of vehicles and the timing of the traffic light.  Hence, in the preparation phase, parametric NLP solvers can be created offline for all possible number of vehicles in the movement. In real-time, the parameters are measured online and then utilized with the corresponding pre-generated solver to obtain a new optimal solution for the system. Such an offline preparation phase can be easily accommodated using available softwares such as Casadi \cite{casadi}. 
%More advanced techniques such as Real Team Iteration (RTI) scheme \cite{RTI} can also be adopted for more time efficient computation of  
\subsubsection{Distributed optimization}

Using established distributed optimization algorithms \cite{boyd11}, each of the OCPs in the form of \eqref{eq:min_decompose3} can be decomposed into smaller OCPs suitable for parallel in-vehicle implementation. While the development of a distributed control algorithm to solve \eqref{eq:min_decompose3} is not within the scope of this article, efficient algorithms from previous studies for distributed control of vehicles at traffic intersections can be adapted for this purpose \cite{Shi2018,katriniok2021}.


%\subsubsection{Reducing the number of OCPs to be solved}
%Although in \eqref{eq:minfunc} all possible combinations of the number of passing vehicles are considered, in practice, a large number of these combinations can be easily ruled out with some {\red{heuristics. }}

%\subsection{Case study I}
%With a deliberate choice for the number of vehicles in each movement and their initial position and speed, this case study is designed to observe how incorporating the motion dynamics of vehicles into signal timing optimization may improve the performance of the system. 
%
%Let us assume that except for the first and second movements where respectively 7 and 10 vehicles are moving towards the intersection, in all the other movements only 3 vehicles exist. The initial speed and position of all the vehicles are reported in Table \ref{table:casestudy1-initialvalue}. 
\begin{figure}[t]
\centering{
\subfloat[\label{fig:scores-demanda}]{

%\input{barplot-800.tex}
\includegraphics[scale=0.45]{barplot-800-eps-converted-to.pdf}
}\\
\subfloat[\label{fig:scores-demandb}]{
%\input{barplot-1000.tex}
\includegraphics[scale=0.45]{barplot-1000-eps-converted-to.pdf}
}\\
\subfloat[\label{fig:scores-demandc}]{
%\input{barpolot-mix.tex}
\includegraphics[scale=0.45]{barpolot-mix-eps-converted-to.pdf}
}
\caption{Comparison of the scores in cases with the Demand Profile I (a), the Demand Profile II (b), and the Demand Profile III (c),}
\label{fig:scores-demand}
}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}[t]
\centering{
\subfloat[]{
\includegraphics[scale=0.49]{trajectory-movement2-demandmix-coordination-eps-converted-to.pdf}
}\\
\subfloat[]{
\includegraphics[scale=0.49]{trajectory-movement2-demandmix-Cycle54-eps-converted-to.pdf}
}\\
\subfloat[]{
\includegraphics[scale=0.49]{trajectory-movement2-demandmix-Cycle60-eps-converted-to.pdf}
}
\caption{Vehicles trajectory and traffic light timing in movement 2 in Case 7 (a), Case 8 (b), and Case 9 (c) }
\label{fig:trajectory}
}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Simulation results}

In this section, we present the results obtained through the application of the proposed scheme across various scenarios. To illustrate the viability of this scheme, we consider multiple demand profiles and compare its performance to the case where vehicle trajectory optimization is carried out alongside a traffic light featuring a fixed cycle but demand-dependent timing. Additionally, we provide results that analyze how the scheme's performance is affected by both the minimum green time duration and communication range. Finally, we compare the performance of the scheme with the state-of-the-art cooperative traffic light and vehicle speed control method proposed in \cite{Biao_xu-2019}.

\subsubsection{Impact of the traffic demand} 
To assess the proposed cooperative method under various traffic conditions, we conducted simulations with different demand profiles. As a reference for comparison, we benchmarked the proposed control algorithm against a baseline approach in which vehicle trajectories are optimized using \eqref{eq:min_decompose2}, while traffic light timing is not coordinated with the vehicles but is demand-dependent instead. We considered three sets of demand profiles as detailed in Table \ref{table:demand}, resulting in a total of nine cases. In three of these cases, we adopted the proposed control approach, while the remaining six cases were used for comparison, employing the baseline control approach with various cycle lengths. Table \ref{table:scenarios} summarizes the characteristics of each case, including the control approach, demand profile, and cycle length. % Concerning the cycle length, in scenarios 3 and 5, a cycle length of 60 seconds is chosen, and in scenarios 4 and 6, the minimum cycle length with regards to the demand profile and respecting the minimum green light is selected.
%

In each movement, the arrival rate is sampled from a Poisson distribution with a rate corresponding to the specific movement's demand. Additionally, the initial speeds of vehicles are randomly selected from a uniform distribution within the range of [$v^\mathrm{d} - 5, v^\mathrm{{max}}$]. If necessary, the arriving speed is adjusted to ensure that a rear-end collision can be avoided when the front vehicle brakes to its maximum capacity. For a fair comparison, cases with the same demand profile share the same initialization parameters. This means that the arrival times and initial speeds of vehicles entering the control zone are consistent across these cases.
%After 300 seconds, no new vehicle enters the control zone but the simulation in each case terminates only when all the vehicles have left the control zone. Parameter values used in this case study are reported in Table \ref{table:parameters}.


The scores corresponding to Demand Profiles I, II, and III, are compared in Figures \ref{fig:scores-demanda}, \ref{fig:scores-demandb}, and \ref{fig:scores-demandc}, respectively. When evaluating the performance metric $S^\mathrm{c}$, a noticeable improvement is observed when comparing Case 1, Case 4, and Case 7 with their counterparts, indicating the significant benefits of optimizing both trajectories and signal timings jointly. This improvement is more pronounced in all demand profiles compared to $S^\mathrm{t}$ and $S^\mathrm{e}$, as it is the explicit focus of \eqref{eq:min_decompose2}. Furthermore, although less prominent, the improvements observed in $S^\mathrm{t}$ and $S^\mathrm{e}$ are also a by-product of the proposed joint optimization framework.




% The result shows that it is significantly better in terms of the performance metric $S^\mathrm{c}$ to optimize the trajectories and signal timings jointly. With the demand profile I,  such coordination may result in $37.49\%$ improvement in $S^\mathrm{c}$ when demand-dependant traffic light timing with a cycle length of 60 second is used. Although Scenario 1 performs better than Scenario 4 in all three metrics, the difference between the two is not significant. This is mainly due to the observation that in cased of low arrival rates such as in demand profile I, the duration of green light of movements in scenario 1 is mostly close or equal to $g^\mathrm{min}$. This makes the performance of this scenario close to that of scenario 4.\\

As an example, in Figure \ref{fig:trajectory}, we illustrate the vehicle trajectories in Movement 2 for Case 7, Case 8, and Case 9, all of which use Demand Profile III (refer to Table \ref{table:scenarios}). It is evident from the figure that Case 7, with coordinated traffic light control, leads to smoother vehicle trajectories when passing the intersection. Similar improvements are observed in other movements.

%We also note that in general, with higher arrival rates in movements, the advantage of having the coordination between vehicles and traffic light is more pronounced. We highlight in particular the performance of Scenario 2 compared to the other two scenarios in terms of  $S^\mathrm{c}$. Similar trends can be observed in the other two performance metrics. This is mainly a consequence of the controller's ability to coordinate with the traffic lights to possibly let more vehicles pass the intersection with smoother trajectories in each movement's green duration.
%\begin{table}
%\caption{Demand in each movement for demand profiles I and II. The unit is \si{veh\per\hour} }
%\begin{center}
%\begin{tabularx}{\columnwidth}{X|cccccccc}
%%\backslashbox[\dimexpr\hsize+2\tabcolsep]{\rot[-45]{Demand}}{Movement}
%\diagbox[height=1.25\rotheadsize]{\raisebox{3ex}{Property}}{\raisebox{-4ex}{Concept}}
%&1&2& 3& 4&5& 6& 7& 8\\[.02cm]\hline
%\rule{0pt}{1.\normalbaselineskip}Demand Profile I& 800&800  &800&2400&400&400&800&1600 \\[.2cm]\hline
%\rule{0pt}{1.\normalbaselineskip}Demand Profile II&800 &2400  &800  &2400 & 800& 2400 &800&2400 \\
%\end{tabularx}
%\end{center}
%\label{table:demand}
%\end{table}


\subsubsection{Impact of the minimum green time} 
In the proposed algorithm, the minimum green time affects traffic light timing as per \eqref{eq:gmin}. To assess the impact of the minimum green time on the algorithm's performance, we conducted simulations where the minimum green time was chosen from the set {2, 4, 6}. The results for Demand Profile I and III are presented in Figure \ref{fig:scores-tgvary800} and Figure \ref{fig:scores-tgvary1000}, respectively. From the figures, it is clear that decreasing the minimum allowed green time leads to performance improvements, although not necessarily in a linear fashion. The most significant improvement is observed when reducing $g^\mathrm{min}$ from 6 to 4. Note that although in general, reducing the minimum green time may result in higher performance for vehicles, it's essential to consider other modes of transport, such as pedestrians and cyclists, when selecting a value for $g^{min}$, as reducing it may impact these modes differently.

\begin{figure}[h]
\centering{
\subfloat[\label{fig:scores-tgvary800}]{
\includegraphics[scale=0.51]{Fig-tgVary-demand800-eps-converted-to.pdf}
}\\
\subfloat[\label{fig:scores-tgvary1000}]{
\includegraphics[scale=0.51]{Fig-tgVary-demandMix-eps-converted-to.pdf}
}
\caption{Impact of the minimum green time on the scores (a) with the Demand Profile I, (b) with the Demand Profile III}
\label{fig:scores-tgvary}

}
\end{figure}

\subsubsection{Impact of the size of the control zone} 
To further evaluate the performance of the proposed scheme under various conditions, we conducted simulations where we adjusted the size of the zone in which vehicle speeds are optimized. In this setup, we varied the controlled zone's size, ranging from 200 meters to 400 meters to and from the intersection, while keeping all other variables and parameters constant. We selected Demand Profile III for this test. To ensure comparability, we calculated scores over a 200-meter range from the intersection. Figure \ref{fig:communication} illustrates the results, demonstrating that a larger control zone leads to improved performance across all three scoring indexes. A longer distance to the intersection enables vehicles to approach smoothly, significantly enhancing scores. We emphasize that the choice of an appropriate size of the control zone is a tradeoff between performance, communication cost, and equipment availability.

\begin{figure}[h]
\centering{
\includegraphics[scale=0.5]{scores-DemandVary-eps-converted-to.pdf}
\caption{Impact of the size of the control zone on the scores. The Demand Profile III is used to generate the simulation results}
\label{fig:communication}
}
\end{figure}



\subsubsection{Comparison with the state-of-the-art} 

We compared the performance of the proposed method with the state-of-the-art (SOTA) method proposed in \cite{Biao_xu-2019}, which utilizes a cooperative approach to traffic light timing optimization and vehicle speed control for automated vehicles in two parts, namely traffic optimization and vehicle speed control. The traffic optimization part uses the enumeration method to optimize the traffic signal timing and vehicle arrival times for a fixed cycle length to minimize the total travel time, whereas the vehicle speed control part uses a pseudospectral method to optimize the vehicle trajectories to minimize vehicle fuel consumption. We implemented the method for the problem formulation given in Section \ref{sec:problem}, and we used the quadratic objective \eqref{eq:cost_fuel} as the objective function for the vehicle speed control part for a fair comparison of the two methods. We refer readers to \cite{Biao_xu-2019} for more details about the SOTA method.

\begin{table*}
\centering
\caption{Scores of the proposed method and the state-of-the-art (SOTA) method for control zones of 200, 300, and 400 meters with the Demand Profile III.}
\begin{tabular}{@{\extracolsep{0.6cm}}m{1.3cm}m{1.3cm}@{\extracolsep{0cm}}m{1.3cm}@{\extracolsep{0.6cm}}m{1.3cm}m{1.3cm}@{\extracolsep{0cm}}m{1.3cm}@{\extracolsep{0.6cm}}m{1.3cm}m{1.3cm}@{\extracolsep{0cm}}m{1.3cm}m{1.3cm}}
\multicolumn{1}{c}{ } & \multicolumn{3}{c}{200-meter Control Zone} & \multicolumn{3}{c}{300-meter Control Zone} & \multicolumn{3}{c}{400-meter Control Zone}\\
\hline
\hline
 Method & $S^\mathrm{c}$ & $S^\mathrm{t}$ & $1000S^\mathrm{e}$ & $S^\mathrm{c}$ & $S^\mathrm{t}$ & $1000S^\mathrm{e}$ & $S^\mathrm{c}$ & $S^\mathrm{t}$ & $1000S^\mathrm{e}$ \\
 \hline
Proposed & $14.93$  & $23.41$ &  $13.62$ & $9.67$  & $31.17$ &  $18.10$& $5.94$  & $37.99$ &  $22.39$ \\
SOTA & $60.12$  & $42.93$ &  $22.64$ & $47.32$  & $49.26$ &  $26.75$ & $43.78$  & $58.71$ &  $32.40$ \\

\hline
\end{tabular}
\label{table:comparison}
\end{table*}


We tested the performance of the two methods using the Demand Profile III for control zones of 200, 300, and 400 meters. We used numerical experiments to tune the parameters of the SOTA method for achieving the best performance in each scenario. Based on our findings, we set the fixed cycle length of the SOTA method to 44, 48, and 50 seconds for the control zones of 200, 300, and 400 meters, respectively. Since the SOTA method does not calculate vehicle trajectories beyond the stop line, we utilized the trajectories of the vehicles from the moment they entered the intersection until they passed the stop line for calculating the scores. The corresponding scores of the methods are presented in Table \ref{table:comparison}. The results show that the proposed method outperforms the SOTA method with better performance, total arrival time, and explicit fuel consumption scores in each scenario. We can explain the reasons behind our method's superiority over the state-of-the-art approach primarily for the following two main reasons:


First, the SOTA method calculates the optimal traffic light timings and the arrival times at the end of each cycle with a fixed cycle length, whereas the proposed method calculates the optimal traffic light timings at each $t_\mathrm{s}$ seconds where the cycle length is flexible. Thus, the proposed method can control the traffic timings at a higher frequency and update the planned trajectories of the vehicles to minimize arrival times and move vehicles at the desired speed, resulting in smaller total travel time and performance scores than the SOTA method.

Second, the SOTA method minimizes the fuel consumption only in the vehicle speed control part, whereas the traffic optimization part calculates optimal traffic light timings to minimize the arrival times without considering the fuel consumption. On the other hand, the proposed method combines the traffic light timing optimization and the vehicle control together, adjusting the traffic light timing at the upper level to reduce the fuel consumption at the lower level. Therefore, it can achieve lower explicit fuel consumption and performance scores than the SOTA method.




\section{Conclusion}
In this study, we introduced a bi-level cooperative vehicle and traffic light control approach for a single signalized intersection. Our controller is designed to be versatile, not relying on specific vehicle dynamics or objective functions. This flexibility allows us to incorporate complex vehicle models and various objective functions into the framework. Furthermore, we don't constrain traffic light cycle times or require green light durations to be integer values. We also make no assumptions about vehicle arrival speeds or simplify vehicle trajectories.

We demonstrated that our optimization problem can be effectively solved using the proposed decomposition method and parametric optimization tools. The algorithm yielded promising results, particularly concerning selected objective functions and general metrics like travel time and fuel consumption, especially under high vehicle arrival rates.

Coordinating vehicle trajectories and traffic lights across a network of multiple intersections in urban settings holds promise for further improving network efficiency and reducing fuel consumption. This represents an important area for future research.

\section{Acknowledgement}

This project has received funding from the European Union’s Horizon 2020 research and innovation programme under the Marie Skłodowska-Curie grant agreement No 845948. This research has also received funding from the European Research Council (ERC) under the European Union's Horizon 2020 research and innovation programme (Grant agreement No. 101018826 - ERC Advanced Grant CLariNet).
%\begin{figure}[t]
%\begin{center}
%%\input{scenario-acceleration.tex}
%\input{scenario1-3-4.tex}
%\caption{Value of scores in scenario 1, 3 and 4}
%\label{fig:case1-1}
%\end{center}
%\end{figure}
%
%\begin{figure}[t]
%\begin{center}
%%\input{scenario-acceleration.tex}
%\input{scenario2-5-6.tex}
%\caption{Value of scores in scenario 2, 5 and 6}
%\label{fig:case1-1}
%\end{center}
%\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\appendices
\section{}\label{app:sumlog}
To derive \eqref{eq:exp_first_derivative}, \eqref{eq:exp_second_derivative}, let us first define $E$ as
\begin{equation}\label{eq:app_exp}
E = \sum_{b=0}^{N_j} \exp(-\beta \tilde{\Phi}_{j_b}(T_j)).
\end{equation}
The first and second derivative of $E$ with respect to ${T^o_j}$ is given by
%\begin{equation}\label{eq:app_dexp}
%\end{equation}

\begin{align}
\dv{E}{T^o_j} &= -\beta\sum_{b=0}^{N_j} \dv{\tilde{\Phi}_{j_b}}{T^o_j}\exp\left(-\beta \tilde{\Phi}_{j_b}(T_j)\right)\\
\dv[2]{E}{{T^o_j}} &= -\beta\sum_{b=0}^{N_j} \left(\dv[2]{\tilde{\Phi}_{j_b}}{{T^o_j}}-\beta \left(\dv{\tilde{\Phi}_{j_b}}{T^o_j}\right)^2\right)\exp(-\beta \tilde{\Phi}_{j_b}(T_j))\label{eq:app_dexp}
\end{align}
Having \eqref{eq:logapproximation} and \eqref{eq:app_exp}-\eqref{eq:app_dexp}, we can write

\begin{align}
\dv{\Phi(T_j)}{T^o_j} &= \frac{-1}{\beta} \displaystyle \frac{\displaystyle\dv{E}{T^o_j}}{E} \nonumber\\
&= \displaystyle\frac{\displaystyle \sum_{b=0}^{N_j} \displaystyle   \dv{\tilde{\Phi}_{j_b}(T_{j})}{T^o_j}  \exp\left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)}{{\displaystyle\sum_{b=0}^{N_j}  \exp\left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)}}
\end{align}
and
\begin{align}
&\dv[2]{\Phi(T_j)}{{T^o_j}} = \frac{-1}{\beta} \left( \displaystyle\frac{E\displaystyle\dv[2]{E}{{T^o_j}} - \left( \displaystyle\dv{E}{{T^o_j}}\right)^2}{E^2} \right)\nonumber\\
& =  \frac{1}{\beta}\left( \frac{\displaystyle\dv{E}{T^o_j}}{E} \right)^2  \frac{-1}{\beta} \left( \displaystyle\frac{\displaystyle\dv[2]{E}{{T^o_j}}}{E} \right) \\
& = \displaystyle \beta \left( \frac{\displaystyle \sum_{b=0}^{N_j} \displaystyle \dv{\tilde{\Phi}_{j_b}(T_{j})}{T^o_j} \exp \left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)} {\displaystyle\sum_{b=0}^{N_j}  \exp\left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)}   \right)^2  \nonumber\\
%%%%%%%%%%%%%%
 & +  \frac{ \displaystyle \sum_{b=0}^{N_j}\! \exp \left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right) \!\left(\! \left(\dv{\tilde{\Phi}_{j_b}(T_{j})}{T^o_j}\right)^2 \!\!-\beta \!\!    \left(\dv[2]{\tilde{\Phi}_{j_b}(T_{j})}{{T^o_j}}\right)\!\right)}             {\displaystyle\sum_{b=0}^{N_j}  \exp \left(-\beta\tilde{\Phi}_{j_b}(T_{j})\right)}.
\end{align}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{}\label{app:KKT}
Consider an optimization problem in a general form of 
\begin{subequations}\label{eq_app_kkt}
\begin{align}
\min_{u} \quad & \tilde{\Phi}(\tilde{u})\\
\text{s.t.}\quad& \tilde{g}(\tilde{u}) = 0\\
&\tilde{h}(\tilde{u})\leq 0.
\end{align}
\end{subequations}
Let us define $\tilde{z}= [\tilde{u}^T,  \tilde{\lambda}^T, \tilde{\mu}_{\mathbb{A}}^T]$ where $\tilde{\lambda}$ is the vector of multipliers associated with the equality constraint $\tilde{g}(\tilde{u})$ and $\tilde{\mu}_{\mathbb{A}}$ denotes the multipliers associated with the strictly active constraints $\tilde{h}_{\mathbb{A}}(\tilde{u})$, i.e. at the solution,  $\tilde{h}_{\mathbb{A}}^i(\tilde{u}) = 0$ and  $\tilde{\mu}^i_{\mathbb{A}} >0$. The KKT optimality condition states that if Linear Independence Constraint Qualification (LICQ) \cite{NumericalOpt} holds, the primal-dual solution $\tilde{z}^*$ will satisfy the following equation:
\begin{equation}K(\tilde{z}^*) = 
\begin{bmatrix}
\nabla_u\tilde{\mathcal{L}}(\tilde{z}^*)\\
\tilde{g}(\tilde{u}^*)\\
\tilde{h}_{\mathbb{A}}(\tilde{u}^*)
\end{bmatrix}
=0,
\end{equation}
where $\tilde{\mathcal{L}}(\tilde{z})$ is the Lagrange function of problem \eqref{eq_app_kkt}, which is given by
\begin{equation}
\tilde{\mathcal{L}}(\tilde{z}) = \tilde{\Phi}(\tilde{u}) + \tilde{\lambda}^T \tilde{g}(\tilde{u}) + \tilde{\mu}_{\mathbb{A}}^T\tilde{h}_{\mathbb{A}}(\tilde{u}).
\end{equation}
%\bibliographystyle{plainurl}%plain does not support url. it should be plainurl. 
\bibliographystyle{unsrt}% the url does not appear in unsrt
%\bibliographystyle{utphys}
%\bibliography{ITS20_MC}

\input{MC_Trafficlight_Vehicle_coordination-extended.bbl}


\end{document}

%%%%%%%%%%%%
%\begin{table}
%\caption{Scores value in Scenarios 1, 3, and 4}
%\begin{center}
%\begin{tabularx}{\columnwidth}{X>{\centering}X>{\centering}XX<{\centering}}
%& $S^c$ & $S^t$ & $S^e$\\\hline\hline
%\rule{0pt}{1.1\normalbaselineskip}Scenario 1& 21.4349&33.3308 &.264705 \\
%\rule{0pt}{1.1\normalbaselineskip}Scenario 3& 34.2900 & 38.9818 & .308689\\
%\rule{0pt}{1.1\normalbaselineskip}Scenario 4& 23.0386 & 33.7872  & .270497 \\
%\rule{0pt}{1.1\normalbaselineskip}improvement compared to Scenario 2&&&
%\end{tabularx}
%\end{center}
%\label{table:scenarios}
%\end{table}

%
%\begin{table}
%\caption{Scores value in Scenarios 2, 5, and 6}
%\begin{center}
%\begin{tabularx}{\columnwidth}{X>{\centering}X>{\centering}XX<{\centering}}
%& $S^c$ & $S^t$ & $S^e$\\\hline\hline
%\rule{0pt}{1.1\normalbaselineskip}Scenario 2& 21.7279&32.8989&0.0271 \\
%\rule{0pt}{1.1\normalbaselineskip}Scenario 5& 39.2972 &40.1253 &0.0328\\
%\rule{0pt}{1.1\normalbaselineskip}Scenario 6&36.5241 & 39.0692 &0.0317\\
%\end{tabularx}
%\end{center}
%\label{table:scenarios}
%\end{table}




%\begin{table}
%        \centering
%        \caption{Comparison of scores values in cases 1, 2, 3}
%        \label{table:case1}
%        \begin{tabular}{cccc}
%             %           \cline{2-10}           
%            &Scenario 1 & No joint optimization  & Improvement\\
%            \hline\hline
%            $S^\mathrm{c}$& 21.4349 &\begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}Scenario 3: 34.290 \\ \rule{0pt}{1.1\normalbaselineskip}Scenario 4 : 23.039\end{tabular}&
%               \begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}37.49\% \\ \rule{0pt}{1.1\normalbaselineskip} 6.96\%\end{tabular}\\\hline
%             $S^\mathrm{t}$& 33.3308 &\begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}Scenario 3: 38.982 \\ \rule{0pt}{1.1\normalbaselineskip}Scenario 4 : 33.787\end{tabular}&
%               \begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}16.64\% \\ \rule{0pt}{1.1\normalbaselineskip} 1.35\%\end{tabular}\\\hline
%             $S^\mathrm{e}$& .0270 &\begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}Scenario 3: 0.0298 \\ \rule{0pt}{1.1\normalbaselineskip}Scenario 4 : 0.0273\end{tabular}&
%               \begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}9.4\% \\ \rule{0pt}{1.1\normalbaselineskip} 1.1\%\end{tabular}\\\hline             
%        \end{tabular}
%\end{table}
%
%
%
%\begin{table}
%        \centering
%        \caption{Comparison of scores values in scenarios 2, 5, 6}
%        \label{table:case2}
%        \begin{tabular}{cccc}
%             %           \cline{2-10}           
%            &Scenario 2 & No joint optimization  & Improvement\\
%            \hline\hline
%            $S^\mathrm{c}$& 21.728 &\begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}Scenario 5: 39.297 \\ \rule{0pt}{1.1\normalbaselineskip}Scenario 6 : 36.524\end{tabular}&
%               \begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}44.71\% \\ \rule{0pt}{1.1\normalbaselineskip} 40.51\%\end{tabular}\\\hline
%             $S^\mathrm{t}$& 32.899 &\begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}Scenario 5: 40.125 \\ \rule{0pt}{1.1\normalbaselineskip}Scenario 6 : 39.069\end{tabular}&
%               \begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}18.01\% \\ \rule{0pt}{1.1\normalbaselineskip} 15.79\%\end{tabular}\\\hline
%             $S^\mathrm{e}$& 0.0275 &\begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}Scenario 5: 0.0312 \\ \rule{0pt}{1.1\normalbaselineskip}Scenario 6 : 0.0306\end{tabular}&
%               \begin{tabular}{@{}c@{}}\rule{0pt}{1.1\normalbaselineskip}11.86\% \\ \rule{0pt}{1.1\normalbaselineskip} 10.13\%\end{tabular}\\\hline             
%        \end{tabular}
%\end{table}
