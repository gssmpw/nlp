\section{Details of the Experiments}
\label{app:appC}

\subsection{Additional Type I Error Rate Results}
\label{app:appC1}
%
We also conducted experiments to investigate the type I error rate when the data dimension $d$ and the number of neighbors $k$ were changed.
%
Specifically, we changed $d \in \{1, 2, 5, 10\}$ and $k \in \{1, 2, 5, 10\}$, while setting the default parameters as $n=100$, $d=2$, and $k=1$.
% Furthermore, we conducted additional experiments where $d$ was changed, considering the case where $k \in \{1, 2, 5, 10\}$ was adaptively selected in a data-driven manner.
\red{
In addition, experiments with changing $d$ were also considered the case where $k$ was selected adaptively from $\{1, 2, 5, 10\}$ in a data-driven manner.
}
%
In all cases, we generated the datasets in the same way as \red{in the experiments on synthetic datasets} (\S{\ref{subsec:experiment_of_synthetic_data}}), and the results are shown in Figure \ref{fig:fpr_d}.
%
\begin{figure}[htbp]
  \begin{minipage}[b]{0.32\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/fpr/zinkou_knn_d.pdf}
      \subcaption{Data Dimension}
  \end{minipage}
  \begin{minipage}[b]{0.32\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/fpr/zinkou_knn_k.pdf}
      \subcaption{Number of Neighbors}
  \end{minipage}
  \begin{minipage}[b]{0.32\linewidth}
    \centering
    \includegraphics[width=0.98\linewidth]{Fig/fpr/zinkou_knn_kchoose_d.pdf}
    \subcaption{Adaptively Selected $k$}
\end{minipage}
  
  \caption{
      Type I error rate when changing the data dimension $d$ and the number of neighbors $k$.
      %
      Our proposed method (\texttt{Stat-kNNAD}), the ablation study (\texttt{w/o-pp}), and the Bonferroni method (\texttt{bonferroni}) successfully control the type I error rate across all settings.
      %
      \red{However, the naive method (\texttt{naive}) fails.
      %
      The results of the \texttt{bonferroni} are almost zero, because it is too conservative.
      }
  }
  \label{fig:fpr_d}
\end{figure}
%


\subsection{Additional Power Results}
\label{app:appC2}
%
We also conducted experiments to investigate the power when \red{the number of training data $n$}, the data dimension $d$ and the number of neighbors $k$ are changed.
%
\red{
We changed $n \in \{100, 200, 500, 1000\}$, $d \in \{1, 2, 5, 10\}$ and $k \in \{1, 2, 5, 10\}$  while setting the default parameters as $n=100$, $d=2$, $k=1$ and signal strength $\delta=5$.
}
%
Furthermore, we conducted additional experiments where $n$ and $d$ was changed, considering the case where $k$ was adaptively selected from $\in \{1, 2, 5, 10\}$ in a data-driven manner.
%
In all cases, we generated the datasets in the same way as \red{in the experiments on synthetic datasets} (\S{\ref{subsec:experiment_of_synthetic_data}}), and the results are shown in Figure~\ref{fig:power_fixed_k} and Figure~\ref{fig:power_adaptive_k}.


\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.32\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/power/zinkou_knn_pwr_n.pdf}
      \subcaption{Datasize }
  \end{minipage}
  \begin{minipage}[b]{0.32\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/power/zinkou_knn_pwr_d.pdf}
      \subcaption{Data Dimension }
  \end{minipage}
  \begin{minipage}[b]{0.32\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/power/zinkou_knn_pwr_k.pdf}
      \subcaption{Number of Neighbors}
  \end{minipage}
  \caption{
      Power for a fixed number of neighbors $k$. 
      %
      The results show the effect of changing the training dataset size $n$, the data dimension $d$, and $k$. 
      %
      Our proposed method (\texttt{Stat-kNNAD}) outperformed other methods \red{across} all settings.
  }
  \label{fig:power_fixed_k}
\end{figure}

\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.32\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/power/zinkou_knn_pwr_kchoose_n.pdf}
      \subcaption{Datasize}
  \end{minipage}
  \begin{minipage}[b]{0.32\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/power/zinkou_knn_pwr_kchoose_d.pdf}
      \subcaption{Data Dimension}
  \end{minipage}
  \caption{
      Power for an adaptively selected number of neighbors $k$. 
      %
      The results show the effect of changing the training dataset size $n$ and the data dimension $d$.
      %
      Our proposed method (\texttt{Stat-kNNAD}) outperformed other methods \red{across} all settings.
  }
  \label{fig:power_adaptive_k}
\end{figure}

\subsection{Details of \red{Tabular} Datasets}
\label{app:appC3}
We used the following \red{10} real datasets from the Kaggle Repository. All datasets are licensed under the CC BY 4.0 license.

\begin{itemize}
  \item \textit{Heart}: Dataset for predicting heart attacks
  \item \textit{Money}: Dataset on financial transactions in a virtual environment
  \item \textit{Fire}: Dataset on fires in the MUGLA region in June
  \item \textit{Cancer}: Dataset related to breast cancer diagnosis
  \item \textit{Credit}: Dataset on credit card transactions
  \item \textit{Student}: Dataset related to student performance
  \item \textit{Bankruptcy}: Dataset on company bankruptcies
  \item \textit{Drink}: Dataset on the quality of drinking water
  \item \textit{Nuclear}: Dataset on pressurized nuclear reactors
  \item \textit{Network}: Dataset on anomaly detection in virtual network environments
\end{itemize}

%
\subsection{\red{Experimental Results on Image Data Examples}}
\label{app:appC4}
\red{
  We evaluated \texttt{Stat-kNNAD} and \texttt{naive} on the 10 datasets from MVTec AD dataset.  
  %
  The datasets used in this study are \textit{Carpet}, \textit{Grid}, \textit{Leather}, \textit{Tile}, \textit{Wood}, \textit{Bottle}, \textit{Capsule}, \textit{Metal Nut}, \textit{Transistor}, and \textit{Zipper}.
  %  
  Examples from each dataset are shown in Figure~\ref{fig:mvtec_examples}.
  %
  In each example, we present patches corresponding to true negative and true positive cases, along with both the naive $p$-value and the selective $p$-value.
}


%
% Let me show the case study in the latent feature space.
%
% 10 kinds of real data examples from MVtec dataset are shown, along with naive $p$ and selective $p$ values.
% %
% As well as the real data Experiments results in~\ref{subsec:experiment_of_image_data}, 'Carpet', 'Grid', 'Leather', 'Tile', 'Wood', 'Bottle', 'Capsule', 'Metal Nut', 'Transistor' and 'Zipper' data examples.
% %
% In each data example, we show true negative and true positive patches with both the naive $p$ value and the selective $p$ value.
%

\begin{figure}[H]
    \centering
    {
    \begin{minipage}[b]{0.45\linewidth}
        \centering
        \subcaption*{
        \centering
        \textit{Carpet}}
        \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_carpet.pdf}
        % \subcaption*{$p_{\text{naive}}=0.011$, $p_{\text{selective}}=0.25$, $p_{\text{naive}}=0.001$, $p_{\text{selective}}=0.022$ }
        \subcaption*{
                    Normal Example (Left):  $p_{\text{naive}}=0.011$, $p_{\text{selective}}=0.250$ \\ 
                    Anomaly Example (Right): $p_{\text{naive}}=0.001$, $p_{\text{selective}}=0.022$ }

      \end{minipage}
      \begin{minipage}[b]{0.45\linewidth}
        \centering
        \subcaption*{
        \centering
        \textit{Grid}}
        \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_grid.pdf}
        \subcaption*{
                Normal Example (Left): $p_{\text{naive}}=0.031$, $p_{\text{selective}}=0.491$ \\ 
                Anomaly Example (Right): $p_{\text{naive}}=0.001$, $p_{\text{selective}}=0.013$ }
    \end{minipage}
    }\\
    \vspace{0.5cm}
    {
    \begin{minipage}[b]{0.45\linewidth}
        \centering
        \subcaption*{
        \centering
        \textit{Leather}}
        \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_leather.pdf}
        \subcaption*{
          Normal Example (Left): $p_{\text{naive}}=0.040$, $p_{\text{selective}}=0.640$\\
          Anomaly Example (Right): $p_{\text{naive}}=0.004$, $p_{\text{selective}}=0.021$ }
    \end{minipage}
    \begin{minipage}[b]{0.45\linewidth}
        \centering
        \subcaption*{
        \centering
        \textit{Tile}}
        \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_tile.pdf}
        \subcaption*{
          Normal Example (Left): $p_{\text{naive}}=0.011$, $p_{\text{selective}}=0.309$\\
          Anomaly Example (Right): $p_{\text{naive}}=0.009$, $p_{\text{selective}}=0.046$
          }
    \end{minipage}
    }\\
    \vspace{0.5cm}
    \begin{minipage}[b]{0.45\linewidth}
        \centering
        \subcaption*{
        \centering
        \textit{Wood}}
        \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_wood.pdf}
        \subcaption*{
          Normal Example (Left): $p_{\text{naive}}=0.028$, $p_{\text{selective}}=0.488$\\
          Anomaly Example (Right): $p_{\text{naive}}=0.001$, $p_{\text{selective}}=0.034$ }
    \end{minipage}
    \begin{minipage}[b]{0.45\linewidth}
        \centering
        \subcaption*{
        \centering
        \textit{Bottle}}
        \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_bottle.pdf}
        \subcaption*{
          Normal Example (Left): $p_{\text{naive}}=0.027$, $p_{\text{selective}}=0.460$\\
          Anomaly Example (Right): $p_{\text{naive}}=0.003$, $p_{\text{selective}}=0.017$ }
    \end{minipage}
    % \caption{
    %   \red{
    %   Experimental results of 6 datasets from MVTec AD: \textit{Carpet}, \textit{Grid}, \textit{Leather}, \textit{Tile}, \textit{Wood}, and \textit{Bottle}.
    %   %
    %   For each dataset, one normal example (left) and one anomaly example (right) are showed.  
    %   %
    %   For each example, the top row displays the original image used for testing along with the patch location (marked in red), while the bottom row presents the extracted patch image.
    %   %
    %   For all normal examples, the naive $p$-value is below the significance level $\alpha = 0.05$ (false positive), whereas the proposed selective $p$-value correctly results in a true negative.  
    %   %
    %   For all anomaly examples, the selective $p$-value successfully detects anomalies.
    %   }
    % }
    % \label{fig:mvtec_examples_1}
\end{figure}


\addtocounter{figure}{-1}
\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.45\linewidth}
      \centering
      \subcaption*{
      \centering
      \textit{Capsule}}
      \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_capsule.pdf}
      \subcaption*{
        Normal Example (Left): $p_{\text{naive}}=0.026$, $p_{\text{selective}}=0.505$\\
      Anomaly Example (Right): $p_{\text{naive}}=0.002$, $p_{\text{selective}}=0.047$ }
  \end{minipage}
  \begin{minipage}[b]{0.45\linewidth}
      \centering
      \subcaption*{
      \centering
      \textit{Metal Nut}}
      \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_metalnut.pdf}
      \subcaption*{
        Normal Example (Left): $p_{\text{naive}}=0.010$, $p_{\text{selective}}=0.283$\\
      Anomaly Example (Right): $p_{\text{naive}}=0.009$, $p_{\text{selective}}=0.038$ }
  \end{minipage}
  \\
  \vspace{0.5cm}
  \begin{minipage}[b]{0.45\linewidth}
      \centering
      \subcaption*{
      \centering
      \textit{Transistor}}
      \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_transistor.pdf}
      \subcaption*{
        Normal Example (Left): $p_{\text{naive}}=0.017$, $p_{\text{selective}}=0.585$\\
      Anomaly Example (Right): $p_{\text{naive}}=0.001$, $p_{\text{selective}}=0.015$ }
  \end{minipage}
  \begin{minipage}[b]{0.45\linewidth}
      \centering
      \subcaption*{
      \centering
      \textit{Zipper}}
      \includegraphics[width=0.6\linewidth]{Fig/appC2/patch_example_zipper.pdf}
      \subcaption*{
        Normal Example (Left): $p_{\text{naive}}=0.030$, $p_{\text{selective}}=0.471$\\
      Anomaly Example (Right): $p_{\text{naive}}=0.001$, $p_{\text{selective}}=0.048$ }
  \end{minipage}
  \caption{
    \red{
    Experimental results of 10 datasets from MVTec AD dataset.
    % \textit{Capsule}, \textit{Metal Nut}, \textit{Transistor}, and \textit{Zipper}.
    % %
    % The interpretation of this figure is the same as that of Figure~\ref{fig:mvtec_examples_1}.
    % %
    For each dataset, one normal example (left) and one anomaly example (right) are showed.  
    %
    For each example, the top row displays the original image used for testing along with the patch location (marked in red), while the bottom row presents the extracted patch image.
    %
    For all normal examples, the naive $p$-value is below the significance level $\alpha = 0.05$ (false positive), whereas the proposed selective $p$-value correctly results in a true negative.  
    %
    For all anomaly examples, the selective $p$-value successfully detects anomalies.
    }
  }
  \label{fig:mvtec_examples}
\end{figure}



\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.46\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/normal_example.pdf}
      \subcaption{\\The naive $p$-value is 0.03\\
       (false positive)\\ 
      The selective $p$-value is 0.46\\
       (true negative)}
  \end{minipage}
  \begin{minipage}[b]{0.46\linewidth}
      \centering
      \includegraphics[width=0.98\linewidth]{Fig/anomaly_example.pdf}
      \subcaption{\\The naive $p$-value is 0.00\\
      (true positive)\\ 
      The selective $p$-value is 0.02\\
      (true positive)}
  \end{minipage}
  \caption{
    Experimental results on the \textit{Bottle} image from the MVTec AD dataset.
    %
    For the normal image (left), the conventional $p$-value falls below the significance level $\alpha = 0.05$, leading to a false positive, whereas the proposed selective $p$-value correctly indicates a true negative.
    %
    For the anomaly image (right), the proposed method accurately detects the anomaly.
    }
  \label{fig:mvtec_bottle_example}
\end{figure}



%10個の事例とそれぞれ２種類のp値を載せる。
%\caption{
%Across all 10 data examples of true negative patches, naive $p$ value are under significant level $\alpha$. On the other hand, selective $p$ value are over significant level $\alpha$.
%This shows that the proposed method correctly rejects the null hypothesis.
%}
