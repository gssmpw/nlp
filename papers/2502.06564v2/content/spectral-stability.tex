\section{Spectral Covariance Stability}

\begin{lemma}[From Euclidean to Spectral Stability]\label{lem:stability-frob-to-spectral}
    Let $0 < \e < \delta < 0.1$, $r, R > 0$, 
    $\cB_R = \set{V\in \R^{d\times d} : \normf{V} \le R}$. Suppose that $\set{X_1,\ldots,X_n} \subset \R^{d\times d}$ is an $\Paren{\e,\delta,r,\cB_R,\cB_R\otimes \cB_R}$-stable set with respect to some $M\in \R^{d\times d}$ and $Q\in \R^{d^2\times d^2}$.
    Let $\cS_R = \set{uu^\top \in \R^{d\times d} : \norm{u}\le \sqrt{R}}$ and let 
    \[
    \cP_R = \Set{\pE v^{\otimes 4} : v\in \R^d, \pE \text{ is a degree-$4$ pseudo-expectation that satisfies the constraint } \norm{v}^2 \le R}\,.
    \]
    
    Then for each $Q'\in \R^{d^2\times d^2}$ such that 
    \[
    \Abs{\Iprod{P, Q-Q'}}\le O(\delta^2/\e)\,,
    \]
    $\set{X_1,\ldots,X_n}$ is an $\Paren{\e,\delta,r,\cS_R,\cP_R}$-stable set with respect to $M$ and $Q'$. 
\end{lemma}
\begin{proof}
    Let $\cC_R = \conv\Paren{\cB_R\otimes \cB_R}$. Note that it is the set of $d^2\times d^2$ matrices with trace at most $R^2$. Note that $\cS_R \subset \cB_R$, and $\cP_R \subset \cC_R$, since $\sum_{i=1}^d\sum_{j=1}^d \pE u_iu_j \cdot u_iu_j = \pE \sum_{i=1}^d u_i^2 \cdot \sum_{j=1}^d u_j^2 \le R^2$.
    
    Since maximum and minimum of a linear function over a convex set is achieved in its extreme poitns,  $\set{X_1,\ldots,X_n}$ is an $\Paren{\e,\delta,r,\cB_R,\cC_R}$-stable set with respect to $M$ and $Q$, and hence of an $\Paren{\e,\delta,r,\cS_R,\cP_R}$-stable with respect to $M$ and $Q$. 
    
    Finally, it is clear that $Q$ can be replaced by any $Q'$ such that $\Abs{\Iprod{P, Q-Q'}}\le O(\delta^2/\e)$.
\end{proof}

\begin{corollary}\label{cor:spectral-stability}
Let $\Sigma \in \R^{d\times d}$ be a positive definite matrix such that $0.9 \cdot \Id_d \preceq \Sigma \preceq 1.1\cdot \Id_d$. Let $y_1,\ldots,y_n\simiid N(0,\Sigma)$, $\Sigma' = \Cov_{y\sim N(0,\Sigma)} \cF(y)$, and let $\zeta_i = \Paren{\Sigma'}^{-1/2}\cF(y_i)$. Let $R \le O(1)$.

If $\e\log(1/\e) \gtrsim 1/d$ and $n\gtrsim d^2\log^5(d)/\e^2$, then $\zeta_1\zeta_1^\top,\ldots,\zeta_n\zeta_n^\top$ is an $\Paren{\e,\delta,r,\cS_R, \cP_R}$-stable set with respect to $M=\Id_d$ and $Q' = 2\Id_{d^2}$, for some $\e\le \delta \le O(\e{\log(1/\e)})$ and $r \le O(1)$.
\end{corollary}
\begin{proof}
By \ref{lem:frobenius-stability-isotropic}, with high probability, $\zeta_1\zeta_1^\top,\ldots,\zeta_n\zeta_n^\top$ is an $\Paren{\e,\delta,r,\cB_R, \cB_R\otimes \cB_R}$-stable set with respect to $M=\Id_d$ and $Q = \E_{y\sim N(0,\Sigma)} \Paren{\Paren{\Sigma'}^{-1/2}\cF(y)\cF(y)^\top\Paren{\Sigma'}^{-1/2} - \Id}^{\otimes 2}$. By \cref{lem:stability-frob-to-spectral}, it is enough to show that 
\[
\Abs{\Iprod{\pE u^{\otimes 4}, Q} - 2} \le O(\delta^2/\e)\,.
\]

By \cref{lem:tensor}, $Q_{iiii} = 2 \pm O(1/d)$, and for $i\neq j$, $Q_{ijij} = 1 \pm O(1/d)$, $Q_{iijj}= \pm O(1/d)$, and other entries are $0$. Hence
\begin{align*}
\Iprod{\pE u^{\otimes 4}, Q} 
&= \sum_{1\le i,j \le d} \pE u_i^2u_j^2 Q_{ijij} + \sum_{1\le i\neq j \le d} \pE u_i^2u_j^2 Q_{iijj} = 2 \pm O(1/d) = 2 \pm O(\e\log(1/\e))\,.
\end{align*}
\end{proof}

\begin{lemma}\label{lem:stability-linear-transformation}
Let $R \le O(1)$. Let $\zeta_1\zeta_1^\top,\ldots,\zeta_n\zeta_n^\top$ be an $\Paren{\e,\delta,r,\cS_R, \cP_R}$-stable set with respect to $\Id_d$ and $2\Id_{d^2}$, for some $\e\le \delta$ and $r\le O(1)$.

Then for each matrix $A\in \R^{d\times d}$ such that $\norm{A}^2\le R$, $A\zeta_1\Paren{A\zeta_1}^\top,\ldots,A\zeta_n\Paren{A\zeta_n}^\top$ is an $\Paren{\e,\delta',r,\cS_1, \cP_1}$-stable set with respect to $M = AA^\top$ and $Q = 2\Id_{d^2}$,
where $r\le O(1)$ and
\[
\delta' = O\Paren{\delta + \sqrt{\e\norm{AA^\top - \Id_d}}}\,.
\]
\end{lemma}
\begin{proof}
Let us check the first property of stability. 
For each unit $u\in \R^{d}$,
\[
\Abs{\tfrac{1}{\card{S'}} \sum_{x\in S'} \iprod{uu^\top, A\zeta_i\zeta_i^\top A^\top-AA^\top}}
= \Abs{\tfrac{1}{\card{S'}} \sum_{x\in S'} \iprod{A^\top uu^\top A, \zeta_i\zeta_i^\top-\Id_d}}
\le O(\delta)\,,
\]
where the inequality follows from the stability of $\zeta_1\zeta_1^\top, \ldots, \zeta_n\zeta_n^\top$.
Let us check the second property. We need to show that
\[
\Abs{\tfrac{1}{\card{S'}} \sum_{x\in S'} \Iprod{\pE v^{\otimes 4}, \paren{A\zeta_i\zeta_i^\top A^\top-AA^\top}^{\otimes 2}} - \Iprod{\pE v^{\otimes 4}, 2\Id_{d^2}}}\le \paren{\delta'}^2/\e\,.
\]
Note that
\begin{align*}
\Iprod {\pE v^{\otimes 4}, \paren{A\zeta_i\zeta_i^\top A^\top-AA^\top}^{\otimes 2}}
&= \pE \Iprod{vv^\top, A\zeta_i\zeta_i^\top A^\top-AA^\top}^2
\\&= \pE \Iprod{\Paren{A^\top v}\Paren{A^\top v}, \zeta_i\zeta_i^\top -\Id_d}^2
\\&= \Iprod{\pE \Paren{A^\top v}^{\otimes 4}, \zeta_i\zeta_i^\top -\Id_d}\,.
\end{align*}
By the stability of $\zeta_1\zeta_1^\top, \ldots, \zeta_n\zeta_n^\top$, 
\[
\Abs{\tfrac{1}{\card{S'}} \sum_{x\in S'} 
\iprod{\pE \Paren{A^\top v}^{\otimes 4}, \zeta_i\zeta_i^\top -\Id_d}
- \Iprod{\pE \Paren{A^\top v}^{\otimes 4}, 2\Id_{d^2}}}\le O\Paren{\delta^2/\e}\,.
\]
Note that
\begin{align*}
\Abs{\Iprod{\pE \Paren{A^\top v}^{\otimes 4} - \pE v^{\otimes 4}, 2\Id_{d^2}}}
&= 2\Abs{\pE \norm{A^\top v}^4 - \pE \norm{v}^4}
\\&= 2\Abs{\pE \Paren{v^\top A A^\top v}^2 - \pE \Paren{v^\top v}^2}
\\&= 
2\Abs{\pE\Paren{{v^\top \Paren{A A^\top - \Id_d} v}}\cdot \Paren{{v^\top \Paren{A A^\top + \Id_d} v}}}
\\&\le \sqrt{\pE\Paren{{v^\top \Paren{A A^\top - \Id_d} v}}^2 \cdot \pE\Paren{{v^\top \Paren{A A^\top + \Id_d} v}}^2}
\\&\le O\Paren{\norm{A A^\top - \Id_d}}\,,
\end{align*}
where we used the \CS inequality for pseudo-distributions, \cref{fact:spectral-certificates} and $\norm{A}\le O(1)$ . Hence the second property is satisfied. The third property is also obviously satisfied.
\end{proof}

\begin{lemma}\label{lem:non-decreasing-covariance}
Let $\zeta_1\zeta_1^\top,\ldots,\zeta_n\zeta_n^\top$ be an $\Paren{10\e,\delta,r,\cS_1, \cP_1}$-stable set with respect to $\Id_d$ and $Q\in \R^{d^2\times d^2}$, where $\e \le \delta \lesssim 1$. Let $\set{z_1,\ldots,z_n}$ be an $\e$-corruption of $\set{\Paren{\paren{\Sigma'}^{1/2}\zeta_1}\Paren{\paren{\Sigma'}^{1/2}\zeta_1}^\top,\ldots, \Paren{\paren{\Sigma'}^{1/2}\zeta_n}\Paren{\paren{\Sigma'}^{1/2}\zeta_n}^\top}$. Let $w\in \cW_\e$, and let 
$\Sigma'' = \frac{1}{\sum_{i=1}^n w_i}\sum_{i=1}^n w_i z_i z_i^\top$. 
Then 
\[
\norm{\Paren{\Sigma''}^{-1/2}\Paren{\Sigma'}^{1/2}}\le O(1)\,.
\]
\end{lemma}
\begin{proof}
Note that it is enough to show that $\Sigma'' \succeq \Paren{1-O(\delta)} \Sigma'$.
Let $G$ be the set of indices where $z$ coincides with $\paren{\Sigma'}^{1/2}\zeta$
Note that
\[
\Sigma'' \succeq \frac{1}{\sum_{i=1}^nw_i}\sum_{i\in G} w_i \paren{\Sigma'}^{1/2}\zeta_i \zeta_i^\top \paren{\Sigma'}^{1/2} \succeq \Paren{1-O(\e)}\sum_{i\in G} w_i \paren{\Sigma'}^{1/2}\zeta_i \zeta_i^\top \paren{\Sigma'}^{1/2}\,.
\]
Let $u\in \R^d$ be an arbitrary unit vector. Since the function 
\[
u^\top\Paren{\Sigma'' - \Paren{1-O(\e)}\paren{\Sigma'}^{1/2}\Paren{\sum_{i\in G} w_i \zeta_i \zeta_i^\top} \paren{\Sigma'}^{1/2}}u
\]
is linear in $w$, its maximum is achieved in one of the extreme points of $\cW_\e$, i.e. in some set $S_u$ of size $\card{S_u}\ge \Paren{1-\e} n$. Denote $G_{u} = G\cap S_u$. By stability,
\[
\Norm{\frac{1}{\card{G_u}}\sum_{i\in G_u} \zeta_i \zeta_i^\top - \Id_d} \le \delta\,.
\]
It follows that
\begin{align*}
0
&\le
u^\top\Paren{\Sigma'' - \Paren{1-O(\e)}\paren{\Sigma'}^{1/2}\Paren{\sum_{i\in G} w_i \zeta_i \zeta_i^\top} \paren{\Sigma'}^{1/2}}u 
\\&\le
u^\top\Paren{\Sigma'' - \Paren{1-O(\e)}\paren{\Sigma'}^{1/2}\Paren{\sum_{i\in G_u} \tfrac{1}{n} \zeta_i \zeta_i^\top} \paren{\Sigma'}^{1/2}}u
\\&\le
u^\top\Paren{\Sigma'' - \Paren{1-O(\e)}\paren{\Sigma'}^{1/2}\Paren{\sum_{i\in G_u} \tfrac{1}{\card{G_u}} \zeta_i \zeta_i^\top} \paren{\Sigma'}^{1/2}}u
\\&\le
u^\top\Paren{\Sigma'' - \Paren{1-O(\e)}\Paren{1-\delta}\paren{\Sigma'}^{1/2}\paren{\Sigma'}^{1/2}}u
\\&\le u^\top\Paren{\Sigma'' - \Paren{1-O(\delta)}\Sigma'}u
\end{align*}
Hence $\Sigma'' \succeq \Paren{1-O(\delta)} \Sigma'$.
\end{proof}

\begin{lemma}
    Let $R\le O(1)$. Let $\zeta_1\zeta_1^\top,\ldots,\zeta_n\zeta_n^\top$ be an $\Paren{10\e,\delta,r,\cS_R, \cP_R}$-stable set with respect to $\Id_d$ and $2\Id_{d^2}$, where $\e \le \delta \lesssim 1$ and $r\le O(1)$. 
    
    Let $\set{z_1,\ldots,z_n}$ be an $\e$-corruption of $\set{\Paren{\paren{\Sigma'}^{1/2}\zeta_1}\Paren{\paren{\Sigma'}^{1/2}\zeta_1}^\top,\ldots, \Paren{\paren{\Sigma'}^{1/2}\zeta_n}\Paren{\paren{\Sigma'}^{1/2}\zeta_n}^\top}$. Let $w\in \cW_\e$. 
    Denote $\Sigma'' = \frac{1}{\sum_{i=1}^n w_i}\sum_{i=1}^n w_i z_i z_i^\top$ and
    $C = \frac{1}{\sum_{i=1}^n w_i}\sum_{i=1}^n w_i \Paren{\Paren{\Sigma''}^{-1/2}z_iz_i^\top \Paren{\Sigma''}^{-1/2} - \Id}^{\otimes 2}$. Suppose that 
    \[
    \max_{P\in\cP_1}\Abs{\Iprod{C - Q,P}}\le \lambda\,.
    \]
    
Denote $A = \Paren{\Sigma''}^{-1/2}\Paren{\Sigma'}^{1/2}$.
Then $A\zeta_1\Paren{A\zeta_1}^\top,\ldots,A\zeta_n\Paren{A\zeta_n}^\top$ is an $\Paren{\e,\delta',r,\cS_1, \cP_1}$-stable set with respect to $M = AA^\top$ and $Q = 2\Id_{d^2}$,
where $r\le O(1)$ and
\[
\delta' = O\Paren{\delta + \e^{3/4}\lambda^{1/4}}\,.
\]
\end{lemma}
\begin{proof}
By \cref{lem:stability-linear-transformation} and \cref{lem:non-decreasing-covariance} $A\zeta_1\Paren{A\zeta_1}^\top,\ldots,A\zeta_n\Paren{A\zeta_n}^\top$ is an $\Paren{\e,O\Paren{\delta + \sqrt{\e}},r,\cS_1, \cP_1}$-stable set with respect to $M = AA^\top$ and $Q = 2\Id_{d^2}$. By \cref{lem:stability},
\[
\norm{AA^\top - \Id_d} \le O\Paren{\delta + \sqrt{\e} + \sqrt{\e \lambda} + \e r}\,.
\]
Therefore, applying \cref{lem:stability-linear-transformation} again, we get the desired result.
\end{proof}

\begin{lemma}\label{lem:adequate}
For each $R > 0$, $\cP_R$ is adequate with respect to $\cS_R$  (see \cref{def:adequate}). 
\end{lemma}
\begin{proof}
Let $A \in \R^{d\times d}$. Then  
$\pE \iprod{A\otimes A, v^{\otimes 4}} = \pE \Paren{v^\top A v}^2 \ge 0$.

Let us prove the second property. Let $A, B\in \R^{d\times d}$. Then
\[
\Paren{\pE \iprod{A \otimes B, v^{\otimes 4}}}^2 = \Paren{\pE \Paren{v^\top A v}\Paren{v^\top B v}}^2 \le \pE \Paren{v^\top A v}^2 \cdot \pE  \Paren{v^\top B v}^2\,,
\]
where we used the \CS inequality for pseudo-distributions. 
By \cref{fact:spectral-certificates}, there is a degree-2 sos proof of the inequalities
\[
-\norm{A}\cdot \norm{v}^2\le {v^\top A v} \le \norm{A}\cdot \norm{v}^2\,.
\]
Hence each degree-4 pseudo-distribution that satisfies the constraint $\norm{v}^2\le R$,
\[
\Paren{\pE \iprod{A \otimes B, v^{\otimes 4}}}^2 \le \pE \Paren{v^\top A v}^2 \cdot \pE  \Paren{v^\top B v}^2\le R^2 \norm{A}^2 \cdot \norm{B}^2 = \Paren{\max_{uu^\top\in\cS_R}\iprod{uu^\top, A}^2} \cdot \Paren{\max_{uu^\top\in\cS_R}\iprod{uu^\top, B}^2}\,.
\]
\end{proof}

\cref{cor:spectral-stability}, \cref{lem:stability-linear-transformation} and \cref{lem:adequate} imply that we can use \cref{thm:filtering} and get the desired estimator in relative spectral norm.