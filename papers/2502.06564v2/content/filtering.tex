\subsection{Filtering Algorithm}
The following algorithm is a generalized version of filtering. Note that it updates the samples via some (known) transformation $F$. When we use if for estimation in relative spectral norm, $F$ is a linear transformation that maps the points into the isotropic position so that $\mu^{(t)}$ is the identity matrix. When we use it for estimation in Frobenius norm, $F$ is simply the identity transformation.
 
\begin{mdframed}[linecolor=black, linewidth=0.8pt, roundcorner=4pt,
  innertopmargin=0.8em, innerbottommargin=0.8em, innerleftmargin=1em, innerrightmargin=1em]
\begin{algorithm}[Filtering]\label{alg:filtering}
\begin{algorithmic}
\State
\State \textbf{Input:} $x\in \R^{n\times m}, Q\in \R^{m\times m}, \cP\subset \R^{m\times m}, F:\R^n\times \R^{n\times m} \to \R^{n\times m}, \varepsilon, \delta\in (0,1), r,C>0$.
\State For all $i\in [n]$, let $w^{(0)}_i \gets 1/n$
\State Let $x^{(0)} \gets x$, $\mu^{(0)} \gets \sum_{i=1}^n \tfrac{1}{n} x_i$, $\Sigma^{(0)} = \sum_{i=1}^n \tfrac{1}{n} \paren{x_i - \mu^{(0)}}\paren{x_i - \mu^{(0)}}^\top$.
\State Let $t \gets 0$.
\While {there exists $P^*\in \cP$ such that $\Abs{\iprod{P^*, Q-\Sigma^{(t)}  }} > C \cdot \Paren{\delta^2/\e + \e r^2}$}
    \State For all $i\in [n]$, let 
    $\tau_i^{(t)} = {\Iprod{P^*, \paren{x_i^{(t)}-\mu^{(t)}}\paren{x_i^{(t)}-\mu^{(t)}}^\top } }$
    \State Sort the $\tau^{(t)}_i$ in decreasing order.
    \State Let $N$ be the first index such that $\sum_{i=1}^{N} w^{(t)}_i > 2\varepsilon$.
    \State Let $w^{(t+1)}_i = \Paren{1-\tau_i/\tau_{\max}}w_i^{(t)}$ for $i \le N$, and $w^{(t+1)}_i = w^{(t)}_i$ otherwise.
    \State Let $x^{(t+1)} \gets F(w^{(t+1)}, x^{(0)})$.
    \State Let $\mu^{(t + 1)} \gets \frac{1}{\sum_{i=1}^n w_i^{(t+1)}}\sum_{i=1}^n w_i^{(t+1)} x_i^{(t+1)}$.
    \State Let $\Sigma^{(t+1)} \gets \frac{1}{\sum_{i=1}^n w_i^{(t+1)}}\sum_{i=1}^n w_i^{(t+1)}\paren{x_i^{(t+1)}-\mu^{(t+1)}}\paren{x_i^{(t+1)}-\mu^{(t+1)}}^\top$.
    \State Update $t \gets t + 1$.
\EndWhile
\State \Return $\mu^{(t)}$
\end{algorithmic}
\end{algorithm}
\end{mdframed}



\begin{theorem}\label{thm:filtering}
    Let $C > 0$ be a sufficiently large universal constant.
    Let $m,\e,{\delta}, r, \cV, \cP, \mu, Q$ be as in \cref{def:stability}, where $\e < {\delta} < 0.01$ and $\cP$ is adequate with respect to $\cV$.
    Suppose that at each step of \cref{alg:filtering} there exists 
    \[
    \delta^{(t)} \le O\Paren{\delta + \min\Set{\sqrt{\e}, \e^{3/4}\Abs{\iprod{P^*, Q-\Sigma^{(t)}  }} ^{1/4}} + \e r }
    \]
    such that
    $\set{x_1^{(t)},\ldots x_n^{(t)}}$ is an $\e$-corruption of a $\Paren{10\e,\delta^{(t)},r,\cV,\cP}$-stable multiset of size $n$ with respect to $\mu^{(t)}$ and $Q$.
    Then the while-statement of \cref{alg:filtering} is checked at most $O(n)$ times, and the algorithm outputs $\hat{\mu}$ such that 
    \[
    \sup_{v\in \cV}\; \Abs{\iprod{v, \hat{\mu}-\mu}} \le O\Paren{\delta + \e r}\,.
    \]
\end{theorem}

The following lemma easily implies \cref{thm:filtering}:

\begin{lemma}[Invariant of the Filtering Algorithm]\label{lem:filtering-invariant} 
Let $G\subseteq [n]$ be the set of indices of uncurrupted samples, and $B = [n]\setminus G$.
Suppose that in iteration $t$, \begin{equation}\label{eq:filtering-invariant}
\sum_{i \in G} \tfrac{1}{n} - w_i^{(t)} \quad \text{<} \quad \sum_{i \in B} \tfrac{1}{n} - w_i^{(t)}\,,
\end{equation}
and furthermore there exists $P^*\in \cP$ such that
\[
\Abs{\iprod{P^*, Q-\Sigma_{w^{(t)}}}} > C\cdot \Paren{\delta^2/\e + \e r^2}.
\]
Then
\[
\sum_{i \in G} \left( \tfrac{1}{n} - w_i^{(t+1)} \right) <
\sum_{i \in B} \left( \tfrac{1}{n} - w_i^{(t+1)} \right).
\]
\end{lemma}

\begin{proof}[Proof of \cref{thm:filtering}]
Let us show that the algorithm terminates after at most $t' = \lceil 2\e n\rceil $ iterations. Assume towards a contradiction that it does not terminate after $t'$ iterations. The number of nonzero entries of $w^{(t)}$ decreases by at least $1$ at each iteration. Hence we have at least $\e n$ zero entries of $w^{(t')}$ that are in $G$. By \cref{lem:filtering-invariant},
\[
\e \le \sum_{i\in G} \Paren{\tfrac{1}{n} - w^{(t')}_i} <  \sum_{i\in G} \Paren{\tfrac{1}{n} - w^{(t')}_i} \le \frac{\card{B}}{n} \le \e\,,
\]
which is a contradiction.

By \cref{lem:stability}, we get the desired bound. 
\end{proof}

Now let us prove \cref{lem:filtering-invariant}.

\begin{proof}
For simplicity let us denote $w = w^{(t)}$ and $w' = w^{(t+1)}$. Note that it is enough to show that
\[
\sum_{i\in G} \Paren{w_i - w'_i} < \sum_{i\in B} \Paren{w_i - w'_i}\,.
\]

Since for $i\le N$, $w_i - w'_i = \tfrac{1}{\tau_{\max}}\tau_i w_i$ and for $i > N$, $w_i - w'_i = 0$, it is equivalent to
\[
\sum_{i\in G\cap [N]} w_i \tau_i < \sum_{i\in B \cap [N]} w_i\tau_i\,.
\]

We will show it by proving the following two lemmas:

\begin{lemma}[Upper bound for the good samples]\label{lem:filtering-upper-bound}
\[
\sum_{i\in G\cap [N]} w_i \tau_i \le O\Paren{\paren{\delta^{(t)}}^2/\e + \e r^2  + \e^2 \Abs{\Iprod{P^*, Q-\Sigma_{w}}} }\,.
\]
\end{lemma}

\begin{lemma}[Lower bound for the bad samples]\label{lem:filtering-lower-bound}
\[
\sum_{i\in B\cap [N]} w_i \tau_i \ge \Abs{\Iprod{P^*, Q-\Sigma_{w}}} / 2\,.
\]
\end{lemma}

\begin{proof}[Proof of \cref{lem:filtering-upper-bound}]
\begin{align*}
\sum_{i\in G\cap [N]} w_i \tau_i 
&= \sum_{i\in G\cap [N]} w_i \Iprod{P^*, \Paren{x_i-\mu_{w^{}}}\Paren{x_i-\mu_{w^{}}}^\top }
\\&\le O\Paren{\sum_{i\in G\cap [N]} w_i {\Iprod{P^*, \Paren{x_i-\mu}\Paren{x_i-\mu}^\top }}
+ \sum_{i\in G\cap [N]} w_i {\Iprod{P^*, \Paren{\mu-\mu_{w^{}}}\Paren{\mu-\mu_{w^{}}}^\top }} }
\\&\le O\Paren{\sum_{i\in G\cap [N]} \tfrac{1}{n} {\Iprod{P^*, \Paren{x_i-\mu}\Paren{x_i-\mu}^\top }}
+ \e {\Iprod{P^*, \Paren{\mu-\mu_{w^{}}}\Paren{\mu-\mu_{w^{}}}^\top }} }\,.
\end{align*}
The first term can be bounded using stability:
\begin{align*}
\sum_{i\in G\cap [N]} \tfrac{1}{n} {\Iprod{P^*, \Paren{x_i-\mu}\Paren{x_i-\mu}^\top }}
&= \sum_{i\in G}  \tfrac{1}{n}\Iprod{P^*, \Paren{x_i-\mu}\Paren{x_i-\mu}^\top } - \sum_{i\in G\setminus [N]}  \tfrac{1}{n}\Iprod{P^*, \Paren{x_i-\mu}\Paren{x_i-\mu}^\top}
\\&\le \tfrac{\card{G}}{n}\Iprod{P,Q} - \tfrac{\card{G}\setminus[N]}{n}\Iprod{P,Q} + O\Paren{\paren{\delta^{(t)}}^2/\e}
\\&\le O\Paren{\e r^2 + \paren{\delta^{(t)}}^2/\e}\,.
\end{align*}
Let us bound the second term. Since $\cP$ is adequate with respect to $\cV$,
\begin{align*}   
\Iprod{P^*, \Paren{\mu-\mu_{w^{}}}\Paren{\mu-\mu_{w^{}}}^\top }
&\le O\Paren{\max_{v\in\cV}\Iprod{v, \mu-\mu_{w^{}}}^2}
\\&\le O\Paren{\paren{\delta^{(t)}}^2 + \e \Abs{\Iprod{P^*, Q-\Sigma_{w}}} + \e^2 r^2}\,,
\end{align*}
where the second inequality follows from \cref{lem:stability}.
\end{proof}

\begin{proof}[Proof of \cref{lem:filtering-lower-bound}]
    
\end{proof}
First, we show that 
\[
\sum_{i\in B} w_i \tau_i \ge 0.9\cdot {\Abs{\Iprod{P^*, Q-\Sigma_{w}}}}\,.
\]
Note that
\[
\sum_{i=1}^n w_i\tau_i = \sum_{i=1}^n w_i \Iprod{P^*, \Paren{x_i-\mu_{w^{}}}\Paren{x_i-\mu_{w^{}}}^\top } = \Iprod{P^*, \Sigma_w - Q} + \Iprod{P^*, Q}\,.
\]
Consider
\begin{align*}
\Abs{\sum_{i\in G} w_i\tau_i - \Iprod{P^*, Q}} 
&=  \Abs{\sum_{i\in G} w_i \Iprod{P^*, \Paren{x_i-\mu_{w^{}}}\Paren{x_i-\mu_{w^{}}}^\top } -  \Iprod{P^*, Q}}
\\&\le \Abs{\sum_{i\in G} w_i \Iprod{P^*, \Paren{x_i-\mu}\Paren{x_i-\mu}^\top } -  \Iprod{P^*, Q}} + 
\Abs{\sum_{i\in G} w_i {\Iprod{P^*, \Paren{\mu-\mu_{w^{}}}\Paren{\mu-\mu_{w^{}}}^\top }}}
\\& \qquad + \Abs{\sum_{i\in G} w_i {\Iprod{P^*, \Paren{x_i-\mu}\Paren{\mu-\mu_{w^{}}}^\top }}}
+\Abs{\sum_{i\in G} w_i {\Iprod{P^*, \Paren{\mu-\mu_{w^{}}}\Paren{x_i-\mu}^\top }}}\,.
\end{align*}

The first term is bounded by $O(\paren{\delta^{(t)}}^2/\e + \e r^2)$ (by stability). The second term is bounded by $O\Paren{\paren{\delta^{(t)}}^2 + \e \Abs{\Iprod{P^*, Q-\Sigma_{w}}} + \e^2 r^2}$, as in the proof of \cref{lem:filtering-upper-bound}. The other terms are also bounded by $O\Paren{\paren{\delta^{(t)}}^2 + \e \Abs{\Iprod{P^*, Q-\Sigma_{w}}} + \e^2 r^2}$ (by adequacy of $\cP$, \cref{lem:stability} for the bound on $\max_{v\in \cV}\iprod{v, \mu - \mu_w}$ and stability for the bound on $\max_{v\in \cV}\iprod{v, \mu - \sum_{i\in G} w_ix_i}^2$).

Hence
\[
\sum_{i\in B} w_i \tau_i \ge \Iprod{P^*, \Sigma_w - Q} - \Abs{\sum_{i\in G} w_i\tau_i - \Iprod{P^*, Q}} \ge \Paren{1-\e}\Iprod{P^*, \Sigma_w - Q} - O\Paren{\paren{\delta^{(t)}}^2/\e + \e r^2}\,.
\]

By the bound on $\delta^{(t)}$ and since $\Abs{\iprod{P^*, Q-\Sigma_{w^{(t)}}}} > C\cdot \Paren{\delta^2/\e + \e r^2}$, we get that $\sum_{i\in B} w_i \tau_i \ge 0.99\cdot {\Abs{\Iprod{P^*, Q-\Sigma_{w}}}}$. Let us bound $\sum_{i\in B\setminus[N]} w_i \tau_i$. By \cref{lem:filtering-upper-bound}, for each $i > N$,
\[
\tau_i \le \frac{1}{\sum_{i\in G\cap [N]}w_i} \sum_{i\in G\cap N} w_i \tau_i \le O\Paren{\paren{\delta^{(t)}}^2/\e^2 + r^2  + \e \Abs{\Iprod{P^*, Q-\Sigma_{w}}} }\,,
\]
where we used the fact that $\tau_i \le \tau_j$ for all $j\in G\cap[N]$. Hence
\[
\sum_{i\in B\setminus[N]} w_i \tau_i \le O\Paren{\paren{\delta^{(t)}}^2/\e + \e r^2  + \e^2 \Abs{\Iprod{P^*, Q-\Sigma_{w}}} }\le  0.1 \Abs{\Iprod{P^*, Q-\Sigma_{w}}}\,.
\]
Therefore,
\[
\sum_{i\in B\cap [N]} w_i \tau_i \ge \Abs{\Iprod{P^*, Q-\Sigma_{w}}} / 2\,.
\]
\end{proof}
\cref{lem:filtering-invariant} follows from \cref{lem:filtering-upper-bound} and \cref{lem:filtering-lower-bound} due to the bound on $\delta^{(t)}$ and since $\Abs{\iprod{P^*, Q-\Sigma_{w^{(t)}}}} > C\cdot \Paren{\delta^2/\e + \e r^2}$.
