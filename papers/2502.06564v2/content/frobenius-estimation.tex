\section{Estimation in Frobenius Norm}

\begin{proposition}\label{prop:Hanson-Wright}
    Let $0 < \e \lesssim 1$ and $R \le O(1)$.
    Let $\cD$ be a distribution in $\R^d$ with zero mean and identity covariance that satisfies $O(1)$-Hanson-Wright property, and let $x_1\ldots,x_n \simiid \cD$ for $n\gtrsim d^2\log^5(d)/\e^2$. 
    Then, with high probability, the set $S = \set{x_1x_1^\top, \ldots, x_nx_n^\top}$ is
 $\Paren{\e,\delta,r,\cB_R, \cB_R\otimes \cB_R}$-stable with respect to $M=\Id_d$ and $Q = \E \Paren{x_ix_i^\top - \Id}^{\otimes 2}$, where $\e \le \delta \le O(\e\log(1/\e))$ and $r\le O(1)$. 
\end{proposition}

\begin{proof}
    Condition 1 of stability follows from $O(1)$-sub-Gaussianity. Note that sub-Gaussianity follows from the Hanson-Wright if we plug $A = uu^\top$ for unit $u \in \R^d$. 
    Let us show condition 2.  
    Let $J\subseteq[n]$ be a set of size $\card{J} \ge (1-\e)n$,  and let $V\in \cB_R$. Note that
    \begin{align*}
    \tfrac{1}{\card{J}} \sum_{i\in J} \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}} 
    = \tfrac{1}{\card{J}} \sum_{x=1}^n \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}} 
    - \tfrac{1}{\card{J}} \sum_{i\in [n]\setminus J} \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}}\,.
    \end{align*}
    By the Hanson-Wright inequality, with high probability all $d^2$-dimensional vectors $x_ix_i^\top-\Id_d$ have norm at most $O(d)$. Hence we can apply matrix Bernstein inequality, and it implies that with high probability the sample covariance is close to the empirical covariance. That is, with high probability, for all $V\in \cB_R$,
    \[
    \Abs{\tfrac{1}{n}\sum_{x=1}^n \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}}
    - \E \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}}} \le O(\e)\,.
    \]

    Note that the Hanson-Wright inequality also implies that $\E \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}} \le O(1)$. Hence 
    \begin{align*}
    \tfrac{1}{\card{J}} \sum_{x=1}^n \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}} &= \Paren{1+O(\e)}\cdot \Paren{\E \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}} + O(\e)} 
    \\&= \E \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}} + O(\e)
    \\&= \iprod{V^{\otimes 2}, Q} + O(\e)\,.
    \end{align*}

    Bounding $\tfrac{1}{\card{J}} \sum_{i\in [n]\setminus J} \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}}$ by $O(\e \log^2(1/\e))$ can be done in exactly the same way as in Lemma 5.21 from \cite{DiakonikolasKK016}. For that Lemma they need condition 4 of Definition 5.15, that is shown in the proof of Lemma 5.17. Their proof uses only the Hanson-Wright inequality and no other properties of Gaussians, and it is enough to have $n\gtrsim d^2\log^5(d)/\e^2$ samples for it.

    As was observed before, the Hanson-Wright inequality implies condition 3 of stability: $\iprod{V^{\otimes 2}, Q} = \E \iprod{V^{\otimes 2}, \paren{x_ix_i^\top-\Id_d}^{\otimes 2}} \le O(1)$.
\end{proof}

\begin{lemma}\label{lem:frobenius-stability-isotropic}
  Let $0 < \e \lesssim 1$ and $R \le O(1)$.  Let $\Sigma \in \R^{d\times d}$ be a positive definite matrix such that $0.9 \cdot \Id_d \preceq \Sigma \preceq 1.1\cdot \Id_d$. Let $y_1,\ldots,y_n\simiid N(0,\Sigma)$, $\Sigma' = \Cov_{y\sim N(0,\Sigma)} \cF(y)$, where $\cF$ is as in \cref{def:function}. Let $\zeta_i = \Paren{\Sigma'}^{-1/2}\cF(y_i)$.

Then, with high probability, $\zeta_1\zeta_1^\top,\ldots,\zeta_n\zeta_n^\top$ is an $\Paren{\e,\delta,r,\cB_R, \cB_R\otimes \cB_R}$-stable set with respect to $M=\Id_d$ and $Q = \E_{y\sim N(0,\Sigma)} \Paren{\Paren{\Sigma'}^{-1/2}\cF(y)\cF(y)^\top\Paren{\Sigma'}^{-1/2} - \Id}^{\otimes 2}$, where $\e \le \delta \le O\paren{\e\log(1/\e)}$ and $r\le O(1)$. 
\end{lemma}
\begin{proof}
    By \cref{prop:Hanson-Wright} it is enough to show that the distribution of $\zeta$ satisfies $O(1)$-Hanson-Wright property. Since $\cF(y) = \cF(\Sigma^{1/2}g)$ is a $O(1)$-Lipschitz function of $g \sim \cN(0,1)$, and since $\Sigma'$ is $O(1/d)$-close to $\Sigma$ by \cref{lem:closeness}, $\Paren{\Sigma'}^{-1/2}\cF(\Sigma^{1/2}g)$ is also a $O(1)$-Lipschitz function of $g \sim \cN(0,1)$. By \cite{log-sobolev-are-hanson-wright}, this distribution satisfies $O(1)$-Hanson-Wright property.
\end{proof}

\begin{lemma}\label{lem:frobenius-stability}
      Let $0 < \e \lesssim 1$ such that $\e\log(1/\e) \gtrsim \log^2(d)/d$.  Let $\Sigma \in \R^{d\times d}$ be a positive definite matrix such that 
      \[
      \Paren{1-O(\e\log(1/\e)} \cdot \Id_d \preceq \Sigma \preceq\Paren{1+O(\e\log(1/\e)} \cdot \Id_d\,.
      \]
      Let $y_1,\ldots,y_n\simiid N(0,\Sigma)$ and $\cF$ be as in $\cref{def:function}$.

Then, with high probability, $\cF(y_1)\cF(y_1)^\top,\ldots,\cF(y_n)\cF(y_n)^\top$ is an $\Paren{\e,\delta,r,\cB_1, \cB_1\otimes \cB_1}$-stable set with respect to $M=\E\cF(y)\cF(y)^\top$ and $S = \E_{g\sim N(0,\Id)}\Paren{gg^\top / \norm{g}^2 - \Id}^{\otimes 2}$, where $\e \le \delta \le O\paren{\e\log(1/\e)}$ and $r\le O(1)$. 
\end{lemma}

\begin{proof}
    By \cref{lem:closeness},
     \[
      \Paren{1-O(\e\log(1/\e)} \cdot \Id_d \preceq \Sigma \preceq\Paren{1+O(\e\log(1/\e)} \cdot \Id_d\,.
      \]
    Denote $\zeta_i = \Paren{\Sigma'}^{-1/2}\cF(y_i)$. Let $J\subseteq[n]$ be a set of size $\card{J} \ge (1-\e)n$,  and let $V\in \cB_1$. Note that
    \[
    \tfrac{1}{\card{J}} \sum_{i\in J} \iprod{V, \cF(y_i)\cF(y_i)^\top-\E\cF(y)\cF(y)^\top} = \tfrac{1}{\card{J}} \sum_{i\in J} \iprod{\Paren{\Sigma'}^{-1/2}V\Paren{\Sigma'}^{-1/2}, \zeta_i \zeta_i^\top -\Id_d}
    \]
    By \cref{lem:frobenius-stability-isotropic}, $\zeta_1\zeta_1^\top,\ldots,\zeta_n\zeta_n^\top$ is $\Paren{\e,\delta,r,\cB_2, \cB_2\otimes \cB_2}$-stable
    with respect to $\Id_d$ and $Q = \E_{y\sim N(0,\Sigma)} \Paren{\Paren{\Sigma'}^{-1/2}\cF(y)\cF(y)^\top\Paren{\Sigma'}^{-1/2} - \Id}^{\otimes 2}$, hence the quantity above is bounded by $\delta = O(\e\log(1/\e))$, so condition 1 of stability is satisfied.

    Let us show the second condition. Note that
    \begin{align*}
   \tfrac{1}{\card{J}} \sum_{i\in J} \iprod{V^{\otimes 2}, \Paren{\cF(y_i)\cF(y_i)^\top-\E\cF(y)\cF(y)^\top}^{\otimes 2}} 
   &=
    \tfrac{1}{\card{J}} \sum_{i\in J} \iprod{V, \Paren{\cF(y_i)\cF(y_i)^\top-\E\cF(y)\cF(y)^\top}}^2 
    \\&=
        \tfrac{1}{\card{J}} \sum_{i\in J} \iprod{U, \Paren{\zeta_i \zeta_i^\top -\Id_d}}^2 \,,
        \end{align*}
    where $U = \Paren{\Sigma'}^{-1/2}V\Paren{\Sigma'}^{-1/2}$. By stability of $\zeta_1\zeta_1^\top,\ldots,\zeta_n\zeta_n^\top$, this quantity is $O(\delta^2/\e)$-close to $\iprod{U^{\otimes 2}, Q}$. Hence it is enough to show that
    \[
    \Abs{\iprod{U^{\otimes 2}, Q} - \iprod{V^{\otimes 2}, S}} \le O(\e\log^2(1/\e))\,.
    \]
    Since $\Paren{\Sigma'}^{-1/2} = \Id + A$, where $\Norm{A}\le O(\e\log(1/\e))$, 
    \[
    U = V + A V + VA + AVA\,.
    \]
    Since $\normf{AV}\le \norm{A}\cdot \normf{V} \le O(\e\log(1/\e))$,
    $U = V + \Delta$, where $\normf{\Delta} \le O(\e\log(1/\e))$.
    Hence $\iprod{\Delta^{\otimes 2}, Q} \le O(\e^2\log^2(1/\e))$. By the \CS inequality, 
    \[
    \Abs{\Iprod{V\otimes \Delta, Q}}\le \sqrt{\iprod{\Delta^{\otimes 2}, Q} \cdot \iprod{V^{\otimes 2}, Q}} \le  O(\e\log(1/\e))\,.
    \]
    Hence $\Abs{\iprod{U^{\otimes 2}, Q} - \iprod{V^{\otimes 2}, Q}} \le O(\e\log(1/\e))$, and it is enough to bound $\Iprod{V^{\otimes 2}, Q-S}$. By \cref{lem:tensor}, in the eigenbasis of $\Sigma$, for all $i,j\in [d]$, $Q_{ijij} = S_{ijij} + O(1/d)$, and $Q_{iijj} = S_{iijj} + O\Paren{\e\log(1/\e)/d}$. First let us bound the entries of the form $ijjij$:
    \[
    \sum_{i,j\in[d]}V_{ij}V_{ij}\Paren{Q_{ijij} - S_{ijij}} \le O(1/d)\cdot \sum_{i,j\in[d]}V_{ij}^2 \le O(1/d) \le O(\e\log(1/\e))\,.
    \]
    Now consider the entries of the form $iijj$. Since $\abs{\sum_{i=1}^d V_{ii}} \le \sqrt{d}$,
    \[
    \sum_{i,j\in[d]}V_{ii}V_{jj}\Paren{Q_{ijij} - S_{ijij}} \le O(\e\log(1/\e)/d)\cdot d \le O(\e\log(1/\e))\,.
    \]
    Since all other components of both $Q$ and $S$ are $0$, we get the desired bound.

    Condition 3 of the stability is clearly satisfied for $S$ (in particular, it follows from the proof above, since $Q$ is very close to $S$, and this condition is satisfied for $Q$).
\end{proof}

\cref{lem:frobenius-stability} and \cref{thm:filtering} imply that we get the desired estimator in relative Frobenius norm.