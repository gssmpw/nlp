\section{Generalized Stability}




\begin{lemma}\label{lem:stability}
    Let $m,\e,\delta, r, \cV, \cP, \mu, Q$ be as in \cref{def:stability}, and suppose that $\e < \delta < 0.1$. Let $S$ be a $\Paren{2\e,\delta,r,\cV,\cP}$-stable multiset of size $n\in \N$ with respect to $\mu$ and $Q$. Let $T = \Set{x_1,\ldots,x_n}$ be an $\e$-corruption of $S$. 

    Let $\cW_\e \subset \R^{n}$ be the set of vectors whose entries satisfy $0 \le w_i\le \frac{1}{n}$, $\sum_{i=1}^n w_i \ge 1 -\e$. For $w\in \cW_\e$ denote $\mu_w = \frac{1}{\sum_{i=1}^n w_i} \sum_{i=1}^{n} w_i x_i$ and $\Sigma_w = \frac{1}{\sum_{i=1}^n w_i}\sum_{i=1}^n w_i\paren{x_i-\mu_w}\paren{x_i-\mu_w}^\top$. 

    If for some $w\in \cW_\e$ and $\lambda > 0$, for all $P\in \cP$, $\Abs{\iprod{P, Q-\Sigma_w}} \le \lambda$, then 
    \[
    \sup_{v\in \cV}\; \Abs{\iprod{v, \mu_w-\mu}} \le O\Paren{\delta + \sqrt{\e\lambda} + \e r}\,.
    \]
\end{lemma}

\begin{proof}
Let $G$ be the set of indices of uncorrupted points in $T$, and let $B = [n]\setminus G$.
Note that
\[
\sum_{i=1}^{n} w_i\iprod{v, x_i - \mu} = \Paren{\tfrac{1}{\card{G}}\sum_{i\in G} \iprod{v,x_i - \mu}}
+ \sum_{i\in G} \Paren{w_i - \frac{1}{\card{G}}} \iprod{v,x_i - \mu} 
+ \sum_{i\in B} w_i \iprod{v,x_i - \mu}. 
\]
The first term is bounded by $\delta$. Let us bound the second term.
By \CS inequality, the second term can be bounded as follows:
\begin{align*}
\Paren{\sum_{i\in G} \Paren{w_i - \frac{1}{\card{G}}} \iprod{v,x_i - \mu}}^2
&\le
\Paren{\sum_{i\in G} \Paren{\frac{1}{\card{G}} - w_i}}
\cdot \sum_{i\in G}  \Paren{\frac{1}{\card{G}} - w_i} \iprod{v,x_i - \mu}^2 
\\&\le \e \cdot \sum_{i\in G}{\frac{1}{\card{G}}} \iprod{v,x_i - \mu}^2 
\\&\le \e \cdot \Paren{vQv^\top + \delta^2/\e}
\\&\le \e r^2 + \delta^2\,.
\end{align*}

It remains to bound the third term. By \CS inequality,
\[
\Paren{\sum_{i\in B} w_i \iprod{v,x_i - \mu}}^2\le
\Paren{\sum_{i\in B} w_i}
\cdot \sum_{i\in B}  w_i \iprod{v,x_i - \mu}^2 
\le
\e \cdot \sum_{i\in B}  w_i \iprod{v,x_i - \mu}^2 \,.
\]
Let $w'_i = w_i$ for all $i\in G$ and $w_i'=0$ otherwise. It follows that
\[
\Sigma_{w'} = \sum_{i\in G} w_i'(x_i-\mu)(x_i-\mu)^\top - \Paren{\sum_{i=1}^n w_i'} (\mu-\mu_{w'})(\mu-\mu_{w'})^\top\,.
\]
Note that
\[
\abs{\iprod{v,\mu-\mu_{w'}}} \le \abs{\iprod{v,\mu-\tfrac{1}{\card{G}}\sum_{i\in G} x_i}} + \abs{\iprod{v,\sum_{i\in G} \Paren{\tfrac{1}{\card{G}}-w_i} \paren{x_i-\mu}}} 
\le \delta + \sqrt{\e r^2 + \delta^2}\,.
\]
In addition, note that
\[
\sum_{i\in G} w_i'\iprod{v, x_i-\mu}^2 = \tfrac{1}{\card{G}}\sum_{i\in G} \iprod{v, x_i-\mu}^2 - 
\sum_{i\in G} \Paren{\tfrac{1}{\card{G}}-w_i'}\iprod{v, x_i-\mu}^2 = vQv^\top - \delta^2 - \e r^2\,.
\]
Hence
\[
v\Sigma_{w'}v^\top = vQv^\top - O\Paren{\delta^2 + \e r^2}\,.
\]

Since
\[
\sum_{i\in G} w_i\paren{x_i-\mu}\paren{x_i-\mu}^\top \succeq \Sigma_{w'}\,,
\]
\[
\sum_{i\in G} w_i \iprod{v, x_i-\mu}^2 \ge vQv^\top - O(\delta^2 + \e r^2).
\]
Therefore,
\begin{align*}
\sum_{i\in B} w_i \iprod{v, x_i-\mu}^2 
&\le
\sum_{i=1}^n w_i \iprod{v, x_i-\mu}^2 - \sum_{i\in G} w_i \iprod{v, x_i-\mu}^2
\\&\le \lambda + vQv^\top - vQv^\top + O(\delta^2 + \e r^2)
\\&\le \lambda +  O(\delta^2 + \e r^2)\,.
\end{align*}

By \CS inequality,
\[
\abs{\sum_{i\in G} w_i \iprod{v,x_i - \mu}} \le \sqrt{\e} \cdot \sqrt{\lambda +  O(\delta^2 + \e r^2)}\,.
\]
Since $\sum_{i=1}^n w_i \ge 1/2$, we get the desired bound.

\end{proof}

To analyze the (generalized) filtering algorithm, we need the following notion.

\begin{definition}[Adequacy of $\cP$]\label{def:adequate}
    Let $m\in \N$, $\cV \subset \R^m$, $\cP \subset \R^{m\times m}$ such that $\cV\otimes \cV \subset \cP$. We say that $\cP$ is \emph{adequate with resect to $\cV$}, if
    \begin{enumerate}
        \item For all $a \in \R^m$ and $P \in \cP$, $\Iprod{a^{\otimes 2}, P} \ge 0$
        \item For all $a,b\in \R^m$ and $P\in \cP$, 
        \[
        \Iprod{a\otimes b, P}^2 \le \Paren{\sup_{v\in \cV}\Iprod{a, v}^2}\cdot\Paren{\sup_{v\in \cV}\Iprod{b, v}^2}\,.
        \]
    \end{enumerate}
\end{definition}

When $\cP = \cV\otimes \cV$, it is clearly adequate with respect to $\cV$. Further we show (\cref{lem:adequate}) that the \emph{sum-of-squares relaxation} of the set of tensors of the form $v^{\otimes4}$ is adequate with respect to the set of matrices of the form $v^{\otimes 2}$. 

% \begin{proof}
% Let $v\in \cV$. 

% For a set of indices $J \subseteq [n]$, denote $\mu_{J} = \frac{\sum_{i\in J} w_i x_i}{\sum_{i\in J} w_i}$ and $\Sigma_{J}=\frac{\sum_{i\in J} w_i\paren{x_i-\mu_J}\paren{x_i-\mu_J}^\top}{\sum_{i\in J} w_i}$.

% Let $G$ be a set of indices of uncorrupted points in $T$. Let $B = [n]\setminus G$. 

% For $t \in \cW$, consider $f(t) = {\iprod{vv^\top, \sum_{i\in G} t_i\paren{x_i-\mu_w}\paren{x_i-\mu_w}^\top - Q}}$. It is a linear function, hence its minimum is achieved in one of the extreme points of $\cW$. Therefore, there exists a set $G'$ of size $\card{G'} \ge (1-2\e)n$ such that
% \[
% {\iprod{vv^\top, \sum_{i\in G} w_i\paren{x_i-\mu_w}\paren{x_i-\mu_w}^\top - Q}}
% \ge
% {\iprod{vv^\top, \tfrac{1}{n}\sum_{i\in G'} \paren{x_i-\mu_w}\paren{x_i-\mu_w}^\top - Q}}\,.
% \]

% Note that
% \begin{align*}
% v\Paren{\tfrac{1}{n}\sum_{i\in G'} \paren{x_i-\mu_w}\paren{x_i-\mu_w}^\top - Q}v^\top 
% &=
% \tfrac{1}{n} v\Paren{\sum_{i\in G'} \paren{x_i-\mu_w}\paren{x_i-\mu_w}^\top - \card{G'}Q - (n-\card{G'}) Q}v^\top
% \\&\ge
% -\delta^2/\e - 2\e r + \frac{\card{G'}}{n}\iprod{v,\mu_G - \mu_w}^2
% \\&\ge 
% -\delta^2/\e - 2\e r + \Paren{\sum_{i\in G'} w_i}\cdot \iprod{v,\mu_G - \mu_w}^2\,.
% \end{align*}

% Since $\Abs{\iprod{vv^\top, Q-\Sigma_T}}\le \lambda$,
% \begin{align*}
% \lambda &\ge v^\top\Paren{\Sigma_w - Q} v 
% \\&\ge v^\top\paren{\tfrac{1}{n}\sum_{i\in G'} \paren{x_i-\mu_w}\paren{x_i-\mu_w}^\top - Q} v + (1-2\e)\cdot\iprod{v,\mu_G - \mu_w}^2
% \\&\ge -\delta^2/\e - \e r + \tfrac{\e}{2}\cdot\iprod{v,\mu_{S'} - \mu_E}^2\,.
% \end{align*}

% Hence $\abs{\iprod{v,\mu_{S'} - \mu_E}} \le O\Paren{\delta/\e + \sqrt{r} + \sqrt{\lambda / \e}}$. It follows that
% \begin{align*}
% \abs{\iprod{v,\mu_T - \mu}} 
% &= \abs{\iprod{v,\paren{1-\e}\mu_{S'} + \e \mu_E - \mu}}
% \\&\le \abs{\iprod{v,\mu_{S'} - \mu}} + \e \cdot\abs{\iprod{v,\mu_{S'} - \mu_E}}
% \\&\le O\Paren{\delta + \e\sqrt{r} + \sqrt{\e\lambda}}\,.
% \end{align*}

% Since $v\in\cV$ is arbitrary, we get the desired bound.

% \end{proof}