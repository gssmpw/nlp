\begin{tikzpicture}
\tikzset{
    protocol_action/.style={
        draw,align=center,minimum height=1cm
        },
    buffer_memory/.style={
        draw,align=center,ellipse
        },
}
%
% == PROTOCOL ACTIONS
%
\node[protocol_action] (rec_tr) at (0,0) {receive\\transaction};
\node[protocol_action,right=.75cm of rec_tr] (prop_vert) {propose\\vertex};
%
\node[protocol_action,below=1.75cm of prop_vert] (add_todag) {add to\\DAG};
\node[protocol_action,above right=-.6cm and 1.5cm of add_todag] (rec_vert) {receive\\vertex};
%
%
\node[draw, right=.5cm of rec_vert] (r_deliver) {$\mathtt{rdlver}$};
\node[draw, right=3.15cm of prop_vert] (r_bcast) {$\mathtt{rbcast}$};
%
\node[protocol_action,below right=.8cm and -.8cm of rec_vert] (sel_leader) {select\\leader};
\node[protocol_action,left=.6cm of sel_leader] (get_wave) {get\\wave};
\node[protocol_action,left=.6cm of get_wave] (order_vert) {order\\wave}; 
\node[protocol_action,below=3cm of rec_tr] (del_tr) {finalize\\transactions};
%
%
\node[draw, right=.3cm of sel_leader] (c_flip) {$\mathtt{cflip}$};
%
%
% == MEMORY
%
\node[buffer_memory,below left=.55cm and .5cm of prop_vert] (bf_tr) {\footnotesize transactions\\\footnotesize mempool};
\node[buffer_memory,below left=.3cm and .2cm of r_bcast] (bf_vert) {\footnotesize buffered\\\footnotesize vertices};
\node[buffer_memory,below right=.6cm and 0cm of prop_vert] (bf_dag) {\footnotesize DAG};
%
% == OPERATIONS
%
\draw (bf_tr.150 |- rec_tr.south) edge[->,red]  node[right] {\scriptsize \ul{push}} (bf_tr.150);
\draw (prop_vert) edge[->,red] node[below right] {\scriptsize \ul{extract}} (bf_tr);
\draw (prop_vert) edge[->,red] node[right] {\scriptsize \ul{lookup}} (bf_dag);
\draw (add_todag) edge[->,red]  node[below left] {\scriptsize \ul{filter-out}} (bf_tr);
%
\draw (rec_vert.120) edge[->,red] node[right,pos=.4] {\scriptsize \ul{push}} (bf_vert.220);
\draw (add_todag) edge[->,red] node[above,pos=.75] {\scriptsize \ul{pop}} (bf_vert);
\draw (add_todag) edge[->,red] node[left] {\scriptsize \ul{add}} (bf_dag);
%
\node[inner sep=0pt] (anchor_lookup_dag_split) at ($(bf_dag.south) + (0,-1.9)$) {};
\draw (bf_dag.south) edge[<-,red] node[right,pos=.9] {\scriptsize \ul{lookup}} (anchor_lookup_dag_split.south);
\draw (anchor_lookup_dag_split) edge[red] (sel_leader.110 |- anchor_lookup_dag_split.south);
\draw (sel_leader.110) edge[red] (sel_leader.110 |- anchor_lookup_dag_split.south);
\draw (anchor_lookup_dag_split) edge[red] (order_vert.north |- anchor_lookup_dag_split.south);
\draw (order_vert.north) edge[red] (order_vert.north |- anchor_lookup_dag_split.south);
\draw (get_wave.north) edge[red] (get_wave.north |- anchor_lookup_dag_split.south);
%
% == TRIGGERS
%
\draw (rec_tr) edge[dashed,->] (prop_vert);
\draw (add_todag) edge[dashed,->] (prop_vert);
%
\draw (prop_vert) edge[->] node[above] {\scriptsize $V$} (r_bcast);
\draw (rec_vert.west |- add_todag.20) edge[dashed,->] (add_todag.20);
%
\draw (add_todag) edge[loop left,dashed,->] (add_todag);
%
\draw (sel_leader) edge[->] node[above] {\scriptsize $V$} (get_wave);
%
\draw (get_wave) edge[->] node[above] {\scriptsize $\{V\}$} (order_vert);
\draw (order_vert.west) edge[->] node[above] {\scriptsize $[X]$} (del_tr.east |- order_vert.west);
%
%
\node[inner sep=0pt] (anchor_add_to_dag_right) at (sel_leader.80 |- add_todag.330) {};
\draw (add_todag.330) edge[dashed] (anchor_add_to_dag_right);
\draw (anchor_add_to_dag_right) edge[->,dashed] (sel_leader.80);
%
%
% == OTHER LAYERS
%
%
\draw (r_deliver) edge[->,dashed] (rec_vert);
\draw (sel_leader) edge[<->,dashed] (c_flip);
%
% == EXTERNAL COMMS
%
\draw ($(r_deliver.east) + (.3,0)$) edge[->] node[above,pos=.3] {\scriptsize $V$} (r_deliver);
\draw (r_bcast.east) edge[->] node[above,pos=.7] {\scriptsize $V$} ($(r_deliver.east |- r_bcast.east) + (.3,0)$);
%
\draw ($(rec_tr.west) + (-.3,0)$) edge[->] node[above,pos=.3] {\scriptsize $X$} (rec_tr);
%
\draw (c_flip.east) edge[<->] ($(r_deliver.east |- c_flip.east) + (.3,0)$);
%
% == LAYERS COLORATION
%
\node[inner sep=0pt] (anchor_full_top) at ($(rec_tr.north) + (0,.1)$) {};
\node[inner sep=0pt] (anchor_full_left) at ($(del_tr.west) + (-.25,0)$) {};
\node[inner sep=0pt] (anchor_full_right) at ($(r_bcast.east) + (.25,0)$) {};
\node[inner sep=0pt] (anchor_full_bottom) at ($(sel_leader.south) + (0,-.1)$) {};
%
\node[inner sep=0pt] (anchor_application_right) at ($(rec_tr.east) + (.25,0)$) {};
%
\node[inner sep=0pt] (anchor_broadcast_left) at ($(r_bcast.west) + (-.125,0)$) {};
%
\node[inner sep=0pt] (anchor_ordering_top) at ($(sel_leader.north) + (0,.125)$) {};

\begin{scope}[on background layer]
\path[fill=yellow,opacity=.5] 
    (anchor_full_left |- anchor_full_top) 
    -- (anchor_application_right |- anchor_full_top) 
    -- (anchor_application_right |- anchor_full_bottom) 
    -- (anchor_full_left |- anchor_full_bottom) ;
\path[fill=green,opacity=.5] 
    (anchor_application_right |- anchor_full_top) 
    -- (anchor_broadcast_left |- anchor_full_top) 
    -- (anchor_broadcast_left |- anchor_ordering_top) 
    -- (anchor_application_right |- anchor_ordering_top)  ;
\path[fill=darkspringgreen,opacity=.5] 
    (anchor_application_right |- anchor_ordering_top) 
    -- (anchor_broadcast_left |- anchor_ordering_top) 
    -- (anchor_broadcast_left |- anchor_full_bottom) 
    -- (anchor_application_right |- anchor_full_bottom)  ;
\path[fill=blue,opacity=.5] 
    (anchor_broadcast_left |- anchor_full_top) 
    -- (anchor_full_right |- anchor_full_top) 
    -- (anchor_full_right |- anchor_ordering_top) 
    -- (anchor_broadcast_left |- anchor_ordering_top)  ;
\path[fill=orange,opacity=.5] 
    (anchor_broadcast_left |- anchor_ordering_top) 
    -- (anchor_full_right |- anchor_ordering_top) 
    -- (anchor_full_right |- anchor_full_bottom) 
    -- (anchor_broadcast_left |- anchor_full_bottom)  ;
\end{scope}
%
% == LEGEND
%
\node[align=center] (leg1) at (.3,-5.1) {\small$\square$ action, $\circ$ memory}; 
%
\node[below=.25cm of leg1.south west,anchor=west,align=center] (leg2) {\small\shortColRed{$\rightarrow$} \ul{operation}, $\dashrightarrow$ may trigger}; 
%
\node[below=.25cm of leg2.south west,anchor=west,align=center] (leg3) {\small$\xrightarrow{Z}$ calls with value of type $Z$}; 
%
\node[below=.25cm of leg3.south west,anchor=west,align=center] (leg4) {\small `$X$' transaction, `$V$' vertex}; 
%
\node[right=1.5cm of leg1,align=center] (dr_leg0) {\small\textcolor{yellow}{$\blacksquare$} \textbf{Application layer}}; 
\node[below=.25cm of dr_leg0.south west,anchor=west,align=center] (dr_leg) {\small\textcolor{green}{$\blacksquare$}/\textcolor{darkspringgreen}{$\blacksquare$} \textbf{DagRider layers}};
\node[below=.25cm of dr_leg.south west,anchor=west,align=center] (rb_leg) {\small\textcolor{blue}{$\blacksquare$} \textbf{Reliable Broadcast layer}};  
\node[below=.25cm of rb_leg.south west,anchor=west,align=center] (gc_leg) {\small\textcolor{orange}{$\blacksquare$} \textbf{Global Coin layer}};
\end{tikzpicture}