

\subsection{Deterministic order for wave finalization\label{ssec:deterministic_order}}


In \cite{all_you_need_is_dag,bullshark,narwhal_and_tusk}, the deterministic process used to order vertices within a wave is not described beyond the requirement that it is deterministic (to guarantee consistency).
However, as we are interested in OF, implementation details matter.
In this paper, we consider three variants: ``FullShuffle'', ``PerColumnShuffle'' and ``VoteCount''.



\paragraph{FullShuffle} This simply consists in randomly shuffling the vertices. 
To ensure determinism, we can fix a PRNG seed. So that it is shared without communication overhead and cannot be predicted in advance, this seed may be computed from e.g., the leader vertex hash value.


\paragraph{PerColumnShuffle} In this variant: \textbf{(1)} the causal sub-graph is split by columns, \textbf{(2)} for each column, vertices are sorted according to a permutation of the rows that depends on a PNRG which seeds depends on the corresponding vertices hash values (ensuring fairness and consistency) and \textbf{(3)} vertices are delivered in ascending order of columns.



\paragraph{VoteCount} This variant is inspired by \cite{reducing_latency_of_dag_based_consensus_in_the_asynchronous_setting_via_the_utxo_model}, \cite{themis_fast_strong_order_fairness_in_byzantine_consensus} and \cite{diversified_top_k_graph_pattern_matching}.
\cite{reducing_latency_of_dag_based_consensus_in_the_asynchronous_setting_via_the_utxo_model} considers that a node $r$ ``votes'' for a vertex $v$ at column $c$ if $c$ is the earliest column such that $v$ is in the causal sub-graph of $v_c^r$.

\begin{figure}[h]
\vspace*{-.4cm}
    \centering

\begin{subfigure}{.24\textwidth}
    \centering
    \scalebox{.85}{\input{figures/deterministic/do_example_full}}
    \caption{Wave}
    \label{fig:ex_full_wave}
\end{subfigure}
%
\begin{subfigure}{.23\textwidth}
    \centering
    \scalebox{.7}{\input{figures/deterministic/do_full_vote_table}}
    \caption{Vote table}
    \label{fig:ex_full_table}
\end{subfigure}
    \caption{Example Wave}
    \label{fig:do_example_1}
\vspace*{-.4cm}
\end{figure}


Fig.\ref{fig:ex_full_wave} displays a wave which leader is $v^C_4$.
By interpreting the structure of the DAG, one can infer the vote table on Fig.\ref{fig:ex_full_table}.
Let us focus on $v_2^A$. Node $A$ votes for vertex $v_2^A$ at column $2$ because it is its own proposal. 
In the considered wave, $B$ never vote for $v_2^A$ because there is no edge between $v_2^B$ and $v_2^A$ (hence the $\infty$ on Fig.\ref{fig:ex_full_table}). 
$D$ votes for $v_2^A$ at column $3$ because there is an edge between $v_3^D$ and $v_2^A$. 
$C$ votes for $v_2^A$ at column $4$ because there is a path between $v_4^C$ and $v_2^A$ (via either $v_3^A$ or $v_3^D$) but no path between $v_3^C$ and $v_2^A$.


From the vote table, a partial order $\geq_{\text{\faEnvelopeO}}$ is inferred.
In \cite{reducing_latency_of_dag_based_consensus_in_the_asynchronous_setting_via_the_utxo_model} it corresponds to, $x <_{\text{\faEnvelopeO}} x'$ iff $|\{\text{nodes vote}~x~\text{first}\}| > |\{\text{nodes vote}~x'~\text{first}\}|$.
The reader may notice the similarity with receive-order-fairness \cite{order_fairness_for_byzantine_consensus}.
In light of \cite{order_fairness_for_byzantine_consensus,quick_order_fairness,themis_fast_strong_order_fairness_in_byzantine_consensus}, many variants of $\geq_{\text{\faEnvelopeO}}$ may be considered.
Then, $\geq_{\text{\faEnvelopeO}}$ can be used to order the vertices of the wave.
However, \cite{reducing_latency_of_dag_based_consensus_in_the_asynchronous_setting_via_the_utxo_model} does not acknowledge the issue of Condorcet cycles (see Appendix \ref{anx:bug_board_and_clerk}).
The mechanism which we retain is inspired by \cite{order_fairness_for_byzantine_consensus,themis_fast_strong_order_fairness_in_byzantine_consensus}, using an additional notion from \cite{diversified_top_k_graph_pattern_matching}.
For editorial constraints, we discuss it in Appendix \ref{anx:vote_count_mechanism}.



