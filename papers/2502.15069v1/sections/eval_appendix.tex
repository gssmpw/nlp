\subsection{Training Details}\label{sec:training_details}
We train for 10 epochs using supervised fine-tuning only on 8 Nvidia A100s.  Each training run, using the huggingface transformers library (v4.43.3), took 2-3 hours depending on the setup. We used the AdamW 8-bit optimizer \cite{Loshchilov2017DecoupledWD}, a learning rate of $2e^{-05}$, and a batch size of 4. We selected these parameters based on early experiments on subsets of our larger disease set.

\subsection{Evaluation Details}
\label{sec:eval_app}
Following the approach in Section \ref{sec:data_gen}, we generate chats using gpt-4o and claude-sonnet 3.5.  For each, we create train, validation, and test splits as detailed in Appendix Table \ref{tab:data_details}.  We also provide the average and standard deviation of the number of findings and the number of messages.  To ensure that both the validation and test sets are distinct from the training set, we removed all examples from the training set that have the exact same structured case in the validation or test sets. We generated a smaller dataset for claude due to the additional cost and time of running multiple prompts per chat.

\subsubsection{Expert Evaluation}
\label{sec:eval_app_eval}

We provide the annotators with the chat, list of findings, and the seed disease.  They are asked
\textit{``Assume the patient has a rare disease and more common conditions have been ruled out. Is this specific rare disease a possible diagnosis for the patient? This rare disease doesnâ€™t need to be the most likely diagnosis, but just a possible diagnosis.''}.  They are prompted to respond yes or no, and provide a 1-2 sentence explanation.  They are allowed to use any external reference material they choose.

One challenge in this annotation task is that our dataset does not include negative examples as they are not required for training.  However, only annotating positive examples may lead to annotators blindly answering ``yes''.  Therefore, we generate negative training examples solely for expert evaluation and ask annotators to review datasets that are 90\% positives and 10\% negatives.  

Generating a chat where a rare disease is not possible is a challenging task.  Providing annotators with cases that are obviously negative would not be informative. Generating cases where a disease is negative but close requires conclusively ruling out a disease, which is challenging in a history taking setting where lab work isn't performed. 
To achieve a close approximation, we regenerate examples from our expert system and take diagnoses that were present in earlier simulation phases but removed later when additional findings were added.  These ``discarded diagnoses'' are likely to be negative diagnoses for the findings. 

We separately generate chats for these findings and discarded diagnosis using the process described in Section \ref{sec:data_gen}.  As a second filtering step, we provide the chat and discarded diagnosis to a gpt-4o prompt, and prompt it to provide the same binary judgment and explanation as we do with the annotators.  Finally, we manually filter out chats where the explanation rests mostly on likelihood (\textit{i.e.} disease A is unlikely because disease B is more likely), and retain cases where there is a clear separation.  However, we want to emphasize that even in these cases, it is hard to completely rule out a rare disease.  All cases were reviewed by at least one annotator -- cases where the original annotator disagreed with the initial label was reviewed by a second labeler.

\subsection{Expert Evaluation Results}\label{sec:eval_app_results}

While the agreement rate for negative cases is lower than the agreement for positive cases, it is inherently challenging to create believably negative cases.  It also does not impact \methodname's performance given that we only add negatives to ensure that annotators do not blindly choose yes. We include a selection of annotator reasoning in Appendix Table \ref{tab:ann_reasoning}. In many cases where the annotator disagrees with our baseline label, they note that the full symptom set isn't present for the disease.  While that may make it unlikely, that does not mean it can be ruled out entirely because an atypical presentation could occur or further symptoms may arise.  This tension is inherent when dealing with rare diseases.
