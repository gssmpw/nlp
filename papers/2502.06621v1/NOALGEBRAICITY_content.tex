\section{Introduction}\label{section:introduction}  
 

 \subsection{The finite-domain CSP dichotomy theorem} 
%
 Fixed-template  \emph{Constraint Satisfaction Problems} are computational problems parametrized by  structures $\struct{A}$ with a finite relational signature, called \emph{templates}; they are denoted by $\CSP(\struct{A})$ and ask whether a given structure $\struct{J}$ with the same signature as $\struct{A}$ admits a homomorphism to $\struct{A}$. 
The general CSP framework is incredibly rich, in fact, it contains all decision problems up to polynomial-time equivalence~\cite{bodirsky2008non}.
%
For this reason, CSPs are typically studied under additional structural restrictions on the template $\struct{A}$.
%
The restriction that has received most attention is requiring the domain of $\struct{A}$ to be finite, and the problems arising in this way are called \emph{finite-domain} CSPs.
%
Already in this setting, one obtains many well-known problems such as HORN-SAT, 2-SAT, 3-SAT, or 3-COLORING.

Consider the concrete example of 3-COLORING. This prominent  
 NP-complete problem can be modeled as $\CSP(\struct{K}_3)$, where $\struct{K}_3$ stands for the complete graph on three vertices: indeed, a homomorphism to $\struct{K}_3$ from a given structure $\struct{J}$ in the same signature (i.e.~from a given graph $\struct{J}$) is simply a  mapping that does not map any  two adjacent vertices of $\struct{J}$ to the same vertex of $\struct{K}_3$.
% 
A key observation in the theory of CSPs is that the NP-completeness of $\CSP(\struct{K}_3)$ can be extended to CSPs of other structures which can ``simulate'' $\struct{K}_3$ over their domain or over a finite power thereof using \emph{primitive positive} (pp) formulas.
%  
Enhancing this by the additional observation that \emph{homomorphically equivalent}  templates have equal CSPs, one arrives at the notion of \emph{pp-constructibility}~\cite{barto2018wonderland}.  
%
If $\struct{A'}$ is pp-constructible from $\struct{A}$, then $\CSP(\struct{A'})$ is reducible to $\CSP(\struct{A})$ in logarithmic space; this uniform  reduction between CSP templates is sufficiently powerful, as we will see below, to describe all NP-hardness amongst finite-domain CSPs.


In the early 2000s, the field of finite-domain constraint satisfaction quickly rose in fame, in particular due to the discovery of  tight  connections  with universal algebra.
%
The most basic of these connections is that two structures with identical domains have the same sets of pp-definable relations if and only if they have the same sets of polymorphisms~\cite{jeavons1997closure,jeavons1998algebraic}.
%
Here, a \emph{polymorphism} of a relational structure $\struct{A}$ is simply a homomorphism from a finite power of $\struct{A}$ into $\struct{A}$ itself; we denote by $\Pol(\struct{A})$ the set of all polymorphisms of $\struct{A}$, the \emph{polymorphism clone} of $\struct{A}$.
%  
Since taking expansions by primitive positive relations does not lead to an increase in complexity, the study of finite-domain CSPs is subsumed by the study of finite algebras.
% 
Over the past two decades, the link between universal algebra and CSPs was  gradually refined.
%
After an intermediate stop at \emph{pp-interpretations}~\cite{bulatov2005classifying}, today we know that also pp-constructibility between finite relational structures is fully encoded in their polymorphism clones~\cite[Theorem~1.3]{barto2018wonderland}: $\struct{A'}$ is pp-constructible from  $\struct{A}$ if and only if $\Pol(\struct{A'})$ satisfies all \emph{height~1 identities} of $\Pol(\struct{A})$.


By a breakthrough result of Bulatov~\cite{bulatov2017dichotomy} and Zhuk~\cite{zhuk2017proof,zhuk2020proof}, the pp-construction of $\struct{K}_3$ is the unique source of NP-hardness for finite-domain CSPs (if P$\neq$NP), and in fact, they provided a polynomial-time algorithm for any such CSP which does not  pp-construct $\struct{K}_3$. 
Besides its complexity-theoretic significance (in particular, of confirming the dichotomy conjecture of Feder and Vardi~\cite{federvardi1998}), this result has the additional appeal that the border for tractability can be described by a neat universal-algebraic condition on polymorphism clones.
%  
We state the theorem of Bulatov and Zhuk in a formulation which takes into account the results in~\cite{barto2018wonderland} and~\cite{Siggers_2010}.

\begin{theorem}[Bulatov and Zhuk~\cite{bulatov2017dichotomy,zhuk2017proof}]  \label{thm:finite_domain_CSP} Let $\struct{A}$ be a finite relational structure.
%
Then either $\struct{A}$ pp-constructs $\struct{K}_3$ and $\CSP(\struct{A})$ is NP-complete, or $\Pol(\struct{A})$ satisfies the \emph{Siggers identity} $ s(x,y,z,x,y,z) \approx s(y,z,x,z,x,y)$ and $\CSP(\struct{A})$ is solvable in polynomial time.  
\end{theorem} 
 
\subsection{The infinite-domain CSP tractability conjecture}\label{subsection:intro_conjecture}
 
Arguably, the two main reasons for the popularity  of finite-domain CSPs over CSPs which require an infinite template are immediate containment of such problems in the class NP (a homomorphism can be guessed and verified in polynomial time) as well as the above-mentioned applicability of algebraic methods  which   had been developed independently of CSPs for decades. Yet, even within the class NP, finite-domain CSPs are of an extremely restricted kind: already simple problems such as ACYCLICITY of directed graphs (captured by the template $(\mathbb Q;<)$),  various natural coloring problems for graphs such as NO-MONOCHROMATIC-TRIANGLE, and more generally the model-checking problem for  natural restrictions of existential second-order logic such as the logic MMSNP of Feder and Vardi~\cite{federvardi1998}, are beyond its primitive scope despite their containment in NP. 

The quest for a CSP framework that includes  such problems whilst  staying within NP and allowing for an algebraic approach akin to the one for finite templates  started with the popularization of \emph{$\omega$-categoricity} by Bodirsky and Ne\v{s}et\v{r}il~\cite{bodirsky2006constraint} as a sufficient structural restriction ensuring the latter:
%
for $\omega$-categorical structures $\struct{A}$, pp-definability is determined by their polymorphism clone and, as was subsequently shown, so are the general reduction of pp-interpretability~\cite{Topo-Birk} as well as the pp-constructibility of $\struct{K}_3$~\cite{barto2018wonderland}.
%
The property of $\omega$-categoricity of $\struct{A}$ can be interpreted as $\struct{A}$ being ``finite modulo automorphisms'':
%
more precisely, the  action of its  automorphism group $\Aut(\struct{A})$ on $d$-tuples has only finitely many orbits for all finite $d\geq 1$.
%
It is, however, a mathematical property with little computational bearing: the CSPs of $\omega$-categorical structures can be monstrous from this perspective~\cite{GJKMP-conf,gillibert2022symmetries}.
%
For this reason, and based on strong empirical evidence, Bodirsky and Pinsker~\cite{bodirsky2021projective} identified  a proper subclass of $\omega$-categorical structures as a candidate for an algebraic complexity dichotomy extending the theorem of Bulatov and Zhuk which does not seem to suffer from this deficiency.
%

 
Their first requirement on $\struct{A}$ is that the orbit under $\Aut(\struct{A})$ of any $d$-tuple  be determined by the relations that hold on it: we call a relational structure $\struct{A}$ \emph{homogeneous} if every isomorphism between its finite substructures  extends to an automorphism of $\struct{A}$.
%
This gives an effective way of representing orbits, which are central to $\omega$-categoricity.
%
They then additionally impose an effective way of determining whether a given finite substructure is contained in $\struct{A}$, which places the CSP in NP:
%
a relational structure $\struct{A}$ over a finite signature $\tau$ is \emph{finitely bounded}~\cite{macpherson2011survey} if there exists a finite set $\mathcal{N}$ of finite $\tau$-structures (\emph{bounds}) such that a finite $\tau$-structure embeds into $\struct{A}$ if and only if it does not embed any member of $\mathcal{N}$;
%
equivalently,  the finite substructures are up to isomorphism precisely the finite models of some universal first-order sentence~\cite[Lemma~2.3.14]{bodirsky2021complexity} (see also~\cite{Bodirsky-Mottet,rydval_arxiv} for more details).
%E
\begin{example} \label{ex:properties_of_q}
    A standard example of a finitely bounded homogeneous structure is $(\mathbb{Q};<)$. Its finite substructures are all finite strict linear orders, which can be axiomatized by irreflexivity, totality, and transitivity:
    %
    \[
    \forall x,y,z\;\; \big(\; (\neg x<x)  \;\wedge\; ( x<y \vee y<x) \;\wedge\; (x<y \wedge y<z \Rightarrow x<z) \;\big).
    \]
    %
    Every isomorphism between two such finite substructures can be extended to an automorphism of $(\mathbb{Q};<)$, e.g.~by a piecewise affine transformation.
\end{example}

Finite boundedness and homogeneity taken together are very strong an assumption. However,  Bodirsky and Pinsker observed that for all practical purposes, in particular the applicability of polymorphisms to complexity as well as containment in NP, it is sufficient that the template $\struct{A}$  be a \emph{first-order reduct} of a structure $\struct{B}$ enjoying these, i.e.  first-order definable therein. 
%
 This yields  sufficient flexibility to model a huge class of computational problems which includes in particular the ones mentioned above.  In fact, requiring $\struct{A}$ to be a \emph{reduct} of a finitely bounded homogeneous structure $\struct{B}$, i.e.~obtained from $\struct{B}$ by forgetting relations,  turns out to be equivalent~\cite[Proposition 7]{baader_rydval}, and we shall find this  approach convenient. 
 %
 \begin{example} \label{ex:properties_of_q1} The CSP of the template $(\mathbb Q;\Betw)$, first-order defined by $\Betw(x,y,z):\Leftrightarrow (x<y<z)\vee (z<y<x)$ in the structure $(\mathbb Q;<)$, is the classical NP-complete \emph{betweenness problem} from the 1970s~\cite{opatrny}. 
 \end{example}
 %
 The following formulation of the Bodirsky-Pinsker conjecture takes into account later progress~\cite{barto2018wonderland,barto_pinsker_proc,barto_pinsker_journal,barto2019equations}.
   


\begin{conjecture}[Bodirsky and Pinsker 2011~\cite{bodirsky2021projective}] \label{conj:bodirsky_pinsker} Let $\struct{A}$ be a reduct of a finitely bounded
homogeneous structure $\struct{B}$. Then one of the following holds.
% 
\begin{itemize}
    \item $\struct{A}$ pp-constructs $\struct{K}_3$ (and consequently, $\CSP(\struct{A})$ is NP-complete);
    \item $\Pol(\struct{A})$ satisfies the \emph{pseudo-Siggers identity}  $\alpha \circ s(x,y,z,x,y,z) \approx \beta \circ s(y,z,x,z,x,y)$, and  $\CSP(\struct{A})$ is polynomial-time solvable.
\end{itemize} 
\end{conjecture} 
 
 It is important to note that the open part of Conjecture~\ref{conj:bodirsky_pinsker} is only the consequence of polynomial-time tractability: the negation of the first item does yield the satisfaction of the pseudo-Siggers identity by a theorem due to Barto and Pinsker~\cite{barto_pinsker_journal}. It is even equivalent to it for \emph{model-complete cores}~\cite[Theorem~1.3]{barto2019equations}: an $\omega$-categorical model-complete core is a template $\struct{A}$ whose endomorphisms preserve all orbits of $\Aut(\struct{A})$; it exists for all CSPs with an $\omega$-categorical template and is unique up to isomorphism~\cite{bodirsky2007cores}. 
  

\section{Three meta-questions: our contributions}\label{section:introduction_contributions}
 
The present article aims to resolve three meta-questions around  Conjecture~\ref{conj:bodirsky_pinsker}, of which the first concerns its scope; the second the algebraic invariants of templates therein; and the third  its connection with the rapidly evolving field of (finite-domain) Promise Constraint Satisfaction Problems. More precisely, we consider the following questions:
%
\begin{enumerate}
    \item Are there significant additional  structural  assumptions that  can be imposed onto the structures of Conjecture~\ref{conj:bodirsky_pinsker} without loss of generality, i.e.~without affecting the truth of the conjecture?
    \item Are there significant algebraic   assumptions that  can be imposed onto the polymorphisms of the structures of Conjecture~\ref{conj:bodirsky_pinsker} without loss of generality?
    \item Are there  algorithmic connections between CSPs from  Conjecture~\ref{conj:bodirsky_pinsker} and  Promise Constraint Satisfaction Problems?
\end{enumerate}
%
We provide affirmative answers to all three questions, as we shall  describe  in the following. 

 

\subsection{Algebraicity is irrelevant} 
\label{section:introduction_no_alg}

 Conjecture~\ref{conj:bodirsky_pinsker} has been confirmed for many subclasses. Mottet and Pinsker speak of first- and second-generation classifications~\cite{mottet2024smooth}:
 %
 those of the former kind  can  roughly be described as exhaustive case-by-case analyzes, using Ramsey theory, of the available polymorphisms for structures first-order definable in a fixed finitely bounded homogeneous structure $\struct{B}$ -- extensive complexity classifications such as those for temporal CSPs~\cite{ComplOfTempCSPs}, Graph-SAT problems~\cite{BodPin-Schaefer-both}, Poset-SAT problems~\cite{posetCSP16}, and CSPs with templates first-order definable in arbitrary homogeneous graphs~\cite{BMPP16} were obtained this way.
 %
 Second-generation classifications, on the other hand, take a more structured approach mimicking advanced algebraic methods for finite domains; they were  employed, for example,  to achieve classifications for the logic MMSNP~\cite{MMSNP-Journal}, Hypergraph-SAT problems~\cite{mottet_et_al:LIPIcs.ICALP.2024.148}, and certain graph orientation problems~\cite{feller2024algebraic,bitter2024completion}.
 %
 However, even the most advanced methods as described in~\cite{mottet2024smooth}  require additional abstract  structural assumptions on the template. 

 One such assumption is that the template $\struct{A}$, or even the structure $\struct{B}$ in which it is first-order defined, has \emph{no algebraicity}. It is present virtually everywhere in the infinite-domain CSP literature~\cite{MMSNP-Journal}; and in particular an important prerequisite in most of the general results of the theory of \emph{smooth approximations}  developed by Mottet and Pinsker~\cite{mottet2024smooth}, as well as in all results of Bodirsky and Greiner~\cite{bodirsky2020complexity,bodirsky2021tractable} about CSPs of \emph{generic superpositions} of theories. We say that a structure $\struct{A}$ has \emph{no algebraicity} (in the group-theoretic sense) if, for every $k\geq 1$ and every tuple $\bar{a}\in A^k$, the automorphisms of $\struct{A}$ which stabilize $\bar{a}$ do not stabilize any $a'\notin \bar{a}$.
%
In $\omega$-categorical structures this is the case if and only if, for every $k\geq 1$, every tuple $\bar{a}\in A^k$, and every $a'\notin \bar{a}$, it is not possible to first-order define the unary relation $\{a'\}$ using $\bar{a}$ as parameters; %in fact, any non-empty first-order definable relation disjoint from $\bar{b}$ is then infinite.
in other words, any non-trivial first-order property  relative to $\bar{a}$ is always satisfied by infinitely many elements, which implies that some arguments become easier compared to finite structures (whereas naturally, many other arguments become harder).
% 
We will show that the following  strengthening of this property (for model-complete cores, see Proposition~\ref{prop:CSP_injective_no_algebraicity}) can be assumed when resolving Conjecture~\ref{conj:bodirsky_pinsker}: a structure $\struct{A}$ is \emph{CSP-injective} if every finite structure that homomorphically maps to $\struct{A}$ also does so injectively; in other words, if there is a solution to an instance of $\CSP(\struct{A})$, then there is also an injective one. CSP-injectivity played an essential role in the universal-algebraic proof of the complexity dichotomy for Monotone Monadic SNP~\cite{MMSNP-Journal} and, more recently, certain finitely bounded homogeneous uniform hypergraphs~\cite{mottet_et_al:LIPIcs.ICALP.2024.148}. 
%
\begin{example} \label{ex:properties_of_q2}
The templates $(\mathbb Q;<)$ and $(\mathbb Q;\Betw)$ are clearly CSP-injective and have no algebraicity, whereas the equivalence relation $(V;\sim)$ with infinitely many classes of size~3 is not CSP-injective and has algebraicity.    
\end{example} 

 In our theorem enforcing CSP-injectivity,  one of the properties preserved by our construction is that of the structure $\struct{B}$ being \emph{Ramsey}. Although of central importance in classification methods~\cite{bodirsky_pinsker_ramsey_canonical,Pinsker22}, its precise definition is not essential to the present paper and  therefore omitted; we refer the reader to~\cite{hubickanesetril2019} for details about structural Ramsey theory.  
 %
\begin{restatable}{theorem}{maintheorem}   \label{thm:removing_algebraicity}
Let $\struct{A}$ be a non-trivial reduct of a countable structure $\struct{B}$ over a finite relational signature.
%
Then there exists a CSP-injective reduct $\blowup{\struct{A}}$ of a countably infinite structure without algebraicity $\ordblowup{\struct{B}}$ over a finite relational signature such that $\CSP(\blowup{\struct{A}})$ and $\CSP(\struct{A})$ are Datalog-interreducible. 
%
Moreover:
% 
\begin{enumerate}
    \item \label{item:1} If $\struct{B}$ is $\omega$-categorical, then $\ordblowup{\struct{B}}$ is $\omega$-categorical as well. In this case,  
    $\blowup{\struct{A}}$ is a model-complete core if and only if $\struct{A}$ is a  model-complete core.  
\item \label{item:2} If $\struct{B}$ is homogeneous, then $\ordblowup{\struct{B}}$ is homogeneous as well.
%
In this case, $\ordblowup{\struct{B}}$ is Ramsey if and only if $\struct{B}$ is Ramsey. 
\item \label{item:3} If $\struct{B}$ is finitely bounded homogeneous, then $\ordblowup{\struct{B}}$ is finitely bounded homogeneous as well.
\item \label{item:4}  If the number of orbits of $d$-tuples of $\struct{A}$  has growth slower than $2^{2^{d}}$,  then $\blowup{\struct{A}}$ pp-constructs $\struct{K}_3$ if and only if  $\struct{A}$ pp-constructs $\struct{K}_3$. 
%
\end{enumerate}
 
\end{restatable}
 
 Let us remark that it is well-known and not hard to see  that reducts of homogeneous structures in a finite relational signature have less than double exponential orbit growth~\cite{macpherson2011survey}, and hence item~\ref{item:4} of Theorem~\ref{thm:removing_algebraicity} applies to the scope of Conjecture~\ref{conj:bodirsky_pinsker}.   


\subsection{Polymorphisms are injective}
 
 Comparing Theorem~\ref{thm:finite_domain_CSP} with Conjecture~\ref{conj:bodirsky_pinsker}, one notices the replacement of the Siggers identity by its (weaker) pseudo-variant. This is not just an inconvenience arising from the proof of Barto and Pinsker in~\cite{barto_pinsker_journal} (or the more recent proof in~\cite{BBKMP23}), but there are examples showing the necessity to weaken the condition. 
 %
\begin{example} \label{ex:example_I4}
    Define a relation $I_4 \coloneqq \{ (x,y,u,v) \mid x=y \Rightarrow u=v\}$ on a countably infinite set $V$. Then $\CSP(V;I_4)$ is solvable in Datalog~\cite{bodirsky2010datalog}, and in particular does not pp-construct $\struct{K}_3$; therefore, the polymorphisms of this template satisfy the pseudo-Siggers identity by the above-mentioned theorem of Barto and Pinsker. However, any polymorphism of $I_4$ must be injective up to dummy variables~\cite{BodChenPinsker}, and hence cannot satisfy the Siggers identity.
\end{example}

 We say that a template is \emph{Pol-injective} if all of its polymorphisms are \emph{essentially injective}, i.e.~injective up to dummy variables -- this is the case if and only if the relation $I_4$ is invariant under its polymorphisms.  
 As it turns out, the relation $I_4$ can be added to the templates constructed in Theorem~\ref{thm:removing_algebraicity} at no computational cost. It thus follows that any algebraic condition on polymorphisms capturing a complexity class closed under Datalog-reductions for CSPs of structures within the scope of Conjecture~\ref{conj:bodirsky_pinsker} must necessarily be satisfiable by essentially injective operations.
% 
Until now, this fact was understood by experts on an intuitive level, but our result provides a rigorous confirmation.
 


\begin{restatable}{theorem}{maintheoremtwo}    \label{thm:polinjective}
The expansions $\blowup{\struct{A}}_{I_4}$ and $\ordblowup{\struct{B}}_{I_4}$ of $\blowup{\struct{A}}$ and $\ordblowup{\struct{B}}$, respectively, by the relation $I_4$ enjoy all properties of Theorem~\ref{thm:removing_algebraicity}, 
except that CSP-injectivity is replaced by Pol-injectivity.
 \end{restatable} 

 For finite structures the only essentially injective polymorphisms are constants and projections.
%
It is therefore of no surprise that so few universal-algebraic conditions for CSPs from the finite have been successfully lifted to the infinite. 
%   
One prominent example which can actually be lifted is the satisfiability of \emph{quasi near-unanimity identities}, which captures \emph{bounded strict width} both in the finite and in the infinite~\cite{bodirsky2013datalog}; bounded strict width corresponds to solvability in a particular proper fragment of Datalog that is not closed under the Datalog-reductions in Theorem~\ref{thm:removing_algebraicity}.
%  
Examples of conditions for polymorphism clones that can be satisfied by essentially injective operations  
are any \emph{pseudo height-1 identities} %for model-complete cores 
(e.g., the pseudo-Siggers identity), but also the \emph{dissected near-unanimity identities}~\cite{gillibert2022symmetries} which were proposed in~\cite{bodirsky2022descriptive} as a possible candidate for solvability of CSPs in fixed-point logic. 

 
Marimon and Pinsker have recently provided a negative answer, within the scope of  Conjecture~\ref{conj:bodirsky_pinsker}, to a question of Bodirsky~\cite[Question 14.2.6(27)]{bodirsky2021complexity} asking whether every $\omega$-categorical CSP template without algebraicity which is  solvable in Datalog has a binary injective polymorphism~\cite[Corollary~8.10]{MarimonPinsker23}.  We contrast this negative result with a corollary to Theorem~\ref{thm:polinjective} that implies that up to Datalog reductions the answer is positive.
 
\begin{restatable}{corollary}{binaryInj}\label{cor:binaryInj} 
  Let $\struct{A}$ be a non-trivial reduct of a finitely bounded homogeneous structure $\struct{B}$. If $\struct{A}$ does not pp-construct $\struct{K}_3$, then $\blowup{\struct{A}}_{I_4}$ (from Theorem~\ref{thm:polinjective}) has a binary injective polymorphism.  
\end{restatable}

\subsection{Sandwiches are relevant}

 One of the currently most vibrant branches of research in constraint satisfaction are \emph{Promise Constraint Satisfaction Problems} (PCSPs).
%
For two relational structures $\struct{S}_1$ and $\struct{S}_2$ such that $\struct{S}_1$ maps homomorphically into $\struct{S}_2$, the problem  $\PCSP(\struct{S}_1,\struct{S}_2)$ asks to decide whether a given finite  structure $\struct{J}$ in the same signature as $\struct{S}_1$ and $\struct{S}_2$ maps homomorphically into $\struct{S}_1$ or does not even map homomorphically into $\struct{S}_2$; the instance $\struct{J}$ is  promised to satisfy one of those two cases. Thus, the problem $\PCSP(\struct{S}_1,\struct{S}_2)$ asks to compare $\CSP(\struct{S}_1)$ to a relaxation $\CSP(\struct{S}_2)$ of it, and  
since $\PCSP(\struct{S}_1,\struct{S}_1)=\CSP(\struct{S}_1)$, promise constraint satisfaction problems generalize the CSP framework. This generalization is vast, and contains many well-known computational problems such as  APPROXIMATE GRAPH COLORING \cite{approximatecolouring}, $(2+\epsilon)$-SAT \cite{2plusepsilonSAT}, and HYPERGRAPH COLORING~\cite{hypergraphcol}. 
%
%
Although formally not necessary,  research has focused on finite templates $(\struct{S}_1,\struct{S}_2)$: this is justified for example by the fact that even for structures over a Boolean domain, there is no complete complexity classification yet. 
%
Hence, the two here considered extensions of finite-domain CSPs to $\omega$-categorical templates, or alternatively to PCSPs, are somewhat orthogonal, and it is natural to wonder whether there exist any connections, in particular of algorithmic nature. 




 One potential link is the use of $\omega$-categorical CSP templates as \emph{sandwiches} to prove tractability of PCSPs, as follows. 
 %
Note that if $\struct{A}$ is a structure such that $\struct{S}_1$ maps homomorphically to $\struct{A}$ and $\struct{A}$ maps homomorphically to $\struct{S}_2$, then $\PCSP(\struct{S}_1,\struct{S}_2)$ trivially reduces to $\CSP(\struct{A})$; we call $\struct{A}$ a sandwich for the template $(\struct{S}_1,\struct{S}_2)$. 
%
This simple observation is more powerful than it might first appear: in fact, so far, every known tractable PCSP can be reduced to the tractable CSP of some sandwich structure~\cite{PromiseandInfDomCSPs,sandwichespromiseconstraintsatisfaction}. 
%
On the other hand, Barto~\cite{promisesmakefiniteproblemsinfinitary} provided an example of a (finite-domain) PCSP template with an infinite polynomial-time tractable sandwich structure that is not \emph{finitely  tractable}, i.e.~such that every finite-domain sandwich structure has an NP-complete CSP~\cite{promisesmakefiniteproblemsinfinitary}. Since his sandwich structure is not $\omega$-categorical, he raised the question whether such an example could also be constructed with an $\omega$-categorical structure (\cite[Question IV.1]{promisesmakefiniteproblemsinfinitary}). Subsequently the question arose, and was promoted in particular by Zhuk at the CSP World Congress~2023, whether structures within the scope of Conjecture~\ref{conj:bodirsky_pinsker} could \emph{ever} serve as tractable sandwich structures in the absence of a finite one. 

In the present paper, we provide a strongly affirmative answer to this question and create non-finitely tractable finite-domain PCSPs from virtually every structure $\struct{A}$ within the scope of the Bodirsky-Pinsker conjecture. Our construction consists of two steps. 
%
First, we show such construction is possible under the additional assumption that $\struct{A}$ is equipped with an inequality predicate and that it is a reduct of a structure $\struct{B}$ which is linearly ordered. 
%
We then combine this construction  with Theorem~\ref{thm:removing_algebraicity}.
%
Modulo an extra step consisting of taking generic superpositions of structures with $(\mathbb{Q};<)$ (for which we need the property of no algebraicity), this finishes our proof. 

\begin{restatable}{theorem}{alltogether} \label{thm:main_theorem_sandwiches}  
 For every non-trivial reduct $\struct{A}$ of a finitely bounded homogeneous structure $\struct{B}$, there exists a reduct $\struct{A}'$ of a finitely bounded homogeneous structure $\struct{B}'$ and a finite PCSP template $(\struct{S}_1,\struct{S}_2)$
   such that 
\begin{enumerate} 
   \item \label{item:all1} $\struct{A}$ pp-constructs $\struct{K}_3$ if and only if  $\struct{A}'$ pp-constructs $\struct{K}_3$. 
   \item \label{item:all2} $\CSP(\struct{A})$ and $\CSP(\struct{A}')$ are Datalog-interreducible.
      \item \label{item:all3} $\struct{A}'$ is a sandwich for $\PCSP(\struct{S}_1,\struct{S}_2)$.
        \item \label{item:all4} %$\PCSP(\struct{S}_1,\struct{S}_2)$ is not finitely tractable.
        Every finite sandwich for $\PCSP(\struct{S}_1,\struct{S}_2)$ pp-constructs $\struct{K}_3$\\ (and hence $\PCSP(\struct{S}_1,\struct{S}_2)$ is not finitely tractable). 
        \item \label{item:all5} If $\struct{A}$ is a model-complete core, then $\struct{A}'$ is a model-complete core as well.
        \item \label{item:all6} If $\struct{B}$ is Ramsey, then $\struct{B}'$ is Ramsey as well.
   \end{enumerate} 
   
 \end{restatable}
%
  
\subsection{Related work}\label{subsect:relatedwork}
 
 By a theorem of Kechris, Pestov, and Todor\v{c}evi\'c~\cite{kechris2005fraisse}, a homogeneous structure $\struct{B}$ with a countable relational signature is Ramsey if and only if its automorphism group $\Aut(\struct{B})$ is \emph{extremely amenable}, and hence the Ramsey property only depends on $\Aut(\struct{B})$ viewed as an abstract topological group.  
%
They also observed that extreme amenability is preserved under taking wreath products; although they do not state this result explicitly, they do provide an example as a proof of concept: the automorphism group of the \emph{random convexly ordered equivalence relation}.  
 % 
 Scow~\cite[Theorem~5.13]{scow2021ramsey} does state this result, and essentially provides a full proof, modulo Theorem~4.7~in \cite{kechris2005fraisse}.
 %
 We kindly borrow her statement and in return provide a positive answer to one of her open questions regarding \emph{semi-retractions}~\cite[Question 4.3]{BARTOŠOVÁ_SCOW_2024}.
 %
 In simple words, a semi-retraction is a certain purely algebraic construction allowing to transfer   the Ramsey property from one structure to another.   

\begin{restatable}{proposition}{semiretraction} \label{prop:rg_semiret_aba} 
  The random linearly ordered graph is a semi-retract of the linearly ordered atomless Boolean algebra. %The canonical injections witnessing this fact can be chosen to be order-preserving.
 \end{restatable}
 
 The first two examples of a tractable $\omega$-categorical sandwich for a finite-domain PCSP that is not finitely tractable have  recently been provided in the preprint~\cite[Propositions~35 and~36]{Mottet_2025}. Our results compare to the results of that work as follows:~\cite[Theorem 1]{Mottet_2025}  shows that every CSP within the scope of the Bodirsky-Pinsker conjecture is polynomial-time equivalent to the PCSP of a half-infinite template, more precisely a template $(\struct{S}_1,\struct{S}_2)$ such that $\struct{S}_1$ is in the scope of the Bodirsky-Pinsker conjecture and $\struct{S}_2$ is finite.
%
In contrast, our Theorem~\ref{thm:main_theorem_sandwiches} provides a non-finitely tractable finite-domain PCSP template $(\struct{S}_1,\struct{S}_2)$ sandwiching a given structure $\struct{A}$ from Conjecture~\ref{conj:bodirsky_pinsker} up to Datalog interreducibility.
%
Since our PCSP template $(\struct{S}_1,\struct{S}_2)$ is finite and not half-infinite, we cannot guarantee polynomial-time equivalence between $\PCSP(\struct{S}_1,\struct{S}_2)$ and $\CSP(\struct{A})$. 

\subsection{Organization of this article}
We define the basic notions not defined in the introduction in Section~\ref{section:preliminaries}. Then Section~\ref{section:algebraicity_irrelevant} will be devoted to Theorems~\ref{thm:removing_algebraicity} and~\ref{thm:polinjective}; it also contains the definition of Datalog reductions. Section~\ref{section:sandwiches} contains a proof sketch of Theorem~\ref{thm:main_theorem_sandwiches}. Finally, we draw conclusions 
%and formulate some open questions 
 in Section~\ref{sect:conclusion}. Due to space restrictions, we omit most technical parts of proofs or only sketch them; full proofs can be found in the appendix.

  
\section{Preliminaries} \label{section:preliminaries} 

The set $\{1,\dots,n\}$ is denoted by $[n]$, and we use the bar notation $\bar{t}$ for tuples.
%
For a function $f\colon A^n \rightarrow B$, the \emph{component-wise action} of $f$ on $k$-tuples $(x_{1,1},\dots, x_{1,k}),$ $\dots,$ $(x_{n,1},\dots, x_{n,k})  \in A^{k}$ is defined as the $k$-tuple $f\big((x_{1,1},\dots, x_{1,k}),\dots, (x_{n,1},\dots, x_{n,k}) \big)\coloneqq \big(f(x_{1,1},\dots,x_{n,1}),\dots, f(x_{1,k},\dots,x_{n,k}) \big)$.

\subsection*{Relational structures.} 
%
A (\emph{relational}) \emph{signature} $\tau$ is a set of \emph{relation symbols}, each $R\in\tau$ with an associated natural number called \emph{arity}. 
%
A (\emph{relational}) \emph{$\tau$-structure} $\struct{A}$ consists of a set $A$ (the \emph{domain}) together with the relations $R^{\struct{A}}\subseteq A^{k}$ for each $R\in \tau$ with arity $k$.
%
An \emph{expansion} of $\struct{A}$ is a $\sigma$-structure $ \struct{B}$ with $A=B$ such that $ \tau\subseteq \sigma$ and $R^{\struct{B}}=R^{\struct{A}}$ for each relation symbol $R\in \tau$. Conversely, we call $\struct{A}$ a \emph{reduct} of $\struct{B}$ and denote it by $\struct{B}|^{\tau}$.  
%We call $\struct{A}$ a \emph{first-order} reduct of $\struct{B}$ if it is a reduct of the expansion of $\struct{B}$ by all relations that are first-order definable in $\struct{B}$.\michael{Now already defined in the intro - could be removed} 
%
For a positive integer $d$ and a $\tau$-structure $\struct{A}$, the \emph{$d$-th power} of $\struct{A}$ is the $\tau$-structure $\struct{A}^d$ with domain $A^d$ and relations $R^{\struct{A}^d}=\{\big((a_{1,1},\dots, a_{1,d}),\dots, (a_{k,1},\dots, a_{k,d})\big)\in (A^d)^k \mid  (a_{1,1},\dots, a_{k,1}),\dots, (a_{1,d},\dots, a_{k,d}) \in R^{\struct{A}}   \}$ for each $R\in \tau$ of arity $k$.
%
The \emph{substructure} of a $\tau$-structure $\struct{A}$ on a subset $B\subseteq A$ is the $\tau$-structure $\struct{B}$ with domain $B$ and relations $R^{\struct{B}}=R^{\struct{A}}\cap B^k$ for every $R\in \tau$ of arity $k$.
%
The \emph{factor} of a $\tau$-structure $\struct{A}$ through an equivalence relation $E\subseteq A^2$ is the $\tau$-structure $\struct{A}/{E}$ with domain $A/E$ and relations $R^{\struct{A}/{E}}= q_E(R^{\struct{A}})$, where $q_E$ denotes the factor map $x\mapsto [x]_E$.  
% 

\subsection*{Structure-preserving maps.} A \emph{homomorphism} $h\colon \struct{A} \rightarrow \struct{B}$ for $\tau$-structures $\struct{A}$ and $\struct{B}$ is a mapping $h\colon  A\rightarrow B$ that \emph{preserves} each $\tau$-relation, i.e.,~if $ \bar{t} \in R^{\struct{A}}$ for some  relation symbol $R\in \tau$, then $h(\bar{t})\in R^{\struct{B}}$.
%
We write $\struct{A} \rightarrow \struct{B}$ if $\struct{A}$ maps homomorphically to $\struct{B}$; formally, 
 $\CSP(\struct{A})=\{\struct{J} \text{ finite} \mid \struct{J} \rightarrow \struct{A}\}$. 
 %
 If $\struct{A} \rightarrow \struct{B}$ and $\struct{B} \rightarrow \struct{A}$, then we say that $\struct{A}$ and $\struct{B}$ are \emph{homomorphically equivalent}. 
% 
 An \emph{endomorphism} of $\struct{A}$ is a homomorphism from $\struct{A}$ to itself; we denote by $\End(\struct{A})$ the set (monoid) of all endomorphisms of $\struct{A}$.  
 %
 It is easy to see that if $\struct{A}$ has a constant endomorphism, then its CSP is trivial, and we call $\struct{A}$ \emph{trivial} itself; otherwise we call $\struct{A}$ \emph{non-trivial}. 

An \emph{embedding} is an injective homomorphism $h\colon \struct{A} \rightarrow \struct{B}$ that additionally satisfies the following condition: for every $k$-ary relation symbol $R\in \tau$ and $\bar{t}\in A^{k}$ we have $h(\bar{t})\in R^{\struct{B}}$ only if $\bar{t}\in R^{\struct{A}}.$ 
%
An \emph{isomorphism} is a surjective embedding. Two structures $\struct{A}$ and $\struct{B}$ are \emph{isomorphic} if there exists an isomorphism from $\struct{A} $ to $\struct{B}$. 
%
An \emph{automorphism} is an isomorphism from $\struct{A}$ to $\struct{A}$; we denote by $\Aut(\struct{A})$ the set (group) of all automorphisms of $\struct{A}$.
% 
The \emph{orbit} of a tuple $\bar{t}\in A^{k}$ in $\struct{A}$ is the set $\{g(\bar{t}) \mid g \in \Aut(\struct{A})\}$.  Any tuples belonging to the same orbit satisfy precisely the same first-order formulas over $\struct{A}$.  
%
The \emph{orbit equivalence} relation provides a natural way to factorize relational structures; in the present paper, we will only need the following specific case.
%
Given a relational structure $\struct{A}$ and a subgroup $G\subseteq \Aut(\struct{A})$,
% 
we denote by $\struct{A}_{\orbeq{G}}$ the structure $\struct{A}/E$ for $E\coloneqq \{(x,y)\in A^2 \mid \exists g\in G\colon g(x)=y\}$.  
%
As mentioned in the introduction, a \emph{polymorphism} of $\struct{A}$ is  a homomorphism from a finite power of $\struct{A}$ into $\struct{A}$. 
 

\subsection*{Universal algebra.}
%
An (\emph{equational}) \emph{condition} is a set of \emph{identities}, i.e.~formal
expressions of the form $s \approx t$, where $s$ and $t$ are terms over
a common set of function symbols. 
%
An equational condition is \emph{height-1} if it contains neither nested terms nor terms consisting of a single variable.
%
We say that $\Pol(\struct{A})$ (or some set of operations on $A$) \emph{satisfies} an %height-1 
equational condition $\Sigma$ if the function symbols can be interpreted as elements of $\Pol(\struct{A})$ so that, for each identity $s \approx t$ in $\Sigma$, the equality $s = t$ holds for any evaluation of variables in $A$. 
%  
An example is the \emph{cyclic identity} of arity $n$ given by $f(x_1,\dots, x_n) \approx f(x_2,\dots,x_n, x_1)$, for a symbol $f$ of arity $n$. 
%
We say that an operation is \emph{cyclic} if it satisfies the cyclic identity.

\begin{theorem}[\cite{Barto_2012}]\label{thm:barto12} 
     Let $\struct{A}$ be a finite relational structure. If $\struct{A}$ does not pp-construct $\struct{K}_3$, then $\Pol(\struct{A})$ contains a cyclic operation.
\end{theorem}
 
A \emph{pseudo-version} of a height-1 identity $s \approx t$ is of the form $\alpha \circ s \approx \beta \circ t$ for fresh unary function symbols $\alpha$ and $\beta$.
% 
An example is the pseudo-Siggers identity from Conjecture~\ref{conj:bodirsky_pinsker}. 
%
This definition naturally extends to height-1 conditions. 
 
\section{Simplifying the Bodirsky-Pinsker conjecture} \label{section:algebraicity_irrelevant}
 
 
\subsection{Injectivity and Datalog reductions}
 

In the context of Conjecture~\ref{conj:bodirsky_pinsker}, the concepts of CSP-injectivity and having no algebraicity are closely related.
% 
On the one hand, if $\struct{B}$ is a homogeneous structure with no algebraicity and its relations only contain  tuples with pairwise distinct entries, then it is CSP-injective~\cite[Lemma~4.3.6]{bodirsky2021complexity}.
%
On the other hand, we can prove the following.

\begin{restatable}{proposition}{corealgebraicity} \label{prop:CSP_injective_no_algebraicity}
 CSP-injective $\omega$-categorical model-complete cores do not have algebraicity. 
\end{restatable}     
%  
Pol-injectivity could be viewed as a universal-algebraic counterpart of CSP-injectivity, despite the fact that the  two properties cannot hold simultaneously in $\omega$-categorical structures.

\begin{restatable}{proposition}{clash} \label{prop:pol_and_CSP_injectivity}
CSP-injective $\omega$-categorical structures are not Pol-injective.
 \end{restatable}    

 The two notions are connected in the sense that from CSP-injective templates one can produce a Datalog-interreducible template by adding the relation $I_4$ from Example~\ref{ex:example_I4}.
  
  \begin{restatable}{proposition}{expansCSPinjective} \label{prop:expans_datalog}
The expansion  of any CSP-injective structure $\struct{A}$ by the relation $I_4$ is a Pol-injective  structure $\struct{A}_{I_4}$, and  $\CSP(\struct{A})$ and $\CSP(\struct{A}_{I_4})$  are Datalog-interreducible.
 \end{restatable} 
%
Datalog reductions between CSPs are typically specified using factorization-free Datalog-interpretations with parameters~\cite{atserias2009affine,dalmau2024local}, which are a particular case of logical interpretations with parameters. 
%
In the present paper, we only need a very special case of Datalog-reductions, which can be easily explained on an informal level.

Datalog is defined by adding formation rules to the existential positive fragment of first-order logic whose semantics is defined with inflationary fixed-points of arbitrary operators.  
%
Every existential positive first-order formula is a Datalog formula and, if $\phi(\bar{x})$ is a Datalog formula over some relational signature $\tau\cup \{R\}$ with $R\notin \tau$, then 
$[\mathsf{ifp}_{R}\,\phi](\bar{x})$ is a Datalog formula over the signature $\tau$ whose semantics is given as follows.
%
For a $\tau$-structure $\struct{A}$ and a tuple $\bar{a}$ over $A$ matching the arity of $\bar{x}$, say $k$, we have $\struct{A}\models [\mathsf{ifp}_{R}\, \phi](\bar{a})$ if and only if $\bar{a}$ is contained in the inflationary fixed-point of the operator $F_{\phi,R}(X) \coloneqq \{\bar{a}\in A^k \mid \bar{a}\in X \text{ or } (\struct{A};X)\models \phi(\bar{a})\}$, i.e., in the limit of the sequence
%
$\emptyset$, $F_{\phi,R}(\emptyset)$, $F_{\phi,R}^2(\emptyset)$, $\dots$
%
For example, the Datalog formula $[\mathsf{ifp}_T\, (x<z) \vee (\exists y \ldotp T(x,y) \wedge T(y,z) )](x,z)$ computes the transitive closure of $<$. 

For a relational $\tau$-structure $\struct{A}$, we say that $\CSP(\struct{A})$ is \emph{solvable in Datalog} if there exists a Datalog sentence  that defines the complement of $\CSP(\struct{A})$, i.e.~the class of all finite $\tau$-structures which do not homomorphically map to $\struct{A}$.
%
For example, $\CSP(\mathbb{Q};<)$ is solvable in Datalog using the sentence $\exists u [\mathsf{ifp}_T\, (x<z) \vee (\exists y \ldotp T(x,y) \wedge T(y,z) )](u,u)$.
%
It is not hard to see that every Datalog formula is specified by a finite set of rules of the form $R(\bar{x})\Leftarrow R_1(\bar{x}_1)\wedge \cdots \wedge R_m(\bar{x}_m)$ where $R$ is a fixed-point variable.
%
In the case of the Datalog formula from above computing the transitive closure of $<$, for example,  the rules are $T(x,z) \Leftarrow (x<z)$ and $T(x,z) \Leftarrow T(x,y) \wedge T(y,z)$.

As mentioned above, when it comes to Datalog-reductions between CSPs, we will only need the following simplified version.
%
For a $\tau$-structure $\struct{A}$ and $\sigma$-structure $\struct{A'}$, we say that $\CSP(\struct{A'})$ \emph{Datalog-reduces} to $\CSP(\struct{A})$ if there exists a mapping $\mathcal{I}$ from finite $\sigma$-structures to finite $\tau$-structures, where $\mathcal{I}(\struct{J})$ can be defined from $\struct{J}$ using Datalog formulas, so that $\struct{J} \rightarrow \struct{A'}$ if and only if  $\mathcal{I}(\struct{J}) \rightarrow \struct{A}$.  
%
It is not hard to see that Datalog reductions compose, i.e., if $\CSP(\struct{A}'')$ Datalog-reduces to $\CSP(\struct{A}')$ and $\CSP(\struct{A}')$ Datalog-reduces to $\CSP(\struct{A})$, then $\CSP(\struct{A}'')$ Datalog-reduces to $\CSP(\struct{A})$.

\subsection{Wreath products}

%In this section, we give a proof sketch of Theorem~\ref{thm:removing_algebraicity}.
Let $\struct{A}$ and $\struct{B}$ be structures over disjoint relational signatures $\tau$ and $\sigma$.
%
Moreover, let $E$ be a fresh binary symbol. 
%
The \emph{wreath product} $\struct{A}\wr\struct{B}$ is the structure over the signature $\tau\cup \{E\}\cup \sigma$ with domain $A\times B$ whose relations are defined as follows.
%
For every $R\in \tau$ of arity $k$:
%
\begin{align*}
    R^{\struct{A}\wr\struct{B}}    \coloneqq \ &  \{((x_1,y_1),\dots, (x_k,y_k))\in (A\times B)^k \mid (x_1,\dots, x_k)\in R^{\struct{A}}\text{ and } y_1=\cdots=y_n\}, \\
E^{\struct{A}\wr\struct{B}}\coloneqq \ &   \{((x_1,y_1),(x_2,y_2))\in (A\times B)^2 \mid y_1=y_2\},
\end{align*} 
%
and for every $S\in \sigma$ of arity $m$: 
%
\[
S^{\struct{A}\wr\struct{B}}  \coloneqq  \{((x_1,y_1),\dots, (x_m,y_m))\in (A\times B)^m \mid (y_1,\dots, y_m)\in S^{\struct{B}}\}. \hspace{2.5cm}
\]
% 
 Below we give several crucial properties of wreath products, but first we start with an illustratory example on which all of these properties can be readily verified. 
%
\begin{example} \label{expl:running_example2}  
%
Consider the wreath product $(\mathbb{Q};<_1)\wr (\mathbb{Q};<_2)$ of two isomorphic copies of $(\mathbb{Q};<)$ with disjoint signatures. The union $<_{\text{conv}}$ of $<_1$ and $<_2$ in this structure, together with  $E$, is the random convexly ordered equivalence relation from Corollary~6.8 in~\cite{kechris2005fraisse}.
%
\end{example} 
%     
Given groups $G$ and $H$ acting on sets $A$ and $B$, respectively, their \emph{wreath product} $G\wr H$ is given by $G^B\times H$ acting on $A\times B$ via $\left((g_b)_{b\in B},h)\right)(a,b)\coloneqq (g_{h(b)}(a),h(b)).$
%
The wreath product $G\wr H$ again forms a group, with the neutral element 
$((e_G)_{b\in B},e_H)$ and the group operation 
$((g_b)_{b\in B},h))\cdot ((g'_b)_{b\in B},h'))\coloneqq ((g_b\cdot g'_{h^{-1}(b)})_{b\in B},h\cdot h'))$.
% 
Note that the permutation group on  $A\times B$ induced by the component-wise action of the Cartesian product $G\times H$ is contained by that induced by the action of $G\wr H$ thereon: the permutations induced stemming from the former are represented in $G\wr H$ by all elements of the form $((g)_{b\in B},h)$. 


\begin{restatable}[Basic properties of wreath products]{proposition}{wreathproducts} \label{prop:basic_properties_wreath_products}
Let $\struct{A}$ and $\struct{B}$ be structures over disjoint finite relational signatures $\tau$ and $\sigma$. Then:
    \begin{enumerate}
        \item \label{item:aut_wreath}  $\Aut(\struct{A} \wr \struct{B})=\Aut(\struct{A}) \wr \Aut(\struct{B})$.
        \item \label{item:algebraicity}  If $\struct{A}$ has no algebraicity, then $\struct{A}\wr\struct{B}$ has no algebraicity.
        \item \label{item:aut_wreath_omega_cat}  If $\struct{A}$ and $\struct{B}$ are $\omega$-categorical, then $\struct{A}\wr\struct{B}$ is $\omega$-categorical. 
        \item \label{item:wreath_homogeneous} If $\struct{A}$ and $\struct{B}$ are homogeneous, then $\struct{A}\wr\struct{B}$ is homogeneous.
        \item \label{item:finite_boundedness} If $\struct{A}$ and $\struct{B}$ are finitely bounded, then $\struct{A}\wr\struct{B}$ is finitely bounded.
        \item \label{item:Ramsey} If $\struct{A}$ and $\struct{B}$ are homogeneous Ramsey, then $\struct{A}\wr\struct{B}$ is homogeneous Ramsey.
    \end{enumerate} 

 \end{restatable}  

\subsection{Putting everything together} \label{section:everything_together}

\begin{proof}[Proof sketch of Theorem~\ref{thm:removing_algebraicity} and Theorem~\ref{thm:polinjective}]  
Let $\tau$ and $\sigma$ be the signatures of $\struct{A}$ and $\struct{B}$, respectively. 
%
We first define the auxiliary structure $\struct{B}'\coloneqq  (\mathbb{Q};<) \wr \struct{B}$. 
%
By Example~\ref{ex:properties_of_q1} and Example~\ref{ex:properties_of_q2}, the structure $(\mathbb{Q};<)$ is finitely bounded, homogeneous, and has no algebraicity.
%
It follows immediately from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:algebraicity}  that $\struct{B}'$ has no algebraicity.
% 
We then define $\ordblowup{\struct{B}}$ as the expansion of $\struct{B}'$ by the binary inequality $\neq$.
%
Note that $\ordblowup{\struct{B}}$ has no algebraicity because taking expansions by first-order definable relations does not change the automorphism group; the same is true for the structure $\ordblowup{\struct{B}}_{I_4}$.
%
We obtain the structure $\blowup{\struct{A}}$ as a reduct of $\ordblowup{\struct{B}}$ by removing all symbols in $\sigma\setminus \tau$ as well as the symbol $<$; but note that $\blowup{\struct{A}}$ can also be defined directly from $\struct{A}$. 
 
We claim that $\blowup{\struct{A}}$ is CSP-injective. 
%
To this end, let $\struct{J}$ be an arbitrary finite structure for which there exists a homomorphism $h\colon \struct{J} \rightarrow \blowup{\struct{A}}$.
%
We define $\struct{J}_{\pi}$ as the $(\tau \cup \{E\})$-structure with domain $J$ such that, for every $R\in \tau\cup \{E\}$, we have $\bar{t}\in R^{\struct{J}_{\pi}}$ if and only if $h(\bar{t})\in R^{\blowup{\struct{A}}}$.
% 
It is easy to see that $\struct{J}_{\pi}$ embeds into the $(\tau \cup \{E\})$-reduct of $\struct{B}'$.
%
Hence, $\struct{J}_{\pi}$ expanded by the binary inequality predicate embeds into $\blowup{\struct{A}}$ and admits an injective homomorphism from $\struct{J}$.
%
We conclude that $\blowup{\struct{A}}$ is CSP-injective.

Next, we informally describe two Datalog-reductions $\mathcal{I}^{\ast}$ and $\mathcal{I}$: from $\CSP(\blowup{\struct{A}})$ to $\CSP(\struct{A})$ and back, starting with the former. 
%  
Let $\struct{J}$ be an instance of $\CSP(\blowup{\struct{A}})$.
%
Denote by $\sim$ the equivalence closure of $E^{\struct{J}}$, and let $q_{\sim}\colon \struct{J}\rightarrow (\struct{J}/{\sim}), x \mapsto [x]_{\sim}$ be the induced quotient map.
%
We define $\mathcal{I}^{\ast}(\struct{J})$ as the $\tau$-structure with domain $J$ and whose relations are the preimages of all $\tau$-relations in $\struct{J}/{\sim}$ under $q_{\sim}$, except that we additionally add, for every $x\in J$ such that $(x,x)\in {\neq}^{\struct{J}}$, the tuple $(x,\dots, x)$ to every $\tau$-relation.
%
It is easy to see that $\mathcal{I}^{\ast}(\struct{J})$ is definable in Datalog; we verify that $\mathcal{I}^{\ast}$ is a reduction from $\CSP(\blowup{\struct{A}})$ to $\CSP(\struct{A})$. 
%
Clearly, if $\struct{J}$ maps homomorphically to $\blowup{\struct{A}}$, then $\mathcal{I}^{\ast}(\struct{J})$ maps homomorphically to $\struct{A}$.
%
Suppose that there exists a homomorphism $h\colon \mathcal{I}^{\ast}(\struct{J})\rightarrow\struct{A}$.
%
Since by non-triviality  $\struct{A}$ does not have a constant endomorphism, there is no $x\in J$ such that $(x,x)\in {\neq}^{\struct{J}}$. 
%
Denote by $\struct{J}'$ the structure obtained from $\struct{J}$ by removing all tuples from ${\neq}^{\struct{J}}$.
%
Now, choosing representatives $j_1,\dots,j_k$ for all classes of $\struct{J}/{\sim}$, the function sending the entirety of $[j_i]_\sim$ to $(0,h(j_i))$ for all $i\leq k$ is a homomorphism from $\struct{J}'$ to $\blowup{\struct{A}}$.
%
By the CSP-injectivity of $\blowup{\struct{A}}$, it can be replaced by an injective homomorphism, which is then also a homomorphism from $\struct{J}$ to $\blowup{\struct{A}}$.
% 
We continue with the reduction from $\CSP(\struct{A})$ to $\CSP(\blowup{\struct{A}})$, which is trivial.
%
Let $\struct{J}$ be an instance of $\CSP(\struct{A})$.
%
We define $\mathcal{I}(\struct{J})$ as the $(\tau\cup \{E,\neq\})$-expansion of $\struct{J}$ by empty relations.
%
By CSP-injectivity, there exists a homomorphism $h\colon \mathcal{I}(\struct{J}) \rightarrow \blowup{\struct{A}}$ if and only if there exists an injective such homomorphism $i$.
%
This is the case if and only if the relation $E^{\blowup{\struct{A}}}$ restricted to $i(C)$ describes the kernel of a homomorphism from  $\struct{J}$ to $\struct{A}$.
 % 
Therefore, $\struct{J}\rightarrow\struct{A}$ if and only if $\mathcal{I}(\struct{J})\rightarrow\blowup{\struct{A}}$. 
 
 We now consider $\blowup{\struct{A}}_{I_4}$. 
%
By Proposition~\ref{prop:expans_datalog}, $\blowup{\struct{A}}_{I_4}$ is Pol-injective and $\CSP(\blowup{\struct{A}}_{I_4})$ and $\CSP(\blowup{\struct{A}})$ are Datalog-interreducible.
%
That $\CSP(\blowup{\struct{A}}_{I_4})$ and $\CSP(\struct{A}$) are Datalog-interreducible then follows from the fact that Datalog-reductions can be composed.
 

Finally, we sketch how to verify the properties in items~\ref{item:1},~\ref{item:2},~\ref{item:3}, and~\ref{item:4}.  
%
We only explicitly cover the case where $I_4$ is present (Theorem~\ref{thm:polinjective}), since the arguments without $I_4$ are a subset.

Regarding~item~\ref{item:1}, the first part ($\omega$-categoricity) follows directly from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:aut_wreath_omega_cat} applied to $\struct{B}'$ and since we take an expansion by relations which are preserved by all bijections, and in particular all automorphisms. 
% 
The second part of~item~\ref{item:1}  (model-complete cores) is immediate %from the characterization of model-complete cores via their endomorphism monoid~\cite{bodirsky2007cores} 
 once one observes that the endomorphism monoid of a wreath product admits a similar description
as its automorphism group, cf.~Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:aut_wreath}.

Regarding~item~\ref{item:2} (homogeneity and the Ramsey property), one first observes that, since $\ordblowup{\struct{B}}_{I_4}$ is an expansion of $\struct{B}'$ by two relations that are preserved by all embeddings, we can ignore these relations and only prove the statement for $\struct{B}'$.
%
Then homogeneity follows directly from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:wreath_homogeneous} because $(\mathbb{Q};<)$ is homogeneous.
%
In the second part, the backward direction follows directly from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:Ramsey} because $(\mathbb{Q};<)$ is homogeneous Ramsey \cite{kechris2005fraisse}.
%
The forward direction can be proved by hand, by instantiating the Ramsey property for the age of $\struct{B}'$ on structures where $E$ interprets as the diagonal relation.  


 Regarding~item~\ref{item:3} (homogeneity and finite boundedness), homogeneity  follows directly from the previous item. As for finite boundedness,  it is a consequence of Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:finite_boundedness} (which immediately yields finite boundedness of $\struct{B}'$), and since we take an expansion by relations definable by a Boolean combination of equality atoms.
%
More precisely, recall that up to isomorphism, the finite substructures of a finitely bounded structure are precisely the finite models of a universal sentence.
%
By adding new clauses defining  the relations $\neq$ and $I_4$ in terms of equalities to the universal sentence describing the finite substructures of $\struct{B}'$, we obtain a universal sentence describing the finite substructures of $\ordblowup{\struct{B}}_{I_4}$. 
 
 Regarding item~\ref{item:4} (pp-construction of $\struct{K}_3$), we use  a characterization via the pseudo-Siggers identity from~\cite[Theorems~1.3 and~3.4]{barto2019equations} and the fact that the structure $(\mathbb{Q};\neq, I_4)$ is an $\omega$-categorical model-complete core that does not pp-construct  $\struct{K}_3$~\cite[Theorems~12.0.1,~12.7.3,~12.9.2, and Corollary~6.4.4]{bodirsky2021complexity}. 
%
One direction is simple (and does not use the assumption on the orbit growth), because $\blowup{\struct{A}}_{I_4}$ clearly pp-constructs $\struct{A}$;
%
the pp-construction is given by $\struct{A} =(\smash{\blowup{\struct{A}}/E^{\smash{\blowup{\struct{A}}_{I_4}}})|^{\tau}}$ (since taking factors and reducts are pp-constructions~\cite{barto2018wonderland}). Thus, if $\struct{A}$ pp-constructs $\struct{K}_3$, then so does $\blowup{\struct{A}}_{I_4}$. 
%
For the other direction, one assumes that $\struct{A}$ does not pp-construct $\struct{K}_3$, in which case Theorem~1.3 in~\cite{barto2019equations} yields polymorphisms in its model-complete core satisfying the pseudo-Siggers identity. 
%
These are then composed with polymorphisms of $(\mathbb{Q};\neq, I_4)$ witnessing the pseudo-Siggers identity, which ultimately yields the satisfaction of the pseudo-Siggers identity by polymorphisms of the model-complete core of $\blowup{\struct{A}}_{I_4}$. The proof of Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:aut_wreath_omega_cat} shows  that also the structure $\blowup{\struct{A}}_{I_4}$ has less than double exponential orbit growth.
%
It then follows from Theorem~3.4 in~\cite{barto2019equations} (whose item~(ii) is equivalent to the pp-construction of $\struct{K}_3$ by Theorem~1.8 in~\cite{barto2018wonderland}) that $\blowup{\struct{A}}_{I_4}$ does not pp-construct $\struct{K}_3$.  
\end{proof}

We conclude this section with two examples. 

\begin{example} \label{ex:two_ex}  Consider $\struct{A}_1\coloneqq (\{0,1\};\{1\}, \{(x,y,z)\in \{0,1\}^3 \mid x+y+z=0 \bmod 2\})$.
%
This structure is a finitely bounded homogeneous model-complete core with algebraicity (since we do not exclude finite structures from these definitions); its CSP is solvable using Gaussian elimination over $\mathbb{F}_2$. 
% 
Note that $\struct{A}_1$ is preserved by the ternary symmetric operation $(x,y,z)\mapsto x+y+z \bmod 2$, which means that its polymorphism clone satisfies the h1-identities $ f(x,y,z) \approx f(y,z,x) \approx f(z,x,y)$.
%
Since pp-constructions preserve the satisfaction of h1-identities in polymorphism clones~\cite{barto2018wonderland} and $\neq$ over an infinite set is not preserved by any operation $f$ satisfying these identities,  $\struct{A}_1$ does not pp-construct $\blowup{\struct{A}_1}$. 
%
 Hence, our Datalog-reduction is not subsumed by pp-constructions. 
 
%
Next, consider $\struct{A}_2\coloneqq (\mathbb{Q};<,\{(x,y,z) \in \mathbb{Q}^{3} \mid x\geq y \text{ or } x\geq z\})$.
%
This structure is a finitely bounded homogeneous model-complete core without algebraicity;
its CSP is definable in fixed-point logic~\cite[Proposition~3.7]{bodirsky2022descriptive}.
%
Note that $\struct{A}_2$ is preserved by the binary commutative operation $(x,y)\mapsto \min(x,y)$, and hence its polymorphism clone satisfies the identity $  f(x,y) \approx f(y,x)$.
% 
For the same reason as above, $\struct{A}_2$ does not pp-construct $\blowup{\struct{A}_2}$.  
\end{example}

 


\section{\texorpdfstring{$\omega$}{omega}-categorical sandwiches for PCSPs} \label{section:sandwiches}

\subsection{PCSP polymorphisms and full powers}

We extend the notion of a polymorphism to PCSP templates $(\struct{S}_1,\struct{S}_2)$ in the usual way:
%
a $k$-ary \emph{polymorphism} of $(\struct{S}_1,\struct{S}_2)$  is a homomorphism from a finite power of $\struct{S}_1$ to $\struct{S}_2$;
%  
we denote by $\Pol(\struct{S}_1,\struct{S}_2)$ the set of all such polymorphisms. 
%  
Also the satisfaction of height-1 conditions can be generalized to the PCSP setting in a straightforward manner.
%
In the case of nested identities, we have to be more careful because the composition of polymorphisms between different structures is not defined.
%  
We say that a height-1 condition $\Sigma$ is \emph{satisfied in  $\Pol(\struct{S}_1,\struct{S}_2)$ modulo a set $H$ of unary operations on $S_2$} if the function symbols in $\Sigma$ can be interpreted as elements of $\Pol(\struct{S}_1,\struct{S}_2)$ such that for each identity $s \approx t$ in $\Sigma$ there exist $\alpha,\beta\in H$ such that $\alpha\circ s =\beta \circ t$ holds for any evaluation of variables in $S_1$.
% 
 
    Our basic tool for creating $\omega$-categorical sandwiches for PCSPs that are not finitely tractable are  \emph{full powers} (see, e.g.,~Bodirsky~\cite[Section~3.5]{bodirsky2021complexity}).
    %
    Roughly speaking, a full power $\fpwr{\struct{A}}{d}$ is a higher-dimensional representation of $\struct{A}$ that can be pp-constructed from it and vice versa; its central feature is that its polymorphisms are the polymorphisms of $\struct{A}$ acting on $d$-tuples, thus allowing to factor it by the orbit-equivalence of $\Aut(\struct{A})$ on $d$-tuples (rather than on elements). 
    %
     In other words, the orbits of $d$-tuples of $\struct{A}$ are represented by orbits of $1$-tuples of $\fpwr{\struct{A}}{d}$, which is crucial in applications of the sandwiching method. 
    
    Let $\struct{A}$ be a relational structure with a signature $\tau$ and let $d\in\mathbb{N}$ be arbitrary.  
    % 
    The $d$-th \emph{full power} of $\struct{A}$, denoted $\fpwr{\struct{A}}{d}$, is the structure with domain $A^d$ and the following relations for every $k \in [d]$:
     %
     \begin{itemize}
         \item for every $R\in \tau$ of arity $k$ and every injection $\iota\colon [k] \rightarrow [d]$, the unary relation 
         \begin{align*}
            R^{\fpwr{\struct{A}}{d}}_{\iota} \coloneqq \{ (a_1\dots, a_d)\in A^d \mid  (a_{\iota(1)},\dots,a_{\iota(k)}) \in R^\struct{A} \}; \hspace{3.5cm}
         \end{align*}
         \item  for every $R\in \tau$ of arity $k$ and every function $\iota\colon [k] \rightarrow [d]$, the $k$-ary relation
         %
         \begin{align*}
             \widehat{R}^{ \fpwr{\struct{A}}{d}}_{\iota} \coloneqq \{ ((a^1_1,\dots, a^1_m),\dots, (a^k_1,\dots, a^k_d)) \in (A^d)^k \mid  (a^1_{\iota(1)},\dots,a^k_{\iota(k)})\in R^{\struct{A}}
               \};
         \end{align*}  
         \item for all functions $\iota,\iota' \colon [k] \rightarrow [d]$, define the binary \emph{compatibility relation} 
         \begin{align*}
             S^{\fpwr{\struct{A}}{d}}_{\iota,\iota'} \coloneqq \{ (a^1_1\dots, a^1_d),(a^2_1,\dots,a^2_d)\in (A^d)^2 \mid \forall i \in [k] \colon a^1_{\iota(i)}=a^2_{\iota'(i)}    \}. \hspace{1.25cm}
         \end{align*}
          
    \end{itemize}  
%
 Below we give several crucial properties of full powers.

\begin{restatable}[Basic properties of full powers]{proposition}{fullpower} \label{prop:basic_properties_full_powers}
Let $\struct{A}$ be a relational structure over a finite signature $\tau$ and let its relations be of arity $\leq d$. Then:
    \begin{enumerate}
        \item \label{item:fpwrpolequal} $\Pol(\fpwr{\struct{A}}{d})$ consists of the component-wise actions of polymorphisms of $\struct{A}$ on $d$-tuples.
        \item \label{item:fpwrppconstr} $\fpwr{\struct{A}}{d}$ is pp-constructible from $\struct{A}$ and vice versa.
        \item \label{item:fpwromegacat} If $\struct{A}$ is $\omega$-categorical, then $\fpwr{\struct{A}}{d}$ is $\omega$-categorical.
        \item \label{item:fpwrhomog} If $\struct{A}$ is homogeneous, then $\fpwr{\struct{A}}{d}$ is homogeneous.
        \item \label{item:fpwrmodcompl} If $\struct{A}$ is a model-complete core, then $\fpwr{\struct{A}}{d}$ is a model-complete core.
        \item \label{item:fpwrfinbou} If $\struct{A}$ is finitely bounded, then $\fpwr{\struct{A}}{d}$ is finitely bounded.
        \item \label{item:fpwrramsey} If $\struct{A}$ is homogeneous Ramsey, then $\fpwr{\struct{A}}{d}$ is homogeneous Ramsey.
        \item \label{item:fpwrreduct} If $\struct{A}$ is a reduct of $\struct{B}$, then $\fpwr{\struct{A}}{d}$ is a reduct of $\fpwr{\struct{B}}{d}$.
    \end{enumerate} 

 \end{restatable}  
 

\subsection{Our sandwich recipe}

\begin{restatable}{proposition}{sandwiches} \label{prop:sandwiches}
Let $\struct{A}$ be a reduct of a linearly ordered finitely bounded homogeneous structure $\struct{B}$ such that the polymorphisms of $\struct{A}$ preserve $\neq$. 
   %
    Let $d\in\mathbb{N}$ be such that the bounds of $\struct{B}$ have size $\leq d$ and its relations are of arity $\leq d-1$. 
    %
    Then there exists a finite substructure $\struct{S}$ of $\struct{A}$ such that: 
    %
    \begin{enumerate} 
        \item $\fpwr{\struct{A}}{d}$ is a sandwich for $\PCSP(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$;
        \item  Every finite sandwich for $\PCSP(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$ pp-constructs $\struct{K}_3$. 
    \end{enumerate} 
   
 \end{restatable}
    

\begin{proof}[Proof sketch] Clearly, for every finite substructure $\struct{S}$ of $\struct{A}$, we have $ \fpwr{\struct{S}}{d}  \rightarrow \fpwr{\struct{A}}{d} \rightarrow \fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}$.
%
We show that there exists a finite substructure $\struct{S}$ of $\struct{A}$  satisfying the second item. 
%
Since $\struct{A}$ is $\omega$-categorical and its polymorphisms preserve $\neq$, by a standard compactness argument there exists a finite substructure $\struct{S}$ of $\struct{A}$ such that $\Pol(\struct{S},\struct{A})$ preserves $\neq$.
%
Moreover, we can without loss of generality assume $|S|\geq 3$.  
%
Now suppose that there is a finite sandwich $\struct{D}$ of $(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$ that does not pp-construct $\struct{K}_3$. 
%
Then, by Theorem \ref{thm:barto12}, there exists a cyclic operation $f$ in $\Pol(\struct{D})$ of some arity $n$. 
%
Take any homomorphisms $g\colon \fpwr{\struct{S}}{d} \rightarrow \struct{D}$ and $h\colon \struct{D} \rightarrow \smash{\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}}$. 
%
Then, by setting 
%
$
    f'(x_1,\dots,x_n) \coloneqq h\circ f(g(x_1),\dots,g(x_n)),
$
%
we get a cyclic $f'\in \Pol(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$ of arity $n$.
%
One can show that every polymorphism from $\fpwr{\struct{S}}{d}$ to $\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}$ can be lifted to a homomorphism from $\struct{S}$ to $\struct{A}$ and that any identity that is satisfied in $\Pol(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$ is also satisfied in $\Pol(\struct{S},\struct{A})$ modulo $\Aut(\struct{B})$. 
%
Hence, there is some $n$-ary $g\in\Pol(\struct{S},\struct{A})$ that is pseudo-cyclic modulo $\Aut(\struct{B})$.  
%
One easily sees that any operation that is pseudo-cyclic modulo some order-preserving automorphism group  must be cyclic.
% 
But any cyclic operation on a set of size at least 3 does not preserve $\neq$, a contradiction.
%  
\end{proof} 


The following statement is folklore; see, e.g.,~\cite[Section~2.3.6]{bodirsky2021complexity}.

\begin{proposition} \label{prop:generic_superpositions} Let $\struct{A}$ and $\struct{B}$ be two countable homogeneous structures without algebraicity over disjoint finite relational signatures $\tau$ and $\sigma$. 
%
Then there exists an up to isomorphism unique homogeneous $(\tau\cup \sigma)$-structure $\struct{A}\ast \struct{B}$, called their \emph{generic superposition}, with the property that $\struct{A}\ast \struct{B}|_{\tau}$ and $\struct{A}\ast \struct{B}|_{\sigma}$ are isomorphic to $\struct{A}$ and $\struct{B}$, respectively. If both $\struct{A}$ and $\struct{B}$ are finitely bounded, then $\struct{A}\ast \struct{B}$ is finitely bounded as well.
\end{proposition} 
 
\begin{proof}[Proof of Theorem~\ref{thm:main_theorem_sandwiches}] Let $\struct{A}$ be a non-trivial reduct of a finitely bounded homogeneous structure $\struct{B}$. 
    % 
    In the first step, we take the structures $\blowup{\struct{A}}$ and $\ordblowup{\struct{B}}$ from Theorem~\ref{thm:removing_algebraicity} to remove algebraicity from $\struct{A}$ and $\struct{B}$ while ensuring that $\struct{\blowup{\struct{A}}}$ pp-constructs $\struct{K}_3$ if and only if $\struct{A}$ does and $\CSP(\struct{A})$ and $\CSP(\blowup{\struct{A}})$ are Datalog-interreducible.
     %
    Next, we take the generic superposition of $\ordblowup{\struct{B}}$ with $(\mathbb{Q};<)$, which exists by Proposition~\ref{prop:generic_superpositions}.
    %
    We set $\widehat{\struct{B}}\coloneqq  \ordblowup{\struct{B}} \ast (\mathbb{Q};<)$ and define $\widehat{\struct{A}}$ as the reduct of $\widehat{\struct{B}}$ to the signature of $\blowup{\struct{A}}$. 
    %
     By Proposition~\ref{prop:generic_superpositions}, $\widehat{\struct{B}}$ is finitely bounded homogeneous and $\widehat{\struct{A}}$ and $\blowup{\struct{A}}$ are isomorphic.
    %  
    But now $\widehat{\struct{A}}$ and $\widehat{\struct{B}}$ satisfy the prerequisites of Proposition~\ref{prop:sandwiches}.
    %
    It follows that $\struct{A}'\coloneqq \fpwr{\widehat{\struct{A}}}{d}$, $\struct{S}_1\coloneqq  \fpwr{\struct{S}}{d}$, and $ \struct{S}_2\coloneqq \fpwr{\widehat{\struct{A}}}{d}_{\orbeq{\Aut(\widehat{\struct{B}})}}$ for $\struct{S}$ as in Proposition~\ref{prop:sandwiches} witness 
    items~\ref{item:all1}--\ref{item:all4} of the theorem. 
    %
    Item~\ref{item:all5} follows directly from Theorem~\ref{thm:removing_algebraicity}\eqref{item:1} and Proposition~\ref{prop:basic_properties_full_powers}\eqref{item:fpwrmodcompl}.
    %
    Similarly, item~\ref{item:all6} follows directly from Theorem~\ref{thm:removing_algebraicity}\eqref{item:2}, Proposition~\ref{prop:basic_properties_full_powers}\eqref{item:fpwrramsey}, and \cite[Theorem~1.5]{bodirsky2014new}.
\end{proof}

\section{Conclusion}\label{sect:conclusion} 

\subsection{Necessity of preprocessing} 

In our proof of Theorem~\ref{thm:main_theorem_sandwiches}, we apply   Proposition~\ref{prop:sandwiches} to a structure which we previously ``preprocessed'' using Theorem~\ref{thm:removing_algebraicity} (removing algebraicity) and generic superpositions. 
It is natural to ask how strong Proposition~\ref{prop:sandwiches} is on its own: can a result similar to Theorem~\ref{thm:main_theorem_sandwiches} be proved directly using this proposition,  perhaps under a  more general structural assumption, e.g.~that  $\struct{A}$ is a model-complete core?
%
Here the answer seems to be negative.
% 
Consider the model-complete core  structure $\struct{A}=(\mathbb{Q};<,\{(x,y,z) \in \mathbb{Q}^{3} \mid x\geq y \text{ or } x\geq z\})$ from the scope of  Conjecture~\ref{conj:bodirsky_pinsker} ($\struct{A}_2$ in Example~\ref{ex:two_ex}); its CSP is  polynomial-time tractable~\cite{ComplOfTempCSPs}.
%
Let $\struct{S}$ be any finite structure for which there exists a homomorphism $h\colon \struct{S}\rightarrow \fpwr{\struct{A}}{d}$, and let $\struct{B}$ be an arbitrary $\omega$-categorical expansion of $\struct{A}$.
%
Let $A_S$ be the set of the elements in $A$ that appear as an entry of some element of $h(S)$, and let  $\struct{A}_S$ be the substructure of $\struct{A}$ on $A_S$.
%
Since $\fpwr{\struct{A}}{d}\to \smash{\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}}$, the structure $\fpwr{\struct{A}}{d}_S$ is a finite sandwich for $\PCSP(\struct{S},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$.
%
 We show that $\CSP(\smash{\fpwr{\struct{A}}{d}_S})$ is tractable, and hence this PCSP is finitely tractable (unless P=NP, in which case this entire discussion is pointless).
 %
 To this end, observe that the binary minimum operation $\min(x,y)$ is a polymorphism of $\struct{A}$. This operation is \emph{conservative}:
 %
 $\min(x,y)\subseteq \{x,y\}$ holds for all $x,y$.
 %
 Hence, its restriction to $A_S^2$ induces a polymorphism of $\struct{A}_S$, which itself induces a polymorphism of $\fpwr{\struct{A}}{d}_S$ through its component-wise action.
 %
 Since this operation is cyclic, $\fpwr{\struct{A}}{d}_S$ does not pp-construct $\struct{K}_3$ \cite[Theorem 1.4]{barto2018wonderland}, and hence we are done by Theorem~\ref{thm:finite_domain_CSP}.
 %
 This issue cannot be fixed simply by taking an expansion of $\struct{A}$ by the inequality relation $\neq$ because $\CSP(\struct{A};\neq)$ is NP-complete~\cite{ComplOfTempCSPs}.
 

\subsection{Numeric algorithms fail} An interesting open question is whether the PCSP templates generated by Theorem~\ref{thm:main_theorem_sandwiches} can be solved by some universal algorithm.
%
Many known PCSP problems admitting infinite tractable sandwiches can be solved by numeric relaxation algorithms such as \emph{BLP} (the basic linear programming relaxation), \emph{AIP} (the basic affine integer relaxation) or \emph{BLP+AIP} (a combination of both) (see, e.g., \cite{barto2021algebraic,BLP_AIP}).
%
The proof of Proposition~\ref{prop:sandwiches} shows that none of the PCSP templates produced by Theorem~\ref{thm:main_theorem_sandwiches} admits a cyclic polymorphism.
%
Since solvability of PCSPs by BLP is characterized by admitting totally symmetric polymorphisms of all arities~\cite[Theorem 7.9]{barto2021algebraic}, which would also be cyclic, BLP does not solve any of those PCSPs.

Regarding the combination BLP+AIP, we remark that the construction of $\blowup{\struct{A}}$ and $\ordblowup{\struct{B}}$ in the proof of Theorem~\ref{thm:removing_algebraicity} can be modified so that, for some finite substructure $\struct{S}$ of $\mathbb{Q}^\struct{A}$, there is no cyclic and no 2-block symmetric operation in $\Pol(\struct{S},\mathbb{Q}^\struct{A})$ (all other properties of $\blowup{\struct{A}}$ and $\ordblowup{\struct{B}}$ remain preserved).
%
Similarly to cyclic identities, also any 2-block symmetric identity can be lifted from $\Pol(\fpwr{\struct{S}}{d},\fpwr{(\mathbb{Q}_{\orbeq{G}}^\struct{A})}{d} )$ to $\Pol(\struct{S},\mathbb{Q}^\struct{A})$, where $G\coloneqq \smash{\Aut(\mathbb{Q}^\struct{B}\ast (\mathbb{Q};<))}$.
%
Thus, since solvability of a finite-domain PCSP by BLP+AIP is characterized by the existence of 2-block symmetric polymorphisms \cite[Theorem 4]{BLP_AIP}, $\PCSP(\fpwr{\struct{S}}{d},\fpwr{(\mathbb{Q}_{\orbeq{G}}^\struct{A})}{d})$ is not solvable by BLP+AIP.
%
For details, we refer the reader to~\cite[Theorem~2]{Mottet_2025}, where this idea was used in concrete cases of non-finitely tractable PCSPs. 
% 
It follows that we can exclude BLP and BLP+AIP as potential algorithms solving the PCSPs produced by Theorem~\ref{thm:main_theorem_sandwiches}. 
%  


\subsection{Topology is irrelevant}
  
  In the context of infinite-domain CSPs, the influence of topological properties of the polymorphism clones of $\omega$-categorical structures has received much attention, with various results claiming their relevance~\cite{bodirsky_relevant_2019} or irrelevance~\cite{barto_pinsker_journal}: while generally, whether or not an $\omega$-categorical structure $\struct{A}$ pp-constructs $\struct{K}_3$ (or \emph{pp-interprets} another $\omega$-categorical structure $\struct{A'}$) does depend on such topological properties~\cite{barto2018wonderland,Topo-Birk,uniformbirkhoff,  bodirsky2021projective}, in many situations it does not (see, e.g.,~\cite{EJMPP}). 
    %
    By moving from any $\omega$-categorical model-complete core template to one without algebraicity, Theorem~\ref{thm:removing_algebraicity} allows us to restrict Conjecture~\ref{conj:bodirsky_pinsker} to a class of topologically well-behaved structures. Namely, for those recent research suggests that often the algebraic structure determines the topological one; at least this is a fact for the endomorphism monoid, where the relevant topology (\emph{pointwise convergence}) can then be defined from the algebraic structure of the monoid alone~\cite{PINSKER_SCHINDLER_2023}.
%r\cite{rubin_reconstruction_1994, PINSKER_SCHINDLER_2023}.  
    %
     For $\omega$-categorical structures with algebraicity, on the other hand, various examples~\cite{evans_counterexample_1990, bodirsky_counterexample_2018,PINSKER_SCHINDLER_2023} show that this need not be the case. This also implies that there is no hope of lifting isomorphisms between endomorphism monoids or polymorphism clones of $\omega$-categorical structures to their counterparts constructed in Theorem~\ref{thm:removing_algebraicity}.  







\bibliographystyle{plain}
\bibliography{REFERENCES}
 

\appendix
\section{Algebraicity is irrelevant (for infinite-domain CSPs)}\label{appendix:section_algebraicity}

\subsection{Omitted definitions}\label{appendix:subsection_definitions}



 We expand on some of the definitions appearing in the paper that were, for the sake of brevity, not presented in much detail.
%
We also add the concept of a relational congruence, which will be useful in the
the presentation of the proofs of Proposition~\ref{prop:basic_properties_wreath_products}, Lemma~\ref{lemma:liftpol}, and Theorem~\ref{thm:removing_algebraicity}, and state the theorem of  
Kechris, Pestov, and Todor\v{c}evi\'{c} referred to in Section~\ref{subsect:relatedwork}, which is needed in the proof of Proposition~\ref{prop:basic_properties_wreath_products}. 
% 

Let $\struct{A}$ be a structure over a finite relational signature containing $\tau$.
%
An equivalence relation $E$ over $A$ is a \emph{relational congruence} on $\struct{A}$ with respect to $\tau$ if the definitions of the corresponding relations of $\struct{A}/E$ do not depend on the choices of the representatives of the equivalence classes of $E$:  for every $R\in \tau$ and all tuples $\bar{t}$ we have $q_E(\bar{t})\in R^{\struct{A}/{E}}$ if and only if $\bar{t}\in R^{\struct{A}}$. 

Recall from the introduction that an $\omega$-categorical structure $\struct{A}$ is a model-complete core if the endomorphisms of $\struct{A}$ preserve all orbits of $\Aut(\struct{A})$.
%
A reformulation of this definition that will be more convenient for us is that for every $e\in \End(\struct{A})$ and every finite $F\subseteq A$, there exists $\alpha \in \Aut(\struct{A})$ such that $e|_F=\alpha|_F$~\cite{bodirsky2021complexity}; we will use this  in the proof of Theorem~\ref{thm:removing_algebraicity}.

Next, we properly define the Ramsey property.
%
For structures $\struct{A}$ and $\struct{W}$, we denote by $\binom{\struct{W}}{\struct{A}}$ the set of all embeddings of $\struct{A}$ into $\struct{W}$.
%
A class $\mathcal{K}$ of structures over a common signature $\tau$ has the \emph{Ramsey property} (RP) if,  for all $\struct{X},\struct{Y}\in \mathcal{K}$ and $k\in \mathbb{N}$, there exists $\struct{W}\in \mathcal{K}$ such that, for every map $f\colon \smash{\binom{\struct{W}}{\struct{X}}} \rightarrow [k]$, there exists $e\in \smash{\binom{\struct{W}}{\struct{Y}}}$ such that $f$ is constant on the set $\{e\circ u\;|\; u\in \textstyle\smash{\binom{\struct{Y}}{\struct{X}}}\} \subseteq \textstyle\smash{\binom{\struct{W}}{\struct{X}}}.$
% 
It is a folklore fact that considering the special case $k=2$ is enough for verifying the RP~\cite{hubickanesetril2019}, and we call any  $\struct{W}$ satisfying the above in this case a \emph{Ramsey witness} for $(\struct{X},\struct{Y})$.  

A homogeneous structure is \emph{Ramsey} if its age has the Ramsey property.
%
 The \emph{age} of a structure $\struct{B}$, denoted by $\age(\struct{B})$, is the class of all finite structures which embed into $\struct{B}$.
  


\subsection*{The KPT correspondence.}
%
In the proof of Proposition~\ref{prop:basic_properties_wreath_products}, we use the Kechris-Pestov-Todor\v{c}evi\'c (KPT) correspondence, which links the Ramsey property for homogeneous structures over countable signatures to a  property of their automorphism group viewed as a topological group. 

A \emph{topological group} is a pair $(G,\mathcal{T})$, where $G$ is a group and $(G;\mathcal{T})$ a topological space, such that both taking inverses and composition in the group $G$ are continuous with respect to $\mathcal{T}$. 
%
A topological group $(G,\mathcal{T})$ is called \emph{extremely amenable} if every continuous action $\alpha$ of $(G,\mathcal{T})$ on a topological compact Hausdorff space $(X,\mathcal{T}')$ has a fixed point, i.e.~there exists $x\in X$ such that $\alpha(g)(x)=x$ for every $g\in G$; the action $\alpha$ being continuous means that  the map $(g,x)\mapsto \alpha(g)(x)$ is.
% 
A bijective map $f$ between two topological groups is a \emph{topological isomorphism} if it is a group isomorphism and  both $f$ and $f^{-1}$ are continuous.
%
Clearly,  topological group isomorphisms preserve extreme amenability. 
%

The formulation of the KPT correspondence below (Theorem~\ref{thm:kpt}) refers to the extreme amenability of $\Aut(\struct{B})$, without mentioning any specific topology: this is because it is understood to be equipped with the \emph{topology of pointwise convergence}.
%
This is the smallest topology on $\Aut(\struct{B})$ containing all sets of the form $\{g\in \Aut(\struct{B}) \mid g(\bar{t}) =\bar{s}\}$ for some tuples $\bar{t},\bar{s}$ over $B$, the \emph{basic open sets} of the topology.
%  
\begin{theorem}[Kechris, Pestov, and Todorcevic~\cite{kechris2005fraisse}] \label{thm:kpt} Let $\struct{B}$ be a homogeneous structure over a countable  relational signature. 
%
Then the following are equivalent:
%
\begin{itemize}
    \item $\Aut(\struct{B})$ is extremely amenable;
    \item $\age(\struct{B})$ has the RP.  
\end{itemize} 
\end{theorem}  

 

\subsection{A proof of Proposition~\ref{prop:CSP_injective_no_algebraicity}}

\corealgebraicity*  

\begin{proof} Let $\struct{B}$ be a CSP-injective $\omega$-categorical model-complete core.
%
We show that $\struct{B}$ has no algebraicity.
%
Suppose, on the contrary, that there exists $\bar{b}\in B^k$ and  $b'\notin \bar{b}$ such that the unary relation $\{b'\}$ is first-order definable in $\struct{B}$ using $\bar{b}$ as parameters.
%
By~\cite[Theorem~4.5.1 and Lemma~4.5.5]{bodirsky2021complexity}, the expansion $(\struct{B},\{\bar{b}\})$ is an $\omega$-categorical model-complete core, and there exists a primitive positive formula $\phi(x)$ defining $\{b'\}$ in $(\struct{B},\{\bar{b}\})$.
%
Also, by~\cite[Theorem~4.5.1]{bodirsky2021complexity}, there exists a primitive positive formula $\psi(\bar{y})$ defining the orbit of $\bar{b}$ in $\struct{B}$.
%
We may assume that $\psi$ does not contain any equality atoms, otherwise we eliminate them by identifying variables.
%
Let $\phi'$ be the primitive positive formula obtained by replacing the constants $\bar{b}$ in $\phi$ with the variables $\bar{y}$, and set $\phi'' \coloneqq   \psi(\bar{y}) \wedge \phi'(x_1)\wedge \phi'(x_2)$; we may again assume that $\phi'$ and $\phi''$ do not contain any equality atoms. 
% 
 We can use $\phi''$ to create an instance $\struct{A}$ of $\CSP(\struct{B})$ that maps homomorphically to $\struct{B}$ but has no injective such homomorphism.
 %  
 More specifically, the domain of $\struct{A}$ consists of the variables of $\phi''$, and the  relations are determined by the atomic subformulas of $\phi''$. 
%  
Clearly, $\struct{A}$ has a homomorphism to $\struct{B}$, because we can substitute $\bar{b}$ for $\bar{y}$ in $\phi''$ and $b$ for both $x_1$ and $x_2$.
%
However, $\struct{A}$ has no injective homomorphism to $\struct{B}$.
%
Indeed, if this was the case, then there would exist distinct witnesses $\bar{y}$, $x_1$, and $x_2$ for the satisfaction of $\phi''$ in $\struct{B}$.
%
By definition, there would exist $\alpha\in \Aut(\struct{B})$ with $\alpha(\bar{y})=\bar{b}$.
%
But then $\alpha(x_1)=\alpha(x_2)=c$, a contradiction to the injectivity of $\alpha$.
%
We conclude that $\struct{A}$ does not have any injective homomorphism to $\struct{B}$, and hence  $\struct{B}$ is not CSP-injective, a contradiction to our original assumption. 
    %
    Hence, $\struct{B}$ has no algebraicity.
\end{proof} 


\subsection{A proof of Proposition~\ref{prop:pol_and_CSP_injectivity}}
 

\clash*

\begin{proof}
We instead show that a $\omega$-categorical $\Pol$-injective structure cannot be CSP-injective. Note that this leads to the same conclusion as the original statement, namely, that the formal intersection between the two properties is empty.

    Let $\struct{B}$ be an $\omega$-categorical Pol-injective structure. 
    %
    Note that every essentially injective operation preserves the relation $I_4$.
    %
    Hence, every polymorphism of $\struct{B}$ preserves $I_4$, and so $I_4$ is pp-definable in $\struct{B}$.
    %
  
    
    Let $\phi(x,y,u,v)$ be a primitive positive formula that defines $I_4$ in $\struct{B}$.
    %
    Since $I_4$ contains all $4$-tuples with pairwise distinct entries, we may assume that $\phi$ contains no equality atoms, otherwise we eliminate them by identifying variables.
    %
    But now we can use $\phi$ to create an instance $\struct{A}$ of $\CSP(\struct{B})$ that maps homomorphically to $\struct{B}$ but has no injective such homomorphism.
    % 
    More specifically, the domain of $\struct{A}$ consists of the variables of $\phi$, except that we identify $x$ and $y$ (but not $u$ and $v$), and the relations are determined by the atomic subformulas of $\phi$. We conclude that $\struct{B}$ is not CSP-injective.   
\end{proof} 


\subsection{A proof of Proposition~\ref{prop:expans_datalog}}

\expansCSPinjective*
 
\begin{proof}
The Pol-injectivity of $\struct{A}_{I_4}$ follows from the known fact that every polymorphism of $I_4$ is essentially injective~\cite{BodChenPinsker} (see also~\cite[Lemma~7.5.1]{bodirsky2021complexity}). We proceed with the proof of Datalog-interreducibility.

We first give a Datalog-reduction $\mathcal{I}^{\ast}$ from $\CSP(\struct{A}_{I_4})$ to $\CSP(\struct{A})$.
%
Let $\tau$ be the signature of $\struct{A}$.
%
Given an instance $\struct{J}$ of $\CSP(\struct{A}_{I_4})$, the relation $\approx$ is defined in $\struct{J}$ by the following Datalog program:
%
\begin{align*}  
  (x\approx y)  \Leftarrow \ & I_4(u,v,x,y) \wedge  (u\approx v), \\
  (x\approx z)  \Leftarrow  \ &  (x\approx y)  \wedge (y\approx z), \\
  (x\approx y)  \Leftarrow \ &  (y\approx x), \\
  (x\approx y) \Leftarrow \ &  (x=y).
\end{align*} 

By definition, this relation is an equivalence relation on $J$; denote by $q_{\approx}$ be the induced quotient map $J\rightarrow J/{\approx}, x\mapsto [x]_{\approx} $.
%  
Let $S\coloneqq \{s_1,\dots, s_n\}$ be arbitrary representatives of the ${\approx}$-classes.
%
Without loss of generality, $S = J/{\approx} $.
%
We define $\mathcal{I}^{\ast}(\struct{J})$ as the $\tau$-structure with domain $J$ and whose relations are the preimages of all $\tau$-relations in $\struct{J}/{\approx}$ under $q_{\approx}$.
%
We verify that $\mathcal{I}^{\ast}$ is a reduction. 

Suppose that $\mathcal{I}^{\ast}(\struct{J}) \rightarrow \struct{A}$.
%
Note that $(\struct{J}/{\approx})|^{\tau}$ is a substructure of $\mathcal{I}^{\ast}(\struct{J})$, and hence $(\struct{J}/{\approx})|^{\tau}\rightarrow \struct{A}$.
% 
Since $\struct{A}$ is CSP-injective, there exists an injective homomorphism $h \colon (\struct{J}/{\approx})|^{\tau} \rightarrow \struct{A}$.
%  
By the definition of $\approx$, if $([s_1]_{\approx},[s_2]_{\approx},[s_3]_{\approx},[s_4]_{\approx})\in I_4^{\struct{J}/{\approx}}$ and $[s_1]_{\approx}=[s_2]_{\approx}$, then $[s_3]_{\approx}=[s_4]_{\approx}$.
%
Since $h$ is injective, it follows that $h$ is also a homomorphism from $\struct{J}/{\approx}$ to $\struct{A}_{I_4}$.
%
Then $h\circ q_{\approx} $ is a homomorphism from $\struct{J}$ to $\struct{A}_{I_4}$.
% 

Now suppose that there exists a homomorphism $g\colon \struct{J}\rightarrow\struct{A}_{I_4}$. 
%
Note that, by definition, for every $k$-ary $R\in\tau$, we have $([s_{i_1}]_{\approx},\dots, [s_{i_k}]_{\approx}) \in R^{\mathcal{I}^{\ast}(\struct{J})}$ if and only if there are $j_1\in [s_{i_1}]_{\approx}, \dots, j_k\in [s_{i_k}]_{\approx}$ such that  $(j_1,\dots,j_k) \in R^{\struct{J}}$.
%
By the definition of $\approx$, every function preserving $I_4$ must identify $\approx$-equivalent elements, and therefore $(g(s_{i_1}),\dots,g(s_{i_k}))=(g(j_1),\dots,g(j_k))$, which implies $(g(s_{i_1}),\dots,g(s_{i_k})) \in  R^{\struct{A}_{I_4}}$. 
%
Therefore, $g$ is a homomorphism from $\mathcal{I}^{\ast}(\struct{J})$ to $\struct{A}$.

The reduction in the opposite direction is trivial. Given an instance $\struct{J}$ of $\CSP(\struct{A})$, we define $\mathcal{I}(\struct{J})$ as the $(\tau\cup \{I_4\})$-expansion of $\struct{J}$ by an empty relation.
\end{proof}
 
\subsection{A proof of Proposition~\ref{prop:basic_properties_wreath_products}}

\wreathproducts*
 
 
 
\begin{proof}  
For~\eqref{item:aut_wreath}, we first show that $\Aut(\struct{A}) \wr \Aut(\struct{B})$ is a subgroup of $\Aut(\struct{A}\wr\struct{B})$.
    %
    Clearly, the wreath product is a subgroup of $\Sym(A\times B)$ and preserves $E^{\struct{A}\wr\struct{B}}$.
    %
    Moreover, as every group element $\left((g_b)_{b\in B},h\right)$ simply acts like $h$ in the second component, all $\sigma$-relations are preserved.
    %
    Concerning $\tau$-relations, note that all pairs occurring within a tuple $((a_1,b_1),\dots,(a_k,b_k))\in R^{\struct{A}\wr\struct{B}}$ share the same second entry $b=b_1=\cdots =b_k$.
    %
    Therefore, the same $g_{h(b)}\in\Aut(\struct{A}))$ is picked to act on all the first entries, and the image $((g_{h(b)}(a_1),h(b)),\dots,(g_{h(b)}(a_k),h(b)))$ lies within $R^{\struct{A}\wr\struct{B}}$.
    
    To prove the equality of the two groups, it remains to show that every $w\in\Aut(\struct{A}\wr\struct{B})$ can be written in the above form.
    %
    As $w$ acts on the equivalence classes of $E^{\struct{A}\wr\struct{B}}$, it induces an automorphism $h'$ on the $\sigma$-reduct of $(\struct{A}\wr\struct{B})/E^{\struct{A}\wr\struct{B}}$, which is isomorphic to $\struct{B}$.
    %
    Further, for any $b\in B$, $w$ also induces an automorphism $g'$ on the $\tau$-reduct of the substructure induced by $A\times \{b\}$, which is in turn isomorphic to $\struct{A}$. 
    %
    Denoting the corresponding automorphisms of $\struct{A}$ and $\struct{B}$ by $g_{h(b)},b\in B$ and $h$, it is now easy to check that $((g_b)_{b\in B},h)$ and $w$ coincide.

    For~\eqref{item:algebraicity},  we show that fixing any tuple $\bar{t}$ of parameters does not yield any nontrivial fixed point of the automorphism group when stabilizing $\bar{t}$. Let $(a',b')$ be any element outside $\bar{t}$. Let $A'$ be the set of all $a\in A$ such that $(a,b)$ appears in $\bar{t}$ for some $b\in B$. Move $a'$ to a different element via some $g\in\Aut(\struct{A})$   whilst fixing $A'$; this is possible because $\struct{A}$ has no algebraicity. Then $\left((g_b)_{b\in B},id\right)$ with $g_{b}\coloneqq g$ if $b=b'$ and $id$ otherwise is an automorphism of $\Aut(\struct{A}\wr\struct{B})$ fixing each entry in $\bar{t}$ and moving $(a',b')$. 

For~\eqref{item:aut_wreath_omega_cat}, recall that, by item~\eqref{item:aut_wreath}, we have $\Aut(\struct{A} \wr \struct{B})=\Aut(\struct{A}) \wr \Aut(\struct{B})$.
%
But note that $\Aut(\struct{A}) \wr \Aut(\struct{B})$ in particular contains the Cartesian product $\Aut(\struct{A})\times \Aut(\struct{B})$. 
%\moritz{Michael criticized that the action of the Cartesian product needs to be defined. I now explained this before the Proposition, I hope this is fine.}
%
%But note that $\Aut(\struct{A}) \wr \Aut(\struct{B})$ in particular contains a copy of the usual Cartesian product  $\Aut(\struct{A})\times \Aut(\struct{B})$ acting on $A\times B$ via $(g,h)(a,b)=(g(a),h(b))$, as $((g)_{b\in B},h)$ acts in that exact way. (redundant as I explained the Cartesian product action when defining the wreath product)
% 
Since the Cartesian product already witnesses that there are only finitely many orbits of tuples of each arity, the statement follows. 

For~\eqref{item:wreath_homogeneous}, let $\bar{t}$ and $\bar{s}$ be tuples of the same length such that the map sending $\bar{t}$ to $\bar{s}$ is a partial isomorphism. 
%
By reordering, we split $\bar{t}$ into subtuples $(\bar{t}_{b_1},\dots,\bar{t}_{b_n})$ for distinct elements $b_i\in B$ such that the second  projection of all entries of $\bar{t}_{b_i}$ is  $b_i$. Similarly, we obtain $(\bar{s}_{c_1},\dots,\bar{s}_{c_n})$. Pick $g_{c_i}\in\Aut(\struct{A})$  sending the first projections of $\bar{t}_{b_i}$ to those of $\bar{s}_{c_i}$. Pick $h\in\Aut(\struct{B})$ sending $b_i$ to  $c_i$. The automorphism $((g_b)_{b\in B}),h)$, where $g_b=id$ if hitherto undefined, sends $\bar{t}$ to $\bar{s}$.

For~\eqref{item:finite_boundedness}, let $\Phi_{\struct{A}}$ and $\Phi_{\struct{B}}$ be any universal sentences defining $\age(\struct{A})$ and $\age(\struct{B})$, respectively. 
%
Denote their quantifier-free parts by $\phi_{\struct{A}}$ and $\phi_{\struct{B}}$.
%
For two tuples $\bar{x}_1,\bar{x}_2$ of the same arity $k$, we use $E(\bar{x}_1,\bar{x}_2)$ as a shortcut for the formula stating that, for every $i\in [k]$, the $i$-the entry of $\bar{x}_1$ and the $i$-the entry of $\bar{x}_2$ are contained in an $E$-atom.
%
Then the following sentence $\Phi_{\struct{A}} \wr \Phi_{\struct{B}}$ defines $\age(\struct{A}\wr\struct{B})$:
%
\begin{align*}
 \forall x,y,z  \Big( E(x,x) \wedge  \big(E(x,y) \Rightarrow E(y,x)\big) \wedge  \big(E(x,y) \wedge E(y,z) \Rightarrow E(x,z) \big)
 \\   
  {}  \wedge \bigwedge\nolimits_{R\in \sigma}   \forall \bar{x}_1,\bar{x}_2   \Big( E(\bar{x}_1,\bar{x}_2) \Rightarrow \big(R(\bar{x}_1)  \Leftrightarrow  R(\bar{x}_2)  \big) 
 \Big)  \\  
   {}  \wedge  \forall \bar{x}  \Big(   \phi_{\struct{B}}(\bar{x})\vee \bigvee\nolimits_{x_1,x_2\in \bar{x}} \big(E(x_1,x_2) \wedge (x_1\neq x_2)\big)    \Big) \\
   {} \wedge \bigwedge\nolimits_{R\in \tau} \forall \bar{x} \Big( R(\bar{x}) \Rightarrow \bigwedge\nolimits_{x_1,x_2\in \bar{x}} E(x_1,x_2)\Big) \\
{}  \wedge \forall \bar{x}  \Big(   \phi_{\struct{A}}(\bar{x})\vee \bigvee\nolimits_{x_1,x_2\in \bar{x}} \neg E(x_1,x_2) \Big).  
\end{align*}
%
To see this, note that:
%
\begin{itemize}
    \item the first line ensures that $E$ is an equivalence relation,
    \item the second line ensures that $E$ is a relational congruence w.r.t.\ $\sigma$-relations,
    \item the third line ensures that the factor by $E$ satisfies $\Phi_{\struct{B}}$, 
    \item the fourth line ensures that $\tau$-relations do not stretch over different $E$-classes,
    \item the fifth line ensures that each $E$-class satisfies $\Phi_{\struct{A}}$.
\end{itemize}

For~\eqref{item:Ramsey}, recall that, by Theorem~\ref{thm:kpt}, $\Aut(\struct{A})$ and $\Aut(\struct{B})$ are extremely amenable. 
%
By Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:aut_wreath}, we have $\Aut(\struct{A} \wr \struct{B})=\Aut(\struct{A}) \wr \Aut(\struct{B})$.
%
Hence, we can use the folklore fact that $  \Aut(\struct{A}) \wr \Aut(\struct{B})$ is a semidirect product $\Aut(\struct{A})^B \rtimes \Aut(\struct{B})$.
%
In particular, we immediately get that $ \Aut(\struct{A})^B$ is a normal subgroup of $\Aut(\struct{A} \wr \struct{B})$.
% 
We claim that $\Aut(\struct{A})^B$ is closed with respect to the topology of pointwise convergence.
%
This follows directly from the fact that the complement of $\Aut(\struct{A})^B$ can be written as \[\bigcup\nolimits_{x \in B, y\in B\setminus\{x\}}\{\left((g_b)_{b\in B},h)\right)\in \Aut(\struct{A}\wr \struct{B}) \mid h(x)=y \},\] which is a union of basic open sets.
%
By Lemma~6.7(iii) in~\cite{kechris2005fraisse}, products of extremely amenable groups are extremely amenable, and hence $\Aut(\struct{A})^B$ is extremely amenable.
%
If we can show that also $\Aut(\struct{A} \wr \struct{B})/\Aut(\struct{A})^B$ is extremely amenable, then it follows from Lemma~6.7(ii) in~\cite{kechris2005fraisse} that $\Aut(\struct{A} \wr \struct{B})$ is extremely amenable as well.
% 
The composition $\pi \circ \iota$ of the natural embedding $\iota \colon \Aut(\struct{B})\rightarrow \Aut(\struct{A} \wr \struct{B})$ with the natural quotient map $\pi \colon \Aut(\struct{A} \wr \struct{B}) \rightarrow \Aut(\struct{A} \wr \struct{B})/\Aut(\struct{A})^B$ is a topological isomorphism between $\Aut(\struct{B})$ and $\Aut(\struct{A} \wr \struct{B})/\Aut(\struct{A})^B$. 
%
Hence, the claim follows from the fact that $\Aut(\struct{B})$ is extremely amenable.
%
Recall that, by item~\ref{item:wreath_homogeneous}, we have that $\struct{A} \wr \struct{B}$ is homogeneous.
%
Since $\Aut(\struct{A} \wr \struct{B})$ is extremely amenable, we conclude using Theorem~\ref{thm:kpt} that $\struct{A} \wr \struct{B}$ is homogeneous Ramsey.  
\end{proof} 

\subsection{A full proof of Theorem~\ref{thm:removing_algebraicity} and Theorem~\ref{thm:polinjective}}

\maintheorem*
 
\maintheoremtwo*
 
\medskip 
 
As the two theorems only differ in the presence of the relation $I_4$, 
large parts of the proofs of Theorem~\ref{thm:removing_algebraicity} and Theorem~\ref{thm:polinjective} are essentially the same.
%
For this reason, we conduct both proofs simultaneously, and differentiate whenever necessary. 

\begin{proof}[Proof of Theorem~\ref{thm:removing_algebraicity} and Theorem~\ref{thm:polinjective}]     

Let $\tau$ and $\sigma$ be the signatures of $\struct{A}$ and $\struct{B}$, respectively.
%
We first define the auxiliary structure $\struct{B}'\coloneqq  (\mathbb{Q};<) \wr \struct{B}$. 
%
By Example~\ref{ex:properties_of_q1} and Example~\ref{ex:properties_of_q2}, the structure $(\mathbb{Q};<)$ is finitely bounded, homogeneous, and has no algebraicity.
%
It follows immediately from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:algebraicity}  that $\struct{B}'$ has no algebraicity.
% 
We then define $\ordblowup{\struct{B}}$ as the expansion of $\struct{B}'$ by the binary inequality $\neq$.
%
Note that $\ordblowup{\struct{B}}$ has no algebraicity because taking expansions by first-order definable relations does not change the automorphism group; the same is true for the structure $\ordblowup{\struct{B}}_{I_4}$.
%
We obtain the structure $\blowup{\struct{A}}$ as a reduct of $\ordblowup{\struct{B}}$ by removing all symbols in $\sigma\setminus \tau$ as well as the symbol $<$; but note that $\blowup{\struct{A}}$ can also be defined directly from $\struct{A}$.  
%
We continue with the proofs of CSP/Pol-injectivity and Datalog-interreducibility, starting with the CSP-injective case. 
 
We claim that $\blowup{\struct{A}}$ is CSP-injective. 
%
To this end, let $\struct{J}$ be an arbitrary finite structure for which there exists a homomorphism $h\colon \struct{J} \rightarrow \blowup{\struct{A}}$.
%
We define $\struct{J}_{\pi}$ as the $(\tau \cup \{E\})$-structure with domain $J$ such that, for every $R\in \tau\cup \{E\}$, we have $\bar{t}\in R^{\struct{J}_{\pi}}$ if and only if $h(\bar{t})\in R^{\blowup{\struct{A}}}$.
% 
It is easy to see that $\struct{J}_{\pi}$ embeds into the $(\tau \cup \{E\})$-reduct of $\struct{B}'$.
%
Hence, $\struct{J}_{\pi}$ expanded by the binary inequality predicate embeds into $\blowup{\struct{A}}$ and admits an injective homomorphism from $\struct{J}$.
%
We conclude that $\blowup{\struct{A}}$ is CSP-injective.

Next, we informally describe two Datalog-reductions $\mathcal{I}^{\ast}$ and $\mathcal{I}$: from $\CSP(\blowup{\struct{A}})$ to $\CSP(\struct{A})$ and back, starting with the former. 
%  
Let $\struct{J}$ be an instance of $\CSP(\blowup{\struct{A}})$.
%
Denote by $\sim$ the equivalence closure of $E^{\struct{J}}$, and let $q_{\sim}\colon \struct{J}\rightarrow (\struct{J}/{\sim}), x \mapsto [x]_{\sim}$ be the induced quotient map.
%
We define $\mathcal{I}^{\ast}(\struct{J})$ as the $\tau$-structure with domain $J$ and whose relations are the preimages of all $\tau$-relations in $\struct{J}/{\sim}$ under $q_{\sim}$, except that we additionally add, for every $x\in J$ such that $(x,x)\in {\neq}^{\struct{J}}$, the tuple $(x,\dots, x)$ to every $\tau$-relation.

It is easy to see that $\mathcal{I}^{\ast}(\struct{J})$ is definable in Datalog; we verify that $\mathcal{I}^{\ast}$ is a reduction from $\CSP(\blowup{\struct{A}})$ to $\CSP(\struct{A})$. 
%
Clearly, if $\struct{J}$ maps homomorphically to $\blowup{\struct{A}}$, then $\mathcal{I}^{\ast}(\struct{J})$ maps homomorphically to $\struct{A}$.
%
Suppose that there exists a homomorphism $h\colon \mathcal{I}^{\ast}(\struct{J})\rightarrow\struct{A}$.
%
Since by non-triviality $\struct{A}$ does not have a constant endomorphism, there is no $x\in J$ such that $(x,x)\in {\neq}^{\struct{J}}$: otherwise, the map on $\struct{A}$ sending every element to $h(q_\sim(x))$ would provide such constant endomorphism.
%
Denote by $\struct{J}'$ the structure obtained from $\struct{J}$ by removing all tuples from ${\neq}^{\struct{J}}$.
%
Now, choosing representatives $j_1,\dots,j_k$ for all classes of $\struct{J}/{\sim}$, the function sending the entirety of $[j_i]_\sim$ to $(0,h(j_i))$ for all $i\leq k$ is a homomorphism from $\struct{J}'$ to $\blowup{\struct{A}}$.
%
By the CSP-injectivity of $\blowup{\struct{A}}$, it can be replaced by an injective homomorphism, which is then also a homomorphism from $\struct{J}$ to $\blowup{\struct{A}}$.

We continue with the reduction from $\CSP(\struct{A})$ to $\CSP(\blowup{\struct{A}})$, which is trivial.
%
Let $\struct{J}$ be an instance of $\CSP(\struct{A})$.
%
We define $\mathcal{I}(\struct{J})$ as the $(\tau\cup \{E,\neq\})$-expansion of $\struct{J}$ by empty relations.
%
By CSP-injectivity, there exists a homomorphism $h\colon \mathcal{I}(\struct{J}) \rightarrow \blowup{\struct{A}}$ if and only if there exists an injective such homomorphism $i$.
%
This is the case if and only if the relation $E^{\blowup{\struct{A}}}$ restricted to $i(C)$ describes the kernel of a homomorphism from  $\struct{J}$ to $\struct{A}$.
 % 
Therefore, $\struct{J}\rightarrow\struct{A}$ if and only if $\mathcal{I}(\struct{J})\rightarrow\blowup{\struct{A}}$. 
 
We now consider $\blowup{\struct{A}}_{I_4}$. 
%
By Proposition~\ref{prop:expans_datalog}, $\blowup{\struct{A}}_{I_4}$ is Pol-injective and $\CSP(\blowup{\struct{A}}_{I_4})$ and $\CSP(\blowup{\struct{A}})$ are Datalog-interreducible.
%
That $\CSP(\blowup{\struct{A}}_{I_4})$ and $\CSP(\struct{A}$) are Datalog-interreducible then follows from the fact that Datalog-reductions can be composed.
 
  
 
 

Finally, we verify the properties in items~\ref{item:1},~\ref{item:2},~\ref{item:3},~and~\ref{item:4}.
%
We only explicitly cover the case where $I_4$ is present, it is easy to see that our arguments also hold in the case without $I_4$.

\textit{Proof of item~\ref{item:1}.} The first part follows directly from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:aut_wreath_omega_cat} applied to $\struct{B}'$ and the fact that we take an expansion by relations which are preserved by all bijections, and in particular all automorphisms of $\struct{B}'$. 
    % 
We continue with the second part. 

Suppose that $e^{\ast}$ is an endomorphism of $\blowup{\struct{A}}_{I_4}$, and let $S^{\ast}$ be an arbitrary finite subset of $\mathbb{Q}\times A$.
%
Since $e^{\ast}$ preserves $\neq$, it is injective. Since $e^{\ast}$ preserves $E^{\smash{\blowup{\struct{A}}_{I_4}}}$, which is an equivalence relation, it naturally acts on its classes.
%
Let $e$ be the map on $(\mathbb{Q}\times A)/E^{\smash{\blowup{\struct{A}}_{I_4}}}$ mapping each $[x]_{\smash{E^{\smash{\blowup{\struct{A}}_{I_4}}}}}$ to $[e^{\ast}(x)]_{\smash{E^{\smash{\blowup{\struct{A}}_{I_4}}}}}$, and let $S\coloneqq \{[x]_{E^{\smash{\blowup{\struct{A}}_{I_4}}}} \mid x\in S^{\ast}\}$.
%  
Similarly as in Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:aut_wreath}, we have that $e$ is an endomorphism of $\struct{A}$. 
%
Since $\struct{A}$ is a model-complete core, there exists an automorphism $\alpha$ of $\struct{A}$ such that $\alpha|_S=e|_S$.
% 
We claim that there exists an automorphism ${\alpha}^{\ast}$ of $\blowup{\struct{A}}_{I_4}$ such that ${\alpha}^{\ast}|_{S^{\ast}}=e^{\ast}|_{S^{\ast}}$.
%
To see this, note that we can simply fix a  permutation  of each equivalence class of $E^{\smash{\blowup{\struct{A}}_{I_4}}}$ and extend $\alpha$, which is a permutation of the equivalence classes, according to it.
%
Since $S^{\ast}$ is finite, we can moreover select the permutations so that ${\alpha}^{\ast}$ coincides with $e^{\ast}$ on $S^{\ast}$.

Next, suppose that $e$ is an endomorphism of $\struct{A}$, and let $S$ be an arbitrary finite subset of $A$.
%
Define $S^{\ast}\coloneqq\{0\}\times S$. 
%
Let $e^{\ast}$ be the map on $\mathbb{Q}\times A$ defined via $e^{\ast}(q,a)\coloneqq(q,e(a))$.
%
This function is an endomorphism of $\blowup{\struct{A}}_{I_4}$.   
%
Since $\blowup{\struct{A}}_{I_4}$ is a model-complete core, there exists an automorphism ${\alpha}^{\ast}$ of 
$\blowup{\struct{A}}_{I_4}$ such that ${\alpha}^{\ast}|_{S^{\ast}}=e^{\ast}|_{S^{\ast}}$.
%
Let $\alpha$ be the map on $A$ mapping each $[x]_{E^{\smash{\blowup{\struct{A}}_{I_4}}}}$ to $[e^{\ast}(x)]_{E^{\smash{\blowup{\struct{A}}_{I_4}}}}$
%
As before, we have that  $\alpha$ is a well-defined automorphism of $\struct{A}$ extending $e$ on $S$.

\textit{Proof of item~\ref{item:2}.} Since $\ordblowup{\struct{B}}_{I_4}$ is an expansion of $\struct{B}'$ by two relations that are preserved by all embeddings, we can ignore these relations and only prove the statement for $\struct{B}'$.
%
Recall that $\struct{B}'=(\mathbb{Q};<)\wr\struct{B}$.
%
The first part of~item~\ref{item:2} follows directly from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:wreath_homogeneous} because $(\mathbb{Q};<)$ is homogeneous.
%
We continue with the second part. 
% 
There the backward direction follows directly from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:Ramsey} because $(\mathbb{Q};<)$ is homogeneous Ramsey \cite{kechris2005fraisse}.
%
We continue with the forward direction, which we prove by hand.

Suppose that $\age(\ordblowup{\struct{B}}_{I_4})$ has the RP.
%
Then clearly also $\age(\struct{B}')$ has the RP.
%
Let $\struct{X},\struct{Y}\in \age(\struct{B})$ be arbitrary.
%
We transform them into $\struct{X}',\struct{Y}'\in \age(\struct{B}')$ by letting $E$ interpret as the diagonal relation and $<$ as the empty relation.
%
Since $\age(\struct{B}')$ has the RP, there exists a Ramsey witness $\struct{W}'\in \age(\struct{B}')$ for $(\struct{X}',\struct{Y}')$.
%
Set $\struct{W}\coloneqq (\struct{W}'/E^{\struct{W}'})|^{\sigma}$.
%
Let $f\colon \smash{\binom{\struct{W}}{\struct{X}}} \rightarrow [2]$ be arbitrary.  
%
We define $f'\colon \smash{\binom{\struct{W}'}{\struct{X}'}} \rightarrow [2]$ as follows.
%
For an embedding $e'\in \smash{\binom{\struct{W}'}{\struct{X}'}} $, we set $f'(e')\coloneqq f(q_E\circ e')$, where $q_E$ denotes the factor map $x\mapsto [x]_E$.
%
We have that $q_E\circ e' \in \smash{\binom{\struct{W}}{\struct{X}}}$ because $E$ interprets as the diagonal relation in $\struct{X}'$ and as a relational congruence w.r.t.\ $\sigma$ in $\struct{W}'$.
%
Since $\struct{W}'$  is a Ramsey witness for $(\struct{X}',\struct{Y}')$, there exists $e'\in \smash{\binom{\struct{W}'}{\struct{Y}'}} $ such that $f'$ is constant on  $\bigl\{e'\circ u' \mid  u'\in \smash{\binom{\struct{Y}'}{\struct{X}'}}\bigr\} \subseteq \smash{\binom{\struct{W}'}{\struct{X}'}}$.
% 
Since $E$ interprets as the diagonal relation in %both $\struct{X}'$ and 
$\struct{Y}'$ and as a relational congruence w.r.t.\ $\sigma$ in $\struct{W}'$, the map $e\coloneqq q_E\circ e'$ is contained in  $\smash{\binom{\struct{W}}{\struct{Y}}}$. 
%
By construction, $f$ is constant on  $\bigl\{e\circ u\;|\; u\in \smash{\binom{\struct{Y}}{\struct{X}}}\bigr\} \subseteq \smash{\binom{\struct{W}}{\struct{X}}}$.
 % 

\textit{Proof of item~\ref{item:3}.} Homogeneity follows directly from the previous item. 
%
The finite boundedness can be deduced from Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:finite_boundedness}, and the fact that we take an expansion by relations definable by a Boolean combination of equality atoms.
%
More specifically, as explained in the introduction, up to isomorphism, the finite substructures of a finitely bounded structures are just the finite models of a universal sentence. 
%
By adding new clauses, that define the relations $\neq$ and $I_4$ in terms of equalities, to the universal sentence for $\age(\struct{B}')$, 
we obtain a universal sentence for $\age(\ordblowup{\struct{B}})$.
% 

\textit{Proof of item~\ref{item:4}.}
%
One direction is simple  (and does not use the assumption on the orbit growth), because $\blowup{\struct{A}}$ clearly pp-constructs $\struct{A}$;
%
the pp-construction is given by $\struct{A} = \smash{(\blowup{\struct{A}}/E^{\blowup{\struct{A}}})|^{\tau}}$. Thus, if $\struct{A}$ pp-constructs $\struct{K}_3$, then so does $\blowup{\struct{A}}$. 

For the other direction, we use  a characterization via the pseudo-Siggers identity from~\cite[Theorems~1.3 and~3.4]{barto2019equations}.
%
Suppose that $\struct{A}$ does not pp-construct $\struct{K}_3$.
%
Let $\struct{C}$ be the model-complete core of $\struct{A}$.
%
Since $\struct{A}$ and $\struct{C}$ are homomorphically equivalent, $\struct{C}$ also does not pp-construct 
$\struct{K}_3$.
%
Then, by Theorem~1.3 in~\cite{barto2019equations}, there exist $\alpha,\beta,s\in \Pol(\struct{C})$ witnessing the pseudo-Siggers identity. 
%
Consider the structure $\blowup{\struct{C}}$.
%
By item~\ref{item:1}, $\blowup{\struct{C}}$ is an $\omega$-categorical model-complete core.
%
Note that we can lift the homomorphic equivalence between $\struct{A}$ and $\struct{C}$ to a homomorphic equivalence between $\blowup{\struct{A}}$ and $\blowup{\struct{C}}$ by setting, for any homomorphism $h$ between $\struct{A}$ and $\struct{C}$ and irrespectively of its direction, $h^{\ast}(x,y)\coloneqq (e(x,y),h(y))$, where $e$ is an arbitrary injection from the Cartesian product of $\mathbb{Q}$ with the domain of $h$ into $\mathbb{Q}$.
%
The inclusion of the injection in the first coordinate ensures that $h^{\ast}$ preserves $I_4$ and $\neq$ (because they are preserved by all injective operations).
%
Since $\blowup{\struct{A}}$ and $\blowup{\struct{C}}$ are homomorphically equivalent, $\blowup{\struct{C}}$ is the model-complete core of $\blowup{\struct{A}}$.
%
Next, we lift the pseudo-Siggers identity from $\Pol(\struct{C})$ to $\Pol(\blowup{\struct{C}})$.
%  
Let $e$ be an arbitrary injection from $\mathbb{Q}\times C$ into $\mathbb{Q}$.
%
The structure $(\mathbb{Q};\neq, I_4)$ is an $\omega$-categorical model-complete core that does not pp-construct  $\struct{K}_3$~\cite[Theorems~12.0.1,~12.7.3,~12.9.2, and Corollary~6.4.4]{bodirsky2021complexity}. 
%
Hence, by Theorem~1.3 in~\cite{barto2019equations} (since pp-constructions are more general than pp-interpretations with parameters), there are  $\alpha',\beta',s'\in \Pol(\mathbb{Q};\neq, I_4)$ witnessing the pseudo-Siggers identity.
%
We set 
% 
%
\begin{align*}
    \alpha^{\ast}(x,y)\coloneqq \ & (\alpha'(x),\alpha(y)), \\ 
    \beta^{\ast}(x,y)\coloneqq \ & (\beta'(x),\beta(y)), \\
    s^{\ast}((x_1,y_1),\dots, (x_6,y_6))\coloneqq \ & (s'(e(x_1,y_1),\dots, e(x_6,y_6)),s(y_1,\dots, y_6)).
\end{align*} 
%
It is easy to verify that $\alpha^{\ast},\beta^{\ast},s^{\ast}\in \Pol(\blowup{\struct{C}})$ and that these operations witness the pseudo-Siggers identity.
%
It can be seen in the proof of Proposition~\ref{prop:basic_properties_wreath_products}\eqref{item:aut_wreath_omega_cat} that also the structure $\blowup{\struct{A}}_{I_4}$ has less than double exponential orbit growth, and therefore so does its model-complete core $\blowup{\struct{C}}$ by the proof of \cite[Corollary 1.8]{barto2019equations}. 
%
Combining this with the pseudo-Siggers identity, it follows from Theorem~3.4 in~\cite{barto2019equations} (whose item~(ii) is equivalent to the pp-construction of $\struct{K}_3$ by Theorem~1.8 in~\cite{barto2018wonderland}) that $\blowup{\struct{A}}_{I_4}$ does not pp-construct $\struct{K}_3$.
%  
\end{proof} 
 

\subsection{A proof of Corollary~\ref{cor:binaryInj}}

\binaryInj*

\begin{proof} 
%
Suppose that $\struct{A}$ does not pp-construct $\struct{K}_3$.
%
By Theorem~\ref{thm:polinjective}\eqref{item:4}, the structure $\blowup{\struct{A}}_{I_4}$ does not pp-construct $\struct{K}_3$ either.
%
Let $\struct{C}$ be the model-complete core of $\struct{A}$.
%
By the proof of Theorem~\ref{thm:polinjective}\eqref{item:4}, $\blowup{\struct{C}}_{I_4}$ is the model-complete core of $\blowup{\struct{A}}_{I_4}$.
%
Hence, also $\blowup{\struct{C}}_{I_4}$ does not pp-construct $\struct{K}_3$.
% 
By \cite[Theorem 3.14]{MarimonPinsker23}, $\Pol(\blowup{\struct{C}}_{I_4})$ contains a binary essential operation $f$.    
%
Let $g$ and $h$ be any homomorphisms witnessing the homomorphic equivalence between $\blowup{\struct{A}}_{I_4}$ and $\blowup{\struct{C}}_{I_4}$. 
%
Then $(x,y) \mapsto g \circ f(h(x),h(y))$ is a binary essential polymorphism of 
$\blowup{\struct{C}}_{I_4}$.
%
Since $\blowup{\struct{C}}_{I_4}$ is Pol-injective, this operation must be injective. 
\end{proof}

 
\section{\texorpdfstring{$\omega$}{omega}-categorical sandwiches for PCSPs}

\subsection{A proof of Proposition~\ref{prop:basic_properties_full_powers}}
For an operation $f\colon A^n \rightarrow A$, we denote the component-wise action of $f$ on $d$-tuples by $f\acts A^d$. For a set $F$ of operations on $A$, we denote by $F\acts A^d$ the set $\{f\acts A^d \mid  f\in F\}$. 
\fullpower*

    \begin{proof} For $i\in [d]$, we denote by $\iota_i$ the function from $[1]$ to $[d]$ defined by $\iota_i(1)\coloneqq i$.

        For~\eqref{item:fpwrpolequal}, let $f\in  \Pol(\fpwr{\struct{A}}{d})$ be arbitrary, and let $n$ be its arity.
        %
        In what follows, we shall use the abbreviation $\bar{a}=(a_1,\dots,a_n)$.
        %
        If $\bar{a}$ appears as the $i$-th row of $(\bar{x}_1,\dots,\bar{x}_n)\in (A^d)^n$ (viewed as a $d\times n$-matrix) and the $j$-th row in $(\bar{y}_1,\dots,\bar{y}_n)\in (A^d)^n$, then, since $f$ preserves $S^{\fpwr{\struct{A}}{d}}_{\iota_i,\iota_j}$, the $i$-th entry of $f(\bar{x}_1,\dots,\bar{x}_n)$ equals the $j$-th entry of $f(\bar{y}_1,\dots,\bar{y}_n)$.
        %
        This ensures that there exists a well-defined operation $f'\colon A^n\to A$ such that $f=f'\acts A^d$.
        %
        The definition of $R^{\fpwr{\struct{A}}{d}}_{\mathrm{id}}$ for every $k$-ary relation $R^\struct{A}$, where $\mathrm{id}$ is the identity map on $[k]$, guarantees that $f'\in \Pol(\struct{A})$.
        %
        Thus, $\Pol(\fpwr{\struct{A}}{d})\subseteq\Pol(\struct{A})\acts A^d$. 
        %
        The other inclusion is trivial.
        
        For~\eqref{item:fpwrppconstr}, we proceed as in the proof of \cite[Lemma~3.5.4]{bodirsky2021complexity}; the identity map yields a $d$-dimensional pp-interpretation of $\fpwr{\struct{A}}{d}$ in $\struct{A}$ and the first projection gives a 1-dimensional pp-interpretation of $\struct{A}$ in $\fpwr{\struct{A}}{d}.$
        
        For~\eqref{item:fpwromegacat}, note that $\Aut(\fpwr{\struct{A}}{d})=\Aut(\struct{A})\acts A^d$ by item~\eqref{item:fpwrpolequal}.
        %
        Since every $n$-orbit in $\fpwr{\struct{A}}{d}$ corresponds to a $dn$-orbit in $\struct{A}$, there are finitely many $n$-orbits in $\fpwr{\struct{A}}{d}$ for each $n\in \mathbb{N}$. 
        %
        Hence, $\fpwr{\struct{A}}{d}$ is $\omega$-categorical as well.
        
        For~\eqref{item:fpwrhomog}, let $\alpha:\struct{D}_1\to\struct{D}_2$ be an isomorphism between two finite substructures of $\fpwr{\struct{A}}{d}$ and let $A_1,A_2$ be the sets of elements of $A$ appearing as entries in some $d_1\in D_1$ or $d_2\in D_2$, respectively.
        %
        Then the relations $S^{\fpwr{\struct{A}}{d}}_{\iota_i,\iota_j}$ and $\widehat{R}^{\,\fpwr{\struct{A}}{d}}$ for $R\in\tau$ guarantee that $\alpha$ induces an isomorphism $\beta$ between $\struct{A}_1$ and $\struct{A}_2$.
        %
        Since $\struct{A}$ is homogeneous, we can extend $\beta$ to some automorphism $\beta^\ast$ of $\struct{A}$.
        %
        Now $\alpha^\ast\coloneqq\beta^\ast\acts A^d$ is an automorphism of $\fpwr{\struct{A}}{d}$ extending $\alpha$.
        
        For~\eqref{item:fpwrmodcompl}, let $e\in \End(\fpwr{\struct{A}}{d})$ be arbitrary and let $D$ be an arbitrary finite subset of $A^d$.
        %
        Define $A_D$ as the set of all elements of $A$ appearing in an entry of some $d\in D$.
        %
        By item~\eqref{item:fpwrpolequal}, we have $e=e'\acts A^d$ for some $e'\in\End(\struct{A})$.
        %
        Since $\struct{A}$ is a model-complete core, there exists $\alpha'\in\Aut(\struct{A})$ such that $\alpha'|_{A_D}=e'|_{A_D}$.
        %
        Then $\alpha\coloneqq\alpha'\acts A^d$ is an automorphism of $\fpwr{\struct{A}}{d}$ satisfying $\alpha|_{D}=e|_{D}$. 
        
        Item~\eqref{item:fpwrfinbou} can be shown in a similar fashion as \cite[Lemma~3.5.4]{bodirsky2021complexity}.
        
        For~\eqref{item:fpwrramsey}, note that, by item~\eqref{item:fpwrhomog}, the mapping $\alpha \mapsto \alpha \acts A^d$ is a topological isomorphism from $\Aut(\struct{A})$ to $\Aut(\fpwr{\struct{A}}{d})$. 
        %
        By Theorem~\ref{thm:kpt}, we have that $\fpwr{\struct{A}}{d}$ is homogeneous Ramsey.
        
        Item~\eqref{item:fpwrreduct} follows directly from the definition of $\fpwr{\struct{A}}{d}$.
    \end{proof} 
 
 

 


\subsection{A full proof of Proposition~\ref{prop:sandwiches}}

\sandwiches*

We split the proof of Proposition~\ref{prop:sandwiches} into several individual statements, which are either independent or build on top of each other (in the order in which they are presented).

We start with the following lemma, a crucial independent observation about pseudo-cyclic polymorphisms from finite substructures of $\struct{A}$ to $\struct{A}$ itself.

\begin{restatable}{lemma}{pseudocyclic} \label{lemma:pseudocyclic}  
 Let $\struct{A}$ be a reduct of a linearly ordered finitely bounded homogeneous structure $\struct{B}$ and let $\struct{S}$ be a finite substructure of $\struct{A}$. If $f\in \Pol(\struct{S},\struct{A})$ is pseudo-cyclic modulo $\Aut(\struct{B})$, then $f$ is cyclic.
 \end{restatable}   
 
    \begin{proof}
        Let $n$ be the arity of $f$ and let $\alpha_1,\alpha_2\in \Aut(\struct{B})$ be such that 
        %
        \begin{align*}
            \alpha_1\circ f(s_1,\dots,s_n)=\alpha_2\circ f(s_2,\dots,s_n,s_1) 
        \end{align*}
        %
        for all $s_1,\dots, s_n\in S$.
        %
        Suppose, on the contrary, that $f$ is not cyclic. 
        %
        Then there are $s_1,\dots,s_n\in S$ such that $f(s_1,\dots,s_n)\neq f(s_2,\dots,s_n,s_1)$. 
        %
        Let $<$ denote the linear order of $\struct{B}$ and set $\Tilde{s_i} \coloneqq (s_i,\dots,s_n,s_1,\dots,s_{i-1})$.
        %
        By assumption, we have $f(\Tilde{s_1})\neq f(\Tilde{s_2})$.
        %
        Without loss of generality, $f(\Tilde{s_1})<f(\Tilde{s_2})$. 
        %
        Since $\alpha_1,\alpha_2$ preserve $<$ and its complement, we have 
        %
        \begin{align*}
            f(\Tilde{s_1})<f(\Tilde{s_2})\Leftrightarrow&\enspace\alpha_1(f(\Tilde{s_1}))<\alpha_1(f(\Tilde{s_2}))\\
            \Leftrightarrow&\enspace\alpha_2(f(\Tilde{s_2}))<\alpha_2(f(\Tilde{s_3}))\\
            \Leftrightarrow&\enspace f(\Tilde{s_2})<f(\Tilde{s_3})\\
           \vdots \  &  \\
            \Leftrightarrow&\enspace f(\Tilde{s_n})<f(\Tilde{s_1}),
        \end{align*}
        a contradiction. Thus, $f$ is cyclic.
    \end{proof} 


The next lemma can be proved using a standard compactness argument.
%

\begin{restatable}{lemma}{karaslemma} \label{lem:christoph_lemma} 
Let $\struct{A}$ be an $\omega$-categorical structure and $R$ a finitary relation over $A$. If $\Pol(\struct{A})$ preserves $R$, then, for every $n\in \mathbb{N}$, there exists a finite substructure $\struct{S}$ of $\struct{A}$ with $|S|\geq n$ such that $\Pol(\struct{S},\struct{A})$ preserves $R$.  
 \end{restatable}  
 %
\begin{proof} We need the following strengthening of~\cite[Lemma~10]{ComplOfTempCSPs} tailored to our statement.
%
\begin{claim} \label{claim:kara_plus}
If $R$ is a union of $\ell$-many $\Aut(\struct{A})$-orbits for some $\ell\in\mathbb{N}$ and there exists $g\in \Pol(\struct{S},\struct{A})$ that does not preserve $R$ for a finite substructure $\struct{S}$ of $\struct{A}$, then there exists an $\ell$-ary $g'\in\Pol(\struct{S},\struct{A})$ that does not preserve $R$.
\end{claim}
% 
\begin{claimproof} 
    By assumption, there exist  $\bar{t}_1,\dots,\bar{t}_m\in R$ such that $g(\bar{t}_1,\dots,\bar{t}_m)\notin R$. 
    %
    First, suppose that $m\leq \ell$.
    %
    Define the $\ell$-ary operation $g'$ by $g'(x_1,\dots,x_{\ell}) \coloneqq g(x_1,\dots,x_m)$. 
    %
    Clearly, $g' \in \Pol(\struct{S},\struct{A})$, and $g'(\bar{t}_1,\dots,\bar{t}_m,\bar{t}_m,\dots,\bar{t}_m)=g(\bar{t}_1,\dots,\bar{t}_m)\notin R$.
    %
      Next, suppose that $\ell \leq m$.
        %
        Since $R$ is the union of $\ell$ orbits, we can pick $\ell$ representatives $\bar{t}_{i_1},\dots,\bar{t}_{i_{\ell}}$ of said orbits among $\bar{t}_1,\dots,\bar{t}_m$. 
        %
        Without loss of generality, we may assume that $i_j=j$ for every $j\leq \ell $. 
        %
        Then, for every $\ell +1\leq i\leq m$, there exists $j_i\leq \ell$ and $\alpha_i\in\Aut(\struct{A})$ such that $\bar{t}_i=\alpha_i(\bar{t}_{j_i})$.
        %
        Define the $\ell$-ary  operation $g'$ by 
        \begin{align*}
            g'(x_1,\dots,x_{\ell}) \coloneqq g(x_1,\dots,x_{\ell},\alpha_{\ell +1}(x_{j_{\ell +1}}),\dots,\alpha_m(x_{j_m})).
        \end{align*}
        Then $g'\in\Pol(\struct{S},\struct{A})$ and $g'$ does not preserve $R$ as witnessed by the tuple $\bar{t}_1,\dots,\bar{t}_{\ell}$. 
\end{claimproof}
%
Now we prove the statement of the lemma.
%
    Since $\struct{A}$ is $\omega$-categorical, $R$ is a union of $\ell$ orbits for some $\ell \in \mathbb{N}$.
    %
    Suppose, on the contrary, that there exists $n\in\mathbb{N}$ such that, for every finite substructure $\struct{S}$ of $\struct{A}$ with $|S|\geq n$, there exists $f_S \in \Pol(\struct{S},\struct{A})$ that does not preserve $R$.
    %
    Then, by Claim~\ref{claim:kara_plus}, for every $\struct{S}$ with $|S|\geq n$ there also exists an $\ell $-ary $f'_S\in\Pol(\struct{S},\struct{A})$ that does not preserve $R$. By a standard compactness argument (an application of K\H{o}nig's Tree Lemma), there is an $\ell $-ary polymorphism of $\struct{A}$ that does not preserve $R$, a contradiction.
\end{proof}

The next lemma essentially states that $\mathcal{I}(\struct{X})\coloneqq \fpwr{\struct{X}}{d}$ is a reduction from $\CSP(\struct{A})$ to $\CSP(\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$. 
 %
 We will, however, use it in the more general setting of PCSPs.

 

\begin{restatable}{lemma}{liftpol}\label{lemma:liftpol} 
Let $\struct{A}$ be a reduct of a finitely bounded homogeneous structure $\struct{B}$. 
%
Suppose that the bounds of $\struct{B}$ have size $\leq d$ and its relations
are of arity $\leq d-1$.  
%
Then, for every finite structure $\struct{X}$ and every homomorphism $h\colon \fpwr{\struct{X}}{d}\to\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}$, there exists a homomorphism $g\colon\struct{X}\to\struct{A}$ such that $h(\bar{x})=g(\bar{x})_{\orbeq{\Aut(\struct{B})}}$ for every $\bar{x}\in X^d$. 
% 
 \end{restatable}  

\begin{proof} 
        Let $h$ and $\struct{X}$ be as in the statement of the lemma. 
        
        First, we define an auxiliary structure $\struct{X}'$ on $X$ with the same signature as $\struct{X}$.
        %
        For every $k$-ary relation $R^{\struct{B}}$ of $\struct{B}$, the relation $R^{\struct{X}'}$ is defined as follows:
        %
        \begin{align}
              R^{\struct{X}'} \coloneqq \{   (x_{\iota(1)},\dots,x_{\iota(k)})  \in X^k \mid    & \text{ there exists }   \iota\colon [k]\to[d] \text{ and }   (x_1,\dots,x_d)\in X^d   \nonumber \\    & \text{ such that  }h (x_1,\dots,x_d)\in R_\iota^{\smash{\fpwr{\struct{B}}{d}_{\orbeq{\Aut(\struct{B})}}}}\}.  \label{eq:exists}
        \end{align}  
        %
        By the definition of full powers, for every $\iota\colon [k]\to[d]$, we have 
        %
        \begin{align*}
             \big((x_{\iota(1)},\dots,x_{\iota(k)},y_{k+1}\dots,y_d),(x_{1}\dots,x_{k},x_{k+1}\dots,x_{d})\big)\in S^{\fpwr{\struct{X}}{d}}_{\mathrm{id},\iota},
        \end{align*}
        %
        where $\mathrm{id}$ denotes the identity map on $[k]$. 
        %
        Thus, and since $h$ is a homomorphism, we have
        %
        \begin{align}
            R^{\struct{X}'} = \{ (x_1,\dots,x_k)\in X^k \mid   h(x_1,\dots,x_d)       \in R_{\mathrm{id}}^{\ \smash{\fpwr{\struct{B}}{d}_{\orbeq{\Aut(\struct{B})}}}}   \text{ for all }   x_{k+1},\dots,x_d\in X  \}.  \label{eq:forall}
        \end{align} 
        
        Next, we define an auxiliary equivalence relation $\sim$ on $X$ by 
        %
        \begin{align*}
            x\sim y :\Leftrightarrow \ & \exists   \bar{z}=(z_1,\dots, z_d)\in X^d\,\exists i_1,i_2 \in [d]   \\ & \textnormal{ with } x=z_{i_1},y=z_{i_2}, \textnormal{ and }\forall\bar{a}=(a_1,\dots, a_d)\in h(\bar{z})\colon  a_{i_1}=a_{i_2}.
        \end{align*}
        %
        Here, the containment $\bar{a} \in h(\bar{z})$ is to be understood in the sense that $h(\bar{z})$ represents the orbit of a $d$-tuple.
        %
        Note that, since $h$ preserves $S_{\iota,\iota'}$  for all $\iota,\iota'\colon [2]\to[d]$, this is equivalent to
        %
        \begin{align}
            x\sim y  \Leftrightarrow \ & \forall \bar{z}=(z_1,\dots, z_d)\in X^d\, \forall i_1,i_2 \in [d]\colon \nonumber \\ & x=z_{i_1} \text{ and } y=z_{i_2} \text{ implies } \forall\bar{a}=(a_1,\dots, a_d)\in h(\bar{z})\colon  a_{i_1}=a_{i_2}. \label{eq:reformulation} 
        \end{align}
        %
        \begin{claim} \label{claim:congruence}
            $\sim$ is a relational congruence on $\struct{X}'$ w.r.t.\ all its relations.
        \end{claim}
        %
        \begin{claimproof}
            We must show that, for every $k$-ary relation $R^{\struct{X}'}$, every $i\in [k]$, and all $ y_1,\dots,y_{i-1},$ $y_{i+1},\dots,y_k,$ $x_1,x_2\in X$: if  $x_1 \sim x_2$, then
        %
         \begin{align*}
             R^{\struct{X}'}(y_1,\dots,y_{i-1},x_1,y_{i+1},\dots,y_k)\Leftrightarrow R^{\struct{X}'}(y_1,\dots,y_{i-1},x_2,y_{i+1},\dots,y_k) .
         \end{align*}
         %
        To this end, define  
        \begin{align*}
            & \bar{y_1}  \coloneqq (y_1,\dots,y_{i-1},x_1,y_{i+1},\dots,y_k),  \quad\bar{z_1}  \coloneqq (y_1,\dots,y_{i-1},x_1,y_{i+1},\dots,y_k,x_2,\dots,x_2), \\ 
            &  \bar{y_2}  \coloneqq (y_1,\dots,y_{i-1},x_2,y_{i+1},\dots,y_k), \quad   
            \bar{z_2}  \coloneqq (y_1,\dots,y_{i-1},x_2,y_{i+1},\dots,y_k,x_1,\dots,x_1).  
        \end{align*}
        %
        Here, the arity of the tuples $\bar{z}_1, \bar{z}_2$ is $d$.
        %
        As before, we denote by $\mathrm{id}$ the identity map on $[k]$.
        %
        Additionally, by $(i\mapsto k+1)$, we denote the map from $[k]$ to $[d]$ sending $i$ to $k+1$ and fixing all other elements.
        %
        This map is well-defined since all relations are of arity $\leq d-1$.
        %
        By eq.~\eqref{eq:reformulation}, for all $\bar{a}=(a_1,\dots, a_d)\in h(\bar{z}_1)\cup h(\bar{z}_2)$, we have  $a_i=a_{k+1}$. 
        %
        Hence:
        %
        \begin{align*}
           \bar{y_1} \in  R^{\struct{X}'} &  \overset{\eqref{eq:exists}\&\eqref{eq:forall}}{\Longleftrightarrow}  h(\bar{z_1}) \in 
              R_{\mathrm{id}}^{\, \smash{\fpwr{\struct{B}}{d}_{\orbeq{\Aut(\struct{B})}}}} \\
            & \ \overset{\text{def.}}{\Longleftrightarrow} \ \exists \bar{a} \in h(\bar{z_1}) \cap R_{\mathrm{id}}^{\fpwr{\struct{B}}{d}}  \\
            & \ \overset{\text{def.}}{\Longleftrightarrow} \ \exists \bar{a}\in h(\bar{z_1}) \cap R_{(i\mapsto k+1)}^{\fpwr{\struct{B}}{d}} \\
            & \ \overset{\text{def.}}{\Longleftrightarrow} \ h(\bar{z_1}) \in R_{(i\mapsto k+1)}^{\fpwr{\struct{B}}{d}_{\orbeq{\Aut(\struct{B})}}}  
            \\
            & \quad \    \vdots  
            \\
            &  \ \overset{\text{def.}}{\Longleftrightarrow} \ h(\bar{z_2}) \in R_{\mathrm{id}}^{\, \smash{\fpwr{\struct{B}}{d}_{\orbeq{\Aut(\struct{B})}}}} \\
            & \overset{\eqref{eq:exists}\&\eqref{eq:forall}}{\Longleftrightarrow} \bar{y_2}\in  R^{\struct{X}'}.   
        \end{align*}
        This is what we had to show.
        \end{claimproof}  

     Finally, we combine the two auxiliary constructions from before by setting $\Tilde{\struct{X}} \coloneqq \struct{X}' /{\sim}$.
  
        \begin{claim} \label{claim:embedding} $\Tilde{\struct{X}}$ embeds into $\struct{B}$.
        \end{claim} 
        %
        \begin{claimproof}
        Suppose, on the contrary, that this is not the case.
        %
        Then there is some bound $\struct{F}$ of $\struct{B}$ that embeds into $\Tilde{\struct{X}}$.
        %
        Without loss of generality, $F=\{[x_1]_\sim,\dots,[x_n]_\sim\}\subseteq \Tilde{X}$.
        %
        Since all bounds have size $\leq d$, we have $n\leq d$.
        %
        As before, we shall use the abbreviations $\bar{x}\coloneqq(x_1,\dots, x_d)$ and $\bar{a}\coloneqq(a_1,\dots, a_d)$.
        %
        Now, for every $k$-ary relation $R^{\Tilde{\struct{X}}}$ and every $\iota\colon [k]\to[n]$, we have  
        %
        \begin{align*}
            ([x_{\iota(1)}]_\sim,\dots,[x_{\iota(k)}]_\sim)\in R^{\Tilde{\struct{X}}}  &\Leftrightarrow \exists x_1'\in[x_{\iota(1)}]_\sim,\dots,x_k'\in[x_{\iota(k)}]_\sim \text{ s.t.\ }
 (x_1',\dots,x_k') \in R^{\struct{X}'} \\
            &\Leftrightarrow (x_{\iota(1)},\dots,x_{\iota(k)}) \in R^{\struct{X}'} \\
            &\Leftrightarrow \forall x_{n+1},\dots,x_d\in X\colon    h(\bar{x}) \in R_{\iota}^{\smash{\fpwr{\struct{B}}{d}_{\orbeq{\Aut(\struct{B})}}}} \\
            &\Leftrightarrow \forall x_{n+1},\dots,x_d\in X\,\forall \bar{a} \in h(\bar{x})\colon \bar{a} \in  R_{\iota}^{\fpwr{\struct{B}}{d}} \\
            &\Leftrightarrow \forall x_{n+1},\dots,x_d\in X\,\forall \bar{a}\in h(\bar{x})\colon  (a_{\iota(1)},\dots,a_{\iota(k)}) \in R^{\struct{B}}.
        \end{align*}
        %
        By fixing some $x_{n+1},\dots,x_d\in X$ and setting $e([x_i]_\sim) \coloneqq a_i$ for $i\leq n$ and some $\bar{a}\in h(\bar{x})$, we have that $e$ is an embedding of $\struct{F}$ into $\struct{B}$, a contradiction.
        \end{claimproof}
         
        Let $e'$ be an embedding from $\Tilde{\struct{X}}$ to $\struct{B}$, which exists by Claim~\ref{claim:embedding}.
        %
        It follows from Claim~\ref{claim:congruence} that $e'$ induces a homomorphism $g\colon \struct{X}'\to\struct{B}$ via $g(x) \coloneqq e'([x]_\sim)$.
        %
        \begin{claim} \label{claim:orbits}
            $h(\bar{x})=g(\bar{x})_{\orbeq{\Aut(\struct{B})}}$ for every $\bar{x}\in X^d$.
        \end{claim}
        %
        \begin{claimproof}
         Let $i,j\in [d]$ be arbitrary. 
          %
          If every $\bar{y} \in h(\bar{x})$ satisfies $y_i=y_j$, then $x_i\sim x_j$ and thus $g(x_i)=g(x_j)$.
          %
          On the other hand, if $g(x_i)=g(x_j)$, then $x_i\sim x_j$ since $e'$ is an embedding.
          %
          Thus, every $\bar{y} \in h(\bar{x})$ satisfies $y_i=y_j$.
          %
          Moreover, for all $x_1,\dots,x_d\in X$, every $k$-ary relation $R^{\struct{X}'}$, and every $\iota\colon [k]\to[d]$, we have
        \begin{align*}
            h(\bar{x}) \in R_{\iota}^{\smash{\fpwr{\struct{B}}{d}_{\orbeq{\Aut(\struct{B})}}}} &\Leftrightarrow (x_{\iota(1)},\dots,x_{\iota(k)}) \in R^{\struct{X}'} \\
            &\Leftrightarrow ([x_{\iota(1)}]_\sim,\dots,[x_{\iota(k)}]_\sim) \in R^{\Tilde{\struct{X}}} \\
            &\Leftrightarrow (g(x_{\iota(1)}),\dots, g(x_{\iota(k)})) \in R^{\struct{B}} \\
            &\Leftrightarrow (g(x_1),\dots, g(x_d))_{\orbeq{\Aut(\struct{B})}} \in R_{\iota}^{\smash{\fpwr{\struct{B}}{d}_{\orbeq{\Aut(\struct{B})}}}}. 
        \end{align*}
        %
        Now the statement of the claim follows from the homogeneity of $\struct{B}$.
        \end{claimproof} 

      

       \begin{claim}
           $g$ is a homomorphism from $\struct{X}$ to $\struct{A}$.
       \end{claim}
        %
        \begin{claimproof}
            Let $R\in \tau$ and $(x_1,\dots,x_k)\in R^\struct{X}$ be arbitrary.
        %
        Since $h$ is a homomorphism, we have $ h(x_1,\dots,x_d) \in R_{\mathrm{id}}^{\,\smash{\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}}} $ for all $x_{k+1},\dots,x_d\in X$. 
        %
        Since every automorphism of $\struct{B}$ is also an automorphism of $\struct{A}$, if follows from Claim~\ref{claim:orbits} that $(g(x_1),\dots,g(x_k))\in R^{\struct{A}} $.
        \end{claimproof} 
         This finishes the proof of the lemma.
    \end{proof}


 

\begin{restatable}{lemma}{liftidentity} \label{lemma:liftidentity} 
    Let $\struct{A}$ be a reduct of a finitely bounded homogeneous structure $\struct{B}$ and let $\struct{S}$ be a finite substructure of $\struct{A}$. 
    %
    Suppose that the bounds of $\struct{B}$ have size $\leq d$ and its relations
are of arity $\leq d-1$.
    %
    If $\Sigma$ is a height-1 condition that is satisfied in $\Pol(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$, then $\Sigma$ is satisfiable in $\Pol(\struct{S},\struct{A})$ modulo $\Aut(\struct{B})$.
 \end{restatable} 
 
    \begin{proof}  
    %
    It is not hard to show that $\fpwr{(\struct{S}^n)}{d} \simeq (\fpwr{\struct{S}}{d})^n$ (cf.~\cite[Corollary 22]{Mottet_2025}) for all $d,n\in \mathbb{N}$.
        %
        Hence, every homomorphism $h\colon (\fpwr{\struct{S}}{d})^{n}\to \fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}$ is also a homomorphism from $\fpwr{(\struct{S}^{n})}{d}$ to $\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}$.
        %
        Suppose that $h$ is a function symbol appearing in $\Sigma$ that is assigned an element of $\Pol(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$. 
        %
        By Lemma \ref{lemma:liftpol}, there is a homomorphism $g\colon \struct{S}^{n}\to \struct{A}$ such that 
        %
        \begin{align*}
            h\begin{pmatrix}\bar{s_1} \\\vdots\\\bar{s_d}\end{pmatrix}=\begin{pmatrix}g(\bar{s_1})\\\vdots\\g(\bar{s_d}) \end{pmatrix}_{\orbeq{\Aut(\struct{B})}}   
        \end{align*}
        %
        for all $\bar{s_1},\dots,\bar{s_d} \in S^{n}$.
        %
        For each function symbol in $\Sigma$, we fix such a homomorphism. 
        %
        Suppose now that $h_1,h_2\in  \Pol(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$ witness the satisfaction of the identity 
        %
        \begin{align*}
            h_1(x_{i_1},\dots,x_{i_{n}})\approx h_2(x_{i_{n+1}},\dots,x_{i_{n+k}}),
        \end{align*}
        %
        where $i_\ell\leq m$ for some $m\in\mathbb{N}$, and let $g_1:\struct{S}^{n}\to \struct{A}$ and $g_2:\struct{S}^{k}\to \struct{A}$ be the associated homomorphisms.
        
        
        
        Let $\bar{s}_1,\dots,\bar{s}_{m}$ be arbitrary tuples over $S$ of arity $k$ large enough so that, for every  $\bar{s}\in S^{m}$, there exists $\ell \in [k]$ such that $\bar{s}$ equals the $\ell$-th entry in $(\bar{s}_1,\dots,\bar{s}_{m})$ (viewed as a $k\times m$-matrix).
        %  
        Define the $m$-ary operations $\Tilde{g_1}$ and $\Tilde{g_2}$ by  $\Tilde{g_1}(x_1,\dots,x_m) \coloneqq g_1(x_{i_1},\dots,x_{i_n})$ and  $\Tilde{g_2}(x_1,\dots,x_m) \coloneqq g_2(x_{i_{n+1}},\dots,x_{i_{n+k}})$. 
        %
        Then the tuples $\Tilde{g_1}(\bar{s}_1,\dots,\bar{s}_{m})$ and $\Tilde{g_2}(\bar{s}_1,\dots,\bar{s}_m)$ satisfy the same equalities and relations w.r.t.~$\struct{B}$ on all $d$-tuples.
        %
        Since all relations of $\struct{B}$ have arity $\leq d$ and $\struct{B}$ is homogeneous, $\Tilde{g_1}(\bar{s}_1,\dots,\bar{s}_{m})$ and $\Tilde{g_2}(\bar{s}_1,\dots,\bar{s}_m)$ lie in the same orbit.
        %
        Thus, there are $\alpha_1,\alpha_2\in\Aut(\struct{B})$ such that
        \begin{align*}
            \alpha_1\circ\Tilde{g_1}(\bar{s}_1,\dots,\bar{s}_{m})=\alpha_2\circ\Tilde{g_2}(\bar{s}_1,\dots,\bar{s}_{m}).
        \end{align*}
        This is equivalent to
        \begin{align*}
            \alpha_1\circ g_1(s_{i_1},\dots,s_{i_n})=\alpha_2\circ g_2(s_{i_{n+1}},\dots,s_{i_{n+k}})
        \end{align*}
        for all $s_1,\dots,s_{m}\in S$. Thus, $\Sigma$ is satisfied in $\Pol(\struct{S},\struct{A})$ modulo $\Aut(\struct{B})$. 
    \end{proof} 

Now we can finally prove Proposition~\ref{prop:sandwiches}.
%
\begin{proof}[Proof of Proposition~\ref{prop:sandwiches}] Clearly, for every finite substructure $\struct{S}$ of $\struct{A}$, we have $ \fpwr{\struct{S}}{d}  \rightarrow \fpwr{\struct{A}}{d} \rightarrow \fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}$.
%
We show that there exists a finite substructure $\struct{S}$ of $\struct{A}$ such that $\PCSP(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$ is not finitely tractable.
%
Since $\struct{A}$ is $\omega$-categorical, Lemma~\ref{lem:christoph_lemma} guarantees the existence of some finite substructure $\struct{S}$ of $\struct{A}$ with $|S|\geq 3$ such that $\Pol(\struct{S},\struct{A})$ preserves $\neq$. 
%
Suppose that there is a finite sandwich $\struct{D}$ of $\smash{(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})}$ that does not pp-construct $\struct{K}_3$. 
%
Then, by Theorem \ref{thm:barto12}, there exists a cyclic operation $f$ in $\Pol(\struct{D})$ of some arity $n$. 
%
Take any homomorphisms $g\colon \fpwr{\struct{S}}{d} \rightarrow \struct{D}$ and $h\colon \struct{D} \rightarrow \fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}$. 
%
Then, by setting 
%
$
    f'(x_1,\dots,x_n) \coloneqq h\circ f(g(x_1),\dots,g(x_n)),
$
%
we get a cyclic $n$-ary $f'\in \Pol(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}}).$ By Lemma~\ref{lemma:liftidentity} there is some $n$-ary $g\in\Pol(\struct{S},\struct{A})$ that is pseudo-cyclic modulo $\Aut(\struct{B})$. 
%
By Lemma~\ref{lemma:pseudocyclic}, this operation is cyclic. Take pairwise distinct elements $s_1,s_2,s_3\in S$. 
%
We now show that the cyclicity of $g$ contradicts the fact that it preserves $\neq$. 
%
To this end, we consider the following three cases:

\begin{description}
    \item[$n\equiv 0  \bmod 3$]
    \[
    g(s_1,s_2,s_3,\dots,s_1,s_2,s_3) = g(s_2,s_3,s_1,\dots,s_2,s_3,s_1)
    \]
    \item[$n\equiv 1  \bmod 3$] 
    \[
    g(s_1,s_2,s_3,\dots,s_1,s_2,s_3,s_1) = g(s_3,s_1,s_2,\dots,s_3,s_1,s_1,s_2)
    \]
    \item[$n\equiv 2  \bmod 3$] 
    \[
    g(s_1,s_2,s_3,\dots,s_1,s_2,s_3,s_1,s_2) = g(s_2,s_3,s_1,\dots,s_2,s_3,s_1,s_2,s_1)
    \]
\end{description} 
%
In all three cases, $g$ does not preserve $\neq$.
%
 Hence, the original assumption that such $\struct{D}$ exists was wrong, and consequently $\PCSP(\fpwr{\struct{S}}{d},\fpwr{\struct{A}}{d}_{\orbeq{\Aut(\struct{B})}})$ is not finitely tractable.
\end{proof} 
 
\section{Why numeric algorithms fail: full explanation}  

 In this section, we provide a detailed explanation of how to adjust the construction in the proof of Theorem~\ref{thm:removing_algebraicity} so that the PCSP templates produced by Theorem~\ref{thm:main_theorem_sandwiches} cannot be solved by BLP+AIP.
 %  
 We remark that the adjustment can also be performed under the addition of the relation $I_4$, i.e., in Theorem~\ref{thm:polinjective}.  
%
The said adjustment is summarized in Proposition~\ref{prop:addingIrelation}.
%
\begin{restatable}{proposition}{addingIrelation}    \label{prop:addingIrelation}
    Let $\struct{A}$ be a non-trivial reduct of a finitely bounded homogeneous structure $\struct{B}$.
    %
    Then there exists a reduct ${(\mathbb{Q};<,I)}^{\struct{A}}$ of a finitely bounded homogeneous structure without algebraicity ${(\mathbb{Q};<,I)}^{\struct{B}}$ such that:
    %
    \begin{enumerate}
        \item \label{item:addingIdatalog} $\CSP(\struct{A})$ and  $\CSP((\mathbb{Q};<,I)^{\struct{A}})$ are Datalog-interreducible.
        \item \label{item:removingalgebitems} The second part of items~\ref{item:1} and~\ref{item:2}, as well as item~\ref{item:4} in Theorem~\ref{thm:removing_algebraicity} hold for ${(\mathbb{Q};<,I)}^{\struct{A}}$ and ${(\mathbb{Q};<,I)}^{\struct{B}}$ substituted for $\blowup{\struct{A}}$ and $\ordblowup{\struct{B}}$.
        \item \label{item:no2blocksymmpol} There exists a finite substructure $\struct{S}$ of  ${(\mathbb{Q};<,I)}^{\struct{A}}$  such that $\Pol(\struct{S},{(\mathbb{Q};<,I)}^{\struct{A}})$ contains no cyclic and no 2-block symmetric operation.
        \end{enumerate}
        
\end{restatable} 

Using a generalization of Lemma~\ref{lemma:pseudocyclic}, which can be proved similarly as~\cite[Lemma~33]{Mottet_2025}, any 2-block symmetric identity can be lifted from $\Pol(\fpwr{\struct{S}}{d},{\smash{({(\mathbb{Q};<,I)}^{\struct{A}}_{\orbeq{G}})}}^{[d]} )$ to $\Pol(\struct{S},{(\mathbb{Q};<,I)}^{\struct{A}})$, where $G\coloneqq \Aut({(\mathbb{Q};<,I)}^{\struct{B}}\ast (\mathbb{Q};<))$.
%
Since solvability of a finite-domain PCSP by BLP+AIP is characterized by the existence of 2-block symmetric polymorphisms~\cite[Theorem 4]{BLP_AIP}, $\PCSP(\fpwr{\struct{S}}{d},{\smash{({(\mathbb{Q};<,I)}^{\struct{A}}_{\orbeq{G}})}}^{[d]} )$ is not solvable by BLP+AIP.
%    
\begin{proof}[Proof of Proposition~\ref{prop:addingIrelation}]
Let $\tau$ and $\sigma$ be the signatures of $\struct{A}$ and $\struct{B}$, respectively.
%
We first define the auxiliary structure $\struct{B}'\coloneqq  (\mathbb{Q};<,I) \wr \struct{B}$ where the relation $I$ is defined by $I(a,b,c):\Leftrightarrow a\neq b\vee a\geq c$. 
%
Since $(\mathbb{Q};<)$ is finitely bounded, homogeneous, and without algebraicity and $I$ is quantifier-free first-order definable in $(\mathbb{Q};<)$, all those properties also apply to $(\mathbb{Q};<,I)$.
%
By Proposition~\ref{prop:basic_properties_wreath_products}, all these properties moreover transfer to $\struct{B}'$.
%
As in the proof of Theorem~\ref{thm:removing_algebraicity}, we define ${(\mathbb{Q};<,I)}^{\struct{B}}$ as the expansion of $\struct{B}'$ by the binary inequality $\neq$.
%
As a quantifier-free first-order expansion of $\struct{B}'$, also ${(\mathbb{Q};<,I)}^{\struct{B}}$ is finitely bounded, homogeneous, and without algebraicity.
%
Next, the structure ${(\mathbb{Q};<,I)}^{\struct{A}}$ is obtained as a reduct of ${(\mathbb{Q};<,I)}^{\struct{B}}$ by removing all symbols in $\sigma\setminus \tau$ (note that the symbols for $<$ and $I$ remain present).
%

\textit{Proof of item~\ref{item:addingIdatalog}.} We informally describe the two Datalog-reductions from $\CSP({(\mathbb{Q};<,I)}^{\struct{A}})$ to $\CSP(\struct{A})$ and back, starting with the former.
%  
Let $\struct{J}$ be an instance of $\CSP({(\mathbb{Q};<,I)}^{\struct{A}})$.
%
For every constraint of the form $(x_1<x_2)$ or $I(x_1,x_2,x_3)$, we add $\{(x_1,x_2)\}$ or $\{(x_1,x_2),(x_2,x_3)\}$, respectively, to the relation interpreting $E$. 
%
Subsequently, we compute the equivalence closure of $E$ and solve the CSP for the $\{<,I\}$-reduct on each equivalence class using a Datalog program. 
%   
If the Datalog program for the $\{<,I\}$-reduct rejects, then we add, for every $x\in J$, the tuple $(x,\dots, x)$ to every $\tau$-relation.
%
Similarly as in the proof of Theorem~\ref{thm:removing_algebraicity}, by the non-triviality of $\struct{A}$, this ensures that our reduction maps $\struct{J}$ to an unsatisfiable instance of $\CSP(\struct{A})$.
%
We moreover add the tuples $(x,\dots, x),(y,\dots, y)$ to every $\tau$-relation whenever the Datalog program for the $\{<,I\}$-reduct derives the constraint $x=y$ while $(x,y)\in {\neq}^{\struct{J}}$; this in particular applies in the case where  
$x$ and $y$ refer to the same variable. 
%
In the rest of the reduction, we proceed as in the proof of Theorem~\ref{thm:removing_algebraicity}, by factoring through $E$.
%
The reduction from $\CSP(\struct{A})$ to $\CSP({(\mathbb{Q};<,I)}^{\struct{A}})$ is obtained by adding empty relations $E,\neq,<,I$.  

\textit{Proof of item~\ref{item:removingalgebitems}.}
%
In showing that ${(\mathbb{Q};<,I)}^{\struct{A}}$ is a model-complete core if and only if $\struct{A}$ is a model-complete core, we would proceed as in the proof of Theorem~\ref{thm:removing_algebraicity}, with a single exception.
%
Namely, we cannot choose arbitrary permutations of $E$-classes, but we must instead choose order-preserving permutations (where $<$ restricted to each $E$-class is the order).
%
In showing that ${(\mathbb{Q};<,I)}^{\struct{B}}$ is homogeneous Ramsey if and only if $\struct{B}$ is homogeneous Ramsey, we can proceed exactly as in the proof of Theorem~\ref{thm:removing_algebraicity}, because $\Aut(\mathbb{Q};<)=\Aut(\mathbb{Q};<,I)$.
%

Next, we want to show that ${(\mathbb{Q};<,I)}^{\struct{A}}$ pp-constructs $\struct{K}_3$ if and only if  $\struct{A}$ pp-constructs $\struct{K}_3$. 
%
Clearly, ${(\mathbb{Q};<,I)}^{\struct{A}}$ pp-constructs $\struct{A}$. Thus, if $\struct{A}$ pp-constructs $\struct{K}_3$, then so does $\blowup{\struct{A}}$. 
% 
The other direction can be proved exactly as in the proof of Theorem~\ref{thm:removing_algebraicity} but again with an exception related to  $<$ and $I$.
%
Namely, when lifting the homomorphic equivalence between $\struct{A}$ and $\struct{C}$ to a homomorphic equivalence between ${(\mathbb{Q};<,I)}^{\struct{A}}$ and ${(\mathbb{Q};<,I)}^{\struct{C}}$, we choose $e$ to be an injection from the Cartesian product of $\mathbb{Q}$ with the domain of $h$ into $\mathbb{Q}$ that preserves the order on the equivalence classes.
%
We then use the fact that $(\mathbb{Q};\neq,<,I)$ has polymorphisms $\alpha',\beta',s'$ witnessing the pseudo-Siggers identity; this follows from~\cite[Theorems~12.0.1,~12.7.3,~12.9.2, and Corollary~6.4.4]{bodirsky2021complexity} and Theorem~1.3 in~\cite{barto2019equations}. 

\textit{Proof of item~\ref{item:no2blocksymmpol}}. For arbitrary 
$a\in A$, set $S \coloneqq \{(0,a),(1,a)\}$.
%
Every $f\in\Pol(\struct{S},{(\mathbb{Q};<,I)}^{\struct{A}})$ preserves $E$, and hence maps $E$-classes onto $E$-classes.
%
In particular, $f(S)$ is contained within a single $E$-class.
%
This means that $f$ induces a well-defined polymorphism $f'$ from the substructure of $(\mathbb{Q};\neq,I)$ induced by $\{0,1\}$ to $(\mathbb{Q};\neq,I)$.
%
By~\cite[Proposition~35]{Mottet_2025}, $f'$ can be neither cyclic nor 2-block symmetric, and this also applies to $f$.
\end{proof}  


\section{Answering a question of Barto\v{s}ov\'{a} and Scow} 

To answer the question of Barto\v{s}ov\'{a} and Scow, we must first extend our notion of a structure to a more general setting.
%
Signatures no longer contain only relation symbols but also \emph{function symbols}, each with an associated number called arity.
%
We call signatures containing only function symbols \emph{functional} and signatures containing both function and relation symbols \emph{mixed}.
%
For each function symbol $f\in \tau$ of arity $k$, a $\tau$-structure $\struct{A}$ has an \emph{operation}  $f^\struct{A}\colon A^k\rightarrow A$. 
%
We allow function symbols of arity $0$, which we call \emph{constant symbols}.
%
Structures with a purely functional signature are called \emph{algebras}.

The notion of a homomorphism $h\colon \struct{A}\rightarrow \struct{B}$ is extended to mixed signatures as follows:
%
for every function symbol $f\in\tau$ of arity $k$, we require that
%
$h(f^\struct{A}(a_1,\dots,a_k))=f^\struct{B}(h(a_1),\dots,h(a_k))$ for all $a_1,\dots,a_k\in A$.
% 
Incorporating this expanded definition of homomorphisms, the definitions of \emph{embeddings},  \emph{isomorphisms}, \emph{automorphisms} and \emph{orbits} can be adopted from relational structures and Section \ref{section:preliminaries}, and $\omega$-\emph{categoricity} is still characterized as in Section \ref{subsection:intro_conjecture}.
%
For two $\tau$-structures $\struct{A}$ and $\struct{B}$, we write $\struct{A}\hookrightarrow\struct{B}$ if $\struct{A}$ embeds into $\struct{B}$.

The notion of a substructure must be adjusted as well, because not every subset of the domain of a $\tau$-structure $\struct{A}$ is necessarily closed under its operations.
%
Suppose that $B\subseteq A$ satisfies $f^\struct{A}(B^k)\subseteq B$ for every function symbol $f\in\tau$ of any arity $k$.
%
Then $B$ induces a \emph{substructure} $\struct{B}$ of $\struct{A}$, where $f^\struct{B} =  f^\struct{A}|_{B^k}$ for every function symbol $f\in\tau$ of any arity $k$; relations are obtained via restriction as in Section~\ref{section:preliminaries}.
%
For a $\tau$-structure $\struct{A}$ and $B\subseteq A$, the \emph{substructure generated by $B$} is the smallest substructure of $\struct{A}$ containing $B$. 
%
If a structure $\struct{A}$ is generated by a finite subset of its domain, we say that it is  \emph{finitely generated}.
%
The notion of \emph{homogeneity} naturally extends to the setting of functional or mixed signatures; we must only replace finite substructures by finitely generated substructures.
%
The \emph{age} of a structure $\struct{B}$ consists of all structures isomorphic to a finitely generated substructure of $\struct{B}$.
%
The \emph{union} $\bigcup_{n\in \mathbb{N}} \struct{A}_n$ of a family $(\struct{A}_n)_{n\in \mathbb{N}}$ of $\tau$-structures with the property that $\struct{A}_n$ is a substructure of $\struct{A}_{n+1}$ for every $n\in \mathbb{N}$ is the $\tau$-structure with domain $\bigcup_{n\in \mathbb{N}} A_n $, relations $R^{\cup_{n\in \mathbb{N}} \struct{A}_n}\coloneqq \bigcup_{n\in \mathbb{N}} R^{\struct{A}_n}$ and operations $f^{\cup_{n\in \mathbb{N}} \struct{A}_n}\coloneqq \bigcup_{n\in \mathbb{N}} f^{\struct{A}_n}$.

\subsection*{Fra\"iss\'e-limits.}   Homogeneous structures arise as limit objects of certain well-behaved classes of finitely generated structures.
%
A class $\class{C}$ of finitely generated structures in a common (mixed) signature $\tau$ is said to have the:
%
\begin{itemize}
    \item \emph{hereditary property (HP)} if, for all $\struct{A}\in\class{C}$ and all $\tau$-structures $\struct{B}\hookrightarrow\struct{A}$, also $\struct{B}\in\class{C}$;
    \item \emph{joint embedding property (JEP)} if, for all $\struct{A,B}\in\class{C}$, there is $\struct{C}\in\class{C}$ with $\struct{A},\struct{B}\hookrightarrow\struct{C}$;
    \item \emph{amalgamation property (AP)} if, for all $\struct{A},\struct{B}_1,\struct{B}_2\in\class{C}$ for which there exist embeddings $f_1\colon \struct{A} \hookrightarrow\struct{B}_1$ and $f_2\colon \struct{A}\hookrightarrow \struct{B}_2$, there exists $\struct{C}\in\class{C}$ and embeddings $g_1\colon \struct{B}_1  \hookrightarrow \struct{C}$ and $g_2\colon \struct{B}_2  \hookrightarrow \struct{C}$ such that $g_1\circ f_1 = g_2\circ f_2$.
\end{itemize}
%
Every class $\class{C}$ of the form $\age(\struct{A})$ for a countable homogeneous structure $\struct{A}$ over a countable signature is (i) closed under isomorphisms, (ii) contains only countably many structures up to isomorphism, and (iii) satisfies the HP, JEP and AP.
%
Fra\"iss\'e's theorem~\cite[Theorem 6.1.2]{hodges_book} states the converse: for every class $\class{C}$ of finitely generated structures over a countable signature satisfying (i), (ii), and (iii), there exists an up to isomorphism unique countable homogeneous structure $\struct{C}$ with $\age(\struct{C})=\class{C}$, called the \emph{Fra\"iss\'e-limit} of $\class{C}$.


\subsection*{Canonical functions.}

Given two structures $\struct{B}$ and $\struct{C}$, we call a function $\phi\colon B\rightarrow C$ \emph{canonical} from $\struct{B}$ to $\struct{C}$ if, for every $k\in \mathbb{N}$ and every $\bar{b}\in B^k$, the orbit of $\phi(\bar{b})$ in $\struct{C}$ only depends on the orbit of $\bar{b}$ in $\struct{B}$.
%
We say that $\struct{B}$ is a \emph{semi-retract} of $\struct{C}$ if there are injective functions $\phi\colon B\rightarrow C$ and $\psi\colon C\rightarrow B$ such that $\phi$ is canonical from $\struct{B}$ to $\struct{C}$, $\psi$ is canonical from $\struct{C}$ to $\struct{B}$, and  $\psi\circ\phi$ acts as the identity on the orbits of $\struct{B}$.
%
The pair $(\phi,\psi)$ is then called a \emph{semi-retraction} between $\struct{B}$ and $\struct{C}$.
%
The notions semi-retract and semi-retraction were introduced by Scow~\cite{scow2021ramsey}, and later refined by Barto\v{s}ov\'a and Scow \cite{BARTOŠOVÁ_SCOW_2024}.  
%
Both works do not explicitly use the word canonical, but rather talk about ``quantifier-free type-respecting functions.''
%
However, in the setting of countable $\omega$-categorical homogeneous structures, these two notions align~\cite[Statement~2.22]{Cameron_1990}.  


\subsection*{The atomless Boolean algebra.}
%
\emph{Boolean algebras} are algebras with signature $\{\wedge,\vee,\neg,0,1\}$ satisfying axioms formalising basic properties of logical operators (conjunction, disjunction, and negation), see, e.g.,~\cite[Section~2.1.4]{bodirsky2021complexity}. 
%
Here, $\wedge$ and $\vee$ are function symbols of arity $2$, $\neg$ is of arity $1$ and $0,1$ are constant symbols. 
%
The class of all finite Boolean algebras fulfills the requirements of Fra\"iss\'e's theorem, and hence there exists a Fra\"iss\'e limit $\alg{A}$ of this class, commonly called the \emph{atomless Boolean algebra}.

Every Boolean algebra $\alg{B}=(B;\wedge,\vee,\neg,0,1)$ induces a partial order $\preceq_{\alg{B}}$ on its domain given by $b_1 \preceq_{\alg{B}} b_2:\Leftrightarrow b_1\vee b_2=b_2$. 
%  
Given a finite Boolean algebra $\alg{B}$, specifying an arbitrary linear order on its atoms and extending it anti-lexicographically to the unique decompositions of all elements as joins of a particular subset of its atoms allows us to linearly order the entire algebra in a way that extends $\preceq_{\alg{B}}$~\cite{kechris2005fraisse}.
%  
Finite Boolean algebras ordered in this way are called \emph{naturally ordered.}
%
Also the class of all finite naturally ordered Boolean algebras fulfills the requirements of Fra\"iss\'e's theorem;
% 
its Fra\"iss\'e-limit $(\alg{A},<)$ is what Barto\v{s}ov\'a and Scow call the \emph{countable atomless Boolean algebra with a generic normal order}~\cite{BARTOŠOVÁ_SCOW_2024}.
%
As the notation indicates, taking the $\{\wedge,\vee,\neg,0,1\}$-reduct of $(\alg{A},<)$ gives us back the countable atomless Boolean algebra $\alg{A}$ (up to isomorphism).
%
Going forward, we will refer to $(\alg{A},<)$ as the \emph{linearly ordered atomless Boolean algebra}. 


\subsection*{The question of Barto\v{s}ov\'{a} and Scow.}
% 
The \emph{random ordered graph} $(\struct{G},<)$ is the Fra\"{i}ss\'e limit of the class of all finite simple graphs with an additional linear ordering of their vertices; its reduct $\struct{G}=(G;E)$ is the well-known random graph, the Fra\"{i}ss\'e limit of the class of all finite simple graphs.
%
Barto\v{s}ov\'a and Scow pose the question whether the random ordered graph is a semi-retract of the countable atomless Boolean algebra with a generic normal order~\cite[Question~4.3]{BARTOŠOVÁ_SCOW_2024}.
%  
We provide a positive answer to this question, building on their proof of the unordered version of the statement~\cite[Theorem~4.1]{BARTOŠOVÁ_SCOW_2024}. 

\semiretraction* 


We remark that Proposition~\ref{prop:rg_semiret_aba} together with \cite[Corollary 5.5]{BARTOŠOVÁ_SCOW_2024} gives an alternative proof of the fact that $(\struct{G},<)$ has the Ramsey property~\cite[Theorem 6.2]{kechris2005fraisse} given the fact that $(\alg{A,<)}$ has the Ramsey property~\cite[Theorem 6.14]{kechris2005fraisse}.

 Constructions of the two structures in question are given in \cite{kechris2005fraisse}; certain details of these constructions will be useful in the proof of Proposition~\ref{prop:rg_semiret_aba}.
%
In the proof of Proposition \ref{prop:rg_semiret_aba}, we will consider various powers of $\{0,1\}$. By interpreting $\wedge$ and $\vee$ as the component-wise infimum and supremum, respectively, $\neg$ as the operation switching all zeroes and ones, and the constant symbols $0$ and $1$ as the corresponding constant tuples, all powers of $\{0,1\}$ can be endowed with the structure of Boolean algebras. 
%
Note that, for every $I$, the elements of $\{0,1\}^I$ can be viewed as an indicator function $\ind{J}{I}\colon I \rightarrow \{0,1\}$, mapping $i$ to $1$ if and only if $i\in J$.
%
If $J$ consists of a single element $j$, we simply write $\ind{j}{I}$.
  %
\begin{proof}[Proof of Proposition~\ref{prop:rg_semiret_aba}]
    We start by constructing an order preserving map $\phi\colon  (A;<) \rightarrow (G;<) $ that is canonical from $(\alg{A},<)$ to $(\struct{G},<)$, analogously to how this is done in the unordered case~\cite{BARTOŠOVÁ_SCOW_2024}.
    %
    We first expand $(\alg{A},<)$ by the binary (edge) relation $E$ defined as follows:
    %
    $a,b\in A$ share an edge if and only if they are distinct and $a \wedge b \neq 0$.
    %
    Note that the $\{<,E\}$-reduct $(A;<,E)$ of $(\alg{A},<,E)$ is a linearly ordered countable simple graph.
    %
    Since the random ordered graph embeds every linearly ordered countable simple graph, there exists an embedding $\psi\colon (A;<,E) \hookrightarrow (\struct{G},<)$.
    %
    By definition, this function is order-preserving.
    %
    It is also canonical from $(\alg{A},<)$ to $(\struct{G},<)$ because $\psi$ is an embedding from $(A;<,E)$ to $(\struct{G},<)$, $(\struct{G},<)$ is homogeneous, and $\Aut(\alg{A},<) \subseteq \Aut(A;<,E) $ (as $E$ is first-order definable in $(\alg{A},<)$).
    
    The construction of the second order-preserving function $\psi\colon (G;<) \rightarrow (A;<) $, which is canonical from $(\struct{G},<)$ to $(\alg{A},<)$, is significantly more involved. 
    %
    The basic idea stems from~\cite{BARTOŠOVÁ_SCOW_2024}, but to incorporate the additional order, we need to make the construction more explicit.
    %
    Pick an arbitrary enumeration $(v_n)_{n\in\mathbb{N}}$ of $G$, and define $I\coloneqq \{(n,m)\in\mathbb{N}^2\mid n\leq m\}$. 
    %
    Consider the natural Boolean algebra $\alg{U}$ induced by $\{0,1\}^I$; it will be helpful to think of its elements as $\mathbb{N}\times \mathbb{N}$-upper block triangular matrices.
    %
    We map $G$ to $U$ via $v_n\mapsto u_n$, where \[ u_n\coloneqq \ind{\{(n,n+k) \,\mid \, k\in\mathbb{N}\}}{I}\vee\ind{\{(m,n)\, \mid \, m<n \text{ and } (v_m,v_n) \in E^{\struct{G}}\}}{I}.\]
    %
    Denote the subalgebra of $\alg{U}$ generated by $\{u_1,\dots,u_k\}$ by $\alg{B}_k$. 
    %
    Note that all entries of the elements of $B_k$ are fully determined by the first $k+1$ columns (considered as $\mathbb{N}\times \mathbb{N}$-upper block triangular matrices).
    %
    Moreover, by cutting off all other entries, $\alg{B}_k$ naturally embeds into the Boolean algebra of all upper block triangular $(k+1)\times(k+1)$-matrices with entries $0$ and $1$, which we call $\alg{C}_{k+1}$. 
    
    Set $I_k\coloneqq\{(n,m)\in I\mid n,m\leq k\}$.
    %
    The finite algebras $\alg{C}_k$ can be naturally ordered by ordering the atoms.
    %
    Starting with the diagonal, we order $\smash{\ind{(1,1)}{I_k},\dots,\ind{(k,k)}{I_k}}$ according to the ordering $<$ of $(\struct{G},<)$ restricted to $\{v_1,\dots, v_k\}$.
    %
    Next, the atoms corresponding to the superdiagonal, $\ind{(1,2)}{I_k},\ind{(2,3)}{I_k}\dots,\ind{(k-1,k)}{I_k}$, are ordered according to $\{v_1,\dots, v_{k-1}\}$, and all of them are set smaller than the atoms corresponding to the diagonal.
    %
    Iterating this process, getting smaller and smaller the further we move from the diagonal, we eventually obtain an ordering of all atoms that induces a linear order of $C_k$.  
    
    Pulling back the order from $(\alg{C}_{k+1},<)$ to $\alg{B}_k$ for all $k\in\mathbb{N}$, we obtain a natural ordering 
    $(\alg{B}_k,<)$ of the algebras $\alg{B}_k$ with respect to the order of their atoms in $(\alg{C}_{k+1},<)$, where the order of any $(\alg{B}_k,<)$ is compatible with that of $(\alg{B}_{k+1},<)$.
    %
    The union $(\alg{B},<)\coloneqq\bigcup_{k\in\mathbb{N}}(\alg{B}_k,<)$ is thus a countable linearly ordered Boolean algebra.
    %
    Notice that, for tuples $(u_{i_1},u_{i_2},\dots,u_{i_n})$ and $(u_{j_1},u_{j_2},\dots,u_{j_n})$ increasing w.r.t.\ $<$, if the
    mapping $u_{i_{\ell}} \mapsto u_{j_{\ell}}$ specifies an isomorphism between subalgebras of $\alg{B}$ generated by the respective elements, then it also does so for the ordered subalgebras of $(\alg{B},<)$ generated by them. 

    The linearly ordered atomless Boolean algebra $(\alg{A},<)$ embeds  $(\alg{B}_k,<)$ for every $k\in \mathbb{N}$ and is homogeneous.
    %
    Consequently, it also contains an isomorphic copy of $(\alg{B},<)$.
    %
    Fix any embedding $\xi$ from $(\alg{B},<)$ to $(\alg{A},<)$, and set  $a_n\coloneqq\xi(u_n)$. 
    %
    We claim that $\phi\colon v_n\mapsto a_n$ is the order-preserving canonical function we seek.  
    %
    As it clearly is order-preserving, it suffices to show that $\phi$ acts on the orbits of increasing tuples.
    %
    For those, we can proceed similarly to how Barto\v{s}ov\'{a} and Scow~\cite{BARTOŠOVÁ_SCOW_2024} treat unordered tuples.

    In $\alg{U}$, the elements $b_n\coloneqq \ind{\{(n,n+k)\mid k\in\mathbb{N}\}}{I},n\in\mathbb{N}$, form an infinite antichain, i.e., the meet of any two distinct elements is $0$.
    %
    Moreover, below each $b_n$, the elements $b_n^i\coloneqq\ind{\{(n,i)\}}{I},i>n$, form another antichain.
    %
    Using this notation, we see that $\phi$ sends each $v_n$ to 
    \[
    a_n=\xi(u_n)=\xi\left( b_n\vee\bigvee\nolimits_{i<n \text{ and } (v_i,v_n)\in E^{\struct{G}}}b_i^n\right).
    \]
    %
    This shows that the properties  (1)--(4) identified in the proof of~\cite[Theorem~4.1]{BARTOŠOVÁ_SCOW_2024} also apply in our case.
    
    As $\xi$ is an embedding, our observation about the ordered subalgebras generated by increasing tuples $(u_{i_1},u_{i_2},\dots,u_{i_n})$ and $(u_{j_1},u_{j_2},\dots,u_{j_n})$ transfers to $(\alg{A},<)$ and increasing tuples $(a_{i_1},a_{i_2},\dots,a_{i_n})$ and $(a_{j_1},a_{j_2},\dots,a_{j_n})$.
    
    In combination with this observation, all the arguments Barto\v{s}ov\'a and Scow~\cite{BARTOŠOVÁ_SCOW_2024} make based on the properties (1)--(4) can also be applied in our case, telling us that the function $\phi$ acts on the orbits of increasing tuples, which makes it canonical.

    Finally, observe that $\phi$ maps distinct vertices to points with meet $0$ if and only if they do not share an edge. 
    %
    Together with the definition of $\psi$ at the beginning of the proof and the fact that $\phi$ and $\psi$ both preserve the respective linear orders, this means that $\psi\circ\phi$ acts as the identity on the orbits of $(\struct{G},<)$. 
\end{proof}
   