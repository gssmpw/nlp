
\definecolor{DarkGray}{HTML}{68904d}
\definecolor{Orange}{HTML}{ffae42}
\begin{figure}[h!]
\small
\centering
\begin{tikzpicture}[
    box/.style={rectangle,draw,fill=DarkGray!20,node distance=1cm,text width=8em,text centered,rounded corners,minimum height=1.5em,thick},
    box2/.style={rectangle,draw,fill=DarkGray!20,node distance=1cm,text width=1em,text centered,rounded corners,minimum height=0.5em,thick},
    arrow/.style={draw,-latex',thick},
  ]
  \node [box] (ffne) {FCNN};
  
  
  \node [box2,above=0.5 of ffne] (tok2) {c$_2$};
  \node [box2,left=0.25 of tok2] (tok1) {c$_1$};
  \node [box2,right=0.25 of tok2] (tok3) {c$_3$};
  \node [above=0.2 of tok2]{Encoder output};
  \node [box,below=0.23 of ffne,fill=Orange] (selfatt){Self-attention};  
  \node [label={[rotate=90]160:Layer 1},rectangle,draw,dashed,inner sep=0.7em,fit=(selfatt) (ffne)] (encoder1) {};

  \node [box2,below=0.4 of selfatt] (se){x$_2$};
  \node [box2,left=0.25 of se] (se2){x$_1$};
  \node [box2,right=0.25 of se] (se3){x$_3$};
  \node [box,below=0.23 of se] (embed) {Embedding};
  \node [below=0.3 of embed] (inp2) {\texttt{2}};
\node [right=0.25 of inp2] (inp3) {\texttt{5}};
\node [left=0.25 of inp2] (inp1) {\texttt{1}};
\path[arrow] (inp2) -- (embed);
\path[arrow] (inp3) -- (embed.south -| inp3);
\path[arrow] (inp1) -- (embed.south -| inp1);
\node [below=0.1 of inp2]{\textbf{Encoder}};
  

\node [box,right=1.0 of embed](emb2){Embedding};

\node [below=0.3 of emb2](enc2){\texttt{3}};
\node [left=0.25 of enc2](enc3){\texttt{BOS}};
\node [below=0.1 of enc2]{\textbf{Decoder}};

\node [box2,above=0.23 of emb2](em22){y$_2$};
\path[draw,thick] (emb2) -- (em22);
\path[arrow] (enc2) -- (emb2);
\path[arrow] (enc3) -- (emb2.south -| enc3);



\node [box2,left=0.25 of em22](em21){y$_1$};
\path[draw,thick] (emb2.north -| em21) -- (em21);

\node [box,above=0.4 of em22,fill=Orange] (selfatt2){Self-attention};
\path[arrow] (em22) -- (selfatt2);
\path[arrow] (em21) -- (selfatt2.south -| em21);

\node [box,above=0.23 of selfatt2] (gate){Copy-gate};
\path[arrow] (selfatt2) -- (gate);

\node [box,above=0.23 of gate,fill=Orange] (XattD){Cross-attention};
\path[arrow] (gate) -- (XattD);

\node [box,above=0.23 of XattD] (ffn) {FCNN};
\path[arrow] (XattD) -- (ffn);

\node [label={[rotate=270]35:Layer 1 (shared)},rectangle,draw,dashed,inner sep=0.7em,fit=(selfatt2) (ffn)] (decoder2) {};
\node [box,above=0.55 of ffn,fill=Orange] (selfatt3){Self-attention};
\path[arrow] (ffn) -- (selfatt3);

\node [box,above=0.23 of selfatt3,fill=Orange] (crossatt2){Cross-attention};
\path[arrow] (selfatt3) -- (crossatt2);

\node [box,above=0.23 of crossatt2] (ffn2) {FCNN};
\path[arrow] (crossatt2) -- (ffn2);
\node [label={[rotate=270]22:Layer 2},rectangle,draw,dashed,inner sep=0.7em,fit=(selfatt3) (ffn2)] (decoder2) {};
\node [box,above=0.4 of ffn2] (linear){Linear classifier};
\path[arrow] (ffn2) -- (linear);
\node [box,above=0.23 of linear] (softmax){Softmax};
\path[arrow] (linear) -- (softmax);
\node[above=0.3 of softmax](output){\texttt{5}};
\path[arrow] (softmax) -- (output);

\coordinate[above right =0.2 and 0.7 of tok3](conn);
\path[draw,thick] (tok1) |- (conn);
\path[draw,thick] (tok2) |- (conn);
\path[draw,thick] (tok3) |- (conn);

\coordinate[left=0.1 of gate](lg);
\path[draw,thick] (gate) -- (lg);
\coordinate[above=0.1 of ffn.north](mw2);
\path[arrow] (lg) |- (mw2);
\coordinate[right=1.5 of mw2](mw3);
\path[draw,thick] (mw2)-- (mw3);
\coordinate[below right =0.1 and 0.1 of selfatt2.south](mw);
\path[arrow] (mw3) |- (mw);
 
\path [arrow] (ffne.north -| tok1) -- (tok1);
\path [arrow] (ffne) -- (tok2);
\path [arrow] (ffne.north -| tok3) -- (tok3);
\path [arrow] (selfatt) -- (ffne);
\path [arrow] (se) -- (selfatt);
\path [arrow] (se2) -- (selfatt.south -| se2);
\path [arrow] (se3) -- (selfatt.south -| se3);
\path[draw,thick] (embed.north -| se2) -- (se2);
\path[draw,thick] (embed) -- (se);
\path[draw,thick] (embed.north -| se3) -- (se3);
\coordinate[left=0.1 of XattD.west](mw4);
\path[arrow] (conn) |- (mw4);
\path[arrow] (conn) |- (crossatt2.west);

\node[draw,text width=3cm] at (-0.2,4.2) {Embedding dimension\\
\begin{itemize}[leftmargin=*, itemsep=1pt, topsep=1pt, parsep=1pt]
\item Encoder: $d_e=1024$ \\
\item Decoder: $d_e=512$ 
\end{itemize}
Attention heads: $4$

Fully connected neural network (FCNN):\\ 
\begin{itemize}[leftmargin=*, itemsep=1pt, topsep=1pt, parsep=1pt]
\item 1 hidden layer \\
\item $4d_e$ neurons \\
\end{itemize}
Shared layer iterated up to $8$ times.
};
\end{tikzpicture}
\vspace{-0.1cm}
\caption{\textbf{Our transformer architecture.} }\label{fig:archi}
%\vspace{-0.1cm}
\end{figure}
