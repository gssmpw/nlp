\begin{figure}[t]
\centering
\small
\vspace{-5pt}
\begin{minipage}{0.9\linewidth}
    \begin{algorithm}[H]
        \vspace{-2pt}
        % \algsetup{linenosize=\small}
        \caption{hMCTS denoising of T-SCEND}
        \label{alg:hmcts}
        \begin{algorithmic}[1]
            \STATE \textbf{Input:} EBM $E_\theta(\cdot)$, Diffusion Steps $T$, MCTS denoising start step $t_s$, Number of initial noise of Best-of-N random search $L$, Maximum MCTS branch count $K$, Maximum MCTS rollout step $N_r$, A set of initial diffusion state $\{\boldsymbol{x}_T^{(k)}\ |\ k=1,...,L\}$ sampled from Gaussian noise. \\
        \STATE {\color{gray}// Random search for $T\rightarrow t_s$} 
        \\
        \FOR{$t = T$ \textbf{to} $t_s$} 
            \STATE Use Eq. \ref{eq:ddpm_denoise} to get $\boldsymbol{x}_{t-1}^{(k)}$ for $k = 1,...,L$
        \ENDFOR \\ 
        $\x_{t_s}\gets \argmin_{\x_{t_s}^{(k)}}E_\theta(\x_{t_s}^{(k)})$ \\
        \STATE {\color{gray}// MCTS denoising for $t_s\rightarrow1$} 
        \FOR{$t = t_s$ \textbf{to} 1}
        \STATE {\color{gray}// Do MCTS Rollouts:}
            \FOR{$i = 1$ \textbf{to} $N_r$}
            \STATE \textbf{Selection:} Use UCB from Eq. \ref{eq:ucb_denoise} to select the child node until a leaf node or a terminal node $\{\boldsymbol{x}_{t'}, Q(\x_{t'}), N(\x_{t'})\}$ is reached and form a path using the nodes accessed during the selection;
            \STATE \textbf{Expansion:} Use Eq. \ref{eq:mcts_denoise} to generate child node state $\boldsymbol{x}_{t'-1}^{(k)}$ for $\boldsymbol{x}_{t'}$ and initialize $Q(\boldsymbol{x}_{t'-1}^{(k)}) = 0$, $N(\boldsymbol{x}_{t'-1}^{(k)}) = 0$ for $k = 0,...,K-1$; \\
            \STATE \textbf{Simulation:} Randomly choose $k^*\sim \{0,...,K-1\}$ and do DDIM simulation from $\boldsymbol{x}_{t'-1}^{(k^*)}$ to get $\boldsymbol{\hat{x}_0}(\boldsymbol{x}_{t'-1}^{(k^*)})$;
                \STATE \textbf{Backpropagation:} Update the value and visit count of each node $\x_{t_p}$ in the path using $Q(\boldsymbol{x}_{t_p}) \gets Q(\boldsymbol{x}_{t_p}) - E_\theta(\boldsymbol{\hat{x}_0}(x_{t'-1}^{(k^*)}))$;
                \STATE \quad $N(\boldsymbol{x}_{t_p}) \gets N(\boldsymbol{x}_{t_p}) + 1$;
            \ENDFOR \\
            % \STATE Choose $\boldsymbol{x}_{t-1}^{(j^*)}$ with maximum $Q(\boldsymbol{x}_{t-1}^{(j^*)}) / N(\boldsymbol{x}_{t-1}^{(j^*)})$ as $\boldsymbol{x}_{t-1}$;
            \STATE $\x_{t-1}\gets\argmax_{\x_{t-1}^{(k)}}\frac{Q(\x_{t-1}^{(k)})}{N(\x_{t-1}^{(k)})}$
        \ENDFOR \\

        \STATE \textbf{return} $\boldsymbol{x}_0$
        \end{algorithmic}
    \end{algorithm}
\end{minipage}
\vspace{-20pt}
\end{figure}