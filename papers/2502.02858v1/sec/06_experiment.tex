



\section{Experiments}
\label{sec:experiment}

In this section, we aim to showcase how our proposed methods handle infeasible safe control problems and ultimately improve safety for humanoids in cluttered environments.
Through both simulation and hardware experiments, we will answer the following key questions.

\begin{itemize}
\item \textbf{Q1}: How often does \eqref{prob:naive_ssa} become infeasible in dexterous safety tasks in cluttered environments?
\item \textbf{Q2}: Does r-SSA and p-SSA mitigate infeasible QPs and improve humanoid safety in cluttered environments?
\item \textbf{Q3}: How does r-SSA compare to p-SSA in terms of parameter tuning and performance?
\item \textbf{Q4}: How does p-SSA perform in real-world dexterous safety tasks?
\end{itemize}



\begin{figure}[ht]
    \centering
    \includegraphics[width=1.0\linewidth]{figure/system_labeled.png}
    \caption{Unitree G1 humanoid robot in MuJoCo simulation performing safe wrist location tracking.
    The humanoid tracks the goal (green) with its wrist while preventing collisions between robot bodies (black) and obstacles (gray) and self-collision.
    There are three active control constraints (blue) triggered by collision bodies being too close, while two of them are infeasible and relaxed by p-SSA (purple).
    The infeasibility is caused by the right arm trying to avoid both the obstacle and the torso at the same time.
    }
    \label{fig:system}
\end{figure}

\subsection{Robot Modeling}\label{sec:robot_model}

% \ruic{G1, dof, dynamics modeling, geometric modeling}
We consider the Unitree G1 humanoid robot in both MuJoCo simulation and real setup.
We model the G1 dynamics with two variants to represent different use cases.

\textbf{G1FixedBase}:
This configuration considers only the upper body joints while keeping the base fixed.
This model is useful for tasks where the humanoid is expected to perform tasks in-place, such as organizing objects on a fixed shelf.
This model features \textbf{17 DoFs}—7 DoFs for each arm and 3 for the waist—with the pelvis fixed to the world frame.



\textbf{G1WholeBody}:
This configuration includes \textbf{20 DoFs}, consisting of 17 DoFs from G1FixedBase and 3 for base motion, modeled as a floating base.
It is designed to assess safe control for humanoid robots as mobile manipulators, but isolating the challenges induced by locomotion.

With either configuration, we model the humanoid dynamics using a first order integrator model, i.e., $\dot{x} = f(x) + g(x)u = u$ where $f(x) = 0$ and $g(x) = I$.
The state $x$ contains all DoF positions and $u$ the DoF velocities, assuming an accurate velocity tracker at the downstream.
Such setting simplifies the derivations while enabling us to focus on QP infeasibility.
In practice, any control-affine systems\footnote{Non-control-affine systems can still be made control-affine via dynamics extension.} in the form of \eqref{eq:dynamics} can be used.
Collision bodies on the humanoid are modeled in spheres as shown in \cref{fig:system}.
\begin{table}[htbp]
\centering
\captionsetup{width=0.95\textwidth}
\caption{Number of Bodies, Obstacles and Constraints in Test Cases}
\label{tab:test_case_size}

\begin{tabular}{lccccc}
\toprule
\textbf{Test Case} & \textbf{DoFs} & \textbf{Bodies} & \textbf{Obs} & \textbf{Self} & \textbf{Body-Obs} \\
\midrule
G1WholeBody\_SO\_V0 & 20 & 19 & 50 & 29 & 950 \\
G1WholeBody\_SO\_V1 & 20 & 19 & 10 & 29 & 190 \\
G1WholeBody\_DO\_V0 & 20 & 19 & 50 & 29 & 950\\
G1WholeBody\_DO\_V1 & 20 & 19 & 10 & 29 & 190 \\
G1FixedBase\_SO\_V0 & 17 & 19 & 10 & 29 & 190\\
G1FixedBase\_SO\_V1 & 17 & 19 & 5 & 29 & 95 \\
G1FixedBase\_DO\_V0 & 17 & 19 & 10 & 29 & 190\\
G1FixedBase\_DO\_V1 & 17 & 19 & 5 & 29 & 95\\
\bottomrule
\end{tabular}

\end{table}

\begin{figure*}[ht]
\centering
    \includegraphics[width=1.0\textwidth]{figure/sim_example.png}
    \caption{Comparison of safe control methods in G1FixedBase\_DO\_v0 task. Spheres and lines follow the convention in \cref{fig:system}. When an obstacle moves near the left elbow (frame 2), the QP becomes infeasible. In that case, p-SSA (top) generates control to minimize violation to control constraints, resulting in less violation (purple connection) than r-SSA (middle). Naive SSA (bottom) does not handle infeasible control constraints (thick red connection), leading to collisions (red spheres).}
\label{fig: sim_example}
\end{figure*}




% \ruic{introduce tasks, constraints, variants}
\subsection{Experiment Setting}\label{sec:exp_setting}

To evaluate safe control algorithms in various cluttered environments, we design a set of dexterous safety tasks with various obstacle configurations and densities.
In all tasks, the robot is tasked to track fixed 3D goal positions for its wrists and base (if with \textbf{G1WholeBody}) while keeping at least $d_\mathrm{min,env}=0.05 m$ from external obstacles and at least $d_\mathrm{min,self}=0.01m$ for self-collision.
A new goal will spawn once the pervious one is reached.

For constraint configurations, we consider two types:
\begin{itemize}
\item \textbf{Static Obstacle (SO):} Stationary 3D spheres with $0.05m$ radius distributed uniformly within a cubic task space of size $0.8m$.
\item \textbf{Dynamic Obstacle (DO):} Moving 3D spheres that follow Brownian motion after spawning uniformly within a task space of size $2m\times 2m\times 0.8m$.
\end{itemize}



For each constraint type (SO and DO), we assign two levels of difficulty (V0 and V1) indicated by the number of obstacles.
Considering two variants of dynamics configuration (G1FixedBase and G1WholeBody), we end up with eight different dexterous safety tasks.
\Cref{tab:test_case_size} shows the number of all considered robot body-obstacle pairs as well as self-collision pairs in each task.
When counting self-collision pairs, adjacent robot bodies that are always within $d_\mathrm{min,self}$ distance are ignored.
See Appendix \ref{append:self_collision} for detailed configurations of the collision pairs.
Both the obstacles and goals are represented as 3D spheres (see \cref{fig:system}).



\subsection{Safe Control Methods}

To model safety after \eqref{prob:multi_safe_control}, we design an $0^\mathrm{th}$ order safety index $\phi^\mathrm{env}_i=\phi^\mathrm{env}_{0,i}=d_\mathrm{min,env}-d_i$ (since our dynamics is $1^\mathrm{st}$ order) for the $i^\mathrm{th}$ body-obstacle pair where $d_i$ is the body-obstacle distance.
Likewise, $\phi^\mathrm{self}_i = \phi^\mathrm{self}_{0,i} = d_\mathrm{min,self}-d_i$  covers self-collision.
The final safety index is $\bphi\defeq[\phi^\mathrm{env}_1,\dots,\phi^\mathrm{env}_{M_\mathrm{env}},\phi^\mathrm{self}_1,\dots,\phi^\mathrm{self}_{M_\mathrm{self}}]\in\RR^M$.
$\bETA$ is set to $0.5$ for each $\phi_i$ for comparison under the same sensitivity to potential collisions.
Under the same basic safe control law (i.e., $\dot{\bphi}\leq -\bETA$ when $\bphi \geq 0$), we are interested in how the following strategies handle infeasible QPs.

\begin{itemize}
\item \textbf{$p-SSA_2$}: The Projected Safe Set Algorithm introduced in \cref{sec:pssa} with $p=2$ in \eqref{prob:pssa_phase_1}. $Q=Q^{pssa}_s=I$.
% Tuning $Q^{pssa}_s$ is not of interest since it does not impact the performance-safety trade-off.

\item \textbf{$r-SSA_2$}: The Relaxed Safe Set Algorithm introduced in \cref{sec:rssa} with $p=2$ in \eqref{prob:rssa}. $Q=I$. With a fixed $Q$, $Q^{rssa}_s$ decides the relative importance between performance and safety. $Q^{rssa}_s$ will be tuned in the ablation study.

\item \textbf{$SSA$}: The naive safe set algorithm given by \eqref{prob:naive_ssa}. $Q=I$. When \eqref{prob:naive_ssa} becomes infeasible, $u_\mathrm{ref}$ is directly passed to the robot since there is no special handling of infeasibility.
\end{itemize}

We use a PID policy to generate $u_\mathrm{ref}$ for goal tracking without considering safety.
Each of the above safe control methods finds a control $u$ as close to $u_\mathrm{ref}$ as possible to enforce safety constraints.
See Appendix \ref{append:safe_control_constraint} for the derivation of control constraints in \eqref{eq:safe_contr_rssa}, \eqref{eq:safe_contr_pssa_phase_1}, and \eqref{eq:safe_contr_pssa_phase_2}.


% Without loss of generality, we also set each of $Q$ and $Q_s$ to have identical diagonal values to place equal weight on each dimension.

% $Q$ is set to identity to place equal importance on each of the control dimensions.
% For the other two methods, $Q_s$ only determines the relative regularization strength between different $\phi_i$, while being irrelevant in terms of handling infeasible problems.
% Without loss of generality, we consider each collision volume pair of the same interest and set $Q_s$ to identity.



\subsection{Evaluation Metrics}

We evaluate each method in terms of both the task performance (e.g., goal tracking) and safety using a combination of metrics.
For a trajectory of length $T$:
\begin{itemize}
    \item $J$: goal tracking performance given by
        \begin{equation}
            J = \frac{1}{2T}\sum_{t,i}\exp(-d_{i,t}^2 / 0.002)
        \end{equation}
        where $d_{i,t}$ is the distance of the wrist or base $i$ to its goal at each $t$.
        
    \item $C$: control constraint satisfaction score, given by
        \begin{equation}
            C=\frac{\sum_{t}\II(s_t>0)\exp\left(-s_t^2 / 0.2\right)}{\sum_{t}\II(s_t>0)}
        \end{equation}
        where $s_t=\sum_{i}s_{i,t}$. The parameter $s_{i,t}$ is the amount of violation to the $i^\mathrm{th}$ control constraint at time $t$ and $s_t$ is the total violation at time $t$. For p-SSA, $s_{i,t}$ is the solution to \eqref{prob:pssa_phase_1}. For r-SSA, $s_{i,t}$ is solved in \eqref{prob:rssa} with the control. For SSA, $s_{i,t}=\max(\dot{\phi}_{i,t}(x_t,u^*_t)+\eta_{i}, 0)$ where $u^*_t$ is the solution to \eqref{prob:naive_ssa} if feasible, or $u_\mathrm{ref,t}$ otherwise.
        $C$ only evaluates time steps when the QP is infeasible.
        
    \item $S$: safety constraint satisfaction score, given by
        \begin{equation}
            S = \frac{\sum_{t,i}\II(d_{i,t} < d_\mathrm{min})\exp(-(d_{i,t}-d_\mathrm{min})^2 / 0.0002)}{\sum_{t,i}\II(d_{i,t} < d_\mathrm{min})}
        \end{equation}
        $S$ evaluates the average amount of safety margin $d_\mathrm{min}$ that is invaded (e.g., negative $d_{i,t}-d_\mathrm{min}$).
        $S=0$ for no violation.
        Notably, $S$ evaluates direct violation to the safety specification (e.g., collisions) as a result of violation to control constraints which is evaluted by $C$.
        Hence, they are positively related while being different metrics.

    \item $R_\mathrm{Feas}$: empirical probability of the QP to be feasible, given by
        \begin{equation}
            R_\mathrm{Feas} = 1 - \frac{1}{T}\sum_{t}\II(s_t>0)
        \end{equation}
        
\end{itemize}

\begin{figure*}[ht]
\centering
    \includegraphics[width=1.0\textwidth]{figure/whole_body.png}
    \caption{Performance comparison under \textbf{G1WholeBody} configuration.}
\label{fig: whole_body}
\end{figure*}
\begin{figure*}[ht]
\centering
    \includegraphics[width=1.0\textwidth]{figure/fixed_base.png}
    \caption{Performance comparison under \textbf{G1FixedBase} configuration.}
\label{fig: fixed_base}
\end{figure*}



\subsection{Overall Performance}

% \ruic{todo table of num of dof, num of obstacle, num of constraints (self, env)}

% \ruic{8 task, seed, steps per seed}

We apply $p-SSA_2$, $r-SSA_2$ ($Q^{rssa}_s=10I$) and $SSA$ to the eight test cases, each for 2000 steps.
We evaluate the tracking performance for arms $J_\mathrm{Arm}$, $C$ score and $S$ score computed independently for environment collision ($C_\mathrm{env}/S_\mathrm{env}$) and self-collision ($C_\mathrm{self}/S_\mathrm{self}$), and QP feasibility rate $R_\mathrm{Feas}$.
\Cref{fig: whole_body} and \Cref{fig: fixed_base} report the overall comparison.
See \cref{fig: sim_example} for examples of safety behaviors driven by the three methods.
See Appendix \ref{append:phi_compare} for the corresponding plot of (a) $\phi$ values for the left hand, (b) joint positions of the left elbow, and (c) joint positions of the left shoulder joint that mainly drive those safety behaviors.

\paragraph{QP Feasibility Rate}
We first focus on $R_\mathrm{Feas}$ (bottom of each plot).
Answering \textbf{Q1}, the QP is more likely to be infeasible with more obstacles (V0).
Comparing the robot modeling, the FixedBase variant also consistently makes QP easier to be infeasible due to the lack of mobility.
Finally, obstacle movements (DO) reduce feasibility score since the safe control computed at the current step might be made unsafe by dynamic obstacles.
Note that the naive SSA has higher $R_\mathrm{Feas}$ than other methods in many cases.
This is because naive SSA essentially ignores the obstacles if the QP is infeasible.
Since we disable the physical collision for simulated obstacles, the humanoid bodies can quickly swing through the obstacles and enter empty spaces.
That makes QPs solved by naive SSA to have less active constraints and easier to be feasible.
On the contrary, r-SSA and p-SSA normally enable the bodies to stay close to obstacles without collisions.
That keeps the number of active constraints high in the QPs to solve, making more QPs to be infeasible.



\paragraph{Minimizing Violations}

Since naive SSA directly passes the reference control upon infeasible QP, violations to control constraints are significant, resulting in negligible $C$ scores. 
Answering \textbf{Q2}, r-SSA and p-SSA significantly improve $C$ scores over naive SSA, meaning that they consistently reduce violations to control constraints when the QP is infeasible.
Comparing r-SSA to p-SSA, we see that p-SSA further out-performs r-SSA in terms of minimizing control constraint violations ($C$), and consequently minimizing safety constraint violations ($S$).
That is because p-SSA independently minimizes constraint violations, while r-SSA sometimes trades safety for performance (e.g., higher $J_\mathrm{Arm}$ in many cases).
In the next section, we perform ablation study to systematically investigate this issue.


% Such trend is also reflected in the $S$ scores, although the improvement may or may not match the scale of $C$ score improvement depending on the task.
% For instance, $S_\mathrm{env}$ is greatly improved as a result of improved $C_\mathrm{env}$ score for all DO tasks, while not being the case for SO tasks.
% That is because, the control constraints being violated only indicates that the safety condition is getting worse (e.g., moving towards obstacles), instead of directly signaling actual safety violation (e.g., actual collisions).
% In that case, dynamic obstacle may

\input{figure/ablation_plot}

\subsection{Ablations on Relaxation Methods}

In this section, we perform ablation on r-SSA to see different performance-safety trade-offs and compare to p-SSA.
To achieve that, we benchmark r-SSA again on all eight tasks with a comprehensive range of $Q_s^{rssa}$ values: $\lambda I$ for $\lambda=a\cdot 10^b$, $a\in[1,9],b\in[0,5]$.
We select $C_\mathrm{env}$ as the proxy for safety and $J_\mathrm{Arm}$ as the proxy for performance.
See \Cref{fig: ablation_study_whole} and \Cref{fig: ablation_study_fixed} for the result.
Each orange point represents the $(J_\mathrm{Arm}, C_\mathrm{env})$ scores for r-SSA with a specific $Q_s^{rssa}$ value.
Pareto fronts are plotted for r-SSA.
A point with some $Q_s^{rssa}$ value is on the front if it is Pareto-optimal, meaning that there is no other ${Q_s^{rssa}}'$ value that can improve r-SSA in both metrics over $Q_s^{rssa}$.
Hence, the pareto front represents the optimal performance-safety trade-off curve for each task.

In all tasks, we find that when $Q_s^{rssa}$ is small, r-SSA would allow large control constraint violations to gain tracking performance (e.g., high $J_\mathrm{Arm}$ ranges).
As $Q_s^{rssa}$ becomes larger, the tracking performance starts to degrade since the control constraints are respected more, and the constraint satisfaction score improves.
At some point,the constraint satisfaction may stop improving while the task performance still degrades (e.g., lower $J_\mathrm{Arm}$ ranges in \cref{fig:pareto_G1WholeBody_SG_DO_v0}, \cref{fig:pareto_G1FixedBase_SG_SO_v0} and \cref{fig:pareto_G1FixedBase_SG_SO_v1}).
Based on the pareto front plots, one would prefer some $Q_s^{rssa}$ value in the top safety performance region that has the highest tracking performance.
Such tuning, however, would be tedious and cannot generalize to different tasks because the pareto front varies a lot for different tasks.
% It is evident that r-SSA is prone to both being over-conservative (large $Q_s^{rssa}$ and low $J_\mathrm{Arm}$) and over-aggressive (small $Q_s^{rssa}$ and low $C_\mathrm{Env}$).
% Such issue is also task-dependent judging from the pareto fronts of different shapes and slopes.
% Hence it is hard to tune the parameters for r-SSA for general cases.
On the contrary, p-SSA automatically secures the sweet spot on the pareto fronts for all tasks.
Hence, answering \textbf{Q3}, while r-SSA can achieve optimal performance-safety trade-off with careful parameter tuning, p-SSA automatically achieves that with zero parameter tuning.



% \begin{figure*}[ht]
% \centering
%     \includegraphics[width=1.0\linewidth]{figure/g1_real.png}
%     \caption{Safe teleopration with real Unitree G1 humanoid. p-SSA rejects excessive movements when both arms are inside the cabinet (top), }
% \label{fig: real_g1_cabinet}
% \end{figure*}

\begin{figure*}[ht]
\centering
    \includegraphics[width=1.0\linewidth]{figure/cabinet_sim.png}
    \caption{Safe teleopration with simluated Unitree G1 humanoid. The humanoid tracks wrist position goals (green) sent by the tele-operator while avoiding collision with the cabinet modeled by a few planes (gray). }
\label{fig: sim_g1_cabinet}
\end{figure*}

\subsection{Safe Teleoperation on Unitree G1 Humanoid}

To demonstrate the practical application of p-SSA, we perform a safe teleoperation task with a Unitree G1 humanoid.
During tele-operation, the humanoid motions may not exactly match the expectation of the operator due to various factors such as imperfect motion retargeting, delay, and human errors.
A safety filter like p-SSA would be useful in preventing unwanted collisions and ease the burden of safety from the operator.
In specific, we consider a scenario where the operator tele-operates the humanoid to organize a cabinet with tight opening.
The humanoid needs to put both arms inside the cabinet to manipulate objects without self-collision or colliding with the cabinet with any of its body parts.
The robot needs to avoid multiple obstacles (e.g., sides of the cabinet) at the same time in a confined space, yielding a typical dexterous safety problem in cluttered environments.

To generate $u_\mathrm{ref}$, we implemented a tele-operation framework that projects human wrist locations in human waist frame to those in humanoid frames.
A nominal controller solves inverse kinematics (IK) to acquire the desired upper body joint positions, and generates joint velocity commands via PID without considering safety.
We implement p-SSA with the G1FixedBase model described in \cref{sec:robot_model}.
Collision volumes of the cabinet are modeled as planes.
The design of energy functions $\phi_i$ respects the same safety margins in \cref{sec:exp_setting}.
Human motions, humanoid locations and obstacle locations are all sensed by an Apple Vision Pro (AVP) wore by the operator.

We show this task with both a simulated robot in MuJoCo and a real G1 humanoid with the same AVP-based teleoperation framework.
In both cases, the operator is encouraged to perform risky actions to see how p-SSA kicks in.
In simulation (see \cref{fig: sim_g1_cabinet}), we can see that p-SSA effectively rejects unsafe nominal controls.
For instance, even when the tele-operation goals travel through the cabinet walls, the robot arms stay inside the cabinet instead of following the goals blindly.
With real hardware (see \cref{fig:teaser}), we observe that p-SSA is able to prevent collisions with multiple types of improper operator actions.
In both simulation and real experiments, partial control constraints have to be relaxed, as indicated by the purple lines connecting collision pairs.
Hence, answering \textbf{Q4}, p-SSA is able to mitigate infeasible QPs in practical scenarios, making itself a reliable approach to the problem of dexterous safety in cluttered environments.

% \ruic{compare hard SSA, single SSA, p-SSA}

% modeling robot:

% We further restrict scope of paper to upper body safety for humanoids.
% Hence choose ssa: availability of models, flexibility in adding constraints.

% Whole-body safety including legs imply additional challenge of enforcing balance while satisfying safety, left for future work, mention \cite{khazoom2022humanoid}.



