\newcommand{\uppervecYCoord}{0}
\newcommand{\lowervecYCoord}{-5.0}
\newcommand{\FigScale}{.2}
\newcommand{\NumTokens}{4}
\newcommand{\LogitLength}{6}

\begin{tikzpicture}

    \newcommand{\DiscSampleX}{4.2}
    \newcommand{\AutoRegBias}{2.5}
    \pgfmathsetmacro{\StartBox}{-6}
    \pgfmathsetmacro{\ConstraintX}{\StartBox + 6}
    \pgfmathsetmacro{\vecYOffset}{.7}
    \begin{scope}
        \fill[blue!10, rounded corners, ] (\StartBox, \lowervecYCoord-1.0) rectangle (\StartBox+3.0, \uppervecYCoord+2.2);
        \node[align=left] at (\StartBox+1.3, \uppervecYCoord+.7) {\large Discrete Bias \\ \large Sequence $B^t$};
        \DiscreteTokenVector{(\StartBox+2.5, \uppervecYCoord)}{4}{\FigScale}{red}    
        \node[align=left] at (\StartBox+1.3, \lowervecYCoord+\vecYOffset) {\large Discrete \\ \large Response \\ \large Sequence  $Y^t$};
        \DiscreteTokenVector{(\StartBox+2.5, \lowervecYCoord)}{4}{\FigScale}{blue}
    \end{scope}


    \pgfmathsetmacro{\gradfcoordY}{(\lowervecYCoord + \uppervecYCoord)/2 + .5}
    \node[align=left, thick, gray, draw] at (\ConstraintX, \gradfcoordY+1.02) {\large Compute distribution to \\ \large sample bias sequence};
    \node[align=left, ultra thick, red, draw] at (\ConstraintX, \gradfcoordY) {\large $\underset{j \in |V|}{\softmax}((\nabla f(B))_{i,j}(1 - \hat{b}_{i, j}))$};
    \draw[thick, dashed] (\StartBox + 3.1, \lowervecYCoord + \vecYOffset) -- (\StartBox + 3.5, \lowervecYCoord + \vecYOffset);
    \draw[thick, dashed] (\StartBox + 3.5, \lowervecYCoord + \vecYOffset) -- (\StartBox + 3.5, \lowervecYCoord+2.3);
    \draw[thick, dashed] (\StartBox + 3.5, \lowervecYCoord+2.3) -- (\ConstraintX, \lowervecYCoord+2.3);
    \draw[thick, dashed] (\ConstraintX, \lowervecYCoord+2.3) -- (\ConstraintX, \gradfcoordY-.55);
    \draw[->, thick, dashed] (\ConstraintX, \gradfcoordY+1.5) -- (\ConstraintX, \uppervecYCoord-.2);
    % \draw[thick, dashed] (\ConstraintX, \gradfcoordY+.4) -- (\ConstraintX, \uppervecYCoord+\vecYOffset);
    \pgfmathsetmacro{\BiasVecExplX}{\DiscSampleX + 1.3}
    \node[align=left, thick, gray, draw] at (\BiasVecExplX, \gradfcoordY+.85) {\large map bias tokens \\ \large to bias vectors};
    \node[align=left, ultra thick, purple, draw] at (\BiasVecExplX, \gradfcoordY) {\large $\tilde{b}_{i, j} = -||Mb_i - Mv_j||^2_2$};
    \draw[thick, dashed] (\BiasVecExplX, \uppervecYCoord-.2) -- (\BiasVecExplX, \uppervecYCoord-.7);
    \draw[->, thick, dashed] (\BiasVecExplX,\lowervecYCoord+2.6) -- (\BiasVecExplX, \lowervecYCoord+2.1);

    \begin{scope}[on background layer]
        \fill[gray!20, rounded corners, ] (\AutoRegBias-4,\uppervecYCoord-.2) rectangle (\AutoRegBias+4.8, \uppervecYCoord+2.2);
        \node[align=left] at (\AutoRegBias-3.1, \uppervecYCoord+.6) {\large $P(B | Y)$};
        \foreach \j in {0, ..., \NumTokens}{
            \SingleDarkSquareStack{(\AutoRegBias-2.3, \uppervecYCoord + \j*(\FigScale +.1 ))}{red}{\LogitLength}{\FigScale}
        }
        \DiscreteTokenVector{(\AutoRegBias + 3.0, \uppervecYCoord)}{4}{\FigScale}{purple}
        % \node[align=left] at (\AutoRegBias + 1.8, \uppervecYCoord+\vecYOffset) {\Large $\sim$};
        \draw[thick, ->] (\AutoRegBias - .75, \uppervecYCoord+\vecYOffset) -- (\AutoRegBias + 2.0, \uppervecYCoord+\vecYOffset);
        \node[align=left] at (\AutoRegBias + 2.5, \uppervecYCoord+\vecYOffset) {\large $B^{t+1}$};
        \node[align=left] at (\AutoRegBias+.25, \uppervecYCoord+1.8) {\Large Gradient-based \textbf{\underline{D}}iscrete Sampling};
    \end{scope}

    % \node[align=left, draw, ultra thick, gray] at (3.6, \uppervecYCoord+\vecYOffset) {\large $P^{LM}$};
    \begin{scope}
        \fill[gray!20, rounded corners, ] (\AutoRegBias-4.0,\lowervecYCoord-1.0) rectangle (\AutoRegBias+4.8, \lowervecYCoord+2.1);

        \draw[blue, ultra thick] (\AutoRegBias-3.5, \lowervecYCoord) rectangle (\AutoRegBias -2.5, \lowervecYCoord + 1.5);
        \node[align=left] at (\AutoRegBias-3.0, \lowervecYCoord+.75) {\large $P^{LM}$};
        \node[align=left] at (\AutoRegBias+.5, \lowervecYCoord-.5) {\Large \textbf{\underline{A}}uto-Regressive \textbf{\underline{B}}iasing};


        
        \foreach \j in {0, ..., \NumTokens}{
            \pgfmathsetmacro{\IncBiasX}{-1 * \j * \FigScale}
            \draw[<-, thick] (\AutoRegBias-.8+\IncBiasX, \lowervecYCoord + .1 +\j*(\FigScale+.1) -- (\AutoRegBias-2.4, \lowervecYCoord + .1+\j*(\FigScale+.1); 
            \SingleDarkSquareStack{(\AutoRegBias-.7+\IncBiasX, \lowervecYCoord + \j*(\FigScale+.1)}{blue}{\LogitLength}{\FigScale};
        }
        % \node[align=left] at (\AutoRegBias+2.5, \lowervecYCoord+\vecYOffset) {\large $\tilde{B}$};
        \foreach \j in {0, ..., \NumTokens}{
            \pgfmathsetmacro{\PlusCoordY}{\lowervecYCoord +.1 + \j*(\FigScale+.1)}
            \pgfmathsetmacro{\PlusCoordX}{1.65+\AutoRegBias}
            \pgfmathsetmacro{\IncBiasX}{-1 * \j * \FigScale}


            \node[align=left] at (\PlusCoordX + \IncBiasX - .5, \PlusCoordY) {\tiny $+$};
            \draw[->, thick] (\AutoRegBias+3+\IncBiasX, \lowervecYCoord + .1 +\j*(\FigScale+.1) -- (\AutoRegBias+4.0, \lowervecYCoord + .1+\j*(\FigScale+.1); 
            \SingleDarkSquareStack{(\AutoRegBias+1.5+\IncBiasX, \lowervecYCoord +\j*(\FigScale+.1)}{purple}{\LogitLength}{\FigScale}
            \draw[green!70!black, thick] (\AutoRegBias+4.2, \lowervecYCoord +\j*(\FigScale+.1) rectangle (\AutoRegBias+4.4, \FigScale + \lowervecYCoord +\j*(\FigScale+.1); 
        }

        \draw[thick] (\AutoRegBias+4.3, \lowervecYCoord + 1.5) -- (\AutoRegBias+4.3, \lowervecYCoord + 1.9); 
        \draw[thick] (\AutoRegBias+4.3, \lowervecYCoord + 1.9) -- (\AutoRegBias-3.0, \lowervecYCoord + 1.9); 
        \draw[thick, ->] (\AutoRegBias-3.0, \lowervecYCoord + 1.9) -- (\AutoRegBias-3.0, \lowervecYCoord + 1.7); 


    \end{scope}

    \pgfmathsetmacro{\GreenBoxStart}{\AutoRegBias + 6.25}
    \draw[->, thick] (\AutoRegBias + 4.8, \lowervecYCoord + \vecYOffset) -- (\GreenBoxStart, \lowervecYCoord + \vecYOffset);
    \draw[->, thick] (\AutoRegBias + 4.8, \uppervecYCoord + \vecYOffset) -- (\GreenBoxStart, \uppervecYCoord + \vecYOffset);

    \begin{scope}
        \fill[green!10, rounded corners, ] (\GreenBoxStart, \lowervecYCoord-1.0) rectangle (\GreenBoxStart+2.5, \uppervecYCoord+2.2);

        \DiscreteTokenVector{(\GreenBoxStart+1.5, \uppervecYCoord )}{4}{\FigScale}{purple}
        \DiscreteTokenVector{(\GreenBoxStart+1.5, \lowervecYCoord )}{4}{\FigScale}{green!70!black}
        \node[align=left] at (\GreenBoxStart+.8, \uppervecYCoord+\vecYOffset) {\large $B^{t+1}$};
        \node[align=left] at (\GreenBoxStart+.8, \lowervecYCoord+\vecYOffset) {\large $Y^{t+1}$};
    \end{scope}


\end{tikzpicture}