\section{A Formal Specification for Remote Attestation}
\label{sec:vra}
%
In this section, we present our formal specification of remote
attestation and verify it is secure against forgery.
%
Again, we start with the definition of the packages.

%
Based on the perfect indistinguishability for
digital signatures, we seek to provide the same
security guarantee for remote attestation.
%
Indeed, we prove that the security of the remote
attestation protocol is based on the securiy of the
digital signature protocol.
%
Our development starts with the definition
of the remote attestation primitives, protocol
and security game.
% 
Afterwards, we reduce the advantage for an
attacker that plays the security game for remote 
attestation to the advantage of playing the 
security game for digital signatures.
%
From this, we conclude perfect indistinguisabilty
for remote attestation.
%

\subsection{Packages}

\begin{figure}
  \centering
  \input{tikz/aux.tex}	
  \caption{Package for RA primitives.}
  \label{fig:att:prim}
\end{figure}

\begin{figure}
	\centering
  \begin{subfigure}[b]{\columnwidth}
      \centering
    \input{tikz/auxprot.tex}	
	\caption{Using the signature protocol.}
	\label{fig:att:prot}
  \end{subfigure}
  \\[0.3cm]
  \begin{subfigure}[b]{\columnwidth}
      \centering
    \input{tikz/attprot-pkg.tex}	
	\caption{Using the attestation primivites.}
	\label{fig:att:protprim}
  \end{subfigure}
  \caption{The two variants to construct the RA protocol.}
  \label{fig:att}
\end{figure}


%
We define packages for the primitives (\pattprot$^\prime$) and 
the respective protocol for remote attestation (\pattprot) 
in Figure~\ref{fig:att}.
%
The remote attestation protocol attests that a remote
server is in a particular state.
%
Hence, both packages define an abstract \ststate $\mathcal{ST}$.
%
To establish the reduction argument, both definitions
import the respective signature procedures.
%
\pattprim (as shown in Figure~\ref{fig:att:prim}) imports the procedures from the digital signature
primitives (Figure~\ref{fig:sigprim}), while \pattprot extends 
the protocol for digital signatures (Figure~\ref{fig:sigprot}).
%
Remote attestation provides primitives with a way to 
acquire a public key (\egetpka), 
issue an attestation for a challenge $c$ (\eattest), and
\everifya that a challenge $c$ was attested with $a$.
%
The attestation is a tuple that contains the hashed state
and the respective signature over this state.
%
To prevent replay, the attestation of a state is also tied to a unique, 
fresh challenge \(c\), provided by the verifier.
%

%
Implementing the attestation has implications for the assumptions of the \ststate $\mathcal{ST}$.
%
The \everifya version in Figure~\ref{fig:att:prim} requires 
a challenge \icoq{c} and
the signature part of the attestation \icoq{a}.
%
Based on \icoq{c}, the procedure computes a 
hash \icoq{m} from the \emph{current} state to verify it 
against the signature \icoq{a}.
%
The code assumes that the state is constant, i.e.,
it never changes.
%
This is a valid assumption from most remote attestation setups
that seek to attest that, for example, an operating system booted 
into a secure state.
%
The code would require the full attestation as input 
for more fine-grained periodic checks over the evolving state.
%
Instead of hashing the current state, the hash part of the
attestation would be directly inputted into the \eversig (as shown in Figure~\ref{fig:sigprim}) procedure.
%
For the proof of indistinguishability, both versions have the same result.
%
Hence, we stick with the constant-state version listed in
Figure~\ref{fig:att:prim}.
%
As we now know, perfect indistinguishability ensures the adversary 
cannot differentiate between valid attestation in our remote attestation settings.
%
The concept of collision resistance prevents malicious 
attempts to forge valid attestation through collisions.
%
In \ssprove, this concept is used as \emph{injective} (\emph{uncurry Hash}), which allows proofs to 
leverage collision resistance to demonstrate that it is computationally infeasible 
to find distinct inputs that map to the same hash output. 
%
In other words, it declares that the hash function (\emph{Hash}) is 
injective when applied to pairs of inputs via uncurry. 
%

\subsection{Security Reduction and Indistinguishability for Protocols}

\begin{figure}
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
Definition AttProt&$_{\text{\real}}^{\text{Prim}}$& :=&\spacer{0.2cm}&
  {package AttProt&$^{\prime}$& &$\circledcirc$& AttPrim &$\circ$& SigPrim&$_{\text{\real}}$& &$\circ$& KeyGen}.&\spacer{0.3cm}&
Definition AttProt&$_{\text{\ideal}}^{\text{Prim}}$& :=&\spacer{0.2cm}&
  {package AttProt&$^{\prime}$& &$\circledcirc$& AttPrim &$\circ$& SigPrim&$_{\text{\ideal}}$& &$\circ$& KeyGen}.&\spacer{0.3cm}&
Definition AttProt&$_{\text{\real}}^{\text{Prot}}$& := {package AttProt &$\circledcirc$& SigProt&$_{\text{\real}}$&}.&\spacer{0.3cm}&
Definition AttProt&$_{\text{\ideal}}^{\text{Prot}}$& := {package AttProt &$\circledcirc$& SigProt&$_{\text{\ideal}}$&}.
    \end{minted}
   \caption{Packages for remote attestation.}
   \label{fig:attprots}
\end{figure}

%
To reduce the security of remote attestation
to the security of digital signatures and prove the 
indistinguishability, we need to define \real
and \ideal packages for the remote attestation protocol.
%
We derive those directly from the respective 
digital signature versions.
%
In Figure~\ref{fig:attprots}, we compose \real %(\ref{fig:attprotprim:real}) 
and \ideal packages %(\ref{fig:attprotprim:ideal}) 
from the attestation primitives.
%
Furthermore, we compose \real %(\ref{fig:attprotprot:real}) 
and 
\ideal packages %(\ref{fig:attprotprot:ideal}) 
from the attestation protocol.
%
With these packages in place, we start our proof
development.
%

%
We connect the \real and \ideal versions of the
remote attestation protocol via refinement as follows.
%
\begin{lemma}[%\pattprot$_{\text{\real}}$-$\mathcal{G}_{\text{\pindist}}^{\Sigma}$: 
    Perfect Indistinguishability of \real Attestation Protocols]\label{lem:real}
    For every attacker \A, the advantage to distinguish
    the \real packages for remote attestation is $0$:
    \begin{center}
        \begin{minipage}{0.5\columnwidth}
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
AttProt&$_{\text{\real}}^{\text{Prim}}$& &$\pindist$& AttProt&$_{\text{\real}}^{\text{Prot}}$&.
    \end{minted}
    \end{minipage}
    \end{center}
\end{lemma}
%
\begin{IEEEproof}
    %
    We first inline the procedures for the remote 
    attestation primitives in \pattprot$_{\text{\real}}^{_\text{Prim}}$.
    %
    Afterwards, we inline \psigprot in \pattprot$_{\text{\real}}^{_\text{Prot}}$.
    %
    Recomputing the hash in \everifya is canceled
    out by the fact that \psigprot reuses the message,
    in this case the hashed state, as input to \esign
    and \eversig.
    %
    The rest of the proof by application of the rules
    in the relational Hoare logic.
    %
\end{IEEEproof}
%
\begin{lemma}[%\pattprot$_{\text{\ideal}}$-$\mathcal{G}_{\text{\pindist}}^{\Sigma}$: 
    Perfect Indistinguishability for \ideal Attestation Protocols]\label{lem:ideal}
    For every attacker \A, the advantage to distinguish
    the \ideal packages for remote attestation is $0$: 
    \begin{center}
        \begin{minipage}{0.5\columnwidth}
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
AttProt&$_{\text{\ideal}}^{\text{Prim}}$& &$\pindist$& AttProt&$_{\text{\ideal}}^{\text{Prot}}$&.
    \end{minted}
    \end{minipage}
    \end{center}
\end{lemma}
%
\begin{IEEEproof}
%
The proof reasoning is anlogous to
the proof of Lemma~\ref{lem:real}.
%
\end{IEEEproof}
%
We now state our reduction theorem:
%
\begin{theorem}[%\icoq{AttProt}-$\leq$-\icoq{SigProt_}: 
    Security reduction for remote attestation]\label{theo:redprot}
  %
  For every attacker \A, the advantage to distinguish 
  the packages \pattprot$_{\text{\real}}^{\text{Prim}}$ and \pattprot$_{\text{\ideal}}^{\text{Prim}}$
  less than or equal to the advantage to distinguish 
  the packages: \psigprot$_{\text{\real}}$ and \psigprot$_{\text{\ideal}}$
  %
  \begin{center}
      \begin{minipage}{0.8\columnwidth}
     \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
  &$\forall$& A,&\spacer{0.1cm}& 
    Adv A             AttProt&$_{\text{\real}}^{\text{Prim}}$& AttProt&$_{\text{\ideal}}^{\text{Prim}}$& &$\leq$& &\spacer{0.1cm}&
    Adv (A &$\circ$& AttProt) SigProt&$_{\text{\ideal}}$& SigProt&$_{\text{\real}}$&.
    \end{minted}
     \end{minipage}
  \end{center}
\end{theorem}
%
\begin{IEEEproof}
    %
    SSProve allows us to use the following equalities:
    %
    \begin{center}
    \begin{minipage}{0.9\columnwidth}
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble,linenos]{coq}
Adv (A &$\circ$& AttProt) SigProt&$_{\text{\ideal}}$& SigProt&$_{\text{\real}}$& &\spacer{0.2cm}&
= Adv A (AttProt &$\circ$& SigProt&$_{\text{\ideal}}$& (AttProt &$\circ$& SigProt&$_{\text{\real}}$&)&\spacer{0.2cm}&
= Adv A AttProt&$_{\text{\real}}^{\text{Prot}}$& AttProt&$_{\text{\real}}^{\text{Prot}}$&
    \end{minted}
    \end{minipage}
    \end{center}
    %
    The first equality (Line~2) is achieved by the reduction of the lemma in \ssprove
    (as shown in their Lemma~2.3~\cite{ssprove}).
    %
    The second equality (Line~3) is, by definition, of the 
    packages for remote attestation (Figure~\ref{fig:attprots}).
    %
    Our goal then becomes:
    %
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
&$\forall$& A, 
Adv A AttProt&$_{\text{\real}}^{\text{Prim}}$& AttProt&$_{\text{\ideal}}^{\text{Prim}}$& &$\leq$& Adv A AttProt&$_{\text{\real}}^{\text{Prot}}$& AttProt&$_{\text{\ideal}}^{\text{Prot}}$&.
    
    \end{minted}
    % 
    We define a triangle inequality
    (as shown in their Lemma~2.2~\cite{ssprove}), and use transitivity of the 
    inequality ($\leq$) to obtain:
    %
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
Adv A AttProt&$_{\text{\real}}^{\text{Prim}}$& AttProt&$_{\text{\real}}^{\text{Prot}}$&&\spacer{0.2cm}&
+ Adv A AttProt&$_{\text{\real}}^{\text{Prot}}$& AttProt&$_{\text{\ideal}}^{\text{Prot}}$&&\spacer{0.2cm}&
+ Adv A AttProt&$_{\text{\ideal}}^{\text{Prot}}$& AttProt&$_{\text{\ideal}}^{\text{Prim}}$&&\spacer{0.2cm}&
&$\leq$& Adv A AttProt&$_{\text{\real}}^{\text{Prot}}$& AttProt&$_{\text{\ideal}}^{\text{Prot}}$&.
    \end{minted}
    %
    By symmetry of games and Lemmas~\ref{lem:real} 
    and \ref{lem:ideal}, our goal reduces to:
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
                0
              + Adv A AttProt&$_{\text{\real}}^{\text{Prot}}$& AttProt&$_{\text{\ideal}}^{\text{Prot}}$&
              + 0
              &$\leq$& Adv A AttProt&$_{\text{\real}}^{\text{Prot}}$& AttProt&$_{\text{\ideal}}^{\text{Prot}}$&.
  \end{minted}
  %
  Clearly, this holds by the
  left and right identity of addition and
  the definition of $\leq$ itself.
  %
\end{IEEEproof}
%
Based on this result, we claim
perfect indistinguishability for the 
remote attestation protocol.
%
\begin{theorem}[%\icoq{AttProt_}$\mathcal{G}_{\text{\pindist}}^{\Sigma}$: 
    Perfect Indistinguishability of Remote Attestation]\label{theo:indist-ra}
  %
  For every attacker \A, the advantage to distinguish the packages
  \pattprot$_{\text{\real}}^{\text{Prim}}$ and \pattprot$_{\text{\ideal}}^{\text{Prim}}$ is $0$:
  %
     \begin{center}
        \begin{minipage}{0.5\columnwidth}
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
AttProt&$_{\text{\real}}^{\text{Prim}}$& &$\pindist$& AttProt&$_{\text{\ideal}}^{\text{Prim}}$&.
    \end{minted}
    \end{minipage}
    \end{center}
\end{theorem}
%
\begin{IEEEproof}
    %
    To prove that
    %
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
Adv A AttProt&$_{\text{\real}}^{\text{Prim}}$& AttProt&$_{\text{\ideal}}^{\text{Prim}}$& &$\leq$& 0

    \end{minted}
    %
    we apply our 
    Reduction Theorem~\ref{theo:redprot}.
    %
    The goal changes into:
    %
     \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
Adv (A &$\circ$& AttProt) SigProt&$_{\text{\ideal}}$& SigProt&$_{\text{\real}}$& &$\leq$& 0
    \end{minted}
    %
    This holds by perfect indistinguishability
    of digital signatures (Theorem~\ref{theo:indist-signature}),
    even for an attacker \A{} that runs the
    attestation protocol \pattprot.
    %
\end{IEEEproof}

\subsection{Security Reduction for Primitives}
\label{sec:coll}

\begin{figure}
    \centering
    \input{tikz/att-real-vs-ideal}
    \caption{Game for Remote Attestation Primitives}
    \label{fig:att:prim:game}
\end{figure}
\begin{figure}
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
Definition SigPrimAtt&$_{\text{\real}}$& :=
  {package AttPrim &$\circ$& SigPrim&$_{\text{\real}}$& &$\circ$& KeyGen}.

Definition SigPrimAtt&$_{\text{\ideal}}$& :=
  {package AttPrim &$\circ$& SigPrim&$_{\text{\ideal}}$& &$\circ$& KeyGen}.

Definition AttPrimSig&$_{\text{\real}}$& :=
  {package AttPrim&$_{\text{\real}}$& &$\circ$& SigPrim&$_{\text{\real}}$& &$\circ$& KeyGen}.
  
Definition AttPrimSig&$_{\text{\ideal}}$& :=
  {package AttPrim&$_{\text{\ideal}}$& &$\circ$& SigPrim&$_{\text{\ideal}}$& &$\circ$& KeyGen}.
   \end{minted}
   \caption{Packages for Remote Attestation primitives.}
   \label{fig:attprims}
\end{figure}


%
We go one step further and also
the security of the remote attestation
primitives to the security of the
primitives of the digital signature.
%
In order to do so, we define semantics
for the attestation primitives in 
Figure~\ref{fig:att:prim:game}.
%
The additional state $\mathcal{Z}$ associates
a challenge $c$ with an attestation signature $a$.
%
In the \everifya procedure, we probe
$\mathcal{Z}$.
%

%
Note that the \real of \pattprim equals to the
\pattprim from Figure~\ref{fig:att:prim}.
%
In Figure~\ref{fig:attprims}, we use
\pattprim as an auxilary package to lift
the digital signature primitives to the
remote attestation primitives.
%
We use the \real of \pattprim to compose the final
package of the remote attestation primitives
game from Figure~\ref{fig:att:prim:game}.
%

%
The following two lemmas provide the
setup for the reduction proof. 
%

\begin{lemma}[%\pattprim$_{\text{\real}}$-$\mathcal{G}_{\text{\pindist}}^{\Sigma}$: 
    Perfect Indistinguishability for \real Attestation Primitives]\label{lem:prim:real}
    For every attacker \A, the advantage to distinguish
    the \real packages for remote attestation primitives
    is $0$: 
    \begin{center}
        \begin{minipage}{0.5\columnwidth}
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
SigPrimAtt&$_{\text{\real}}$& &$\pindist$& AttPrimSig&$_{\text{\real}}$&.
    \end{minted}
    \end{minipage}
    \end{center}
\end{lemma}
%
\begin{IEEEproof}
    %
    The proof is by reflexivity on the fact
    that \pattprim and \pattprim$_{\real}$ are
    equal.
    %
\end{IEEEproof}
%
\begin{lemma}[%\pattprim$_{\text{\real}}$-$\mathcal{G}_{\text{\pindist}}^{\Sigma}$: 
    Perfect Indistinguishability for \ideal Attestation Primitives]\label{lem:prim:ideal}
    For every attacker \A, the advantage to distinguish 
    the \ideal packages for remote attestation primitives
    is $0$: 
    \begin{center}
        \begin{minipage}{0.5\columnwidth}
    \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
SigPrimAtt&$_{\text{\ideal}}$& &$\pindist$& AttPrimSig&$_{\text{\ideal}}$&.
    \end{minted}
    \end{minipage}
    \end{center}
\end{lemma}
%
\begin{IEEEproof}
    %
    Instead of discarding the new memory location
    $\mathcal{Z}$ in \pattprim$_{\ideal}$, our proof 
    connects it to the $\mathcal{SIG}$ 
    location in \psigprim$_{\ideal}$ with the
    following invariant:
    %
\begin{minted}[escapeinside=@@,fontsize=\footnotesize,autogobble]{Coq}
 @$\lambda$@ (s@$_1$@,s@$_2$@), heap_ignore @$\{\mathcal{Z}\}$@ (s@$_1$@,s@$_2$@) @$\land$@
            Z_to_SIG s@$_2$@.@$\mathcal{Z}$@ s@$_2$@.@$\mathcal{ST}$@ = s@$_1$@.@$\mathcal{SIG}$@.
\end{minted}
    %
    The \hignore invariant defines equality on
    all state location except $\mathcal{Z}$.
    %
    The function \ztosig translates $\mathcal{Z}$
    to $\mathcal{SIG}$ via the hash function $\mathcal{H}$.
    %
\begin{minted}[escapeinside=@@,fontsize=\footnotesize,autogobble]{Coq}
Definition h_to_sig @$\mathcal{Z}$@ @$\mathcal{ST}$@:
  let s := @$\mathcal{ST}$@ in
  map (@$\lambda$@ (c,a), (@$\mathcal{H}$@ c s, a)) @$\mathcal{Z}$@.
\end{minted}
   %
    %
    The proof consists of three proof obligations, one per procedure.
    %
    The details are in our proof development.
    %
    The most interesting part is in the proof obligation
    for \everifya, where we have to establish the
    following equality:
    %
\begin{minted}[escapeinside=@@,fontsize=\footnotesize,autogobble]{Coq}
(@$\mathcal{H}$@ c@$_1$@ s@$_1$@, a) @$\in$@ @$\mathcal{SIG}$@ = (c, a) @$\in$@ @$\mathcal{Z}$@ 
\end{minted}
    %
    By applying our invariant and rewriting the left-hand side, we derive:
    %
\begin{minted}[escapeinside=@@,fontsize=\footnotesize,autogobble]{Coq}
(@$\mathcal{H}$@ c@$_1$@ s@$_1$@, a) = (@$\mathcal{H}$@ c@$_2$@ s@$_2$@, a) 
\end{minted}
    %
    Note that the challenges and the states do not
    unify immediately because c$_2$ and s$_2$ come from
    the invariant.
    %
    But unification only arises in the relational Hoare logic
    reasoning.
    %
    To solve this goal, we need a vital property of the hash
    function $\mathcal{H}$; collision-resistance, a.k.a., injectivity.
    %
\end{IEEEproof}
%
\begin{hypothesis}[Collision-Resistance]
    Any hash function $\mathcal{H}$ used in remote attestation
    must be injective:
    %
    \begin{center}
    \begin{minipage}{0.7\columnwidth}
\begin{minted}[escapeinside=@@,fontsize=\footnotesize,autogobble]{Coq}
@$\forall$@ c@$_1$@ s@$_1$@ c@$_2$@ s@$_2$@,
  @$\mathcal{H}$@ c@$_1$@ s@$_1$@ = @$\mathcal{H}$@ c@$_2$@ s@$_2$@ -> c@$_1$@ = c@$_2$@ @$\land$@ s@$_1$@ = s@$_2$@.
\end{minted}
    \end{minipage}
    \end{center}
\end{hypothesis}
%
\begin{theorem}[%\icoq{AttPrim}-$\leq$-\icoq{SigPrim_}: 
    Security reduction for Remote Attestation primtives]\label{theo:redprim}
  %
  For every attacker \A, the advantage to distinguish 
  the packages \pattprim$_{\text{\real}}$ and \pattprim$_{\text{\ideal}}$
  less than or equal to the advantage to distinguish 
  the packages: \psigprim$_{\text{\real}}$ and \psigprim$_{\text{\ideal}}$
  %
  \begin{center}
      \begin{minipage}{0.8\columnwidth}
     \begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
  &$\forall$& A,&\spacer{0.1cm}& 
    Adv A             AttPrim&$_{\text{\real}}$& AttPrim&$_{\text{\ideal}}$& &$\leq$& &\spacer{0.1cm}&
    Adv (A &$\circ$& AttPrim) SigPrim&$_{\text{\ideal}}$& SigPrim&$_{\text{\real}}$&.
    \end{minted}
     \end{minipage}
  \end{center}
\end{theorem}
%
\begin{IEEEproof}
    %
    The proof follows the same structure as the reduction proof for the 
    protocols (Theorem~\ref{theo:redprot}):
    %
    We use the triangle inequality and afterwards apply 
    Lemmas~\ref{lem:prim:real} and \ref{lem:prim:ideal}.
    %
    The details are in the proof development associated with this paper.
    %
\end{IEEEproof}
%
Ideally, we would now follow up with a theorem that
states perfect indistinguishability for the primitives of
the digital signatures.
%
The following section shows that the according proof is
currently not possible in frameworks such as SSProve.
%
