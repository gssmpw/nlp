\begin{tikzpicture}[
	font=\footnotesize,
	node distance=0.3cm
	]
	\node[] (real) at (0,0)  {
		\psigprim$_{\text{\real}}$
	};
	\node[] (code-r) [below = 0.75cm of P] {
		\begin{minipage}{0.45\columnwidth}
			\begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
get_pk() :=
  #import key_gen ;;

  (_,pk) <- key_gen tt ;;
  #ret pk

sign(m) :=
  sk <- #get @&$\mathcal{SK}$& ;;
  let &$\sigma$& := &$\Sigma$&.Sign sk m ;;



  #ret &$\sigma$&

ver_sig(m,s) :=
  pk <- #get @&$\mathcal{PK}$& ;;
  #ret &$\Sigma$&.VerSig pk s m
			\end{minted}
		\end{minipage}
	};
	\node[] (state-r) [above right = 0cm and 0cm of code-r.north west] {
	\begin{minipage}{0.45\columnwidth}
		\begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
&$\mathcal{SK}$& : SecKey, &$\mathcal{PK}$& : PubKey
&\phantom{$\mathcal{SIG}$}&
		\end{minted}
	\end{minipage}
	};

	% Package frame and stuff
  \draw[] (code-r.north west) -- (code-r.north east);
	\draw[] (code-r.north west) |- (state-r.north) -| (code-r.north east);
	\draw[] (state-r.north west) |- (real.north) -| (code-r.north east);
	\draw[] (code-r.north east) |- (code-r.south) -| (code-r.north west);

    %%%%%%%% Ideal %%%%%%%%%%%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%

    \node[] (ideal) [right = 2.5 cm of real]  {
      \psigprim$_{\text{\ideal}}$
    };
    \node[] (code-i) [below = 0.75cm of ideal] {
    	\begin{minipage}{0.45\columnwidth}
    		\begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble,highlightlines={10,11,12,16,17},highlightcolor=lYellow!20]{coq}
get_pk() :=
  #import key_gen ;;

  (_,pk) <- key_gen tt ;;
  #ret pk

sign(m) :=
  sk <- #get @&$\mathcal{SK}$& ;;
  let s := &$\Sigma$&.Sign sk m ;;
  S <- #get @&$\mathcal{SIG}$& ;;
  let S' := S &$\cup$& {(m,s)} ;;
  #put @&$\mathcal{SIG}$& S' ;;
  #ret s

ver_sig(m, s) :=
  S <- #get @&$\mathcal{SIG}$& ;;
  #ret ( (m,s) &$\in$& S )
    		\end{minted}
    	\end{minipage}
    };
    \node[] (state-i) [above right = 0cm and 0cm of code-i.north west] {
    	\begin{minipage}{0.45\columnwidth}
    		\begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble,highlightlines={2},highlightcolor=lYellow!20]{coq}
&$\mathcal{SK}$&: SecKey, &$\mathcal{PK}$&: PubKey,
&$\mathcal{SIG}$&: (Message x Signature)
    		\end{minted}
    	\end{minipage}
    };

    % Package frame and stuff
    \draw[] (code-i.north west) -- (code-i.north east);
    \draw[] (code-i.north west) |- (state-i.north) -| (code-i.north east);
    \draw[] (state-i.north west) |- (ideal.north) -| (code-i.north east);
    \draw[] (code-i.north east) |- (code-i.south) -| (code-i.north west);

\end{tikzpicture}
