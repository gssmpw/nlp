\begin{tikzpicture}[
	font=\footnotesize,
	node distance=0.3cm
	]
	\node[] (real) at (0,0)  {
		\pattprim$_{\text{\real}}$
	};
	\node[] (code-r) [below = 0.75cm of P] {
		\begin{minipage}{0.45\columnwidth}
			\begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
get_pk&$^a$&()
  &\kimport& get_pk ;;
  pk <- get_pk ;;
  &\kret& pk
 
attest(c)
  &\kimport& sign;;
  s <- &\kget& @&$\mathcal{ST}$&
  #let m := &$\mathcal{H}$& s c ;;
  a <- sign m ;;



  &\kret& (a,m)

verify&$^a$&(c,a)
  &\kimport& verify ;;
  s <- &\kget& @&$\mathcal{ST}$& ;;
  #let m := &$\mathcal{H}$& s c ;;
  &\kret& verify a m
	        \end{minted}
		\end{minipage}
	};
	\node[] (state-r) [above right = 0cm and 0cm of code-r.north west] {
	\begin{minipage}{0.45\columnwidth}
		\begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble]{coq}
&$\mathcal{ST}$& : State
&$\phantom{\mathcal{Z}}$&
	\end{minted}
	\end{minipage}
	};

	% Package frame and stuff
  \draw[] (code-r.north west) -- (code-r.north east);
	\draw[] (code-r.north west) |- (state-r.north) -| (code-r.north east);
	\draw[] (state-r.north west) |- (real.north) -| (code-r.north east);
	\draw[] (code-r.north east) |- (code-r.south) -| (code-r.north west);

    %%%%%%%% Ideal %%%%%%%%%%%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%

    \node[] (ideal) [right = 2.5 cm of real]  {
      \pattprim$_{\text{\ideal}}$
    };
    \node[] (code-i) [below = 0.75cm of ideal] {
    	\begin{minipage}{0.45\columnwidth}
    		\begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble,highlightlines={11,12,13,18,20},highlightcolor=lYellow!20]{coq}
get_pk&$^a$&()
  &\kimport& get_pk ;;
  pk <- get_pk ;;
  &\kret& pk
 
attest(c)
  &\kimport& sign ;;
  s <- &\kget& @&$\mathcal{ST}$& ;;
  #let m := &$\mathcal{H}$& s c ;;
  a <- sign m ;;
  Z <- &\kget& @&$\mathcal{Z}$& ;;
  let Z' := Z &$\cup$& {(c,a)} ;;
  &\kput& @&$\mathcal{Z}$& Z' ;;
  &\kret& (a,m)

verify&$^a$&(c,a)
  
  Z <- &\kget& @&$\mathcal{Z}$& ;;

  &\kret& ( (c,a) &$\in$& Z )
    		\end{minted}
    	\end{minipage}
    };
    \node[] (state-i) [above right = 0cm and 0cm of code-i.north west] {
    	\begin{minipage}{0.45\columnwidth}
    		\begin{minted}[fontsize=\footnotesize,escapeinside=&&,autogobble,highlightlines={2,3},highlightcolor=lYellow!20]{coq}
&$\mathcal{ST}$&: State,
&$\mathcal{Z}$&: (Challenge x Signature)
    		\end{minted}
    	\end{minipage}
    };

    % Package frame and stuff
    \draw[] (code-i.north west) -- (code-i.north east);
    \draw[] (code-i.north west) |- (state-i.north) -| (code-i.north east);
    \draw[] (state-i.north west) |- (ideal.north) -| (code-i.north east);
    \draw[] (code-i.north east) |- (code-i.south) -| (code-i.north west);

\end{tikzpicture}
