\begin{tikzpicture}[
    pkg/.style={draw,align=center,minimum height=1.5cm, minimum width=1.5cm},
    prot/.style={draw,align=center,minimum height=1.1cm},
    real/.style={fill=lGray!20},
    ideal/.style={fill=lYellow!20},
    imp/.style={rounded corners,draw,align=center,minimum height=0.5cm, minimum width = 3cm},
    imp2/.style={rounded corners,draw,align=center,minimum height=0.5cm, minimum width = 11cm},
    node distance=0.3cm,
    font=\footnotesize
  ]
    % Key Gen
  \node[pkg] (kg1) at (0,0) { \texttt{KeyGen}\\(\ref{fig:keygen:package}) };

    % RSA
  \node[pkg,dashed] (rsa) [below right = 1.5cm and -1cm  of kg1] { $\Sigma$ := RSA\\(\ref{sec:rsa}) };
  
    % Sig Prim
    \node[pkg,real]  (sig1) [above right = 0cm and 1.75cm of kg1] { 
        \texttt{SigPrim}\\
        (\ref{fig:problem:eu},~\ref{fig:sigprim})
    };
    \node[pkg,ideal] (sig2) [below right = 0cm and 1.75cm of kg1] {
        \texttt{SigPrim}\\
        (\ref{fig:problem:eu},~\ref{fig:sigprim}) 
    };
 
    % Prot
    \node[pkg,real]  (sigprot1) [right = 1.5cm of sig1] { 
        \sigprot\\
        (\ref{fig:problem:eu-ind},~\ref{fig:pprot})
    };
    \node[pkg,ideal] (sigprot2) [right = 1.5cm of sig2] { 
        \sigprot\\
        (\ref{fig:problem:eu-ind},~\ref{fig:pprot}) 
    };
 
    \node[pkg,real]  (attprot3) [right = 1cm of sigprot1] { 
        \attprot\\
        (\ref{fig:att:prot})
    };
    \node[pkg,ideal] (attprot4) [right = 1cm of sigprot2] { 
        \attprot\\
        (\ref{fig:att:prot})
    };
 
    \node[align=center] (ind1) [right = 0.25cm of attprot3] { $\pindist$\\(\ref{lem:real}) };
    \node[align=center] (ind2) [right = 0.25cm of attprot4] { $\pindist$\\(\ref{lem:ideal}) };
    
    \node[pkg,real]  (attprot1) [right = 0.25cm of ind1] { 
        \attprot$^\prime$\\
        (\ref{fig:att:protprim})
    };
    \node[pkg,ideal] (attprot2) [right = 0.25cm of ind2] { 
        \attprot$^\prime$\\
        (\ref{fig:att:protprim})
    };
 
    % RA Prim
    \node[pkg,real]  (ra1) [right =1.5cm of attprot1] { 
        \texttt{AttPrim}\\
        (\ref{fig:att:prim}) 
    };
    \node[pkg,ideal] (ra2) [right = 1.5cm of attprot2] {  
        \texttt{AttPrim}\\
        (\ref{fig:att:prim}) 
    };

    %% Exports/Imports
    % KeyGen
    \draw[]
    ([xshift=0.05cm]kg1.east)
    --node[midway,above]{\texttt{key\_gen}}
    ([xshift=1.25cm]kg1.east);
  
    \draw[->] ([xshift=1.25cm]kg1.east) |- ([xshift=-0.05cm]sig1.west);
    \draw[->] ([xshift=1.25cm]kg1.east) |- ([xshift=-0.05cm]sig2.west);
  
    % SigPrim
    \draw[->]
    ([xshift=0.05cm,yshift=0.5cm]sig1.east)
    -- node[midway,above]{\texttt{get\_pk}}
    ([xshift=-0.05cm,yshift=0.5cm]sigprot1.west);
    \draw[->]
    ([xshift=0.05cm,yshift=0.5cm]sig2.east)
    -- node[midway,above]{\texttt{get\_pk}}
    ([xshift=-0.05cm,yshift=0.5cm]sigprot2.west);

    \draw[->]
    ([xshift=0.05cm,yshift=0cm]sig1.east)
    --node[midway,above]{\texttt{sign}}
    ([xshift=-0.05cm,yshift=0cm]sigprot1.west);
    \draw[->]
    ([xshift=0.05cm,yshift=0cm]sig2.east)
    --node[midway,above]{\texttt{sign}}
    ([xshift=-0.05cm,yshift=0cm]sigprot2.west);
  
    \draw[->]
    ([xshift=0.05cm,yshift=-0.5cm]sig1.east)
    --node[midway,above]{\texttt{ver\_sig}}
    ([xshift=-0.05cm,yshift=-0.5cm]sigprot1.west);
    \draw[->]
    ([xshift=0.05cm,yshift=-0.5cm]sig2.east)
    --node[midway,above]{\texttt{ver\_sig}}
    ([xshift=-0.05cm,yshift=-0.5cm]sigprot2.west);

    % RAPrim
    \draw[<-]     
    ([xshift=0.05cm,yshift=0.5cm]attprot1.east)
    -- node[midway,above]{\texttt{get\_pk}} ([xshift=-0.05cm,yshift=0.5cm]ra1.west);
    \draw[<-]     
    ([xshift=0.05cm,yshift=0.5cm]attprot2.east)
    -- node[midway,above]{\texttt{get\_pk}} ([xshift=-0.05cm,yshift=0.5cm]ra2.west);
 
    \draw[<-]     
    ([xshift=0.05cm,yshift=0cm]attprot1.east)
    --node[midway,above]{\texttt{attest}} ([xshift=-0.05cm,yshift=0cm]ra1.west);
    \draw[<-]     
    ([xshift=0.05cm,yshift=0cm]attprot2.east)
    --node[midway,above]{\texttt{attest}} ([xshift=-0.05cm,yshift=0cm]ra2.west);
   
    \draw[<-]
    ([xshift=0.05cm,yshift=-0.5cm]attprot1.east)
    --node[midway,above]{\texttt{ver\_att}} ([xshift=-0.05cm,yshift=-0.5cm]ra1.west);
    \draw[<-]
    ([xshift=0.05cm,yshift=-0.5cm]attprot2.east)
    --node[midway,above]{\texttt{ver\_att}} ([xshift=-0.05cm,yshift=-0.5cm]ra2.west);

    % Sig-Prim to RA-Prim
    %real
    \draw[->]
    ([xshift=-0.5cm,yshift=0.05cm]sig1.north) -- 
    ([xshift=-0.5cm,yshift=1.5cm]sig1.north)  -- 
    node[midway,above] {\texttt{get\_pk}}
    ([xshift=1.5cm,yshift=1.5cm]ra1.north east) --  
    ([xshift=1.5cm,yshift=-0.5cm]ra1.east) |- 
    ([xshift=0.05cm,yshift=-0.5cm]ra1.east);
    \draw[->]
    ([xshift=0cm,yshift=0.05cm]sig1.north) -- 
    ([xshift=0cm,yshift=1cm]sig1.north) -- 
    node[midway,above] {\texttt{sign}}
    ([xshift=1cm,yshift=1cm]ra1.north east) --  
    ([xshift=1cm,yshift=0cm]ra1.east) |- 
    ([xshift=0.05cm,yshift=0cm]ra1.east);
    \draw[->]
    ([xshift=0.5cm,yshift=0.05cm]sig1.north) -- 
    ([xshift=0.5cm,yshift=0.5cm]sig1.north) -- 
    node[midway,above] {\texttt{ver\_sig}}
    ([xshift=0.5cm,yshift=0.5cm]ra1.north east) --  
    ([xshift=0.5cm,yshift=0.5cm]ra1.east) |- 
    ([xshift=0.05cm,yshift=0.5cm]ra1.east);
    %ideal
    \draw[->]
    ([xshift=-0.5cm,yshift=-0.05cm]sig2.south) -- 
    ([xshift=-0.5cm,yshift=-1.5cm]sig2.south)  -- 
    node[midway,below] {\texttt{get\_pk}}
    ([xshift=1.5cm,yshift=-1.5cm]ra2.south east) --  
    ([xshift=1.5cm,yshift=0.5cm]ra2.east) |- 
    ([xshift=0.05cm,yshift=0.5cm]ra2.east);
    \draw[->]
    ([xshift=0cm,yshift=-0.05cm]sig2.south) -- 
    ([xshift=0cm,yshift=-1cm]sig2.south) -- 
    node[midway,below] {\texttt{sign}}
    ([xshift=1cm,yshift=-1cm]ra2.south east) --  
    ([xshift=1cm,yshift=0cm]ra2.east) |- 
    ([xshift=0.05cm,yshift=0cm]ra2.east);
    \draw[->]
    ([xshift=0.5cm,yshift=-0.05cm]sig2.south) -- 
    ([xshift=0.5cm,yshift=-0.5cm]sig2.south) -- 
    node[midway,below] {\texttt{ver\_sig}}
    ([xshift=0.5cm,yshift=-0.5cm]ra2.south east) --  
    ([xshift=0.5cm,yshift=-0.5cm]ra2.east) |- 
    ([xshift=0.05cm,yshift=-0.5cm]ra2.east);

    \draw[->] 
    ([xshift=0.05cm]sigprot1.east) --
    node[midway,above] { \texttt{prot} }
    ([xshift=-0.05cm]attprot3.west);
    \draw[->] 
    ([xshift=0.05cm]sigprot2.east) --
    node[midway,above] { \texttt{prot} }
    ([xshift=-0.05cm]attprot4.west);


    %% Indistinguishability proofs
    \path[dashed,white]
    (sigprot1.south)
    edge node[midway,align=center,text=black] (spindist) {
        \texttt{\pindist}\\
        (~\ref{fig:problem:eu-ind},~\ref{theo:indist-signature})
    }
    (sigprot2.north);

    \path[dashed,white]
    (attprot3.south)
    edge node[midway,left,align=center,text=black] (rared) {
        \textcolor{SomeGreen}{$\leq$}\\(\ref{theo:redprot})
    }
    node[midway,right,align=center,text=black] (rapindist) {
        \texttt{\pindist}\\(\ref{theo:indist-ra})
    }
    (attprot4.north);

    \begin{scope}[on background layer]
        \draw[dashed,SomeGreen] (spindist.east) -- (ind1.west);
        \draw[dashed,SomeGreen] (spindist.east) -- (ind2.west);
        \draw[dashed,SomeGreen] (ind1.south) -- (ind2.north);
    \end{scope}

    %% Sigma
    \node[fill=white] at (kg1.north west) { $\Sigma$ };
    \node[fill=white] at (sig1.north west) { $\Sigma$ };
    \node[fill=white] at (sig2.north west) { $\Sigma$ };

  \end{tikzpicture}
  

