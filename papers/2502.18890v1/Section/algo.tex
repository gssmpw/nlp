% \begin{algorithm}[ht]
% \small
% \caption{\ours}
% \label{alg:algorithm}
% \begin{algorithmic}[1]
% \setstretch{1.15}
% \REQUIRE Prompt $\mathbf{p}$, target model $M$, decoding tree $T$, $4$-gram number $k$; full cache $C_f$, max budget size $|B|$ of partial cache $C_p$, cache initial size $|S|$; prefix length $e$.
% \STATE $C_f \leftarrow Prefill(M, \mathbf{p})$, where $|C_f|=\text{len}(\mathbf{p})$;
% \STATE $C_p \leftarrow \{C_f[0:|S|], \text{Top-K}_{|B|-|S|}(C_f)\}$, where $|C_p|=|B|$ and $\text{Top-K}$ function is from \cref{equ:gqa};
% \STATE $st \leftarrow 0, e \leftarrow \text{len}(\mathbf{p})$.
% \WHILE{$st\leq 100 \times 1024$} 
% \IF{$(|C_f|-e)>|B|-|S|$}
% \STATE $ C_p \leftarrow \{C_f[:|S|], \text{Top-K}_{|B|-|S|}(C_f)\}, e \leftarrow |C_f|$.
% \ENDIF
% \STATE Get draft logits $l_{\leq 3}$ \footnotemark by \cref{equ:ours} with $C_p$.
% \STATE Impose penalty by \cref{equ:repeat} to get probability $p_{\leq 3}$.
% % \STATE Get probabilities $p_0, p_1, p_2, p_3$ using \cref{equ:repeat}.
% % \STATE Construct $g$ groups of candidate draft tokens $\{x^i_{\leq 3}\}_{i=0}^{g-1}$ using $T$ and probability $p$.
% \STATE Construct $g$ groups of candidate draft tokens $\{x^i_{\leq 3}\}_{i=0}^{g-1}$ using $T$ and $p_{\leq 3}$.
% \STATE Select $k$ $4$-grams $\{a^i_{\leq 3}\}_{i=0}^{k-1}$ with highest frequency, where $\forall j \leq k-1, a^j_0=\arg\max p_0$ (\S \ref{sec:multi_token}).
% % \STATE Select top-$k$ $4$-grams $\{a^i_{\leq 3}\}_{i=0}^{k-1}$ \footnotemark using \emph{token reutilization} as described in \S \ref{sec:multi_token}.
% % \STATE Send $\{a\} \cup \{x\}$ to $M$ to get verification logits, then impose penalty by \cref{equ:repeat} to get probability $\{q_{\leq 4}^i\}_{i=0}^{k+g-1}$.\footnotemark
% % \STATE Send $\{a\} \cup \{x\}$ to $M$ to get verification logits, then get verification probabilities $\{q_{\leq 4}^i\}_{i=0}^{k+g-1}$ using \cref{equ:repeat}.\footnotemark
% \STATE Let draft tokens $\{d^i_{\leq 3}\}_{i=0}^{k+g-1} = \{a^i_{\leq 3}\}_{i=0}^{k-1} \cup \{x^i_{\leq 3}\}_{i=0}^{g-1}$, and send $\{d\}$ to $M$ to get verification logits, then get verification probabilities $\{q_{\leq 4}^i\}_{i=0}^{k+g-1}$ using \cref{equ:repeat}.\footnotemark
% \STATE  Sample target tokens $\{y^i_{\leq 3}\}_{i=0}^{k+g-1}$ from $\{q_{\leq 3}^i\}_{i=0}^{k+g-1}$.
% % \STATE Verify  $\{a\} \cup \{x\}$ against $\{y\}$  in parallel by exactly match (\S \ref{sec:overall}) to obtain valid $n$-gram groups $\mathcal{G}$, where $0 \leq n \leq 4$.
% % \STATE Let the longest accepted length $n = \max\limits_{m} (d^i_{\leq m} = y^i_{\leq m})$, and randomly select $i$ from $\{i \mid d^i_{\leq n-1} = y^i_{\leq n-1}\}$, where $i \leq k+g-1$.
% % \STATE Get the longest accepted length $n$ by exactly match $(d^i_{\leq m} = y^i_{\leq m})$, and randomly select $i$ from $\{i \mid d^i_{\leq n-1} = y^i_{\leq n-1}\}$, where $i \leq k+g-1$.
% \STATE Get the longest accepted length $n$ of draft tokens satisfying $d^i_{\leq m} = y^i_{\leq m}$, and randomly select $i$ from $\{i \mid d^i_{\leq n-1} = y^i_{\leq n-1}\}$, where $i \leq k+g-1$.
% % \STATE Randomly select a valid \{y_0, ..., y_{n-1}\}$ from $\mathcal{G}$.
% % \STATE Randomly select $i$ from $\{i \mid d^i_{\leq n-1} = y^i_{\leq n-1}, \forall i \leq k+g-1\}$.
% \STATE Resample extra token $y^i_{n}$ from $q^i_{n}$ and take $\{y^i_{\leq n}\}$ as output tokens.
% \STATE Let $st \leftarrow st+n+1$.
% \STATE Evict $C_p$ to ensure the size of $C_p$ is $|B|$ and update $C_f$.
% \ENDWHILE
% \end{algorithmic}
% \end{algorithm}
% \footnotetext[2]{The subscript $\leq 3$ here denotes a tuple with indices $0, 1, 2, 3$. The notation will be used similarly hereafter.}
% \footnotetext{We get 5 verification logits for each 4-gram in $\{a\} \cup \{x\}$, because the first tokens in the 4-grams must be prepended with the last resampled token before being sent to $M$.}

\begin{algorithm}[t!]
\small
\caption{\ours}
\label{alg:algorithm}
\begin{algorithmic}[1]
\setstretch{1.15}
\REQUIRE Prompt $\mathbf{p}$, target model $M$, decoding tree $T$, $n$-gram candidate number $k$; max budget size $|B|$ of partial cache, cache initial size $|S|$.
\STATE Prefill target model with KV cache $C_{full} \leftarrow Prefill_M(\mathbf{p})$, \textit{s.t.} $|C_{full}|=\text{len}(\mathbf{p})$;
\STATE Prefill partial KV cache $C_p \leftarrow \{C_{full}[0:|S|], \text{Top-K}_{|B|-|S|}(C_{full})\}$ \textit{w.r.t} \cref{equ:gqa}, where $|C_p|=|B|$;
\STATE $st \leftarrow 0, e \leftarrow \text{len}(\mathbf{p})$.
\WHILE{$st\leq \text{target length}$} 
\IF{$(|C_{full}|-e)>|B|-|S|$}
\STATE \textbf{Dynamic KV Cache Update: } $ C_p \leftarrow \{C_{full}[:|S|], \text{Top-K}_{|B|-|S|}(C_{full})\}, e \leftarrow |C_{full}|$.
\ENDIF
% \STATE Multi-token Generation: 
\STATE \textbf{Multi-token Parallel Generation:} Get penalized probability $p_{\leq 3}$\footnotemark with partial cache $C_p$.
\STATE \textbf{Tree-based Attention:} Construct $g$ groups of candidate draft tokens $\{x^i_{\leq 3}\}_{i=1}^{g}$ using decoding tree $T$ and $p_{\leq 3}$.
\STATE \textbf{Token Reutilization:} Select $k$ n-gram candidates $\{a^i_{\leq 3}\}_{i=1}^{k}$ with highest frequency, where $a_0=\arg\max p_0$ (\S \ref{sec:multi_token}).
\STATE \textbf{Parallel Verification:} Let draft tokens $\{d^i\}_{i=1}^{k+g} \coloneqq \{a^i_{\leq 3}\}_{i=1}^{k} \cup \{x^i_{\leq 3}\}_{i=1}^{g}$, and send $\{d\}$ to $M$ to get penalized verification probabilities $\{q^i\}_{i=1}^{k+g}$.
% \footnotemark
\STATE  Sample target tokens $\{y^i\}_{i=1}^{k+g} \sim \{q^i\}_{i=1}^{k+g}$.
% \STATE Get the longest accepted length of draft tokens satisfying $d^i_{\leq m} = y^i_{\leq m}$.
\STATE Random select the longest accepted length of draft tokens $d^j_{\leq m} \in \{d_{\leq m}|d^i_{\leq m} = y^i_{\leq m}\}_{i=1}^{k+g}$ by exactly match.
% ($i$ is randomly chosen from indices of all longest accepted drafts).
% , and randomly select $i$ from $\{i \mid d^i_{\leq n-1} = y^i_{\leq n-1}\}$, where $i \leq k+g-1$.
% \STATE Randomly select a valid \{y_0, ..., y_{n-1}\}$ from $\mathcal{G}$.
% \STATE Randomly select $i$ from $\{i \mid d^i_{\leq n-1} = y^i_{\leq n-1}, \forall i \leq k+g-1\}$.
% \STATE Resample extra token $y^i_{n}$ from $q^i_{n}$
\STATE Let $st \leftarrow st+\text{len}(y^i)$; \textbf{yield: } $y^i$
\STATE Evict $C_p$ to ensure the size of $C_p$ is $|B|$ and update $C_{full}$.
\ENDWHILE
\end{algorithmic}
\end{algorithm}
\footnotetext{The subscript $\leq 3$ here denotes a tuple with indices $0, 1, 2, 3$. The notation will be used similarly hereafter.}
% \footnotetext{We get 5 verification logits for each n-gram in $\{a\} \cup \{x\}$, because the first tokens in the n-grams must be prepended with the last resampled token before being sent to $M$.}
