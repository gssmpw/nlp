\section{Introduction}
\label{sec:intro}


% Recently, transfer learning has emerged as a promising approach for medical semantic segmentation, primarily due to the persistent challenge of acquiring large amounts of labeled data necessary for training deep learning models effectively. 
For medical segmentation tasks, acquiring ground-truth labels is challenging because  detailed annotation of large 3D images is both time-consuming and requires expert input\cite{medical_deeplearning1, medical_deeplearning2}. To compensate the lack of labeled training samples, transfer learning has become a common approach for medical semantic segmentation \cite{medical_transfer1, medical_transfer2}, 
%, which refers to any learning strategy that 
leveraging the knowledge from a high resource domain to improve the performance on low-resource tasks\cite{pan2009survey}. 
%The hope is that this source domain is related to the target domain and thus transferring knowledge from the source can improve the performance within the target domain. 
% For vision applications, the most widely used approach is to pre-train a model on a source domain/task and then fine-tune that same model on the target domain/task. 
% In this approach, the knowledge that is transferred from the source to the target problem is in the form of the values of the network parameters. 
% Unfortunately, the effectiveness of transfer learning is not always guaranteed. Low task correlation, domain correlation, and the misapplication of the transfer method may lead to negative transfer\cite{negative-transfer,negative_transfer_2}. 
However, the effectiveness of transfer learning is not guaranteed: low task and domain correlation can impair the target domain performance. This phenomenon is known as  {\it negative transfer}\cite{negative_transfer_2}. 
% , along with improper application for specific scenarios\st{(such as using classification approach to address segmentation problem, using natural image method to tackle medical image problem)}, 
%Negative transfer may hinder the performance of the target, which is a long-standing and challenging issue in the transfer learning context. 
% i.e., introducing source domain knowledge in an undesirable manner decreases learning performance in the target domain, 
Due to the inherent heterogeneity in medical images, including differences in imaging modalities, contrast variations, and patient-specific anatomy\cite{medical_transfer1, medical_da},   negative transfer  is common in medical image segmentation\cite{negative-transfer}. 
% Therefore, studying NT facilitates more reliable and safer transfers in real-world applications.
% what to transfer,how to transfer, when to transfer. “when to transfer” examines whether the source data/knowledge should be transferred or not for a particular application scenario.

Most existing works address negative transfer by selecting more relevant source domain\cite{yicong, jin2024cross}, reweighting the source samples\cite{instance_level_3, negative_transfer_2}, and aligning distributions in the feature space\cite{feature_level_1}. The principle idea in these works lies in the notion of domain similarity \cite{MMD, KLD, correlation_coefficient} or some transferability metric across different tasks \cite{nce, hscore, leep, logme, otce} to quantify transfer performance.  
As these approaches have originated from a classification or regression context, they ignore the complex output structures in image-output tasks such as semantic segmentation. In segmentation, the risk of negative transfer of a given model does not uniformly distribute over the whole image. For example, some textures such as the white matter or the grey matter in the brain are shared across multiple domains, while some are unique to a specific domains such as the cortical protrusions and depressions across individual brains. This observation necessitates the need for a fine-grained transfer learning approach that could adapt to variable negative transfer risk at different image regions.


Recently, a few natural image segmentation works have incorporated the category-level and pixel-level transferability into loss function %to enhance the target performance by weighting the loss function by pixel-level transferability score\cite{Dong,10222912}.
by propagating the global category-wise transferability calculated by entropy criterion\cite{dong}, or weighting the loss function by transferability score during fine-tuning phase\cite{10222912}. However, they don't work effectively on medical segmentation tasks due to fewer semantic categories, tiny segmentation foreground, and severed class imbalance of medical images, compared to natural images\cite{medical_and_natural}.



%To measure negative transfer at specific image regions, previous works focus on estimating the domain similarity \cite{MMD, KLD, correlation_coefficient} or quantifying the global transfer hardness across different tasks \cite{nce, hscore, leep, logme, otce} to select beneficial source data or models to transfer. Transferability reveals how easy it is to transfer knowledge learned from a source task to a target task\cite{otce}. 
%To mitigate pixel-level negative transfer risk on medical segmentation tasks

To solve the aforementioned challenges, we propose a simple yet effective weighted fine-tuning approach that directs the model's attention towards regions with significant transfer risk, tailored to the medical semantic segmentation problem (Fig.~\ref{architecture}). Specifically, we introduce a pixel-level {\it transfer risk map}, which quantifies the transfer hardness for each pixel and the potential risks of negative transfer associated with them. Here we adopt LEEP (Log Expected Empirical Prediction)\cite{leep} metric as our transferability method for its high computational efficiency, simplicity, and superior performance\cite{10222912}. And to alleviate the adverse effects of class imbalance during the fine-tuning phase, we calculate loss values across all pixels but average them exclusively over the foreground pixels. Such a method effectively reduces the impact that a large amount of well-learned background pixels might have on biasing the loss value, which in turn expedites the refinement of model parameters. 


%The proposed method is designed to direct the model's attention towards regions with significant transfer risk, thus mitigating the negative transfer and enhancing the overall effectiveness of the fine-tuning process. The framework is shown in Fig.~\ref{architecture}.
% In the fine-tuning stage, the model can leverage the knowledge from source model more heavily in regions where transfer hardness is low. Conversely, in regions of high transfer hardness, the model prioritizes learning from the target data to refine these areas, thereby optimizing the overall performance. 

% \jy{To mitigate negative transfer, previous works focus on estimating the domain similarity \cite{MMD, KLD, correlation_coefficient} or quantifying the global transfer hardness across different tasks \cite{nce, hscore, leep, logme, otce} to select beneficial source data or models to transfer. Transferability reveals how easy it is to transfer knowledge learned from a source task to a target task\cite{otce}. Recent works address negative transfer by improving the transferability in dataset-level\cite{yicong, jin2024cross}, image-level\cite{instance_level_1, instance_level_2, instance_level_3, negative_transfer_2}, and feature-level\cite{feature_level_1, feature_level_2}. However, for a given source domain and task, the risk of negative transfer does not uniformly distribute over the whole image, as some textures such as \st{the white matter or the grey matter in the brain} are shared across multiple domains, while some are unique to a specific domain or task such as \st{the cortical protrusions and depressions across individual brains}. This necessitates the need for a pixel-wise approach that could adapt to variable negative transfer risk at different image regions. Recent works incorporate the pixel-level transferability to enhance the target performance by propagating the global category-wise transferability calculated by entropy criterion\cite{dong} or weighting the loss function by transferability score during fine-tuning phase\cite{10222912}. However, they don't work effectively on medical segmentation tasks due to fewer categories, tiny segmentation foreground, and severed class imbalance of medical images, compared to natural images.
% }

% \jy{Considering the issues mentioned above, this work focused on pixel-level transferability-guided weighted fine-tuning for medical segmentation tasks. To mitigate pixel-level negative transfer risk on medical segmentation tasks, we propose a pixel-level transfer risk map that meticulously quantifies the transfer hardness for each pixel and the potential risks of negative transfer associated with them. Here we adopt LEEP (Log Expected Empirical Prediction)\cite{leep} metric as our transferability method for its high computational efficiency, simplicity, and superior performance\cite{10222912}. However, these transferability metrics are designed for classification or regression tasks, which cannot be directly applied to semantic segmentation tasks. Inspired by \cite{10222912}, we adapt LEEP on segmentation tasks by calculating transferability scores over the sampled pixel-wise features.
% And to alleviate the adverse effects of class imbalance during the fine-tuning phase, we calculate loss values across all pixels but average them exclusively considering the non-zero pixels. Such a method effectively tempers the impact that a multitude of well-learned background pixels might have on diluting the loss value, which in turn expedites the refinement of model parameters. 
% }

%Transferability reveals how easy it is to transfer knowledge learned from a source task to a target task\cite{otce}, which can quantify the global transfer hardness accurately. 
% its estimation metrics aim to develop a measure (or a score) that can tell us, without training on the target dataset, how effectively they can transfer knowledge learned in the source model to the target task. 
% Feature statistics based transferability methods like MMD\cite{MMD}, KL-divergence\cite{KLD}, and correlation coefficient\cite{correlation_coefficient} estimate the domain similarity based on the original feature representation and its first- or high-order statistics, which is not suitable for real-world medical task without access to source data. Another category of transferability method is fine-tuning based, including LEEP\cite{leep}, LogME\cite{logme}, NCE\cite{nce} and H-score\cite{hscore},  considering the correlation between the predicted target label or the learned feature representations and the true target label. 

% make transferability computable
% They are predominantly applied to the source domain selection problem, aiming to a priori determine which domains are likely to yield superior transfer outcomes\cite{yicong, jin2024cross}. 
% 基于feature的方法需要source的数据，基于finetune的方法都基于分类任务

% Despite these empirical observations, little research work has been published to analyze or predict negative transfer. Third and most importantly, given limited or no labeled target data, how to detect and/or avoid negative transfer.

% Merely employing transferability methods for domain-level priori determine \cite{yicong, jin2024cross} often falls short. 
% Relying solely on transferability methods for domain-level priors \cite{yicong, jin2024cross} often proves inadequate. How to mitigate the risk of negative transfer from relevant source domains has become a considerable problem. Most works address negative transfer by improving the instance-level and feature-level transferability. Instance-level methods mitigate negative transfer by removing the irrelevant source samples\cite{instance_level_1} or reweighting the source samples\cite{instance_level_3, negative_transfer_2}, even some active learning methods\cite{instance_level_2}, which rely more on source data. Feature-level approaches usually focus on feature space decomposition\cite{feature_level_1}, or improving the transferability of feature representations\cite{feature_level_2}, which may lead to poor discriminability. However, for a given source domain and task, the risk of negative transfer to the target is not uniform over the entire image. This is not only caused by having fine-grained textures. Rather, it is because some textures such as the shape of the brain are shared across multiple domains, while some are unique to a domain or task such as specific brain matter. These requirements underscore the need for a meticulous focus on finer granularity during the transfer process, thereby facilitating the model's capacity to refine and fine-tune local regions. 
% Dong et al.\cite{Dong} quantify the adaptation contributions of semantic representations across domains via transferability information propagation from global category-wise prototypes calculated by entropy criterion, which is not suitable for medical segmentation tasks that typically involve fewer categories compared to natural images. Tan et al.\cite{10222912} proposed a transferability-weighted fine-tuning method to emphasize low-transferability regions, thereby enhancing the overall transfer accuracy for the target task, which doesn't work effectively on medical segmentation tasks due to their tiny segmentation foreground and severed class imbalance.

%In this work, we propose a LEEP based pixel-level transfer risk map that harnesses transferability evaluation techniques to meticulously quantify the transfer hardness for each pixel and the potential risks of negative transfer associated with them. Furthermore, we propose a novel weighted fine-tuning approach guided by the transfer risk map for medical segmentation tasks. 

% Extensive experiments on brain tumor and brain matter segmentation datasets demonstrate that our proposed fine-tuning consistently outperforms the vanilla fine-tuning in all transfer experiments, with 4.37\% gain on FeTS2021 and 1.81\% gain on iSeg-2019. A 2.9\% gain in Dice score under a few-shot scenario validates the robustness of our approach, highlighting its capacity to mitigate the impact of localized negative transfer and to facilitate model adaptation and refinement during fine-tuning. 
\input{figures/architecture}
Extensive experiments on brain tumor and brain matter segmentation datasets demonstrate that our proposed fine-tuning method achieves significantly enhanced performance when transferring knowledge between distinct modalities and tasks, with a 4.37\% gain in brain tumor segmentation dataset FeTS 2021 and a 1.81\% gain in brain matter segmentation dataset iSeg-2019, indicating that it indeed avoids negative transfer from diverse modalities and tasks while learning beneficial knowledge for segmentation across multiple modalities and tasks. In the few-shot scenario, our method also improved the baseline by 2.9\% on average, validating the robustness of our approach under different sample sizes.  
   
% Medical image segmentation enables the precise localization and quantification of regions of interest, serving as a critical step in diagnostic aid, automated diagnostic workflows, surgical planning, and treatment efficacy assessment. Despite significant progress in the field of automated segmentation, particularly with the advent of deep learning, there is still a formidable challenge with domain shift, according to the inherent variability present in medical images, including differences in imaging modalities (MRI, CT, Ultrasound, etc.), contrast variations, and patient-specific anatomy\cite{medical_transfer1, medical_da}. Transfer learning represents a powerful learning paradigm for mitigating the domain gap and enhancing the performance on target tasks with knowledge from related source tasks. Transferability reveals how easy it is to transfer knowledge learned from a source task to a target task. The most straightforward approach is to evaluate transferability based on the test accuracy of the target task after the transfer, which involves expensive computation in retraining neural networks. Recent studies including LEEP\cite{leep}, LogME\cite{logme}, NCE\cite{nce} and H-score\cite{hscore} have proposed different methods to estimate the knowledge transferability between source and target tasks for natural images. These transferability estimation metrics aim to develop a measure (or a score) that can tell us, without training on the target data set, how effectively these transfer learning algorithms can transfer knowledge learned in the source model to the target task, using the target dataset.
% Currently, the application of transferability theory estimation is predominantly concentrated on the source domain selection problem, aiming to a priori determine which domains are likely to yield superior transfer outcomes. Li et al.\cite{yicong} propose a prior knowledge guided and transferability based source selection framework, leveraging the prior knowledge and transferability estimation metrics to select the best source tasks for transfer learning on brain image segmentation tasks. Jin et al.\cite{jin2024cross} propose an MMD-based domain selection method, which adaptively selects the source domain with the least difference from the target subject in a BCI-MI dataset of 109 subjects. 

% Recent works in the natural images field have started to incorporate transferability and discriminability into their models, thereby contributing to the enhancement of the models’ performance. Dong et al.\cite{Dong} propose a novel Knowledge Aggregation-induced Transferability Perception Adaptation Network to explore where and how to capture transferable visual characterizations and semantic representations for unsupervised domain adaptation. They quantify the adaptation contributions of semantic representations across domains via transferability information propagation from global category-wise prototypes calculated by entropy criterion. A transferability-aware information bottleneck is developed to capture transferable appearance translation. Chen\cite{chen2020harmonizing} observe that some local regions of the whole image are more descriptive and dominant than others, they further enhance the local discriminability by proposing to compute local feature masks in both domains based on the shallow layer features for approximately guiding the semantic consistency in the following alignment, which can be seen as an attention-like module that captures the transferable regions in an unsupervised manner. Tan\cite{10222912} introduced an adaptation method that enables existing transferability metrics to be applied to semantic segmentation data and proposed a transferability-weighted fine-tuning method that emphasizes low-transferability regions, thereby enhancing the overall transfer accuracy for the target task. 

% Owing to the intrinsic disparities between medical and natural images, techniques from the natural image domain cannot be seamlessly adapted for medical imaging tasks. In the context of segmentation, a stark contrast exists where medical images allocate a tiny fraction of the image area as the segmentation foreground—encompassing lesions or specific tissue segments—resulting in a pronounced class imbalance that is particularly acute in medical image segmentation. Additionally, medical image processing necessitates a fine-grained capability for discerning local textures, as opposed to the coarse-grained object shape recognition typically emphasized in natural image segmentation. The minute anomalies within these textures can betray the signatures of underlying diseases, thus aiding in the model's segmentation accuracy. These requirements underscore the need for a meticulous focus on finer granularity during the transfer process, facilitating the model's capacity to meticulously refine and fine-tune local regions, consequently elevating the efficacy of the segmentation outcomes.


% \begin{itemize}
% \item[1)]A transferability guided method, a pixel-level transfer risk map. It harnesses transferability evaluation techniques to meticulously quantify the potential risks of negative transfer associated with them.
% \item[2)]A novel weighted fine-tuning approach guided by the transfer risk map for medical segmentation tasks. It directs the model's attention towards regions with significant transfer hardness, thus mitigating the potential risk of local negative transfer and enhancing the overall performance. 
% \item[3)] Extensive experiments on brain tumor and brain matter segmentation datasets demonstrate the effectiveness and robustness of our method. 
% % It validates the efficacy of our proposed approach in mitigating the risk of potential negative transfer.
% \end{itemize}
%\st{In summary, we propose a transferability-guided pixel-level weighted fine-tuning strategy with a tailored transfer risk map for medical segmentation tasks. The proposed pixel-level transfer risk map harnesses transferability evaluation techniques to meticulously quantify the potential risks of negative transfer associated with them. The weighted fine-tuning guided by the transfer risk map directs the model's attention towards regions with significant transfer hardness, thus mitigating the potential risk of local negative transfer and enhancing the overall performance. Extensive experiments have proved the superiority of our method compared with baseline methods.}