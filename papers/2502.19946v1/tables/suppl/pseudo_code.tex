\begin{algorithm*}
\setstretch{1.2}
  \caption{The testing loop of proposed \textbf{SOBA} method for test-time adaptation
    \label{alg:whole_loop}}
  \begin{algorithmic}[1]
   \State \textbf{Input: }{CLIP visual encoder \(E_{v}(\theta_v)\), text encoder \(E_{t}(\theta_t)\), testing dataset $D_{test}$, number of classes $N$, $N$ text descriptions $T$ of $N$ classes, original basis \({\mathcal{E}}\), dynamic queue $L$, hyper-parameter $\alpha$, queue capacity $\rm{K}$.}
  \For{each test sample \( x_{test} \) in \( D_{test} \)}
        \State {Image embedding: } \( f_{test} \) $\gets$ \(E_{v}(\theta_v, x_{test})\)
        \State {Text embeddings: } \( W_{t} \) $\gets$ \(E_{t}(\theta_t, T)\)
        \State {CLIP logits: } \( logits_{ori} \) $\gets$ $f_{test}W_{t}^{\rm{T}}$
        \State {Pseudo-label of \( x_{test} \): } \(\hat{l}\) $\gets$ \texttt{OneHot}($logits_{ori}$)
        \State $L$ $\gets$ \texttt{Update}($L, f_{test}, \hat{l}, logits_{ori}$) \Comment{See Algorithm \ref{alg:update}}
        \For{each pseudo-class \( \hat{l}_{k} \) in \( L \)}
            \State {Get prototype of class \(\hat{l}_{k}\):}
            ${\mathbf{\mu}_{k}}$ $\gets$ $\frac{\sum_{i=1}^{M_{k}} \mathbb{I}_{\hat{l}=k} f_{test,i}}{\sum_{i=1}^{M_{k}} \mathbb{I}_{\hat{l}=k}}$
        \EndFor
        \State {Get covariance $C$ of $L$:}
        $C$ $\gets$ $\frac{1}{N}\sum_{k=1}^{N} \frac{ {\textstyle \sum_{i=1}^{{M}_{k}}\mathbb{I}_{\hat{l}=k}(f_{test,i}-{\mathbf{\mu}_{k}})(f_{test,i}-{\mathbf{\mu}_{k}})^{\rm{T}}  } }{ {\textstyle \sum_{i=1}^{M_{k}}} \mathbb{I}_{\hat{l}=k}} $
        \State Space rotation: $\hat{\mathbf{\mu}}$ $\gets$ \texttt{SOBA}(${\mathbf{\mu}}, C$) \Comment{See Equation \ref{eq:main} and \ref{eq:main_mat}}
        \State {\textbf{SOBA} logits: }\( logits_{trans} \) $\gets$ \texttt{Linear}($f_{test}, \hat{\mathbf{\mu}}$)
        \State {Final inference: } $logits$ $\gets$ $logits_{ori} + {\alpha}\times logits_{\rm{trans}}$
  \EndFor
      \State \Return{$logits$} \Comment{return prediction based on the mode}
  \end{algorithmic}
\end{algorithm*}