\section{Regret Analysis (Linear Constrained Bandit)}\label{sec:regret-analysis-bandit}

\begin{lemma}[Good event 1]\label{lemma:good-event1}
Suppose \Cref{algo:zero-vio-bandit} is run with $\rho = 1$.
Let $\delta \in (0, 1]$.
Define $\rmvEventBandit$ as the event where the following inequality holds: 
\begin{align*}
&\sum_{k =1}^K
\E_{\ba \sim \pi^{(k)}} \norm*{\ba}^2_{\paren*{\bLambda^{(k)}}^{-1}} 
\leq 2\sum_{k =1 }^K
\norm*{\ba^{(k)}}^2_{\paren*{\bLambda^{(k)}}^{-1}}
+ 4 \ln \frac{2K}{\delta} \;.
\end{align*}
Then, $\P(\rmvEventBandit) \geq 1 - \delta$.
\end{lemma}
\begin{proof}
\looseness=-1
The claim immediately follows from \Cref{lemma:exp-to-concrete} with $\norm*{\ba}_2\leq 1$ and $\rho=1$.
\end{proof}

\begin{lemma}[Good event 2]\label{lemma:good-event2}
Define $\confeventBandit$ as the event where the following two hold:
For any $\pi \in \Pi$, $k \in \bbrack{1, K}$,
$$
\abs*{\widehat{r}^{(k)}_\pi - r_\pi} \leq \co \beta^{(k)}_\pi
\quad\text{ and }\quad
\abs*{\widehat{u}^{(k)}_\pi - u_\pi} \leq \cp \beta^{(k)}_\pi\;.
$$
Then, if \Cref{algo:zero-vio-bandit} is run with $\rho = 1$ and the value of $\min\brace*{\cp, \co} \geq B + R\sqrt{d \ln \frac{4K}{\delta}}$, it holds that $\P(\confeventBandit) \geq 1 - \delta$.
\end{lemma}
\begin{proof}
\looseness=-1
Using \Cref{lemma:confidence-ellipsoid} with $\rho = 1$, with probability at least $1-\delta$, for any $k \in \bbrack{1, K}$ and for both $g \in \brace{r, u}$, we have
\begin{align*}
\abs*{\ba^\top \paren*{\hbtheta^{(k)}_g - \btheta_g}} 
&\leq
\norm*{\hbtheta^{(k)}_g - \btheta_g}_{\bLambda^{(k)}}
\norm*{\ba}_{\paren*{\bLambda^{(k)}}^{-1}}\\
&\numeq{\leq}{a}
\paren*{B + R\sqrt{d \ln \frac{2\paren*{1 + K}}{\delta}}} \norm*{\ba}_{\paren*{\bLambda^{(k)}}^{-1}}\\
&\leq
\paren*{B + R\sqrt{d \ln \frac{4K}{\delta}}} \norm*{\ba}_{\paren*{\bLambda^{(k)}}^{-1}}\;,
\end{align*}
where (a) uses \Cref{lemma:confidence-ellipsoid}.
The claim holds by \(
\abs*{\widehat{g}^{(k)}_{\pi} - g_{\pi}}
\leq \E_{\ba \sim \pi}\abs*{\ba^\top \paren*{\hbtheta^{(k)}_g - \btheta_g}}
\) for $g \in \brace{r, u}$. 
\end{proof}

\begin{lemma}[Cumulative bonus bound]\label{lemma:cumulative-bonus-bandit}
Suppose $\rmvEventBandit$ holds.
Then, $\sum_{k=1}^K\beta^{(k)}_{\pi^{(k)}} \leq \sqrt{K} \sqrt{2d\ln \paren*{1 + \frac{K}{d}} + 4 \ln \frac{2K}{\delta}}$.
\end{lemma}
\begin{proof}
It holds that
\begin{align*}
\sum_{k=1}^K\beta^{(k)}_{\pi^{(k)}}
&\numeq{\leq}{a} \sqrt{K 
\sum_{k=1}^K
\paren*{\E_{\ba \sim \pi^{(k)}} \norm*{\ba}_{\paren*{\bLambda^{(k)}}^{-1}}}^2
}
\numeq{\leq}{b} \sqrt{K 
\sum_{k=1}^K
\E_{\ba \sim \pi^{(k)}} \norm*{\ba}^2_{\paren*{\bLambda^{(k)}}^{-1}}
}\\
&\numeq{\leq}{c}  \sqrt{K}
\sqrt{2
\sum_{k=1}^K
\norm*{\ba^{(k)}}^2_{\paren*{\bLambda^{(k)}}^{-1}}
+ 4 \ln \frac{2K}{\delta}} 
\numeq{\leq}{d} \sqrt{K} \sqrt{2d\ln \paren*{1 + \frac{K}{d}} + 4 \ln \frac{2K}{\delta}}\;,
\end{align*}    
where (a) and (b) use Cauchyâ€“Schwarz inequality, (c) is due to \(\rmvEventBandit\), and (d) uses \Cref{lemma:elliptical potential}.
\end{proof}

\begin{lemma}[Restatement of \Cref{lemma:bandit-opt-pes-main}]\label{lemma:bandit-opt-pes}
Suppose $\confeventBandit$ holds. Then, for any $\pi \in \Pi$ and $k \in \bbrack{1, K}$, 
$$
r_{\pi} + 2\co \beta^{(k)}_{\pi} \geq 
\widehat{r}_{\pi}^{(k)} + \co \beta^{(k)}_{\pi} \geq r_{\pi} \quad \text{ and }\quad
u_{\pi} \geq \widehat{u}_{\pi}^{(k)} - \cp \beta^{(k)}_{\pi}
\geq u_{\pi} - 2\cp \beta^{(k)}_{\pi}\;.
$$
\end{lemma}
\begin{proof}
We have
\begin{align*}
u_\pi
\geq 
\widehat{u}^{(k)}_\pi - \abs*{\widehat{u}^{(k)}_\pi - u_\pi} 
\geq \widehat{u}^{(k)}_\pi - \cp \beta^{(k)}_\pi
\geq \widehat{u}^{(k)}_\pi - \abs*{\widehat{u}^{(k)}_\pi - u_\pi} - \cp \beta^{(k)}_\pi
\geq u_\pi - 2\cp \beta^{(k)}_\pi\;.
\end{align*}
Similarly, 
\begin{align*}
r_\pi + 2\co \beta^{(k)}_\pi
\geq 
\widehat{r}^{(k)}_\pi + \abs*{\widehat{r}^{(k)}_\pi - r_\pi} + \co \beta^{(k)}_\pi
\geq \widehat{r}^{(k)}_\pi + \co \beta^{(k)}_\pi
\geq \widehat{r}^{(k)}_\pi + \abs*{\widehat{r}^{(k)}_\pi - r_\pi}
\geq r_\pi\;.
\end{align*}
\end{proof}

\begin{lemma}[Restatement of \Cref{lemma:alpha-feasibility-main}]\label{lemma:alpha-feasibility}
Consider $k \in \unconfBandit^c$.
For any $\alpha \in \brack*{0,  \frac{\bslt - 2\cp \beta^{(k)}_{\pisafe}}{\bslt - 2\cp \beta^{(k)}_{\pisafe} + 2\cp \beta^{(k)}_{\pi^\star}}}$, a mixture policy \(\pi_\alpha \df (1-\alpha) \pisafe + \alpha \pi^\star\) satisfies
$u_{\pi_\alpha} - 2\cp \beta^{(k)}_{\pi_\alpha} \geq b$.
\end{lemma}
\begin{proof}
For any $k$ and $\alpha \in [0, 1]$, we have
\begin{align*}
u_{\pi_\alpha} - b - 2\cp \beta^{(k)}_{\pi_\alpha}
&= (1-\alpha) \underbrace{\paren*{u_{\pisafe} - b}}_{\geq \bslt} + \alpha \underbrace{\paren*{u_{\pi^\star} - b}}_{\geq 0} - 2\cp (1-\alpha) \beta^{(k)}_{\pisafe} - 2\cp \alpha \beta^{(k)}_{\pi^\star}\\
&\geq (1-\alpha) \paren*{\bslt - 2\cp \beta^{(k)}_{\pisafe}} - 2\alpha \cp \beta^{(k)}_{\pi^\star}.
\end{align*}
To make \((1-\alpha) \paren*{\bslt- 2\cp \beta^{(k)}_{\pisafe}} - 2\alpha \cp \beta^{(k)}_{\pi^\star} \geq 0\), a sufficient condition is
\begin{align}\label{eq:alpha-cond-temp}
   \alpha \leq  \frac{\bslt - 2\cp \beta^{(k)}_{\pisafe}}{\bslt - 2\cp \beta^{(k)}_{\pisafe} + 2\cp \beta^{(k)}_{\pi^\star}}\;,
\end{align}
where the right hand side is non-negative since $k \in \unconfBandit^c$.
This concludes the proof.
\end{proof}


\begin{lemma}[Restatement of \Cref{lemma:Ck-bound-main}]\label{lemma:Ck-bound}
Suppose \Cref{algo:zero-vio-bandit} is run with $\rho = 1$.
Assume the event $\rmvEventBandit$ holds.
Then, 
\(|\unconfBandit| \leq  32d\cp^2\bslt^{-2}\ln\paren*{2K\delta^{-1}}\).
\end{lemma}
\begin{proof}
\looseness=-1
We have 
\begin{align*}
\sum_{k=1}^K
\E_{\ba \sim \pi^{(k)}} \norm*{\ba}^2_{\paren*{\bLambda^{(k)}}^{-1}}
&\geq
\sum_{k \in \unconfBandit}
\E_{\ba \sim \pi^{(k)}} \norm*{\ba}^2_{\paren*{\bLambda^{(k)}}^{-1}}\\
&\numeq{\geq}{a}
\sum_{k \in \unconfBandit}
\underbrace{
\paren*{\E_{\ba \sim \pi^{(k)}} \norm*{\ba}_{\paren*{\bLambda^{(k)}}^{-1}}}^2
}_{=\paren*{\beta^{(k)}_{\pisafe}}^2 \text{ since $\pi^{(k)}=\pisafe$}}
\numeq{\geq}{b} 
|\unconfBandit| \frac{\bslt^2}{4\cp^2}\;,
\end{align*}
where (a) is due to Jensen's inequality,
and (b) is due to \Cref{def:unconf-set}.
Due to \(\rmvEventBandit\), we have
\begin{align*}
\sum_{k=1}^K
\E_{\ba \sim \pi^{(k)}} \norm*{\ba}^2_{\paren*{\bLambda^{(k)}}^{-1}}
\leq 
2\sum_{k =1}^K
\norm*{\ba^{(k)}}^2_{\paren*{\bLambda^{(k)}}^{-1}}
+ 4 \ln \frac{2K}{\delta}\;.
\end{align*}
Using \Cref{lemma:elliptical potential} and since $\norm*{\ba}_2\leq 1$ and $\rho = 1$, the first term is bounded by:
\(\leq 2d\ln\paren*{1 + \frac{K}{d}}\)\;.
Thus, 
\begin{align*}
\frac{\bslt^2}{4\cp^2} |\unconfBandit| 
\leq 2d\ln\underbrace{\paren*{1 + \frac{K}{d}}}_{\leq 2K} + 4 \ln \frac{2K}{\delta}
\leq 8d\ln\paren*{\frac{2K}{\delta}}
\;.
\end{align*}
The claim holds by rearranging the above inequality.
\end{proof}






\begin{lemma}[Restatement of \Cref{lemma:optimism-main}]\label{lemma:optimism}
If $\co \geq \frac{2B\cp}{\bslt}$, for any $k \in \unconfBandit^c$, $\pi_{\alpha^{(k)}}$ satisfies
\(r_{\pi_{\alpha^{(k)}}} + \co \beta^{(k)}_{\pi_{\alpha^{(k)}}} \geq r_{\pi^{\star}}\).
\end{lemma}
\begin{proof}
Let $\alpha^{(k)} \df \frac{\bslt - 2\cp \beta^{(k)}_{\pisafe}}{\bslt - 2\cp \beta^{(k)}_{\pisafe} + 2\cp \beta^{(k)}_{\pi^\star}}$.
Note that 
$\frac{\alpha^{(k)}}{1 - \alpha^{(k)}} = \frac{\bslt - 2\cp \beta^{(k)}_{\pisafe}}{2\cp \beta^{(k)}_{\pi^\star}}$.
We have,
\begin{align*}
r_{\pi_{\alpha^{(k)}}} + \co
&= (1-\alpha^{(k)}) r_{\pisafe} + \alpha^{(k)} r_{\pi^{\star}} + \co (1-\alpha^{(k)}) \beta^{(k)}_{\pisafe} + \co \alpha^{(k)} \beta^{(k)}_{\pi^\star}\\
&\geq \alpha^{(k)} r_{\pi^{\star}} +  \co\paren*{\paren*{1-\alpha^{(k)}}\beta^{(k)}_{\pisafe} + \alpha^{(k)} \beta^{(k)}_{\pi^\star}} \;.
\end{align*}
A sufficient condition to have
$
\alpha^{(k)} r_{\pi^{\star}} + 
\co \paren*{\paren*{1-\alpha^{(k)}}\beta^{(k)}_{\pisafe} + \alpha^{(k)} \beta^{(k)}_{\pi^\star}}
\geq r_{\pi^\star}$ is, since $r_{\pi^\star} = \E_{\ba \sim \pi^\star}\brack*{\left\langle\btheta, \ba\right\rangle} \leq \norm*{\btheta}_2 \E_{\ba \sim \pi^\star}\norm*{\ba}_2 \leq B$, 
\begin{align*}
B 
&\leq \co\paren*{\beta^{(k)}_{\pisafe} + \frac{\alpha^{(k)}}{1-\alpha^{(k)}} \beta^{(k)}_{\pi^\star}}\\
&= \co\paren*{\beta^{(k)}_{\pisafe} + \frac{1}{2\cp}\bslt - \beta^{(k)}_{\pisafe}}
\leq \frac{\co}{2\cp}\bslt\;.
\end{align*}
\looseness=-1
Therefore, when $\co \geq \frac{2B \cp}{\bslt}$, we have
\(
r_{\pi_{\alpha^{(k)}}} + \co \beta^{(k)}_{\pi_{\alpha^{(k)}}} \geq r_{\pi^{\star}}
\).
\end{proof}

\begin{theorem}[Restatement of \Cref{theorem:bandit-regret-main}]\label{theorem:formal-regret}
\looseness=-1
Suppose that \Cref{algo:zero-vio-bandit} is run with $\rho=1$,
\begin{align*}
\cp =B + R\sqrt{d \ln \frac{4K}{\delta}},
\; \text{ and }\;
\co = \cp \paren*{1 + \frac{2B}{\bslt}}.
\end{align*} 
Then, with probability at least $1-2\delta$, the following two hold simultaneously:
\begin{itemize}
    \item $\pi^{(k)} \in \Pisafe$ for any $k \in [K]$ 
    \item \( \regret (K) \leq 
32dB \cp^2\bslt^{-2}\ln\paren*{2K\delta^{-1}} +
4\co \sqrt{K} \sqrt{2d\ln \paren*{1 + \frac{K}{d}} + 4 \ln \frac{2K}{\delta}}
\)
\end{itemize}
\end{theorem}
\begin{proof}
Suppose the good events \(\rmvEventBandit \cap \confeventBandit\) hold. 
Recall that $\pi^{(k)}$ is either $\pisafe$ in $k \in \unconfBandit$ or the solution to \optpes in $k \in \unconfBandit^c$. 
Since \optpes is ensured to have feasible solutions by \Cref{lemma:alpha-feasibility} for $k \in \unconfBandit^c$,  the first claim follows immediately.

\looseness=-1
We will prove the second claim.
It holds that
\begin{align*}
\regret(K) 
&= \sum^K_{k=1} r_{\pi^\star} - r_{\pi^{(k)}}
= \underbrace{\sum_{k\in \unconfBandit} r_{\pi^\star} - r_{\pi^{(k)}}}_{\text{$\pi^{(k)}=\pisafe$}}
+ \underbrace{\sum_{k\notin \unconfBandit} r_{\pi^\star} - r_{\pi^{(k)}}}_{\text{$\pi^{(k)}$ is computed by \optpes}}\\
&\leq B |\unconfBandit| + \sum_{k\notin \unconfBandit} r_{\pi^\star} - r_{\pi^{(k)}}\\
&\numeq{\leq}{a} 32dB \cp^2\bslt^{-2}\ln\paren*{2K\delta^{-1}} 
+ \underbrace{\sum_{k\notin \unconfBandit} \paren*{r_{\pi^\star} - \widehat{r}^{(k)}_{\pi^{(k)}} - \co\beta^{(k)}_{\pi^{(k)}}}}_{\circled{1}}
+ \underbrace{\sum_{k\notin \unconfBandit} \paren*{\widehat{r}^{(k)}_{\pi^{(k)}} + \co\beta^{(k)}_{\pi^{(k)}} - r_{\pi^{(k)}}}}_{\circled{2}}\;,
\end{align*}
where (a) uses the bound of $|\unconfBandit|$ (\Cref{lemma:Ck-bound}). 
Using \Cref{lemma:bandit-opt-pes}, the term $\circled{2}$ is bounded by
\(
\circled{2} \leq 
\sum_{k\notin \unconfBandit} 3\co\beta^{(k)}_{\pi^{(k)}}
\).
On the other hand, $\circled{1}$ is bounded by
\begin{align*}
\circled{1} 
&\numeq{\leq}{a} \sum_{k\notin \unconfBandit}
r_{\pi_{\alpha^{(k)}}} + \co \beta^{(k)}_{\pi_{\alpha^{(k)}}}
- \widehat{r}^{(k)}_{\pi^{(k)}} - \co\beta^{(k)}_{\pi^{(k)}} \\
&\numeq{\leq}{b} \sum_{k\notin \unconfBandit}
\co \beta^{(k)}_{\pi_{\alpha^{(k)}}} + 
\paren*{\widehat{r}^{(k)}_{\pi_{\alpha^{(k)}}} + \co \beta^{(k)}_{\pi_{\alpha^{(k)}}}
- \widehat{r}^{(k)}_{\pi^{(k)}} - \co\beta^{(k)}_{\pi^{(k)}}} \\
&\numeq{\leq}{c} \sum_{k\notin \unconfBandit}
\co \beta^{(k)}_{\pi_{\alpha^{(k)}}}\;,
\end{align*}
where (a) uses the optimism of mixture policy (\Cref{lemma:optimism}), (b) uses \Cref{lemma:bandit-opt-pes}, and (c) holds since $\pi_{\alpha^{(k)}}$ is a feasible solution to \optpes due to \Cref{lemma:alpha-feasibility}.

\looseness=-1
Finally, by combining all the results, we have
\begin{align*}
\regret(K) &\leq 
32dB \cp^2\bslt^{-2}\ln\paren*{2K\delta^{-1}} 
+ 4\co \sum_{k\notin \unconfBandit} \beta^{(k)}_{\pi_{\alpha^{(k)}}}\\
&\leq 
32dB \cp^2\bslt^{-2}\ln\paren*{2K\delta^{-1}} +
4\co \sqrt{K} \sqrt{2d\ln \paren*{1 + \frac{K}{d}} + 4 \ln \frac{2K}{\delta}}
\end{align*}
where the second inequality uses \Cref{lemma:cumulative-bonus-bandit}.
Since the good event $\rmvEventBandit \cap \confeventBandit$ occurs with probability at least $1 - 2\delta$ due to \Cref{lemma:good-event1,lemma:good-event2}, the claim holds.
\end{proof}
