
\begin{algorithm2e}[htbp]
    \caption{Capped conjugate gradient~\citep[Algorithm 1]{royer2020newton}} 
    \label{alg:capped-cg}

    \SetKwInOut{Input}{Input}
    \SetKwInOut{Output}{Output}
    \DontPrintSemicolon

    \Input{A symmetric matrix $H \in \R^{d \times d}$, a vector $g \in \R^d$, a regularizer $\rho \in (0,\infty)$, a parameter $\bar\rho \in (0,\infty)$ used to decide whether to terminate the algorithm earlier, and a tolerance parameter $\xi\in(0,1)$.}
    \Output{$(\text{d\_type}, \tilde d)$ such that $\text{d\_type} \in \{ \texttt{NC}, \texttt{SOL}, \texttt{TERM} \}$ and \lemmaref{lem:capped-cg} holds.}
        
    \SetKwFunction{CappedCG}{CappedCG}
    \SetKwProg{Fn}{Subroutine}{}{}

    \Fn{\CappedCG{$H, g, \rho, \xi, \bar \rho$}} {
    $(y_0, r_0, p_0, j) \gets (0, g, -g, 0)$\;
    $\bar H \gets H + 2\rho \Id$\;
    $M \gets \frac{\|Hp_0\|}{\|p_0\|}$\;
    \lIf{$p_0^\top \bar H p_0 < \rho \|p_0\|^2$} {
        \Return $(\texttt{NC}, p_{0})$
    }
    \While{True}{

        \tcp{Beginning of standard CG}
         $\alpha_k \gets \frac{\|r_k\|^2}{p_k^\top \bar H p_k}$\;
         $y_{k+1} \gets y_k + \alpha_k p_k$\;
         $r_{k+1} \gets r_k + \alpha_k \bar H p_k$\;
         $\beta_{k+1} \gets \frac{\|r_{k+1}\|^2}{\|r_k\|^2}$\;
         $p_{k+1} \gets -r_{k+1} + \beta_{k+1} p_k$\;
        \tcp{End of standard CG}

        $k \gets k + 1$\;
        $M \gets \max\left( M, \frac{\|Hp_{k}\|}{\|p_{k}\|}, \frac{\|Hr_{k}\|}{\|r_{k}\|}, \frac{\|Hy_{k}\|}{\|y_{k}\|} \right)$
        \tcp*[f]{Estimate the norm of $H$}
        \\
        $(\kappa, \hat\xi, \tau, T) \gets \left( 
            \frac{M + 2\rho}{\rho},
            \frac{\xi}{3\kappa},
            \frac{\sqrt \kappa}{\sqrt \kappa + 1},
            \frac{4\kappa^4}{(1 - \sqrt \tau)^2}
            \right)$\;
        
        \lIf{$y_{k}^\top \bar H y_{k} < \rho \| y_{k} \|^2$} {
            \Return $(\texttt{NC}, y_{k})$
        }\lElseIf{$\|r_{k}\|  \leq \hat \xi \| r_0 \|$} {
            \Return $(\texttt{SOL}, y_{k})$
        }\lElseIf{$p_{k}^\top \bar H p_{k} < \rho \| p_{k} \|^2$} {
            \Return $(\texttt{NC}, p_{k})$
        }\uElseIf{$\|r_{k}\|>\sqrt T\tau^{\frac{k}{2}} \|r_0\|$}  {
        $\alpha_{k} \gets \frac{\|r_{k}\|^2}{p_{k}^\top \bar H p_{k}}$\;
        $y_{k+1} \gets y_{k} + \alpha_{k} p_{k}$\;
        Find %
        $i \in \{ 0, \dots, k-1 \}$
        such that 
        \begin{equation}
            \label{eqn:capped-cg-slow-decay-condition}
            \frac{(y_{k+1} - y_i)^\top \bar H (y_{k+1} - y_i)}{\|y_{k+1}-y_i\|^2} < \rho.
        \end{equation} \\
        \Return $(\texttt{NC}, y_{k+1} - y_i)$\;
        }
        \ElseIf{$k \geq J(M, \bar\rho, \xi) + 1$}
        { 
            \Return $(\texttt{TERM}, y_k)$ 
            \tcp*[f]{$J(M, \bar\rho, \xi)$ is defined in \eqref{eqn:capped-cg-hessvec-evals}}
        }
    }
    }
\end{algorithm2e}

