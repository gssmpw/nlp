
\begin{algorithm2e}[htbp]
    \caption{Adaptive regularized Newton-CG (\algname{ARNCG})}
    \label{alg:adap-newton-cg}
    \DontPrintSemicolon


    \SetKwInOut{Input}{Input}
    \SetKwInOut{Output}{Output}
    \Input{Initial point $x_0 \in \R^n$, parameters $\mu \in (0, 1/2)$, $\beta \in (0, 1)$, $\tau_-\in (0, 1)$, $\tau_+ \in (0, 1]$, $\tau \in (0, 1]$, $\gamma\in(1,\infty)$, $m_{\mathrm{max}} \in [1,\infty)$, $M_0\in(0,\infty)$, and $\eta \subseteq [0, 1]$, and regularizers $\{ \omega_k^{\supsucc}, \omega_k^{\supfallback} \}_{k \geq 0} \subseteq (0, \infty)$ for trial and fallback steps.}
        
    \SetKwFunction{CappedCG}{CappedCG}
    \SetKwFunction{HessianLipschitzEstimation}{HessianLipschitzEstimation}
    \SetKwFunction{NewtonStep}{NewtonStep}
    \SetKwProg{Fn}{Subroutine}{}{}
    \For(\tcp*[f]{the main loop})
    {$k = 0, 1, \dots$} {
        $(x_{k + \frac{1}{2}}, M_{k+1}) \gets $\NewtonStep{$x_k, \omega_k^{\supsucc}, M_k, \omega_k^{\supfallback}$}
        \tcp*[f]{trial step}\\
        \uIf
        { 
            (the above step returns \texttt{FAIL}) or $\big(
                g_{k + \frac{1}{2}} > g_{k}
            \text{ and }
            g_{k} \leq g_{k-1}
            \big)$
        } {
            $(x_{k + 1},  M_{k+1}) \gets $\NewtonStep{$x_k, \omega_k^{\supfallback}, M_k, \omega_k^{\supfallback}$}
            \tcp*[f]{fallback step} \\
        } \lElse
        (\tcp*[f]{accept the trial step})
         {
            $x_{k+1} \gets x_{k + \frac{1}{2}}$
        }
    }
    \Fn{\NewtonStep{$x, \omega, M, \bar\omega$}} {
     $\tilde \eta \gets \min\big( \eta, \sqrt M \omega \big)$\; 
     $(\text{d\_type}, \tilde d) \gets$ \CappedCG{$\nabla^2\varphi(x), \nabla \varphi(x), \sqrt M \omega, \tilde \eta, \tau \sqrt M \bar \omega$}
         \tcp*[f]{see \Cref{sec:appendix/capped-cg}}
         \\
     \lIf
     {$\text{d\_type} = \texttt{TERM}$} 
     {
        \Return $\texttt{FAIL}$
        \tcp*[f]{never reached if $\omega \geq \bar\omega$}
     }
     \uElseIf
     (\tcp*[f]{a normal solution})
     {$\text{d\_type} = \texttt{SOL}$} 
     {
         Set $d \gets \tilde d$ and $\alpha \gets \beta^m$, where
         $0 \leq m \leq m_{\mathrm{max}}$ is the minimum integer such that %
         \begin{equation}
             \label{eqn:smooth-line-search-sol}
             \varphi(x + \beta^{m} d) \leq \varphi(x) + \mu \beta^{m} d^\top \nabla \varphi(x). %
         \end{equation} \\
         \uIf
         (\tcp*[f]{switch to a smaller stepsize})
         {the above $m$ does not exist}
         {
            Set $\hat \alpha \gets \min(1,\omega^{\frac{1}{2}} M^{-\frac{1}{4}} \| d \|^{-\frac{1}{2}})$\;
            Set $\alpha \gets \hat \alpha \beta^{\hat m} $,
            where $0 \leq \hat m \leq m_{\mathrm{max}}$ is the minimum integer such that
            \begin{equation}
                \label{eqn:smooth-line-search-sol-smaller-stepsize}
                \varphi(x + \hat \alpha \beta^{\hat m} d) \leq \varphi(x) + \mu \hat \alpha \beta^{\hat m} d^\top \nabla \varphi(x). %
            \end{equation} \\
        \lIf{the above $\hat m$ does not exist}
        {
            \Return $(x, \gamma M)$
        }
         }
     } \uElse
        (\tcp*[f]{a negative curvature direction ($\text{d\_type}$ = \texttt{NC})})
      {
         Set $\bar d \gets \| \tilde d \|^{-1} \tilde d$ and adjust it to a descent direction with length $L(\bar d)$:
         \begin{equation}
             \label{eqn:smooth-line-search-nc-direction}
             d \gets -
             L(\bar d)
             \sign\left (\bar d^\top \nabla \varphi(x)\right ) 
             \bar d,
             \quad 
             \text{where }
             L(\bar d) := M^{-1} |\bar d^\top \nabla^2\varphi(x) \bar d|.
         \end{equation}
         \\
         Set $\alpha \gets \beta^m$, where $0 \leq m \leq m_{\mathrm{max}}$ is the minimum integer such that %
         \begin{equation}
             \label{eqn:smooth-line-search-nc}
             \varphi(x + \beta^{m} d) \leq \varphi(x) - M \mu \beta^{2m} \| d \|^3.
         \end{equation} \\ 
        \lIf{the above $m$ does not exist}
        {
            \Return $(x, \gamma M)$
        }
     }

     
     $M^+ \gets M$, $x^+ \gets x + \alpha d$ and $\Delta \gets \varphi(x) - \varphi(x^+)$\;
    \uIf{$\text{d\_type} = \texttt{SOL}$ and $m = 0$ satisfies \eqref{eqn:smooth-line-search-sol}} {
        \lIf{
            $\Delta \leq \frac{4}{33} \mu \tau_+ M^{-\frac{1}{2}} \min \left( \| \nabla \varphi(x^+) \|^2 \omega^{-1}, \omega^3 \right)$
            }
        { $M^+\gets \gamma M$ }
        \lElseIf{$\Delta\geq  \frac{4}{33}\mu \tau_{-}M^{-\frac{1}{2}} \bar \omega^3$}
        { $M^+\gets \gamma^{-1} M$ }
    } \lElseIf{$\text{d\_type} = \texttt{SOL}$ and 
        $\Delta \leq \tau_+ \beta \mu M^{-\frac{1}{2}} \omega^3$
    } { $M^+\gets \gamma M$ }
    \lElseIf{$\text{d\_type} = \texttt{NC}$ and 
        $\Delta \leq \tau_+ (1 - 2\mu)^2 \beta^2 \mu M^{-\frac{1}{2}} \omega^3$
    } { $M^+\gets \gamma M$ }
        \lElseIf{$\Delta\geq \mu \tau_{-}M^{-\frac{1}{2}} \bar \omega^3$} {
            $M^+\gets \gamma^{-1} M$
        } %
    \Return $(x^+, M^+)$\;
    }
\end{algorithm2e}

