
\section{Details and properties of capped CG} \label{sec:appendix/capped-cg}

\input{newton-cg/algo/capped-cg-algo}

The capped CG in \citet{royer2020newton} is presented in \Cref{alg:capped-cg}, with an additional termination condition $k \geq J(M, \bar\rho, \xi) + 1$ and type \texttt{TERM}. 
Note that in \Cref{alg:adap-newton-cg}, we will take $\rho = \sqrt M \omega$. The following lemma states the number of iterations for the original version of capped CG.
\begin{lemma}[Lemma 1 of \citet{royer2020newton}]
    \label{lem:capped-cg-iteration-complexity}
    When the termination condition for \texttt{TERM} is removed, \Cref{alg:capped-cg} terminates in $\min(n, J(M, \rho, \xi)) + 1 \leq \min(n, \tilde O(\rho^{-\frac{1}{2}}))$ iterations, where
    \begin{equation}
    \label{eqn:capped-cg-hessvec-evals}
    J(M, \rho, \xi) 
    = 1 + \left( \sqrt \kappa + \frac{1}{2} \right) \log \left( \frac{144\left( \sqrt \kappa + 1 \right)^2 \kappa^6}{\xi^2} \right),
    \quad 
    \kappa = \frac{M + \rho}{\rho}
    .
\end{equation}
\end{lemma}
The additional termination condition indicates that the regularizer $\rho$ may be too small to find a solution within the given computational budget. 

For the oracle complexity, each iteration of \Cref{alg:capped-cg} requires only one Hessian-vector product, since the quantities $H y_k$, $H p_k$ and $H r_k$ used in the negative curvature monitor can be recursively constructed from $\bar H p_k$ generated in the standard CG iteration.
When the residual decays slower than expected, one more CG iteration is performed, and if the historical iterations are stored, only one additional Hessian-vector product is needed. 

The properties of our version with the \texttt{TERM} state are summarized below.
\begin{lemma}
    \label{lem:capped-cg}
    Invoking the subroutine \texttt{CappedCG}$(H, g, \rho, \xi, \bar\rho)$ obtains $(\text{d\_type}, \tilde d)$, then we have the following properties.
    \begin{enumerate}
        \item When $\text{d\_type} = \texttt{SOL}$, $\tilde d$ is an approximated solution of $(H + 2\rho \Id)\tilde d=-g$ such that
    \begin{align}
        \label{eqn:capped-cg-hessian-lowerbound}
        \tilde d^\top (H + 2\rho \Id) \tilde d &\geq\rho \|  \tilde d\|^2,  \\
        \label{eqn:capped-cg-hessian-lowerbound-H}
        \tilde d^\top H \tilde d &\geq -\rho \|  \tilde d\|^2, 
        \\
        \label{eqn:capped-cg-io-diff}
        \| \tilde d \| &\leq 2 \rho^{-1} \|g\|, \\
        \label{eqn:capped-cg-hessian-upperbound}
        \| (H + 2\rho \Id) \tilde d + g \| &\leq \frac{1}{2}\rho \xi \|\tilde d\| \leq \xi \|g\|,\\
        \label{eqn:capped-cg-descent-direction}
        \tilde d^\top g &= - \tilde d^\top (H + 2\rho \Id) \tilde d \leq -\rho \|\tilde d \|^2.
    \end{align}
        \item When $\text{d\_type} = \texttt{NC}$, $\tilde d$ is a negative curvature direction such that 
    \begin{align}
        \tilde d^\top H\tilde d \leq -\rho\|\tilde d\|^2.
        \label{eqn:capped-cg-nc-direction-inequ}
    \end{align}
        \item When $\text{d\_type} = \texttt{TERM}$, then $\rho < \bar \rho$.
        In other words, if $\bar\rho \leq \rho$ the algorithm terminates with $\text{d\_type} \in \{\texttt{SOL}, \texttt{NC}\}$.
    \item 
    Suppose there exist $\alpha, a, b > 0$ such that
     $H \succeq \alpha \Id$, $\bar \rho \leq b\rho^a$ and $\rho \leq 1$, then 
     the algorithm terminates with $\text{d\_type} = \texttt{SOL}$ when $\xi = \rho \leq C(\alpha, a, b, \|H\|)$, where
     \begin{align*}
        C(\alpha, a, b, U) := 
        \min\left( 1,
            \left (\frac{\alpha^2}{b U} \right )^{\frac{1}{a}}, 
            \left( \frac{24\alpha^7}{b^7 \sqrt{U}(U+2)} \right)^{\frac{1}{7a}},
            \left( \frac{12\alpha^7}{b^7} \right)^{\frac{1}{7a+2}}
         \right).
     \end{align*}
    \end{enumerate}
\end{lemma}
\begin{proof}
    The first two cases directly follow from \citet[Lemma 3]{royer2020newton}.\footnote{This lemma assumes that $H = \nabla^2 \varphi(x)$, $g = \nabla \varphi(x)$, and $\varphi$ has Lipschitz Hessian. However, the statement of this lemma and the capped CG involve only the Hessian of $\varphi$ at a single point $x$, and hence the assumption can be removed.} 
    The third case follows from \lemmaref{lem:capped-cg-iteration-complexity} and the 
    monotonic non-increasing property of the map $\rho \mapsto J(M, \rho, \xi)$.

    The fourth case follows from the standard property of CG for positive definite equation,
    since $H \succeq \alpha \Id$ the capped CG reduces to the standard CG. 
    Specifically, let $\{ y_k, r_k \}_{k\ge 0}$ be the sequence generated by \Cref{alg:capped-cg}, then \citet[Equation (5.36)]{nocedal1999numerical} gives that 
    \begin{align*}
        \| e_k \|_{\bar H}
        \leq 2 \left( \frac{\sqrt{\kappa({\bar H})}-1}{\sqrt{\kappa({\bar H})}+1} \right)^k \|e_0\|_{\bar H}
        \leq 2 \exp\left( \frac{-2k}{\sqrt{\kappa({\bar H})}} \right) \|e_0\|_{\bar H},
    \end{align*}
    where $\|e_k\|_{\bar H}^2 := e_k^\top \bar H e_k$ and $\kappa(\bar H) = (\alpha + 2\rho)^{-1}(\|H\| + 2\rho)$ is the condition number, 
    and $e_k = y_k + \bar H^{-1} g = \bar H^{-1} r_k$ and $\bar H = H + 2\rho \Id$.
    Then, the above display becomes
    \begin{align*}
        \frac{1}{\|H\|+ 2\rho}
        \|r_k\|^2
        &\leq
        r_k^\top  \bar H^{-1} r_k 
        \leq 4 \exp\left( \frac{-4k}{\sqrt{\kappa({\bar H})}} \right) r_0^\top \bar H^{-1}  r_0 \\
        &\leq 
        4 \exp\left( \frac{-4k}{\sqrt{\kappa({\bar H})}} \right)  
        \frac{1}{\alpha + 2\rho}
        \|r_0\|^2.
    \end{align*}
    Let $M, \kappa, \hat \xi$ be the quantities updated in the algorithm. 
    Then, we have $M \geq \alpha$ 
    and $\kappa \leq \rho^{-1}\|H\| + 2$ and $\hat \xi = \frac{\xi}{3\kappa} \geq \frac{\xi}{3\rho^{-1}\|H\| + 6}$.
    Hence, when the \texttt{TERM} state is removed, and suppose \Cref{alg:capped-cg} terminates at $k_*$-th step with $\texttt{SOL}$.
    Then, we have
    \begin{align}
        \label{eqn:proof/cg-normal-termination}
        k_* \leq \left \lceil \frac{1}{2} \sqrt{\kappa(\bar H)}
        \log \frac{6\sqrt{\kappa(\bar H)}(\rho^{-1} \|H \| + 2)}{\xi} \right \rceil.
    \end{align}
    Since $\kappa(\bar H) \leq \frac{\|H\|}{\alpha}$ and $\rho\le1$, 
    we know 
    \begin{align*}
        k_*
        &\leq 
        \frac{1}{2} \sqrt{\frac{\|H\|}{\alpha}}
        \log \frac{6\sqrt{\|H\|}(\|H \| + 2)}{\sqrt{\alpha}\rho\xi} + 1 
        =: K(\rho, \xi).
    \end{align*}
    When incorporating the \texttt{TERM} state, and suppose it is triggered at the $\hat k$-th step, then 
    \begin{equation}
        \label{eqn:proof/capped-cg-term-condition}
    K(\rho, \xi) \geq k_* > \hat k \geq J(M, \bar \rho, \xi) + 1
    \geq J(M, \bar \rho, \xi)
    .
    \end{equation}
    However, when $b\rho^a \geq \bar \rho$, we have 
    \begin{align*}
        J(M, \bar\rho, \xi)
        \geq 
        J(\alpha, \bar\rho, \xi)
        \geq J(\alpha, b\rho^a, \xi)
        \geq \sqrt{\frac{\alpha}{b\rho^a}} \log \frac{144 \alpha^7}{\xi^2 b^7 \rho^{7a}}.
    \end{align*}
    Hence, when $\xi = \rho \leq C(\alpha, a, b,  \|H\|)$, 
    we have $\frac{\alpha}{b\rho^a} \geq \frac{\|H\|}{\alpha} \geq 1$ and 
    $\frac{144\alpha^7}{b^7 \rho^{7a + 2}} \geq \frac{6\sqrt{\|H\|} (\|H\|+2)}{\sqrt{\alpha} \rho^2}$
    and $\frac{144\alpha^7}{b^7 \rho^{7a + 2}} \geq 12$.
    Then, 
    \begin{align*}
        0 \overset{\eqref{eqn:proof/capped-cg-term-condition}}&{\geq} J(M, \bar \rho, \rho) - K(\rho, \rho) \\
        &\geq 
         \sqrt{\frac{\alpha}{b \rho^a}} \log \frac{144 \alpha^7}{b^7\rho^{7a+2}}
        - \frac{1}{2}\sqrt{\frac{\|H\|}{\alpha}}\log  
        \frac{6\sqrt{\|H\|} (\|H\|+2)}{\sqrt{\alpha} \rho^2} -1\\
        &\geq 
         \frac{1}{2}\sqrt{\frac{\|H\|}{\alpha}} \log \frac{144 \alpha^7}{b^7\rho^{7a + 2}} - 1
         \geq \frac{\log 12}{2} - 1
         > 0
        ,
    \end{align*}
    which leads to a contradiction. Therefore, the algorithm will terminate with \texttt{SOL}.
\end{proof}



