\begin{algorithm*}[tb]
\caption{Constructing a Reasoning Tree}\label{algo:stage2}
\begin{algorithmic}
 \STATE \textbf{Input}: A LLM agent $\pi_\theta$, a given task description $u$, a trajectory $\tau_0$ from the training set $\mathcal{D}_{expert}$ on task $u$, max exploration depth $D$, max exploration width $W$
   
   \STATE Initialize a root node $U$ with state $s \gets u$, depth $t \gets 0$, reward $r \gets 0$, action $\gets \textit{null}$, children set $\mathcal{C} \gets \{\}$
   
   \STATE Initialize the reasoning tree $\mathcal{T}$ with $U$
   
   \STATE The expansion node queue $E \gets [u]$
   
   \WHILE {$E$ is not empty}
      \STATE Get a node $N \gets E\text{.pop}$ with state $N.s$, action $N.a$, reward $N.r$, children set $\mathcal{C}$ at step $N.t$
      
      \IF {the number of children in $N.\mathcal{C} < W$ and $N.t \leq D$}
         \STATE Sample a new trajectory $\tau$ based on state $N.s$
         \STATE Get a new branch $b$ constructed on $\tau$ and merge $b$ in node $N.\mathcal{C}$
         
         \IF {$\tau$ achieves a non-zero final reward}
            \STATE Push all the nodes on $b$ with $N.t \leq D$ into $E$
         \ENDIF
      \ENDIF
   \ENDWHILE
   
   \STATE Construct a branch $b$ with $\tau_0$ and merge in $U.\mathcal{C}$
   
   \STATE Push all the nodes on $b$ with depth $t$ and $t \leq D$ into $E$
   
   \STATE \textbf{repeat} Function in Line 5-12
   
   \STATE \textbf{return} the reasoning tree $\mathcal{T}$
   
\end{algorithmic}
\end{algorithm*}
