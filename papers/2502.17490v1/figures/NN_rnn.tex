\begin{tikzpicture}[node distance=0.6cm]
% rectangle
\fill[gray!20, rounded corners=1cm] (-1,-3.5) rectangle (11.8,3.1);
\draw[thick, gray, rounded corners=1cm] (-1,-3.5) rectangle (11.8,3.1);
\node (rl) at (-1, 0.0) {};
\node (rr) at (11.8, 0.0) {};
\node (rb) at (5.4, -3.4) {};
\node (rt) at (5.4, 2.7) [thick] {\textcolor{gray}{\textbf{Recurrent Neural Network}}};

% Subject
\node (subj) at (5.4, -2.9) [thick, dashed, draw=rwth6, rounded corners=0.1cm, fill=rwth7!20] {subject to: $\mathrm{log}\left(\bm{U}_i^{-1}\,\bm{C}_{i_n}\,\bm{U}_i^{-1}\right) + 2\,\Delta t\, \bar{\bm{D}}_i = \bm{0}$};

% State variables
\node[draw=rwth3, rounded corners=0.1cm, fill=rwth3!20] (states) at ($(rb.south) + (0,-0.7)$) {States: $\bm{C}_n,\,\bm{U}_{i_n}$};
\draw[->, very thick, >=latex] (states.north) -- (rb.south);

% Inputs
\node[align=center, draw=rwth5, rounded corners=0.1cm, fill=rwth5!20] (input) at ($(rl.west) + (-1,0)$) {Inputs: \\ $\bm{C}_{n+1}$ \\ $\Delta t$};
\draw[->, very thick, >=latex] (input.east) -- ($(rl.west)+(0.1,0)$);

% Outputs
\node[align=center, draw=rwth10, rounded corners=0.1cm, fill=rwth10!20] (output) at ($(rr.east) + (1.2,0)$) {Outputs: \\ $\bm{S}_{n+1}$};
\draw[->, very thick, >=latex] ($(rr.west)+(0.2,0)$) -- (output.west);

% Erstes Netzwerk
\node (input1) at ($(rl)+(1,0)$) [draw, circle, fill=white] {$\bar{\bm{C}}_e$};
%
\node (hidden1_1) [draw, circle, right=of input1, minimum size=1cm, fill=rwthb1] {};
\node (hidden1_2) [draw, circle, above=of hidden1_1, minimum size=1cm, fill=rwthb1] {};
\node (hidden1_3) [draw, circle, below=of hidden1_1, minimum size=1cm, fill=rwthb1] {};
%
\node (hidden2_1) [draw, circle, right=of hidden1_1, minimum size=1cm, fill=rwthb2] {};
\node (hidden2_2) [draw, circle, right=of hidden1_2, minimum size=1cm, fill=rwthb2] {};
\node (hidden2_3) [draw, circle, right=of hidden1_3, minimum size=1cm, fill=rwthb2] {};
%
\node (output1) [draw, circle, right=of hidden2_1, fill=rwthb4] {$\psi$};
%
%% Verbindungen erstes Netzwerk
\foreach \i in {1,...,3} {
    \draw[-] (input1.east) to (hidden1_\i.west);
}
%
\foreach \j in {1,...,3} {
	\foreach \k in {1,...,3} {
    		\draw[-] (hidden1_\j.east) to (hidden2_\k.west);
    	}
}
%
\foreach \k in {1,...,3} {
    \draw[-] (hidden2_\k.east) to (output1.west); 
}

% Zweites Netzwerk
\node (a) at ($(output1.east)+(0.2,0)$){};

\node (input2) [draw,circle,right of=a, fill=white]{$\bar{\bm{\Sigma}}$};
%
\node (hidden3_1) [draw, circle, right=of input2, minimum size=1cm, fill=rwtho1] {};
\node (hidden3_2) [draw, circle, above=of hidden3_1, minimum size=1cm, fill=rwtho1] {};
\node (hidden3_3) [draw, circle, below=of hidden3_1, minimum size=1cm, fill=rwtho1] {};
%
\node (hidden4_1) [draw, circle, right=of hidden3_1, minimum size=1cm, fill=rwtho3] {};
\node (hidden4_2) [draw, circle, right=of hidden3_2, minimum size=1cm, fill=rwtho3] {};
\node (hidden4_3) [draw, circle, right=of hidden3_3, minimum size=1cm, fill=rwtho3] {};
%
\node (output2) [draw, circle, right=of hidden4_1, fill=rwtho5] {$\omega^*$};
%
%% Verbindungen zweites Netzwerk
\foreach \i in {1,...,3} {
    \draw[-] (input2.east) to (hidden3_\i.west);
}
%
\foreach \j in {1,...,3} {
	\foreach \k in {1,...,3} {
    		\draw[-] (hidden3_\j.east) to (hidden4_\k.west);
    	}
}
%
\foreach \k in {1,...,3} {
    \draw[-] (hidden4_\k.east) to (output2.west); 
}
%

% connect
\path[->,thick] ($(output1.north) + (0,0.2)$) edge[bend left]($(input2.north) + (0,0.2)$);
\path[->,thick] ($(input2.south) + (0,-0.2)$) edge[bend left]($(output1.south) + (0,-0.2)$);

% derivatives
\node (deriv1) at ($(output1.east) + (0.3,1.3)$) {$\frac{\partial\psi}{\partial\bar{\bm{C}}_e}$};
\node (deriv2) at ($(output1.east) + (0.3,-1.3)$) {$\frac{\partial\omega^*}{\partial\bar{\bm{\Sigma}}}$};

\end{tikzpicture}