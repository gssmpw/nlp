% \pagebreak

%\section{Notation and Variables} \label{sc:ap.notation}
%
%We summarize the notations used in this paper in Table \ref{tab:notations}. 
%
%%\TL{TODO: check paper for variables!}
%%\JZ{I'm checking this now...}
%\begin{table}[hb]
%  \caption{List of notations used on this work.}
%  \label{tab:notations}
%  \begin{tabular}{ll}
%    \toprule
%    Symbol&Description\\
%    \midrule
%    $\mathbf{x}_t$ & State of the system at time $t$ \\
%    $\mathbf{u}_t$ & Input to the system at time $t$ \\
%    $\mathcal{C}_{(\cdot)}$ & Cost term for optimization problem\\
%    $w_{(\cdot)}$ & Weight for the optimization cost terms\\
%    $J_k$ & Cost function ($=\sum w_i\mathcal{C}_i$) for the $k$-time prediction\\
%    $\bm{\chi}$ & Set of state constraints\\
%    $\bm{\zeta}$ & Set of input constraints\\
%    $dt$ & Sampling time\\
%    $\mmBold$ & Magnetic dipole of the electromagnet\\
%    $\mpBold$ & Magnetic dipole of the pen magnet \\
%    $\mpBoldt$ & Approx. of $\mpBold$, with only $\ez$ component and $\ctheta \simeq 1$\\
%    $\RmagtopenBold$ & 3D Vector distance from $\mmBold$ to $\mpBold$\\
%    $\RmagtopenBoldt$ & 3D Vector distance from $\mmBold$ to $\mpBoldt$\\
%    $\posp$ & Pen tip position \\
%    $\posm$ & Center of electromagnet, projected into paper plane\\
%    $\mathbf{r_d}$ & in-plane vector $\mathbf{r_d} = \posm - \posp$\\
%    $\ed$ & unity vector that goes from $\ed = \mathbf{r_d} / \norm{\mathbf{r_d}}$\\
%    $d$ & in-plane separation between $\posp$ and $\posm$, i.e $d=\norm{\mathbf{r_d}}$\\
%    $h$ & $= h_m + h_p$, i.e vertical distance between $\mpBold$ and $\mpBoldt$ \\
%    $\alpha$ & intensity of the electromagnet (PWM input)\\
%    $\mathbf{F_a}$ & Actuation force on the pen, from $\posp$ to $\posm$\\
%    $\theta$ & Control parameter to progress along the desired path\\
%    $\posst$ & Current desired point in the path\\
%    $\mathbf{r_{\theta}}$ & in-plane vector $\mathbf{r_{\theta}} = \posst - \posm$\\
%    $\mathbf{F_{\theta}}$ & Desired force on the pen, from $\posp$ to $\posst$\\
%    $\mathbf{n}$ & The normalized tangent at $\mathbf{s}(\theta)$ \\
%  \bottomrule
%\end{tabular}
%\end{table}

%\section{Variables}\label{a:var}

% \begin{table}[!htb]
%   \caption{List of variables and optimization weights used in this work.}
%   \label{tab:var}
%   \begin{tabular}{ll}
%     \toprule
%     Variable&Value\\
%     \midrule
%     $N$&10\\
%     $w_l$&1.5\\
%     $w_c$&1.5\\
%     $w_\theta$&10.\\
%     $w_{\dot{\theta}}$&0.1\\
%     $w_f$&10.\\
%     $w_d$&0.05\\
%     $w_\alpha$&7.\\
%     $c$&5.\\
%     $w_v$&1.\\
%     $w_m$&1.\\
%     $v_C$&0.1\\
%   \bottomrule
% \end{tabular}
% \end{table}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Dipole model evaluation
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Control Algorithm}
\label{ap:control_algorithm}
\SetKwProg{Fn}{Function}{}{}
\begin{algorithm}[h]
\SetAlgoLined
\DontPrintSemicolon
 \Fn{MPCC($\mathbf{x0}, \mathbf{w},\posp, \mathbf{parameters}$)}{
 $[\mathcal{C}_l, \mathcal{C}_c, \mathcal{C}_\theta, \mathcal{C}_{\dot{\theta}}]\leftarrow$compute lag and contour error \;
 $[\mathcal{C}_f, \mathcal{C}_d, \mathcal{C}_\alpha]\leftarrow$compute force error \;
 $J_k \leftarrow $ sum($\mathcal{C}_l, \mathcal{C}_c, \mathcal{C}_\theta, \mathcal{C}_{\dot{\theta}},\mathcal{C}_f, \mathcal{C}_d, \mathcal{C}_\alpha$)\;
 $[\mathbf{x}, \mathbf{u}]\leftarrow$minimize($J_k$) \;
 }
  \Return $[\mathbf{x}, \mathbf{u}]$\;
  \;
 
 $\mathbf{x_0}$, $\mathbf{w} \leftarrow \ $initialize\;
\While{drawing not finished}{
  $\posp \leftarrow$ Measure pen position\;
  ${\posp}_{,k} \leftarrow$ $KalmanFilter(\posp) $\;
  $\mathbf{x_0} \leftarrow$ update system states, from sensor data\;
  $\mathbf{parameters} \leftarrow$ update MPCC parameters \;
  $[\mathbf{x_{t=1..n}},\mathbf{u_{t=1...n}}] \leftarrow$ $MPCC(\mathbf{x_0},\mathbf{w},\mathbf{p},\mathbf{params})$\;
  $\mathbf{x_0}\leftarrow \mathbf{x_1}$\;
  apply($\mathbf{u_0})$
 }
 \caption{Closed Loop Haptic Feedback Control.} 
\label{alg:optimization-overview}
\end{algorithm}



%%%%%I commented out the include statement for the entire appendix in Main.tex because of compilation errors. Undo that once you fixed the LAtex