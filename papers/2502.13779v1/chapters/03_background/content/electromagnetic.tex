\section{Magnetic Model}
\label{sc:back.mag}

\subsection{Dipole Model}
\label{sc:back.dipole}
In our haptic applications, we employ electromagnetic feedback. To effectively provide this feedback, it is crucial to understand the relationships between the electrical current, the magnetic field, and the force experienced by a permanent magnet embedded in a tool.

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{chapters/03_background/figures/coordinates.pdf}
    \caption{Diagram of the coordinate system used in the models}
    \label{fig:background:em_coordinates}
\end{figure}

We utilize simplified magnetic field models from previous research \cite{thomaszewski2008magnets}, which allow us to simulate the magnetic field in real-time. These models require only the magnitude, orientation, and position of each dipole magnet. We apply similar simplifications in our approach.

The formula for the magnetic field created by a dipole is:
\begin{equation}
    \BBold (\rBold, \mBold)=\frac {\mu _{0}}{4\pi }\frac {3 \ \HatrBold \ (\mBold \cdot \HatrBold  )-\mBold}{|\rBold |^3} \ ,
    \label{eq:basic_B}
\end{equation}        
where $\mu_0$ represents the permeability of air, $\rBold$ is the vector from the center of the magnetic source to the testing point, and $\mBold$ symbolizes the magnetic moment containing the \emph{strength} and orientation of the magnetic source. The magnetic moment varies depending on the magnet type: $\meBold$ for an electromagnet and $\mpBold$ for a permanent magnet. For the permanent magnet embedded in the tool, angles $\theta$ and $\varphi$ are measured from the positive z-axis, as depicted in \figref{fig:background:em_coordinates}.

The three components of the magnetic moment for the toolâ€™s embedded magnet are described by:
\begin{equation}\label{eq:mpBold}
    \mpBold =  \frac{1}{\mu_0}*Br*V * \begin{bmatrix}\sin(\theta) \ \cos(\varphi)\\\sin(\theta) \ \sin(\varphi)\\\cos(\theta)\end{bmatrix}\ ,
\end{equation}
where $V$ is the volume and $Br$ is the residual magnetic flux of the permanent magnet, expressed in Tesla units.

\subsubsection{Electromagnet Dipole Equivalent} 
\label{sc:back.dipole.cyl}
Our designs employ electromagnets to generate haptic feedback. We extend the dipole model to include cylindrical and spherical electromagnets used in different devices.

The magnetic field generated by an electromagnet dipole at a point influenced by another dipole or sensor is given by:
\begin{equation}
  \mathbf{B_e} (\rBold,\mmBold) =  \BBold (\rBold, \mmBold),
  \label{eq:ap.B2}
\end{equation}

\noindent where $\rBold$ represents the vector from $\mmBold$ to either $\mpBold$ or $\siBold$, as shown in \figref{fig:background:em_coordinates}.

\paragraph{Cylinderical}
    \magpen uses a cylindrical electromagnetic. Hence we need a dipole model for cylindrical electromagnets used in our applications. The magnetic field $\mathbf{B_e}$ is modeled using a cylindrical coordinate system aligned with the magnet. The magnet's magnetic moment, $\mmBold$, can be expressed as:
    \begin{equation}
        \mmBold = \alpha \ m_e \ [0,0,1]^T,\\
    \end{equation}
    \noindent where $\alpha$ represents the normalized input to the electromagnet and $m_e$ the calibrated strength of the magnet. 
    
    % By analyzing only the z-component of the magnetic field, we derive:
    % \begin{eqnarray}
    % B_{e,z}(d) &=& \frac{\mu_0 \alpha m_m}{4\pi} \left( \frac{2 h^2 - d^2}{\left( d^2 + h^2\right)^{\frac{5}{2}}} \right),\label{eq:apB2z}
    % \end{eqnarray}
    % \noindent where $h$ and $d$ represent specific geometric distances.
       
    % In \magpen, $h$ is a fixed value. Furthermore, we calibrate for $m_e$. To measure the z-component of the magnetic field generated by the electromagnet to compare it with the dipole prediction of \eqref{eq:apB2z}. We use a hall sensor (Allegro A1324, sensitivity is 5 mV/G) to measure the z-magnetic flux at a fix height $h$, where the magnet of the pen would be. Setting the electromagnet to $\alpha =1$ and moving it in a grid we attain multiple readings of the hall sensor for different electromagnet positions $\posm$. We present the obtained magnetic field plotted in \figref{fig:ap:3D-hall-fit}, left.

    % \begin{figure}[!t]
    % \vspace{-1em}
    % \centering
    % \includegraphics[width=.45\columnwidth]{chapters/05_shared_control/mpc/figures/apend_fit_3d.pdf}
    % \includegraphics[width=.45\columnwidth]{chapters/05_shared_control/mpc/figures/apend_fit.pdf}
    % \caption{3D overview of all data points. The x,y axis are position and the z-axis is $B_2^{(z)}$}
    % \label{fig:ap:3D-hall-fit}
    % \end{figure}
    
    % Due to symmetry over the z-axis, as we expect for $B_{m,z}$, we re-plot all points as a function of distance $d_s = \norm{\mathbf{p_s}-\posm}$, with $\mathbf{p_s}=(0,0)$ the in-plane position of the hall sensor. In turn, Eq. \ref{eq:apB2z} can be expressed in the form,
    % \begin{equation}
    %    B_{m,z}(d_s) = C_1 \frac{2 C_2^2 - d_s^2}{\left( d_s^2 + C_2^2\right)^{5/2}} \label{eq:apB2_fit}
    % \end{equation}
    % \noindent where we have defined two parameters used for the fitting,
    % \begin{eqnarray}
    % C_1 &=& \frac{\mu_0 \alpha m_m}{4\pi} \label{eq:C1}\\
    % C_2 &=& h \label{eq:C2}
    % \end{eqnarray}
    
    % The right plot of Figure \ref{fig:ap:3D-hall-fit} shows the measured data for magnetic flux $B_{m,z}(d_s)$ and the fitting to Eq. \ref{eq:apB2_fit}, from which we obtained $C_1 = -1.276 \ 10^{-07}$ and $C_2 = 2.713 \ 10^{-02}$. By replacing these values in equations \ref{eq:C1} and \ref{eq:C2}, we observe that our system can be described by the values $m_m = 1.286$ [A m$^2$] and $h = 2.71$ [cm]. We want to emphasize the excellent agreement in Figure \ref{fig:ap:3D-hall-fit} between the experimental values and the proposed dipole model for the electromagnet. However, we should note that the experimental points show a flattening of $B_{m,z}(x)$ for values of $x < 3$ [mm], that translates into smaller values of forces in that region, as $\mathbf{F_a} \propto \nabla{B_{m,z}}$. 
    
\paragraph{Spherical}
    \omniHap and \omniUIST consit of custom spherical electromagnets. These operate under different constraints compared to cylindrical electromagnets. However, we can approximate them as the superposition of three orthogonal cylindrical electromagnets. However, in practice the coils are not perfectly orthogonal. Hence we use a calibration matrix $\mathbb{C}$ (cf. a scalar $\alpha$ in a cylindrical EM). Thus, the magnetic moment of these electromagnets is proportional to the actuation current:
    \begin{equation}\label{eq:me_from_c_i}
    \meBold = \mathbb{C} * \mathbf{I}^T \ ,
    \end{equation}
    \noindent where $\mathbf{I}$ is the current vector for each coil, and $\mathbb{C}$ is a calibration matrix derived from measurements.

    % To compute $\mmBold$, we have multiple sensors at known locations ($\RsiBold$) that measure $\mathbf{B_e}$. Thus we can compute $\meBold$ directly from \eqref{eq:ap.B2}:   
    
    % \begin{equation}
    %     \mmBold(\RmagtoallBold,\mathbf{B_e}) = \frac{4\pi\Rmagtoall}{\mu_0}\mathbf{B_e} - \frac{12\pi\Rmagtoall^3}{\mu_0(\Rmagtoall^2-3)} \left( \mathbf{B_e} \cdot \RmagtoallBold \right) \RmagtoallBold
    % \end{equation}
    
    % Note that for coils that are completely orthogonal and thus align perfectly with the sensor axis, $\mathbf{C}$ is a diagonal matrix. In our implementation, we found that the elements outside the diagonal are around $1.5\%$ the diagonal elements in magnitude.
    
\subsubsection{Magnetic Field at a Sensor}
To compute the magnetic field at each sensor location, we consider the combined influence of the permanent magnet, the electromagnet, and any background interference:
\begin{equation} \label{eq:b_sum}
\BiBold =\underbrace{\BBold(\RsiBold-\RpenBold, \mpBold)}_{\BpBold} + \underbrace{\BBold(\RsiBold, \meBold)}_{\BeBold} + \BnBold \ .
\end{equation}
This equation allows us to predict the total magnetic field experienced at each sensor location accurately.

\subsection{Dipole-dipole Model} 
\label{ap:em_model}

We have introduced the dipole model to calculate the magnetic fields produced by both permanent and electromagnets.

Primarily, our objective is to determine the actuation force on the pen, $\mathbf{F_p}$, which can be computed by integrating the gradient of the magnetic potential over the volume of the pen's permanent magnet:
\begin{equation}
\mathbf{F_p} = \iiint \nabla \left( \mathbf{M_p} \cdot \mathbf{B_m}(\cdot)\right) dxdydz , \label{eq:gradB2}
\end{equation}

The dipole-dipole interaction model, as described analytically by \citet{yung1998analytic}, provides an equation for the force between two magnetic dipoles. This model is crucial for determining the necessary magnetic dipole moment of the electromagnet, given the magnetic dipole and position of the permanent magnet to achieve a specific force:

\begin{multline}
   \mathbf{F_p} = {\dfrac  {3\mu _{0}}{4\pi \Rmagtopen^{5}}}
   \left [ \left(\langle\mpBold,\RmagtopenBold\rangle \right) \mmBold + 
   \left(\langle\mmBold,\RmagtopenBold\rangle\right) \mpBold \right . +
   \\
   \left(\langle\mpBold,\mmBold\rangle\right) \RmagtopenBold - 
    \left . {\dfrac{5\left(\langle\mpBold,\RmagtopenBold\rangle\right)
    \left(\langle\mmBold,\RmagtopenBold\rangle\right)}{\Rmagtopen^{2}}} \RmagtopenBold \right ] \ , \label{eq:F21-dip}
\end{multline}
A detailed derivation for specifically planar forces, as used in \magpenTitle, is provided in \appref{app:dipoledipole}.

