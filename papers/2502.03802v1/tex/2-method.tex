\section{Methodology}
\label{sec:method}
% \textcolor{red}{Di: You may want to put a short paragraph to explain the following three subsections}
We present key components of our approach: multivariate state space reconstruction for capturing coupled system dynamics; multivariate partial cross mapping to distinguishes between direct and indirect causality in multivariate settings; MXMap, the proposed framework leveraging the two for multivariate causal discovery.

\subsection{Multivariate State Space Reconstruction (multiSSR)}
\label{sec:multi-ssr}

Consider a set of $K$ observed time series denoted as $\left\{ x^{[k]}_{t} \right\}_{t=0}^{T},  k=1, 2, 3, ..., K$ from a dynamical system. Building upon the univariate delay embedding introduced in Section~\ref{sec:ssr}, each time series generates a univariate embedding $\mathcal{M}_{X}^{[k]}$. The vector $\vv{\textbf{m}}_{x}^{[k]}(t)$ on $\mathcal{M}_{x}^{[k]}$ is given by:

\begin{equation}
    \vv{\textbf{m}}_{x}^{[k]}(t)= \left[x_{t}^{[k]},  x^{[k]}_{t-\tau},  x^{[k]}_{t-\tau\cdot2},  x^{[k]}_{t-\tau\cdot3},  ...,  x^{[k]}_{t-\tau\cdot\left(E-2\right)},  x^{[k]}_{t-\tau\cdot\left(E-1\right)}\right]
\end{equation}


Multivariate State-Space Reconstruction (multiSSR) constructs a multivariate embedding by stacking all $K$ univariate delay embeddings. A vector $\textbf{m}_{x}(t)$ on $\mathcal{M}_{x}(t)$ is represented as:

\begin{equation}
    \vv{\textbf{m}}_{x}(t)= \left[ \vv{\textbf{m}}_{x}^{[1]}(t) \ \ \   \vv{\textbf{m}}_{x}^{[2]}(t) \ \ \     \vv{\textbf{m}}_{x}^{[3]}(t) \ \ \    ... \ \ \   \vv{\textbf{m}}_{x}^{[K]}(t)\right]
\end{equation}

% \begin{equation*}
%     \textbf{m}_{x}(t)= \left[ \textbf{m}_{x}^{[1]}(t) \ \ \   \textbf{m}_{x}^{[2]}(t) \ \ \     \textbf{m}_{x}^{[3]}(t) \ \ \    ... \ \ \   \textbf{m}_{x}^{[K]}(t)\right]
% \end{equation*}

% \begin{equation}
%     = \left[ x_{t}^{[1]}, ..., x_{t-\tau^{[1]}\cdot(E^{[1]}-1)}^{[1]}, x_{t}^{[2]}, ..., x_{t-\tau^{[2]}\cdot(E^{[2]}-1)}^{[2]}, x_{t}^{[3]}, ..., x_{t-\tau^{[3]}\cdot(E^{[3]}-1)}^{[3]}, ..., x_{t}^{[K]}, ..., x_{t-\tau^{[K]}\cdot(E^{[K]}-1)}^{[K]} \right]
% \end{equation}

% As discussed in~\citep{vlachos2010nonuniform}, the \textit{uniform} Multi-SSR entails using the same delay values $\tau$ and the same embedding dimensions $E$ across all $K$ time series. Conversely, \textit{nonuniform} Multi-SSR means the parameters $\tau$ and $E$ are individually selected for each time series. For the purpose of this study, we adopted the uniform Multi-SSR scheme for simplicity and consistency.

For simplicity and consistency, we adopt a uniform multiSSR scheme, where the delay values $\tau$ and embedding dimensions $E$ are the same for all $K$ time series, as suggested by \citep{vlachos2010nonuniform}.


\begin{algorithm}[htb]
    \caption{MXMap Workflow}
    \label{alg:mxmap}
    \scriptsize
    \KwData{Delay $\tau$, dimension $E$; Time series of a multivariate dynamical system $G = \{X_1, X_2, \ldots, X_n\}$; Variable indices $S := \{1, \ldots, K\}$; PCM threshold of correlation ratio $\gamma^\star$.}
    \KwResult{Adjacency matrix $\mathcal{A}$; Final children dictionary $CH$} 

    \textbf{Phase 1: Initial Causal Graph} 
    
    \For{$i \in S$}{
        \For{$j \in S$ and $j \neq i$}{
            Embed $X_i$ and $X_j$ with delay parameters $\tau$ and $E$; 
            Perform cross mappings to reconstruct $X_i$ from $X_j$ and vice versa; 

            Compute scores $\beta_{X_i\Rightarrow X_j}$ and $\beta_{X_j\Rightarrow X_i}$;

            \If{$\beta_{X_i\Rightarrow X_j} > \beta_{X_j\Rightarrow X_i}$ and both scores $\geq 0.5$}{
                Establish link $X_i\Rightarrow X_j$ (set $\mathcal{A}_{i,j}=1$ and add $j$ to $CH[i]$);
            }
            \ElseIf{$\beta_{X_j\Rightarrow X_i} > \beta_{X_i\Rightarrow X_j}$ and both scores $\geq 0.5$}{
                Establish link $X_j\Rightarrow X_i$ (set $\mathcal{A}_{j,i}=1$ and add $i$ to $CH[j]$);
            }
        }
    }

    \textbf{Phase 2: Prune Indirect Connections}

    \For{$i \in S$}{
        \For{$j \in CH[i]$}{
            \If{Longest path between $X_i$ and $X_j$ has more than 2 nodes}{
                Identify all intermediate nodes between $X_i$ and $X_j$ as set $\textit{Conds}$;
                
                Embed $X_i$, $X_j$, and $\textit{Conds}$; perform multiPCM to compute reconstructions;

                Calculate scores $\rho_{All}$, $\rho_{Direct}$, and ratio $\gamma = \rho_{Direct} / \rho_{All}$;

                \If{$\gamma < \gamma^\star$}{
                    Remove link $X_i\Rightarrow X_j$ (set $\mathcal{A}_{i,j}=0$ and remove $j$ from $CH[i]$);
                }
            }
        }
    }
    
\end{algorithm}


\subsection{Multivariate Partial Cross Mapping (multiPCM)}
\label{sec:multi-pcm}

The original PCM method considers three univariate inputs: the potential cause, effect, and condition variables. Multivariate Partial Cross Mapping (multiPCM) extends this by allowing the condition set to be multivariate, making it better suited for high-dimensional systems.

Consider a set of variables $\mathcal{G}$, with a quasi-chain structure $X_1 \Rightarrow \mathcal{G} \setminus {\{X_1, X_2\}} \Rightarrow X_2$. Here, $X_1$ is the alleged cause, $X_2$ is the alleged effect, and the rest of the variables, denoted as $\textit{Conds} := \mathcal{G} \setminus {\{X_1, X_2\}}$, serve as the condition set.

The two univariate inputs, $X_1$ and $X_2$, form univariate delay embeddings, while the multivariate condition set forms a multivariate embedding as described in Section~\ref{sec:multi-ssr}.

Similar to the original PCM as described in Section~\ref{sec:uni-pcm}, we conduct the apparent (univariate) and conditioned (multivariate) cross mappings to obtain the two correlation scores. 

\begin{itemize}
    \item \textbf{Apparent cross mapping:} Perform univariate cross mapping to reconstruct $X_1$ from $X_2$, denoted as $\hat{X_1}^{X_2}$.
    \item \textbf{Conditioned cross mapping:} Reconstruct the condition set from $X_2$, denoted by $\widehat{\textit{Conds}}^{X_2}$, and then reconstruct $X_1$ from $\widehat{\textit{Conds}}^{X_2}$, resulting in $\hat{X_1}^{\widehat{\textit{Conds}}^{X_2}}$.
\end{itemize}


The two correlation scores are then computed as follows:

% \begin{equation}
%     \rho_{All}=\left| Corr(X_1, \hat{X_1}^{X_2}) \right|
% \end{equation}
% \begin{equation}
%     \rho_{Direct}=\left| ParCorr(X_1, \hat{X_1}^{X_2} | {\hat{X_1}^{\widehat{\textit{Conds}}^{X_2}}} ) \right|
% \end{equation}

\begin{align}
    \rho_{All}=\left| Corr(X_1, \hat{X_1}^{X_2}) \right| &&  \rho_{Direct}=\left| ParCorr(X_1, \hat{X_1}^{X_2} | {\hat{X_1}^{\widehat{\textit{Conds}}^{X_2}}} ) \right|
\end{align}


Following a similar reasoning as in Section~\ref{sec:uni-pcm}, we determine whether a direct causal link exists between $X_1$ and $X_2$ by calculating the correlation ratio $\gamma = \frac{\rho_{Direct}}{\rho_{All}}$ and comparing it against an empirical threshold.


\subsection{Multivariate Cross Mapping (MXMap) for Multivariate Causal Discovery in Dynamical Systems}
\label{sec:mxmap}

We propose MXMap as a two-phase framework for multivariate causal discovery in dynamical systems. Inspired by the structure of RESIT (Regression with Subsequent Independence Test)~\citep{peters2014causal} algorithm, MXMap first establishes an initial causal graph and then prunes indirect connections (Algorithm~\ref{alg:mxmap}). 
% \textcolor{red}{Di: You may want to add line numbers for Algorithm 1.} 

The details of each phase are as follows:
\begin{itemize}
    \item \textbf{Phase 1 (Establish Initial Causal Graph):} 
    In the first phase, MXMap applies exhaustive bivariate CCM tests between all pairs of variables to establish an initial causal graph. For each pair of variables, we embed their time series using delay embedding parameters ($\tau$, $E$) and compute delay embeddings $\mathcal{M}_{X_i}$ and $\mathcal{M}_{X_j}$. Cross mapping is then performed between these embeddings to reconstruct each variable, yielding reconstructed series $\hat{X_i}$ and $\hat{X_j}$. Correlation scores are calculated for both directionsâ€”$\beta_{X_i \Rightarrow X_j}$ and $\beta_{X_j \Rightarrow X_i}$. The direction with the higher score is chosen as the causal direction, and a link is added to the initial graph accordingly. For this CCM phase, if both scores are below a correlation threshold (0.5), no link is established.
    \item \textbf{Phase 2 (Prune Indirect Causal Connections):} The initial causal graph generated in Phase 1 may contain indirect connections, which can result in an overly dense graph. In the second phase, MXMap uses multiPCM to refine the graph by pruning indirect links. For each parent-child pair in the initial graph, we identify all intermediate variables forming paths between them. We then apply multiPCM to assess whether the causal link between the parent and child is direct or goes through intermediate variables. Specifically, we embed the parent, child, and intermediate variables, and compute two correlation scores: $\rho_{All}$, representing overall correlation, and $\rho_{Direct}$, representing partial correlation conditioned on the intermediate variables and assessing the direct information transfer between parent and child variables. We calculate the correlation ratio $\gamma = \frac{\rho_{Direct}}{\rho_{All}}$ and compare it to a predefined ratio threshold $\gamma^\star$. If ratio $\gamma$ is below $\gamma^\star$, the direct information transfer isn't considered important enough, and the parent-child link is considered indirect and is removed from the graph.
\end{itemize}



