\chapter{Mixed-Frequency Quantile Regression Forests} \label{ch:MIDAS-QRF}
\chaptermark{Mixed-Frequency QRF}
\section{Introduction}

Standard regression models infer the effects of a set of covariates on the conditional expected value of the response variable. However, in real-world scenarios the effects of the covariates may vary across different parts of the outcome variable's conditional distribution. In this case, standard regression models may provide misleading results, and a more complete picture of the response variable's distribution would allow to obtain more robust results, especially if the distribution of the outcome exhibits non-Gaussian characteristics.

\vspace{0.15in}

\noindent To this end, a variety of models has been developed to estimate location parameters beyond the expected value, with Quantile Regression (QR) being one of the most important ones. Introduced in \cite{koenker1978regression} as a generalization of median regression, QR represents a flexible methodology to model data that violate the gaussianity assumptions of standard regression models. As a result, QR has become widely popular among scholars and practitioners in several fields, such as environmental science \citep{reich2012spatiotemporal, vasseur2021comparing, coronese2019evidence}, healthcare and medicine \citep{wei2006quantile,
merlo2022two, borgoni2018modelling}, finance and economics \citep{taylor1999quantile, merlo2022quantile, bernardi2018bayesian, petrella2019joint, daouia2018estimation, daouia2021expecthill}. 
\vspace{0.15in}

\noindent Although being widely applied in several empirical studies, the standard QR model may be affected by two main limitations. 
The first one arises when dealing with data collected at mixed-frequencies, as in time series modelling. In this domain, it is often necessary to incorporate information with different temporal resolution to uncover meaningful relations among the phenomena of interest. The application of standard statistical and econometrics models, including QR, usually requires the use of variables observed at the same frequency, causing potentially useful predictors to be excluded due to the temporal mismatch. 
One of the most relevant approaches developed to overcome this issue is the Mixed Data Sampling (MIDAS) model proposed by \cite{ghysels2007midas}. This approach includes mixed-frequency variables as covariates in linear models, allowing to obtain more accurate predictions. For this reason, it has been applied to a variety of fields, such as finance and economics \citep{kuzin2009midas, andreani2021multivariate, candila2023mixed}, environmental sciences \citep{oloko2022climate, jiang2023carbon} and tourism \citep{bangwayo2015can, wen2021forecasting}.
\vspace{0.15in}

\noindent Another possible limitation of the standard QR model is its reliance on the a-priori specification of the functional form of the relation between the outcome and the covariates. In many empirical applications, this relationship is often unknown and highly complex, and more robust results could be otbtained employing a non-parametric approach.
To address this issue, the standard QR approach has been extended to the machine learning realm: starting from \cite{white1992nonparametric}, which applies neural networks to QR, other contributions have incorporated QR in the most common machine learning algorithms, such as Support Vector Machines \citep{hwang2005simple, xu2015weighted} and Random Forests \citep{meinshausen2006quantile, athey2019generalized}. However, the majority of these models cannot handle mixed-frequency data. For this reason, recently \cite{xu2019artificial, xu2021qrnn} extended QR neural networks to the MIDAS framework, although they showed the presence of some drawbacks related to the low interpretability, high computational effort and high number of observations needed to train the model.\vspace{0.15in}

\noindent Thus, the aim of this chapter is to propose a comprehensive methodology to estimate quantiles that addresses the limitations of both standard QR and complex machine learning models. To this end, the MIDAS-QRF is introduced as a novel machine learning algorithm able to embed the MIDAS component into the Quantile Regression Forest algorithm (QRF) proposed by \cite{meinshausen2006quantile}. 
\vspace{0.15in}

\noindent Being based on the QRF algorithm, the proposed model offers several advantages with respect to deep learning algorithms. The MIDAS-QRF is easier to train and it also allows to extract the so called "variable importance" of each covariate,  giving insight into the relative importance of different covatiates in forecasting the response variable. These features make MIDAS-QRF particularly flexible and useful in a variety of domains and applications.
Moreover, the MIDAS components introduced in the QRF allow to model non-linear relationships among variables sampled at different frequencies without specifying a-priori any particular functional form and without making any assumption on the dependent variable's distribution. The proposed model also expands the applicability of the well known QRF, since it handles mixed-frequency data often involved in real empirical applications. Last but not least,
% Moreover, by using Quantile Regression Forests as base algorithm, the MIDAS-QRF provides better interpretability and require less computational effort compared to other machine learning algorithms, such as neural networks. 
the proposed MIDAS-QRF model is particularly suitable for empirical applications involving variables with skewed and fat-tailed distributions.

\vspace{0.15in}

\noindent Moreover, the MIDAS-QRF offer advantages also over standard statistical methods, such as multivariate splines on the covariate space. This is due to the MIDAS-QRF (and Random Forest algorithms in general) nature as an ensemble method. By combining the predictions of multiple decision trees, the MIDAS-QRF allows to reduce overfitting and improve accuracy with respect to individual models. Moreover, Contributions to the literature \citep{genuer2012variance, breiman1996bagging, breiman2001random, hastie2009random} show that this approach based on aggregation also helps in reducing the variance of the model, leading to increased stability in forecasts. Moreover, algorithms based on Random Forests are particularly effective in handling high-dimensional data, thanks to the random selection of features at each split, which mitigates the curse of dimensionality and provides insights into feature importance. Additionally, they are flexible, scalable, and can naturally handle missing values \citep{breiman2001random}. 

\vspace{0.15in}

\noindent It is quite common to encounter dependent variables in the financial domain that are not normally distributed, and are further influenced by additional covariates observed at lower frequencies, often exhibiting non-linear relationships.
\vspace{0.15in}

\noindent For this reason, the MIDAS-QRF is employed to estimate the well-known financial risk measure Value-at-Risk (VaR), which is one of key risk metrics employed for capital calculation, decision-making, and risk management within the Basel III banking framework. \citep{Jorion:1997}. From a statistical point of view, VaR represents the conditional quantile of a financial variable's distribution, and a variety of models have been applied to its estimation, such as QR, linear ARCH models \citep{koenker1996conditional, taylor1999quantile}, GARCH models \citep{xiao2009conditional, lee2013quantile, zheng2018hybrid}, penalized QR \citep{bayer2018combining}, models based on the Asymmetric Laplace distribution \citep{merlo2021forecasting, taylor2019forecasting}, as well as extensions to multivariate settings \citep{petrella2019joint, bernardi2017multiple, merlo2022quantile}. Some of these models have been also extended to account for mixed-frequency data, see for example \cite{engle2013stock, candila2023mixed} and \cite{mo2018macroeconomic}.
\vspace{0.15in}

\noindent In empirical applications involving time series, it may be useful to estimate quantiles in a dynamic framework to model the time-varying distribution of the variable of interest. In the financial literature, the Conditional Autoregressive Value-at-Risk (CAViaR) model of \cite{engle2004caviar} has been proposed to accurately model he time-changing distribution of portfolio returns. This approach is based on directly estimating the conditional quantile via a linear autoregressive model, and it has been recently extended to the mixed-frequency framework by \cite{xu2021quantile}.
\vspace{0.15in}

\noindent In the spirit of the CaViaR, this chapter proposes also an extension of the MIDAS-QRF to a dynamic framework. The resulting Dynamic MIDAS-QRF allows to estimate quantiles in an autoregressive framework by introducing the lagged quantile predictions as additional covariate similarly to the CaViaR model.

\vspace{0.15in}

\noindent Given that financial data are usually observed at different frequencies and are often characterized by the well-known stylized facts \citep{cont2001empirical}, they are rarely well-fitted by linear models. In this context, the proposed MIDAS-QRF may be more appropriate than others to obtain accurate quantile estimates. 
\vspace{0.15in}

\noindent For this reason, the proposed model is applied in an empirical setting related to the financial field. In particular, this chapter focuses on the emerging topic of the financialization of energy commodities. This products have been widely employed over the two past decades as  hedging and speculative assets, especially during
periods of financial and economic downturns. This phenomenon, along with the deregulation of over-the-
counter markets, led to a significant increase of the volatility of energy commodities returns.
Thus, the study of the risks linked to such commodities is particularly relevant under a risk management framework.
The empirical application is focused on three daily energy commodities indexes, the West Texas Intermediate (WTI) Crude Oil, the Brent Crude Oil and the Heating Oil. The aim of the empirical application is to employ the proposed MIDAS-QRF and its dynamic version to predict VaR, defined as the maximum loss that a financial operator can incur over a defined time horizon for a given confidence level. The time series spans from July 2014 to March 2022, including observations collected during the COVID-19 pandemic and at the beginning of Russian-Ukrainian conflict. In order to measure the risks associated with energy commodities, three different low-frequency covariates are considered: the monthly Real Broad Dollar Index, whose effects on oil prices have been investigated in \cite{LIN201659, AKRAM2009838}, the quarterly Natural Gas returns and the quarterly Saudi Arabia Crude Oil Production, whose link to oil prices has been extensively studied by the U.S. Energy Information Administration (EIA) \footnote{https://www.eia.gov/finance/markets/crudeoil/spot\_prices.php}.

\vspace{0.15in}

\noindent The statistical validity of the out-of-sample VaR forecasts is tested by means of backtesting procedures \citep{christoffersen1998evaluating, christoffersen2004backtesting, engle2004caviar}. The empirical results show that the proposed models outperform several well-known statistical and machine learning models often considered in the literature. A variable importance analysis is also reported to show which variables may be considered the most relevant in predicting the VaR.
The rest of the chapter is organized as follows: Section \ref{sec:MIDAS-QRF-notation} gives preliminary information on QRF, Section \ref{sec:MIDAS-QRF-methodology} describes the proposed methodology, Section \ref{sec:MIDAS-QRF-empirical} presents the empirical application of MIDAS-QRF and Section \ref{sec:MIDAS-QRF-conclusions} concludes.

%\section{Approaches to VaR estimation}

\section{Quantile Regression Forest: Notation and Preliminary Results}
\label{sec:MIDAS-QRF-notation}

This section reports the notation and some preliminars on QRF useful for the rest of the chapter. 
\vspace{0.15in}


% \subsection{Quantile Regression}
% %Starting from the quantile regression technique of \citep{koenker1978regression}, our model takes inspiration from \citep{ghysels2004midas} and \cite{candila2020using} for the MIDAS approach and from \citep{meinshausen2006quantile} for the QRF one.



%  the linear QR model is formally specified as follows:
% \begin{equation}
%     	\label{eq:QR}
%      Y_{i}=\mathbf{X}_i'\boldsymbol{\beta}_{\tau}+\varepsilon_{i}  \;\;\; \textnormal{with} \;\;\; Q_{\tau}(\varepsilon_{i}| \mathbf{X}_{i}, \boldsymbol{\beta}_{\tau})=0 \;\;\;\;\;\;\;\; \forall \; \tau \in (0,1),
% 	\end{equation}

% where $Q_{\tau}(\varepsilon_{ij}| \mathbf{x}_{it}, \boldsymbol{\beta}_{\tau}, b_{i,\tau})$ is the conditional quantile of the erratic component $\varepsilon_i$. The vector of parameters $\boldsymbol{\beta}_\tau$ is estimated by solving the following minimisation problem:

% \begin{equation}
% 	\label{eq:minimisation}
% 	\min_{\boldsymbol{\beta}_\tau\in \mathbb{R}^{p}}\sum_{i=1}^{T}\rho_\tau(y_i-\mathbf{x}'_i\boldsymbol{\beta}_\tau)
% \end{equation}

% where $\rho_\tau(u)=u(\tau-\mathbf{1}_{\{u<0\}})$ is the quantile loss function, i.e. the check function, of \cite{koenker1978regression}.

% % QR can be implemented to estimate VaR by expressing VaR as the quantile at level $\tau$ of a financial variable's distribution at time $i$: 

% % \begin{equation}
% % \mathbb{P}(Y_i<-VaR_i|\mathcal{F}_{i-1})=\tau
% % \end{equation}

% % where $Y_i$ represents the financial returns variable and $\mathcal{F}_{i-1}$ is the $\sigma$-algebra representing the information available at time $i-1$.

% %  In this sense, the computation of VaR can be performed in a parametric linear setting through the QR model of \eqref{eq:QR}. 
%  In the next paragraph we present the extension of the QR model to a non-parametric setting with the QRF algorithm of \cite{meinshausen2006quantile}.
 
 


 \noindent Let $\mathcal{S}=\{(Y_i, \mathbf{X}_i)\}_{i=1}^N$ be a random sample of dimension $N$ of random variables drawn from the unknown joint distribution of the random variables $(Y, \mathbf{X})\in \mathbb{R} \times  \mathbb{R}^p$ with realisation $\mathbf{s}=\{(y_i, \mathbf{x}_i)\}_{i=1}^N$, where $Y$ is the response variable and $\mathbf{X}$ the vector of $p$ covariates.
 \vspace{0.15in}

\noindent The QRF algorithm \citep{meinshausen2006quantile} has been developed as an extension to the Random Forests (RF) algorithm introduced by \cite{breiman2001random}. Both models rely on the Classification and Regression Trees (CART) \citep{breiman1984classification} algorithm. Differently from the the Random Forest approach, which estimates the conditional expected value, the QRF estimates the quantile of the conditional distribution of $Y$.
\vspace{0.15in}


% In particular, the QRF algorithm consists in training $B$ decision trees indexed with $b=1, \dots, B$ and by computing the final prediction as the average of the decision trees' predictions.
\noindent Specifically, each decision tree in the QRF is trained with the CART algorithm, that consists in recursively partitioning the training sample $\mathcal{S}$ into $M$ disjoint sub-samples denoted with $R_m, m=1, \dots, M$ according to a splitting rule. In this setting, the splitting rule is based on minimizing the the Sum of Squared Errors (SSE) in each sub-sample of $R_m$:

\begin{equation}
SSE_{R_m}= \; \; 
\sum_{y_i \in R_m} (\bar{y}_m - y_i)^2,
\end{equation} 

\noindent where $\bar{y}_m$ is the mean of the observations in $R_m$ \footnote{Other splitting rules can be considered. For instance, \cite{athey2019generalized} proposes to use a quantile loss-base splitting rule. The choice of the splitting rule depends mainly on the empirical application of interest and the final forecast accuracy, as no contribution in the literature offers clear and robust evidence for choosing one approach over another in quantile regression settings.
In this thesis, the standard QRF approach of \cite{meinshausen2006quantile} has been chosen since it is more established in the machine learning literature. However, the proposed model can be easily adapted to consider other QRF models with different splitting rules.}. 
\vspace{0.15in}


\noindent At the end of the tree training, each sub-sample that is no further splitted is denoted as "terminal node" and indicated with $R^{*}_m$. 

\vspace{0.15in}

\noindent The QRF prediction of the conditional quantile $Q_{\tau}(Y|\mathbf{X}=x)$ is obtained from the estimated conditional distribution $F(y |\mathbf{X}=x)$, defined as follows:

% \begin{equation}
% 	\label{eq:tree}
%  \hat{y}_{i}= \frac{1}{|R_m|} \sum_{y_i \in R^*_m}   y_i
%  \end{equation}

% In the standard RF algorithm, the prediction $\hat{y}^{RF}_{i}$ is obtained as:
% \begin{equation}
% 	\label{eq:rf} 
%  \hat{y}^{RF}_{i}= \frac{1}{B}\sum_{b=1}^B \hat{y}_{i, b} 
%  \end{equation}



\begin{equation}
	\label{eq:qrfconddistr}
	\begin{aligned}
		F(y|\mathbf{X}=x)
		&:=P(Y\leq y|\mathbf{X}=x )\\
		&:=\mathbb{E}[\mathbf{1}_{\{Y\leq y\}}|\mathbf{X}=x]
	\end{aligned}
\end{equation}

\noindent In particular, given a new set of observations, $\hat{F}(y|\mathbf{X}=x)$ is estimated by individuating one terminal node $R^{*}_m$ in each tree and by averaging the estimations of the $B$ trees:

\begin{equation}
		\hat{F}(y|\mathbf{X}=x )=\frac{1}{B}\sum_{b=1}^{B}\sum_{Y_i \in {R^{*}_{m,b}}} \frac{\mathbf{1}_{\{Y_{i}\leq y\}}}{|{R^{*}_{m,b}}|} ,
	\end{equation}

\noindent Subsequently, the quantile at probability level $\tau \in (0,1)$ is estimated as follows:

\begin{equation}
\hat{Q}_{\tau}(Y|\mathbf{X}=x) := \inf \, \{y : \widehat{F} \; (y|\mathbf{X}=x ) \leq \tau\}
\end{equation}

\noindent The QRF also computes the Variable Importance of each covariate, i.e. the influence of each covariate on the model's performance. The bigger the importance, the greater the positive effect of the variable on the model's accuracy. This feature improves the interpretability of the phenomena of interest and it can be considered as a nice property held by Random Forests with respect, for instance, to Neural Networks. 

\vspace{0.15in}

\noindent As mentioned in the introduction, the standard QRF algorithm cannot handle directly mixed-frequency data as many other models, and the aim of this chapter is to fill this gap by introducing mixed frequency variables in a QRF framework exploiting the MIDAS approach. 

\vspace{0.15in}

\noindent The methodology of the resulting MIDAS-QRF is presented in the next section.


\section{Methodology}
\label{sec:MIDAS-QRF-methodology}

This section describes the MIDAS-QRF methodological approach, developed to extend the QRF algorithm of \cite{meinshausen2006quantile} via the MIDAS approach of \cite{ghysels2007midas} in order to handle mixed-frequency data in quantiles estimation via Random Forests. %\textcolor{violet}{As first attempt we propose Firstly, we introduce the static version of our model, denoted MIDAS-QRF, then, we illustrate its extension to a dynamic framework.} 

\subsection{The MIDAS-QRF Model}
Let $Y_{i,t}$ and $\mathbf{X}_{i,t}$, $i=1, \dots, N_t, t=1, \dots, T$ be the high-frequency response variable and the set of high-frequency covariates observed at time $i$ of the $t-th$ period of the year. Moreover, $\textbf{Z}_t=\{Z_t^h\}^{H}_{h=1}$ is the vector of H low-frequency covariates observed in the $t-th$ period of the year. In this sense, $T$ represents the overall number of low-frequency periods. 

\vspace{0.15in}

\noindent For instance, if $Z_t$ is observed monthly, $T=12$ and the value $N_t$ represents the total number of days in the $t-th$ month. In a financial setting, the variable $Y_{i,t}$ may represent the daily financial returns sampled at day $i$ while the low-frequency variables might be monthly economic variables measuring the general state of the economy, sampled at the $t-th$ month of the year.
\vspace{0.15in}

\noindent The MIDAS approach proposed by \cite{ghysels2007midas} allows to include mixed-frequency variables in the QRF model, where the dependent variable is observed at a higher-frequency than the covariates.
\vspace{0.15in}

\noindent The simplest MIDAS linear regression is:

\begin{equation}
	\label{eq:MIDAS}
	Y_{i,t}=\beta_0+\beta_1MC_{i-1,t}^1+\dots+\beta_H MC_{i-1,t}^H+ \varepsilon_{i,t}
\end{equation}

where the covariate $MC_{i,t}^h=(\sum_{j=1}^{K}\phi_k(\bm{\omega})Z_{t-j}^h)_{i,t}$ is the MIDAS component, a filter of the last $K$ observations of $Z^h$ up to time $i-1$ of the $t$-th period. The number of lags $k$ can be chosen arbitrarily or via grid search. For interpretability purposes, in this chapter the number $k$ is chosen so that to consider meaningful fraction of the year (for instance, for monthly variables it would makes sense to consider three months, that is $k=3$).

The function $\phi_k(\boldsymbol{\omega})$ is the Beta weighting function (see \cite{candila2023mixed} and references therein) in which $\boldsymbol{\omega}=(\omega_1, \omega_2)$:

\begin{equation}
	\label{eq:beta}
	\phi_k(\omega_1, \omega_2)=\frac{(k/K)^{\omega_1-1}(1-k/K)^{\omega_2-1}}{\sum_{j=1}^{K}(j/K)^{\omega_1-1}(1-j/K)^{\omega_2-1}}.
\end{equation}

This function allows to impute a greater weight to more recent observations by setting $\omega_1=1$ and optimising $\omega_2$ with respect to the model's likelihood or a proper loss function. 
% For this reason, the MIDAS model greatly relies on the selection of an optimal $\omega_2$ to capture the long memory properties of the data. 
Other weighting functions are discussed in \cite{ghysels2019estimating}. 

\vspace{0.15in}

\noindent In this chapter, the linear specification of \eqref{eq:MIDAS} is relaxed by considering:
\begin{equation}
\label{eq:RF2}
Y_{i,t}=f(\mathbf{X}_{i-1,t}, \mathbf{MC}_{i-1,t})+\varepsilon_{i,t}
\end{equation}
where $f(\cdot)$ is a non-parametric function and $\mathbf{MC}_{i-1,t}=\{MC_{i-1,t}^h\}_{h=1}^H$  is the matrix of MIDAS components related to the set of covariates $\mathbf{Z}_t$.

\vspace{0.15in}

\noindent Being interested in the VaR of $Y_{i,t}$, the MIDAS-QRF estimates the conditional quantile:

\begin{equation}
\hat{Q}_{\tau}(Y_{i,t}|\mathbf{X}_{i-1,t}, \mathbf{MC}_{i-1,t})=f_{\tau}(\mathbf{X}_{i-1,t}, \mathbf{MC}_{i-1,t})
\end{equation}
by including the MIDAS covariates in the QRF model. This is achieved by training the QRF with the training set $\mathbf{s}^*=\{(y_{i,t}, \mathbf{x}_{i-1,t}, \mathbf{MC}_{i-1,t})\}_{i=1, t=1}^{N_t,T}$, which includes the observations of the MIDAS component of each low-frequency covariate.
%framework by computing $\hat{f}(\mathbf{X}_{i-1,t}, \mathbf{MC}_{i-1,t})$ with a QRF.}

%Thus, the training set used to train the MIDAS-QRF is $\mathbf{s}^*=\{(y_{i,t}, \mathbf{x}_{i-1,t}, \mathbf{MC}_{i-1,t})\}_{i=1, t=1}^{N_t,T}$. 
%The quantile estimation $\hat{Q}_{\tau}(Y_{i,t}|\mathbf{X}_{i-1,t}, \mathbf{MC}_{i-1,t})$ is obtained as: 
%\begin{equation}
%\hat{Q}_{\tau}(Y_{i,t}|\mathbf{X}_{i-1,t}, \mathbf{MC}_{i-1,t})=\hat{f}(\mathbf{X}_{i-1,t}, \mathbf{MC}_{i-1,t})
%\end{equation}

%\textcolor{violet}{In this contest the function \eqref{eq:beta} cannot be computed as in the parametric MIDAS models in order to compute $MC_{i-1,t}^h$, so to }
\vspace{0.15in}

\noindent In this non-parametric context, the likelihood of the MIDAS-QRF model cannot be computed, and consequently $\omega_2$ cannot be optimized via maximum likelihood as in the standard MIDAS model.
To overcome this issue, the optimal $\omega_2$ could be found via grid search as the one delivering the higher forecast accuracy. A similar approach is also discussed in \cite{candila2023mixed}. However, this procedure can be particularly burdersome if the vector $\textbf{Z}_t$ is large. \vspace{0.15in}

\noindent Thus, proposed methodology reduces the computational effort of the MIDAS-QRF training as follows. For each covariate $Z_h$, a set of $MC_{i-1,t}^h$ is computed by using different values of $\omega_2$, obtaining a matrix of MIDAS components. Then, the Principal Component Analysis (PCA) is applied on the resulting matrix to reduce its dimensionality, and the first component of the PCA is used in $\mathbf{s}^*$ as MIDAS component related to $Z_h$.
This procedure is performed separately for each low-frequency covariate in the training set.
\vspace{0.15in}

\noindent The main benefit of this approach is that it retains the most important information in $Z_h$ while reducing computational effort and training time for the MIDAS-QRF. Additionally, like the standard QRF, the MIDAS-QRF assesses the relevance of each covariate in predicting the response variable through the Variable Importance measure. Although this measure cannot be interpreted as the coefficients in parametric models, it allows to enhance the interpretability of Random Forests-based models compared to other machine learning algorithms.
\vspace{0.15in}

\noindent A potential limitation of the MIDAS-QRF is that the estimation procedure to obtain MC values can increase variability in MIDAS-QRF estimates, a common issue in MIDAS models. However, being based on Random Forests, the MIDAS-QRF algorithm allows to reduce estimates variability due to its ensemble nature. Additionally, the MIDAS-QRF retains all statistical properties of the standard QRF algorithm since the MIDAS component is considered as an additional covariate in the training set. For more details on the MIDAS-QRF and QRF statistical properties, refer to \cite{meinshausen2006quantile}, in which the model's consistency is shown along with numerical examples.

\subsection{Variable Importance computation}

Variable Importance is usually computed permuting the observations of the generic $p$-th covariate and measuring the effect on the model's forecast accuracy. 
The idea behind this procedure is that if a covariate significantly affects the model's performance, permuting its values would result in a decrease in forecast accuracy. On the contrary, if the covariate is less important, permuting its values should have minimal influence on the model's performance.
\vspace{0.15in}

\noindent More in detail, the Variable Importance  is computed in two steps. In the first step, Out-Of-Bag (OOB) observations of the training set are used to compute the Sum of Squared Residuals (SSR) of the QRF, denoted with $m$:

\begin{equation}
    m=\sum_{i=1}^S (y_i^{OOB}-\hat{y}_i)^2
\end{equation}

\noindent where $S$ denotes the total number of OOB observations selected in the procedure (in empirical setting, this number is usually pre-determined by the function used to implement the algorithm) and $y_i^{OOB}$ is the $i-th$ OOB observation of the outcome variable.

\noindent Subsequently, the observations of the $p$-th covariate are permuted, and the SSR is re-calculated. The resulting SSR is denoted with $m^*$. 
The importance of the $p$-th variable at each quantile level $\tau$, denoted with $I_{p, \tau}$, is measured as:
\begin{center}
\begin{equation}
I_{p, \tau}=m-m^*
\end{equation}
\end{center}
The bigger the decrease of the SSR after permutation, the greater the variable importance.
The ability to extract the Variable Importance measure allows the MIDAS-QRF to retain the grade of interpretability of standard Random Forest-based algorithms.
\vspace{0.15in}

\noindent In this chapter, the Variable Importance of the covariates included in the training set is extracted to gain a deeper insight into the results obtained in Section \ref{sec:MIDAS-QRF-empirical}.

\subsection{Dynamic MIDAS-QRF}

In order to model the quantile in a dynamic framework, the MIDAS-QRF approach is extended to an autoregressive framework. A dynamic approach to quantile estimation has already been introduced in a parametric setting with the CaViaR model of \cite{engle2004caviar}. The aim of this study is to apply this well-established autoregressive approach to the MIDAS-QRF. Thus, the resulting Dynamic MIDAS-QRF relies on considering lagged values of the quantile predictions as additional covariate used to train the model.

\vspace{0.15in}

\noindent The iterative algorithm of the Dynamic MIDAS-QRF consists in an initialisation phase and a two-step procedure. Denoting with $R= \sum_{t=1}^T N_t$ the total number of observations in $\mathbf{s}^*$, in the initialization consists in computing a vector of quantile forecasts $\mathbf{\hat{Q}}^{\tau}_0=\{\hat{Q}_{r}^{\tau}\}_{r=1}^{V-1}$ with $V<R$ using any suitable autoregressive model, such as CaViaR. 

\vspace{0.15in}

\noindent Then, the two-step procedure consists in:
\begin{enumerate}

\item \textbf{First step}: a MIDAS-QRF is trained considering the training set 
\newline $\mathbf{s}^*=\{y_r, \mathbf{x}_{r-1}, \mathbf{MC}_{r-1}, \hat{Q}_{r-1}^{\tau}\}_{r=1}^{V}$ and used to compute the quantile prediction $\hat{Q}_{V}^{\tau}$.

\item \textbf{Second step:} the training set is updated with the additional quantile prediction $\hat{Q}_{V}^{\tau}$ and the MIDAS-QRF is trained again.
\end{enumerate}

\vspace{0.15in}

\noindent The algorithm iterates between these two steps until the entire dataset 
\newline $\mathbf{s}^*=\{y_r, \mathbf{x}_{r-1}, \mathbf{MC}_{r-1}, \hat{Q}_{r-1}^{\tau}\}_{r=1}^{R}$ is included in the training set with their respective quantile predictions. Finally, a vector of quantile predictions $\hat{\mathbf{Q}}^\tau=\{\hat{Q}^{\tau}_{r}\}_{r=1}^{R}$ is obtained and can be used also to evaluate the forecast accuracy of the model.


\section{Empirical Application} \label{sec:MIDAS-QRF-empirical}

Over the past two decades, there has been a growing interest among investors in using energy commodities as hedging and speculative assets, especially during periods of financial and economic downturns. This phenomenon, known as the financialization of energy commodities, along with the deregulation of over-the-counter markets, led to a significant increase of the volatility of energy commodities returns. 
\vspace{0.15in}

\noindent Thus, the study of the risks linked to such commodities is particularly relevant under a risk management framework. 
For this reason, this section shows the empirical application of the static and dynamic versions of the MIDAS-QRF to forecast the well-known financial risk measure VaR of three energy commodities: WTI Crude Oil, Brent Crude Oil and Heating Oil.
The performance of the proposed models is measured in terms of statistical adequacy by means of backtesting procedures, and in terms of forecast accuracy, measured using the quantile loss function, i.e. the check function, of \cite{koenker1978regression} $\rho_\tau(u)=u(\tau-\mathbf{1}_{\{u<0\}})$. The data summary statistics of the log-returns of each index are reported in Table \ref{tab:sum-stats} along with their graphs in Figures \ref{fig:wti}-\ref{fig:brent}-\ref{fig:heat}.


\vspace{0.15in}

\noindent The MIDAS-QRF and its dynamic specification are employed to estimate one-step-ahead VaR forecasts at three different probability levels ($\tau=0.01, 0.025, 0.05$) with an expanding-window approach by refitting the models every ten days.
The training set considers time series spanning from September 2014 to October 2019. The forecasts are made on an out-of-sample test set composed of 700 observations from November 2019 to April 2022, covering the pre-pandemic, pandemic and post-pandemic period, including the beginning of the Russian-Ukrainian conflict. The richness of information contained in this specific time span allows to train the model in "standard" settings and testing it in setting in which low volatility periods are alternated by periods of high volatility. This approach allows to test the ability of the model to obtain reliable forecast both in standard settings and in unseen and unexpected situations.

\vspace{0.15in}

\noindent The covariates set includes both low-frequency and daily variables. The low-frequency variables are the monthly Real Broad Dollar Index (DOLL), the quarterly Natural Gas returns (NATGAS) and the quarterly Saudi Arabia Crude Oil Production (SAUDI-PROD). Daily variables are the daily lag 1 and lag 2 of the indexes of interest along with the daily Standard and Poor's 500 Index (SP500). The number of lags was selected to create a dataset of manageable size, enabling a comparison between the proposed MIDAS-QRF model and simpler models that consider only a single covariate. All the daily, monthly and quarterly time series have been by computing their log-returns.
The dynamic MIDAS-QRF is trained with the same dataset used for the static version, but the lagged vector of quantile forecasts is introduced as additional covariate, denoted with $lag\_quant$.

\noindent Thus, the MIDAS-QRF equation in this empirical application is:

\begin{equation}
\footnotesize
\hat{Q}_{\tau}(Y_{i,t}|X_{i,t}, \mathbf{MC}_{i-1,t})^{MIDAS-QRF}=f_{\tau}(SP500_{i,t}, MC_{i-1,t}^{DOLL}, MC_{i-1,t}^{NATGAS}, MC_{i-1,t}^{SAUDI})
\end{equation}
 And the dynamic MIDAS-QRF model equation is:


\begin{equation}
\footnotesize
\begin{aligned}
    \hat{Q}_{\tau}(Y_{i,t}|\mathbf{X}_{i,t},\mathbf{MC}_{i-1,t})^{DYN} = f_{\tau}(lag\_quant_{i-1,t},
    SP500_{i,t},     MC_{i-1,t}^{DOLL}, MC_{i-1,t}^{NATGAS}, MC_{i-1,t}^{SAUDI})
\end{aligned}
\end{equation}


\vspace{0.15in}

\noindent The benchmark models set includes the parametric models GARCH and GARCH-MIDAS \citep{engle2013stock}  with Gaussian and Student's-t distributions of the errors, semi-parametric models, that are the four different specifications of the CaViaR model, namely Asymmetric Slope (AS), Symmetric Absolute Value (SAV), Indirect GARCH (IG) and Adaptive (AD), and the standard Quantile Regression Forest of \cite{meinshausen2006quantile}. The functional form of the parametric and semi-parametric models is reported in Table \ref{tab:models_eq}.

\begin{landscape}
    \input{MIDAS-QRF/tables/models}
\end{landscape}

\noindent The computational time to fit the MIDAS-QRF and its dynamic specification is equal, on average, to 471 seconds on an ordinary multi-CPU server Intel Xeon with 24 cores.

\subsection{Backtesting Procedures}

Backtesting procedures represent statistical tests employed in VaR analysis to assess the accuracy and reliability of the the models used to forecast VaR.

\noindent The main backtesting procedures commonly used in the VaR literature and used in this thesis are:

\begin{itemize}
    \item \textbf{Unconditional Coverage Test} \citep{kupiec1995techniques}: tests whether the actual frequency of VaR violations (instances where actual losses exceed the predicted VaR) matches the expected violation frequency. For accurate models, the proportion of VaR violations should align with the VaR confidence level (e.g., for a 5\% VaR, breaches should occur about 5\% of the time).

    \item \textbf{Conditional Coverage Test} \citep{christoffersen1998evaluating}: combines the Unconditional Coverage Test with an independence test to evaluate whether the VaR violations are randomly distributed over time and are, thus, independent. As a matter of fact, the presence of clustered violations might indicate a not reliable and robust model. 

\item \textbf{Dynamic Quantile Test} \citep{Manganelli:2004}: tests whether the VaR violations are serially uncorrelated conditional on previous quantile estimates. 
\end{itemize}

\subsection{MIDAS-QRF Results}
The results in terms of quantile loss and backtesting procedures for the MIDAS-QRF model are presented in Tables \ref{tab:brent}-\ref{tab:wti}-\ref{tab:heat}. The columns UC\_pval, CC\_pval and DQ\_pval indicate the p-value results of the Unconditional Coverage, Conditional Coverage and Dynamic Quantile tests, respectively. The AE column reports the Actual over Expected exceedance ratio. The column $\%Loss$ indicates the ratio between the loss of the static version of the MIDAS-QRF model with respect to the other benchmark models:

$$
\textit{\% Loss}=\frac{Loss_{MIDAS-QRF}}{Loss_{Benchmark}}
$$


\vspace{0.15in}

\noindent The results of the backtesting procedures show that, differently from the benchmark models, the MIDAS-QRF consistently delivers adequate forecasts at all quantile levels for each index. For instance, for the Brent index the MIDAS-QRF is the only model passing all the backtesting procedures at quantile level $0.01$. In terms of forecast accuracy, the MIDAS-QRF outperforms every benchmark model for all index, with a consistent increase in accuracy at the lower quantile levels of the Brent and WTI index.


\input{MIDAS-QRF/tables/tab-brent}

\input{MIDAS-QRF/tables/tab-wti}

\input{MIDAS-QRF/tables/tab-heat}

\newpage

\subsection{Dynamic MIDAS-QRF Results}
The forecast accuracy and the results of the  backtesting procedures of the dynamic MIDAS-QRF model are presented in Tables \ref{tab:brent-dyn}-\ref{tab:wti-dyn}-\ref{tab:heat-dyn}.

\vspace{0.15in}

\noindent These results highlight that, similarly to the MIDAS-QRF, the Dynamic MIDAS-QRF passess all of the backtesting procedures at all quantile levels for each index. In terms of forecast accuracy, the dynamic specification of the MIDAS-QRF outperforms all benchmark models at all quantile level of every index, and the most relevant increase in forecast accuracy is achieved for the WTI and Brent index.
Moreover, the comparison in terms of forecast accuracy with the static MIDAS-QRF highlights that the autoregressive structure of the dynamic MIDAS-QRF  allows to gain a higher degree of accuracy especially at the lower quantile level $0.01$ of each index. This result suggests that introducing a dynamic element into the MIDAS-QRF allows to model tail risk more accurately, especially when the distribution of the variable changes over time.

\input{MIDAS-QRF/tables/tab-brent-dyn}

\input{MIDAS-QRF/tables/tab-wti-dyn}

\input{MIDAS-QRF/tables/tab-heat-dyn}

Figure \ref{fig:heat-pred} displays the predictions at the three quantile levels of the Heating Oil indexes obtained with both versions of the MIDAS-QRF model. Predictions of the remaining two indexes are represented in Figures \ref{fig:brent-pred}-\ref{fig:wti-pred}. It is worth noticing that, for all three indexes, both the MIDAS-QRF and its dynamic specification effectively manage to obtain accurate forecasts both in situations similar to the one in the training set, as well as during the unexpected high volatility periods related to the pandemic and the Russian-Ukrainian conflict.


\begin{figure}[H]
    \centering
    \includegraphics[width=0.93\textwidth]{MIDAS-QRF/images/heat_pred.pdf}
\includegraphics[width=0.93\textwidth]{MIDAS-QRF/images/heat_pred_dyn.pdf}
    \caption{Heating Oil (black line) index out-of-sample predictions at quantile levels $\tau= 0.01, 0.025, 0.05$. The top panel and the bottom panel show the predictions obtained with the dynamic MIDAS-QRF model, respectively.}
    \label{fig:heat-pred}
\end{figure}


\subsection{Variable Importance}

The variable importance of the static and dynamic MIDAS-QRF is computed to evaluate the relevance of macroeconomic variables and the $lag\_quant$ variable in training the MIDAS-QRF and the dynamic MIDAS-QRF.
Figures \ref{fig:imp_01}-\ref{fig:imp_025}-\ref{fig:imp_05} depict the bar graphs showing the variable importance of the proposed models at all three quantile levels for the Heating Oil index. 

\vspace{0.15in}

\noindent The variable importance analysis reveals the significant role of macroeconomic variables in both the static and dynamic MIDAS-QRF models. For instance, in the MIDAS-QRF the variable DOLL is among the top three important variables across all quantile levels. The importance of the other two low-frequency variables changes across quantile levels, but it is always positive. 
Concerning the dynamic MIDAS-QRF instead, the most important variable at all quantile level  is $lag\_quant$, highlighting the relevant role of the dynamic component in training the proposed model. Similarly to the static MIDAS-QRF, the most important low-frequency variable is DOLL, whereas the importance of the other two low-frequency variables remains positive at all quantile levels.

\vspace{0.15in}

\noindent As well as for the Heating Oil index, also for the other two indexes, all the macroeconomic variables and the $lag\_quant$ variable play a significant role in training the two versions of the proposed model. In particular, for the Brent index all three macroeconomic variables are among the most important variables both in the static and dynamic MIDAS-QRF, especially the DOLL one.

\vspace{0.15in}

\noindent In conclusion, these results highlight the relevant role of macroeconomic variables in capturing market risk at low quantile levels and in delivering accurate forecasts. The results also show that the forecast accuracy of the MIDAS-QRF can be further improved by adding a dynamic component. In this case, empirical results show that also the dynamic MIDAS-QRF outperforms benchmark models and passes all the backtesting procedures.

\begin{figure}[H]
    \centering
    \captionsetup{width=.8\linewidth}
\includegraphics[trim={0.6cm 0 0 0},clip, width=\textwidth, height=9.5cm]{MIDAS-QRF/images/graphs/varimp_0.01_HEATING_OIL.pdf}
\includegraphics[trim={0.6cm 0 0 0},clip, width=\textwidth, height=9.5cm]{MIDAS-QRF/images/graphs/varimp_dyn_0.01_HEATING_OIL.pdf}
\caption{Variable importance for the static MIDAS-QRF at $\tau=0.01$ for the Heating Oil index}
\label{fig:imp_01}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[trim={0.6cm 0 0 0},clip, width=\textwidth, height=9.5cm]{MIDAS-QRF/images/graphs/varimp_0.025_HEATING_OIL.pdf}
    \includegraphics[trim={0.6cm 0 0 0},clip, width=\textwidth, height=9.5cm]{MIDAS-QRF/images/graphs/varimp_dyn_0.025_HEATING_OIL.pdf}
    \caption{Variable importance for the static MIDAS-QRF at $\tau=0.025$ for the Heating Oil index}
    \label{fig:imp_025}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[trim={0.6cm 0 0 0},clip, width=\textwidth, height=9.5cm]{MIDAS-QRF/images/graphs/varimp_0.05_HEATING_OIL.pdf}
    \includegraphics[trim={0.6cm 0 0 0},clip, width=\textwidth, height=9.5cm]{MIDAS-QRF/images/graphs/varimp_dyn_0.05_HEATING_OIL.pdf}
    \caption{Variable importance for the static MIDAS-QRF at $\tau=0.05$ for the Heating Oil index}
    \label{fig:imp_05}
\end{figure}


 \section{Conclusions}
 \label{sec:MIDAS-QRF-conclusions}
 
 
This chapter introduces a new model called MIDAS-QRF to compute conditional quantiles in a machine learning framework to jointly account for complexity, non-linearity and mixed-frequencies in data. The proposed model relies on the MIDAS methodology of \cite{ghysels2007midas}  to exploit information coming from low-frequency variables in order to compute quantiles through the QRF algorithm of \cite{meinshausen2006quantile}, which allows to infer the entire conditional distribution of the response variable through the Random Forest algorithm \citep{breiman2001random}. 

\vspace{0.15in}

\noindent The benefits of this approach are twofold: first, it allows to model non-linear relations among variables without making any parametric assumption and to study the behaviour of the phenomena on the tails. In this sense, the MIDAS-QRF results particularly useful in settings characterised by complex relationships among variables, such as the financial and economics one.
Second, it extends the QRF algorithm by considering mixed-frequency data by introducing a feature that has never been considered in in Random Forests algorithms. 
Moreover, the employment of the PCA on the low-frequency variables to compute the MIDAS components offers a novel perspective on estimating the $\omega_2$ parameter of the MIDAS model while shrinking the computational burden of the MIDAS-QRF training.
\vspace{0.15in}

\noindent The proposed model is applied to a real financial dataset to forecast the VaR of three commodities index. The empirical findings highlight the relevant role of macroeconomic variables in capturing market risk at low quantile levels to deliver accurate forecasts. The results also show that the forecast accuracy of a MIDAS-QRF model can be further improved by adding a dynamic component to model the dynamic distribution of financial variables. In this case, also the dynamic MIDAS-QRF outperforms benchmark models and passes all the backtesting procedures.




