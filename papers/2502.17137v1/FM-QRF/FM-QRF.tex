\chapter{Finite mixtures of Quantile Regression Forests and their application to GDP growth-at-risk from climate change} \label{ch:FM-QRF}
\chaptermark{Finite Mixtures of QRF}
\section{Introduction}
\label{sec:1}

Regression models target the expected value of the conditional distribution of the outcome given a set of covariates. When the distribution of the outcome is asymmetric, modelling other location parameters, e.g. percentiles of the conditional distribution, may offer a more complete picture of the outcome of the distribution compared with models describing only its centre. 

\vspace{0.15in}

\noindent The idea of modelling location parameters has a long history in statistics. The seminal paper of \cite{koenker1978regression} is regarded as the first detailed development of Quantile Regression (QR), which represents a generalization of median regression. QR approach is particularly useful when modeling data characterised by skewness, heavy tails, outliers, truncation, censoring and heteroschedasticity. The flexibility of this model allows for a wide range of applications in fields such as economics, finance, healthcare, environmental science, and marketing; for a detailed review of the most used QR techniques, see \cite{koenker2005quantile} and \cite{koenker2017handbook}. 

\vspace{0.15in}

\noindent Recently, extensions of QR modelling have been proposed in high dimensional framework and in a non-parametric context
including the QR Neural Networks \citep{white1992nonparametric}, the QR Support Vector Machines \citep{hwang2005simple, xu2015weighted} the QR kernel based algorithms \citep{christmann2008consistency} the QR Forests (QRF) \citep{meinshausen2006quantile} and the Generalized QR Forests 
\citep{ athey2019generalized}.

%\textcolor{red}{The capabilities of QR have been extended to allow for more accurate and robust modeling of complex data structures with the use of machine learning algorithms and mixed-effects models.
%Machine learning models applied to QR include QR Neural Networks \cite{white1992nonparametric}, QR Support Vector Machines \citep{hwang2005simple, xu2015weighted}, QR kernel based algorithms \citep{christmann2008consistency}, QR Forests (QRF) \citep{meinshausen2006quantile} and Generalized QR Forests 
%\citep{ athey2019generalized}.}
\vspace{0.15in}

\noindent Empirical applications often entail dependent observations in the form of hierarchically structured data: this is the case of spatial, multilevel or longitudinal sample designs. In these contexts, when regression models are considered, the potential association between dependent observations should be taken into account in order to provide valid and efficient inferences. This is often achieved by using random of mixed effects model where subject-specific random effects are considered in the linear predictors.

\vspace{0.15in}

\noindent Throughout the statistical and econometrics literature only recently random effects models have been used to capture the dependence from a QR perspective for clustered, multilevel, spatial and repeated measurements. Applications in fields such as medicine, environmental science, finance and economics have been particularly studied: for a detailed review of these techniques see for example \citet{farcomeni2012quantile, smith2015multilevel, alfo2017finite, marino2018mixed, merlo2021forecasting, hendricks1992hierarchical,pandey1999comparative, reich2011bayesian, bassett2002portfolio, kozumi2011gibbs, bernardi2015bayesian, bernardi2018bayesian,merlo2022quantile,merlo2022quantilets}.

\vspace{0.15in}

\noindent In these models, individual-specific random effects (coefficients) result useful to describe the influence of omitted covariates on parameter estimates of the observed ones. In this context, the random effects (coefficients) are often thought of as representing (individual-specific) unobserved heterogeneity, while observed covariates describe the observed counterpart (the fixed part of the models). However, in some applications a parametric assumption on the fixed part of the model may not be appropriate, leading to inaccurate conclusions regarding the phenomenon of interest. For this reason, QR machine learning models, incorporating random effects, may be more suitable to model complex and non-linear relationships among the response variable and the covariates in case of hierarchically structured data.

%estimate the differences between statistical units by means of random-effects and population-level relationships with “fixed-effects” relying on a-priori parametric specification (linear or non-linear) of the fixed-effects, such as parametric distribution-free approaches \citep{koenker2004quantile, fu2012quantile, galvao2010penalized,galvao2011quantile, lipsitz1997quantile} and non-linear parametric approaches \citep{geraci2019modelling, wang2012bayesian, galarza2020quantile}. % Others, such as \cite{laird1978nonparametric}, exploit the Maximum Likelihood (ML) approach to QR presented in previous contributions \citep{yu2001bayesian, bernardi2018bayesian, petrella2019joint, harding2009quantile, barnes2002quantile, taylor2019forecasting} and representing a valid data-driven approaches resistant to misspecification \citep{farcomeni2012quantile, alfo2017finite, merlo2022two}. 

\vspace{0.15in}

\noindent Only recently random effects machine learning algorithms have been introduced to model dependence in a standard regression framework; see, for example, Mixed-Effects Neural Networks \citep{xiong2019mixed}, Mixed-Effects Support Vector Machines \citep{luts2012mixed} and Mixed-Effects Random Forests \citep{hajjem2014mixed, hajjem2011mixed, sela2012re}). These models are inadequate when the main interest of the research is the conditional quantiles of the distribution of the outcome. 

\vspace{0.15in}

\noindent This chapter aims at filling this gap by introducing a new model called Finite Mixtures of Quantile Regression Forests (FM-QRF). The aim of the proposed methodology is to build a data-driven model to estimate quantiles of longitudinal data in a  non-parametric framework. To this end, the QR finite mixtures approach of \citep{merlo2022two, tian2014linear, tian2016class, alfo2017finite} is extended to the machine learning realm. The FM-QRF is based on well known random effects machine learning algorithms, but leaves the random effects distribution unspecified and estimates the fixed part of the model with a QRF. 
\vspace{0.15in}

\noindent The quantile estimates are obtained with an iterative procedure based on the Expectation Maximization-type algorithm (EM) using the Asymmetric Laplace distribution (AL) as working likelihood.
The suggested methodology may be considered as an extension to a non-linear and non-parametric framework the work of \cite{geraci2007quantile, geraci2014linear, alfo2017finite} as well as an extension to a QR framework of the  mixed-modeling approach presented in \cite{hajjem2014mixed}.

\vspace{0.15in}

\noindent The FM-QRF performance is tested with a large scale simulation study and its behaviour is compared with a set of competitor models.
The FM-QRF is empirically applied to a longitudinal dataset to assess the effects of climate-change on the distribution of future growth of GDP of 210 worldwide countries. One of the first contributions in investigating the effects of climate change on GDP growth is by
\cite{kiley2021growth}, based on the concept of Growth-at-risk (GaR) introduced in \cite{yao2001measuring}. GaR is represented by the lower quantiles of the GDP growth and measures the expected maximum economic downturn given a probability level over a certain time-period. 
\vspace{0.15in}

\noindent The aim of this chapter is to extend the findings of \cite{kiley2021growth} by employing the FM-QRF to unveil non-linear complex relationship among GDP growth and climate-related variables in a mixed-effects framework. In particular, the long-term estimate of the future GaR is obtained by considering covariates related to temperature and precipitations. 
Consistent with prior literature, the findings shown in this chapter indicate that unsustainable climate practices will have adverse impacts on most of the countries, with significant heterogeneous effects among them. It is also found that temperature and precipitations differently affect upper and lower quantiles of the GDP growth conditional distribution, and that, in contrast to previous findings based on linear approaches, precipitations also play a relevant role in affecting its tails, especially in the upper quantiles.

\vspace{0.15in}

\noindent The rest of the chapter is organized as follows. Section \ref{sec:FM-QRF-methodology} describes the methodology of the FM-QRF. Section \ref{sec:FM-QRF-simulation} shows the results of the simulation study. Section \ref{sec:FM-QRF-empirical} shows the results of the case study on climate-change related data and Section \ref{sec:FM-QRF-conclusions} contains concluding remarks and outlines possible future research agenda.


\section{Methodology}
\label{sec:FM-QRF-methodology}
This chapter introduces the FM-QRF and provides a detailed explanation of the EM algorithm used to train the proposed model.

\subsection{Finite Mixtures of Quantile Regression Forest}

Let $Y_{it}, i=1,\dots,N$, $t=1,\dots,T_i$ be the response variable for the $i$-th statistical unit observed at time $t$. Let $y_{it}$ be the realisation of the outcome variable and denote with $\mathbf{x}_{it} \in \mathbb{R}^p$ the vector of observed explanatory variables with components $x_{it,j}, j=1, \dots, p$ and $x_{it,1} \equiv 1$. For a given quantile level $\tau \in (0, 1)$, in a longitudinal and clustered data setting, denote $\mathbf{b}_{\tau}=\{b_{1, \tau},\dots,b_{N, \tau}\}$ the vector of unit- and quantile-specific random coefficients. The response $Y_{it}$ is assumed to follow an Asymmetric Laplace density \citep[ALD - ][]{yu2001bayesian}:
\begin{equation}\label{eq:ald}
f_{y|b}(y_{it}|b_{i, \tau}; \tau) = \frac{\tau(1- \tau)}{\sigma_\tau} \exp \Bigg\{ - \rho_\tau \left( \frac{y_{it} - \mu_{it,\tau}}{\sigma_\tau}\right) \Bigg\},
\end{equation}
where $\tau$, $\sigma_\tau > 0$ and $\mu_{it, \tau}$ represent, respectively, the skewness, the scale, and the location parameter of the distribution while the latter one is also the quantile of the conditional distribution. The function $\rho_\tau (u) = u (\tau - \boldsymbol{1}_{\{u < 0\}})$ represents the quantile loss function of \cite{koenker1978regression}.
As it is well known in the literature the ALD is used as a working model able to recast estimation of parameters for the linear QR model in a Maximum Likelihood framework. 

\vspace{0.15in}

\noindent In the QR framework, the location parameter $\mu_{it,\tau}$ is often modeled as:
\begin{equation}
    	\label{eq:me-lqmm}
     \mu_{it,\tau}=\mathbf{x}_{it}^{\prime}\bbeta_\tau+b_{i, \tau}  \;\;\;  \tau \in (0,1),
	\end{equation}
where the random effect $b_{i, \tau}$ is time-constant and varies across statistical units according to a distribution $f_b(\cdot)$ with support $\mathcal{B}$ where $E[b_{i, \tau}] = 0$ is used for parameter identifiability. Rather than specifying such a distribution parametrically as in, e.g.,\cite{geraci2007quantile}, here it is left unspecified and estimated directly from the observed data via a Non-Parametric Maximum Likelihood approach \cite[NPML - ][]{laird1978nonparametric}. Moreover, the model \eqref{eq:me-lqmm} is extended to a machine learning framework using a non-parametric unknown function $g_{\tau}(\mathbf{x}_{it})$ instead of the traditional linear one $\mathbf{x}_{it}^{\prime}\bbeta_\tau$.

\vspace{0.15in}

\noindent More in detail, the distribution $f_b(\cdot)$ is approximated by a discrete distribution on $K < N$ locations $\alpha_{k,\tau}$ so that:
\begin{equation}
\label{eq:bk_bi}
    {\alpha}_{k,\tau} \sim \sum_{k=1}^K \pi_{k,\tau}\delta_{{\alpha}_{k,\tau}},
\end{equation}
where the probability $\pi_{k,\tau}$ is defined as $\pi_{k,\tau} = \mathbb{P}({b}_{i, \tau} = {\alpha}_{k ,\tau})$ with $i=1,\dots, N$ and $k=1,\dots,K$ and $\delta_{{\alpha}_{k,\tau}}$ is a one-point distribution putting a unit mass at ${\alpha}_{k,\tau}$. Under this approach, for $b_{i, \tau}={\alpha}_{k,\tau}$, the location parameter of the ALD in equation \eqref{eq:me-lqmm} becomes
\begin{equation}
    	\label{eq:fmqrf}
     \mu_{itk,\tau}=g_{\tau}(\mathbf{x}_{it})+\alpha_{k, \tau}  \;\;\;  \tau \in (0,1),
	\end{equation}
where $g_\tau: \mathbb{R}^p \rightarrow \mathbb{R}$.
%is a non-parametric unknown function which, %in the FM-QRF, is estimated as in QRF \citep{meinshausen2006quantile}, 
\vspace{0.15in}

\noindent The model likelihood becomes:
\begin{equation}\label{eq:llk2}
L({\boldsymbol{} \Phi_\tau}) = \prod_{i=1}^N  \sum_{k=1}^K \Bigg\{\prod_{t=1}^{T_i} f_{y|b}(y_{it}|b_{i, \tau}=\alpha_{k, \tau}; \tau)\Bigg\} \pi_{k, \tau},
\end{equation}
 %${\boldsymbol{ \Phi}_\tau} = \{ f(\mathbf{x}_{it}), \sigma, {\alpha}_1, . . . , {\alpha}_K, \pi_1, . . . , \pi_K \}$ is the parameter vector.\\
where ${\boldsymbol{ \Phi}_\tau} = \{ \sigma_\tau, g_{\tau}(\mathbf{x}_{it}), {\alpha}_{1,\tau}, \dots , {\alpha}_{K,\tau}, \pi_{1,\tau}, \dots , \pi_{K,\tau} \}$ is the vector of unknown parameters.

\vspace{0.15in}

\noindent It is worth highlighting that the proposed FM-QRF can be also considered as an extension of: (i) the QRF \citep{meinshausen2006quantile} because a random part is added to the non-parametric unknown function of QRF; (ii) the QR for longitudinal data based on latent Markov subject-specific parameters \citep{farcomeni:2012} because the linear fixed-part is replaced by the function $g_{\tau}(\mathbf{x}_{it})$. %Differently from previous contributions  \citep[see][]{geraci2007quantile, geraci2014linear,farcomeni2012quantile}, the use of QRF to estimate $g_{\tau}(\mathbf{x}_{it})$ and the finite-mixture representation of the random part of model \eqref{eq:me-lqmm} allow us to make the FM-QRF represents a valid data-driven approach resistant to misspecification \citep{alfo2017finite, farcomeni2012quantile}  
\vspace{0.15in}

\noindent Differently from previous contributions  \citep[see][]{geraci2007quantile, geraci2014linear,farcomeni2012quantile}, the FM-QRF relies on the NPML, which is based on a finite-mixture representation of the random part of model \eqref{eq:me-lqmm}. This approach does not require to make any a-priori assumption on the distribution of the random effects, making the FM-QRF a valid data-driven approach resistant to misspecification \citep{alfo2017finite, farcomeni2012quantile}.

\vspace{0.15in}

\noindent The simultaneous estimation of $g_{\tau}(\mathbf{x}_{it})$ and $b_{k, \tau}$ in a QR setting poses several challenges, and the next section reports the EM algorithm developed to estimate both $g_{\tau}(\mathbf{x}_{it})$ and the $\alpha_{k, \tau}$ of the proposed FM-QRF. 

\subsection{Parameters Estimation with the EM Algorithm}

Following previous contributions \citep{tian2014linear, merlo2022two, alfo2017finite}, the estimates $\widehat{g}_{\tau}(\mathbf{x}_{it})$ and $\widehat{b}_{k,\tau}$ of \eqref{eq:fmqrf} are computed iteratively: in the first step the $g_{\tau}(\mathbf{x}_{it})$ function is estimated using the algorithm developed for the QRF approach \citep{meinshausen2006quantile}, then, in the second step, given $\widehat{g}_{\tau}(\mathbf{x}_{it})$, the random-effects $b_{k, \tau}$s are obtained by maximising \eqref{eq:loglikmixture} with the EM algorithm.

%In particular, we consider the AL density in the EM likelihood as suitable tool to make inference in a quantile regression framework \citep{yu2001bayesian}. In this setting, the variable $Y_{it}$ has density:

%\begin{equation}\label{eq:ald}
%f(y_{it}|\mu_{it,\tau}, \sigma_{\tau}) = \frac{\tau(1- \tau)}%{\sigma_\tau} \exp \Bigg\{ - \rho_\tau \left( \frac{y_{it} - \mu_{it,%\tau}}{\sigma_\tau}\right) \Bigg\},
%\end{equation}
%where $\mu_{it, \tau}=g_{\tau}(\mathbf{x}_{it})+b_{i,\tau}$ represents the quantile at level $\tau$, $\sigma_\tau > 0$ is the scale parameter and the function $\rho_\tau (u) = u (\tau - \boldsymbol{1}_{\{u < 0\}})$ is the quantile loss function of \cite{koenker1978regression}.

%By assuming the observations of the response variable to be independent conditional on the random vector $b_i$, the corresponding likelihood function to be maximised is: 

%\begin{equation}
%\label{eq:llk1}
%L({\boldsymbol{\Phi}_\tau}) = \prod_{i=1}^N \Bigg\{ %\int_{\mathcal{B}} \prod_{t=1}^{T_i} f(y_{it}|\mu_{it,\tau}, %\sigma_{\tau}) f_{b} ({b_{i}}) \; \textnormal{d} b_{i} \Bigg\}
%\end{equation} 

%with set of parameters ${\boldsymbol{ \Phi}_\tau} = \{\sigma_\tau, %g_\tau(\mathbf{x}_{it}), {b}_{1,\tau}, \dots , {b}_{N,\tau}\}$.

%The maximization of  \eqref{eq:llk1} involves an integral that does not have a closed form solution, and different approaches have been proposed in the literature.
%In this work, we refer to the EM algorithm solution presented in \cite{alfo2017finite, tian2014linear, merlo2022two}, based on the NPML \cite{laird1978nonparametric}. 

%requires to specify the functional form of , and well known approaches to tackle this issue (see \cite{abramowitz1964handbook, press2007numerical,liu1994note, pinheiro1995approximations}) can be computationally intensive. Thus, we propose to compute the ML estimates of $b_{i,\tau}$ by building an EM algorithm based on the NPML approach of \cite{laird1978nonparametric} applied to quantile regression mixed models (as presented in \cite{marino2018mixed, merlo2022quantile, alfo2017finite}). 
%in which $g_{\tau}(\mathbf{x}_{it})$ is estimated with a QRF.

%In the NPML approach, $f_{b}(\cdot)$ is approximated with a discrete distribution on $K < N$ locations $b_{k,\tau}$ so that:
%\begin{equation}
%\label{eq:bk_bi}
%    {b}_{i,\tau} \sim \sum_{k=1}^K \pi_{k,\tau} \delta_{{b}_{k,\tau}}
%\end{equation}},

%where the probability $\pi_{k,\tau}$ is defined as $\pi_{k,\tau} = \mathbb{P}({b}_{i, \tau} = {b}_{k ,\tau})$ with $i=1,\dots, N$ and $k=1,\dots,K$ and $\delta_{{b}_{k,\tau}}$ is a one-point distribution putting a unit mass at ${b}_{k,\tau}$.

%In this setting, the likelihood \eqref{eq:llk1} becomes:
%\begin{equation}\label{eq:llk2}
%L({\boldsymbol{} \Phi_\tau}) = \prod_{i=1}^N \Bigg\{ \sum_{k=1}^K \prod_{t=1}^{T_i} f(y_{it}|\mu_{itk, \tau},\sigma_{\tau}) \pi_{k, \tau}\Bigg\},
%\end{equation}
 %${\boldsymbol{ \Phi}_\tau} = \{ f(\mathbf{x}_{it}), \sigma, {b}_1, . . . , {b}_K, \pi_1, . . . , \pi_K \}$ is the parameter vector.\\
%where ${\boldsymbol{ \Phi}_\tau} = \{ \sigma_\tau, g_{\tau}(\mathbf{x}_{it}), {b}_{1,\tau}, \dots , {b}_{K,\tau}, \pi_{1,\tau}, \dots , \pi_{K,\tau} \}$ is the parameter vector.
% The likelihood in equation \eqref{eq:llk2} resembles the likelihood of a finite mixture of quantile regressions with $K$ clusters based on the AL density of equation \eqref{eq:ald} with location parameter $\mu_{itk,\tau}=g_{\tau}(\mathbf{x}_{it})+b_{k,\tau}$. 



% The EM algorithm consists of two steps: an Expectation (E) step and a Maximisation (M) step. In the E-step the expectation of the complete data log-likelihood is computed as a function of the current estimates of the parameters. Subsequently, in the M-step, the parameters are updated to maximise the expected complete log-likelihood obtained in the E-step. 

\vspace{0.15in}

\noindent The complete data log-likelihood function employed in the EM algorithm is obtained starting from the finite mixture representation in \eqref{eq:llk2}, in which each observation $i$ can be considered as drawn from one of the $K$ locations. Let $w_{ik}$ be the indicator variable equal to $1$ if the $i$-th unit belongs to the $k$-th component of the finite mixture, and 0 otherwise. The EM algorithm treats as missing data the component membership $w_{ik}$. Thus the log-likelihood for the complete data is:


\begin{equation}
	\label{eq:loglikmixture}
	\ell_c(\boldsymbol{ \Phi}_\tau)=\sum_{i=1}^{N}\sum_{k=1}^{K}w_{ik, \tau}\left\{ \sum_{t=1}^{T_i} \log\left(f_{y|b}(y_{it}|b_{i, \tau}=\alpha_{k, \tau}; \tau)\right)+\log(\pi_{k,\tau}) \right\}.
\end{equation}

%with $\Phi_{\tau}=(\sigma, b_1, \dots, b_K, \pi_1, \dots, \pi_K)$ as parameter vector. 

The algorithm for the estimation of the parameters in model \eqref{eq:fmqrf} is as it follows.
Firstly, the values of $\widehat{\alpha}_{k,\tau}^{(0)}, \hat{\sigma}^{(0)}_{\tau}, \hat{\pi}_{k, \tau}^{(0)}, \widehat{g}_{\tau}(\mathbf{x}_{it})^{(0)}$ are initialised. The value of $\widehat{g_{\tau}}(\mathbf{x}_{it})^{(0)}$ at level $\tau$ is estimated by means of the algorithm used for QRF, fitted with the training set $\mathcal{T}^{(0)}= \left\{\left(y_{it}, {\bf x}_{it}\right)\right\}_{\substack{i=1,\ldots, N\\ j=1,\ldots, T_i}}$ ignoring the clustered structure of the data. 

\vspace{0.15in}

\noindent Subsequently, given $\widehat{g}_{\tau}(\mathbf{x}_{it})^{(0)}$, in the \textbf{E-step} the estimates $\hat{w}_{ik, \tau}^{(r+1)}$, $\hat{\pi}_{k,\tau}^{(r+1)}$, $\widehat{g}_{\tau}(\mathbf{x}_{it})^{(r+1)}$ are computed. The estimate values $\hat{w}_{ik, \tau}^{(r+1)}$ and $\hat{\pi}_{k, \tau}$ are obtained with the following expressions:

\begin{equation}
	\label{eq:w_hat}
	\hat{w}_{ik,\tau}^{(r+1)}=\mathbb{E}[w_{ik,\tau}|\mu_{itk},\hat{\Phi}_\tau^{(r)}]=\frac{\prod_{t=1}^{T_i}f_{y|b}(y_{it}|b_{i, \tau}=\alpha_{k, \tau}; \tau)^{(r)}\hat{\pi}_{k, \tau}^{(r)}}{\sum_{l=1}^{K}\prod_{i=1}^{T_i}f_{y|b}(y_{it}|b_{i, \tau}=\alpha_{l, \tau}; \tau)^{(r)}\hat{\pi}_{l, \tau}^{(r)}},
\end{equation}
\begin{equation}
\label{eq:pi_hat}
\hat{\pi}_{k, \tau}^{(r+1)}=\frac{1}{N}\sum_{i=1}^N \hat{w}_{ik,\tau}^{(r+1)},
\end{equation}
where $f_{y|b}(y_{it}|b_{i, \tau}=\alpha_{k, \tau}; \tau)^{(r)}$ is the value of the ALD \eqref{eq:ald} at step $r$ related to the $t$-th measurement of the $i$-th statistical unit when considering the $k$ -th component of the finite mixture.

\vspace{0.15in}

\noindent Then, given $\hat{w}_{ik, \tau}^{(r+1)}$ and $\hat{\pi}_{k, \tau}$, $\widehat{g}_{\tau}(\mathbf{x}_{it})^{(r+1)}$ is updated as it follows. First, the quantity $y^{*(r+1)}_{it}=y_{it}-\widehat{\alpha}_{k, \tau}^{(r)}$ is computed, which represents the unknown function of the model at step $r+1$. The resulting training set $\mathcal{T}^{(r+1)}= \left\{\left(y_{it}^{*(r+1)}, {\bf x}_{it}\right)\right\}_{\substack{i=1,\ldots, N\\ j=1,\ldots, T_i}}$ is used to fit a QRF to estimate $\widehat{g}_{\tau}(\mathbf{x}_{it})^{(r+1)}$ at level $\tau$ accounting for the weight $\hat{w}_{ik, \tau}^{(r+1)}$ of each observation.

\vspace{0.15in}

\noindent Then, in the \textbf{M-step} the estimation of $\hat{\sigma}_{\tau}$ and $\widehat{\alpha}_{k, \tau}$ are obtained
by maximising the expectation $\mathbb{E}[\ell_c(\boldsymbol{\Phi}_\tau)| \mu_{itk}, \hat{\boldsymbol{\Phi}}_\tau^{(r)}]$ with respect to $\hat{\sigma}_{\tau}$ and $\widehat{\alpha}_{k, \tau}$ by numerical optimisation techniques. In particular, in this chapter the Nelder-Mead algorithm \citep{nelder1965simplex} has been implemented. Subsequently, $\widehat{\alpha}_{i, \tau}^{(r)}$ are estimated by means of \eqref{eq:bk_bi}.

\vspace{0.15in}

\noindent The E- and M-steps are alternated iteratively until convergence, that is reached when difference between the likelihood of two consecutive steps is smaller than a certain threshold. A schematic description of the algorithm is presented below.


\begin{figure}[H]
\centering
\begin{minipage}{0.87\textwidth}
\SetKwComment{Comment}{/* }{ */}
\begin{algorithm}[H]
\caption{Mixed-Effects Quantile Regression Forest}\label{tab:algorithm}
\KwData{For a fixed quantile level $\tau$, $\mathcal{T}=\left\{\left(y_{it}, {\bf x}_{it}\right)\right\}_{\substack{i=1,\ldots, N\\ j=1,\ldots, T_i}}$, ${\alpha}_{k, \tau} = \sum_{k=1}^K \pi_{k,\tau} \delta_{{b}_{k,\tau}}$.}
\KwResult{Quantile estimate $\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it})=\hat{g}_\tau(\mathbf{x}_{it})+\hat{\alpha}_{k,\tau}$}
\vspace{0.5cm}

$r \gets 0$ \;
$\widehat{\alpha}_{k,\tau}^{(r)} \gets 0$\;
$\hat{\sigma}_{\tau}^{(r)} \gets \sum_{s=1}^S \frac{1}{N}\sum_{i=1}^{N} \frac{1}{T_i}\sum_{t=1}^{T_i} \rho(u_{it})$\ where $u_{i,t}=y_{i,t}-\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it})$;
$\hat{\boldsymbol{\pi}}_{k, \tau}^{(r)} \gets K$ weights of a Gaussian quadrature\;
$\widehat{g}_{\tau}(\mathbf{x}_{it})^{(r)} \gets$ estimate of the unknown function at level $\tau$ obtained by fitting the QRF with $\mathcal{T}$\;

\vspace{0.5cm}
\textbf{E-step}: Update  estimates $\hat{w}_{ik, \tau}^{(r+1)}$ and $\widehat{g}_{\tau}(\mathbf{x}_{it})^{(r+1)}$:
\begin{itemize}
\item Update ${w_{ik, \tau}}^{(r+1)}$ with equation \eqref{eq:w_hat}
    \item Update $\widehat{g}_{\tau}(\mathbf{x}_{it})^{(r+1)}$ using a QRF fitted with  $\mathcal{T}^{(r+1)}=\left\{\left(y_{it}^{*(r+1)}, {\bf x}_{it}\right)\right\}_{\substack{i=1,\ldots, N\\ j=1,\ldots, T_i}}$ where $y^{*(r+1)}_{it}=y_{it}-\widehat{\alpha}_{k, \tau}^{(r)}$ and accounting for the weight $\hat{w}_{ik,\tau}^{(r+1)}$ of each observation.
\end{itemize} 

\vspace{0.5cm}
\textbf{M-step}: Update estimates $\widehat{\alpha}_{k, \tau}^{(r+1)}$ and $\hat{\sigma}_{\tau}^{(r+1)}$ by maximising \eqref{eq:loglikmixture}
\vspace{0.5cm} 

Keep iterating between \textbf{E-step} and \textbf{M-step} until convergence.

\end{algorithm}
\end{minipage}
\end{figure}

One of the main drawbacks of the traditional EM algorithm is that the M-step may be particularly burdensome in empirical applications involving a large set of covariates, in particular in terms of computational effort. Hence, in order to overcome this issue, the closed-form solutions approach used in \cite{merlo2022two} and \cite{tian2014linear} and reported in the next section is applied.
%Then, we estimate the group-specific random-effects by exploiting the NPML approach presented in Section 2 through closed form solutions of a modified version of the Expectation-Maximisation (EM) algorithm proposed in \cite{merlo2022two}, presented in the next subsection. 

\subsection{Closed Form Solutions to the EM Algorithm}\label{sec:closedformsolutions}

As shown in \cite{merlo2022two} and \cite{tian2014linear}, closed form solutions to the EM algorithm are obtained considering the location-scale mixture representation of $Y_{it}$ presented in \cite{kozumi2011gibbs}:
\begin{equation}
\label{eq:hier}
    Y_{it}=\theta V_{it}+\tau \sqrt{V_{it}}Z_{it}
\end{equation}
%\begin{equation}\label{eq:hier}
  % \textcolor{red}{f(y_{it} \mid   \mu_{itk,\tau}, \sigma_{\tau}, v_{it, \tau})} \sim N(\mu_{itk, \tau} + \theta v_{it, \tau}, \rho^2 \sigma_{\tau} v_{it, \tau}), \quad v_{it, \tau} \sim \textnormal{Exp} (\frac{1}{\sigma_{\tau}})
%\end{equation}
where $V_{it}$ is an exponential random variable with realization $v_{it}$ and $Z_{it}$ a standard Normal random variable.
%, the term $\mu_{itk, \tau} = g_{\tau}(\mathbf{x}_{it}) + b_{k, \tau}$ represents the $\tau$-th conditional quantile of the AL distribution in \eqref{eq:ald}. 


\vspace{0.15in}

\noindent In this setting, $f(v_{it, \tau} |y_{it}, \mu_{itk,\tau}, \sigma_{\tau})$ is a Generalized Inverse Gaussian (GIG) distribution \citep{tian2014linear, tian2016class}:\\

\begin{equation}
\label{eq:GIG}
f(v_{it, \tau} |    y_{it},  \mu_{itk,\tau}, \sigma_{\tau}) \sim \textnormal{GIG} \Bigg( \frac{1}{2}, \frac{(y_{it} - \mu_{itk, \tau})^2}{\rho^2 \sigma_{\tau}} , \frac{2\rho^2 + \theta^2}{\rho^2 \sigma_{\tau}} \Bigg).
\end{equation}
where $\theta = \frac{1-2\tau}{\tau (1-\tau)}$ and $\rho^2 = \frac{2}{\tau (1-\tau)}$.
Starting from \eqref{eq:hier} and \eqref{eq:GIG}, the complete data log-likelihood function of the EM algorithm is based on:

\begin{equation}\label{eq:ytildev}
f( y_{it}, v_{it, \tau} | \mu_{itk}, \sigma_{\tau})= \frac{1}{ \sigma_{\tau} \rho \sqrt{2 \pi \sigma_{\tau} v_{it, \tau}}}  \exp \bigg( - \frac{(   y_{it} - \mu_{itk, \tau} - \theta v_{it, \tau})^2}{2 \rho^2 \sigma_{\tau} v_{it, \tau}} -\frac{v_{it, \tau}}{\sigma_{\tau}} \bigg).
\end{equation}

From \eqref{eq:ytildev}, the complete data log-likelihood function is proportional to:

\begin{center}
\begin{align}
\begin{split}
& \ell_c ({\alpha}_{1, \tau}, ..., {\alpha}_{K, \tau}) \propto \frac{1}{2} \sum_{i=1}^N \sum_{k=1}^K \sum_{t=1}^{T_i}  w_{ik, \tau} v_{it, \tau}^{-1} (   y_{it} - g_{\tau}(\mathbf{x}_{it}) -  \alpha_{k, \tau})^2  \\
& - \theta \sum_{i=1}^N \sum_{k=1}^K \sum_{t=1}^{T_i}  w_{ik, \tau} (   y_{it} - g_\tau(\mathbf{x}_{it}) -  \alpha_{k, \tau}).
\label{eq:complhierc}
\end{split}
\end{align}
\end{center}

Estimates $\widehat{{\alpha}}_{k, \tau}$ are obtained by alternating between the E-step and the M-step.

\vspace{0.15in}

\noindent In the \textbf{E-step} the expectation of \eqref{eq:complhierc} conditional to the observed data is computed and it is proportional to:

\begin{center}
\begin{align}
\begin{split}
&\mathbb{E}[ \ell_c ({\alpha}_{1, \tau}, ..., {\alpha}_{K, \tau}) \mid {\mu_{it}, }\hat{{\boldsymbol{\Phi}}}_{\tau}^{(r)}] \propto  \\
%= Q(\boldsymbol{\beta}_\tau, {b}_{1}, ..., {b}_{K}) \mid {\bf \hat{\Phi}})
& \frac{1}{2} \sum_{i=1}^N \sum_{k=1}^K \sum_{t=1}^{T_i} \hat{w}_{ik}^{(r+1)} \hat{v}_{it, \tau}^{(r+1)} (   y_{it} - \hat{g}_{\tau}(\mathbf{x}_{it}) -  \alpha_{k, \tau})^2 \label{eq:ecdl21} \\ 
& - \theta \sum_{i=1}^N \sum_{k=1}^K \sum_{t=1}^{T_i}  \hat{w}_{ik, \tau}^{(r+1)}  (   y_{it} - \hat{g}_{\tau}(\mathbf{x}_{it}) -  {\alpha}_{k, \tau}), 
\end{split}
\end{align}
\label{eq:ecdl22}
\end{center}

where $\hat{w}_{ik, \tau}^{(r+1)}$ is obtained as in \eqref{eq:w_hat} and the unknown function part ${g}_\tau(\mathbf{x}_{it})$ is estimated using the QRF algorithm.
 
\vspace{0.15in}

\noindent The estimates of the latent variable $\hat{v}_{it, \tau}^{(r+1)} = \mathbb{E}[V_{it, \tau}^{-1} \mid \mu_{itk}, \hat{{\boldsymbol{\Phi}}}_{\tau}^{(r)}]$ are obtained by exploiting the moment properties of the GIG distribution in \eqref{eq:GIG}:

\begin{center}
\begin{equation}\label{eq:mominv}
\hat{v}_{it, \tau}^{(r+1)} = \mathbb{E}[V_{it, \tau}^{-1} \mid \mu_{itk}, \hat{{\boldsymbol{\Phi}}}_{\tau}^{(r)}] = \frac{\sqrt{\theta^2 + 2\rho^2}}{\mid    y_{it} -   \widehat{g}_\tau(\mathbf{x}_{it})^{(r)} -  {\hat{\alpha}}_{k, \tau}^{(r)} \mid}.
\end{equation}
\end{center}

In the \textbf{M-step}, \eqref{eq:ecdl22} is maximised with respect to ${\alpha}_{1, \tau}, \dots, {\alpha}_{K, \tau}$ and the following update expression for $\widehat{{\alpha}}_{k, \tau}^{(r+1)}$ is obtained: %In particular:
%\begin{fleqn}
%\begin{align}\label{eq:derivbeta}
%\frac{\partial Q(\boldsymbol{\beta}_\tau, {b}_{1}, ..., {b}_{K}) \mid {\bf \hat{\Phi}})}{\partial \boldsymbol{\beta}_\tau}
%\end{align}
%\end{fleqn}
%\begin{fleqn}
%\begin{align}
%& = \frac{1}{\rho^2 \sigma_{\tau}_{\tau}} \sum_{i=1}^N \sum_{k=1}^K \sum_{t=1}^{T_i}  \hat{w}_{ik} (1-d_{it}) \hat{v}_{it} {\bf x}_{it} (   y_{it} - f(\mathbf{x}_{it})_\tau -  {\bf \hat{b}}_{k}) - \frac{\theta}{\rho^2 \sigma_{\tau}_{\tau}} \sum_{i=1}^N \sum_{k=1}^K \sum_{t=1}^{T_i}  \hat{w}_{ik} (1-d_{it}) {\bf x}_{it}.
%\end{align}
%\end{fleqn}
%Finally, by setting $\frac{\partial Q(\boldsymbol{\beta}_\tau, {b}_{1}, ..., {b}_{K}) \mid {\bf \hat{\Phi}})}{\partial \boldsymbol{\beta}_\tau} = 0$ and solving for $\boldsymbol{\beta}_\tau$, we have:

\begin{center}
\begin{equation}\label{eq:b}
\widehat{{\alpha}}_{k, \tau}^{(r+1)} = \sum_{i=1}^N \sum_{t=1}^{T_i} \frac{ \hat{w}_{ik, \tau}^{(r+1)} \hat{v}_{it, \tau}^{(r+1)}  }{   \hat{w}_{ik, \tau}^{(r+1)} \big( \hat{v}_{it, \tau}^{(r+1)}  (   y_{it} -   \widehat{g}_{\tau}(\mathbf{x}_{it})^{(r)}) - \theta  \big) }.
\end{equation}
\end{center}
% Equation \eqref{eq:b} is an equivalent to a modified weighted least square estimator expression, in which the response variable and the weights $\hat{w}_{ik, \tau}^{(r)}$ and $ \hat{v}_{it, \tau}^{(r)}$ are $\tau$-dependent through $\hat{v}_{it, \tau}^{(r)}$ and $\theta$.





\section{Simulation Study}\label{sec:FM-QRF-simulation}

This section reports the results of a simulation study carried out to assess the performance of the FM-QRF. The proposed model is tested in a non-linear setting characterised by non-neglegible clustering-effects. The FM-QRF is used to predict quantiles at levels $\tau \in \{0.1, 0.5, 0.9\}$.

\vspace{0.15in}

\noindent The data are simulated under the following non-linear data generating process (DGP) \citep{hajjem2014mixed}:
$$
 y_{it} = g(\mathbf{x}_{it}) + b_i + \varepsilon_{it}
 $$
$$g(\mathbf{x}_{it}) = 2 x_{it,1} + x_{it,2}^2 + 4\cdot\mathbf{1}_{\{x_{it,3} > 0\}} + 2 x_{it,3} \log |x_{it,1}|$$

\vspace{0.15in}

\noindent The covariates are generated as $x_{it, 1}, \; x_{it,2}, \; x_{it,3} \sim \mathcal{N}(0,1)$. The random-effects parameters and the error terms are generated independently according to four DGPs with small and large proportion of random-effects variance (PREV, computed as in \cite{hajjem2014mixed}). DGPs with a large PREV are characterised by the presence of a larger proportion of total variance explained by the random effects, implying that the clustered structure of the data is more pronounced:

\begin{enumerate}
    \item \textbf{(NN-S)} $b_i \sim N(0,1), \;\; \varepsilon_{it} \sim N(0,1) $ with small PREV

     \item \textbf{(NN-L)} $b_i \sim N(0,1), \;\; \varepsilon_{it} \sim N(0,1) $ with large PREV

      \item \textbf{(TT-S)} $b_i \sim t(3), \;\; \varepsilon_{it} \sim t(3) $ with small PREV

      \item \textbf{(TT-L)} $b_i \sim t(3), \;\; \varepsilon_{it} \sim t(3) $ with large PREV
\end{enumerate}
 
 Under scenarios NN-S and NN-L the assumptions of the linear quantile mixed model (LQMM) of Gaussian random parameters hold, whereas for scenarios TT-S and TT-L these hypotheses are violated. In particular, a DGP with heavier tails represented by a Student's \textit{t} distribution with three degrees of freedom is assumed.
 

\vspace{0.15in}

\noindent As in \cite{hajjem2011mixed}, for each scenario are considered a training set of 500 observation for $N=100$ statistical units and $T_i=5$ measurements each, and an unbalanced test set with $T_i \in \{9, 27, 45, 63, 81\}$ for a total of 4500 observations.
Each scenario has been replicated $S = 100$ times.

\vspace{0.15in}

\noindent The average performance of the ME-QRF across the 100 replications is assessed on the test set in terms of the following three loss functions:

\begin{itemize}

\item Average Mean Absolute Error (MAE) and average Mean Squared Error (MSE) with respect to the theoretical quantile of the DGP, computed as in \cite{min2004monte}:

\begin{center}
    \begin{equation}
        MAE_{\tau}= \frac{1}{S} \sum_{s=1}^S \frac{1}{N}\sum_{i=1}^{N} \frac{1}{T_i}\sum_{t=1}^{T_i} |Q^s_{\tau}(y_{it}|\mathbf{x}_{it})-\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it})|
    \end{equation}
\end{center}
\begin{center}
    \begin{equation}
        MSE_{\tau}= \frac{1}{S} \sum_{s=1}^S \frac{1}{N}\sum_{i=1}^{N} \frac{1}{T_i}\sum_{t=1}^{T_i} (Q^s_{\tau}(y_{it}|\mathbf{x}_{it})-\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it}))^2
    \end{equation}
\end{center}

where $Q^s_{\tau}(y_{it}|\mathbf{x}_{it})$ and $\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it}) = \mu_{it, \tau}$ are the the theoretical and estimated conditional quantiles at level $\tau$ of the $s$-th simulated dataset, respectively. 


   % \item Average Quantile loss (QLOSS) of \cite{koenker1978regression}:

   %  \begin{equation}
   %  \label{eq:qloss}
   %      QLOSS_\tau= \frac{1}{S} \sum_{s=1}^S \frac{1}{N}\sum_{i=1}^{N} \frac{1}{T_i}\sum_{t=1}^{T_i}  u_{it} (\tau - \boldsymbol{1}_{\{u_{it} < 0\}})
   %  \end{equation}

   %  where $u_{it}=y_{it}-\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it})$.
    
    \item Average Ramp loss (RAMP) as proposed in \cite{takeuchi2006nonparametric}. This loss is used to measure the quantile property of estimator $\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it})$ in dividing the data so that $\tau$ percent of observations fall below $\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it})$ and $1-\tau$ are above:

    \begin{equation}
       RAMP_\tau= \frac{1}{S} \sum_{s=1}^S \frac{1}{N}\sum_{i=1}^{N} \frac{1}{T_i}\sum_{t=1}^{T_i}  \boldsymbol{1}_{\{u_{it} < 0\}}
    \end{equation}

where $u_{it}=y_{it}-\hat{Q}^s_{\tau}(y_{it}|\mathbf{x}_{it})$. The model satisfies the quantile property for ramp loss values close to $\tau$.
    
\end{itemize}

The performance in term of losses of the FM-QRF is compared with three benchmark models: LQMM, Quantile Regression Forest (QRF) and the Quantile Mixed Model (QMM) of \cite{merlo2022two} adapted to a no two-part model. The latter model exploits the same methodological approach of the FM-QRF in a linear setting. The number of mixture components has been set to $K=11$ with a grid search approach for all models, and the hyper-parameters of the FM-QRF (that is, number of trees, minimum number of observations in terminal nodes, number of features to consider for splitting nodes)   have been optimized by Bayesian Optimization using the \texttt{ParallelBayesOptQRF} package implemented in R \footnote{https://github.com/mila-andreani/ParallelBayesOptQRF}. The QRF has been trained by using the same hyper-parameters settings of the FM-QRF. 

\vspace{0.15in}

\noindent Results are reported in Table \ref{tab:simres}. 

\begin{table}[H]
\small
\begin{center}
{\tabcolsep=7pt\def\arraystretch{0.75}
\begin{tabular*}{\textwidth}{@{} l @{\extracolsep{\fill}}@{}cccclccc@{}}
 \midrule
\multicolumn{1}{l}{} & \textbf{} & \textbf{NN-S} &  &  &  & \textbf{NN-L} \\ \midrule
\multicolumn{1}{l}{} & \textbf{MAE} & \textbf{MSE} & \textbf{RAMP} &  & \textbf{MAE} & \textbf{MSE} & \textbf{RAMP} \\ \cmidrule(lr){2-4} \cmidrule(l){6-8} 
\multicolumn{1}{l}{$\tau=0.1$} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} &  & \multicolumn{1}{l}{} & \multicolumn{1}{l}{}  \\
\textbf{FM-QRF} & 1.54 & 4.93 & 0.1 &  & \textbf{1.83} & \textbf{5.87} & 0.1 \\
\textbf{LQMM} & 2.45 & 10.20 & 0.1 &  & 1.86 & 5.89 & 0.1 \\
\textbf{QRF} & \textbf{1.50} & \textbf{4.49} & 0.1 &  & 2.64 & 10.98 & 0.1 \\
\textbf{QMM} & 4.38 & 35.34 & 0.2 &  & 4.67 & 40.62 & 0.2 \\
$\tau=0.5$ &  &  &  &  &  &  &  \\
\textbf{FM-QRF} & 1.56 & 4.41 & 0.5 &  & \textbf{1.65} & \textbf{4.62} & 0.5 \\
\textbf{LQMM} & 2.09 & 8.11 & 0.5 &  & 1.72 & 5.27 & 0.5 \\
\textbf{QRF} & \textbf{1.46} & \textbf{3.72} & 0.5 &  & 2.11 & 7.15 & 0.5 \\
\textbf{QMM} & 2.33 & 10.36 & 0.5 &  & 2.80 & 14.61 & 0.5 \\
$\tau=0.9$ &  &  &  &  &  &  &  \\
\textbf{FM-QRF} & 1.49 & 4.46 & 0.9 &  & 1.67 & 4.86 & 0.9 \\
\textbf{LQMM} & 2.15 & 7.90 & 0.9 &  & \textbf{1.57} & \textbf{4.34} & 0.9 \\
\textbf{QRF} & \textbf{1.32} & \textbf{3.57} & 0.9 &  & 2.20 & 7.93 & 0.9 \\
\textbf{QMM} & 6.39 & 79.14 & 0.7 &  & 5.16 & 61.12 & 0.8 \\ \midrule
\multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} &  & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} \\
\multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} &  & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} \\ \midrule
\multicolumn{1}{l}{} & \textbf{} & \textbf{TT-S} &  &  & \textbf{} & \textbf{TT-L}  \\ \cmidrule(lr){2-4} \cmidrule(l){6-8} 
\multicolumn{1}{l}{} & \textbf{MAE} & \textbf{MSE} & \textbf{RAMP} &  & \textbf{MAE} & \textbf{MSE} & \textbf{RAMP}  \\ \cmidrule(lr){2-4} \cmidrule(l){6-8} 
\multicolumn{1}{l}{$\tau=0.1$} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} &  & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} & \multicolumn{1}{l}{} \\
\textbf{FM-QRF} & \textbf{2.11} & \textbf{9.03} & 0.1 &  & \textbf{1.80} & 6.66 & 0.1 \\
\textbf{LQMM} & 2.57 & 11.09 & 0.1 &  & 1.94 & \textbf{6.42} & 0.1 \\
\textbf{QRF} & 2.22 & 11.09 & 0.1 &  & 2.02 & 7.88 & 0.1 \\
\textbf{QMM} & 4.94 & 49.44 & 0.2 &  & 4.11 & 33.16 & 0.2 \\
$\tau=0.5$ &  &  &  &  &  &  &  \\
\textbf{FM-QRF} & 1.62 & 5.31 & 0.5 &  & \textbf{1.43} & \textbf{4.32} & 0.5 \\
\textbf{LQMM} & 2.02 & 7.45 & 0.5 &  & 1.57 & 4.48 & 0.5 \\
\textbf{QRF} & \textbf{1.55} & \textbf{4.93} & 0.5 &  & 1.44 & 4.51 & 0.5 \\
\textbf{QMM} & 2.51 & 12.16 & 0.5 &  & 2.01 & 7.82 & 0.5 \\
$\tau=0.9$ &  &  &  &  &  &  &  \\
\textbf{FM-QRF} & \textbf{2.11} & \textbf{8.64} & 0.9 &  & \textbf{1.87} & 7.10 & 0.9 \\
\textbf{LQMM} & 2.71 & 11.53 & 0.9 &  & 2.06 & \textbf{6.81} & 0.9 \\
\textbf{QRF} & 2.22 & 9.23 & 0.9 &  & 2.06 & 8.02 & 0.9 \\
\textbf{QMM} & 7.91 & 218.196 & 0.8 &  & 5.13 & 50.79 & 0.8 \\ \bottomrule
\end{tabular*}}
\caption{Loss values for each scenario computed on the test set of the four fitted models. Bold values indicate the smallest loss.}
\label{tab:simres}
\end{center}
\end{table}

\noindent In the first scenario, in which data meet the Gaussianity assumptions of the LQMM model, the FM-QRF performance mainly depends on the relevance of the clustering effect in the simulated data. 

\vspace{0.15in}

\noindent When the clustering effect is small, the best performing model is the QRF algorithm. This is due to the fact that, in this setting, the QRF is more well specified than the LQMM, which is a linear model, and the FM-QRF model, which is designed for non-linear setting in which the clustering effect is large.
As a matter of fact, when the clustering effect is more relevant, the best performing model is the FM-QRF for almost all quantile levels.

\vspace{0.15in}

\noindent In the second scenario, the simulated data violate the gaussianity assumptions of the LQMM. 
In this case, the FM-QRF outperforms the benchmark models both when the clustering effect is small and large for almost all quantile levels.

\vspace{0.15in}

\noindent The only exception is represented by the performance of the FM-QRF in terms of MSE in the large clustering effect setting when $\tau=0.01, 0.9$.
In this case, a larger training set could lead to an improved performance of the FM-QRF in terms of MSE in predicting extreme quantile values.

\vspace{0.15in}

\noindent In conclusion, the main finding in this simulation study is that the performance of the FM-QRF improves as the clustering effect increases, and when data violate the gaussianity assumptions of the LQMM model. 

%In the next section we will apply the FM-QRF to model the relation between future risk of GDP growth and climate change.

\section{Empirical Application}\label{sec:FM-QRF-empirical}

The study of the effects of climate change is a widely discussed topic in several fields, and a variety of studies have highlighted the relevant and multifaceted role of the growing frequency and intensity of natural disasters in determining economic output of countries \citep{mele2021nature, tol2018economic,palagi2022climate, peng2011toward, deschenes2007economic, dell2014we, dell2012temperature, weitzman2014fat, barro2015environmental, fankhauser2005climate}. 
\vspace{0.15in}

\noindent 
Extreme weather events, including floods, droughts, and escalating temperatures, exert direct influence on the economic output of countries, especially those heavily relying on the agricultural sector. This impact primarily stems from infrastructural damages and fluctuations in crop yields and livestock productivity, resulting in significant economic losses \citep{nelson2014climate, aydinalp2008effects, orlov2021global}.
Other studies have shown that climate change affects economic output of countries also indirectly, by altering migratory flows \citep{cattaneo2016migration, marotzke2020economic}, demography \citep{barreca2015convergence}, criminality \citep{burke2018higher} productivity and labor supply \citep{somanathan2021impact, heal2016reflections, graff2014temperature}, energy production and consumption \citep{burke2015global, burke2018large}.
These results highlight the relevance of considering climate change related risks in macroeconomic policy analyses, although evaluating the economic impact of climate change is a quite difficult task. A variety of statistical and econometric models has been proposed in literature {\citep{ kolstad2020estimating, carleton2016social, mendelsohn2006distributional, coronese2018natural, coronese2019evidence, hsiang2016climate}; in particular, several studies have exploited standard regression approaches to analyse the relation between climate-related variables and economic aggregates, such as GDP and GDP growth; see for example \cite{hsiang2016climate, dell2012temperature, kahn2021long, burke2015global, burke2018large}.
\vspace{0.15in}

\noindent Nevertheless, the effects of climate change may extend beyond the typical GDP distribution, potentially heightening the vulnerability to economic downturns, as evidenced by the lower tails of GDP growth distribution, and amplifying systemic risks through the intersection of climate change impacts and human systems \citep[e.g. international food markets, international security and countries' economic arrangements][]{king2017climate}.

\vspace{0.15in}

\noindent In order to uncover vulnerabilities and potential systemic risks overlooked by standard regression approaches, the focus of more recent analyses shifted from measures of central tendency of the GDP growth distribution \citep{kahn2021long, dell2012temperature, burke2015global, burke2018large, kalkuhl2020impact}, towards its upper and lower tails \citep{kiley2021growth, yao2001measuring, coronese2018natural, coronese2019evidence}. Indeed, analysing the relation between climate change and the tails of GDP growth provides useful information to enhance policy effectiveness, especially when the policy maker aims at preventing and mitigating the impact of extreme events, such as economic downturns or recessions, caused by climate change. Moreover, information on the tails of GDP growth can be used as a measure of economic resilience, offering insights into how well an economy can endure and recover from extreme events.
\vspace{0.15in}

\noindent One of the most used risk measures concerning the tails of the GDP growth distribution is the GDP Growth-at-Risk (GaR) \citep{yao2001measuring, adrian2022term, adrian2019vulnerable}, representing the expected maximum economic downturn given a probability level over a certain time-period. GaR may be estimated in a QR framework as the conditional quantile of the GDP growth distribution at 1\% or 5\% quantile level. 

\vspace{0.15in}

\noindent In the recent work of \cite{kahn2021long}, a linear QR parametric approach is used to predict the effects of different climate-change scenarios on future GaR of a basket of countries. The results highlight that unsustainable climate practices will have a negative effect on the GaR on the majority of countries included in the sample, increasing their risk of experiencing an extreme economic downturn.

\vspace{0.15in}

\noindent Given the relevance of the approach of \cite{kahn2021long}, the aim of this chapter is to extend their findings to a non-linear QR setting by applying the proposed FM-QRF to an unbalanced panel of 3045 country-year observations from 1995 to 2015 for 210 countries.
The outcome variable is the first difference of the natural logarithm of the yearly GDP per capita. The yearly covariates set includes the current value of: Temperature (\textit{TMP}), Precipitation (\textit{PRE}), Magnitude of precipitations greater than 20mm (\textit{r20mm}), maximum number of Consecutive Wet Days (\textit{cwd}), maximum number of Consecutive Dry Days (\textit{cdd}) and Maximum temperature of the year (\textit{txx}). All variables have been differentiated.
Also four lags of each covariate have been included in the covariates set for a total of 30 predictors.

The GDP data have been retrieved from the World Bank\footnote{https://data.worldbank.org}, and the covariates observations represent the historical values of the projected variables considered in the CMIP6 dataset\footnote{https://climateknowledgeportal.worldbank.org}. The final dataset and the \texttt{R} code used to create the dataset is available on Github \footnote{https://github.com/mila-andreani/climate-change-dataset}.
The summary statistics of the variables included in the sample are reported in Table \ref{tab:summary-FM-QRF}.

\input{FM-QRF/tables/summarystats}

\vspace{0.15in}

\noindent The empirical analysis presented here is developed in two parts.
In the first subsection (\ref{sec:4.1}), the validity of a non-linear QR approach over a standard linear one is evaluated by means of an analysis of variance (ANOVA) test \citep{st1989analysis}, and the Variable Importance of each covariate is analysed to measure its relevance in predicting GDP growth quantiles.
\vspace{0.15in}

\noindent The second subsection (\ref{sec:4.2}) focuses on the application of the FM-QRF model to forecast quantiles of the GDP growth at five different probability levels $\tau= 0.01, 0.05, 0.5, 0.95, 0.99$  at three horizons $t=2030,2050,2100$.
The conditional lower quantile levels $0.01$ and $0.05$ measure the downside risk of GDP growth (GaR). This risk measure represents the maximum probable loss in GDP growth caused by climate change. The upper two conditional quantiles levels $0.95$ and $0.99$ represent the upside risk of GDP growth, measuring the maximum probable growth of GDP conditional on the covariates set.
\vspace{0.15in}

\noindent The conditional quantiles forecasts at different $\tau$ are computed using the projected values of the covariates from the CMIP6 dataset \citep{o2016scenario,li2021changes}. In particular, the effects of climate change are measured by comparing two alternative climate scenarios formulated in the CMIP6 experiments.
Such scenarios are denoted as Shared Socio-economic Pathways (SSPs) \citep{riahi2017shared}, and each SSP outlines the progression of climate variables conditional on the future trajectory of socio-economic factors and climate policies implemented by individual countries up to the year 2100. Five different SSP are available, and in this chapter two different SSPs are considered: SSP1 \citep{van2017energy} and SSP5 \citep{kriegler2017fossil}, which are two opposite scenarios of climate change.  
In SSP5 a future energy-intensive economy based on fossil fuels is hypothesised, whereas in SSP1 climate sustainable practices will prevail. 
Thus, the SSP5 represents the worst-case scenario in terms of climate change, and SSP1 represents the best-case one. 

\vspace{0.15in}

\noindent The aim of this analysis is to evaluate whether the fossil fuel-based economy of the SSP5 scenario will negatively affect the future GDP growth distribution at different quantile levels.
The results provide evidence that unsustainable climate policies (SSP5 scenario) will increase the GaR of the majority of the countries included in the considered sample. Moreover, differently from results obtained in the related literature \cite{dell2012temperature}, and as recently demonstrated in \cite{damania2020does}, this analysis shows that changes in precipitations-related variables due to climate change also represent a relevant risk factor undermining future economic growth.

% \subsection{Preliminary results}

% The first part of the empirical application concerns the comparison of the ME-QRF with the LQMM of equation \eqref{eq:lqmm}. Both models allow to model clustering effects in longitudinal data, and these preliminary analysis is carried out to assess whether a linear or a non-linear are more appropriate, To this end, both models are used to estimate conditional quantiles at seven different probability levels $\tau \in \{0.01, 0.05, 0.25, 0.5, 0.75, 0.95, 0.99\}$ and the random effect $b_i$ models country-based clustering.
%  The performance of the two models is compared in terms of average quantile loss (QLOSS):



%     \begin{equation}
%     \label{eq:qloss}
%         QLOSS_\tau= \frac{1}{N}\sum_{i=1}^{N} \frac{1}{T_i}\sum_{t=1}^{T_i}  (\tau - \boldsymbol{1}_{\{u_{it} < 0\}}) u_{it} 
%     \end{equation}

%     where $u_{it}=y_{it}-\hat{Q}_{\tau}(y_{it}|\mathbf{x}_{it})$.

% Table \ref{tab:reslqmm} reports the results in terms of quantile loss. The first column reports the $QLOSS_\tau$ of the ME-QRF, the second column reports the $QLOSS_\tau$ of the LQMM model and the third column shows the percentage of improvement (POI) between the loss of the ME-QRF and the LQMM model:

% \begin{equation}POI_\tau=\frac{QLOSS_\tau^{ME-QRF}}{QLOSS_\tau^{LQMM}}
% \end{equation}

% Values smaller than 100\% indicate that the ME-QRF outperforms the LQMM model.



% \begin{table}[H]
% \begin{center}
% {\tabcolsep=22pt\def\arraystretch{1.1}
% \begin{tabularx}{0.85\textwidth}{cccc}
% \toprule
% $\tau$ & $\mathbf{QLOSS^{ME-QRF}}$                   & $\mathbf{QLOSS^{LQMM}}$                & $\textnormal{\textbf{POI}}_\tau$ \\ \midrule
% 0.01 & 0.26 & 1.38 & 19\% \\ 
%   0.05 & 0.92 & 1.61 & 57\% \\ 
%   0.25 & 2.85 & 3.45 & 83\% \\ 
%   0.50 & 3.52 & 4.22 & 83\% \\ 
%   0.75 & 2.71 & 3.38 & 80\% \\ 
%   0.95 & 0.86 & 1.59 & 54\% \\ 
%   0.99 & 0.24 & 1.65 & 15\% \\ \bottomrule
% \end{tabularx}}
%  \caption{ Results in terms of quantile loss, $QLOSS_{\tau}$, for the ME-QRF and LQMM models. The third column shows the POI between the ME-QRF and the LQMM quantile losses; values smaller than 100\% indicate that the ME-QRF outperforms the LQMM model.}
% \label{tab:reslqmm}
% \end{center}
% \end{table}


% These results point out that our model delivers a smaller quantile loss with respect to the LQMM, especially at extreme quantile levels. Thus, as already shown in the simulation study, the ME-QRF can be successfully implemented to model complex and non-linear relationship among variables, such as GDP growth and climate-related variables.

% Then, the variable importance at each quantile level is measured in order to assess the relevance of each variable in predicting upside and downside risk.
% The variable importance of the $j$-th covariate is measured by first computing the sum of squared residuals ($SSR$) of the ME-QRF using Out-Of-Bag observations. Then, the observations of the $j$-th covariate are permuted and the SSR of the RF is computed again. The importance of the $j$-th variable at each quantile level $\tau$, denoted with $I_{j, \tau}$, is measured as:

% \begin{center}
% \begin{equation}
% I_{j, \tau}=SSR-SSR^*
% \end{equation}
% \end{center}

% where $SSR^*$ is the SSR after the permutation of the $j$-th variable.
% The bigger the decrease of the SSR after permutation, the greater the variable importance.
% The results of variable importance are shown in figures \ref{fig:meanimp}- \ref{fig:varimp}. Figure \ref{fig:meanimp} shows the average $I_{j}$  across quantiles, whereas figures \ref{fig:varimp} show the $I_{j, \tau}$ at each quantile level for each variable. 




% % \begin{table}[]
% % \centering
% % \resizebox{\columnwidth}{!}{%
% % \begin{tabular}{@{}cccccccccc@{}}
% % \toprule
% % \textbf{TMP\_LAG3} & \textbf{TMP\_LAG1} & \textbf{TMP\_LAG0} & \textbf{TMP\_LAG4} & \textbf{TMP\_LAG2} & \textbf{cdd\_LAG3} & \textbf{cdd\_LAG4} & \textbf{cdd\_LAG2} & \textbf{PRE\_LAG4} & \textbf{cwd\_LAG2} \\
% % 5.18 & 4.96 & 3.90 & 2.68 & 1.81 & 1.46 & 1.44 & 1.34 & 1.22 & 1.21 \\ \midrule
% % \textbf{cdd\_LAG0} & \textbf{PRE\_LAG3} & \textbf{PRE\_LAG0} & \textbf{txx\_LAG2} & \textbf{PRE\_LAG1} & \textbf{r20mm\_LAG2} & \textbf{cdd\_LAG1} & \textbf{r20mm\_LAG0} & \textbf{PRE\_LAG2} & \textbf{r20mm\_LAG3} \\
% % 1.06 & 1.04 & 0.96 & 0.96 & 0.92 & 0.92 & 0.88 & 0.81 & 0.79 & 0.79 \\ \midrule
% % \textbf{r20mm\_LAG4} & \textbf{txx\_LAG3} & \textbf{r20mm\_LAG1} & \textbf{cwd\_LAG1} & \textbf{txx\_LAG4} & \textbf{cwd\_LAG3} & \textbf{txx\_LAG0} & \textbf{txx\_LAG1} & \textbf{cwd\_LAG4} & \textbf{cwd\_LAG0} \\
% % 0.76 & 0.75 & 0.74 & 0.67 & 0.66 & 0.63 & 0.59 & 0.55 & 0.53 & 0.38
% % \end{tabular}%
% % }
% % \caption{Average variable importance across quantiles for each covariate.}
% % \label{tab:meanimp}
% % \end{table}


% The results in figure \ref{fig:meanimp} highlight that, across quantiles, temperature substantially affects economic growth both in the short and long term, along with the Consecutive Dry Days (cdd) lags, lag 2 of the Consecutive Wet Days variable (cwd) and the lags 3 and 4 of the Precipitations variable.

% Another finding is related to the presence of a substantial heterogeneity in variable importance values across quantiles, as depicted in figure \ref{fig:varimp}.

% At lower quantiles, temperature, dry spells (cdd), and precipitations and their magnitude (r20mm) are the most important variables in predicting GDP growth, along with their lags.

% In summary, findings related to variable importance analysis point out that: differently from the findings of previous literature (such as \cite{kiley2021growth} and \cite{dell2012temperature}), not only temperature affects GDP growth, but also precipitations and dry spells influence the GDP growth upside risk. 
% Secondly, climate variables affect lower and upper tail risk of GDP growth in a different way. These results highlight the importance of using a non-linear quantile regression approach to determine the climate drivers of future GDP growth risks.}

\subsection{Preliminary Analysis}\label{sec:4.1}

This section reports the results of the preliminary analysis on the dataset of interest. Within the machine learning framework of this chapter, first the validity of a non-linear QR approach over a standard linear one is evaluated with an analysis of variance (ANOVA) test \citep{st1989analysis} to compare a spline QR model \citep{marsh2001spline, koenker1994quantile, wang1998mixed} and standard QR at five quantile levels $\tau=0.01, 0.05, 0.5, 0.95, 0.99$. 

\vspace{0.15in}

\noindent The spline QR model is an extension of the standard QR model based on piecewise-defined polynomial functions. Differently from the linear QR modeling framework, the splines model adapts to non-linear relationships with a series of knot points, where each different polynomial segment originates.
This feature makes this model particularly suitable to model complex and non-linear relationships among the variables of interest.
\vspace{0.15in}

\noindent In this section, both the  QR spline model and the linear one consider the same covariates of the FM-QRF. In particular, the QR spline model is represented by a piecewise cubic polynomial with 2 knots for each covariate.
The results of the ANOVA test, in Table \ref{tab:anova}, reveal that a non-linear approach, such as the one in FM-QRF, results more valid than the linear one.
\input{FM-QRF/tables/anova}

\vspace{0.15in}

\noindent In the second part of the preliminary analysis the relevance of each covariate in predicting the quantiles of the GDP growth distribution is assessed by extracting the Variable Importance measure from the FM-QRF.   

\vspace{0.15in}

\noindent The analysis is performed by fitting a FM-QRF for each $\tau$ and by computing the Variable Importance measure \citep{breiman1984classification} for each $p$-th covariate as follows.
First, the sum of squared residuals (SSR), denoted with $m_{p,\tau}$, is computed by using Out-Of-Bag observations of the covariate. Then, the observations are permuted and the SSR is re-calculated. The SSR after the permutation is denoted with $m^*_{p, \tau}$.
The Variable Importance of the $p$-th covariate for the $\tau$ quantile, denoted with $I_{p, \tau}$, is finally computed as:
\begin{center}
\begin{equation}
I_{p, \tau}=m_{p, \tau}-m^*_{p, \tau}.
\end{equation}
\end{center}
The higher the reduction in the SSR following the permutation, the higher the importance of the variable.
The results of variable importance are shown in figures \ref{fig:meanimp}- \ref{fig:varimp}. Figure \ref{fig:meanimp} shows the average $I_{p}$ across quantiles, whereas figures \ref{fig:varimp} show the $I_{p, \tau}$ at each quantile level for each variable. 


\vspace{0.15in}

\noindent Figure \ref{fig:meanimp} shows that, at an aggregate level, the most important set of variables used to predict quantiles are the lags of the Temperature variable. The second set of variables is represented by the consecutive number of Dry Spells. This pattern is similar to the one observed at a disaggregate level, represented in Figure \ref{fig:varimp} at different quantile probability levels. 

\begin{figure}[H]
    \centering
    \includegraphics[trim=1cm 0 0 0,  width=0.9\textwidth]{FM-QRF/images/meanvar.pdf}
    \caption{Average variable importance across quantiles $I_j$ for each covariate.}
    \label{fig:meanimp}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[trim=1cm 0 0 0, width=\textwidth]{FM-QRF/images/plotvarimp.pdf}
     \caption{Permutation-based variable importance $I_{j,\tau}$ for each covariate included in the training set.}
    \label{fig:varimp}
\end{figure}

\vspace{0.15in}

\noindent These results highlight that both temperature and precipitations affect the GDP growth distribution of each country to a different extent. Although being in contrast with previous contributions \citep{dell2012temperature}, the obtained results are confirmed by more recent findings \citep{damania2020does}, which show that precipitations-related variables play a more relevant role with respect to temperature at the upper quantiles of the GDP growth distribution, representing a relevant factor influencing upside risk of economic productivity growth. 

\subsection{Projection Results}\label{sec:4.2}

This section reports the quantile estimates along with their standard errors projected in $2030,2050,2100$ under the SSP1 and SSP5 scenarios. The FM-QRF has been fitted using $K=9$ locations, identified via grid search and the computational time to fit the model is equal, on average, to 620.45 seconds on an ordinary multi-CPU server Intel Xeon with 24 cores.
\vspace{0.15in}

\noindent The mean and the bootstrap standard error of each estimate are obtained with $N=500$ replications. Table \ref{tab:avg-se} report the average mean and standard error across countries for the SSP1 and SSP5 scenarios, respectively. Country specific estimates are reported in Tables \ref{tab:se_table_SSP1} and \ref{tab:se_table_SSP5}. 

\input{FM-QRF/tables/avg-se}

\vspace{0.15in}

\noindent The results obtained under the two scenarios are compared by considering the difference between the values of quantiles estimated in the worst-case scenario in terms of climate policies (SSP5) and the values of quantiles estimated according to the best-case one (SSP1):
\begin{equation}
\Delta Q_{it}^{\tau}= Q_{it}^{\tau, SSP5}-Q_{it}^{\tau, SSP1},
\end{equation}

\noindent where $Q_{it}^{\tau}$ represents the estimated values of the quantile of the $i$-th country at probability level $\tau$ projected in year $t$.
Given that the main difference between the SSP1 and SSP5 is related to two opposite climate change mitigation policies scenarios, the magnitude of $\Delta Q_{it}^{\tau}$ can be attributed only to climate change and its effect on climate variables.

\vspace{0.15in}

\noindent Negative values of $\Delta Q_{it}^{\tau}$ indicate that  $Q_{it}^{\tau, SSP5} < Q_{it}^{\tau, SSP1}$. This means that under the SSP5 scenario, the GDP growth at both low and high quantile levels will be smaller due to inadequate climate-related policies.

\vspace{0.15in}

\noindent The country-specific results of this analysis are mapped in figures \ref{fig:1}-\ref{fig:5} at three different time horizons ($t=2030, 2050, 2100$). The main finding obtained by interpreting the values of $\Delta Q_{it}^{\tau}$ is that the effects of the unsustainable climate practices hypothesised in the SSP5 scenario are negative at an aggregate level, but their magnitude substantially vary across time and among countries. 

\vspace{0.15in}

\noindent For each quantile level, in $2030-2050$ the value of $\Delta Q_{it}^{\tau}$ is estimated to be negative for almost two thirds of the countries. This points out that the climate change hypothesised in the worst case scenario will increase the downside risk of the majority of the countries in the considered sample, while also representing a limiting factor to the potential country-specific GDP growth. 

\vspace{0.15in}

\noindent For instance, figure \ref{fig:4} shows the maps at 2030, 2050 and 2100 for quantile at level $\tau=0.05$. In this case, in 2030 the $\Delta Q_{i, 2030}$ assumes values ranging from a minimum of -16\% to a maximum of 7\%. This indicates that for some countries $Q_{i,2030}^{0.05, SSP5} < Q_{i,2030}^{0.05, SSP1}$, that is,  some countries will see their 5\% quantile (that represents a negative value of the GDP growth) decreasing more in the ``worst-case'' climate change scenario with respect to the ``best-case'' one. Another finding is that the effects of unsustainable climate practices change over time whether the country is considered to be 'high-income' with a moderate climate, o 'low-income' with more extreme climate conditions.

\vspace{0.15in}

\noindent By comparing the panels reported in Figures \ref{fig:1}- \ref{fig:5}, the following     results can be deducted. The impact of temperatures and precipitations from 2030 to 2050 on the United States, considered as a high-income and climate-temperate country, are modestly positive at all quantile levels. These findings indicate that high-income countries with economies reliant on energy-intensive sectors could see advantages in scenarios with limited climate policies, indicating a higher capability of high-income countries to adapt more effectively to adverse climate-change scenarios.

\vspace{0.15in}

\noindent For low-income and hot countries instead, such as countries in the African continent and India, the effects of climate-change from 2030 to 2050 are negative at all quantile levels, especially at the medium term (2050). The same holds for Russia, which is a high-income but cold country. In this case, Russia will suffer from adverse climate-change scenarios both in terms of upside and downside risk.
The results on the heterogeneity of climate change effects over time on rich/poor and hot/cold countries are confirmed by previous findings \citep{kiley2021growth}.

\vspace{0.15in}

\noindent In general, even though between 2030 and 2050 the majority of the countries will suffer from climate change in terms of GDP growth, in 2100 this heterogeneity will be slightly less pronounced, bringing the number of countries suffering from climate change to two thirds of the sample to 50\%. This might result from the  optimistic socio-demographic growth scenario hypothesised in SSP5, based on the hypothesis of large public interventions in favor of the communities against climate change. The effects of these interventions could have a positive effect in the long run on the poorest countries which, as shown in the literature, are those which will suffer most from the effects of climate change, precisely due to their socio-economic conditions. 

\vspace{0.15in}

\noindent The socio-economic development of these countries would thus ensure that the effects of climate change, even though still existing, will be mitigated by the presence of a growing number of mitigation policies and public intervention.


\begin{landscape}
\begin{figure}[H]
    \centering
    \includegraphics[height=13cm]{FM-QRF/images/plot1.pdf}
   \caption{Map showing $\Delta Q_{it}^{\tau}$ in years $t=2030,2050,2100$ for quantile at probability level $\tau=0.01$.}
    \label{fig:1}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}[H]
    \centering
    \includegraphics[height=13cm]{FM-QRF/images/plot2.pdf}
   \caption{Map showing $\Delta Q_{it}^{\tau}$ in years $t=2030,2050,2100$ for quantile at probability level $\tau=0.05$.}
        \label{fig:2}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}[h]
    \centering
    \includegraphics[height=13cm]{FM-QRF/images/plot3.pdf}
    \caption{Map showing $\Delta Q_{it}^{\tau}$ in years $t=2030,2050,2100$ for quantile at probability level $\tau=0.50$.}
    \label{fig:3}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}[H]
    \centering
    \includegraphics[height=13cm]{FM-QRF/images/plot4.pdf}
     \caption{Map showing $\Delta Q_{it}^{\tau}$ in years $t=2030,2050,2100$ for quantile at probability level $\tau=0.95$.}
    \label{fig:4}
\end{figure}
\end{landscape}

\begin{landscape}
\begin{figure}[H]
    \centering
    \includegraphics[height=13cm]{FM-QRF/images/plot5.pdf}
    \caption{Map showing $\Delta Q_{it}^{\tau}$ in years $t=2030,2050,2100$ for quantile at probability level $\tau=0.99$.}
    \label{fig:5}
\end{figure}
\end{landscape}


\section{Conclusions}\label{sec:FM-QRF-conclusions}

This chapter introduces the FM-QRF, a novel model to estimate quantiles of longitudinal data in a non-linear mixed-effects framework by means of QRF and the NPML approach.

\vspace{0.15in}

\noindent A large scale simulation study shows that the FM-QRF outperforms other benchmark models in a non-linear setting. The model is applied empirically to study the long-term effects of climate change on GDP growth-at-risk, unveiling the relevant effects of future changes in temperature and precipitations on the tails of the GDP growth distribution.
\vspace{0.15in}

\noindent The non-linear approach presented in this chapter offers several advantages when assessing the economic effects of climate change compared to a standard linear approach, as the FM-QRF allows to model the complex non-linear relationships between climate-related variables and GDP growth without any a-priori distributional assumption on the form these relationships, on the outcome variable and the random effects parameters. The empirical results presented in this chapter point out that these features make the FM-QRF well-suited for evaluating the future economic effects of climate change, allowing to deliver more accurate forecasts with respect to standard linear approaches.

%performance of the proposed model is tested by means of a simulation study and the ME-QRF performance is compared against the benchmark model LQMM, QRF and QMM. The main finding is that the ME-QRF outperforms benchmark models when the data generating process is non-linear and the clustering effects are non-negligible. These results suggest that our model can be successfully used in highly complex applications, such as the study of the effect of climate change on future economic output.
% In this chapter the ME-QRF is applied on a longitudinal data analysis on 210 worldwide countries from 1995 to 2015 to study the role of precipitations and temperature-related variables on GDP growth distribution.
% By making use of the CMIP6 dataset, we first measure the role of each climate-related variable in predicting lower and upper quantiles of GDP growth. Then, we predict the effects of different climate change policies in 2030, 2050 and 2100 on the downside and upside risk of GDP growth.
% In line with previous literature, we provide evidence that unsustainable climate practices will negatively affect the majority of countries included in our sample and that the magnitude of such effects are very heterogeneous across countries. We also show that temperature and precipitations differently affect upper and lower quantiles og GDP growth, and that, in contrast to previous literature, precipitations also play a relevant role in affecting the tails of GDP growth distribution, especially in the upper quantiles.

\vspace{0.15in}

\noindent Possible future developments of the FM-QRF model concern the inclusion of mixed-frequency covariates in order to consider variables observed at a higher frequency with respect to the outcome, that may include important information for understanding the phenomenon under consideration. The analysis of the results of the FM-QRF could be further enriched by including the study of the presence of heterogeneity among statistical units in terms of individual intercepts. Moreover, future model extension could concern the inclusion of time-varying random parameters by exploiting a Markovian structure as proposed in \cite{marino2018mixed, merlo2022quantilets, merlo2022quantile}.





