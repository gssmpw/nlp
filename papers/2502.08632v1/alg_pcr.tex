\begin{algorithm}[t]
	\caption{$\PCR$: RL with Resets via One-Context Regression}
	\label{alg:pcr}
	\begin{algorithmic}[1]\onehalfspacing
		          \State \textbf{input:} One-context regression oracle $\Reg$; efficiency function $\Nreg: (0,1)\times(0,1)\to\NN$; \# of latent states $S$; final error tolerance $\epfinal \in (0,1)$; failure parameter $\delta \in (0,1)$; horizon $H$; action set $\MA$.
		%
%        \State Define $\wh\pi_k: \MX \to \Delta(\MA)$ by $\wh\pi_k(x) := \Unif(\MA)$.
        \State $N \gets \Nreg\left(\left(\frac{\epfinal\delta}{H|\MA|S}\right)^{C_{\ref{thm:pcr-app}}},\left(\frac{\epfinal\delta}{H|\MA|S}\right)^{C_{\ref{thm:pcr-app}}}\right)$.
        \State $\trunc \gets \epfinal/(4+HS)$.
        \State $R \gets SH$, $\tsmall \gets \frac{\trunc^2}{RS^2H^2}$, $\alpha \gets \frac{1-4\trunc}{S}$, $m \gets \frac{2}{\min(\alpha\trunc,\tsmall)}\log(S/\delta)$, $n \gets \frac{m|\MA|}{\trunc}\log(S/\delta)$.
        \State $\epsilon \gets \min(\frac{\alpha^8\trunc^{16}\tsmall^{8}}{6^{8}H^{8}m^{12}|\MA|^{12}}, \frac{\delta^4}{m^2|\MA|^2n^4})$, $\gamma \gets \epsilon^{1/8}$, $\gamma' \gets 2\epsilon^{1/4}$.
        \State $\Gamma^{(1)} \gets \emptyset$.
        \For{$1 \leq r \leq R$}
            \State $\Psi_1^{(r)} := \{\piunif\}$.
            \For{$1 \leq h < H$}
                \State $\Psi_{h+1}^{(r)} \gets \EPCR(\Reg, h, \Psi_{1:h}^{(r)}, \Gamma,n,m,N,\gamma,\gamma')$.
            \EndFor
            \State $\Gamma^{(r+1)} \gets \Gamma^{(r)} \cup \bigcup_{h \in [H]:|\Psi_h^{(r)}| \leq S} \Psi_h^{(r)}$.
        \EndFor
        \State \textbf{return:} $\bigcup_{h \in [H]} \bigcup_{1 \leq r \leq R: |\Psi_h^{(r)}| \leq S} \Psi_h^{(r)}$.
	\end{algorithmic}
\end{algorithm}


\begin{algorithm}[!htb]
	\caption{$\EPCR$: Extend Policy Cover in Reset Model}
	\label{alg:epcr}
	\begin{algorithmic}[1]\onehalfspacing
          \State \textbf{input:} One-context regression oracle $\Reg$; step $h \in [H]$; policy covers $\Psi_{1:h}$; backup policy cover $\Gamma$; sample counts $n,m,N\in\NN$; tolerances $\gamma,\gamma' \in (0,1)$.
		%
%        \State Define $\wh\pi_k: \MX \to \Delta(\MA)$ by $\wh\pi_k(x) := \Unif(\MA)$.
        \State $\MC \gets \emptyset$.
        \For{$1 \leq i \leq m$}
            \State Sample trajectory $(x_1,a_1,\dots,x_h) \sim \frac{1}{2}\left(\Unif(\Psi_h) + \Unif(\Gamma)\right)$.
            \State Set $x_h^{(i)} := x_h$.
            \State Update dataset: $\MC \gets \MC \cup \{x_h\}$.
        \EndFor
%        \LineComment{Write $\MC = \{x_h^{(1)},\dots,x_h^{(m)}\}$}
        \For{$1 \leq i \leq m$}
            \For{$a \in \MA$}
                \State $\MD_{i,a} \gets \emptyset$.
                \For{$N$ times}
                    \State Sample $j \sim \Unif([m])$ and $a_h \sim \Unif(\MA)$.
                    \State Reset to $x_h := x_h^{(j)}$ and sample $x_{h+1} \sim \BP^M_{h+1}(\cdot|x_h, a_h)$.
                    \State Update dataset: $\MD_{i,a} \gets \MD_{i,a} \cap \{(x_{h+1}, \mathbbm{1}[j=i \land a_h = a])\}$.
                \EndFor
                \State $\what_{h+1}(\cdot;i,a) \gets \Reg(\MD_{i,a})$. \Comment{$\what_{h+1}(\cdot; i,a): \MX \to [0,1]$}
            \EndFor
        \EndFor
        \State $\Psi_{h+1} \gets \emptyset$, $\Tclus \gets \emptyset$.
        \For{$1 \leq t \leq n$}
            \State Sample $j \sim \Unif([m])$.
            \State Reset to $x_h := x^{(j)}$ and sample trajectory $(x_h,a_h,x_{h+1}) \sim \Unif(\MA)$. Write $\xbar_{h+1}^{(t)} := x_{h+1}$.
            \State Define $\MR^{(t)}: \MX \to [0,1]$ by 
            \[\MR^{(t)}(x) := \max\left(0, 1-\frac{\max_{(i,a) \in [m]\times\MA} |\what_{h+1}(\xbar_{h+1}^{(t)};i,a) - \what_{h+1}(x;i,a)|}{\gamma}\right).\] \label{line:rt-def}
            \If{$\max_{(i,a) \in [m]\times\MA} |\what_{h+1}(\xbar_{h+1}^{(t)};i,a) - \what_{h+1}(\xbar_{h+1}^{(t')};i,a)| > \gamma'$ for all $t' \in \Tclus$}\label{line:cluster-test}
                \State $\pihat^{(t)} \gets \PSDPB(h, \Reg, \MR^{(t)}, \Psi_{1:h},\Gamma, N)$.\Comment{See \cref{alg:psdpb}}\label{line:psdp-call}
                \State Update $\Psi_{h+1} \gets \Psi_{h+1} \cup \{\pihat^{(t)}\}$.
                \State Update $\Tclus \gets \Tclus \cup \{t\}$.
            \EndIf
        \EndFor 
        \State \textbf{return:} $\Psi_{h+1}$.
	\end{algorithmic}
\end{algorithm}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
