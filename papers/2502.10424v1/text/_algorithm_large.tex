\begin{algorithm*}[h]
\caption{QuantSpec Algorithm} \label{alg:our_algorithm}
\begin{algorithmic}[1]
\setlength{\itemsep}{3pt}
\item[] \textbf{Input:} Model $M$, Upper 4-bit Cache $C_U$, Lower 4-bit Cache $C_L$, Full Precision Cache Buffer $[C_{F_1}, C_{F_2}]$, 
\item[] \textbf{Input:} Prefill Length $S_P$, Target Decode Length $S_D$, Prefill Context $X = [x_0, \cdots, x_{S_P-1}]$, Speculate Length $\gamma$
\item[] \textbf{Input:} Number of Layers $L$, Sensitive Layer Number $L_S$, Quantization Group Size $G$
\item[] \textbf{Function: } $\operatorname{PREFILL}$, $\operatorname{DRAFT}$, $\operatorname{TARGET}$, $\operatorname{VERITY}$, $\operatorname{QUANTIZE}$, $\operatorname{REJECTCACHE}$
\item[] \textbf{Notation: } Verified tokens $x_i$, generated draft tokens $g_i$, logits of draft model $q_i$, logits of target model $p_i$, number of tokens already been generated in total $N$, number of tokens already been generated in this speculate step $n$, number of tokens accepted in this speculate step $v$

\item[] \textbf{Prefill Stage}
\STATE $X_{S_P}, C_{KV} \leftarrow \operatorname{PREFILL}(M, X_{<S_P})$  \hfill \textcolor{gray}{$\triangleright$ KV Cache is written together for simplicity}

\STATE $\textcolor{orange!95!black}{C_U, C_L} \leftarrow \operatorname{QUANTIZE}(C_{KV_{:S_P-G}}, L_S)$ \hfill \textcolor{gray}{$\triangleright$ Prepare the hierarchical quantized KV Cache}
\STATE $\textcolor{orange!95!black}{C_{F_1}, C_{F_2}} \leftarrow C_{KV_{S_P-G:}}, \operatorname{None}$ \hfill \textcolor{gray}{$\triangleright$ Prepare the full-precision cache buffer for recent tokens}

\item[] \textbf{Decode Stage}
\WHILE{$N < S_D$}
    \STATE $n \leftarrow 0$ and $v \leftarrow 0$
    \WHILE{$n < \gamma$}
        \STATE $q_{n + 1}, \textcolor{orange!95!black}{C_{F_2}} \leftarrow \operatorname{DRAFT}(M, \textcolor{orange!95!black}{C_U, C_{F_1}, C_{F_2}, L_S}, X_{\leq S_P + N} + g_{<n})$
        \STATE Sample $g_{n + 1} \sim q_{n + 1}$ and $n \leftarrow n + 1$
    \ENDWHILE
    \STATE $p_1, \cdots p_{\gamma}, \textcolor{orange!95!black}{C_{F_2}} \leftarrow \operatorname{TARGET}(M, \textcolor{orange!95!black}{C_U, C_L, C_{F_1}, C_{F_2}}, X_{\leq S_P + N} + g_{<\gamma})$

    \FOR{$i=1$ to $\gamma$}
        \IF{$\operatorname{VERIFY}(g_i, p_i, q_i)$}
            \STATE $x_{N + i} \leftarrow g_i$ and $v \leftarrow v + 1$ 
        \ELSE
            \STATE $x_{N + i} \leftarrow \operatorname{CORRECT}(p_i, q_i)$ and $v \leftarrow v + 1$ 
            \STATE $\textcolor{orange!95!black}{C_{F_2}} \leftarrow \operatorname{REJECTCACHE}(\textcolor{orange!95!black}{C_{F_2}}, i)$ \hfill \textcolor{gray}{$\triangleright$ Clear the rejected KV cache from the full precision cache buffer}
            
            Break
        \ENDIF
        \IF{$i = \gamma$}
            \STATE $x_{N + \gamma + 1} \leftarrow p_{\gamma + 1}$ and $N \leftarrow N + 1$
        \ENDIF
    \ENDFOR

    $N \leftarrow N + v$ 
    \IF{$C_{F_2}$ is full}
        \STATE Concatenate $\operatorname{QUANTIZE(C_{F_1})}$ with \textcolor{orange!95!black}{$C_U \text{~and~} C_L$}  \hfill \textcolor{gray}{$\triangleright$ Quantize the first half of the full precision cache buffer}
        \STATE $\textcolor{orange!95!black}{C_{F_1} \leftarrow C_{F_2~:-G}}$ and $\textcolor{orange!95!black}{C_{F_2} \leftarrow C_{F_2~-G:}}$ \hfill \textcolor{gray}{$\triangleright$ Move the second part to the first part of full precision buffer}
    \ENDIF
\ENDWHILE

\end{algorithmic}
\end{algorithm*}