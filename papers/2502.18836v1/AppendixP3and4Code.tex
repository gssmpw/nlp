\section{P3 \& P4: Urban Ride Sharing Sample Implementation}
\label{app:p3p4}

This appendix presents an implementation of \textbf{P3} and \textbf{P4}: Urban Ride Sharing without and with interrupts, using LangGraph~\cite{langgraph2024}.

\subsection{Agentic Workflow Formulation}

In this first stage, we define agents to manage the nodes of the workflow, including data collection, route planning, vehicle dispatch, traffic adjustment, monitoring and alert, and logging agents. At the end, we use the \texttt{>>} syntax to specify dependencies among agents. The transition from problem specifications to workflow formulation is handled automatically by MACI\,\cite{chang2025MACI} in LangGraph.

\begin{lstlisting}[style=PythonStyle, caption=Collaborative Agents and Prompts, label=lst:agent_pipelinep3p4]
    # ---- Data Collection Agent ---- #
    DC_Agent = Agent(
        name=``Data Collection Agent'',
        backstory=``You collect basic traffic data, road closure updates, and estimated travel times between locations in Bay Area suburb.'',
        task_description=``Retrieve traffic conditions, road closures, and estimated travel durations for all routes involved in passenger transport.'',
        task_expected_output=``Structured travel time data, including:
        1) CityMap: A graph G = (V, E), where the locations V and roads E have distances and travel times.
        2) Ride Requests: A set of requests R, each defined by: PassengerID, pickup/drop-off locations, and time windows.
        3) Vehicles: A set of available vehicles K, each with location, battery/fuel level, passenger capacity, and speed.'')
        
    # ---- Route Planning Agent ---- #
    RP_Agent = Agent(
        name=``Route Planning Agent'',
        backstory=``You determine optimal routes for vehicles to minimize total travel time while ensuring all passengers arrive on time.'',
        task_description=``Use traffic data and constraints to compute the best routes for each vehicle, ensuring on-time airport arrivals.'',
        task_expected_output=``Optimized vehicle assignments and travel routes.'')
    
    # ---- Vehicle Dispatch Agent ---- #
    VD_Agent = Agent(
        name=``Vehicle Dispatch Agent'',
        backstory=``You assign passengers to vehicles and ensure each vehicle follows the optimal planned route,'',
        
        task_description=``Assign passengers to vehicles based on capacity constraints and route efficiency,''
        
        task_expected_output=``Vehicle assignment list and dispatch schedule.'')
    
    # ---- Traffic Adjustment Agent (e.g. disruptions, special cases)---- #
    TA_Agent = Agent(
        name=``Traffic Adjustment Agent'',
        backstory=``You monitor live traffic updates and adjust vehicle routes dynamically in case of delays in Bay Area suburb.'',
        task_description=``Recompute routes in real time when disruptions occur (traffic, road closures), ensuring minimal delays.'',
        task_expected_output=``Updated travel plans for affected vehicles.'')
    
    # ---- Monitoring & Alert Agent ---- #
    MA_Agent = Agent(
        name=``Monitoring & Alert Agent'',
        backstory=``You track vehicle movements and notify if there are risks of missing passenger deadlines in Bay Area suburb.'',
        task_description=``Send alerts for potential delays and recommend contingency plans.'',
        task_expected_output=``Timely notifications for alternative route adjustments or emergency responses.'')
    
    Writer_agent = Agent(
        name=``Writer Agent'',
        backstory=``You are a language model specialized in writing text into .json files'',
        task_description=``Write the json response into ./p3_output.json'',
        task_expected_output=``A .json file containing the given string,
        tools=write_str_to_txt'')

    # ---- Define Dependencies (With Disruption) ---- #
    DC_Agent >> RP_Agent >> VD_Agent >> TA_Agent >> MA_Agent >> Writer_agent

    # ---- Define Dependencies (Without Disruption) ---- #
    DC_Agent >> RP_Agent >> VD_Agent >> MA_Agent >> Writer_agent

\end{lstlisting}

\subsection{P3: Execute Meta Plan without Disruption}

Now that the meta-plan workflow has been constructed, the second step involves providing real data for workflow execution. The following code snippet illustrates how vehicle and passenger locations are specified, followed by the corresponding agent executions.

\begin{lstlisting}[style=JSONStyle, caption=Sample JSON Output from Agentic Workflow, label=lst:data_collectionp3p4]
==================================================
RUNNING AGENT: Data Collection Agent
==================================================
1) \textbf{CityMap: A graph G=(V,E)}
   - \textbf{Locations V:}
     - V1: Downtown
     - V2: Golden Gate Park
     - V3: Fisherman Wharf
     - V4: Union Square
     - V5: San Francisco Airport (SFO)

   - \textbf{Roads E with distances and travel times:}
     - E1: Downtown to Golden Gate Park, Distance: 5 miles, Travel Time: 20 minutes
     - E2: Golden Gate Park to Fisherman Wharf, Distance: 6 miles, Travel Time: 25 minutes
     - E3: Fisherman Wharf to Union Square, Distance: 2 miles, Travel Time: 10 minutes
     - E4: Union Square to SFO, Distance: 15 miles, Travel Time: 30 minutes
     - E5: Downtown to SFO, Distance: 13 miles, Travel Time: 35 minutes

2) \textbf{Ride Requests: A set of requests R}
   - Request 1:
     - PassengerID: P001
     - Pickup: Downtown
     - Drop-off: Union Square
     - Time Window: 9:00 AM - 9:30 AM
   - Request 2:
     - PassengerID: P002
     - Pickup: Golden Gate Park
     - Drop-off: SFO
     - Time Window: 10:00 AM - 11:00 AM
   - Request 3:
     - PassengerID: P003
     - Pickup: Fisherman Wharf
     - Drop-off: Downtown
     - Time Window: 1:00 PM - 1:30 PM

3) \textbf{Vehicles: A set of available vehicles K}
   - Vehicle 1:
     - Location: Downtown
     - Battery/Fuel Level: 80%
     - Passenger Capacity: 4
     - Speed: 30 mph
   - Vehicle 2:
     - Location: Union Square
     - Battery/Fuel Level: 60%
     - Passenger Capacity: 6
     - Speed: 25 mph
   - Vehicle 3:
     - Location: SFO
     - Battery/Fuel Level: 90%
     - Passenger Capacity: 3
     - Speed: 35 mph

This structured data provides an overview of the current traffic conditions, road closures, and estimated travel times for passenger transport in SF.

================================================== 
RUNNING AGENT: Route Planning Agent
==================================================
Optimized vehicle assignments and travel routes:

1) \textbf{Vehicle Assignments:}

   - Vehicle 1:
     - Assigned to Request 1
     - Route: Downtown (V1) -> Union Square (V4)
     - Estimated Travel Time: 20 minutes (E1 + E3)
     - Departure Time: 9:00 AM
     - Arrival Time: 9:20 AM

   - Vehicle 2:
     - Assigned to Request 2
     - Route: Union Square (V4) -> Golden Gate Park (V2) -> SFO (V5)
     - Estimated Travel Time: 55 minutes (E3 + E2 + E4)
     - Departure Time: 10:00 AM
     - Arrival Time: 10:55 AM

   - Vehicle 3:
     - Assigned to Request 3
     - Route: Fisherman Wharf (V3) -> Downtown (V1)
     - Estimated Travel Time: 10 minutes (E3)
     - Departure Time: 1:00 PM
     - Arrival Time: 1:10 PM

2) \textbf{Travel Routes:}

   - Request 1:
     - Vehicle 1 will pick up Passenger P001 at Downtown and drop off at Union Square.
     - Route: V1 -> V4

   - Request 2:
     - Vehicle 2 will pick up Passenger P002 at Golden Gate Park and drop off at SFO.
     - Route: V4 -> V2 -> V5

   - Request 3:
     - Vehicle 3 will pick up Passenger P003 at Fisherman Wharf and drop off at Downtown.

==================================================
RUNNING AGENT: Vehicle Dispatch Agent
==================================================
Vehicle Assignment List and Dispatch Schedule:

1) \textbf{Vehicle Assignments:}

   - Vehicle 1:
     - Assigned to Request 1
     - Passengers: P001
     - Route: Downtown (V1) -> Union Square (V4)
     - Estimated Travel Time: 20 minutes
     - Departure Time: ``9:00 AM''
     - Arrival Time: ``9:20 AM''

   - Vehicle 2:
     - Assigned to Request 2
     - Passengers: P002
     - Route: Union Square (V4) -> Golden Gate Park (V2) -> SFO (V5)
     - Estimated Travel Time: 55 minutes
     - Departure Time: ``10:00 AM''
     - Arrival Time: ``10:55 AM''

   - Vehicle 3:
     - Assigned to Request 3
     - Passengers: P003
     - Route: Fisherman Wharf (V3) -> Downtown (V1)
     - Estimated Travel Time: 10 minutes
     - Departure Time: ``1:00 PM''
     - Arrival Time: ``1:10 PM''

2) \textbf{Dispatch Schedule:}

   - 9:00 AM: Vehicle 1 departs from Downtown with Passenger P001.
   - 9:20 AM: Vehicle 1 arrives at Union Square.
   - 10:00 AM: Vehicle 2 departs from Union Square with Passenger P002.
   - 10:55 AM: Vehicle 2 arrives at SFO.
   - 1:00 PM: Vehicle 3 departs from Fisherman Wharf with Passenger P003.
   - 1:10 PM: Vehicle 3 arrives at Downtown.

These assignments and schedules ensure efficient use of vehicles and timely arrival of all passengers.

==================================================
RUNNING AGENT: Monitoring & Alert Agent
==================================================
\textbf{Alert Notification:}

1) Vehicle 1:
   - Current Status: On schedule.
   - Recommendation: No action needed as the vehicle is expected to arrive on time.

2) Vehicle 2:
   - Current Status: Potential delay risk due to high traffic expected around Golden Gate Park.
   - Recommendation: Consider adjusting the route to avoid traffic congestion. Possible alternative: Take the route via Sunset Blvd to bypass heavy traffic areas. Notify the passenger of the potential delay and the alternative route.

3) Vehicle 3:
   - Current Status: On schedule.
   - Recommendation: No action needed as the vehicle is expected to arrive on time.

\textbf{Contingency Plan:}

Emergency Response: If Vehicle 2 faces unexpected delays despite the alternative route, prepare a standby vehicle for immediate dispatch from a nearby location to ensure Passenger P002 reaches SFO on time.

==================================================
RUNNING AGENT: Writer Agent
==================================================
Thought: I need to write the given context string into a JSON file named ``./p3_output.json''.

Using Tool: write_str_to_txt
Tool call dict: {omitted}
Data successfully written to ``./p3_output.json''
Tool result: None
Observations: {0: None}
The context string has been successfully written into ``./p3_output.json'' as a JSON file.

\end{lstlisting}

\subsection{P4: Execute Meta Plan with Disruption}

This section depicts the execution of the meta-plan (workflow) under traffic disruption. In this scenario, the system dynamically identifies traffic delays and integrates real-time updates into the planning process. Each agent plays a crucial role: the data collection agent continuously monitors traffic conditions; the route planning agent adjusts travel routes based on congestion data; and the dispatch agent ensures that vehicle assignments are optimized despite delays. The workflow demonstrates how coordinated agent interventions, including dynamic rerouting and schedule adjustments, effectively mitigate the impact of heavy traffic, maintaining timely transportation, and enhancing overall operational efficiency.

\begin{lstlisting}[style=JSONStyle, caption=Sample JSON Output from Agent Pipeline, label=lst:disruptionp3p4]
==================================================
RUNNING AGENT: Traffic Adjustment Agent
==================================================
1) \textbf{Vehicle V1 (Passenger 101):}
   - \textbf{Current Disruption:} Heavy traffic reported on the route from Downtown SF to SF Airport.
   - \textbf{Updated Route:}
     - Start at Union Square
     - Travel to Downtown SF (2 miles, 15 minutes)
     - Detour via I-280 South instead of the usual route to SF Airport
     - Estimated travel time via detour: 30 minutes
   - \textbf{Total Updated Estimated Travel Time:} 45 minutes
   - \textbf{Revised Departure Time:} ``08:15'' to ensure timely arrival within the window.
   - \textbf{Special Instructions:} Maintain communication with the passenger about the updated route and expected arrival time.

2) \textbf{Vehicle V2 (Passenger 102):}
   - \textbf{Current Disruption:} Road closure near Fisherman Wharf due to an event.
   - \textbf{Updated Route:}
     - Start at Fisherman Wharf
     - Detour via Bay Street to Van Ness Avenue, then proceed to Golden Gate Bridge
     - Estimated travel time via detour: 15 minutes
   - \textbf{Total Updated Estimated Travel Time:} 15 minutes
   - \textbf{Revised Departure Time:} ``09:15'' to ensure timely arrival within the window.
   - \textbf{Special Instructions:} Ensure fuel levels are adequate for the detour and communicate any changes to the passenger.

\end{lstlisting}
