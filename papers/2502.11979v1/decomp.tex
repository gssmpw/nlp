\newcommand{\MaxGadgetDepth}{\frac{\omega^5}{4}}
\newcommand{\TwoMaxGadgetDepth}{\frac{\omega^5}{2}}
\newcommand{\FourMaxGadgetDepth}{\omega^5}

\label{sec:decomp}

The algorithm first partitions the drivers using a recursive decomposition of the grid $G$.
At each level of the decomposition, the grid is split into blocks, which are $\omega$-wide subgrids (continuous subsequences of rows).
At the first level $\mathcal{L}_1$, the decomposition is trivial: the whole grid $G$ forms a single block.
At each of the following levels $j+1$, $\mathcal{L}_{j+1}$ is obtained by splitting each block of $\mathcal{L}_j$ into at most two blocks.
Let $H$ be a block in $\mathcal{L}_j$.
The \emph{middle row} of vertices in $H$ will divide the block into two:
the upper block will be formed by all rows above the middle one
and the lower block will be formed by all rows below it.
Provided that those blocks are non-empty, they are added to $\mathcal{L}_{j+1}$.
For reasons that we describe later, the process finishes at the last level where all blocks have length at least
$\TwoMaxGadgetDepth$.
This gives us $\log m + 1$ levels.

Note that, although the blocks at a single level of the decomposition do not necessarily cover the whole grid, they are disjoint.
Also, all blocks across all $\mathcal{L}_j$'s form a laminar family, i.e., any two blocks are either disjoint or one is fully contained in the other.
Furthermore, at the last level of the decomposition, the blocks are of size at most $\FourMaxGadgetDepth + 1$.
Note that at least one block at the last level has to be shorter than that.
Otherwise, we could create the next level of the decomposition with all blocks of length at least $\TwoMaxGadgetDepth$.
The existence of a block of length at most $\FourMaxGadgetDepth$ implies that all blocks are of length at most $\FourMaxGadgetDepth + 1$
because of the following observation.

\begin{remark}
Block lengths at the same level of the decomposition differ by at most one.
\end{remark}
\begin{proof}
At the first level, we only have one block, so the claim holds naturally.
At each of the following levels, assuming that we have blocks of sizes belonging to the set $\set{s, s+1}$ for some $s$,
in the next level we will have blocks of sizes ranging from $\cefrac{s}{2}$ to $\flfrac{s-1}{2}$.
It is because the first one is split into blocks of sizes $\cefrac{s}{2}$ and $\flfrac{s}{2}$,
whereas the second one is split into blocks of sizes $\cefrac{s-1}{2}$ and $\flfrac{s-1}{2}$.
For odd $s$ the block sizes are $\frac{s+1}{2}$ and $\cefrac{s-1}{2}$, which differ by one.
For even $s$ they are $\frac{s}{2}$ and $\frac{s-2}{2}$, which also differ by one.
Hence, lengths blocks on the next level also differ by at most one.
\end{proof}

\begin{definition}
A driver $(u,v,b)$ is \emph{assigned} to a block $H$ iff $H$ is the smallest block containing vertices $u$ and $v$.
We will denote a multiset of those drivers as $B_H$.
\end{definition}

For each driver such a block is unique (from laminarity) and must exist because the whole grid is one of the blocks.
Also, for a driver $(u, v, b)$ assigned to $H$, $u$ and $v$ must lie on opposite sides of the \emph{middle row} of $H$
(or on the middle row itself).

All drivers assigned to blocks from $\mathcal{L}_j$ form $B_j$.
From now on we focus on a single level of the decomposition $j$ and present a constant factor approximation algorithm for the problem restricted to $B_j$.
In other words, we will arrive at a price assignment to all edges in $G$ whose revenue will be within a constant factor of the optimal revenue with respect to $B_j$.
Let us denote the latter value by $\mathrm{OPT}_j$.
Because we partition the drivers into $\log m$ multisets, one of the $\mathrm{OPT}_j$'s must be at least $\frac{1}{\log m}$ of the optimal global revenue.
By picking the best of the $\log m$ solutions, we will achieve a $\OO{\log m}$-approximation globally.

\subsection{Separating Subproblems}

Intuitively, we would like to split the problem restricted to $B_j$ into subproblems corresponding to the blocks of $\mathcal{L}_j$ (fragmentation of $G$)
and drivers assigned to them (partition of $B_j$).
Ideally, we would solve those subproblems independently and each of the solutions would yield a pricing of edges in the corresponding block
achieving a constant factor approximation of the revenue with respect to the drivers assigned to that block.
Then, we could apply all those solutions simultaneously to the whole grid and gain a constant factor approximation with respect to $B_j$.

This, however, is not possible as the blocks of $\mathcal{L}_j$ together with assigned drivers do not form independent subproblems.
Although, for any $H$, both endpoints of all paths desired by a driver in $B_H$ are in block $H$,
a cheapest path desired by her may contain edges outside of $H$.
The solution is to extend the subproblem corresponding to $H$ to include some of the edges outside of $H$ and optimize their prices
with respect to the revenue from $B_H$.
If we did this naively and added all edges that could be used by drivers assigned to $H$,
we would have to extend the corresponding subproblem to the whole grid.
Then, we would be able to optimize for only one of the blocks of $\mathcal{L}_j$ at a time,
which is not helpful, as $\abs{\mathcal{L}_j}$ can be as large as $n$.

However, it turns out that extending a subproblem by adding only a constant number of rows adjacent to the corresponding block is enough.
This is because we can model any finite-length grid using a relatively shallow grid with the same width.
In other words, for any block $H$, it makes no difference to the revenue whether the drivers from $B_H$ can use all the edges in $G$
or are restricted to $H$ and a constant number of rows above and below it.
Let us formalize this observation.

\input{compression_lemma.tex}

Based on \cref{lemma:compression}, we create independent subproblems using an odd- and even-step approach.
Let us index the blocks of $\mathcal{L}_j$ from top to bottom.
In the odd-step (even-step), we extend all the odd-indexed (even-indexed) blocks by $\MaxGadgetDepth$ up and down.
Those extra rows are assigned to the corresponding blocks, i.e. are part of the corresponding subproblems and will be priced according to their solution.
Because of that, they cannot overlap with other blocks in the same step or their extensions.
And indeed they do not as all blocks have length at least $\TwoMaxGadgetDepth$.
Thich means that blocks of the same parity are at least $\TwoMaxGadgetDepth$ apart---enough to accomodate two
extensions.

Note that some of the extensions could be shorter than $\MaxGadgetDepth$.
This can only happen to the top and bottom blocks which are closer than $\MaxGadgetDepth$ to the top or bottom end of the grid.
Let $H$ be such a top (bottom) block.
The extension of $H$ to the top (bottom) is shorter than $\MaxGadgetDepth$, but it reaches the end of the grid.
Thus, it contains all the paths to the top (bottom) of $H$ that drivers assigned to $H$ could use.

Each of the steps (odd and even) consists of independent and disjoint subproblems,
which are solved by the algorithm presented in \cref{sec:single_block}.
We ensure the separation of the subproblems within the same step by pricing the edges between them at $\infty$ (more specifically $b_{max} + 1$).
Thus, solutions to those subproblems can be applied simultaneously forming a global solution to the whole grid.
Because multisets of drivers assigned to different subproblems form a partition of $B_j$,
one of the subproblems must have an optimal solution yielding at least $\frac{\mathrm{OPT}_j}{2}$ revenue.
As for each subproblem separately we will achieve a constant factor approximation,
one of the solutions has to generate revenue within a constant factor of $\frac{\mathrm{OPT}_j}{2}$.

All subproblems for blocks in all levels of decomposition apart from the last one
have a special structure that we exploit in the algorithm.
Because such a block $H$ is divided into two blocks by the middle row,
only drivers ($u, v, b$) whose vertices $u$ and $v$ are separated by or lying on the middle row of $H$ can be assigned to $H$.
Otherwise, they would be assigned to the upper or lower block (in the next level of the decomposition).

That does not hold for a block $H'$ at the last level of the decomposition.
However, as we observed earlier, such a block $H'$ is at most $\FourMaxGadgetDepth + 1$ long.
Even with extensions, it gives us a constant upper bound on the size of the instance associated with $H'$
($\frac{3}{2} \FourMaxGadgetDepth + 1$)
and, thus, a constant upper bound on the number of edges in that instance.
This observation, together with the Rounding Lemma (\cref{rounding_lemma}), allows us to
find a $4$-approximation for $H'$ with extensions and drivers $B_{H'}$ in polynomial time.
We iterate over all price assignments which draw prices from the set $\roundedSet$ from the Rounding Lemma,
and apply them to the edges in the instance associated with $H'$.
Since $\abs{\mathcal{P}}$ is polynomial in the size of the instance and there is a constant number of edges,
such a procedure is polynomial.
By the Rounding Lemma, one of those assignments will achieve revenue of at least $\frac{1}{\Crounding}$ of the optimal one.
From now on, we focus on the subproblems for blocks in all levels of decomposition excluding the last one.