    \label{apx:compression_lemma}

    Here we provide proofs which were omitted from \cref{sec:decomp} due to space considerations.

    \compressionlemma*

    Before proceeding with the proof, we introduce the concept of crossing vertices and an auxiliary lemma.
    A \emph{crossing vertex} of two paths $P_1$ and $P_2$ is an endpoint of a maximal path shared by $P_1$ and $P_2$.
    Whenever we call a vertex crossing without referencing any specific pair of paths,
    we mean that it is a crossing vertex of some pair from a given set of paths.
    
    \crossingvtexlemma*
    \begin{proof}
        \newcommand{\cross}[2]{\mathrm{cross}\bra{#1, #2}}
        Let us consider any collection of shortest paths in $G$ between pairs of vertices in $S$, namely
        $ \longset{P_{a, b}}{a, b \in S, a \neq b} $,
        where $P_{a, b}$ is an arbitrarily chosen shortest $a$-$b$ path in $G$.
        Without loss of generality, we assume that these paths are simple (any path can be made simple by removing loops).
        We'll now present a procedure that limits the number of crossing vertices outside $S$ to
        ${\abs{S} \choose 2} \cdot \bra{{\abs{S} \choose 2} - 1}$
        without changing the distances between vertices in $S$.

        \input{path_rerouting_algo.tex}
    
        The above procedure gradually creates $\mathcal{R}$ -- a family of shortest paths as in
        $G$ with limited number of crossing vertices.
        Throughout the procedure we maintain that there are only at most
        $\abs{\mathcal{R}} \bra{ \abs{\mathcal{R}} - 1}$ crossing vertices that don't belong to $S$.
        With $\cross{P}{Q}$ we denote the set of crossing vertices of paths $P$ and $Q$.
        Then, we write our invariant as:
        \begin{equation}
            \label{crossing_invariant}
            \abs{ \bigcup_{R_1, R_2 \in \mathcal{R}} \cross{R_1}{R_2} \setminus S } \leq \abs{\mathcal{R}} \bra{ \abs{\mathcal{R}} - 1}
        \end{equation}

    Let us process the paths from $ \longset{P_{a, b}}{a, b \in S, a \neq b} $ in any fixed order.
    Each path $P$ will be iteratively rerouted with respect to each path already in $\mathcal{R}$
    to ensure that it is contributing at most two crossing vertices with each $R \in \mathcal{R}$.
    Let us consider a single such rerouting step for $P$, a shortest $a$-$b$ path, and $R$ -- a path that was already processed before.
    If $P$ and $R$ have at most two crossing vertices -- we leave $P$ as is and proceed with the next path $R' \in \mathcal{R}$.
    Otherwise, we create a new path $P'$ from $P$ by replacing the $c_1$-$c_q$ part with the $c_1$-$c_q$ part of $R$.
    Since $R$ also is a shortest (=cheapest) path, $R[c_1 \dots c_q]$ also is a cheapest $c_1$-$c_q$ path,
    making $P'$ a cheapest $a$-$b$ path.
    Note that only $c_1$ and $c_q$ are crossing vertices of $P'$ and $R$.

    Now we also need to show that no other new crossing vertices between $P'$ and the already processed paths from $\mathcal{R}$ were created.
    More formally, for each $R' \in \mathcal{R}$ that was already processsed with $P$:
    \begin{equation*}
        \cross{P'}{R'} \setminus \set{a,b} \quad \subseteq \quad \cross{P}{R'} \cup \cross{R}{R'} \cup \set{c_1, c_q}
    \end{equation*}
    Note that all crossing vertices on the right-hand side apart from $c_1$ and $c_q$ where already added to the set of crossing vertices
    before $P$ was rerouted with respect to $R'$.
    To prove this, we will consider all vertices lying strictly inside the three parts of $P'$:
    $P[a \dots c_1]$, $R[c_1 \dots c_q]$, and $P[c_q \dots b]$.    
    $P[a \dots c_1]$ and $P[c_q \dots b]$ did not change, so any crossing vertices have already been accounted for
    when $P$ was being rerouted with respect to other paths in $\mathcal{R}$:
    \[ \cross{P[a \dots c_1]}{R'} \setminus \set{a, c_1} \quad \subseteq \quad \cross{P}{R'} \]
    \[ \cross{P[c_q \dots b]}{R'} \setminus \set{b, c_q} \quad \subseteq \quad \cross{P}{R'} \]
    $R[c_1 \dots c_q]$ is already a subpath of $R$,
    so naturally all crossing vertices strictly inside it are also crossing vertices of $R$ and $R'$:
    \[ \cross{R[c_1 \dots c_q]}{R'} \setminus \set{c_1, c_q}
        \quad \subseteq \quad \cross{R}{R'} \]
    Thus, all crossing vertices of $P'$ and any $R'$ that was already processed (apart from $c_1$ and $c_q$)
    were already crossing vertices before.
    Hence, we have that $P$ contributes only $c_1$ and $c_q$ as new crossing vertices when rerouted with respect to $R$.

    In the end we replace $P$ with $P'$ and continue rerouting it with respect to the remaining paths in $\mathcal{R}$.
    In the end, when $P$ is added to $\mathcal{R}$, it produces at most two crossing vertices with each path already in $\mathcal{R}$.
    This maintains the invariant that there are at most $\abs{\mathcal{R}} \bra{ \abs{\mathcal{R}} - 1}$
    crossing vertices between the paths in $\mathcal{R}$ (excluding $S$, the path endpoints).
    Also $P$ remains a shortest $a$-$b$ path.
    Thus, because $\abs{\mathcal{R}} = {\abs{S} \choose 2}$, $\mathcal{R}$ is the desired collection of paths.
    \end{proof}


    \begin{proof}[Proof of \cref{lemma:compression}]
    With the help of the above lemma, we will now prove \cref{lemma:compression}.
    For ease of exposition in the proof we will deal with incomplete grids, i.e., grids where some edges are missing.
    We model those missing edges by setting their weights to $\infty$.
    This way we will reason about incomplete grids, but, in reality, the underlying grid will be complete.

    Starting with the original grid $G$, we prove the above lemma by creating consecutive graphs
    and showing that the distances between vertices in the first row (denoted $S$) are preserved in each step.

    \paragraph{\textbf{$G'$ -- shortest path graph with few crossing vertices}}
    By \cref{lemma:crossing_vertices} there exists a collection $\mathcal{R}$ of shortest paths between vertices in $S$
    that results in at most ${\omega \choose 2} \cdot \bra{{\omega \choose 2} - 1}$ crossing vertices outside of the first row.
    We define $G'$ as the union of all paths in $\mathcal{R}$.
    Note that, by construction, pairwise distances between vertices in $S$ are the same in $G'$ as in $G$.

    \paragraph{\textbf{$G''$ -- a grid with small depth}}
    Now, let us compress $G'$ to a grid of depth at most $\MaxGadgetDepth$.
    Let us consider maximal ranges of consecutive rows in $G' \setminus S$ that only contain vertices of degree $2$.
    For brevity we will call them $2$-layers.
    
    Let us consider a single $2$-layer $L$.
    It must be a $l \times \omega$ (partial) grid for some $l$.
    If $l \leq \omega+1$, we leave $L$ as is.
    Otherwise, we will compress it to a $\omega \times (\omega+1)$ (partial) grid.
    Let $U$ and $D$ be  the sets of vertices in the top and bottom row of $L$
    that have edges outgoing from $L$.
    Note that $U \cup D$ are exactly the vertices having edges outgoing from $L$.
    Thus, to preserve distances between vertices in $S$ globally, it is enough to maintain the distances from $L$ between vertices in $U \cup D$.
    Now let us look at $L$ in isolation from the rest of the graph.
    
    \begin{figure}
        \centering
        \vspace{-0.5cm}
        \includegraphics[width=0.5\textwidth]{2-layer-grid}
        \vspace{-0.5cm}
        \caption{
            An example of a compressed $2$-layer, where vertices in $U \cup D$ are connected using the newly created paths.
            Note that not all vertices in the border rows belong to $U$ or $D$,
            but only those that have edges going outside of the $2$-layer.
        }
        \label{fig:nestedgrid}
    \end{figure}

    Note that inside $L$ (in isolation from the rest of the graph), all vertices have degree two except for those in $U \cup D$.
    This is because all $L$'s vertices had degree two in $G''$ and of those in $U \cup D$ each had one edge outgoing from $L$.
    Consequently, $L$ can be partitioned into paths that connect vertices in $U \cup D$.
    There will be no cycles in this decomposition, because $G''$ is a union of paths starting and ending outside of $L$.
    Again, because the maximal degree is two, those path do not cross (are vertex disjoint).
    Thus, each vertex $a \in U \cup D$ is connected (via such a path) to exactly one vertex $b$ in $U \cup D$
    (it is a perfect matching on $U \cup D$).
    In our compressed grid $L'$ we will connect each such $a$ with the matching $b$ using vertex disjoint paths.
    Then, for each $a, b \in U \cup D$ we can make the total costs along such an $a$-$b$ path equal to
    the corresponding distance from $a$ to $b$ in $L$
    (for example by setting one edge's weight to it and leaving the other weights at $0$).
    Now, we will show that those disjoint paths can be created in a grid of depth $\omega + 1$.
    
    With $U_{in}$ we term the set of vertices in $U$ that are matched with other vertices in $U$.
    Let us consider all vertices in $U$ in the order from left to right as they appear in $L$.
    Let $a, b \in U_{in}$ be connected by a path in $L$.
    We will show by contradiction that any vertex $c \in U$ which is between $a$ and $b$
    must be matched with a vertex $d \in U$ that also lies between $a$ and $b$.
    If $d \notin U$ ($d \in D$), any $a$-$b$ path crosses with any $c$-$d$ path,
    because the latter would have to reach the bottom row from the topmost one of $L$ and the former starts and ends in the topmost row.
    Such a crossing would necessarily result in a vertex of degree at least $3$, which, by the definition of a $2$-layer, is impossible.
    If $d \in U$, but was not between $a$ and $b$, each possible pair of $a$-$b$ and $c$-$d$ paths would also have to cross at least once,
    which is impossible for the same reason.
    Thus, vertices in $U_{in}$ can be connected as shown in \cref{fig:nestedgrid}.

    Since the maximal nesting level of the connected pairs is $\frac{\abs{U_{in}}}{2}$ and one extra row of vertices is needed per level of nesting,
    this gives us a depth of $\frac{\abs{U_{in}}}{2} + \frac{\abs{D_{in}}}{2}$.
    Of course, vertices in the analogous set $D_{in}$ are connected in the same way.
    
    Now, each vertex in $U_{out} := U \setminus U_{in}$ is matched with a vertex from $D_{out} := D \setminus D_{in}$.
    Note that this perfect matching between $U_{out}$ and $D_{out}$ preserves the left-to-right ordering of the vertices
    (that is, the leftmost vertex in $U_{out}$ is matched with the leftmost one in $D_{out}$ and so on).
    It is because if we had two pairs of matched vertices violating this order, the paths connecting them would cross.
    In the previous stage, no edges have been added in the columns of vertices from $U_{out}$ and $D_{out}$, so we add respectively $\frac{\abs{U_{in}}}{2} + 1$ and $\frac{\abs{D_{in}}}{2} + 1$ vertical edges outgoing from them.
    Consequently, the algorithm keeps prolonging the resulting paths starting in $U_{out}$ and $D_{out}$ by appending edges to the other end until all matched pairs of vertices are connected. This happens from left to right. At each step the algorithm selects vertices $u$ and $d$, the ends of paths starting in leftmost of the yet unprocessed vertices from respectively $U_{out}$ and $D_{out}$, and connects them according to the following procedure:
    \begin{enumerate}[nosep]
    \item From whichever of $u$ and $d$ is further right, lead a horizontal path to the left until the column of the other one.
    \item Connect the paths ending in $u$ and $d$ using a vertical path of length $\abs{U_{out}}$ (twice the number of pairs left to connect including the current one).
    \item Remove vertices corresponding to $u$ and $d$ from $U_{out}$ and $D_{out}$.
    Depending on whether $u$ or $d$ was further right, prolong the vertical paths outgoing from vertices in $U_{out}$ ($u$) or $D_{out}$ ($d$) by one edge.
    \end{enumerate}
    
    By construction we are guaranteed that in each iteration the first edge to the left of $u$ and $d$ is
    the vertical path added in the step two of the previous iteration,
    which must be to the left of both $u$ and $d$.
    Hence, the horizontal path from the first step will not cross with any path.
    Since $\abs{U_{out}} = \abs{D_{out}}$, the above procedure connects exactly the matched pairs from $U_{out} \times D_{out}$.
    It needs extra depth of $\abs{U_{out}} + 1$.
    
    The above procedure creates a grid where exactly the matched pairs of vertices are connected and the matching is the same as in $L$.
    The resulting depth of $L'$ is equal to
    $\frac{\abs{U_{in}}}{2} + \frac{\abs{D_{in}}}{2} + 1 + \abs{U_{out}}
    \leq \max \bra{ \abs{U}, \abs{D}} + 1$.
    Thus, $L$ can be compressed to a $(\omega+1) \times \omega$ grid.
        
    Since there are at most ${\omega \choose 2} \cdot \bra{{\omega \choose 2} - 1}$ crossing vertices outside the first row,
    there can be at most ${\omega \choose 2} \cdot \bra{{\omega \choose 2} - 1}$ rows in the grid $G'$ that contain a vertex
    of degree $3$ or more (let us color those rows black).
    Now $G'$ consists of the row formed by vertices in $S$, the black rows, and $2$-layers.
    Let us create $G''$ from $G'$ by compressing the $2$-layers of more than $\omega + 1$ rows as described earlier.
    Now, in $G''$ we have at most ${\omega \choose 2} \cdot \bra{{\omega \choose 2} - 1}$ black rows,
    with each pair of consecutive ones being separated by at most $\omega+1$ rows.
    Adding the one row for $S$, this gives us
    ${\omega \choose 2} \cdot \bra{{\omega \choose 2} - 1} \cdot (\omega+2) + (\omega + 1) + 1 \leq \MaxGadgetDepth$
    rows in the grid $G''$,
    which has the same distances between vertices in $S$ as $G$.
    \end{proof}