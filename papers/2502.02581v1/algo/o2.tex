\begin{algorithm}[h!]
    \caption{Sparse Materialization}
    \label{algo:o2}
    \SetAlgoLined

    \KwIn{%
        \begin{tabular}[t]{@{}l@{}}
            $\set{P}$: sharded parameter placement\\
            $F$: expert load distribution\\
            $t$: overlap degree\\
            $m$: memory capacity per device\\
        \end{tabular}%
    }
    \KwOut{$\set{P}'$: materialization plan}
    
    $t \gets \min(t, |\set{E}|)$, $m \gets \min(m, t)$\;
    $\set{P}' \gets \set{P}$\;
    \eIf{$t \leq m$}{
        $\set{E}^\text{topT} \gets$ Top $t$ experts  by load $F$\; \label{algo:o2:br1start}
        $\set{P}' \gets \set{P}' \cup (\set{D} \times \set{E}^\text{topT})$\; \label{algo:o2:br1end}
    }{ \label{algo:o2:br2start}
        $totSlots \gets |\set{D}| \cdot m$\;  
        \ForEach{$e \in \operatorname{sortByLoadDescending}(\set{E}^\text{topT})$}{
            $n \gets \operatorname{assignSlotsByLoad}(e, totSlots, F)$\; \label{algo:o2:slot_assignment}
            $\set{P}^{e} \gets$ Distribute $n$ replicas of expert $e$ across nodes and devices, prioritizing nodes with more available slots\; \label{algo:o2:topo_awareness} 
            $\set{P}' \gets \set{P}' \cup \set{P}^{e}$\;
        } \label{algo:o2:br2end}
    }
    \Return{$\set{P}'$}
\end{algorithm}
