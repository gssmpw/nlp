\begin{algorithm}[hbp]
    \caption{Heterogeneous Sharding}
    \label{algo:o3}
    \SetAlgoLined

    \KwIn{%
        \begin{tabular}[t]{@{}l@{}}
            $F^\text{g}$: expert load distribution of all MoE layer \\
            $t$: overlap degree\\
        \end{tabular}%
    }
    \KwOut{$\gset{P}$: MoE sharding plan}

    $\set{J} \gets$ top-$t$ experts by load for each layer \; \label{algo:o3:partition-start}
    $\set{J}' \gets \gset{E} - \set{J}$ \; \label{algo:o3:partition-end}
    $S \gets |\gset{E}| / |\set{D}|$ ; \tcp{Available slots per device} \label{algo:o3:slots}
    $\gset{P} \gets \varnothing$ \;

    \CommentSty{/* Place underloaded experts first. */} \\
    $\set{L} \gets \{\set{E}_{l} \cap \set{J}' \ |\ l = 0, 1, \cdots, L\}$ \; \label{algo:o3:underloaded-start}
    \ForEach{$\set{E}'_{l} \in \operatorname{sortByMaxLoadDescending}(\set{L} )$} {
        $\set{P}_l \gets \varnothing$ \;
        \ForEach{$e \in \operatorname{sortByLoadDescending}(\set{E}'_{l})$} {
            $n \gets$ least-loaded node, prioritizing nodes with less available slots \;
            $d \gets$ least-loaded device on node $n$, prioritizing devices with less available slots \;
            $\set{P}_l \gets \set{P}_l \cup \{(d, e)\}$\;
            $S_{d} \gets S_{d} - 1$ \;
        }
        $\gset{P} \gets \gset{P} \cup \set{P}_l$ \;
    } \label{algo:o3:underloaded-end}

    \CommentSty{/* Place overlappable experts next. */} \\
    update $\gset{P}$ by arbitrarily placing $\set{J}$ to rest of slots $S$ \; \label{algo:o3:overlappable}

    \Return{$\gset{P}$}
\end{algorithm}
