\begin{algorithm}
\footnotesize
\caption{Data Construction for Stage I}
\label{algorithm:imi}
\begin{algorithmic}[1]
\Require Question $x$, answer $y$, language model $\mathcal{M}$, Retriever $\mathcal{R}$, max history length $T$
\Ensure Optimal reasoning process $s^*$ or $null$
\State Initialize priority queue $\mathcal{PQ} \gets \{([x], 0)\}$ 

\Comment{(trajectory, retrieval count)}
\While{$\mathcal{PQ}$ is not empty}
    \State $(h, r) \gets \mathcal{PQ}.dequeue()$ 
    
    \Comment{Get trajectory with lowest retrieval count}
    \State $q \gets \mathcal{M}(h)$ \Comment{Subquery Generation}
    \If{$ShouldAnswer(q)$ or $length(h) > T$}
        \State $o \gets \mathcal{M}(h, q)$ \Comment{Final answer}
        \If{$IsEqual(o, y)$}
            \Return $h$
        \EndIf
    \Else
        \State $a \gets \mathcal{M}(h, q)$ \Comment{Direct answer}
        \State $\mathcal{PQ}.enqueue(([h, (q, a)], r))$
        \State $d \gets \mathcal{R}(q)$ \Comment{Retrieve document}
        \State $a \gets \mathcal{M}(h, q, d)$ \Comment{Retrieved answer}
        \State $\mathcal{PQ}.enqueue(([h, (q, (d, a))], r+1))$
    \EndIf
\EndWhile
\State \Return $null$
\end{algorithmic}
\end{algorithm}