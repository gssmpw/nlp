\section{Final Upper bound}\label{sec:finalbound}

In this section, we use \cref{lem:marginbound} and \cref{cor:coverfinal} to give our generalization bound for hypotheses in $ \dlh,$ for all margin levels simultaneously. We now present our generalization bound and then proceed with the proof. 
\begin{theorem}\label{thm:finalmarginbound}
    There exists a universal constant $ c $  such that: For $ \cH \subseteq \{  -1,1\}^{\cX}$ a hypothesis class of VC-dimension $ d $, distribution $ \cD $ over $ \cX\times \{  -1,1\}  $, failure parameter $0<\delta<1$,  and training sequence size $ m\in \mathbb{N} $, it holds with probability at least $ 1-\delta $ over $ \rS\sim \cD^{m} $ that: for any margin $ 0<\gamma\leq 1 $ and any function $ f\in \dlh $
    \begin{align*}
     \ls_{\cD}(f)\leq 
     \ls_{\rS}^{\gamma}(f)
     +\negmedspace\negmedspace\sqrt{c\cdot \ls_{\rS}^{\gamma}(f) \left(\frac{d\func{\left(\frac{m\gamma^{2} }{d} \right)}}{m\gamma^{2}}
     +\frac{\ln{\left(\frac{e}{\delta} \right)}}{m}\right)} 
     \negmedspace+\negmedspace c \negmedspace\left(\frac{d\func{\left(\frac{m\gamma^{2} }{d} \right)}}{m\gamma^{2}}+\frac{\ln{\left(\frac{e}{\delta} \right)}}{m}\right)\negmedspace.
    \end{align*}
    where $ \func(x)=\Ln^{2}(\Ln(x))\Ln(x).$      
\end{theorem}

\begin{proof}
    Let $ c' \geq c>0 $ and $ c'\geq 1 $  be the universal constants from \cref{cor:coverfinal} and $ \tilde{c}=\max(1/c,c').$ We will show in the following, that with probability at least $ 1-\delta $ over $ \rS,$ it holds for all $ 0<\gamma\leq 1 $ and all $ f\in \dlh $ that
    \begin{align}\label{eq:finalbound-2}
        \ls_{\cD}(f)
        \leq
        \ls_{\rS}^{\gamma}(f)
        + \cc\Big(\sqrt{\frac{\ls_{\rS}^{\gamma}(f)\cdot 2 \left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{9600\tilde{c}^2 \min(c,1)d}{32\gamma^{2}} \func{\left(  \frac{32 m\gamma^{2} }{\min(c,1)d} \right)} \right)}{m}}
        \\
        +\frac{5\left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{9600\tilde{c}^2 \min(c,1)d}{32\gamma^{2}} \func{\left(  \frac{32 m\gamma^{2} }{\min(c,1)d} \right)}\right)}{m}\Big).\nonumber
    \end{align}
    We first notice that if $\frac{9600\tilde{c}^2 \min(c,1)d}{32m}\geq \gamma^{2}$, the right-hand side of the above is greater than
    $ 1 $, and we are done by the left-hand side always being at most
    $ 1 $, i.e. the above inequality holds with probability $ 1 $.
    Thus, we now consider the case where $1\geq \gamma^{2}\geq \frac{9600\tilde{c}^2 \min(c,1)d}{32m} $. We now further restrict the values we have to consider for the bound in \cref{eq:finalbound-2} to be non vacomuous, this is done to the end of employing \cref{cor:coverfinal} later in the argument.
 
    We will soon argue that the function $\func(x)/x$ is decreasing for $ x\geq e^{4},$ we notice this is also a continuous function i $ x.$ 
    Now consider the function $ 9600\tilde{c}^2 \func{\left(  \frac{32 m\gamma^{2} }{\min(c,1)d} \right)}/(\frac{32 m\gamma^{2} }{\min(c,1)d} ),$ which by the above is decreasing in $  \frac{32m\gamma^{2} }{\min(c,1)d}\geq e^{e},$ which is the case since we consider $ \gamma $ such that  $1\geq \frac{32 m\gamma^{2} }{\min(c,1)d} \geq 9600\tilde{c}^2\geq 9600.$ 
    This also implies that for the right hand side of \cref{eq:finalbound-2} being less than $ 1 $ for any $1\geq \gamma^{2}\geq \frac{9600\tilde{c}^2 \min(c,1)d}{32m} $ it must be the case that $ m $ is such that $9600\tilde{c}^2 \func{\left(  \frac{32 m }{\min(c,1)d} \right)}/(\frac{32m }{\min(c,1)d} )< 1$ which we assume is the case from now on.  
    Furthermore, by the above argued continuity and the function being decreasing, let $ \gamma' $ be such that   $ 1\geq\gamma'^{2} \geq \frac{9600\tilde{c}^2 \min(c,1)d}{32m} $ and that $ 9600\tilde{c}^2 \func{\left(  \frac{32 m\gamma^{2} }{\min(c,1)d} \right)}/(\frac{32 m\gamma^{2} }{\min(c,1)d} )=1,$ notice that $ \gamma' $ must be within the interval since the function was decreasing in $ \left(  \frac{32 m\gamma^{2} }{\min(c,1)d} \right) $ and for the value $\gamma^{2}=  \frac{9600\tilde{c}^2 \min(c,1)d}{32m}$ the function is greater than $1.$ Notice that for the values of $ \gamma,$ between $ \gamma'^{2}\geq \gamma \geq \frac{9600\tilde{c}^2 \min(c,1)d}{32m},$ the bound on the right hand side of \cref{eq:finalbound-2} is again larger than $ 1,$ so we consider from now on the case $ 1\geq\gamma^{2}\geq\gamma'^{2},$ and $ m $  such that $9600\tilde{c}^2 \func{\left(  \frac{32m }{\min(c,1)d} \right)}/(\frac{32m }{\min(c,1)d} )<1.$ Furthermore, again by the above argued monotonicity we notice that for $ 1\geq\gamma^{2}\geq \gamma'^{2} $ we have that 
    \begin{align}\label{eq:finalbound-3}
        9600\tilde{c}^2 \func{\left(  \frac{32 m\gamma^{2} }{\min(c,1)d} \right)}/\left(\frac{32 m\gamma^{2} }{\min(c,1)d} \right) 
        \leq 9600\tilde{c}^2 \func{\left(  \frac{32 \gamma'^{2}m }{\min(c,1)d} \right)}/\left(\frac{32 \gamma'^{2}m }{\min(c,1)d} \right)= 1
    \end{align}  
    which gonna be important later when we want to invoke \cref{cor:coverfinal}.   
    
    To argue that $ \func(x)/x $  is decreasing  for $ x\geq e^{4},$ we notice that for $ x\geq e^{4} $ we have that $ \func(x)=\Ln^{2}(\Ln(x))\Ln(x)=\ln^{2}(\ln{\left(x \right)})\ln{\left(x \right)},$ thus it suffices to show that the function $ f(x)=\ln^{2}(\ln{\left(x \right)})\ln{\left(x \right)}/x $ is decreasing for $ x\geq e^{4}.$  
    $ f $ has derivative $ (2\ln{\left(\ln{\left(x \right)} \right)}-\ln{\left(x \right)}(\ln{\left(\ln{\left(x \right)} \right)})^{2}+\left(\ln{\left(\ln{\left(x \right)} \right)}\right)^{2})/x^{2}.$ 
    We observe that for $ x\geq e^{2} $ we have that $  -\ln{\left(x \right)}(\ln{\left(\ln{\left(x \right)} \right)})^{2}/2+\left(\ln{\left(\ln{\left(x \right)} \right)}\right)^{2} \leq 0$ and for $ x\geq e^{4} $ we have that $ 2\ln{\left(\ln{\left(x \right)} \right)}-\ln{\left(x \right)}(\ln{\left(\ln{\left(x \right)} \right)})^{2}/2\leq 0.$ Whereby we conclude that $ f(x)=\ln^{2}(\ln{\left(x \right)})\ln{\left(x \right)}/x $ is decreasing for $ x\geq e^{4}.$ We are now ready to setup the parameters for the union bound over the different level sets of $ \gamma $ . 

    Let $I=\{   0,\ldots,\lfloor\log_{2}(  1/\gamma')\rfloor \}$
    and define $ \gamma_{0}^{i}=\sqrt{2^{i}\gamma' } $ and $ \gamma_{1}^{i}=\sqrt{2}\gamma_{0}^{i}$, for $ i\in I$, except $ i=\lfloor\log_{2}(  1/\gamma')\rfloor,$ where we define $ \gamma_{1}^{\lfloor\log_{2}(  1/\gamma')\rfloor}=1 $. For $ i\in I $ we also define $ N_{i}= \exp{\left(\frac{72 c'd}{ (\gamma_{0}^{i})^{2}} \func{\left(  \frac{16m(\gamma_{0}^{i})^{2}}{cd} \right)} \right)}  $ and $ \delta_{i}= \frac{\delta}{1640N_{i}^{2}} \frac{d}{m(\gamma_{0}^{i})^{2}}$. Furthermore, for each $ i\in I $ we define $ J_{i} =\{0, 1,\ldots,\big\lfloor\frac{m}{\ln{\left(N_{i} \right)}}\big\rfloor\}$ and for $ j\in J_{i} $  define  $ \tau_{0}^{i,j}=j\frac{\ln{\left(N_{i} \right)}}{m} $ and $ \tau_{1}^{i,j}=\left(j+1\right)\frac{\ln{\left(N_{i} \right)}}{m} $. Lastly for $ i\in I $ and $ j\in J_{i} $ we define
    \begin{align*}
        \beta_{i,j}= \cc\left(\sqrt{\frac{\tau_{1}^{i,j}\cdot 2 \ln{\left(\frac{e}{\delta_{i}} \right)}}{m}} 
         +\frac{2\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}\right).
     \end{align*} 
    For now let  $ i\in I  $, then with the above notation, we get by the union bound and an invocation of \cref{lem:marginbound} that 
    
    \begin{align}\label{eq:finalbound-1}
        &\p_{\rS\sim\cD^{m}}\Bigg[\exists j\in J_{i},
            \exists \gamma \in \left[\gamma_{0}^{i},\gamma_{1}^{i}\right]
            ,\exists f\in \dlh: 
            \ls_{\rS}^{\gamma}(f)\in [\tau_{0}^{i,j},\tau_{1}^{i,j}] 
            ,\ls_{\cD}(f) \geq \tau_{1}^{i,j} 
            + \beta_{i,j}
            \Bigg] \nonumber
            \\
            &\leq
            \sum_{j\in J_{i}}\p_{\rS\sim\cD^{m}}\Bigg[
            \exists \gamma \in \left[\gamma_{0}^{i},\gamma_{1}^{i}\right]
            ,\exists f\in \dlh: 
            \ls_{\rS}^{\gamma}(f)\in [\tau_{0}^{i,j},\tau_{1}^{i,j}] 
            ,\ls_{\cD}(f) \geq \tau_{1}^{i,j} 
            + \beta_{i,j}
            \Bigg]\nonumber
            \\
            &\leq \left(\left\lfloor\frac{m}{\ln{\left(N_{i} \right)}}\right\rfloor+1\right) \delta_{i}  \sup_{X\in \cX^{2m}}  \cN_{\infty}(X,\dlh_{\left\lceil2\gamma_{1}^{i}\right\rceil},\frac{\gamma_{0}^{i}}{2}) .
    \end{align}
    We remark that if $ i\in I $ is such that  $ \frac{\ln{\left(N_{i} \right)}}{m}>1 $, then we have that $ \tau_{1}^{i,j}=(j+1)\frac{\ln{\left(N_{i} \right)}}{m}>1,$ which implies that we could have upper bounded the above with $0$. Thus, we assume for now that $ i\in I $ such that  $ \frac{\ln{\left(N_{i} \right)}}{m}\leq1 $, which implies that $ \big(\big\lfloor\frac{m}{\ln{\left(N_{i} \right)}}\big\rfloor+1\big) $ is upper bounded by $ \frac{2m}{\ln{\left(N_{i} \right)}} $.

    To the end of employing \cref{cor:coverfinal} with $\gamma= \min(2\gamma_{1}^{i},1) $ and $ \alpha=\frac{\gamma_{0}^{i}}{4\gamma_{1}^{i}}$, we notice that for $\gamma= \min(2\gamma_{1}^{i},1) $ and $ \alpha=\frac{\gamma_{0}^{i}}{4\gamma_{1}^{i}}$ we have that 
    \begin{align}\label{eq:finalbound-4}
        \cN_{\infty}(X,\dlh_{\left\lceil2\gamma_{1}^{i}\right\rceil},\frac{\gamma_{0}^{i}}{2})\leq\cN_{\infty}(X,\dlh_{\left\lceil\gamma\right\rceil},\alpha \gamma)  
    \end{align}
    where the inequality follows from in the case that $
    \gamma=\min(2\gamma_{1}^{i},1)=1,$ then since the functions in $ \dlh $ only attains values in $
    [-1,1]$, we have that  $
    \dlh_{\left\lceil2\gamma_{1}^{i}\right\rceil}=\dlh_{\left\lceil1\right\rceil}
    =\dlh$ and that the covering number being decreasing in the precision argument and $ \gamma_{0}^{i}/2\geq \alpha\gamma $.
    Furthermore, to the end of invoking \cref{cor:coverfinal}, we now argue that $ \gamma^{2}\geq \frac{4cd\Ln^{2}(\Ln{ ( \frac{8\alpha m \gamma^{2}}{cd}) }) }{\alpha^{2}m}$ for the above $ \gamma$ and $ \alpha .$  To this end we notice that since $ \gamma_{0}^{i} $ and $ \gamma\sqrt{2}\gamma_{0}^{i},$ except $ i=\lfloor\log_{2}(  1/\gamma')\rfloor,$ where we define $ \gamma_{1}^{\lfloor\log_{2}(  1/\gamma')\rfloor}=1$, we have the following $ \frac{1}{4\sqrt{2}}\leq \alpha=\frac{\gamma_{0}^{i}}{4\gamma_{1}^{i}} \leq \frac{1}{4}.$ Furthermore, we argued previously that it suffices to consider the case that $\frac{9600\tilde{c}^2 \min(c,1)d}{32} \func{\left(  \frac{32 m }{\min(c,1)d} \right)}/{m}<1.$ Now if $ \gamma=1 $ we get that 
    \begin{align*}
      \frac{4cd\Ln^{2}(\Ln{ ( \frac{8\alpha m \gamma^{2}}{cd}) }) }{\alpha^{2}m}\leq \frac{128cd\Ln^{2}(\Ln{ ( \frac{2 m}{cd}) }) }{m} \leq \frac{9600\tilde{c}^2 \min(c,1)d}{32m} \func{\left(  \frac{32 m }{\min(c,1)d} \right)} <1=\gamma^{2}
    \end{align*}
    where the first inequality uses that $ \frac{1}{4\sqrt{2}}\leq \alpha \leq \frac{1}{4},$ and the second inequality that $ c\leq \tilde{c}=\max(c',1/c),$ where $ c'\geq c $  and $ 9600/32 \geq128$ and the last inequality the case $ \gamma=1 $  we consider. 
    
    Now if $ \gamma=2\gamma_{1}^{i} $ we get  
    \begin{align*}
        \frac{4cd\Ln^{2}(\Ln{ ( \frac{8\alpha m \gamma^{2}}{cd}) }) }{\alpha^{2}m}\leq \frac{128cd\Ln^{2}(\Ln{ ( \frac{8 m(\gamma_{1}^{i})^{2}}{cd}) }) }{m} 
        &\leq \frac{9600\tilde{c}^2 \min(c,1)d}{32m} \func{\left(  \frac{32 m (\gamma_{1}^{i})^{2}}{\min(c,1)d} \right)}
        \\ &\leq(\gamma_{1}^{i})^2\leq \gamma^{2}
    \end{align*}
    where the first inequality uses that $ \frac{1}{4\sqrt{2}}\leq \alpha \leq \frac{1}{4},$ and the second inequality that $ c\leq \tilde{c}=\max(c',1/c),$ where $ c'\geq c,$ that $ \gamma=2\gamma_{1}^{i} $   and $ 9600/32 \geq128$ where the second to last inequality follows from \cref{eq:finalbound-3} and $ 1\geq\gamma_{1}^{i}\geq\gamma_{0}^{i}\geq\gamma'$ and the last inequality by $ \gamma=2\gamma_{1}^{i} $, whereby we have argued that $ \gamma^{2}\geq \frac{4cd\Ln^{2}(\Ln{ ( \frac{8\alpha m \gamma^{2}}{cd}) }) }{\alpha^{2}m}$, and since $ 0<\gamma\leq1 $ and $ 0<\alpha< 1/2 $ we get by invoking  \cref{cor:coverfinal} that  
    \begin{align*}
        \cN_{\infty}(X,\dlh_{\left\lceil2\gamma_{1}^{i}\right\rceil},\frac{\gamma_{0}^{i}}{2})
        \leq
        \cN_{\infty}(X,\dlh_{\left\lceil\gamma\right\rceil},\alpha \gamma)   
        &\leq 
        \exp{\left(\frac{c'd}{\alpha^{2}\gamma^{2}}\func\left( \frac{8\alpha m \gamma^{2}}{cd}\right) \right)}  
        \\
        &\leq 
        \exp{\left(\frac{16 c'd}{ (\gamma_{0}^{i})^{2}} \func\negmedspace{\left(  \frac{16 m(\gamma_{0}^{i})^{2}}{cd} \right)}\negmedspace \right)}  
        \leq N_{i} ,
    \end{align*}
     where the first inequality follows from \cref{eq:finalbound-4}, the second inequality by \cref{cor:coverfinal}, the third inequality by  using on the term outside of
     $\func(\cdot)$ that $ \frac{1}{\alpha^{2}\gamma^{2}} =\frac{16(\gamma_{1}^{i})^{2}}{(\gamma_{0}^{i})^{2}\min(4(\gamma_{1}^{i})^{2},1)}\leq
    16/(\gamma_{0}^{i})^{2} $  and using on the term inside of
    $\func(\cdot)$
    that  $ \gamma_{1}^{i}\leq \sqrt{2}(\gamma_{0}^{i})^{2} $ to upper bound
    $ \alpha
    \gamma^{2}=\frac{\gamma_{0}^{i}}{4\gamma_{1}^{i}}(\min(2\gamma_{1}^{i},1))^{2}\leq
    \sqrt{2}(\gamma_{0}^{i})^{2}$.   
    Thus, by using that we concluded that $  \cN_{\infty}(X,\dlh_{\left\lceil2\gamma_{1}^{i}\right\rceil},\frac{\gamma_{0}^{i}}{2})
    \leq N_{i} $ and that $ (\lfloor\frac{m}{\ln{(N_{i} )}}\rfloor+1)\leq   \frac{2m}{\ln{(N_{i} )}}$, and $  \delta_{i}= \frac{\delta}{1640N_{i}^{2}} \frac{d}{m(\gamma_{0}^{i})^{2}},$ we get by plugging into the last expression of \cref{eq:finalbound-1}, that 
    \begin{align}\label{eq:finalbound0}
        &\left(\left\lfloor\frac{m}{\ln{\left(N_{i} \right)}}\right\rfloor+1\right) \delta_{i}  \sup_{X\in \cX^{2m}}  \cN_{\infty}(X,\dlh_{\left\lceil2\gamma_{1}^{i}\right\rceil},\frac{\gamma_{0}^{i}}{2}) 
        \leq
        \frac{m}{\ln{\left(N_{i} \right)}}
         \frac{\delta }{820N_{i}}\frac{d}{m(\gamma_{0}^{i})^{2}}.
    \end{align}
     Furthermore, we notice that  by $N_{i} =\exp{\left(\frac{72 c'd}{ (\gamma_{0}^{i})^{2}} \func{\left(  \frac{16m(\gamma_{0}^{i})^{2}}{cd} \right)} \right)},$  we have that
    \begin{align}\label{eq:finalbound1}
        \frac{m}{\ln{\left(N_{i} \right)}} \leq 
     \frac{
        m (\gamma_{0}^{i})^{2} 
        }{
        {72c'd } 
        \func{\left(  \frac{16m(\gamma_{0}^{i})^{2}}{cd} \right)} }
     \leq \frac{m(\gamma_{0}^{i})^{2}}{d},
    \end{align} 
    where the last inequality follows by $ c'\geq 1$ and $ \func{(  \frac{16m(\gamma_{0}^{i})^{2}}{cd} )} \geq1 $. Now, combining \cref{eq:finalbound-1}, \cref{eq:finalbound0} and \cref{eq:finalbound1} we get that 
    \begin{align*}
        &\p_{\rS\sim\cD^{m}}\Big[\exists j\in J_{i},
        \exists \gamma \in \left[\gamma_{0}^{i},\gamma_{1}^{i}\right]
        ,\exists f\in \dlh: 
        \ls_{\rS}^{\gamma}(f)\in [\tau_{0}^{i,j},\tau_{1}^{i,j}] 
        ,\ls_{\cD}(f) \geq \tau_{1}^{i,j} 
        + \beta_{i,j}
        \Big] 
        \\
        &\leq \frac{\delta}{820N_{i}}=\frac{\delta}{820}\exp{\left(-\frac{72 c'd}{ (\gamma_{0}^{i})^{2}} \func{\left(  \frac{16 m(\gamma_{0}^{i})^{2}}{cd} \right)} \right)}.
        % \\
        % \leq \frac{m(\gamma_{0}^{i})^{2}}{d}\frac{1}{\gamma_{0}^{i}} \frac{\left(\gamma_{0}^{i}\right)^{2}}{d}\frac{\delta}{eN_{i}}\frac{d}{m\left(\gamma_{0}^{i}\right)^{2}}
        % \\\leq  \frac{\delta}{eN_{i}}
        % \\=\frac{\delta}{e}\exp{\left(-\frac{72 c'd}{ (\gamma_{0}^{i})^{2}} \func{\left(  \frac{16 m(\gamma_{0}^{i})^{2}}{cd} \right)} \right)}. 
    \end{align*}
    We showed the above for any $ i \in I=\{   0,\ldots,\lfloor\log_{2}(  1/\gamma')\rfloor \}$; thus, by an application of the union bound, and $\gamma_{0}^{i}= \sqrt{2^{i}\gamma' },$   we conclude that: 
    \begin{align*}
        &\p_{\rS\sim\cD^{m}}\Big[\exists i\in I, \exists j\in J_{i},
        \exists \gamma \in \left[\gamma_{0}^{i},\gamma_{1}^{i}\right]
        ,\exists f\in \dlh: 
        \ls_{\rS}^{\gamma}(f)\in [\tau_{0}^{i,j},\tau_{1}^{i,j}] 
        ,\ls_{\cD}(f) \geq \tau_{1}^{i,j} 
        + \beta_{i,j}
        \Big]\\
        &\leq
         \sum_{i=0}^{\lfloor\log_{2}(  1/\gamma')\rfloor}   \frac{\delta}{820}\exp{\left(-\frac{72 c'd}{ (\gamma_{0}^{i})^{2}} \func{\left(  \frac{16 m(\gamma_{0}^{i})^{2}}{cd} \right)} \right)}
         \leq\frac{\delta}{820} 
         \sum_{i=0}^{\lfloor\log_{2}(  1/\gamma')\rfloor}
          \exp{\left(-\frac{72c'd}{2^{i}\gamma'} \right)} 
          \\
         &\leq
         \frac{\delta}{820} \sum_{i=0}^{\lfloor\log_{2}(  1/\gamma')\rfloor}
         \exp{\left(-\frac{72c'd}{2^{\lfloor\log_{2}(  1/\gamma')\rfloor-i}\gamma'} \right)} 
          \leq
         \frac{\delta}{820} \sum_{i=0}^{\lfloor\log_{2}(  1/\gamma')\rfloor}
         \exp{\left(-\frac{72c'd2^{i}}{2^{\log_{2}(  1/\gamma' )}\gamma'} \right)}
         \\
         &\leq
        \frac{\delta}{820} \sum_{i=0}^{\lfloor\log_{2}(  1/\gamma')\rfloor}
        \exp{\left(-72c'd 2^{i} \right)}
           \leq \frac{\delta}{820},
    \end{align*}
    where the first inequality first inequality follows from the union bound, the second inequality by $ \func{\left(  \frac{16 m(\gamma_{0}^{i})^{2}}{cd} \right)} \geq 1,$  the third inequality by summing in the reverse order, the fourth inequality by $ 2^{\lfloor\log_{2}(  1/\gamma')\rfloor}\leq2^{\log_{2}(  1/\gamma')},$ so  $ -1/2^{\lfloor\log_{2}(  1/\gamma')\rfloor}\leq-1/2^{\log_{2}(  1/\gamma')},$ and the last inequality by the sum being less than 1.
    Thus, we conclude that with probability at least $ 1-\delta$, we have that for all $ i\in I$, for  all $j\in J_{i}$,  for all
    $\gamma \in \left[\gamma_{0}^{i},\gamma_{1}^{i}\right]$,  for all
    $f\in \dlh$, that either 
    \begin{align*}
        \ls_{\rS}^{\gamma}(f)\not\in [\tau_{0}^{i,j},\tau_{1}^{i,j}] 
    \end{align*}
    or
    \begin{align*}
        \ls_{\cD}(f) <\tau_{1}^{i,j} 
        + \beta_{i,j}= \tau_{1}^{i,j} 
        + \cc\left(\sqrt{\frac{\tau_{1}^{i,j}\cdot 2 \ln{\left(\frac{e}{\delta_{i}} \right)}}{m}} 
        +\frac{2\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}\right),
    \end{align*}
    where the last equality uses that $ \beta_{i,j}=\cc\Big(\sqrt{\frac{\tau_{1}^{i,j}\cdot 2 \ln{\left(\frac{e}{\delta_{i}} \right)}}{m}} 
    +\frac{2\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}\Big). $ 
    Furthermore, since $ \cup_{i\in I} [\gamma_{0}^{i},\gamma_{1}^{i}]=[\gamma_{0}^{0},\gamma_{1}^{\lfloor\log_{2}(  1/\gamma')\rfloor}]=[\gamma',1] $ and  for each $ i\in I $,  $ \cup_{j\in J_{i}} [\tau_{0}^{i,j},\tau_{1}^{i,j}]$ contains the interval $ [0,1] $ and $ \ls_{\rS}^{\gamma}(f)\in [0,1] $, the above implies that with probability at least  $ 1-\delta$ over $ \rS, $  for any $ \gamma\in [\gamma',1] $ and for any
    $f\in \dlh$   there exists $ i\in I$, such that
    $\gamma \in \left[\gamma_{0}^{i},\gamma_{1}^{i}\right]$, and $j\in J_{i}$ such that $\ls_{\rS}^{\gamma}(f)\in [\tau_{0}^{i,j},\tau_{1}^{i,j}] $, and
    it holds that
    \begin{align}\label{eq:finalbound8}
        \ls_{\cD}(f) < \tau_{1}^{i,j} 
        + \cc\left(\sqrt{\frac{\tau_{1}^{i,j}\cdot 2 \ln{\left(\frac{e}{\delta_{i}} \right)}}{m}} 
        +\frac{2\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}\right).
    \end{align}
    % Moreover, we concluded earlier that for $ \gamma\in \Big(0,\sqrt{\frac{9600c'^2d}{m} }\Big]=(0,\gamma_{0}^{0}] $ and all $ f\in \dlh $ with probability $ 1 $, we have that  
    % \begin{align}\label{eq:finalbound3}
    %     \ls_{\cD}(f)
    %     \leq
    %     \ls_{\rS}^{\gamma}(f)
    %     + \cc\Bigg(\sqrt{\frac{\ls_{\rS}^{\gamma}(f)\cdot 2 \left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{9600c'^2 d}{\gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{6\min(c,1)d} \right)} \right)}{m}}
    %     \\
    %     +\frac{5\left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{9600c'^2 d}{\gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{6\min(c,1)d} \right)}\right)}{m}\Bigg).\nonumber
    %   \end{align} 
    %   Thus, we conclude that with probability at least $ 1-\delta,$  for any $ 0<\gamma\leq 1 $ and $ f\in \dlh,$ we have either there exists $  i\in I$,  $j\in J_{i}$, such that $ \gamma\in [\gamma_{0}^{i},\gamma_{1}^{i}] $  and $ \ls_{\rS}^{\gamma}(f)\in [\tau_{0}^{i,j},\tau_{1}^{i,j}], $ and that  
    %   \begin{align}\label{eq:finalbound4}
    %     \ls_{\cD}(f) < \tau_{1}^{i,j} 
    %     + \cc\left(\sqrt{\frac{\tau_{1}^{i,j}\cdot 2 \ln{\left(\frac{e}{\delta_{i}} \right)}}{m}} 
    %     +\frac{2\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}\right) ,
    %   \end{align}
    %   or else $ 0<\gamma\leq\sqrt{\frac{9600c'^2d}{m} }$, whereby \cref{eq:finalbound3} implies that 
    %   \begin{align}\label{eq:finalbound7}
    %     \ls_{\cD}(f)
    %     \leq
    %     \ls_{\rS}^{\gamma}(f)
    %     + \cc\Bigg(\sqrt{\frac{\ls_{\rS}^{\gamma}(f)\cdot 2 \left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{9600c'^2 d}{\gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{6\min(c,1)d} \right)} \right)}{m}}
    %     \\
    %     +\frac{5\left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{9600c'^2 d}{\gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{6\min(c,1)d} \right)}\right)}{m}\Bigg).\nonumber
    %   \end{align}
      Now in the case of $\gamma \in \left[\gamma_{0}^{i},\gamma_{1}^{i}\right]$, $\ls_{\rS}^{\gamma}(f)\in [\tau_{0}^{i,j},\tau_{1}^{i,j}] $ and \cref{eq:finalbound8} holding, we get, by the definition of $ \tau_{0}^{i,j} =j\frac{\ln{\left(N_{i} \right)}}{m}$ and $ \tau_{1}^{i,j} =(j+1)\frac{\ln{\left(N_{i} \right)}}{m}$, $ \ln{\left(N_{i} \right)} \leq \ln{\left(\frac{e}{\delta_{i}} \right)}$ and $\sqrt{a+b}\leq \sqrt{a}+\sqrt{b},$ that 
      \begin{align}\label{eq:finalbound5}
        \ls_{\cD}(f)\leq 
        \tau_{1}^{i,j} 
        + \cc\left(\sqrt{\frac{\tau_{1}^{i,j}\cdot 2 \ln{\left(\frac{e}{\delta_{i}} \right)}}{m}} 
        +\frac{2\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}\right)
        \\
        \leq 
        \tau_{0}^{i,j} +\frac{\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}
        + \cc\left(\sqrt{\frac{\tau_{0}^{i,j}\cdot 2 \ln{\left(\frac{e}{\delta_{i}} \right)}}{m}}+ \sqrt{2}\frac{\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}
        +\frac{2\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}\right) \nonumber
        \\
        \leq \ls_{\rS}^{\gamma}(f)
        + \cc\left(\sqrt{\frac{\ls_{\rS}^{\gamma}(f)\cdot 2 \ln{\left(\frac{e}{\delta_{i}} \right)}}{m}}
        +\frac{5\ln{\left(\frac{e}{\delta_{i}} \right)}}{m}\right).\nonumber
      \end{align}
      Furthermore, we have that $ N_{i}= \exp{\left(\frac{72 c'd}{ (\gamma_{0}^{i})^{2}} \func{\left(  \frac{16m(\gamma_{0}^{i})^{2}}{cd} \right)} \right)}  $, $ \delta_{i}= \frac{\delta}{1640N_{i}^{2}} \frac{d}{m(\gamma_{0}^{i})^{2}}$, and by $ \gamma\in \left[\gamma_{0}^{i},\gamma_{1}^{i}\right]$, with $ \gamma_{1}^{i}\leq \sqrt{2}\gamma_{0}^{i} $, it implies that $ \gamma \leq \sqrt{2}\gamma_{0}^{i}$,
      which combined gives that $ \ln{\left(e/\delta_{i} \right)} $  can be bounded by 
      \begin{align}\label{eq:finalbound6}
       \ln{\left(\frac{e}{\delta_{i}} \right)}= \ln{\left(\frac{1640e}{\delta} \right)}+2\ln{\left( N_{i}\right)}+\ln{\left(\frac{m(\gamma_{0}^{i})^{2}}{d} \right)}
       \\
       \leq \ln{\left(\frac{1640e}{\delta} \right)}+\frac{144c'd}{ (\gamma_{0}^{i})^{2}} \func{\left(  \frac{16 m(\gamma_{0}^{i})^{2}}{cd} \right)} +\ln{\left(\frac{m\gamma^{2}}{d} \right)} \tag{by $ \gamma\geq \gamma_{0}^{i} $  }
        \\
        \leq \ln{\left(\frac{1640e}{\delta} \right)}+\frac{288c'd}{ \gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{\min(c,1)d} \right)} +\Ln{\left(\frac{m\gamma^{2} }{d} \right)} \tag{by $ \gamma \leq \sqrt{2}\gamma_{0}^{i}$ and $ \gamma_{0}^{i}\leq \gamma $ }.
      \end{align}
      We notice that since $ \ln{\left(x \right)}/x $ has derivative $ \frac{1-\ln{\left(x \right)}}{x^2}=\frac{\ln{\left(e/x \right)}}{x^{2}} $ which is less than $ 0 $  for $ x\geq e $, we have that $\Ln{\left(x \right)}/x   $ is decreasing for $ x\geq e $ and since $ \frac{1}{x} $ is decreasing for $ 0<x<e $ we conclude that $ \Ln\left(x\right)/x $ is decreasing for $ x>0$. Thus, we conclude that
      \begin{align*}
        \frac{\Ln{\left(\frac{m\gamma^{2}}{d} \right)}}{m}  \leq  \frac{d\Ln{\left(\frac{m\gamma^{2}}{d} \right)}}{m\gamma^{2}}\leq \frac{d\Ln(\frac{m\gamma^{2} }{d})}{m\gamma^{2}}\leq \frac{d\func{\left(  \frac{16 m\gamma^{2} }{\min(c,1)d} \right)} }{m\gamma^{2}}.
      \end{align*}  
      Now, using this with \cref{eq:finalbound5} and \cref{eq:finalbound6}, we conclude that 
      \begin{align*}
        \ls_{\cD}(f) 
        \leq \ls_{\rS}^{\gamma}(f)
        + \cc\Bigg(\sqrt{\frac{\ls_{\rS}^{\gamma}(f)\cdot 2 \left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{288c'd}{ \gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{\min(c,1)d} \right)} +\Ln{\left(\frac{m\gamma^{2}}{d} \right)} \right)}{m}}
        \\
        +\frac{5\left( \ln{\left(\frac{1640e}{\delta} \right)}+\frac{288c'd}{ \gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{\min(c,1)d} \right)} +\Ln{\left(\frac{m\gamma^{2}}{d} \right)}\right)}{m}\Bigg)
        \\
        \leq
        \ls_{\rS}^{\gamma}(f)
        + \cc\Bigg(\sqrt{\frac{\ls_{\rS}^{\gamma}(f)\cdot 2 \left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{289c'd}{ \gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{\min(c,1)d} \right)} \right)}{m}}
        \\
        +\frac{5\left( \ln{\left(\frac{1640e}{\delta} \right)}+\frac{289c'd}{ \gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{\min(c,1)d} \right)} \right)}{m}\Bigg).
      \end{align*}
      Thus we conclude that with probability at least $ 1-\delta $ over $ \rS $ it holds for any $ \gamma\in[\gamma',1] $ and any $ f\in \dlh $ that 
      \begin{align}\label{eq:finalbound9}
        \ls_{\cD}(f) 
        \leq
        \ls_{\rS}^{\gamma}(f)
        + \cc\Bigg(\sqrt{\frac{\ls_{\rS}^{\gamma}(f)\cdot 2 \left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{289c'd}{ \gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{\min(c,1)d} \right)} \right)}{m}}
        \\
        +\frac{5\left( \ln{\left(\frac{1640e}{\delta} \right)}+\frac{289c'd}{ \gamma^{2}} \func{\left(  \frac{16 m\gamma^{2} }{\min(c,1)d} \right)} \right)}{m}\Bigg),
      \end{align}
      and since we start by concluding that with probability $ 1 $ over $ \rS $ for any  $ \gamma\in[0,\gamma']$ and any $ f\in\dlh $ \cref{eq:finalbound-2} holds, i.e. 
      \begin{align}\label{eq:finalbound10}
        \ls_{\cD}(f)
        \leq
        \ls_{\rS}^{\gamma}(f)
        + \cc\Big(\sqrt{\frac{\ls_{\rS}^{\gamma}(f)\cdot 2 \left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{9600\tilde{c}^2 \min(c,1)d}{32\gamma^{2}} \func{\left(  \frac{32 m\gamma^{2} }{\min(c,1)d} \right)} \right)}{m}}
        \\
        +\frac{5\left(\ln{\left(\frac{1640e}{\delta} \right)}+\frac{9600\tilde{c}^2 \min(c,1)d}{32\gamma^{2}} \func{\left(  \frac{32 m\gamma^{2} }{\min(c,1)d} \right)}\right)}{m}\Big)\nonumber
    \end{align}
    and the right hand side of the \cref{eq:finalbound10} being larger than \cref{eq:finalbound9} (we recall that $ \tilde{c}=\max(c',1/c) $ ), this implies that \cref{eq:finalbound10} holds with probability at least $ 1-\delta $ over $ \rS $ for any $ 0<\gamma\leq 1 $ and $f\in \dlh $, which concludes the proof of \cref{thm:finalmarginbound}. 
\end{proof}
