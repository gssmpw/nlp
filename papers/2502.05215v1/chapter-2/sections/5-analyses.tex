
\section{Analyses}\label{chap2/sec:analyses}

We provide insights on the method for IVF-PQ, considering the effects of quantization and space partitioning.
For an image $I$ whose representation is $x=f(I)\in\R^d$, 
$\hat{x}$ denotes the representation of a transformed version: $\hat{x} = f(t(I))\in\R^d$, and $x^\acti$ the representation of the activated image $I^\acti$.
For details on the images and the implementation used in the experimental validations, see Sec. \ref{chap2/sec:experimental}.

\begin{figure}[b!]
   \begin{minipage}{0.45\textwidth}
        \centering
        \vspace{3pt}
        \includegraphics[width=1.05\linewidth, trim={0 0.8em 0 0em},clip]{chapter-2/figs/exp/prc.pdf}
        \caption{Precision-Recall curve for ICD with 50k queries and 1M reference images (more details for the experimental setup in Sec. \ref{chap2/sec:experimental}). $p_\mathrm{f}^{\mathrm{ivf}}$ is the probability of failure of the IVF (Sec. \ref{chap2/sec:space_partitioning}).
        }
        \label{chap2/fig:prc}
   \end{minipage}\hfill
      \begin{minipage}{0.51\textwidth}
        \centering
        \includegraphics[width=0.8\textwidth, trim={0 0.15cm 0 0.23cm}, clip]{chapter-2/figs/exp/distances.pdf}
        \caption{
            Distance estimates histograms (sec. \ref{chap2/sec:quantization}).
            With active indexing, $\|x- q(x)\|^2$ is reduced ({\color{blue}$\leftarrow$}), inducing a shift ({\color{orange}$\leftarrow$}) in the distribution of $\|\hat{x}- q(x)\|^2$, where $t(I)$ a hue-shifted version of $I$.
            $y$ is a random query.
        }
        \label{chap2/fig:dists}
   \end{minipage}
\end{figure}


\subsection{Product quantization: impact on distance estimate}\label{chap2/sec:quantization}

We start by analyzing the distance estimate considered by the index:
\begin{equation}
    \|\hat{x}-q(x)\|^2 = \|x-q(x)\|^2 + \|\hat{x}-x\|^2
    + 2 (x-q(x))^\top (\hat{x}-x).
    \label{eq:distance}
\end{equation}
The activation aims to reduce the first term, \ie, the quantization error $\|x- q(x)\|^2$, which in turn reduces $\|\hat{x}- q(x)\|^2$. 
Figure~\ref{chap2/fig:dists} shows in blue the empirical distributions of $\|x- q(x)\|^2$ (passive) and $\|x^\acti- q(x)\|^2$ (activated). 
As expected the latter has a lower mean, but also a stronger variance.
The variation of the following factors may explain this: \emph{i)} the strength of the perturbation (due to the HVS modeled by $H_{\mathrm{JND}}$ in~\eqref{eq:scaling}), \emph{ii)} the sensitivity of the feature extractor $\|\nabla_x f(x)\|$ (some features are easier to push than others), \emph{iii)} the shapes and sizes of the Vorono√Ø cells of PQ.

The second term of \eqref{eq:distance} models the impact of the image transformation in the feature space. 
Comparing the orange and blue distributions in Fig.~\ref{chap2/fig:dists}, we see that it has a positive mean, but the shift is bigger for activated images.
We can assume that the third term has null expectation for two reasons: \emph{i)} the noise $\hat{x}-x$ is independent of $q(x)$ and centered around 0, \emph{ii)} in the high definition regime, quantification noise $x-q(x)$ is independent of $x$ and centered on 0. 
Thus, this term only increases the variance. 
Since $x^\acti-q(x)$ has smaller norm, this increase is smaller for activated images.

All in all, $\|\hat{x}^\acti-q(x)\|^2$ has a lower mean but a stronger variance than its passive counterpart $\|\hat{x}-q(x)\|^2$.
Nevertheless, the decrease of the mean is so large that it compensates the larger variance. 
The orange distribution in active indexing is further away from the green distribution for negative pairs, \ie, the distance between an indexed vector $q(x)$ and an independent query $y$.


\subsection[Space partitioning: impact on the IVF probability of failure]{Space partitioning: impact on the IVF \\probability of failure}\label{chap2/sec:space_partitioning}

We denote by $p_\mathrm{f} := \mathbb{P}(\qivf(x) \neq \qivf (\hat{x}) )$ the probability that $\hat{x}$ is assigned to a wrong bucket by IVF assignment $\qivf$.
In the single-probe search ($k'=1$), the recall (probability that a pair is detected when it is a true match, for a given threshold $\tau$ on the distance) is upper-bounded by $1 - p_\mathrm{f}$:
\begin{align}
   R_\tau 
   = \mathbb{P} \left(\{ \qivf(\hat{x}) = \qivf(x) \} \cap \{ \| \hat{x}-q(x)\| < \tau \} \right) 
   \leq \mathbb{P} \left(\{ \qivf(\hat{x}) = \qivf(x) \}  \right) 
   =1 - p_\mathrm{f}.
\end{align}
In other terms, even with a high threshold $\tau \rightarrow \infty$ (and low precision), the detection misses representations that ought to be matched, with probability $p_\mathrm{f}$. It explains the sharp drop at recall $R=0.13$ in Fig.~\ref{chap2/fig:prc}.
This is why it is crucial to decrease $p_\mathrm{f}$.
The effect of active indexing is to reduce $\|\hat{x}-\qivf(x)\|$
therefore reducing $p_\mathrm{f}$ and increasing the upper-bound for $R$:
the drop shifts towards $R=0.32$. 

This explanation suggests that pushing $x$ towards $\qivf(x)$ decreases even more efficiently $p_\mathrm{f}$. 
This makes the IVF more robust to transformation but this may jeopardize the PQ search because features of activated images are packed altogether.
In a way, our strategy, which pushes $x$ towards $q(x)$, dispatches the improvement over the IVF and the PQ search.





