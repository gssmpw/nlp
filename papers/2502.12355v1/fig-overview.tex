\begin{tikzpicture}

\definecolor{red}{RGB}{181, 23, 0}
\definecolor{blue}{RGB}{0, 118, 186}
\definecolor{gray}{RGB}{146, 146, 146}
\definecolor{green}{RGB}{56, 142, 60}

\tikzset{
  pics/pics-multi-bg/.style n args={1}{
    code={
      \node[
        inner sep=0,
        fill=black!2,
      ] (#1) {};

      \node[
        fit=(#1),
        inner sep=0,
        pattern=north east lines, pattern color=black!15,
      ] {};
    }
  }
}

\tikzset{
  style-pi/.style={
    draw,
    fill=yellow!10,
    rounded corners,
    minimum width=10mm,
    minimum height=8mm,
  },
  style-fit/.style={
    draw,
    dashed,
    inner sep=3mm,
  },
  style-traj-elem/.style={
    minimum width=0,
    inner sep=0
  },
  style-gentraj/.style={
    ->,
    % >=stealth',
    decorate, decoration={
      snake,
      segment length=3mm,
      amplitude=1pt,
      post length=1pt,
    },
  }
}

\def\spacing{4mm}

\footnotesize

%
% Expert models
%
\node[style-pi] (pi-expert-0) {$\pi_{\color{red}e_0}$};
\node[below=3mm of pi-expert-0, style-pi] (pi-expert-1) {$\pi_{\color{red}e_1}$};
\node[below=6mm of pi-expert-1, style-pi] (pi-expert-n) {$\pi_{\color{red}e_n}$};
\node[] at ($(pi-expert-1)!0.5!(pi-expert-n)$) {\rotatebox{90}{$\cdots$}};
\node[fit=(pi-expert-0)(pi-expert-n)] (bg-pi-expert) {};

%
% Trajectories
%
\draw pic[
  right=10mm of bg-pi-expert,
  minimum width=19mm,
  minimum height=24mm,
] {pics-multi-bg={bg-trajs}};

\node[
  below=4mm of bg-trajs.north west,
  anchor=north west,
  matrix,
  minimum width=19mm,
  draw,
  fill=black!2,
] {
  \scriptsize
  \node[style-traj-elem] (s0-traj) {$\mathbf{s}_0$,};
  \node[right=0mm of s0-traj, style-traj-elem] (a0-traj) {$\mathbf{a}_0$,};
  \node[right=0mm of a0-traj, style-traj-elem] (s1-traj) {$\mathbf{s}_1$};
  \node[right=-1pt of s1-traj, style-traj-elem] (dots-traj) {...};
  \node[right=0mm of dots-traj, style-traj-elem] (ad-traj) {$\mathbf{a}_d$};
  % \node[right=0mm of ad-traj, style-traj-elem] (sdplus1-traj) {$s_{d + 1}$};
  % \node[right=0mm of sdplus1-traj, style-traj-elem] (adplus1-traj) {$a_{d + 1}$};
  \node[right=-1pt of ad-traj, style-traj-elem] {...};
  \\
};

%
% Expert -> Trajectories
%
\draw[style-gentraj] (pi-expert-0.east) -- ($(pi-expert-0.east -| bg-trajs.west) - (0, 5mm)$);
\draw[style-gentraj] (pi-expert-1.east) -- ($(pi-expert-1.east -| bg-trajs.west) - (0, 5mm)$);
\draw[style-gentraj] (pi-expert-n.east) -- ($(pi-expert-n.east -| bg-trajs.west) + (0, 5mm)$);

%
% State-action pairs
%
\draw pic[
  right=\spacing of bg-trajs,
  minimum width=15mm,
  minimum height=36mm,
] {pics-multi-bg={bg-pairs}};
\node[
  below=0mm of bg-pairs.north west,
  anchor=north west,
  fill=black!2,
  draw,
  minimum width=15mm,
  inner sep=2pt,
] (pair-0) {\scriptsize $(\mathbf{s}_{\color{red}0}, \mathbf{a}_{\color{red}d})$};
\node[
  below=5mm of pair-0,
  fill=black!2,
  draw,
  minimum width=15mm,
  inner sep=2pt,
] (pair-1) {\scriptsize $(\mathbf{s}_{\color{red}t}, \mathbf{a}_{\color{red}t + d})$};

%
% Trajectories -> state-action pairs
%
\draw[->] (s0-traj.north) to[out=60,in=190] (pair-0.west);
\draw[->] (ad-traj.north) to[out=80,in=190] (pair-0.west);

%
% BC
%
\node[
  right=11mm of bg-pairs,
  style-pi
] (pi-bc) {$\pi_{\theta}$};

%
% Pairs -> BC
%
\draw[->] (bg-pairs) -- node[fill=blue!7] {BC} (pi-bc);

%
% PPO
%
\node[
  right=11mm of pi-bc,
  style-pi
] (pi-ppo) {$\pi_{\theta'}$};

%
% BC -> PPO
%
\draw[->] (pi-bc) -- node[fill=blue!7] (ppo) {PPO} (pi-ppo);
\node[
  below=8mm of ppo,
  inner sep=0,
] (reward) {$r_{\color{red}k_p, k_e, \dotsc}$};
\draw[->] (reward) -- (ppo);

%
% Real world
%
\tikzset{
  style-realworld/.style={
    draw,
    fill=green!4,
    rounded corners,
  },
}

\node[
  right=\spacing of pi-ppo,
  style-realworld,
  minimum width=15mm,
  minimum height=18mm,
] (simulink) {};
\node[
  anchor=north west,
] at (simulink.north west) {Simulink};
\node[
  above left=1mm and 1mm of simulink.south east,
  anchor=south east,
  draw,
  dotted,
  rounded corners,
  fill=yellow!10,
  minimum width=7mm,
  minimum height=5.6mm,
] (simulink-pi) {};

\node[
  right=4mm of simulink,
  style-realworld,
  minimum width=15mm,
  minimum height=18mm,
] (sensor) {};
\node[
  anchor=north west,
] at (sensor.north west) {Vicon};

\node[
  minimum width=8mm,
  minimum height=5mm,
  draw,
  rounded corners,
  fill=green!10,
] at (sensor.center) (robot) {Robot};

\draw[->] (simulink) -- node[above, opacity=0] (anchor-a-y) {$a$} (robot);
\draw[->, rounded corners] (sensor.north) -- ($(sensor.north |- simulink.north) + (0, 3mm)$) -- node[above] {$\mathbf{s}$} ($(simulink.north) + (0, 3mm)$) -- (simulink.north);
\coordinate (anchor-a-x) at ($(simulink.east)!0.5!(sensor.west)$);
\node[] at (anchor-a-y -| anchor-a-x) {$\mathbf{a}$};

%
% PPO -> Simulink
%
\draw[->, rounded corners] (pi-ppo.east) -- (pi-ppo.east -| simulink-pi.north) -- (simulink-pi.north);

%
% Boundary
%
\tikzset{
  style-boundary/.style={
    dashed
  }
}

\node[fit=(pi-expert-0)(pi-expert-n)(bg-pairs)(sensor), inner ysep=2mm] (top-level) {};
\coordinate (y-top) at (top-level.north);
\coordinate (y-bot) at (top-level.south);
\coordinate (y-top-expert) at (y-top -| bg-trajs.center);
\coordinate (y-top-bc) at (y-top -| pi-bc.center);
\coordinate (y-top-ppo) at (y-top -| pi-ppo.center);
\begin{scope}[on background layer]
\draw[style-boundary] (y-top-expert) -- (y-bot -| bg-trajs.center);
\draw[style-boundary] (y-top-bc) -- (y-bot -| pi-bc.center);
\draw[style-boundary] (y-top-ppo) -- (y-bot -| pi-ppo.center);
\end{scope}
\node[
  text width=33mm, align=center,
  inner sep=0,
] at ($(top-level.north west)!0.5!(y-top-expert) + (0, 2mm)$) {\bf Domain-Randomized Expert Demonstration};
\node[
  text width=60mm, align=center
] at ($(y-top-expert)!0.5!(y-top-bc) + (0, 2mm)$) {\bf BC with \\State-Action Re-Matching};
\node[
  text width=20mm, align=center
] at ($(y-top-bc)!0.5!(y-top-ppo) + (0, 2mm)$) {\bf PPO \\ Fine-Tuning};
\node[
  text width=36mm, align=center
] at ($(y-top-ppo)!0.5!(top-level.north east) + (0, 2mm)$) {\bf Deployment on a Real-World\\Insect-Scale Robot};

\end{tikzpicture}
