\section{Introduction}
Detecting Out-of-Distribution (OOD) data is crucial for enhancing AI models' robustness, reliability, and safety in real-world scenarios, where input data may deviate from the training data distribution.
Many works~\citep{hendrycks2016baseline,liang2018enhancing,lee2018simple,hendrycks2018deep,liu2020energy} have been proposed for OOD detection tasks on i.i.d. data, e.g., images. 
Such an urgent need also exists in the domains that apply graph-format data, such as medical-diagnosis~\citep{kukar2003transductive} and autonomous driving~\citep{dai2018dark}. 
However, there has been a notable lack of work focusing on graph OOD node detection, i.e., detecting OOD nodes on which the model is expected to have low confidence~\citep{amodei2016concrete,liang2018enhancing}. Due to the interdependence among graph nodes, it is hard to apply the methods designed for i.i.d. inputs directly. 


\begin{wrapfigure}{R}{0.35\textwidth}
    \centering
    \includegraphics[width=0.98\linewidth]{Images/overall.png}
    \vspace{-8pt}
    \caption{AUROC across graphs. 
    }
    \vspace{-8pt}
    \label{fig:overall_auroc}
\end{wrapfigure}


Recently, GNNSafe~\citep{wu2022energy} adapted energy-based OOD detection for graph data mainly by using GNNs as the backbone, and output energy for nodes as confidence, achieving current state-of-the-art performance. 
However, it is trained by classification loss and constructs node energy by classification logits without specifically designed training for modeling data distribution, limiting the performance of identifying OOD nodes. 
Moreover, the energy propagation technique, used in GNNSafe, heavily relies on the homophily assumption, i.e., that neighbors often belong to the same class. This will lead to significant performance degradation on heterophilic graphs, where neighbors do not share a similar distribution. 
To mitigate these issues, we suggest training Energy-based Models (EBMs) to detect OOD instances via Maximum Likelihood Estimation (MLE) to obtain better energy, and removing energy propagation to address the heterophily issue. However, training EBMs via MLE requires performing Markov Chain Monte Carlo (MCMC) sampling in training, which is notorious for graphs due to the complexity of graph topology. 



In this paper, our proposed \bname (\shortname) alleviates both the heterophily issue and sampling challenges of learning EBMs for large graphs. 
The \textit{key insight} in our work is: GNNs can extract the topology information, forming latent space without interdependence. Hence, we can conduct MCMC sampling on latent space to train the energy head. 
This approach is computationally efficient, as it avoids sampling the adjacency matrix, and eliminates the need for energy propagation techniques, which could degrade performance on heterophilic graphs.
Specifically, \shortname decomposes the EBM into two components: graph encoder and energy head. 
First, the graph encoder is trained by the Graph Contrastive Learning (GCL) algorithm and classification loss for obtaining informative node representations, then the energy head, trained over latent space by MLE, outputs the energy scores of nodes, which are used as nodes' OOD scores. 
By doing so, \shortname transposes operations inherently dependent on the graph structure into the latent representation domain, thereby decoupling subsequent steps from the graph structure's dependency. 
The benefits are twofold: 
1) MCMC sampling can be efficiently conducted on low-dimensional latent space to sample node representations only, dramatically decreasing the computation cost; 
2) the Energy head does not require a propagation operation to further extract topology information, avoiding performance degradation on heterophilic graphs.


Moreover, to better unleash the effectiveness of \shortname in node OOD detection, we propose several principled training designs: a Multi-Hop Graph encoder (MH) and Energy Readout (ERo) to enhance node representation learning, Conditional Energy (CE) to improve EBM training, and Recurrent Update to effectively update the CE and ERo jointly, enabling the graph encoder and energy head promote each other. 
Furthermore, we found that existing node OOD detection methods are evaluated only on homophilic graphs, with heterophilic graphs being overlooked. We therefore conduct a comprehensive evaluation of existing methods across homophilic and heterophilic graphs. The results show that existing graph-based methods deliver even worse performance on heterophilic graphs, compared to those graph-agnostic node OOD detection methods (\cref{fig:overall_auroc}). 
Thanks to the powerful constructed \shortname, our method can achieve state-of-the-art performance on OOD detection across both homophilic and heterophilic graphs without OOD exposure. 

\input{Images/framework}


Our key contributions can be summarized as follows:
\begin{itemize}[nosep,leftmargin=20pt]
    \item Our proposed \shortname decomposes EBM into two components, a graph encoder for extracting topology information and an energy head for estimating density, which avoids the notorious challenges of sampling the adjacency matrix when training via MLE and prevents serious performance degradation on heterophilic graphs.
    \item We are the first to evaluate node OOD detection performance on both homophilic and heterophilic graphs and provide a comprehensive assessment of existing graph-based methods.
    \item We conduct extensive experiments to demonstrate the superiority of \shortname. The results show that \shortname, trained without OOD exposure, outperforms state-of-the-art methods—whether trained with or without OOD exposure—on both homophilic and heterophilic graphs. 
\end{itemize}
