% \documentclass[format=acmsmall, review=false]{acmart}
% \usepackage{acm-ec-25}
\documentclass[A4, 11pt]{article}

%% Packages sorted alphabetically
\usepackage[ruled,vlined]{algorithm2e}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsthm}
\usepackage[titletoc]{appendix}
\usepackage[english]{babel}
\usepackage{booktabs}
\usepackage{cancel}
\usepackage{caption}
\usepackage{comment}
\usepackage{diagbox}
\usepackage{dsfont}
\usepackage{enumerate}
\usepackage{eurosym}
\usepackage{float}
\usepackage{graphicx}
\usepackage[left=1in,top=1in,right=1in,bottom=1in]{geometry}
\usepackage[colorlinks=true,linkcolor=blue,citecolor=blue]{hyperref}
\usepackage{cleveref} % cleveref must go after hyperref
\usepackage{indentfirst}
\usepackage[utf8]{inputenc}\usepackage{csquotes} %Csquotes must go after inputenc
\usepackage{mathtext}
\usepackage{mathtools}
\usepackage{multicol}
\usepackage{multirow}
\usepackage{natbib}
\usepackage[short]{optidef}
\usepackage{pgfplots}
\usepackage{setspace}
\usepackage{subcaption}
\usepackage{supertabular}
\usepackage[flushleft]{threeparttable}
\usepackage{tikz,tkz-graph,tkz-berge}
\usetikzlibrary{decorations.pathreplacing}
\usetikzlibrary{arrows.meta}
\usepackage[textwidth=30mm]{todonotes}
\usepackage{xargs}
\usepackage{xcolor}
\usepackage[all]{xy}

%% Macros
\newcommand{\debug}[1]{{\color{black}#1}} % To color the macros
\newcommand{\debugbis}[1]{{\color{black}#1}} % To color the macros

\DeclareMathOperator*{\sm}{<}
\DeclareMathOperator*{\bi}{>}
\DeclareMathOperator*{\argmin}{argmin}
\DeclareMathOperator*{\argmax}{argmax}
\DeclareMathOperator{\Expect}{\debug{\mathbb{E}}}
\DeclareMathOperator{\Prob}{\debug{\mathbb{P}}}
\DeclareMathOperator{\Students}{\debug{\mathcal{S}}}
\DeclareMathOperator{\Colleges}{\debug{\mathcal{C}}}
\DeclareMathOperator{\Resources}{\debug{\mathcal{R}}}
\newcommandx{\CutoffsMatrix}{\debug{\pmb{\Theta}}}
\newcommandx{\Cutoffs}[2][1={}, 2={}]{\debug{\theta_{#1}^{\debugbis{#2}}}}
\DeclareMathOperator{\Contracts}{\debug{\mathcal{X}}}
\DeclareMathOperator{\Matchings}{\debug{\mathcal{M}}}

\renewcommand{\algorithmcfname}{ALGORITHM}
\SetAlFnt{\small}
\SetAlCapFnt{\small}
\SetAlCapNameFnt{\small}
\SetAlCapHSkip{0pt}
\IncMargin{-\parindent}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{assumption}{Assumption}
\theoremstyle{definition}{
\newtheorem{definition}[theorem]{Definition}
\newtheorem{remark}{Remark}
\newtheorem{example}{Example}}

\usepackage{pifont}% http://ctan.org/pkg/pifont
\newcommand{\xmark}{\ding{55}}%
\newcommand{\cmark}{\ding{51}}%


\let\oldnl\nl% Store \nl in \oldnl
\newcommand{\nonl}{\renewcommand{\nl}{\let\nl\oldnl}}% Remove line number for one line

\newcommand{\FG}[1]{\todo[color=red!30!gray!20,author=\textbf{Felipe},inline]{\small #1\\}}
\newcommand{\DS}[1]{\todo[color=red!100!gray!20,author=\textbf{Denis},inline]{\small #1\\}}
% Choose a citation style by commenting/uncommenting the appropriate line:
%\setcitestyle{acmnumeric}
\setcitestyle{authoryear}

% Title. Note the optional short title for running heads. In the interest of anonymization, please do not include any acknowledgements.
% \title{Two-Sided Matching with Resource-Regional Caps}
% \date{}

\begin{document}

% Title page for title and abstract only.
\begin{titlepage}

% \maketitle
\begin{center}
\huge{\textbf{Two-Sided Matching with Resource\\ Regional Caps}}
\end{center}


\begin{table}[h]
\centering
\small{\begin{tabular}[t]{ccc}
\textbf{Felipe Garrido-Lucero*} & & \textbf{Denis Sokolov*}\\
IRIT, Université Toulouse Capitole & & Inria, Fairplay joint team\\
Toulouse, France & & Palaiseau, France\\
\texttt{felipe.garrido-lucero@irit.fr} & & \texttt{denis.sokolov@inria.fr}\\
& & \\
& & \\
\textbf{Patrick Loiseau} & & \textbf{Simon Mauras}\\
Inria, Fairplay joint team  & & Inria, Fairplay joint team\\
Palaiseau, France & & Palaiseau, France\\
\texttt{patrick.loiseau@inria.fr} & & \texttt{simon.mauras@inria.fr}\\
\end{tabular}}
\end{table}

\begin{abstract}
We study two-sided many-to-one matching problems under a novel type of distributional constraints, resource-regional caps. In the context of college admissions, under resource-regional caps, an admitted student may be provided with a unit of some resource through a college, which belongs to a region possessing some amount of this resource. A student may be admitted to a college with at most one unit of any resource, i.e., all resources are close substitutes, e.g., dorms on the campus, dorms outside the campus, subsidies for renting a room, etc. The core feature of our model is that students are allowed to be admitted without any resource, which breaks heredity property of previously studied models with regions. 

It is well known that a stable matching may not exist under markets with regional constraints. Thus, we focus on three weakened versions of stability that restore existence under resource-regional caps: envy-freeness, non-wastefulness, and novel direct-envy stability. For each version of stability we design corresponding matching mechanism(s). Finally, we compare stability performances of constructed mechanisms using simulations, and conclude that more sophisticated direct-envy stable mechanism is the go-to mechanism for maximal stability of the resulting matching under resource-regional caps.
\end{abstract}

\small{\textbf{Keywords}: Matching, Direct-envy, Resource-regional Caps}

\vfill
{\small*Equal contribution}

\small{Preprint. Under review.}
\end{titlepage}

\section{Introduction}

Since the seminal work of \citet{gale62}, one of the central objectives of market design has been a problem of matching agents to institutions, e.g., students to schools or colleges \citep{abdulkadiroglu03}, doctors to hospitals \citep{roth99}, workers to employers \citep{kelso82}, etc. The basic agents-institutions matching model consists of a two-sided market, where on the one side we have agents each possessing strict preferences over institutions, while on the other side each institution has its quota (amount of seats to distribute among agents) together with its strict preferences over agents. In general, two-sided many-to-one matching models consider various types of real-life scenarios, including but not limited to affirmative action policies \citep{sonmez19}, soft and hard upper and lower quotas \citep{ehlers14}, and regional constraints \citep{kamada12}.

In this paper, we introduce a new two-sided matching problem that describes a market under resource-specific regional caps (RRC). As in the college admissions models, we treat agents as students and institutions as colleges. The distinctive feature of our model is the presence of resources that can be distributed by colleges among admitted students. All resources are close substitutes to each other, i.e., each student demands at most one resource at a time. For instance, these resources may be dorms on the campus, dorms outside the campus, subsidies for renting a room, etc. In line with matching with contracts \citep{hatfield05}, each student $s$ has strict preferences over a set of contracts and an outside option $\emptyset$, where each contract is a tuple containing this student $s$, a college $c$ (where $s$ wants to be admitted), and either a unit of some resource $r$ (that $s$ wants to get after being admitted to $c$) or nothing (denoted by $r_0$, an empty resource). In turn, each resource has a corresponding partition on the set of colleges that contains regions (subsets of colleges), where each region possesses some amount of indivisible units of this resource (resource quota), that can be distributed by colleges from this region among admitted students. A matching is called \textit{feasible} if no quotas are violated and each student is assigned to at most one college.

The closest model to ours is matching under regional caps (RC) \citep{kamada10,kamada12,kamada15}. RRC constraints become RC if, first, there is exactly one non-empty resource, and, second, any student should receive a unit of this non-empty resource upon admission. Therefore, all hardness results under RC transfers to RRC, e.g., non-existence of a stable matching \citep{kamada17}, and NP-completeness of checking the existence of a stable matching \citep{aziz24}. The key innovation of RRC is the relaxation of regional caps, i.e., now students are allowed to express their preferences for being admitted without any non-empty resource, which exempts them from any regional constraints. This feature breaks the \textit{heredity} property \citep{kamada17,goto17}, which requires the feasibility of a matching to be monotone in the number of students matched.\footnote{See \Cref{app:constraints} for more detailed discussion of heredity, and the formal proof of why RRC does not satisfy heredity.} Note that RRC model is new even for one non-empty resource. Also note that, under no non-empty resources, RRC becomes classical \citet{gale62}.

A major real-life motivation for our model is college admissions with common dormitories, that takes place, for instance, in France and Turkey. A dormitory may provide its rooms (resource) to students that apply to some subset of colleges (region). In turn, students may be admitted to a college without getting a dormitory room (e.g., if a student is living close to the college). We are not aware of any specific way to endogenously deal with such problems either in the literature, or in practice. Thus, we assume that currently policymakers use an exogenous approach, i.e., prior to the admission process, common quotas are distributed across colleges, so each college appears to have its own number of rooms to distribute (each region contains exactly one college). The exogenous approach may obviously lead to wasted seats, if a college over-demanded by students who cannot study without a room gets not enough rooms, while under-demanded by such students college gets too many rooms. This paper is the first to present an endogenous way of resource distribution under RRC constraints. Furthermore, since there may be many resources desired by students, that are close substitutes, we generalize this framework to multiple non-empty resources.

Since \citet{gale62}, the fundamental requirement for a resulting matching has been its \textit{stability}. Under RRC, the stability of a matching is disaggregated into three separate notions: \textit{no (justified) envy}, \textit{no waste}, and \textit{resource-efficiency}. A matching has an envy, if there is a pair of a student and a college, that prefer each other to (some of) their current matches, and do not violate feasibility by breaking their ties and uniting together. A matching has waste, if some student wants to switch to an empty seat of some college she is not admitted to, and can do so without violating feasibility. A matching is resource-efficient if no student, admitted to some college, prefers to stay at this college and get an available unit of some other resource instead of her current resource possession.

The results of \citet{kamada17} imply that, under RRC, there may not exist a stable matching. Thus, we focus on three weakened versions of stability that restore existence: \textit{envy-freeness}, \textit{non-wastefulness}, and novel \textit{direct-envy stability}.

We say that a matching is \textit{envy-free} if it is resource-efficient and causes no envy. This paper presents an envy-free \textit{Decreasing Uniform Cutoffs} mechanism (DUC), where each college has a unique cutoff that determines which students are allowed to be admitted. We say that a matching is \textit{non-wasteful} if it is resource-efficient and causes no waste. We construct two non-wasteful mechanisms, \textit{Random Serial Dictatorship} (RSD) and \textit{Controlled Serial Dictatorship} (CSD), where CSD chooses the next student by minimizing newly created amount of envy, which allows us to obtain a more stable matching (on average). Notice, that envy-freeness and non-wastefulness completely disregard either waste or envy, thus, we introduce a novel trade-off notion of direct-envy stability, which partially cares of both, no envy and no waste.

Given a matching, we say that a student \textit{directly envies} another student, if the latter has everything that the former requires: either a seat at a desired college together with a desired resource, or just a desired seat. A matching is \textit{direct-envy stable} if it causes no direct envy, and any present resource inefficiency or waste would create more direct envy upon resolving. In other words, any direct-envy stable matching does not tolerate direct envy together with any possibility of its creation. We construct two direct-envy stable mechanisms, \textit{Decreasing Random Cutoffs} (DRC) and \textit{Decreasing Maximal Cutoffs} (DMC), where each college now has one cutoff \emph{per each resource} (including empty $r_0$) that determines which students are allowed to be admitted with a corresponding resource. DMC decreases cutoffs trying to keep them as close to each other as possible (for a given college), which allows us to obtain a more stable matching (on average) by minimizing envy.

\citet{kamada15} introduce \textit{weak stability} and prove that a weakly stable matching always exists under regional caps. It also turns out to be true in our setting, since direct-envy stability implies weak stability (see \Cref{prop:direct_envy_free_stability_implies_weak_stability}). In addition, we show that there exists RRC market without a resource-efficient direct-envy-stable matching, i.e., it is pointless to look for a corresponding mechanism.

Furthermore, we evaluate the stability performance of all five mechanisms by simulating their behavior under varying conditions. Specifically, we consider (i) different numbers of non-empty resource types ($0$, $1$, 5, and $10$) and (ii) four distinct market structures: horizontal (uniform preferences), college-vertical (aligned colleges' preferences), student-vertical (aligned students' preferences), and fully-vertical (aligned colleges' and students' preferences).

Our theoretical and numerical findings reveal that when there is no alignment in colleges’ preferences, DMC mechanism consistently demonstrates the highest average stability. However, in cases where such alignment exists, CSD mechanism emerges as both stable and strategy-proof. Given that real-world markets rarely exhibit perfect alignment of preferences, our results suggest that DMC is the most reliable and practical mechanism to employ under RRC constraints, making it the preferred choice for ensuring maximal stability in such settings.

The rest of the paper is structured as follows. \Cref{sec:literature} discusses related studies. \Cref{sec:model} formally introduces two-sided many-to-one matching problem under RRC. \Cref{sec:matching} presents cutoffs together with three versions of stability: envy-freeness, non-wastefulness, and direct-envy stability; and shows that there is no resource-efficient direct-envy-stable mechanism. \Cref{section:mechanisms} constructs DRC, DMC, DUC, RSD, and CSD mechanisms and proves their properties. \Cref{sec:empirics} describes simulation results on proposed mechanisms. \Cref{sec:conclusion} concludes. \Cref{app:constraints} overviews multiple distributional constraints studied in the literature, and proposes a new kind of general constraints that generalizes RRC, \textit{set-hereditary distributional constraints}. \Cref{app:balanced_market_with_5_resources,Appendix:Unbalanced markets} contain additional simulation results.

\section{Related Literature}\label{sec:literature}

Groundbreaking work by \citet{kamada15} introduced matching with distributional constraints into both computer science and economics. Distributional constraints are called \textit{aggregate} if there is at least one constraint that considers more than one college (e.g., regional constraints of \citet{kamada12} and \citet{kamada18}). RRC are obviously aggregate. The following papers work with two-sided many-to-one matching markets under various types of constraints, none of which fully capture RRC.

\citet{delacretaz23} and \citet{nguyen21} consider a two-sided many-to-one matching market under multidimensional knapsack constraints, which are not aggregate. \citet{hafalir22} study stable assignments under a model without aggregate constraints, but with regions. The authors work with choice functions of a region. \citet{liu23} present Student-Project-Resource problem with aggregate constraints. The authors introduce resources and corresponding regions, however, first, students do not have preferences over resources (a unit of a resource is necessary for a college to admit one student), and, second, it is assumed that any resource is fully indivisible, e.g., dormitory should give all its rooms to only one college. In contrast, our approach allows for student's preferences over resources, and for splitting rooms among several colleges from one region. \citet{kojima20} consider a matching problem under general constraints, where each college is constrained to choose among the predefined nonempty collection of subsets of students. \cite{romm24} show that stable allocations may admit justified envy under such constraints. \citet{kawase19} study algorithms that determine whether a given matching is stable under such constraints. \citet{imamura24b} present algorithms that check whether a given matching is Pareto efficient under such constraints. \citet{kamada24} introduce the most general version of such constraints, named \textit{general upper bounds}. However, since the set of subsets of students to choose from is fixed for each college, such constraints are not aggregate.\footnote{See \Cref{app:constraints} for discussion.} \citet{suzuki23} study a problem of redistribution of already admitted students across colleges, where constraints are extensionally represented by a set of school-feasible vectors (each containing a list of capacities for all colleges). Like RRC, this approach introduces dependence of one college possible chosen set from the chosen sets of other college(s), however, it has no resources. 

\citet{aziz24} model summer internship matching through aggregate constraints with one type of resource (money) with corresponding regions and no students' preferences over resources (a student cannot be admitted without funding). The authors use cutoff minimizing mechanism to find a cutoff stable matching. Note that RRC contains summer internship model if regions are disjoint. \citet{barrot23} and \citet{yahiro24} introduce stable and strategy-proof mechanisms under union of symmetric M-convex sets constraints. However, these constraints are based on the set of school-feasible vectors, thus, do not capture RRC. \citet{kamada23} study Pareto efficient and fair matchings under a problem of inter-regional students flow with equal in- and out- flow, but without regional constraints.

In addition, review article of \citet{aziz22} discusses in details the following types of distributional constraints: lower quotas, regional, diversity, multi-dimensional capacity, matroidal, hereditary, and general upper-bound. \Cref{app:constraints} defines them together with g-matroidal constraints (M$^\natural$-convex family) \citep{imamura24a} and shows that RRC are not implied by any of these constraints.

\section{Model}\label{sec:model}

We consider a finite set of \textbf{students} $\Students$, a finite set of \textbf{colleges} $\Colleges$, and a finite set of types of indivisible and substitutable \textbf{resources} $\Resources$. We consider, in addition, an \textit{empty resource} 
$r_0$ and denote $\Resources_0 = \Resources \cup \{r_0\}$. A \textbf{contract} is a triple of a student, a college, and a resource (empty or not) from the set of all contracts, denoted by $\Contracts = \Students \times \Colleges \times \Resources_0$.

Each college $c$ has a number of vacant seats $q_c$ to be distributed among admitted students, i.e., the \textbf{quota} of this college. We denote $\mathbf{q} = (q_c)_{c\in\Colleges}$ to be the quota profile of colleges.

Each non-empty resource has its own regional caps. Formally, we associate each non-empty type of resource $r\in\Resources$ to a partition of the colleges $P(r) \subseteq 2^{\Colleges}\backslash \{\emptyset\}$, representing a family of non-empty disjoint regions, such that union of all regions from $P(r)$ is exactly $\Colleges$. In particular, each $i$-th region $C_r^i \in P(r)$ (a non-empty set of colleges) has a maximum amount $p_r^i$ of units of resource $r$ that can be allocated to the students admitted to colleges within $C_r^i$. Remark that different type of resources may be associated with different families of regions (i.e., different partitions of the set of colleges). For $n \in \mathbb{N}$, we denote $[n] = \{1,2,...,n\}$. We also denote $\mathbf{p}_r = (p_r^i)_{i \in [|P(r)|]}$. For generality, we assume that $P(r_0)=\{\Colleges\}$ and $p_{r_0}=|{\Students}|$, i.e., there are enough units of an empty resource for every college and every student.

Each college $c \in \Colleges$ has a strict ranking $\succ_c$ over the set of all students $\Students$, where $s\,\succ_c s'$ for some $\{s,s'\}\subseteq \Students$ means that college $c$ strictly prefers student $s$ to student $s'$.\footnote{Sometimes colleges may also have resource-specific preferences over students, e.g., room-eligibility rankings in the French college admissions platform, knows as Parcoursup.} We denote $\succ_{\Colleges} = \{\succ_c\}_{c\in\Colleges}$. Each student $s \in \Students$ has strict preferences over $\{\Colleges\times\Resources_0\} \cup \{\emptyset\}$, where,

\begin{itemize}
\item $(c,r)\,\succ_s \emptyset$ means that it is \textbf{acceptable} for the student $s$ to be admitted to the college $c$ with one unit of the resource $r$,
\item $\emptyset\,\succ_s (c,r)$ means that it is unacceptable for the student $s$ to be admitted to the college $c$ with one unit of the resource $r$,
\item $(c,r)\,\succ_s (c',r')$ means that student $s$ strictly prefers to be admitted to the college $c$ with a unit of the resource $r$ to being admitted to the college $c'$ with a unit of the resource $r'$.
\end{itemize}

% In particular, remark that non-empty resources are substitutes for students, e.g., ``room in a dorm'' and ``subsidy for renting a room outside a dorm''. 
% In addition, 
Note that any contract with the empty resource $r_0$ is never a part of any (aggregate) resource constraints, thus, if a student can be admitted to a college with a non-empty resource, then she for sure can be admitted there with an empty resource.\footnote{Once the notion of feasible matching is introduced in \Cref{sec:matching} we can state this formally: for any feasible matching $\mu$ and any student $s$, such that $(c,r_0)\succ_s \emptyset$ and $(s,c,r)\in\mu$ for some college $c$ and resource $r$, the matching $(\mu\backslash\{(s,c,r)\})\cup \{(s,c,r_0)\}$ is also feasible.} So, without loss of generality, we assume that for any student $s\in\Students$, any college $c\in\Colleges$, and any non-empty resource $r\in\Resources$, whenever $(c,r)$ is acceptable for $s$, it holds $(c,r)\succ_s (c,r_0)$. In other words, whenever a resource is acceptable for a student at a given college, the student prefers to get the resource to getting the empty one. We denote a preference profile of students by $\succ_{\Students}=\{\succ_s\}_{s\in\Students}$. For a fixed student $s \in \Students$, we denote $\succ_{-s} =\ {\succ_{\Students}}\setminus\{\succ_s\}$ and, alternatively, $\succ_{\Students} = (\succ_s, \succ_{-s})$.

Finally, the \textbf{matching market with resource-regional caps} (RRC) is a tuple 
$$\langle \Students,\Colleges,\Resources_0, \{P(r)\}_{r\in \Resources_0}, \mathbf{q}, \{\mathbf{p}_r\}_{r\in \Resources_0}, \succ_{\Colleges}, \succ_{\Students} \rangle.$$

\section{Matching and Stability}\label{sec:matching}

A \textbf{matching} $\mu$ is any subset of the set of all contracts $\Contracts$, such that \textbf{each student has at most one contract}. A matching $\mu$ is \textbf{feasible} if (i) each college $c$ has at most $q_c$ contracts and (ii) for any non-empty resource $r$ and region $C_r^i \in P(r)$, $\mu$ contains at most $p^i_r$ contracts related to $r$ and any college from $C_r^i$. 

The minimal property that we require for any matching is \textit{individual rationality}. A matching is \textbf{individually rational} if it does not contain unacceptable contracts.

A \textbf{matching mechanism} $\varphi$ is a function that maps students' preference profiles to matchings. Given a students' preference profile $\succ_{\Students}$, we denote by $\varphi(\succ_{\Students})$ the corresponding matching through the mechanism $\varphi$, and by $\varphi_s(\succ_{\Students})$, a match of the student $s$. 

Given a matching $\mu$, we denote by $\mu_s$, $\mu_c$, and $\mu_r$, respectively, all triples within $\mu$ containing student $s$, college $c$, and resource $r$. In particular, whenever a student $s$ is unmatched in $\mu$, $\mu_s = \emptyset$. For a contract $\mu_s = (s,c,r) \in \mu$, we sometimes abuse notation and denote $\mu_s = (c,r)$. In particular, we write $(c',r') \succ_s \mu_s$ whenever student $s$ prefers $(c',r')$ to $(c,r)$.

% Constraints in our model (RRC constraints) is a type of \textit{distributional constraints}.

A matching $\mu$ is \textbf{Pareto-efficient} (for students) if there is no other feasible matching $\mu'$, such that, each student $s$ weakly prefers $\mu'_s$ to $\mu_s$. A mechanism $\varphi$ is \textbf{Pareto-efficient} (for students) if it produces a Pareto-efficient matching $\varphi(\succ_{\Students})$ for any students' preference profile $\succ_{\Students}$. In general, for any property of a matching, we say that a mechanism verifies the same property if for any students' preference profile $\succ_{\Students}$, $\varphi(\succ_{\Students})$ verifies this property.

A mechanism $\varphi$ is \textbf{strategy-proof} (for students) if for any students' preference profile $\succ_{\Students}$, and any student $s\in \Students$, there does not exist an alternative preference list $\succ'_s$, such that $$\varphi_s(\succ_{-s},\succ'_s)\succ_s \varphi_s(\succ_{\Students}).$$

The rest of this section is devoted to identify several notions of stability depending on the type of blocking contracts considered. \Cref{sec:stability} introduces \textit{resource-efficiency}, \textit{envy-freeness}, and \textit{non-wastefulness}. \Cref{sec:direct_envy_stability} introduces \textit{weak stability} and \textit{direct-envy stability}. \Cref{tab:stability_notions} summarizes three main stability notions by showing the kind of the blocking pairs that each notion allows and forbid to exist. Finally, \Cref{sec:cutoffs_and_cutoff_envy_free} introduces the notion of \textit{cutoffs}, the main workhorse we use for the design of mechanisms in \Cref{section:mechanisms}.

\subsection{Stable Matchings}\label{sec:stability}

Given a feasible and individually rational matching, we consider three different sources of \textbf{instability}: resource inefficiency, envy, and waste (wasted college seats).

\begin{definition}
Let $\mu$ be a feasible and individually rational matching. A contract $(s,c,r) \in \Contracts \setminus \mu$ is said to \textbf{resource-block} $\mu$ if (i) $\mu_s = (s,c,r')$ for some $r' \in \Resources_0\setminus\{r\}$, (ii) $(c,r) \succ_s \mu_s$, and (iii) $(\mu\backslash\{\mu_s\})\cup \{(s,c,r)\}$ is feasible. Matching $\mu$ is called \textbf{resource-efficient} if it does not have any resource-blocking contract.
\end{definition}

In words, a contract $(s,c,r)$ resource-blocks a matching $\mu$ whenever the student $s$, already allocated in the college $c$, prefers another resource $r$ while staying at $c$, and there is a not taken unit of $r$ that $c$ can allocate. %the matching obtained after exchanging the resources remains feasible.

\begin{definition}\label{def:envy_freeness}
Let $\mu$ be an individually rational feasible matching. A contract $(s,c,r)\in\Contracts\backslash\mu$ is said to  \textbf{envy-block} $\mu$ if $(c,r)\succ_s \mu_s$ and there exists a contract $(s',c,r')\in\mu$, such that, (i) $s\succ_c s'$; (ii) $(s,c,r')\not\in \mu$ for any $r'\in\Resources_0$; and (iii) the matching $(\mu\backslash\{\mu_s,(s',c,r')\})\cup \{(s,c,r)\}$ is feasible. Matching $\mu$ is called \textbf{envy-free} if it is resource-efficient and does not have envy-blocking contracts.
\end{definition}

In words, a contract $(s,c,r)$ envy-blocks a matching $\mu$ whenever $s$ prefers to be allocated at some other college $c$ with the resource $r$, college $c$ prefers $s$ to one of its assigned students, and the matching remains feasible after making the replacement of contracts. In order for a matching to be called envy-free we require not only no envy, but also resource-efficiency, since it does not violate existence (\Cref{prop:properties_DUC}). Envy-free matchings are useful in many contexts (see \citet{kamada24}). Note that an empty matching is envy-free in our model. Thus, the existence of an envy-free matching is trivial.

\begin{definition}\label{def:non_wastefulness}
Let $\mu$ be a feasible individually rational matching. A contract $(s,c,r)\in\Contracts\backslash\mu$ is said to \textbf{waste-block} $\mu$ if (i) $(c,r)\succ_s \mu_s$; (ii) $(s,c,r')\not\in \mu$ for any $r'\in\Resources_0$; (iii) $|\mu_c|<q^c$; and (iv) the matching $(\mu\backslash\{\mu_s\})\cup \{(s,c,r)\}$ is feasible. Matching $\mu$ is called \textbf{non-wasteful} if it is resource-efficient and does not have any waste-blocking contract.
\end{definition}

In words, a contract $(s,c,r)$ waste-blocks a matching $\mu$ whenever $s$ prefers to be allocated at some other college $c$ with the resource $r$, college $c$ has an empty seat and can allocate a not taken unit of $r$. In order for a matching to be called non-wasteful we require not only no waste, but also resource-efficiency, since it does not violate existence (\Cref{prop:properties_SD}).

A contract is said to \textbf{block} a matching if it is either resource, envy, or waste-blocking. 

\begin{definition}\label{def:stability}
A feasible individually rational matching is called \textbf{stable} if it has no blocking contracts. 
\end{definition}

Unfortunately, stable matching may not exist, as exposed by \citet{kamada17} in the following example.

\begin{example}\label{example:noStableMatching}
Consider a market with two students, two colleges, and one (non-empty) resource with one region containing both colleges. Quotas are $q_{c_1} = q_{c_2} = p_r = 1$. Preferences are:

\begin{table}[H]
    \centering
    \begin{tabular}{c c c}
        $\succ_{s_1}: (c_1,r),(c_2,r),\emptyset$ &  & $\succ_{c_1}: s_2,s_1$\\
        $\succ_{s_2}: (c_2,r),(c_1,r),\emptyset$ &  & $\succ_{c_2}: s_1,s_2$
    \end{tabular}
\end{table}

 There are five possible feasible individually rational matchings: $\mu_0=\{\}$, $\mu_1=\{(s_1,c_1,r)\}$, $\mu_2=\{(s_2,c_2,r)\}$, $\mu_3=\{(s_1,c_2,r)\}$, and $\mu_4=\{(s_2,c_1,r)\}$. The following is true: $\mu_0$ has a waste-blocking contract $(s_2,c_1,r)$; $\mu_1$ has an envy-blocking contract $(s_2,c_1,r)$; $\mu_2$ has an envy-blocking contract $(s_1,c_2,r)$; $\mu_3$ has a waste-blocking contract $(s_1,c_1,r)$; and $\mu_4$ has a waste-blocking contract $(s_2,c_2,r)$. Thus, all five feasible matchings are unstable.
 %$\hfill\triangle$
\end{example}

\subsection{Direct-Envy Stable Matchings}\label{sec:direct_envy_stability}

In order to guarantee the existence of some weakened version of stable matchings we will (1) strengthen the notion of envy-blocking and (2) partially relax the no waste and resource-efficiency requirements. The proposed version of weakened stability is built around a new notion of \textit{direct envy}, which requires that the envious student be able to obtain whatever she needs directly from the other student.

\begin{definition}\label{def:direct_envy_blocking_contract}
Let $\mu$ be a feasible individually rational matching. A contract $(s,c,r)\in\Contracts\backslash\mu$ is said to \textbf{direct-envy-block} $\mu$ if $(c,r) \succ_s \mu_s$, $s$ is not matched to $c$, and there exists another contract $(s',c,r') \in \mu$, such that, (i) $s\succ_c s'$, and (ii) $r \in \{ r', r_0$\}.
\end{definition}

Notice that any direct-envy-blocking contract is envy-blocking. Indeed, since $\mu$ is initially feasible, condition (ii) in \Cref{def:direct_envy_blocking_contract} implies that the matching remains feasible after the exchange of the two contracts. A contact is said to be \textbf{indirect-envy-blocking} if it is envy-blocking, but not direct-envy-blocking. 

Now we can adapt the notion of \textit{weak stability} from \citet{kamada15} to our setting.

\begin{definition}\label{def:weak_stability}
A feasible and individually rational matching is called \textbf{weakly stable} if it has no direct-envy-blocking contract and for any waste-blocking contract $(s,c,r)$, first, $r\neq r_0$, and, second, in the region $C_r^i$ that contains $c$, all $p_r^i$ units of resource $r$ are distributed among admitted students.
\end{definition}

Weak stability is a well known stability notion in the literature of matching under distributional constraints \citep{aziz24,kamada17}. We focus on studying a stronger stability notion in our setting, namely, \textit{direct-envy stability}. \Cref{prop:direct_envy_free_stability_implies_weak_stability} shows that direct-envy stability implies weak stability. Furthermore, \Cref{prop:DRC_DMC_des} implies that direct-envy stable matching always exists.

\begin{definition}\label{def:dominated_contract}
Let $\mu$ be a feasible and individually rational matching. A [resource] waste-blocking contract $(s,c,r)\in\Contracts\setminus\mu$ is said to be \textbf{(direct-envy) dominated} if there exists another contract $(s',c,r')\in\Contracts\backslash\mu$, such that (i) $(s',c,r')$ is not [direct-]envy, waste or resource-blocking under $\mu$, and (ii) $(s',c,r')$ is direct-envy-blocking under $(\mu\backslash\{\mu_s\})\cup \{(s,c,r)\}$.
\end{definition}

\Cref{def:dominated_contract} states that a resource or waste-blocking contract $x = (s,c,r) \in \Contracts\setminus\mu$ is dominated by another not blocking contract $x' \in \Contracts\setminus\mu$ whenever $x'$ becomes a direct-envy blocking contract after replacing the contract $\mu_s$ within $\mu$ by $x$. From an implementation point of view, a central planner may prefer to leave some colleges with empty seats or undistributed resources, even if some students envy those places or resources, in order to avoid to trigger new direct-envy blocking contracts. A resource or waste-blocking contact is said to be \textbf{undominated} if it is not dominated.

% For a given feasible matching $\mu$ and a waste-blocking contract $(s,c,r) \in \Contracts\setminus\mu$, this contract is d.e.-dominated waste-blocking if we can find another contract in $\Contracts\setminus\mu$ with the same college and another student such that, first, it  does not block $\mu$ already, second, the college prefers the second to the first student, and, third, the second contract blocks a matching obtained from $\mu$ when adding a contract $(s,c,r)$ and removing $\mu_s$.

% In other words, the contract $(s,c,r)$ initially waste-blocks $\mu$ because $s$ prefers $(c,r)$ to her current allocation, but if we implement this contract by adding it in $\mu$, we create a direct-envy-blocking contract as in Definition \ref{def:direct_envy_blocking_contract}.

% A matching is \textbf{non-wasteful} if any blocking contract is envy-blocking. A mechanism is \textbf{non-wasteful} if it produces a non-wasteful matching for any $\succ_{\Students}$.

\begin{definition}\label{def:direct-envy-stability}
A feasible and individually rational matching is called \textbf{direct-envy stable} if it has no direct-envy-blocking contracts and any resource or waste-blocking contract is dominated. 
% We say a mechanism is \textbf{direct-envy stable} if it produces a direct-envy stable matching for any students preference profile $\succ_{\Students}$.
\end{definition}

\begin{proposition}\label{prop:direct_envy_free_stability_implies_weak_stability}
Any direct-envy stable matching is weakly stable.
\end{proposition}

\begin{proof}
Take a direct-envy stable matching $\mu$. By definition, there is no direct-envy-blocking contracts, and any resource or waste-blocking contract is dominated. Let $(s,c,r) \in\Contracts\backslash\mu$ be a waste-blocking contract. We need to prove that $r\neq r_0$ and that in the region that contains college $c$, all units of resource $r$ are distributed among admitted students.

Since $\mu$ is direct-envy stable, $(s,c,r)$ is dominated, i.e., there exists another contract $(s',c,r')\in\Contracts\backslash\mu$, such that (i) $(s',c,r')$ is not blocking under $\mu$ and (ii) $(s',c,r')$ is direct-envy-blocking under $(\mu\backslash\{\mu_s\})\cup \{(s,c,r)\}$. In particular, since it is $(s,c,r)$ that makes $(s',c,r')$ direct-envy-blocking under $(\mu\backslash\{\mu_s\})\cup \{(s,c,r)\}$, $r = r' \neq r_0$, as whenever $r' = r_0$, $(s',c,r')$ should be waste-blocking under $\mu$.

Suppose now that under $\mu$ in the region containing $c$, some units of resource $r$ are not distributed. Hence, $(s',c,r')$ should be waste-blocking under $\mu$, since $r' = r$, which is a contradiction. We conclude that matching $\mu$ is weakly stable.
\end{proof}

\begin{table}[H]
\small
\centering
\caption{Stability notions with allowed blocking contracts.
Symbols \cmark and \xmark\ signal, respectively, the type of blocking contract allowed and forbidden to exist under the corresponding type of stability.}
\begin{tabular}{ c  c  c  c  c}
    \textit{Types of}  & Envy-freeness & Non-wastefulness & Direct-envy Stability & Stability \\
    \textit{blocking contracts}  & (\Cref{def:envy_freeness}) & (\Cref{def:non_wastefulness}) & (\Cref{def:direct-envy-stability}) & (\Cref{def:stability})\\
    \toprule
    Indirect-envy  & \xmark & \cmark  & \cmark & \xmark\\
    Direct-envy  & \xmark & \cmark & \xmark & \xmark\\ 
    \hline
    Undominated waste  & \cmark & \xmark & \xmark & \xmark \\
    Dominated waste & \cmark & \xmark & \cmark  & \xmark\\
    \hline
    Undominated resource & \xmark & \xmark & \xmark  & \xmark \\
    Dominated resource & \xmark & \xmark & \cmark  & \xmark \\
    \toprule
\end{tabular}
\label{tab:stability_notions}
\end{table}

In \Cref{section:mechanisms} we show that a direct-envy stable matching always exists by constructing a direct-envy stable mechanism DRC (see \Cref{prop:DRC_DMC_des}). A natural question that arises after discovering this is: \textit{does any market under RRC constraints have a resource-efficient direct-envy stable matching?} The following proposition shows that the answer is \textit{no}, which explains why resource-efficiency is not required for direct-envy stability.

\begin{proposition}\label{prop:no_re_des_mechanism}
    There is no resource-efficient direct-envy stable mechanism.
\end{proposition}

\begin{proof}
    We show that there exists a market without a resource-efficient direct-envy stable matching.
    
    Consider a market with three students, three colleges, and one (non-empty) resource $r$ with one region containing all colleges. Quotas are $q_{c_1} = q_{c_2} = q_{c_3} = p_r = 1$. Preferences are:

    \begin{table}[H]
        \centering
        \begin{tabular}{l c c}
            $\succ_{s_1}: (c_1,r),(c_1,r_0),(c_3,r),(c_2,r_0),(c_3,r_0),\emptyset$ &  & $\succ_{c_1}: s_3,s_2,s_1$\\
            $\succ_{s_2}: (c_1,r),\emptyset$ &  & $\succ_{c_2}: s_1,s_2,s_3$\\
            $\succ_{s_3}: (c_2,r_0),(c_1,r_0),\emptyset$ &  & $\succ_{c_3}: s_3,s_1,s_2$
        \end{tabular}
    \end{table}

    Let us look for all direct-envy stable matchings. Take a direct-envy stable matching $\mu$.
    
    Suppose that $(s_2,c_1,r)\in \mu$. Thus, none of the following contracts is in $\mu$ due to feasibility: $(s_3,c_1,r_0),(s_1,c_1,r),(s_1,c_1,r_0),(s_1,c_3,r)$. Also, if $(s_3,c_2,r_0)\in \mu$, then $s_1$ has a direct envy towards $s_3$, so $(s_3,c_2,r_0)\not\in \mu$. Therefore, the matching should be $\mu=\{(s_1,c_2,r_0),(s_2,c_1,r)\}$, which is not direct-envy stable: $s_3$ direct envies $s_1$ with $(s_3,c_1,r_0)$. Therefore, $(s_2,c_1,r)\not\in \mu$.

    So far, we know that $(s_2,c_1,r)\not\in \mu$, i.e., $s_2$ is unmatched. Thus, $(s_1,c_1,r)\not\in \mu$, since otherwise $s_2$ direct envies $s_1$. Suppose that $(s_3,c_1,r_0)\in \mu$. Thus, none of the following contracts is in $\mu$ due to feasibility: $(s_3,c_2,r_0),(s_1,c_1,r_0)$. Thus, the matching should be $\mu=\{(s_1,c_3,r),(s_3,c_1,r_0)\}$, which is not direct-envy stable: $(s_3,c_2,r_0)$ is undominated waste-blocking contract. Therefore, $(s_3,c_1,r_0)\not\in \mu$.

    So far, we know that none of the following contracts is in $\mu$: $(s_1,c_1,r),(s_2,c_1,r),(s_3,c_1,r_0)$. Suppose that $(s_1,c_1,r_0)\in \mu$. Thus, none of the following contracts is in $\mu$ due to feasibility: $(s_1,c_2,r_0),(s_1,c_3,r_0),(s_1,c_3,r)$. Thus, the matching should be $\mu=\{(s_1,c_1,r_0),(s_3,c_2,r_0)\}$, which is direct-envy stable, but not resource-efficient: $(s_1,c_1,r)$ is resource-blocking.

    So far, we know that none of the following contracts is in $\mu$: $(s_1,c_1,r),(s_1,c_1,r_0),(s_2,c_1,r),$ $(s_3,c_1,r_0)$. Suppose that $(s_3,c_2,r_0)\in \mu$. Thus, the matching should be $\mu=\{(s_1,c_3,r),(s_3,c_2,r_0)\}$, which is not direct-envy stable: $(s_1,c_1,r_0)$ is undominated waste-blocking contract. Therefore, $(s_3,c_2,r_0)\not\in \mu$.

    So far, we know that none of the following contracts is in $\mu$: $(s_1,c_1,r),(s_1,c_1,r_0),(s_2,c_1,r),$ $(s_3,c_1,r_0),(s_3,c_2,r_0)$. Thus, the matching should be $\mu=\{(s_1,c_3,r)\}$, which is not direct-envy stable: $(s_3,c_2,r_0)$ is undominated waste-blocking contract.
    
    Therefore, there is only one direct-envy stable matching $\mu=\{(s_1,c_1,r_0),(s_3,c_2,r_0)\}$, which is not resource-efficient. This concludes the proof.
\end{proof}

\subsection{Cutoffs}\label{sec:cutoffs_and_cutoff_envy_free}

We find direct-envy stable matchings by distributing resources among colleges in a \textit{balanced} way with respect to their preferences. In order to do it, we (i) transform the colleges ordinal preferences into cardinal preferences and (ii) run decreasing cutoffs mechanisms which construct matchings by choosing the contracts whose values are weakly above the current cutoffs (subject to feasibility).

% Given a college $c \in \Colleges$, we extend $c$'s strict preferences to $(\Students\times \Resources_0)\cup\{\emptyset\}$ by aligning $\succ_c$ with the students preferences over pairs containing $c$. We abuse notation and denote college $c$'s preferences over pairs also by $\succ_c$. Thus, the following holds for $\succ_c$:

% \begin{itemize}
%     \item for any $(s,r)\in \Students\times \Resources_0$: $(s,r) \succ_c \emptyset$ if, and only if, $(c,r) \succ_s \emptyset$, i.e., a pair $(s,r)$ is acceptable for $c$ if, and only if, $(c,r)$ is acceptable for $s$;

%     \item for any acceptable $(s,r),(s,r')\in \Students\times \Resources_0$: $(s,r)\succ_c (s,r')$ if, and only if, $(c,r)\succ_s (c,r')$;

%     \item for any acceptable $(s,r),(s',r')\in \Students\times \Resources_0$: $(s,r)\succ_c (s',r')$ if, and only if, $s\succ_c s'$.
% \end{itemize}

% In particular, a contract $(s,c,r)$ is called acceptable whenever $(s,r)\succ_c \emptyset$. 

% \begin{remark}
% Students initially ranked as acceptable by colleges may not appear on colleges' extended preferences if the students do not find the colleges acceptable (with any resource). In particular, the extended preference ordering of a college might by empty. 
% \end{remark}

% We align all colleges' preferences over students with students' preferences over pairs and obtain a new collection $\succ_{\Colleges} = \{\succ_c\}_{c\in\Colleges}$.


To each contract $(s,c,r)\in \Contracts$, we assign an integer value 
\begin{equation*}
v_{(s,c,r)}=
  \left\{
    \begin{aligned}
      & 1+|\{s'\in \Students\:|\: s\succ_c s' \}|, \text{ if }  (c,r)\succ_s \emptyset,\\
      & -1, \text{ otherwise. }
    \end{aligned}
  \right.
\end{equation*}

In words, any acceptable contract $(s,c,r)$, where a student $s$ is $k$-th best student for a college $c$, is assigned a value $v_{(s,c,r)}=|\Students| + 1 - k$, while any unacceptable contract is assigned a value of $-1$.

Remark that, whenever $(c,r)$ and $(c,r')$ are both acceptable for a student $s$, $v_{(s,c,r)} = v_{(s,c,r')}  \geq 1$. Similarly, $v_{(s,c,r)} > v_{(s',c,r')} \geq 1$ whenever $(c,r)$ is acceptable for $s$, $(c,r')$ is acceptable for $s'$, and $s\succ_c s'$.
% For each college $c$ we denote its \textbf{number of acceptable pairs} by $\overline{v}_c := \max \{v_{(s,c,r)} \mid (s,r) \in \Students \times \Resources_0\}$.

We leverage the cardinal representation of colleges' preferences to construct matchings by determining cutoffs and choosing the contracts whose values are weakly above. %Since cutoffs may not define a unique matching, we will choose the one \textbf{maximizing students' preferences}. In particular, t
The following sections introduce different mechanisms which focus on determining cutoffs such that the resulting matching is feasible and stable. 

\begin{definition}\label{def:cutoff_matrix}
A \textbf{cutoff profile} is a matrix $\CutoffsMatrix = (\Cutoffs[r][c])^{c\in\Colleges}_{r\in\Resources_0}$, where $\Cutoffs[r][c]\in[|{\Students}|+1]$, such that, for any $c \in \Colleges$ and non-empty resource $r\in \Resources$, $\Cutoffs[r_0][c] = \Cutoffs[0][c] \leq \Cutoffs[r][c]$ . A cutoff is \textbf{minimal} if it is equal to $1$.
\end{definition}

The condition over cutoffs in \Cref{def:cutoff_matrix} requires that whenever a contract, containing a student $s$, a college $c$, and a non-empty resource $r$, can be included in a matching, i.e., its value is weakly above the corresponding cutoff $\Cutoffs[r][c]$, then any contract with $s$, $c$, and the empty resource $r_0$ can be included as well. 

Given a cutoff profile $\CutoffsMatrix$, we denote by $\mu(\CutoffsMatrix)$ the induced matching obtained by including the most preferred contract $(s,c,r)$ of each student $s$ whose value $v_{s,c,r}$ is weakly above the cutoff $\Cutoffs[r][c]$. Remark $\mu(\CutoffsMatrix)$, a priory, \textbf{may not be feasible nor stable}.

Given a cutoff profile $\CutoffsMatrix$, we denote by $\CutoffsMatrix - \mathbf{1}$ the cutoff profile obtained by decreasing $1$ unit to each entry of $\CutoffsMatrix$ that is not minimal. Similarly, we denote by $\CutoffsMatrix - \mathbf{1}^c$ and $\CutoffsMatrix - \mathbf{1}_{r}^c$, respectively, the cutoff profile obtained by decreasing $1$ unit to each entry related to college $c$ in $\CutoffsMatrix$ that is not minimal, and one unit to the entry related to college $c$ and resource $r$, if it is not already minimal.

\begin{definition}
    A cutoff profile $\CutoffsMatrix$ is said to be \textbf{optimal} if $\mu(\CutoffsMatrix)$ is feasible, and there is no $c\in \Colleges$ and $r\in \Resources_0$, such that $\Cutoffs_{r}^c > 1$ and $\mu(\CutoffsMatrix- \mathbf{1}_{r}^c)$ is feasible.
\end{definition}

In words, a cutoff profile is optimal if the induced matching is feasible, and either all cutoffs are minimal, or no cutoff can be further decreased without breaking the feasibility of the induced matching.

\begin{proposition}\label{prop:optimal_cuts_des}
    Any optimal cutoff profile induces a direct-envy stable matching. Any direct-envy stable matching can be induced by a unique optimal cutoff profile.
\end{proposition}

\begin{proof}
    By definition, the matching induced by an optimal profile of cutoffs is such that, for each college holds, that none of its cutoffs can be reduced by one in order to get a feasible matching (making sure that the empty resource cutoff is always the lowest). Take such matching $\mu$.
    
    If $(s,c,r)\in \mu$, then any $(s',c,r)$, such that $s'\succ_c s$ could have been included into $\mu$. Moreover, any $(s',c,r_0)\in \mu$, such that $s'\succ_c s$ could have been included into $\mu$. Therefore, there are no direct-envy-blocking contracts under $\mu$.
    
    Now suppose that there is a waste-blocking contract $(s,c,r)$ under $\mu$. First, we show that $r\neq r_0$. Since $c$ has an open seat, if $r=r_0$, then we would get feasible matching my setting $\Cutoffs[0][c]=v_{(s',c,r_0)}$, where $(s',c,r_0)$ is the highest ranked waste-blocking contract for $c$ with empty resource. Thus, $\mu$ cannot be induced by an optimal profile of cutoffs. Contradiction.
    
    Now we show that $(s,c',r)\in \mu$, where $\{c,c'\}\subseteq C^i_r$, i.e., student $s$ is admitted to another college from the same region for $r$ with a unit of $r$. Note that all resource $r$'s units should be distributed in $C^r_i$. Suppose otherwise, i.e., college $c$ has an empty seat and can distribute a unit of $r$. Since $\mu$ is induced by an optimal profile of cutoffs, there is no blocking contract with college $c$ and an empty recourse $r_0$. Therefore, there should exist a waste-blocking contract $x$ containing $c$ and $r$ (it is either $(s,c,r)$ or some contract with higher rank at $c$), such that, if we set $\Cutoffs[0][c]=\Cutoffs[r][c]=v_x$ by decreasing either both or just one of these cutoffs by one, we induce a feasible matching different from $\mu$, thus, $\mu$ cannot be induced by an optimal profile of cutoffs. Contradiction. As a result, for $(s,c,r)$ to be waste-blocking, $s$ should be admitted with $r$ to some college in the same region for $r$ as $c$, where all units of $r$ are distributed. 
    
    Finally, we show that the highest ranked contract with $c$ and $r$ below the cutoff $\Cutoffs[r][c]$, $x$, is not $(s,c,r)$, which implies that $(s,c,r)$ is dominated. Suppose that $x=(s,c,r)$, then if we set $\Cutoffs[0][c]=\Cutoffs[r][c]=v_{(s,c,r)}$, we induce a feasible matching different from $\mu$, thus, $\mu$ cannot be induced by an optimal profile of cutoffs. Contradiction.

    Now suppose that there is a resource-blocking contract $(s,c,r)$ under $\mu$. Thus, $r\neq r_0$, $(s,c,r')\in \mu$ with $r'\neq r$, and there is a free unit of $r$ that $c$ can distribute. Suppose that $(s,c,r)$ is undominated, i.e., there is no contract $(s',c,r)$, such that, $s'\succ_c s$ and $(c,r)\succ_{s'} \mu_{s'}$. This implies that $\Cutoffs[r][c]=v_{(s,c,r)} + 1$. Thus, matching $\mu(\CutoffsMatrix- \mathbf{1}_{r}^c)=(\mu(\CutoffsMatrix)\backslash (s,c,r')\cup (s,c,r)$ is feasible. Contradiction.
    
    Thus, $\mu$ is direct-envy stable, i.e., any optimal cutoff profile induces a direct-envy stable matching.

    Now we switch to the second statement. Consider a direct-envy stable matching $\mu$. Construct a profile of cutoffs $\CutoffsMatrix$, such that for each pair $c\in \Colleges$ and $r\in \Resources_0$, the cutoff $\Cutoffs[r][c]$ either equals to $(v_{(s,c,r)} + 1)$, where $x_r^c\equiv (s,c,r)$ is the highest ranked by $c$ contract, such that $(c,r) \succ_s \mu_s$, or equals to 1, if no such contract exists. We need to show that, first, $\CutoffsMatrix$ induces $\mu$, and, second, $\CutoffsMatrix$ is optimal.

    Take any contract $(s,c,r)\in \mu$. By construction, $\Cutoffs[r][c]\leq v_{(s,c,r)}$, since otherwise there will be a direct-envy-blocking contract $x_r^c$. So, contract $(s,c,r)$ is included into $\mu(\CutoffsMatrix)$, since it is the best contract for $s$ that she can choose from. Thus, $\CutoffsMatrix$ induces $\mu$.

    Take any not minimal cutoff $\Cutoffs[r][c]>1$ with a corresponding contract $x_r^c = (s,c,r)$ right beneath it. The constructed cutoff profile is not optimal if a matching $(\mu(\CutoffsMatrix)\backslash \mu(\CutoffsMatrix)_s)\cup x_r^c$ is feasible. It may happen in one of two cases:
    \begin{enumerate}
        \item if all seats of $c$ are taken, but a unit of $r$ for $c$ is free, i.e., some $(s,c,r')\in \mu$, which implies that $(s,c,r)$ is undominated resource-blocking contract. Contradiction.

        \item if there is an empty seat at $c$, i.e., $(s,c,r)$ is undominated waste-blocking contract. Contradiction.
    \end{enumerate}

    Thus, $\CutoffsMatrix$ is the only optimal cutoff profile that induces $\mu$. As a result, any direct-envy stable matching can be induced by unique optimal cutoff profile.
\end{proof}

% \begin{definition}\label{def:min_cutoff_envy_freeness}
% A feasible individually rational matching $\mu$ is said to be \textbf{min-cutoff envy-free} if there exists a cutoff profile $\CutoffsMatrix$ such that $\mu = \mu(\CutoffsMatrix)$ and for any college $c \in \Colleges$, (i) $\Cutoffs[r][c] = \Cutoffs[r'][c]$ for any $r,r' \in \Resources_0$ and (ii) $\mu(\CutoffsMatrix - \mathbf{1}^c)$ is not feasible.
% \end{definition}

% Remark that any min-cutoff envy-free matching is envy-free as for any college the first condition requires for all cutoffs to be equal. In particular, for any chosen contract, any better contract for this college could have been chosen as well, which eliminates the possibility for existence of any envy-blocking contract.

\begin{algorithm}[H] \label{alg:General_Mechanism}
\SetAlgoNoLine
\KwIn{A matching market with resource-regional caps $\langle \Students,\Colleges,\Resources_0, \{P(r)\}_{r\in \Resources_0}, \mathbf{q}, \{\mathbf{p}_r\}_{r\in \Resources_0}, \succ_{\Colleges}, \succ_{\Students} \rangle$}
\KwOut{A matching $\mu$}

\textbf{Initialization}:
\begin{itemize}
    \item Cutoff mechanism: For any $(c,r)\in\Colleges\times\Resources_0$, $\Cutoffs[r][c](0) \longleftarrow |{\Students}| + 1$, $t \longleftarrow 1$.
    \item Contract mechanism: $\mu(0) \longleftarrow \varnothing$, $t \longleftarrow 1$.
\end{itemize}

\While{Possible Update}{
\begin{itemize}
    \item Cutoff mechanism: $\CutoffsMatrix(t+1) = \text{Update}(\CutoffsMatrix(t))$, $t \longleftarrow t+1$
    \item Contract mechanism: $\mu(t+1) = \text{Update}(\mu(t))$, $t \longleftarrow t+1$
\end{itemize}
}
\textbf{Return} 
\begin{itemize}
    \item Cutoff mechanism: $\mu(\CutoffsMatrix(t))$ 
    \item Contract mechanism: $\mu(t)$
\end{itemize}
\caption{General Mechanism}
\end{algorithm}

\section{Mechanisms}\label{section:mechanisms}

This section is devoted to present five mechanisms, divided in two main families: cutoff mechanisms and contract mechanisms. Both families, starting from an empty matching, update the current solution until no further update can be done without breaking the feasibility of the matching. In particular, after each iteration of any mechanism the tentative matching is always feasible.

Each mechanism is totally determined by its \textbf{update rule}. Algorithm \ref{alg:General_Mechanism} illustrates a general mechanism. For $t \geq 0$, we denote, respectively, $\CutoffsMatrix(t)$ and $\mu(t)$ to the tentative cutoff profile and matching at iteration $t$. %\vspace{-0.2cm}

% two families of mechanisms:
% \begin{itemize}
% \item \textbf{Cutoffs mechanisms} which, starting from an initial cutoff profile, create a sequence of cutoff profiles by modifying their entries until convergence.
% \item \textbf{Matching mechanisms} which, starting from an initially feasible matching, modify contracts preserving the feasibility, until exhausting the options.
% \end{itemize}

% For each family, a mechanism will be defined by three components: its \textbf{initialization} (the initial cutoff profile or matching), the \textbf{update rule} (how to modify the cutoffs or the contracts), and a \textbf{stopping criterion}. In the rest of this section we present each family in a general way and show theoretical properties obtained when considering particular initializations, update rules, and stopping criteria. \Cref{Sec:empirics} will complement the theoretical study with empirical results.

\subsection{Cutoff Mechanisms}

Cutoff mechanisms, starting from the most restrictive cutoffs, create a sequence of decreasing cutoff profiles until it finds some optimal profile. Once the final cutoff profile is computed, the induced student matching, as explained in \Cref{sec:cutoffs_and_cutoff_envy_free}, is constructed.

% \Cref{alg:General_Cutoff_Mechanism} presents a general cutoffs mechanism. For $t \geq 0$, we denote $\CutoffsMatrix(t)$ to the cutoff profile at iteration $t$. 

% \begin{algorithm}[ht]
% \SetAlgoNoLine
% \KwIn{A matching market with resource-regional caps $\langle \Students,\Colleges,\Resources_0, \{P(r)\}_{r\in \Resources}, \mathbf{q}, \{\mathbf{p}_r\}_{r\in \Resources}, \succ_{\Colleges}, \succ_{\Students} \rangle.$}
% \KwOut{A matching $\mu$}

% \textbf{Initialization} : $\CutoffsMatrix(0)$ an initial cutoffs matrix, $t = 1$.

% \While{Stopping criterion not attained}{
% $\CutoffsMatrix(t+1) = \text{Update}(\CutoffsMatrix(t))$, $t = t+1$
% }
% Return $\mu(\CutoffsMatrix(t))$
% % \textbf{Initialization} : $\CutoffsMatrix(0) = \{\overline{v}_c+1\}_{r\in\Resources}^{c\in\Colleges}$ or any $\CutoffsMatrix(0)$ such that $\mu(\CutoffsMatrix(0))$ is feasible, $t = 1$.
% % \While{$\CutoffsMatrix(t) \neq \mathbf{1}$}{
% % \For{$(c,r) \in \Colleges\times \Resources$, such that $\Cutoffs[r][c] \bi 1$, randomly chosen without replacement}{
% % \uIf{$r = 0$ and $\mu(\CutoffsMatrix(t) - 1_{0}^c)$ is feasible}{Set $\CutoffsMatrix(t+1) = \CutoffsMatrix(t) - 1_{0}^c$, $t = t+1$, \textbf{break}}
% % \uElseIf{$r \neq 0$, $\Cutoffs[r][c] = \Cutoffs[0][c]$ and $\mu(\CutoffsMatrix(t) - 1_{r}^c - 1_{0}^c)$ is feasible}{Set $\CutoffsMatrix(t+1) = \CutoffsMatrix(t) - 1_{r}^c - 1_{0}^c$, $t = t+1$, \textbf{break}}
% % \uElseIf{$\Cutoffs[r][c] \bi \Cutoffs[0][c]$ and $\mu(\CutoffsMatrix(t) - 1_{r}^c)$ is feasible}{Set $\CutoffsMatrix(t+1) = \CutoffsMatrix(t) - 1_{r}^c$, $t = t+1$, \textbf{break}}
% % }
% % Return $\mu(\CutoffsMatrix(t))$}
% \caption{General Cutoffs Mechanism}
% \label{alg:General_Cutoff_Mechanism}
% \end{algorithm}

% Consider the following cutoff minimizing mechanism CUTS.
% \begin{itemize}
%     \item \textbf{Step $0$.} Set $\Cutoffs[0]$, such that $\mu(\Cutoffs[0])$ is feasible.\footnote{For instance, resulting cutoffs from CUT$^{\nearrow\searrow}(\succ_{\Students})$.} By default, $\Cutoffs[0] = \{\{t^c_i\}_{i\in\{0,1,\dots,m\}}\}_{c\in\Colleges}$, such that $t^c_i=\overline{v}_c+1$ for all $c\in\Colleges$ and $i\in\{0,1,\dots,m\}$, i.e., no contract can be included into a matching. Go to Step $1$.
%     \item \textbf{Step $k$ ($k\geq 1$).} If all cutoffs from $\Cutoffs[k-1]$ are minimal (equal to 1), set CUTS$(\succ_{\Students})=\mu(\Cutoffs[k-1])$, end the procedure. Otherwise, pick any not minimal cutoff $t^c_i\in \Cutoffs[k-1]$. If $t^c_i=t^c_0$, set $\mathbf{T}=t^c_i\cup t^c_0$, otherwise, set $\mathbf{T}=t^c_i$. 
%     If $\mu((\Cutoffs[k-1]\backslash \mathbf{T})\cup (\mathbf{T}-\mathbf{1}))$ is feasible, set $\Cutoffs[k]=(\Cutoffs[k-1]\backslash \mathbf{T})\cup (\mathbf{T}-\mathbf{1})$, go to Step $(k+1)$.
%     Otherwise, set $\Cutoffs=\Cutoffs[k-1]\backslash \{t^c_i\}$, go to Sub-step $k.1$
%     \begin{itemize}
%         \item \textbf{Sub-step $k.\ell$ ($\ell \geq 1$).} If $|\Cutoffs|=0$, set CUTS$(\succ_{\Students})=\mu(\Cutoffs[k-1])$, end the procedure. 
%         Otherwise, if all cutoffs from $\Cutoffs$ are minimal (equal to 1), set CUTS$(\succ_{\Students})=\mu(\Cutoffs[k-1])$, end the procedure. Otherwise, pick any not minimal cutoff $t^c_i\in \Cutoffs$. If $t^c_i=t^c_0$, set $\mathbf{T}=t^c_i\cup t^c_0$, otherwise, set $\mathbf{T}=t^c_i$.
%         If $\mu((\Cutoffs[k-1]\backslash \mathbf{T})\cup (\mathbf{T}-\mathbf{1}))$ is not feasible, set $\Cutoffs=\Cutoffs\backslash \{t^c_i\}$, go to Sub-step $k.(\ell+1)$. Otherwise, set $\Cutoffs[k]=(\Cutoffs[k-1]\backslash \mathbf{T})\cup (\mathbf{T}-\mathbf{1})$, go to Step $(k+1)$.
%     \end{itemize}
% \end{itemize}

% In words, mechanism CUTS works as follows. At Step $0$ we set up cutoffs that induce a feasible matching. Then, at each Step $k$ we randomly pick any cutoff (for any college) and check whether decreasing it by one will still produce a feasible matching (making sure that the empty cutoff is always the lowest). If it is so, we decrease the chosen cutoff by one, and switch to the next Step $(k+1)$. Otherwise, i.e., if decreasing the chosen cutoff by one produces a not feasible matching, we go to Sub-steps $k.\cdot$, where we start checking the same for the rest cutoffs one by one. If, at some Sub-step $k.\ell$ decreasing the newly chosen cutoff by one produces a not feasible matching, we go to the next Sub-step $k.(\ell+1)$. Otherwise, i.e., if decreasing the newly chosen cutoff by one produces a feasible matching, we decrease this cutoff by one, and switch to the next Step $(k+1)$. The procedure ends either if all cutoffs are minimal (equal to 1), or if it is impossible to decrease any cutoff and get a feasible matching, i.e., all cutoffs are checked during Sub-steps $k.\cdot$.

\subsubsection{Decreasing Random Cutoffs} 

The Decreasing Random Cutoffs (DRC) mechanism is defined by the following update rule:
\smallskip

\fbox{
\parbox{0.95\textwidth}
{At time $t$, pick uniformly $(c,r) \in \Colleges\times\Resources_0$ such that $\Cutoffs[r][c]$ is not minimal. 
\begin{itemize}
    \item If either $\Cutoffs[r][c] \bi \Cutoffs[0][c]$ or $r = r_0$, and $\mu(\CutoffsMatrix(t) - 1_r^c)$ is feasible, set $\CutoffsMatrix(t+1) = \CutoffsMatrix(t) - 1_r^c$.
    \item If $\Cutoffs[r][c] = \Cutoffs[0][c]$, $r \neq r_0$, and $\mu(\CutoffsMatrix(t) - 1_r^c - 1_0^c)$ is feasible, set $\CutoffsMatrix(t+1) = \CutoffsMatrix(t) - 1_r^c - 1_0^c$.
\end{itemize}}
}
\smallskip

The update rule of the DRC mechanism uniformly picks an entry of the current cutoff profile and tries to decrease it by one unit. Whenever the chosen cutoff is equal to the cutoff of the empty resource, both of them are decreased in order to keep the condition in \Cref{def:cutoff_matrix}. By construction of the DRC update rule, the matching remains feasible during the whole algorithm. 

\subsubsection{Decreasing Maximal Cutoffs} 

The Decreasing Maximal Cutoffs (DMC) mechanism is defined by the following update rule:
\smallskip

\fbox{
\parbox{0.95\textwidth}
{At time $t$, pick $\sigma \in \Sigma(\Colleges)$ a permutation of the colleges. Set $\CutoffsMatrix(t_0) = \CutoffsMatrix(t)$ and for $\ell \in [|{\Colleges}|]$, run the following sub-routine:
    \begin{itemize}
        \item Let $c$ be the $\ell$-th college in $\sigma(\Colleges)$. Consider 
        $$\mathrm{R}_{\text{f}}^c = \{\Cutoffs[r][c](t) \mid \Cutoffs[r][c](t) > 1, \mu(\CutoffsMatrix(t_{\ell-1}) - 1_r^c) \text{ is feasible for } r \in \Resources_0\},$$ 
        its set of cutoffs that can be decreased, and $$\mathrm{R}_{\text{f}\max}^c = \{\Cutoffs[r][c](t)\in \mathrm{R}_{\text{f}}^c \mid \Cutoffs[r][c](t) \geq \Cutoffs[r'][c](t) \text{ for any } \Cutoffs[r'][c](t)\in \mathrm{R}_{\text{f}}^c\}$$ that is, the subset of $\mathrm{R}_{\text{f}}^c$ with the highest cutoffs.
        
        \item Set $\CutoffsMatrix(t_{\ell}) = \CutoffsMatrix(t_{\ell-1} ) - \sum\nolimits_{r \text{, s.t. }\Cutoffs[r][c](t) \in \mathrm{R}_{\text{f}\max}^c} 1_{r}^c$ and run the sub-routine $\ell + 1$.
    \end{itemize}
    Set $\CutoffsMatrix(t+1) = \CutoffsMatrix(t_{|{\Colleges}|})$, where $\CutoffsMatrix(t_{|{\Colleges}|})$ is the cutoff profile obtained after running $|{\Colleges}|$ subroutines.
}}
\smallskip

The update rule of the DMC mechanism, for each college, simultaneously decreases the largest set of maximal cutoffs that preserve the feasibility of the matching. In particular, the condition in \Cref{def:cutoff_matrix} is always verified, since whenever a non-empty resource $r\in\Resources$ belongs to $\mathrm{R}_{\text{f}\max}^c$ and $\Cutoffs[r][c] = \Cutoffs[0][c]$, then $r_0 \in \mathrm{R}_{\text{f}\max}^c$. In other words, whenever a cutoff $\Cutoffs[r][c] $ with the same value as $\Cutoffs[0][c]$ is decreased, $\Cutoffs[0][c]$ is decreased as well.
% $\Cutoffs[r][c]$ can be decreased by one unit preserving the matching feasibility, $\Cutoffs[0][c]$ can also be decreased as this can never break the matching feasibility. In other words, whenever $r$ $r_0 \in \mathrm{R}_{\max}^c$, $r_0 \in \mathrm{R}_{\text{f}\max}^c$.

\subsubsection{Decreasing Uniform Cutoffs} 

The Decreasing Uniform Cutoffs (DUC) mechanism is defined by the following update rule:
\smallskip

\fbox{
\parbox{0.95\textwidth}
{At time $t$, pick $\sigma \in \Sigma(\Colleges)$ a permutation of the colleges. Set $\CutoffsMatrix(t_0) = \CutoffsMatrix(t)$ and for $\ell \in [|{\Colleges}|]$, run the following sub-routine:
    \begin{itemize}
        \item Let $c$ be the $\ell$-th college in $\sigma(\Colleges)$. If $\mu(\CutoffsMatrix(t_{\ell-1}) - \mathbf{1}^c)$ is feasible, set $\CutoffsMatrix(t_{\ell}) = \CutoffsMatrix(t_{\ell-1} ) - \mathbf{1}^c$. Otherwise, set $\CutoffsMatrix(t_{\ell}) = \CutoffsMatrix(t_{\ell-1} )$. Run the sub-routine $\ell + 1$.
    \end{itemize}
Set $\CutoffsMatrix(t+1) = \CutoffsMatrix(t_{|{\Colleges}|})$, where $\CutoffsMatrix(t_{|{\Colleges}|})$ is the cutoff profile obtained after running $|{\Colleges}|$ subroutines.}
}
\smallskip

The update rule of the DUC mechanism decreases, for each college, all its cutoffs simultaneously, whenever the resulting matching remains feasible. Thus, the condition in \Cref{def:cutoff_matrix} is always verified.

\subsubsection{Theoretical Properties of Cutoffs Mechanisms}

\begin{proposition}\label{prop:DRC_DMC_des}
Both DRC and DMC are direct-envy stable.
\end{proposition}

\begin{proof} By construction, the resulting matching $\mu$ in both mechanisms is induced by an optimal profile of cutoffs. Thus, by \Cref{prop:optimal_cuts_des}, $\mu$ is direct-envy stable.
\end{proof}

\begin{proposition}\label{prop:DMC_not_strategy-proof}
DRC and DMC are not strategy-proof and do not always find a stable matching whenever one exists.
\end{proposition}

\begin{proof} Consider a market with two students, two colleges, and one resource. Corresponding region contains both colleges. Quotas are $q_{c_1}=q_{c_2}=p_r=1$. Preferences are:

\begin{table}[H]
\centering
\begin{tabular}{l c c}
$\succ_{s_1}: (c_2,r),(c_1,r),\emptyset$ &  & $\succ_{c_1}: s_1,s_2$\\
$\succ_{s_2}: (c_2,r),\emptyset$ &  & $\succ_{c_2}: s_2,s_1$
\end{tabular}
\end{table}

Suppose, first we choose $c_1$ for DMC or $(c_1,r)$ for DRC. Thus, DMC$(\succ_{\Students})=$DRC$(\succ_{\Students})=\{(s_1,c_1,r)\}$. Note that there is only one stable matching $\{(s_2,c_2,r)\}$. Therefore, DRC and DMC do not always find a stable matching whenever one exists.

Now, consider a market with two students, two colleges, and only empty resource. Quotas are $q_{c_1}=q_{c_2}=1$. Preferences are:

\begin{table}[H]
\centering
\begin{tabular}{l c c}
$\succ_{s_1}: (c_2,r_0),(c_1,r_0),\emptyset$ &  & $\succ_{c_1}: s_1,s_2$\\
$\succ_{s_2}: (c_1,r_0),(c_2,r_0),\emptyset$ &  & $\succ_{c_2}: s_2,s_1$
\end{tabular}
\end{table}

Suppose, first we choose $c_1$ for DMC or $(c_1,r_0)$ for DRC; then we choose $c_2$ for DMC or $(c_2,r_0)$ for DRC; then again $c_1$ for DMC or $(c_1,r_0)$ for DRC; then we choose $c_2$ for DMC or $(c_2,r_0)$ for DRC. Thus, DMC$(\succ_{\Students})=$DRC$(\succ_{\Students})=\{(s_1,c_1,r_0),(s_2,c_2,r_0)\}$.

Now, suppose that student $s_1$ lies about her preferences: $\succ'_{s_1}:(c_2,r_0),\emptyset$. Thus, DMC$(\succ_{\Students})=$ DRC$(\succ'_{s_1},\succ_{s_2})=\{(s_1,c_2,r_0),(s_2,c_1,r_0)\}\succ_{s_1}\{(s_1,c_1,r_0),(s_2,c_2,r_0)\}=$ DMC$(\succ_{\Students})=$ DRC$(\succ_{\Students})$. Thus, DRC and DMC are not strategy-proof for students.\footnote{For this case, DMC and DRC act as college-proposing deferred acceptance, which is not strategy-proof for students.}
\end{proof}

\begin{proposition}\label{prop:properties_DUC}
DUC is envy-free, not strategy-proof, and does not always find a stable matching whenever one exists.
\end{proposition}

\begin{proof} For DUC being not strategy-proof and not always finding a stable matching whenever one exists, works the same reasoning as in the proof of \Cref{prop:DMC_not_strategy-proof}.

DUC is envy-free by construction. It cannot produce any envy-blocking or resource-blocking contracts, because each college has all its cutoffs being equal.
\end{proof}

\begin{proposition}\label{prop:cutoffs_mechanisms_are_stable_if_no_resources}
Under no non-empty resources all cutoff mechanisms (DMC, DRC, DUC) are stable and identical.
\end{proposition}

\begin{proof}
    By construction, DMC, DRC, and DUC mechanisms become college-proposing deferred acceptance (CDA) under no non-empty resources. Thus, first, they produce the same matching for the same market, and, second, all properties of CDA transfer to DMC, DRC, and DUC, e.g., stability of the resulting matching (since stability from \Cref{def:stability} becomes classical \citet{gale62} stability under no non-empty resources).
\end{proof}

\begin{comment}
    For CUT$^{\nearrow\searrow}$ consider the following example. 

        Consider a market with three students, two colleges, and one resource. Corresponding region contains both colleges. Quotas are $q^{c_1}=q^{c_2}=p^r=1$. Preferences are:

    \begin{table}[H]
        \centering
        \begin{tabular}{l c c}
            $\succ_{s_1}: (c_1,r),(c_2,r),\emptyset$ &  & $\succ_{c_1}: s_1,s_2,s_3$\\
            $\succ_{s_2}: (c_2,r),\emptyset$ &  & $\succ_{c_2}: s_1,s_2,s_3$\\
            $\succ_{s_3}: (c_2,r),\emptyset$ & & 
        \end{tabular}
    \end{table}

     Thus, induced preferences of colleges over pairs are: 

    \begin{table}[H]
        \centering
        \begin{tabular}{l}
            $\succ_{c_1}: (s_1,r),\emptyset$\\
            $\succ_{c_2}: (s_1,r),(s_2,r),(s_3,r),\emptyset$
        \end{tabular}
    \end{table}

     Suppose, during Step 1.1 we choose $c_1$. Thus, during Steps 1.2 and 1.3 we choose $c_2$. Thus, CUT$^{\nearrow\searrow}(\succ_{\Students})=\{(s_1,c_2,r)\}$. Note that there is only one stable matching $\{(s_1,c_1,r)\}$. Therefore, CUT$^{\nearrow\searrow}$ does not always find a stable matching whenever one exists.

     Now, consider a market with two students, two colleges, and one resource. Corresponding region contains both colleges. Quotas are $q^{c_1}=q^{c_2}=p^r=1$. Preferences are:

    \begin{table}[H]
        \centering
        \begin{tabular}{l c c}
            $\succ_{s_1}: (c_2,r),(c_1,r),\emptyset$ &  & $\succ_{c_1}: s_2,s_1$\\
            $\succ_{s_2}: (c_2,r),\emptyset$ &  & $\succ_{c_2}: s_2,s_1$
        \end{tabular}
    \end{table}

    Thus, induced preferences of colleges over pairs are: 

    \begin{table}[H]
        \centering
        \begin{tabular}{l}
            $\succ_{c_1}: (s_1,r),\emptyset$\\
            $\succ_{c_2}: (s_2,r),(s_1,r),\emptyset$
        \end{tabular}
    \end{table}

    Suppose, during Step 1.1 we choose $c_2$, and during Step 1.2 we choose $c_1$. Thus, CUT$^{\nearrow\searrow}(\succ_{\Students})=\{(s_2,c_2,r)\}$.

    Now, suppose that student $s_1$ lies about her preferences: $\succ'_{s_1}: (c_1,r),\emptyset$.  Thus, induced preferences of colleges over pairs are: 

    \begin{table}[H]
        \centering
        \begin{tabular}{l}
            $\succ'_{c_1}: (s_1,r),\emptyset$\\
            $\succ'_{c_2}: (s_2,r),\emptyset$
        \end{tabular}
    \end{table}

     Again, during Step 1.1 we choose $c_2$. Thus, CUT$^{\nearrow\searrow}(\succ'_{s_1},\succ_{s_2})=\{(s_1,c_1,r)\}\succ_{s_1}\{(s_2,c_2,r)\}=$ CUT$^{\nearrow\searrow}(\succ_{\Students})$. Thus, CUT$^{\nearrow\searrow}$ is not strategy-proof for students.
\end{comment}

\subsection{Contract Mechanisms}

Contract mechanisms, starting from the empty matching, sequentially add contracts until no other contract can be included without breaking the feasibility of the matching. Given a matching $\mu$ and a student $s\in\Students$ that has no match under $\mu$, we define \textbf{the most preferred contract of student $s$ given the matching $\mu$} as the the most preferred acceptable contract of $s$, such that $\mu \cup (s,c,r)$ is feasible.

\subsubsection{Random Serial Dictatorship}

The Random Serial Dictatorship (RSD) mechanism fixes a students permutation $\sigma \in \Sigma({\Students})$ as part of the initialization and runs the following update rule:
\smallskip

\fbox{
\parbox{0.95\textwidth}
{At iteration $t$, let $s_t$ be the $t$-th student in $\sigma({\Students})$ and $(c^*,r^*)$ be her the most preferred contract given the matching $\mu(t-1)$. Set $\mu(t) = \mu(t-1) \cup (s_t,c^*,r^*)$.
}
}
\smallskip

The RSD mechanism has as many iterations as number of students. Following the prefixed order given by $\sigma$, the mechanism adds to the matching the most preferred acceptable contract of each student preserving its feasibility.

\subsubsection{Controlled Serial Dictatorship}

The Controlled Serial Dictatorship (CSD) mechanism, like the RSD mechanism, will run as many iterations as number of students. However, instead of prefixing the order in which students are included into the matching, the CSD mechanism will add the most preferred contract by any college among the most preferred contracts of the remaining students preserving the feasibility of the matching. In other words, among the students most preferred feasible contracts, the mechanism adds the one with the highest valuation. Formally, initialize $S_0 = \Students$. The CSD mechanism is defined by the following update rule:
\smallskip

\fbox{
\parbox{0.95\textwidth}
{At iteration $t$, for each student $s \in S_{t-1}$, compute her the most preferred contract given the matching $\mu(t-1)$ and denote by $X_t$ the union of all these solutions. Compute next,
$$ X'_t = \argmax_{(s,c,r)\in X_t} v_{(s,c,r)}.$$ 
Pick at random any solution $(s,c,r)\in X'_t$, if there are more than one. Set $\mu(t) = \mu(t-1) \cup (s,c,r)$ and $S_{t} = S_{t-1} \setminus\{s\}$.
}
}
\smallskip

\subsubsection{Theoretical Properties of Contract Mechanisms}

\begin{proposition}\label{prop:properties_SD}
    RSD and CSD are non-wasteful and Pareto-efficient. RSD is strategy-proof, while CSD is not.
\end{proposition}

\begin{proof}
RSD and CSD are Pareto-efficient by construction. In turn, Pareto-efficiency implies non-wastefulness (absence of waste-blocking and resource-blocking contracts). RSD is strategy-proof by construction. CSD is not strategy-proof as students may affect their chances of being chosen earlier by putting contracts with high college rank higher in her own ranking.
\end{proof}

\begin{comment}
We unsuccessfully tried to find a counter-example for small markets (3 colleges, 3 students, one non-empty resource, one region, unit quotas) using simulations. The main candidate for a resource efficient direct-envy stable mechanism was DMC with a specific college sequence (for each college we perform a sub-routine from a DMC update rule), since DMC is a direct-envy stable mechanism that produces very little resource inefficiency in simulations from \Cref{sec:empirics}. However, the following turns out to be true.

\begin{proposition}
    There exists a market under RRC constraints, such that no sequence of colleges allows DMC to find some existing resource efficient direct-envy stable matching.
\end{proposition}

\begin{proof}
    Consider a market with three students, three colleges, and one (non-empty) resource $r$ with one region containing all colleges. Quotas are $q_{c_1} = q_{c_2} = q_{c_3} = p_r = 1$. Preferences are:

    \begin{table}[H]
        \centering
        \begin{tabular}{l c c}
            $\succ_{s_1}: (c_2,r),(c_2,r_0),(c_3,r_0),\emptyset$ &  & $\succ_{c_1}: s_3,s_1,s_2$\\
            $\succ_{s_2}: (c_2,r),(c_1,r_0),\emptyset$ &  & $\succ_{c_2}: s_3,s_2,s_1$\\
            $\succ_{s_3}: (c_3,r_0),(c_1,r),(c_2,r_0),\emptyset$ &  & $\succ_{c_3}: s_2,s_1,s_3$
        \end{tabular}
    \end{table}

    Note that if $(s_3,c_1,r)$ belongs to some feasible matching, then it is one of three possible matchings: $\mu_1 = \{(s_3,c_1,r)\}$, $\mu_2 = \{(s_3,c_1,r),(s_1,c_2,r_0)\}$, and $\mu_3 = \{(s_3,c_1,r),(s_1,c_3,r_0)\}$. None of them is direct-envy stable, i.e., none of them can be produced by DMC.

    Suppose that the first college is $c_1$. Thus, $(s_3,c_1,r)$ is tentatively chosen, since both cutoffs of $c_1$ are now $\Cutoffs_0^{c_1} = \Cutoffs_r^{c_1} = 3$. We cannot decrease cutoffs further for $c_1$, thus, the next college is either $c_2$, or $c_3$. From above we know that $s_3$ should eventually switch to $(c_3,r_0)$. ... 
\end{proof}
\end{comment}

\section{Numerical Results}\label{sec:empirics}

% {\color{red} avoid past tense}

We study the stability of the mechanisms introduced in \Cref{section:mechanisms} both theoretically and numerically under markets presenting different preferences alignments.
For each market, we first draw preferences without unacceptable contracts, using the uniform distribution over preferences, that meet the following properties:
\begin{itemize}
    \item \textbf{Horizontal markets}: %Students' and colleges' preferences are drawn uniformly,
    College preferences are unconstrained, and student's preferences are such that $(c,r)\succ_s (c,r_0)$ for each student $s$, college $c$, and resource $r$.
    \item \textbf{Student-vertical markets}: Colleges' preferences are unconstrained, while students' preferences are aligned over colleges and resources separately, i.e., for any student $s\in\Students$:
    \begin{itemize}
        \item for any resource $r \in \Resources_0$, $(c_{|{\Colleges}|},r) \succ_s ... \succ_s (c_2,r) \succ_s (c_1,r)$, and
        \item for any college $c \in \Colleges$, 
        $(c,r_{|{\Resources}|}) \succ_s ... \succ_s (c,r_2) \succ_s (c,r_1) \succ_s (c,r_0)$.
    \end{itemize}     
    \item \textbf{College-vertical markets}: %Students' preferences are drawn uniformly, while all colleges agree on the preferences over students, i.e., for any college $c\in\Colleges$, $s_{|{\Students}|} \succ_c ... \succ_c s_2 \succ_c s_1$.
    All colleges agree on the same preferences over students, i.e., for any college $c\in\Colleges$, $s_{|{\Students}|} \succ_c ... \succ_c s_2 \succ_c s_1$, while students have horizontal preferences as above.
    \item \textbf{Fully-vertical markets}: Both students and colleges have aligned preferences as described above.
\end{itemize}

Then, to create a situation where students have unacceptable contracts, each student randomly discards a (uniformly random) subset of contracts, by declaring them as unacceptable (moving them below an outside option $\emptyset$).
%Remark, that under none of the presented types of markets students must rank as acceptable the same set of contracts. In other words, truncated preferences (up to the empty contract $\emptyset$) may have different sizes and, even for markets with aligned preferences, students may include different contracts in their rankings. 

The following proposition shows that under aligned colleges' preferences, like in college-vertical or fully-vertical markets, CSD mechanism is an unambiguous winner, since it becomes stable and strategy-proof.

\begin{proposition}\label{prop:CSD_is_stable_under_colleges_alignment}
CSD is stable and strategy-proof whenever colleges' preferences are aligned.
\end{proposition}

\begin{proof}
    Consider the common preferences of colleges $\succ$. By construction, CSD call order of students is exactly $\succ$, i.e., the best student chooses a contract first, second best chooses a contract second, etc. Thus, no student may affect this order and, moreover, each time any student is called to choose, her best action is to choose the best possible contract according to her true preferences, i.e., CSD is strategy-proof.

    By \Cref{prop:properties_SD}, CDS has no waste and is resource-efficient. Moreover, from above we know that call order is exactly $\succ$, therefore, by \Cref{def:envy_freeness}, there may not be envy in the final matching. As a result, by \Cref{def:stability}, CSD is stable.
\end{proof}

Thus, we do not test CSD under college-vertical and fully-vertical markets, since it always produces zero blocking contracts.

Regarding the experiments, we fix the size of the simulated markets to $100$ students, $10$ colleges, and variable number of resources $|{\Resources}_0| \in \{1,2,10\}$.\footnote{For an intermediate case with $|{\Resources}_0| = 5$, see \Cref{app:balanced_market_with_5_resources}.} Remark that $|{\Resources_0}| = 1$ means no non-empty resources, obtaining a market à la \citet{gale62}. In addition, we consider, first, one unique region with all colleges belonging to it for each resource, and, second, \textit{balanced markets} (both in colleges capacities and resources quotas), i.e., colleges capacities and resources quotas both sum up $100$.\footnote{For experiments on unbalanced markets and general number of regions, see \Cref{Appendix:Unbalanced markets}.} These two modeling choices are designed to create a market that involves trade-offs between our different notions of stability. Intuitively, random balanced markets are more intricate than unbalanced ones, as shown by \citet{ashlagi17} (see \Cref{Appendix:Unbalanced markets} for discussion). Similarly, having a single region introduces more complexity as opposed to assigning each college to its own region, which is equivalent to eliminating resource constraints entirely.

For each kind of market and number of resources we simulate $100$ markets and solve each of them once with the five mechanisms. The following tables show the average number of blocking contracts of each kind together with its standard deviation. Please remark that each blocking contract was considered only once for the counting in the following order of importance: waste-blocking, direct-envy-blocking, indirect-envy-blocking, and resource-blocking. For instance, if a blocking contract is both waste and direct-envy-blocking, then it is counted only towards a number of waste-blocking contracts.
% \footnote{We decided to put resource-blocking first to highlight the average amount of resource inefficiency.} 
For clarity of exposition, we omit from tables any mechanism yielding no blocking contracts. Finally, the last column of each table shows the averaged total amount of blocking contracts. 

We say that the \textit{mechanism A is more stable on average than the mechanism B under fixed type of markets and fixed number of resources} if A has less blocking contracts than B in (the last column of) the corresponding table.

Numerical results illustrate that an important trade-off might exist between blocking contracts. DUC, being envy-free, produces a large number of waste-blocking contracts.\footnote{Interestingly, for our simulations on balanced markets, this happens only under more than one non-empty resource (5 and 10 resources, see \Cref{tab:blocking_contracts_five_resources,tab:blocking_contracts_ten_resources}). However, DUC produces a lot of waste under any kind of unbalanced markets even for one non-empty resource (see \Cref{tab:blocking_contracts_two_resources_unbalanced_horizontal_market,tab:blocking_contracts_two_resources_unbalanced_college_vertical_market}).} RSD, while producing no waste, yields a large number of direct-envy. In turn, DRC (direct-envy stable mechanism) produces resource, waste, and envy-blocking contracts.\footnote{Again, interestingly, for our simulations on balanced markets, this happens only under more than one non-empty resource (5 and 10 resources, see \Cref{tab:blocking_contracts_five_resources,tab:blocking_contracts_ten_resources}). Note that under either 5 resources, or unbalanced markets with one non-empty resource and colleges' preferences alignment, DMC yields no blocking contracts (see \Cref{tab:blocking_contracts_five_resources,tab:blocking_contracts_two_resources_unbalanced_college_vertical_market}). However, DMC becomes unstable under unbalanced horizontal markets (see \Cref{tab:blocking_contracts_two_resources_unbalanced_horizontal_market}).}

\begin{table}[H]
\centering
\small{
\caption{Average numbers of blocking contracts produced by mechanisms presented in \Cref{section:mechanisms} over $100$ balanced markets with $100$ students, $10$ colleges, and $1$ resource, i.e., college admissions à la \citet{gale62}. Mechanisms presenting zero blocking contracts were omitted from the corresponding kind of market.}
\begin{tabular}{cccccc}
\toprule
\multicolumn{6}{c}{\textbf{Horizontal Markets - One resource} ($\Resources_0 = \{r_0\}$)}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy       & Total    \\
\hline
% DRC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0 & 0.0$\pm$0.0     \\
% DMC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0 & 0.0$\pm$0.0     \\
% DUC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0 & 0.0$\pm$0.0     \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 19.78$\pm$10.32   & 0.0$\pm$0.0 & 19.78$\pm$10.32 \\
CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 2.42$\pm$2.178    & 0.0$\pm$0.0 & 2.42$\pm$2.178  \\
\toprule
\multicolumn{6}{c}{\textbf{Student-vertical Markets - One resource ($\Resources_0 = \{r_0\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total \\
\hline
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 136.69$\pm$22.017 & 0.0$\pm$0.0 & 136.69$\pm$22.017 \\
CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 4.35$\pm$4.109    & 0.0$\pm$0.0 & 4.35$\pm$4.109    \\
\toprule
\multicolumn{6}{c}{\textbf{College-vertical Markets - One resource ($\Resources_0 = \{r_0\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total       \\
\hline
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 17.49$\pm$8.137   & 0.0$\pm$0.0 & 17.49$\pm$8.137 \\
% CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0 & 0.0$\pm$0.0     \\
\toprule
\multicolumn{6}{c}{\textbf{Fully-vertical Markets - One resource ($\Resources_0 = \{r_0\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total       \\
\hline
% DRC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0 & 0.0$\pm$0.0       \\
% DMC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0 & 0.0$\pm$0.0       \\
% DUC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0 & 0.0$\pm$0.0       \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 136.64$\pm$20.067 & 0.0$\pm$0.0 & 136.64$\pm$20.067 \\
% CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0 & 0.0$\pm$0.0       \\
\toprule
\end{tabular}
\label{tab:blocking_contracts_no_resources}
}
\end{table}

Comparing two non-wasteful mechanisms, although CSD shows a much better performance than RSD, it still produces some amount of (direct) envy. However, this is not the case anymore when colleges have the same ranking over students (\Cref{prop:CSD_is_stable_under_colleges_alignment}), making CSD the most stable mechanism under this kind of markets. Interestingly, under students' preferences alignment, RSD produces several times more direct envy, while DUC produces several times more waste. 

Overall, DMC presents the best total performance under not aligned colleges' preferences, i.e., even though it produces all kinds of blocking contracts (except direct-envy), it minimizes their sum. Therefore, whenever working on markets \textit{without colleges' preferences alignment}, the results suggest that \textit{DMC is the most stable on average mechanism}.

\Cref{tab:blocking_contracts_no_resources} presents results under $\Resources_0 = \{r_0\}$. \Cref{prop:cutoffs_mechanisms_are_stable_if_no_resources} proves that DMC, DRC, and DUC are stable under $\Resources_0 = \{r_0\}$, thus none of them appears. In addition, as stated in \Cref{prop:CSD_is_stable_under_colleges_alignment}, CSD becomes stable whenever colleges present preferences alignment.

\Cref{tab:blocking_contracts_two_resources} presents results for two resources $\Resources_0 = \{r_0,r_1\}$. Now DRC differs from college-proposing deferred acceptance, so it produces resource and envy-blocking contracts for all kinds of preferences alignment. Surprisingly, DMC remained stable even when increasing the number of simulated market up to $100$k.\footnote{Note that DMC may not be stable even if $\Resources_0 = \{r_0,r_1\}$ due to \Cref{example:noStableMatching} (also see \Cref{tab:blocking_contracts_two_resources_unbalanced_horizontal_market}).} Furthermore, no mechanism produced any waste under any balanced market with one non-empty resource (unlike under unbalanced markets, see \Cref{tab:blocking_contracts_two_resources_unbalanced_college_vertical_market,tab:blocking_contracts_two_resources_unbalanced_horizontal_market}).

\Cref{tab:blocking_contracts_ten_resources} presents results for $|{\Resources_0}| = 10$. Note that now DMC yields some amount of resource, waste, and envy-blocking contracts, although extremely low. Moreover, remark the aggregated results of all mechanisms presented in the last column of \Cref{tab:blocking_contracts_ten_resources}: DMC remains the most stable on average mechanism under no alignment of colleges' preferences, with DRC being next best. These are exactly two direct-envy stable mechanisms, which indicates that direct-envy stability indeed produces very little instability on average.

Summing up all the results, we formulate the following algorithm aimed at helping policymakers to pick the most suitable matching mechanism (out of five) in order to obtain the most stable matching, given the policymaker's agenda.

\begin{table}[ht]
\centering
\small{
\caption{Average numbers of blocking contracts produced by mechanisms presented in \Cref{section:mechanisms} over $100$ balanced markets with $100$ students, $10$ colleges, and $2$ resource, i.e., one empty resource and one non-empty resource. Mechanisms presenting zero blocking contracts were omitted from the corresponding kind of market.}
\begin{tabular}{cccccc}
\toprule
\multicolumn{6}{c}{\textbf{Horizontal Markets - Two resources ($\Resources_0 = \{r_0,r_1\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy       & Total    \\
\hline
DRC & 1.0$\pm$1.086   & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 3.97$\pm$3.465 & 4.97$\pm$4.061   \\
% DMC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0      \\
% DUC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0      \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 28.34$\pm$11.288  & 0.21$\pm$0.535 & 28.55$\pm$11.337 \\
CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 5.21$\pm$4.459    & 0.08$\pm$0.306 & 5.29$\pm$4.524   \\
\toprule
\multicolumn{6}{c}{\textbf{Student-vertical Markets - Two resources ($\Resources_0 = \{r_0,r_1\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total \\
\hline
DRC & 2.15$\pm$1.676  & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 4.6$\pm$3.197  & 6.75$\pm$4.328    \\
% DMC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0       \\
% DUC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0       \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 270.55$\pm$41.849 & 4.04$\pm$5.209 & 274.59$\pm$42.989 \\
CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 7.73$\pm$4.974    & 0.31$\pm$0.784 & 8.04$\pm$5.206    \\
\toprule
\multicolumn{6}{c}{\textbf{College-vertical Markets - Two resources ($\Resources_0 = \{r_0,r_1\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total       \\
\hline
DRC & 0.96$\pm$1.148  & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 2.58$\pm$2.534 & 3.54$\pm$3.448   \\
% DMC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0      \\
% DUC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0      \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 28.86$\pm$11.949  & 0.35$\pm$0.876 & 29.21$\pm$11.981 \\
% CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0      \\
\toprule
\multicolumn{6}{c}{\textbf{Fully-vertical Markets - Two resources ($\Resources_0 = \{r_0,r_1\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total       \\
\hline
DRC & 4.79$\pm$2.74   & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 12.67$\pm$7.09 & 17.46$\pm$9.231   \\
% DMC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0       \\
% DUC & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0       \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 267.88$\pm$38.647 & 2.49$\pm$4.041 & 270.37$\pm$38.707 \\
% CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0       \\
\toprule
\end{tabular}
\label{tab:blocking_contracts_two_resources}
}
\end{table}

\subsection{Guide for Policymakers}

Theoretical and simulation results imply the following guide for a policymaker on which mechanism to choose depending on the market type and/or her stability objective:
\begin{itemize}
    \item If colleges' preferences are aligned, then one should choose CSD (\Cref{prop:CSD_is_stable_under_colleges_alignment}), else
    \item if one does not tolerate waste:
    \begin{itemize}
        \item and strategy-proofness is not important, then one should choose CSD (\Cref{prop:properties_SD}), else
        \item one should choose RSD (\Cref{prop:properties_SD}), else
    \end{itemize}
    \item if one does not tolerate envy, then DUC is the choice (\Cref{prop:properties_DUC}),\footnote{Note that DUC produces the least stable on average matching for any type of balanced markets under 5 and 10 resources (see \Cref{tab:blocking_contracts_five_resources,tab:blocking_contracts_ten_resources}), while being among two the least stable mechanisms (together with RSD) for any type of unbalanced markets even under 2 resources (see \Cref{tab:blocking_contracts_two_resources_unbalanced_college_vertical_market,tab:blocking_contracts_two_resources_unbalanced_horizontal_market}).} else
    \item one should choose DMC.\footnote{DMC appears to be more stable on average than any other mechanism for any considered balanced or unbalanced market type  without colleges' preferences alignment and any number of resources.}
\end{itemize}

In short, direct-envy stable DMC is almost always the best choice for achieving maximal stability.

\begin{table}[ht]
\centering
\small{
\caption{Average numbers of blocking contracts produced by mechanisms presented in \Cref{section:mechanisms} over $100$ balanced markets with $100$ students, $10$ colleges, and $10$ resources. Mechanisms presenting zero blocking contracts were omitted from the corresponding kind of market.}
\begin{tabular}{cccccc}
\toprule
\multicolumn{6}{c}{\textbf{Horizontal Markets - Ten resources ($\Resources_0 = \{r_0,r_1,...,r_9\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy       & Total    \\
\hline
DRC & 0.17$\pm$0.53   & 0.79$\pm$1.243     & 0.0$\pm$0.0       & 8.85$\pm$5.256  & 9.81$\pm$5.488     \\
DMC & 0.06$\pm$0.237  & 0.71$\pm$1.16      & 0.0$\pm$0.0       & 3.37$\pm$3.297  & 4.14$\pm$3.418     \\
DUC & 0.0$\pm$0.0     & 668.52$\pm$319.666 & 0.0$\pm$0.0       & 0.0$\pm$0.0     & 668.52$\pm$319.666 \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0        & 66.25$\pm$24.582  & 16.26$\pm$8.154 & 82.51$\pm$29.445   \\
CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0        & 26.38$\pm$14.674  & 6.22$\pm$3.537  & 32.6$\pm$16.84     \\
\toprule
\multicolumn{6}{c}{\textbf{Student-vertical Markets - Ten resources ($\Resources_0 = \{r_0,r_1,...,r_9\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total \\
\hline
DRC & 1.64$\pm$1.841  & 1.64$\pm$2.563      & 0.0$\pm$0.0       & 19.03$\pm$6.663   & 22.31$\pm$7.933     \\
DMC & 0.0$\pm$0.0     & 2.03$\pm$3.005      & 0.0$\pm$0.0       & 9.74$\pm$4.374    & 11.77$\pm$5.381     \\
DUC & 0.0$\pm$0.0     & 3435.54$\pm$537.443 & 0.0$\pm$0.0       & 0.0$\pm$0.0       & 3435.54$\pm$537.443 \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0         & 623.93$\pm$72.998 & 252.02$\pm$53.159 & 875.95$\pm$100.814  \\
CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0         & 29.72$\pm$8.435   & 10.89$\pm$5.808   & 40.61$\pm$12.525    \\
\toprule
\multicolumn{6}{c}{\textbf{College-vertical Markets - Ten resources ($\Resources_0 = \{r_0,r_1,...,r_9\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total       \\
\hline
DRC & 0.59$\pm$2.04   & 0.14$\pm$0.347     & 0.0$\pm$0.0       & 5.84$\pm$8.78  & 6.57$\pm$10.656    \\
DMC & 0.0$\pm$0.0     & 0.02$\pm$0.14      & 0.0$\pm$0.0       & 0.01$\pm$0.099 & 0.03$\pm$0.171     \\
DUC & 0.0$\pm$0.0     & 660.43$\pm$372.934 & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 660.43$\pm$372.934 \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0        & 68.94$\pm$26.998  & 17.09$\pm$8.35 & 86.03$\pm$31.38    \\
% CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0        & 0.0$\pm$0.0       & 0.0$\pm$0.0    & 0.0$\pm$0.0        \\
\toprule
\multicolumn{6}{c}{\textbf{Fully-vertical Markets - Ten resources ($\Resources_0 = \{r_0,r_1,...,r_9\}$)}}\\
\toprule
& Resource   & Waste   & Direct-Envy   & Indirect-Envy    & Total       \\
\hline
DRC & 3.64$\pm$3.548  & 0.51$\pm$1.109      & 0.0$\pm$0.0       & 38.9$\pm$13.195   & 43.05$\pm$15.481    \\
DMC & 0.0$\pm$0.0     & 0.0$\pm$0.0         & 0.0$\pm$0.0       & 0.04$\pm$0.196    & 0.04$\pm$0.196      \\
DUC & 0.0$\pm$0.0     & 3427.23$\pm$399.947 & 0.0$\pm$0.0       & 0.0$\pm$0.0       & 3427.23$\pm$399.947 \\
RSD & 0.0$\pm$0.0     & 0.0$\pm$0.0         & 635.65$\pm$81.564 & 257.12$\pm$58.736 & 892.77$\pm$113.301  \\
% CSD & 0.0$\pm$0.0     & 0.0$\pm$0.0         & 0.0$\pm$0.0       & 0.0$\pm$0.0       & 0.0$\pm$0.0         \\
\toprule
\end{tabular}
\label{tab:blocking_contracts_ten_resources}
}
\end{table}

% \subsection{Matched Students}

% The first experiment focuses on students. We look at two measures: the total number of matched students per mechanism and the distribution of students per college that each of the mechanisms produces. \Cref{fig:matched_students} presents the results of the first metric. Remark how mechanisms are robust to the alignment of students and colleges preferences. Moreover, except for DUC, all mechanisms manage to match most of the students to a college, getting closer to $100\%$ when the number of resources increases, as the instances become less restrictive.

% % \begin{minipage}{0.95\textwidth}
% \begin{figure}[h]
% \centering
% \includegraphics[scale = 0.5]{EC25/Images/Number_matched_students.pdf}
% \hspace{1cm}\caption{Average number of matched students over synthetic markets with variable number of types of resources. For each value of $|{\Resources_0}| \in [10]$, we simulated $100$ markets of each kind.}
% \label{fig:matched_students}
% \end{figure}
% % \end{minipage}

% \Cref{fig:matched_students_distribution} presents the distribution of matched students over colleges. For ease of exposition, we compare a horizontal market against a student-vertical market only. The colored shades represent the number of students per college. Remark how all mechanisms get biased toward the most preferred colleges when students have aligned preferences. 
% % to be completed when we get the figures

% \begin{figure}[h]
%     \centering
%     % \includegraphics[width=0.5\linewidth]{}
%     \caption{Distribution of matched students per colleges over synthetic markets with variable number of resources and two colleges. For each value of $|{\Resources_0}| \in [10]$, we simulated $100$ markets of each kind.}
%     \label{fig:matched_students_distribution}
% \end{figure}

% {\color{red}I don't see Fig 2}

% % \begin{minipage}{0.9\textwidth}
% % \begin{table}[H]
% % \small{
% % \caption{
% % Average number of matched students over synthetic markets with variable number of resources. For each value of $|{\Resources}_| \in [10]$, we simulated $100$ markets of each kind.}
% % \centering
% % \begin{tabular}{c|ccccc}
% % \toprule
% %     \multirow{2}{*}{$|{\Resources}|$} & \multicolumn{5}{c}{\textbf{Matched Students}} \\
% %      &   DRC &   DMC &   DUC &   RSD &   CSD \\
% %     \toprule
% %   1 & 89.88$\pm$4.92 & 89.87$\pm$4.99 & 59.38$\pm$24.05 & 90.06$\pm$5.04 & 89.55$\pm$5.04 \\
% %   2 & 90.29$\pm$4.48 & 90.07$\pm$4.51 & 39.14$\pm$20.06 & 89.84$\pm$5.22 & 89.61$\pm$4.8  \\
% %   3 & 89.53$\pm$5.17 & 89.34$\pm$5.42 & 30.79$\pm$16.05 & 88.68$\pm$4.9  & 89.03$\pm$5.04 \\
% %   4 & 89.49$\pm$4.55 & 89.44$\pm$4.67 & 25.91$\pm$12.6  & 89.02$\pm$4.13 & 89.01$\pm$4.28 \\
% %   5 & 90.01$\pm$4.91 & 89.99$\pm$4.74 & 26.29$\pm$11.27 & 89.33$\pm$5.04 & 89.31$\pm$5.2  \\
% %   6 & 90.01$\pm$4.6  & 89.92$\pm$4.57 & 23.14$\pm$10.25 & 89.09$\pm$4.57 & 89.45$\pm$4.37 \\
% %   7 & 90.41$\pm$5.06 & 90.13$\pm$5.05 & 24.87$\pm$9.85  & 89.97$\pm$5.02 & 90.21$\pm$4.74 \\
% %   8 & 89.17$\pm$4.82 & 89.01$\pm$4.77 & 22.16$\pm$8.19  & 88.38$\pm$4.9  & 88.69$\pm$5.25 \\
% %   9 & 89.97$\pm$4.62 & 89.82$\pm$4.52 & 21.81$\pm$7.43  & 89.39$\pm$4.65 & 89.45$\pm$4.4  \\
% %   10 & 89.87$\pm$5.06 & 89.51$\pm$5.05 & 21.58$\pm$8.04  & 89.0$\pm$4.88  & 89.05$\pm$4.98 \\
% % \toprule
% % \end{tabular}
% % \label{tab:matched_students}}
% % \end{table}
% % \end{minipage}

% \subsection{Resources Allocation}

% The second experiment focuses on the resources. As for matched students, we look at two measures: the percentage of allocated resources per mechanism and the distribution of resources per college that each of the mechanisms produces. \Cref{fig:resources_allocated} presents the percentage of resources allocated. For $|{\Resources}_0| = 1$, i.e., no resources, by convention we show a $100\%$ of the resources as allocated. 

% \begin{figure}[h]
%     \centering
%     \includegraphics[scale = 0.5]{EC25/Images/Percentage_allocated_resources.pdf}
%     \caption{Average number of allocated resources over synthetic markets with variable number of types of resources. For each value of $|{\Resources}_0| \in [10]$, we simulated $100$ markets of each kind.}
%     \label{fig:resources_allocated}
% \end{figure}

% \Cref{fig:resources_allocated_distribution} represents the distribution of resources allocated over colleges. Once again, we have compared a horizontal market and a student-vertical market. As for the number of matched students, the mechanisms benefit the most prefered colleges.

% \begin{figure}[h]
%     \centering
%     % \includegraphics[width=0.5\linewidth]{}
%     \caption{Distribution of allocated resources per colleges over synthetic markets with variable number of types of resources and two colleges. For each value of $|{\Resources}_0| \in [10]$, we simulated $100$ markets of each kind.}
%     \label{fig:resources_allocated_distribution}
% \end{figure}

% % \begin{table}[H]
% % \small{
% % \caption{
% % % Comparison of the average performance of the five mechanisms over synthetic markets with different number of resources. For each value $|{\Resources}| \in [10]$, we simulated $100$ markets, each of them with $100$ students, $10$ colleges, random regions partitions, random quotas (both for colleges and resources), and random preferences. Remark we present the \textit{blocking students} and not blocking contracts, in order to avoid over-representation, i.e., for any student present in more than one blocking contract of the same type, we only counted her once. The column \textit{Total} considers the sum of resource, waste, and direct-envy blocking students. Finally, we have ommited the results whenever an algorithm presents zero blocking pairs of a kind.
% % }
% % \centering
% % \begin{tabular}{c|ccccc}
% % \toprule
% %     \multirow{2}{*}{$|{\Resources}|$} & \multicolumn{5}{c}{\textbf{Percentage of Allocated Resources}} \\
% %      &   DRC &   DMC &   DUC &   RSD &   CSD \\
% %     \toprule
% %   1 & 65.48$\pm$27.43 & 68.2$\pm$27.44  & 68.78$\pm$27.16 & 68.65$\pm$27.59 & 68.41$\pm$27.48 \\
% %   2 & 75.77$\pm$21.79 & 77.66$\pm$21.14 & 54.84$\pm$24.68 & 77.85$\pm$20.65 & 77.81$\pm$21.69 \\
% %   3 & 81.97$\pm$16.67 & 83.39$\pm$16.22 & 50.74$\pm$23.18 & 83.63$\pm$16.3  & 83.66$\pm$16.22 \\
% %   4 & 84.35$\pm$17.07 & 86.25$\pm$16.48 & 46.92$\pm$21.1  & 85.38$\pm$16.87 & 85.67$\pm$16.6  \\
% %   5 & 83.97$\pm$15.38 & 85.42$\pm$15.11 & 45.45$\pm$20.71 & 85.59$\pm$14.58 & 85.71$\pm$14.92 \\
% %   6 & 86.79$\pm$14.55 & 88.64$\pm$13.63 & 41.89$\pm$16.23 & 87.36$\pm$14.04 & 87.82$\pm$14.11 \\
% %   7 & 86.05$\pm$12.57 & 86.93$\pm$12.11 & 40.3$\pm$17.04  & 86.39$\pm$12.52 & 86.76$\pm$12.37 \\
% %   8 & 89.04$\pm$12.65 & 90.09$\pm$11.96 & 41.37$\pm$16.17 & 90.23$\pm$11.95 & 89.89$\pm$12.59 \\
% %   9 & 89.62$\pm$10.41 & 90.6$\pm$9.81   & 41.05$\pm$16.96 & 89.67$\pm$10.35 & 90.04$\pm$10.42 \\
% %   10 & 90.96$\pm$9.96  & 91.66$\pm$9.86  & 41.3$\pm$15.36  & 91.85$\pm$9.55  & 91.7$\pm$10.06  \\
% % \toprule
% % \end{tabular}
% % \label{tab:my_label}}
% % \end{table}

% \subsection{Blocking Contracts}

% The third experiments studies the stability of each mechanism by looking at the number of blocking contracts under the produced matchings. We split the analysis depending on the type of blocking contract considered.

% \subsubsection{Resource-efficiency}

% As proved in \Cref{prop:no_re_des_mechanism}, there is no direct-envy-free and resource efficient mechanism. In particular, DRC and DMC, as illustrated in \Cref{fig:resource_efficiency}, produce matchings with resource-blocking contracts. Interesting, DMC becomes resource-efficient whenever the market presents (any) alignment of preferences. 

% \begin{figure}[h]
%     \centering
%     \includegraphics[scale = 0.5]{EC25/Images/Number_resource_blocking_contracts.pdf}
%     \caption{Average number of resource-blocking contracts of the matching produced by the different mechanisms. For each value of $|{\Resources}_0| \in [10]$, we simulated $100$ markets of each kind.}
%     \label{fig:resource_efficiency}
% \end{figure}

% \subsubsection{Non-wastefulness}

% The existence of waste-blocking contracts is strongly affected by the resources quotas as in order to allocate the available seat of a college to a student, the policy maker must also be able to allocated her a resource. In particular, non-wastefulness cannot be obtained by students alignment on preferences, as \Cref{fig:non_wastefulness} illustrates. Please remark we have omitted DUC from the figures as its number of waste-blocking contracts is too large with respect to the other mechanisms, making hard to read the results. In exchange, mechanisms presenting wasting improve their performance whenever colleges have the same rank for students.

% \begin{figure}[h]
%     \centering
%     \includegraphics[scale = 0.5]{EC25/Images/Number_waste_blocking.pdf}
%     \caption{Average number of waste-blocking contracts of the matching produced by the different mechanisms. For each value of $|{\Resources}_0| \in [10]$, we simulated $100$ markets of each kind.}
%     \label{fig:non_wastefulness}
% \end{figure}

% \subsubsection{Direct-envy stable}

% DMC, DRC, and DUC are direct-envy stable (\Cref{prop:DRC_DMC_des,prop:properties_DUC}). Interestingly, the controlled serial dictatorship mechanism becomes direct-envy-free as well whenever colleges present preferences alignment, as illustrated in \Cref{fig:direct_envy_freness}.

% \begin{figure}[h]
%     \centering
%     \includegraphics[scale = 0.5]{EC25/Images/Number_direct_envy_blocking_contracts.pdf}
%     \caption{Average number of direct-envy-blocking contracts of the matching produced by the different mechanisms. For each value of $|{\Resources}_0| \in [10]$, we simulated $100$ markets of each kind.}
%     \label{fig:direct_envy_freness}
% \end{figure}

% \subsubsection{Envy-freness}

% Among the mechanisms considered in this article, only DUC is envy-free (\Cref{prop:properties_DUC}). Surprisingly, both DMC and CSD become envy-free as well when colleges present preferences alignment, as illustrated in \Cref{fig:envy_freness}.



% \begin{figure}[h]
%     \centering
%     \includegraphics[scale = 0.5]{EC25/Images/Number_envy_blocking_contracts.pdf}
%     \caption{Average number of envy-blocking contracts of the matching produced by the different mechanisms. For each value of $|{\Resources}_0| \in [10]$, we simulated $100$ markets of each kind.}
%     \label{fig:envy_freness}
% \end{figure}




% % \begin{minipage}{0.99\textwidth}
% % \begin{table}[H]
% % \small{
% % \caption{Comparison of the average performance of the five mechanisms over synthetic markets with different number of resources. For each value $|{\Resources}| \in [10]$, we simulated $100$ markets, each of them with $100$ students, $10$ colleges, random regions partitions, random quotas (both for colleges and resources), and random preferences. Remark we present the \textit{blocking students} and not blocking contracts, in order to avoid over-representation, i.e., for any student present in more than one blocking contract of the same type, we only counted her once. The column \textit{Total} considers the sum of resource, waste, and direct-envy blocking students. Finally, we have omitted the results whenever an algorithm presents zero blocking pairs of a kind.}
% % \centering
% % \begin{tabular}{c|cc|ccc|cc}
% % \toprule  
% %     \multirow{2}{*}{$|{\Resources}|$} & \multicolumn{2}{c|}{\textbf{Resource-Blocking}} & \multicolumn{3}{c|}{\textbf{Waste-Blocking}} & \multicolumn{2}{c}{\textbf{Direct-Envy-Blocking}}\\
% %     & DRC & DMC & DRC & DMC & DUC & RSD & CSD\\
% %     \toprule
% %   1 & 0.25$\pm$0.5  & 0.0$\pm$0.0   & 0.3$\pm$0.62  & 0.39$\pm$0.72 & 52.77$\pm$29.86 & 41.68$\pm$8.77 & 9.02$\pm$4.35  \\
% %   2 & 0.21$\pm$0.65 & 0.02$\pm$0.2  & 0.79$\pm$1.09 & 0.84$\pm$1.11 & 84.89$\pm$18.24 & 43.53$\pm$8.56 & 11.53$\pm$4.82 \\
% %   3 & 0.29$\pm$0.67 & 0.04$\pm$0.24 & 0.88$\pm$1.09 & 0.91$\pm$1.08 & 92.5$\pm$10.28  & 45.79$\pm$8.92 & 11.77$\pm$5.82 \\
% %   4 & 0.37$\pm$0.86 & 0.04$\pm$0.24 & 0.96$\pm$1.1  & 0.86$\pm$1.01 & 96.75$\pm$5.98  & 46.38$\pm$7.4  & 11.68$\pm$5.56 \\
% %   5 & 0.36$\pm$0.7  & 0.0$\pm$0.0   & 1.22$\pm$1.25 & 0.97$\pm$1.16 & 96.21$\pm$5.79  & 45.39$\pm$8.32 & 12.03$\pm$5.07 \\
% %   6 & 0.39$\pm$0.81 & 0.07$\pm$0.32 & 1.08$\pm$1.14 & 0.98$\pm$1.17 & 98.06$\pm$4.62  & 46.54$\pm$8.7  & 13.21$\pm$5.18 \\
% %   7 & 0.28$\pm$0.71 & 0.03$\pm$0.3  & 1.02$\pm$1.28 & 1.22$\pm$1.29 & 97.07$\pm$5.12  & 45.43$\pm$8.26 & 13.21$\pm$4.8  \\
% %   8 & 0.3$\pm$0.69  & 0.02$\pm$0.14 & 1.27$\pm$1.26 & 1.3$\pm$1.23  & 97.33$\pm$3.6   & 49.03$\pm$7.59 & 14.7$\pm$5.14  \\
% %   9 & 0.25$\pm$0.7  & 0.08$\pm$0.39 & 1.41$\pm$1.54 & 1.22$\pm$1.21 & 97.56$\pm$3.74  & 47.53$\pm$8.2  & 14.7$\pm$5.62  \\
% %   10 & 0.25$\pm$0.64 & 0.08$\pm$0.39 & 1.27$\pm$1.25 & 1.22$\pm$1.29 & 97.06$\pm$4.31  & 47.38$\pm$8.55 & 14.13$\pm$5.61 \\
% % \toprule
% % \end{tabular}
% % \label{tab:my_label}}
% % \end{table}
% % \end{minipage}

% % \begin{table}[H]
% % \small{
% % \caption{
% % % Comparison of the average performance of the five mechanisms over synthetic markets with different number of resources. For each value $|{\Resources}| \in [10]$, we simulated $100$ markets, each of them with $100$ students, $10$ colleges, random regions partitions, random quotas (both for colleges and resources), and random preferences. Remark we present the \textit{blocking students} and not blocking contracts, in order to avoid over-representation, i.e., for any student present in more than one blocking contract of the same type, we only counted her once. The column \textit{Total} considers the sum of resource, waste, and direct-envy blocking students. Finally, we have omitted the results whenever an algorithm presents zero blocking pairs of a kind.
% % }
% % \centering
% % \begin{tabular}{c|ccccc}
% % \toprule
% %     \multirow{2}{*}{$|{\Resources}|$} & \multicolumn{4}{c}{\textbf{Envy-Blocking}}\\
% %     & DRC &   DMC &  RSD &   CSD  \\
% %     \toprule
% %   1 & 2.62$\pm$3.03 & 0.58$\pm$1.18 & 4.26$\pm$5.43   & 0.48$\pm$0.75 \\
% %   2 & 3.07$\pm$2.86 & 0.98$\pm$1.33 & 6.7$\pm$7.12    & 1.2$\pm$1.56  \\
% %   3 & 3.43$\pm$3.56 & 1.19$\pm$1.72 & 6.94$\pm$7.63   & 1.13$\pm$1.65 \\
% %   4 & 3.79$\pm$4.01 & 1.26$\pm$1.32 & 7.71$\pm$8.63   & 1.33$\pm$1.93 \\
% %   5 & 3.97$\pm$3.72 & 1.52$\pm$1.57 & 9.86$\pm$10.06  & 1.22$\pm$1.8  \\
% %   6 & 3.74$\pm$3.42 & 1.48$\pm$1.86 & 11.11$\pm$10.36 & 1.88$\pm$2.91 \\
% %   7 & 4.08$\pm$4.37 & 1.3$\pm$1.52  & 11.6$\pm$9.65   & 2.12$\pm$2.45 \\
% %   8 & 3.51$\pm$3.15 & 1.29$\pm$1.46 & 11.2$\pm$11.06  & 2.3$\pm$2.86  \\
% %   9 & 4.23$\pm$4.56 & 1.68$\pm$1.82 & 10.94$\pm$11.28 & 2.99$\pm$3.86 \\
% %   10 & 3.41$\pm$3.11 & 1.42$\pm$2.0  & 10.73$\pm$11.92 & 2.22$\pm$3.19 \\
% % \toprule
% % \end{tabular}}
% % \end{table}

\section{Conclusion}\label{sec:conclusion}

In this paper, we introduce a novel kind of distributional constraints, a resource-regional caps (RRC). Its main distinctive features, described in the context of a college admissions, are the presence of multiple resources (close substitutes) that students care about during the admission procedure, together with an option for a student to be admitted to a college without any resource. 

We present the stability of a matching under RRC framework by dividing it into three separate concepts: no (justified) envy, no waste, and resource-efficiency. Since a stable matching may not exist in general, we propose three weaker versions of stability that restore existence: envy-freeness (no envy and resource-efficiency), non-wastefulness (no waste and resource-efficiency), and direct-envy stability. The first two versions care about containing, respectively, absolutely no envy, and absolutely no waste (it turns out that both agendas are compatible with resource-efficiency). The latter version is based on the idea of a direct envy of one student towards another, which arises if the second student, object of envy, has everything that the first one, subject of envy, requests. A direct-envy stable matching does not tolerate direct envy and any waste or resource inefficiency that does not create more direct envy upon being resolved. We show that direct-envy stability is incompatible with resource-efficiency, i.e., there exists a market without a resource-efficient direct-envy stable matching.

For each weaker version of stability we design at least one corresponding mechanism: Decreasing Uniform Cutoffs (DUC) for envy-freeness, Random or Controlled Serial Dictatorships (RSD and CSD) for non-wastefulness, and Decreasing Random or Maximal Cutoffs (DRC and DMC) for direct-envy stability. CSD and DMC are designed to be more stable (on average) versions of, correspondingly, RSD and DRC. 

In addition, we test stability performances of all five mechanisms under (i) different numbers of non-empty resources types, and (ii) four types of markets: horizontal, college-vertical, student-vertical, and fully vertical. As a result, theoretical and numerical findings suggest that, under no alignment of colleges' preferences, DMC is the most stable on average, while otherwise, CSD appears to be stable and strategy-proof mechanism. Thus, given that in the real world most markets have no perfect alignment of preferences, DMC is the go-to mechanism for maximizing stability of the resulting matching under RRC constraints.

Finally, we propose some potential avenues for the future research on RRC. Is it possible to strengthen the stability of existing matchings beyond the direct-envy stability? If yes, which types of blocking contracts are guaranteed to be absent under proposed stronger notion of stability? Going back to real-life motivation, french college admissions not only operate with common dormitories but also use affirmative action \citep{sokolov25}, while there is no (at least known to us) research that combines these two features. Also, recently \citet{cho22} proved that under hereditary constraints, no mechanism can be weakly stable and strategy-proof. However, it is an open question whether a weakly stable and strategy-proof mechanism exists for markets under resource-regional caps, which do not satisfy heredity. Withal, it would be interesting to look for a lattice-like structure on the set of feasible or stable matchings under RRC.

% Now consider the following cutoff minimizing mechanism CUTS$^\searrow$.

% \begin{itemize}
%     \item \textbf{Step $0$.} Set $\Cutoffs[0]$, such that $\mu(\Cutoffs[0])$ is feasible. By default, $\Cutoffs[0] = \{\{t^c_i\}_{i\in\{0,1,\dots,m\}}\}_{c\in\Colleges}$, such that $t^c_i=\overline{v}_c+1$ for all $c\in\Colleges$ and $i\in\{0,1,\dots,m\}$, i.e., no contract can be included into a matching. Also, set $C=\Colleges$, go to Step 1.

%     \item \textbf{Step $k$ ($k\geq 1$).} If $|C|>0$, pick some college $c$ from $C$, and set $C=C\backslash\{c\}$. Otherwise, if $\Cutoffs[k-1]\neq\Cutoffs[k-1-|\Colleges|]$, pick some college $c$ from $\Colleges$, and set $C=\Colleges\backslash\{c\}$.\footnote{There could be many ways of picking $c$.} Otherwise, calculate the final matching CUTS$^\searrow(\succ_{\Students})=\mu(\Cutoffs[k-1])$, end the procedure.\footnote{If $|C|=0$ and $\Cutoffs[k-1]=\Cutoffs[k-1-|{\Colleges}|]$, i.e., all cutoffs for all colleges stayed the same over the last $|\Colleges|$ steps.}
    
%      Once some college $c$ is picked, set $\Cutoffs[k-1][c,\max+1]=\{\}$, go to Sub-step $k.0$.

%     \begin{itemize}
%         \item \textbf{Sub-step $k.\ell$ ($\ell \geq 0$).} Take all maximal cutoffs of $c$ from 
%         $$\mathbf{T}_\ell=\Cutoffs[k-1] \backslash\left(\bigcup_{n=-1}^{(l-1)} \Cutoffs[k-1][c,\max-n]\right),$$ 
%         $\Cutoffs[k-1][c,\max-\ell]=\{t^c_i\in \mathbf{T}_\ell\:|\: t^c_i\geq t^c_j \text{ for any } t^c_j\in \mathbf{T}_\ell\}$. If cutoffs from $\Cutoffs[k-1][c,\max-\ell]$ are minimal (i.e., all equal to 1), set $\Cutoffs[k]=\Cutoffs[k-1]$, go to Step (k+1). Otherwise, if matching $\mu((\Cutoffs[k-1]\backslash \Cutoffs[k-1][c,\max-\ell])\cup(\Cutoffs[k-1][c,\max-\ell] -\mathbf{1}))$ is feasible, set $\Cutoffs[k]=(\Cutoffs[k-1]\backslash \Cutoffs[k-1][c,\max-\ell])\cup(\Cutoffs[k-1][c,\max-\ell] -\mathbf{1})$, go to Step (k+1). Otherwise, consider a contract $(s,c,r_i)$ with value $v_{(s,c,r_i)}=t^c_i-1$, where $t^c_i\in \Cutoffs[k-1][c,\max-\ell]$. If $i=0$, set $\Cutoffs[k]=\Cutoffs[k-1]$, go to Step (k+1). Otherwise, if $|\Cutoffs[k-1][c,\max-\ell]|>1$, set $\Cutoffs[k]=(\Cutoffs[k-1]\backslash (\Cutoffs[k-1][c,\max-\ell]\backslash\{t^c_i\}))\cup((\Cutoffs[k-1][c,\max-\ell]\backslash\{t^c_i\}) -\mathbf{1})$, go to Step ($k+1$). Otherwise, go to Sub-step $k.(\ell+1)$.\footnote{Step $k$ will eventually end since sooner or later we will consider $\Cutoffs[k-1][c,\max-\ell]$ that contains the lowest cutoffs of $c$, thus, also containing $t^c_0$.}
    
%     \end{itemize}
% \end{itemize}

% \begin{algorithm}[ht]
% \SetAlgoNoLine
% \KwIn{An RRC $\langle \Students,\Colleges,\Resources, \{P(r)\}_{r\in \Resources\backslash \{r_0\}}, \{q^c\}_{c\in \Colleges}, \{\{p^r_i\}_{i\in\{1,\dots,|P(r)|\}}\}_{r\in \Resources\backslash \{r_0\}}, \{\succ_c\}_{c\in\Colleges}, \succ \rangle.$}
% \KwOut{A direct-envy stable matching}

% \textbf{Initialization} : $\Cutoffs[0] \longleftarrow \{\{\overline{v}_c+1\}_{i\in\{0,1,\dots,m\}}\}_{c\in\Colleges}$ or any $\Cutoffs[0]$ such that $\mu(\Cutoffs[0])$ is feasible, $C \longleftarrow \Colleges$.

% \For{}{
% }
% \caption{Decreasing Cutoff Mechanism CUTS$^\searrow$}
% \label{alg:decreasing_cutoff}
% \end{algorithm}

%  In words, mechanism CUTS$^\searrow$ works as follows. At Step $0$ we set up cutoffs that induce a feasible matching. Then, at each Step $k$ we randomly pick any college $c$ that was not considered before (starting from the point where we picked the last available college and started over), and at each Sub-step $k.\cdot$ we pick the set of maximal cutoffs of $c$ among not previously considered cutoffs of $c$ during Sub-steps $k.\cdot$, and try to decrease the maximal number of them by one in order to get a feasible matching (making sure that the empty cutoff is always the lowest). If it is possible during some Sub-step $k.\cdot$, we decrease these cutoffs by one and switch to the next Step $(k+1)$. Otherwise, i.e., if no cutoff of $c$ can be decreased by one to get a feasible matching, we just switch to the next Step $(k+1)$. The procedure ends if all cutoffs for all colleges stayed the same over the last $|\Colleges|$ steps, where each of these steps considered different college.
 
% \begin{proposition}
%     CUTS and CUTS$^\searrow$ are direct-envy stable.
% \end{proposition}

% \begin{proof}
%     By construction, the resulting matching in both mechanisms is induced by a set of cutoffs, such that, for each college holds, that none of its cutoffs can be reduced by one in order to get a feasible matching (making sure that the empty cutoff is always the lowest). Take such matching $\mu$.
    
%     If $(s,c,r)\in \mu$, then any $(s',c,r)$, such that $s'\succ_c s$ could have been included into $\mu$. Moreover, if $(s,c,r_0)\in \mu$, then any $(s',c,r)$, such that $r\in\Resources$ and $s'\succ_c s$ could have been included into $\mu$ Therefore, there are no direct-envy-blocking contracts under $\mu$.

%     Now suppose that there is a waste-blocking contract $(s,c,r)$ under $\mu$. We show that $r\neq r_0$. Since $c$ has an open seat, if $r=r_0$, then we would get feasible matching my setting $t^c_0=v_{(s,c,r)}$, thus, $\mu$ cannot be the resulting matching of CUTS or CUTS$^\searrow$. Contradiction.
    
%     Now we show that $(s,c',r)\in \mu$, where $\{c,c'\}\subseteq C^r_i$. Note that all resource $r$'s units should be distributed in $C^r_i$. Suppose otherwise, i.e., college $c$ has an empty seat and can get a unit of $r$. Since $\mu$ is induced by minimized set of cutoffs, there is no blocking contract with college $c$ and an empty recourse $r_0$. Therefore, there should exist a waste-blocking contract $x$ containing $c$ and $r$ (it is either $(s,c,r)$ or some contract with higher rank at $c$), such that, if we set $t^c_{0}=t^c_r=v_x$, we induce a feasible matching different from $\mu$, thus, $\mu$ cannot be the resulting matching of CUTS or CUTS$^\searrow$. Contradiction. As a result, for $(s,c,r)$ to be waste-blocking, $s$ should be admitted with $r$ to some college in the same region for $r$ as $c$. 

%     Finally, we show that $x\neq(s,c,r)$, which implies that $(s,c,r)$ is dominated. Suppose that $x=(s,c,r)$, then if we set $t^c_{0}=t^c_r=v_{(s,c,r)}$, we induce a feasible matching different from $\mu$, thus, $\mu$ cannot be the resulting matching of CUTS or CUTS$^\searrow$. Contradiction.

%     Thus, $\mu$ is direct-envy stable.
% \end{proof}

% \begin{proposition}\label{prop:CUTS_not_strategy-proof}
%     CUTS and CUTS$^\searrow$ are not strategy-proof, and do not always find a stable matching whenever one exists.
% \end{proposition}

% \begin{proof}
%     CUTS and CUTS$^\searrow$ work the same for the example below.
    
%     Consider a market with two students, two colleges, and one resource. Corresponding region contains both colleges. Quotas are $q^{c_1}=q^{c_2}=p^r=1$. Preferences are:

%     \begin{table}[H]
%         \centering
%         \begin{tabular}{l c c}
%             $\succ_{s_1}: (c_2,r),(c_1,r),\emptyset$ &  & $\succ_{c_1}: s_2,s_1$\\
%             $\succ_{s_2}: (c_2,r),\emptyset$ &  & $\succ_{c_2}: s_2,s_1$
%         \end{tabular}
%     \end{table}

%      Thus, induced preferences of colleges over pairs are: 

%     \begin{table}[H]
%         \centering
%         \begin{tabular}{l}
%             $\succ_{c_1}: (s_1,r),\emptyset$\\
%             $\succ_{c_2}: (s_2,r),(s_1,r),\emptyset$
%         \end{tabular}
%     \end{table}

%      Suppose, during Step 1 we choose $c_1$. Thus, CUTS$^\searrow(\succ_{\Students})=\{(s_1,c_1,r)\}$. Note that there is only one stable matching $\{(s_2,c_2,r)\}$. Therefore, CUTS and CUTS$^\searrow$ do not always find a stable matching whenever one exists.

%      Now, suppose that student $s_2$ lies about her preferences: $\succ'_{s_2}: (c_2,r),(c_1,r),\emptyset$.  Thus, induced preferences of colleges over pairs are: 

%     \begin{table}[H]
%         \centering
%         \begin{tabular}{l}
%             $\succ'_{c_1}: (s_2,r),(s_1,r),\emptyset$\\
%             $\succ'_{c_2}: (s_2,r),(s_1,r),\emptyset$
%         \end{tabular}
%     \end{table}

%      During Step 1 we choose $c_1$, hence, during Step 2 we choose $c_2$. Thus, CUTS$^{\searrow}(\succ_{s_1},\succ'_{s_2})=\{(s_2,c_2,r)\}\succ_{s_2}\{(s_1,c_1,r)\}=$ CUTS$^\searrow(\succ_{\Students})$. Thus, CUTS and CUTS$^\searrow$ are not strategy-proof for students.
% \end{proof}

% \begin{conjecture}
%     In expectation, MDC$(\succ_{\Students})$ has less blocking contracts than RDC$(\succ_{\Students})$.
% \end{conjecture}

% \subsection{CUT, CUT$^{\nearrow\searrow}$}

%  A feasible matching is called \textbf{envy-free} if it is IR, and any blocking contract is waste-blocking. Envy-free matchings are useful in many contexts (see \citet{kamada24}). Note that an empty matching is envy-free in our model. Thus, the existence of an envy-free matching is trivial.

% \begin{definition}
%     A feasible matching $\mu$ is \textbf{min-cutoff envy-free} if (i) it is induced by a set of cutoffs $\Cutoffs=\{\Cutoffs[][c]\}_{c\in\Colleges}$, such that for each college $c\in\Colleges$ all its cutoffs from $\Cutoffs[][c]$ are equal to each other, and (ii) $\mu((\Cutoffs\backslash\Cutoffs[][c])\cup(\Cutoffs[][c]-\mathbf{1}))$ is not feasible for any $c\in\Colleges$ with not minimal cutoffs.
% \end{definition}

% A mechanism is \textbf{min-cutoff envy-free} if it produces a min-cutoff envy-free matching for any $\succ_{\Students}$. Note, that for any college we require all its cutoffs to be equal to each other, as if there is only one general cutoff for any college. Therefore, any min-cutoff envy-free matching is envy-free, since if some contract is chosen, then any better contract for this college could have been chosen, which eliminates the possibility for existence of any envy-blocking contract.

% For any subset of cutoffs $\mathbf{T}$, denote by $(\mathbf{T}+\mathbf{1})$ the set where each cutoff $t^c_i\in \mathbf{T}$ smaller than $(\overline{v}_c+1)$ is increased by 1, while each maximal cutoff stays so. Consider the following mechanism CUT$^{\nearrow\searrow}$.

% \begin{itemize}
%     \item \textbf{Step $1.0$.} Set $\Cutoffs[0] = \{\{t^c_i\}_{i\in\{0,1,\dots,m\}}\}_{c\in\Colleges}$, such that $t^c_i=1$ for all $c\in\Colleges$ and $i\in\{0,1,\dots,m\}$, i.e., all contracts can be included into a matching. If $\mu(\Cutoffs[0])$ is feasible, set the final matching CUT$^{\nearrow\searrow}(\succ_{\Students})=\mu(\Cutoffs[0])$, end the procedure. Otherwise, set $flag=-1$, go to Step $1$.

%     \item \textbf{Step $1.k$ ($k\geq1$).} If all cutoffs for each college are maximal (i.e., for each $c\in\Colleges$ all equal to $(\overline{v}_c+1)$), denote them by $\Cutoffs[0][']$, go to Step $2.0$. Otherwise, if $flag=0$, pick some college $c$ from $\Colleges$, such that its cutoffs are not maximal, set $\Cutoffs[k]=(\Cutoffs[k-1]\backslash \Cutoffs[k-1][c])\cup(\Cutoffs[k-1][c] +\mathbf{1})$ and $flag=-1$, go to Step $1.(k+1)$. Otherwise, if $flag=1$, denote $\Cutoffs[0]'=(\Cutoffs[k-1]\backslash \Cutoffs[k-1]['c])\cup(\Cutoffs[k-1]['c] +\mathbf{1})$,  go to Step $2.0$. Otherwise, go to Sub-step $1.k.1$.

%     \begin{itemize}
%         \item \textbf{Sub-step $1.k.\ell$ ($1\leq \ell\leq|\mathcal{C}|$).} Pick some college $c$ from $\Colleges$ that was not picked before during Step $k$. If there is no such college, set $flag=0$, go to Step $k$. Otherwise, take all cutoffs of $c$, $\Cutoffs[k-1][c]=\{t^c_i\in \Cutoffs[k-1]\}$. If all cutoffs from $\Cutoffs[k-1][c]$ are maximal (i.e., all equal to $(\overline{v}_c+1)$), go to Sub-step $1.k.(\ell+1)$. Otherwise, if $\mu((\Cutoffs[k-1]\backslash \Cutoffs[k-1][c])\cup(\Cutoffs[k-1][c] +\mathbf{1}))$ is feasible, set $flag=1$, go to Step $k$. Otherwise, go to Sub-step $1.k.(\ell+1)$.
%     \end{itemize}

%     \item \textbf{Step $2.0$.} Set $C=\Colleges$. Go to Step $2.1$.

%     \item \textbf{Step $2.k$ ($k\geq1$).} If $|C|>0$, pick some college $c$ from $C$, and set $C=C\backslash\{c\}$, go to Sub-step $2.k.1$. Otherwise, if $\Cutoffs[k-1][']\neq\Cutoffs[k-1-|\Colleges|][']$, pick some college $c$ from $\Colleges$, and set $C=\Colleges\backslash\{c\}$, go to Sub-step $2.k.1$.\footnote{There could be many ways of picking $c$.} Otherwise, calculate the final matching CUT$^{\nearrow\searrow}(\succ_{\Students})=\mu(\Cutoffs[k]['])$, end the procedure.\footnote{If $|C|=0$ and $\Cutoffs[k-1][']=\Cutoffs[k-1-|{\Colleges}|][']$, i.e., all cutoffs for all colleges stayed the same over the last $|{\Colleges}|$ steps.}

%     \begin{itemize}
%         \item \textbf{Sub-step $2.k.1$.} Take all current cutoffs of $c$, $\Cutoffs[k-1]['c]$. If cutoffs from $\Cutoffs[k-1]['c]$ are minimal (i.e., all equal to 1), set $\Cutoffs[k][']=\Cutoffs[k-1][']$, go to Step $2.(k+1)$. Otherwise, if matching $\mu((\Cutoffs[k-1][']\backslash \Cutoffs[k-1]['c])\cup(\Cutoffs[k-1]['c] -1))$ is feasible, set $\Cutoffs[k][']=(\Cutoffs[k-1][']\backslash \Cutoffs[k-1]['c])\cup(\Cutoffs[k-1]['c] -\mathbf{1})$, go to Step $2.(k+1)$. Otherwise, set $\Cutoffs[k][']=\Cutoffs[k-1][']$, go to Step $2.(k+1)$.
%     \end{itemize}
% \end{itemize}

%  In words, mechanism CUT$^{\nearrow\searrow}$ works as follows. At Step $1.0$ we set all cutoffs to be minimal, i.e., any contract can be chosen by students. Then, at each Step $1.k$ we check for each college one by one (at each Sub-step $1.k.\cdot$), whether we can increase all its cutoffs by one and obtain a feasible matching. If it is not possible for all colleges, we randomly choose one of them, increase all its cutoffs by one, and switch to the next Step $1.(k+1)$. Otherwise, if we can obtain a feasible matching, we increase all cutoffs of the found college by one, and switch to the Step $2.0$. 

%  During each Step $2.k$ we randomly pick any college $c$ that was not considered before (starting from the point where we picked the last available college and started over) and try to decrease all its cutoffs by one in order to get a feasible matching. If it is possible, we decrease these cutoffs by one and switch to the next Step $2.(k+1)$. Otherwise, i.e., if all cutoffs of $c$ cannot be decreased by one to get a feasible matching, we just switch to the next Step $2.(k+1)$. The procedure ends if all cutoffs for all colleges stayed the same over the last $|\Colleges|$ steps $2.\cdot$, where each of these steps considered different college.

%  Denote by CUT the mechanism CUT$^{\nearrow\searrow}$, where $\Cutoffs[0] = \{\{t^c_i\}_{i\in\{0,1,\dots,m\}}\}_{c\in\Colleges}$, such that $t^c_i=\overline{v}_c+1$ for all $c\in\Colleges$ and $i\in\{0,1,\dots,m\}$, i.e., no contract can be included into a matching.

%  By construction of CUT and CUT$^{\nearrow\searrow}$, the following holds.

% \begin{proposition}
%     CUT and CUT$^{\nearrow\searrow}$ are min-cutoff envy-free, not strategy-proof, and do not always find a stable matching whenever one exists.
% \end{proposition}

% \begin{proof}
%     For CUT being not strategy-proof and not always finding a stable matching whenever one exists, works the same reasoning as in proof of \Cref{prop:CUTS_not_strategy-proof}.

%     For CUT$^{\nearrow\searrow}$ consider the following example. 

%         Consider a market with three students, two colleges, and one resource. Corresponding region contains both colleges. Quotas are $q^{c_1}=q^{c_2}=p^r=1$. Preferences are:

%     \begin{table}[H]
%         \centering
%         \begin{tabular}{l c c}
%             $\succ_{s_1}: (c_1,r),(c_2,r),\emptyset$ &  & $\succ_{c_1}: s_1,s_2,s_3$\\
%             $\succ_{s_2}: (c_2,r),\emptyset$ &  & $\succ_{c_2}: s_1,s_2,s_3$\\
%             $\succ_{s_3}: (c_2,r),\emptyset$ & & 
%         \end{tabular}
%     \end{table}

%      Thus, induced preferences of colleges over pairs are: 

%     \begin{table}[H]
%         \centering
%         \begin{tabular}{l}
%             $\succ_{c_1}: (s_1,r),\emptyset$\\
%             $\succ_{c_2}: (s_1,r),(s_2,r),(s_3,r),\emptyset$
%         \end{tabular}
%     \end{table}

%      Suppose, during Step 1.1 we choose $c_1$. Thus, during Steps 1.2 and 1.3 we choose $c_2$. Thus, CUT$^{\nearrow\searrow}(\succ_{\Students})=\{(s_1,c_2,r)\}$. Note that there is only one stable matching $\{(s_1,c_1,r)\}$. Therefore, CUT$^{\nearrow\searrow}$ does not always find a stable matching whenever one exists.

%      Now, consider a market with two students, two colleges, and one resource. Corresponding region contains both colleges. Quotas are $q^{c_1}=q^{c_2}=p^r=1$. Preferences are:

%     \begin{table}[H]
%         \centering
%         \begin{tabular}{l c c}
%             $\succ_{s_1}: (c_2,r),(c_1,r),\emptyset$ &  & $\succ_{c_1}: s_2,s_1$\\
%             $\succ_{s_2}: (c_2,r),\emptyset$ &  & $\succ_{c_2}: s_2,s_1$
%         \end{tabular}
%     \end{table}

%     Thus, induced preferences of colleges over pairs are: 

%     \begin{table}[H]
%         \centering
%         \begin{tabular}{l}
%             $\succ_{c_1}: (s_1,r),\emptyset$\\
%             $\succ_{c_2}: (s_2,r),(s_1,r),\emptyset$
%         \end{tabular}
%     \end{table}

%     Suppose, during Step 1.1 we choose $c_2$, and during Step 1.2 we choose $c_1$. Thus, CUT$^{\nearrow\searrow}(\succ_{\Students})=\{(s_2,c_2,r)\}$.

%     Now, suppose that student $s_1$ lies about her preferences: $\succ'_{s_1}: (c_1,r),\emptyset$.  Thus, induced preferences of colleges over pairs are: 

%     \begin{table}[H]
%         \centering
%         \begin{tabular}{l}
%             $\succ'_{c_1}: (s_1,r),\emptyset$\\
%             $\succ'_{c_2}: (s_2,r),\emptyset$
%         \end{tabular}
%     \end{table}

%      Again, during Step 1.1 we choose $c_2$. Thus, CUT$^{\nearrow\searrow}(\succ'_{s_1},\succ_{s_2})=\{(s_1,c_1,r)\}\succ_{s_1}\{(s_2,c_2,r)\}=$ CUT$^{\nearrow\searrow}(\succ_{\Students})$. Thus, CUT$^{\nearrow\searrow}$ is not strategy-proof for students.
% \end{proof}

% \begin{conjecture}
% In expectation, UDC$(\succ_{\Students})$ + better initialization has less (waste-)blocking contracts than UDC$(\succ_{\Students})$.
% \end{conjecture}

% \subsection{Matching Mechanisms}

% A matching is \textbf{non-wasteful} if any blocking contract is envy-blocking. A mechanism is \textbf{non-wasteful} if it produces a non-wasteful matching for any $\succ_{\Students}$.

% \par Fix a feasible matching $\mu$ and a student $s$ that is unmatched under $\mu$. Name this \textbf{student's choice under a matching} $\mu$ a non-empty solution of 
% \begin{equation*}
%     \begin{aligned}
%         \min_{(c,r)\in \Colleges\times\Resources} \quad & \bar{v}_c-v_{(s,c,r)} \\ 
%         \text{s.t.} \quad\quad & \mu\cup\{(s,c,r)\} \text{ is feasible.}
%     \end{aligned}
% \end{equation*}

% \par In words, student's choice under a matching is the best contract for her, such that adding it to the matching does not break feasibility.

% % \subsection{Random and Controlled Serial Dictatorship mechanisms}

% Consider a Random Serial Dictatorship mechanism (RSD).

% \begin{itemize}
%     \item \textbf{Step $0$.} Randomly create a strict ordering over set of all students $\Students$. Create an empty matching $\mu=\{\}$. Go to Step 1.
%     \item \textbf{Step $k$ ($1\leq k \leq |\Students|$).} Consider the $k$-th student according to the ordering. Add her choice under $\mu$ to $\mu$. If $k=|\Students|$, set RSD$(\succ_{\Students})=\mu$, end the procedure. Otherwise, go to the next Step $(k+1)$.
% \end{itemize}


% Now consider a Controlled Serial Dictatorship mechanism (CSD).

% \begin{itemize}
%     \item \textbf{Step $0$.} Create an empty matching $\mu=\{\}$. Go to Step 1.
%     \item \textbf{Step $k$ ($1\leq k \leq |\Students|$).} Denote by $S$ a set of not previously considered students. Solve
%     \begin{equation*}
%         \begin{aligned}
%             \min_{s\in S} \quad & \bar{v}_c-v_{(s,c,r)} \quad \text{or} \quad \# \text{ of envy-blocking contracts under } \mu\cup\{(s,c,r)\}\\
%             \text{s.t.} \quad & (s,c,r) \text{ is $s$'s choice under $\mu$.} &
%         \end{aligned}
%     \end{equation*}
%     If solution is non-empty, pick any student from the solution and add her choice under $\mu$ to $\mu$, go to the next Step $(k+1)$ (if $k<|\Students|$). Otherwise, set CSD$(\succ_{\Students})=\mu$, end the procedure.
% \end{itemize}

% \par By the serial dictatorship nature of the proposed mechanisms, the following holds. 

% \begin{proposition}
%     RSD and CSD are non-wasteful and Pareto-efficient. RSD is strategy-proof, while CSD is not.
% \end{proposition}

% \begin{proof}
%     Pareto-efficiency implies non-wastefulness. CSD is not strategy-proof since now a student may affect her chances for being chosen earlier by putting contracts with high college rank higher in her own ranking.
% \end{proof}



%
\section*{Acknowledgement}

\noindent This work was partially supported by the French National Research Agency (ANR) through grants ANR-20-CE23-0007 and ANR-23-CE23-0002 and through the PEPR IA FOUNDRY project (ANR-23-PEIA-0003).

% Bibliography
\bibliographystyle{ACM-Reference-Format}
\bibliography{sample}

% \newpage
\input{Appendix}

\end{document}

% Look at the fair resources distribution among colleges
% 
