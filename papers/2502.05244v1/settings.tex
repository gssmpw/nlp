\setcounter{secnumdepth}{2}
\setcounter{tocdepth}{1}

\usepackage{tikz}
\usetikzlibrary{calc, arrows}
\usetikzlibrary{shapes}
\usetikzlibrary{positioning}
\usepackage{booktabs}
\usepackage{tabularx}
\usepackage{multirow}
\usepackage{longtable}
\usepackage{makecell}
\usepackage{amsmath,amsfonts,amsthm,amssymb,mathrsfs,bbm,mathtools,nicefrac}
\usepackage{enumitem}
\usepackage[noabbrev,capitalize]{cleveref}
\usepackage[italic]{derivative}
\usepackage{xparse}
\usepackage{upgreek}
\usepackage{setspace}
\usepackage[most]{tcolorbox}
\usepackage[parfill]{parskip}
\usepackage{centernot}
\usepackage{needspace}

\usepackage{ifthen}
\newboolean{manuscript}

\usepackage{natbib}
\setcitestyle{authoryear}
\bibliographystyle{plainnat}
\usepackage{usebib}
\bibinput{sources}
\NewDocumentCommand{\pcite}{m}{\citeauthor*{#1} (\citeyear{#1}).\\\emph{\usebibentry{#1}{title}}.}
\NewDocumentCommand{\icite}{m}{``\usebibentry{#1}{title}'' \citep{#1}}

\hyphenation{Ber-noul-li Me-trop-o-lis Hast-ings a-le-a-toric}

\usepackage{graphicx}

\usepackage[list-style=longtable]{acro}
\usepackage{imakeidx}
\usepackage{hyperref}
\makeindex[intoc]
\indexsetup{headers={\indexname}{\indexname}}
\acsetup{index/use=true}

\NewDocumentCommand{\idxpage}{m}{\hyperpage{#1}}
\NewDocumentCommand{\idxpagebf}{m}{\textbf{\idxpage{#1}}}
\NewDocumentCommand{\pidx}{mo}{\index{\IfValueTF{#2}{#1|#2}{#1|idxpage}}}
\NewDocumentCommand{\idx}{d<>mo}{\emph{\IfValueTF{#1}{#1}{#2}}\pidx{#2}[#3]}
\NewDocumentCommand{\midx}{d<>omo}{\idx<#1>{#3}[#4]}

\newtheorem{thm}{Theorem}[chapter]
\newtheorem{cor}[thm]{Corollary}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{fct}[thm]{Fact}

\theoremstyle{definition}
\newtheorem{defn}[thm]{Definition}

\numberwithin{equation}{chapter}

\Crefname{thm}{Theorem}{Theorems}

\definecolor{blue}{RGB}{02,106,253}
\definecolor{red}{RGB}{245,51,30}
\definecolor{green}{RGB}{96,189,69}
\definecolor{purple}{RGB}{200,0,240}
\def\b{\textcolor{blue}}
\def\r{\textcolor{red}}
\def\g{\textcolor{green}}
\def\purple{\textcolor{purple}}

\usepackage{xcolor,amsmath}
\usepackage[linesnumbered,ruled,vlined,algochapter]{algorithm2e}
\DontPrintSemicolon
\makeatletter
    \let\c@algocf\c@thm
\makeatother
\crefname{algocf}{Algorithm}{Algorithms}
\Crefname{algocf}{Algorithm}{Algorithms}
\SetAlgoSkip{bigskip}

\renewcommand{\KwSty}[1]{\textnormal{\textcolor{blue!90!black}{\ttfamily\bfseries #1}}\unskip}
\renewcommand{\ArgSty}[1]{\textnormal{\ttfamily #1}\unskip}
\SetKwComment{Comment}{\color{green!50!black}// }{}
\renewcommand{\CommentSty}[1]{\textnormal{\ttfamily\color{green!50!black}#1}\unskip}
\newcommand{\assign}{\leftarrow}
\newcommand{\var}{\texttt}
\newcommand{\FuncCall}[2]{\texttt{\bfseries #1(#2)}}
\SetKwProg{Function}{function}{}{}
\renewcommand{\ProgSty}[1]{\texttt{\bfseries #1}}

\tcbuselibrary{theorems}
\newtcbtheorem
  [use counter*=thm,number within=chapter,crefname={Example}{Examples},Crefname={Example}{Examples}]%
  {ex}
  {Example}
  {%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=blue!10,
    coltitle=black,
    colframe=blue!10,
    fonttitle=\bfseries,
    parbox=false,
    halign=justify, %
  }%
  {ex}%

\newtcbtheorem
  [use counter*=thm,number within=chapter,crefname={Remark}{Remarks},Crefname={Remark}{Remarks}]%
  {rmk}
  {Remark}
  {%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=gray!20,
    coltitle=black,
    colframe=gray!20,
    fonttitle=\bfseries,
    parbox=false,
    halign=justify,
  }%
  {rmk}%

\newtcbtheorem
  [use counter*=thm,number within=chapter,crefname={Problem}{Problems},Crefname={Problem}{Problems}]%
  {exc}
  {Problem}
  {%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=purple!10,
    coltitle=black,
    colframe=purple!10,
    fonttitle=\bfseries,
    parbox=false,
    halign=justify,
  }%
  {exercise}%

\newtcolorbox{readings}{%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=green!30,
    coltitle=black,
    colframe=green!30,
    fonttitle=\bfseries,
    title={Readings},
    parbox=false,
    halign=justify,
}
\newtcolorbox{oreadings}{%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm,top=0cm,
    toptitle=0.2cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=green!20,
    coltitle=black,
    colframe=green!20,
    fonttitle=\bfseries,
    title={Optional Readings},
    parbox=false,
    halign=justify,
}

\newtcolorbox{thmb}{%
    before skip=10pt,after skip=10pt,
    left=0.2cm,right=0.2cm, top=0cm,
    toptitle=0cm,bottomtitle=0cm,
    breakable,
    toprule at break=0.2cm,
    sharp corners,
    colback=gray!10,
    coltitle=black,
    colframe=gray!10,
    fonttitle=\bfseries,
    title={},
    parbox=false,
    halign=justify,
}

\let\marginnote\relax
\usepackage{marginnote}
\NewDocumentCommand{\margintag}{O{0\baselineskip}m}{%
  \checkoddpage%
  \ifoddpage%
    {\marginnote{\footnotesize #2}[#1]}%
  \else%
    {\reversemarginpar\marginnote{\footnotesize #2}[#1]}%
  \fi}%
\NewDocumentCommand{\safefootnote}{om}{\footnotemark\margintag[#1]{\textsuperscript{\tiny\arabic{footnote}} \normalfont\justifying #2}}

\NewDocumentEnvironment{marginbox}{O{0\baselineskip}m}{\begin{marginfigure}[#1]{\textbf{#2}}\quad}{\end{marginfigure}}

\makeatletter
\NewDocumentCommand{\embeq}{m}{%
  \leavevmode\hfill\refstepcounter{equation}\textup{\tagform@{\theequation}}\label{#1}%
}
\makeatother

\makeatletter
\NewDocumentCommand{\algeq}{m}{%
  \leavevmode\Comment*[r]{\refstepcounter{equation}\textup{\tagform@{\theequation}}\label{#1}}%
}
\makeatother

\usepackage{etoolbox}
\makeatletter
\patchcmd{\@algocf@start}%
  {-1.5em}%
  {0pt}%
  {}{}%
\makeatother

\allowdisplaybreaks

\setlist[enumerate]{noitemsep, topsep=-6pt, leftmargin=16pt}
\setlist[itemize]{noitemsep, topsep=-6pt}

\usepackage{import}
\usepackage{xifthen}
\usepackage{pdfpages}
\usepackage{transparent}

\NewDocumentCommand{\incfig}{om}{%
    \IfValueTF{#1}{%
        \def\svgwidth{#1}%
    }{%
        \def\svgwidth{\columnwidth}%
    }%
    \centering\import{./figures/}{#2.pdf_tex}%
}
\newcommand{\incplt}[1]{%
  \begin{center}
    \import{./plots/output/}{#1.pgf}
  \end{center}
}

\usepackage{titlesec}
\titleclass{\part}{top} %
\titleformat{\part}
[display]
{\centering\normalfont}
{\vspace{3pt}\Large\smallcaps{\partname} \thepart}
{0pt}
{\vspace{1pc}\Huge\normalfont\textit}
\titlespacing*{\part}{0pt}{0pt}{20pt}

\NewDocumentEnvironment{exercise}{mm}{\begin{exc}{#1}{#2}}{\par\textit{\hyperref[solution:#2]{$\triangleright$ Solution}}
\end{exc}}


\newtheorem{nexc}{}[chapter]
\crefname{nexc}{Problem}{Problems}
\Crefname{nexc}{Problem}{Problems}

\NewDocumentCommand{\excheading}{}{\needspace{6\baselineskip}\section*{Problems}}

\NewDocumentEnvironment{nexercise}{mm}{%
  \needspace{2\baselineskip}%
  \begin{nexc}%
  \hyperref[solution:#2]{\textbf{#1.}}\label{exercise:#2}%
  \par\nobreak
}{%
  \end{nexc}%
}

\NewDocumentCommand{\exerciseref}{mo}{\margintag{\normalfont\textbf{\Cref{exercise:#1} \IfValueT{#2}{({#2})}{}}}}
\newcommand*\circled[1]{\tikz[baseline=(char.base)]{
            \node[shape=circle,draw,inner sep=1pt] (char) {#1};}}
\NewDocumentCommand{\exerciserefmark}{mo}{\hyperref[exercise:#1]{\circled{\normalfont\textbf{?}}}\exerciseref{#1}[#2]}

\NewDocumentEnvironment{solution}{m}{\paragraph{\normalfont{\textbf{Solution to \cref{exercise:#1}.}}}\label{solution:#1}}{}
