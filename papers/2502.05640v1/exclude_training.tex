\pgfplotsset{width=7cm,compat=1.5}

% Style to select only points from #1 to #2 (inclusive)
\pgfplotsset{select coords between index/.style 2 args={
		x filter/.code={
			\ifnum\coordindex<#1\def\pgfmathresult{}\fi
			\ifnum\coordindex>#2\def\pgfmathresult{}\fi
		}
}}

\begin{figure}[htp!]
\centering
\subfloat[]{
		\begin{tikzpicture}[font=\small, scale=1, every node/.style={scale=1}]
		\pgfplotsset{
			scale only axis,
		}
		
		\begin{axis}[
		height=4cm,
		axis x line*=bottom, 
		axis y line*=left,
		ymax=96,
		ymin=91,
		xmin=1,
		xmax=50,
		xtick={1,10,20,30,40,50},
		grid=major,
		grid style={dashed,gray!50},
		ylabel = Accuracy (\%),
		xlabel = Training epoch number,
		clip=false,
		legend style={at={(axis cs:7,92)},anchor=west,font=\scriptsize},
		ylabel style={yshift=-0.2cm},
		]	
		\addplot [semithick,blue] table [y=accuracy, x=epoch] {Data/vanillaTM_acc_size.dat};
		\addlegendentry{Vanilla TM}
		\addlegendimage{ultra thin, red, mark=triangle*}\addlegendentry{ETHEREAL after training}
		\addlegendimage{ultra thin, red, mark=*}\addlegendentry{ETHEREAL after exclusion}
		\addplot [ultra thin, red] table [y=accuracy, x=epoch]{Data/excludeTM_acc_size.dat};
		\addplot [only marks, red, mark=triangle*, mark size=1.5pt, ultra thin] table [y=accuracy, x=epoch]{Data/excludeTM_acc_size_OnlyRetrain.dat};	
		\addplot [only marks, red, mark=*, mark size=1.5pt, ultra thin] table [y=accuracy, x expr=\thisrow{epoch}+1]{Data/excludeTM_acc_size_OnlyExclude.dat};
		\draw[fill=white,thick, densely dotted] (axis cs:35.3,91.2) rectangle (axis cs:51,93.7);
		\draw[thick, densely dotted] (axis cs:35.5, 94.3) rectangle (axis cs:41.5,95.1);
		\coordinate[] (pt) at (axis cs:36.5,94.4);		
		\end{axis}
		
		\node[pin=280:{%
		\begin{tikzpicture}[baseline,trim axis left,trim axis right,scale=0.25]
		\begin{axis}[
		xmin=36,xmax=41,
		xtick={36,37,38,39,40,41},
		ymin=94.4,ymax=95,
		ytick={94.4,94.7,95},
		enlargelimits,
		grid=major,
		grid style={dashed,gray!50},
		ticklabel style = {font=\Huge}
		]
		\addplot [very thick,red] table [y=accuracy, x=epoch]{Data/excludeTM_acc_size.dat};
		\addplot [only marks, red, mark=triangle*, mark size=6pt] table [y=accuracy, x=epoch]{Data/excludeTM_acc_size_OnlyRetrain.dat};	
		\addplot [only marks, red, mark=*, mark size=6pt] table [y=accuracy, x expr=\thisrow{epoch}+1]{Data/excludeTM_acc_size_OnlyExclude.dat};
		\end{axis}
		\end{tikzpicture}%
		}] at (pt) {};
	
		\end{tikzpicture}
}

\subfloat[]{
	\begin{tikzpicture}[font=\small, scale=1, every node/.style={scale=1}]
	\pgfplotsset{
		scale only axis,
	}

	\begin{axis}[
	height=4cm,
	axis x line*=bottom,
	axis y line*=left,
	ymax=40,
	ymin=8,
	xmin=1,
	xmax=50,
	grid=major,
	grid style={dashed,gray!50},
	ytick={10,20,30,40},
	xtick={1,10,20,30,40,50},
	ylabel = {\begin{tabular}[c]{@{}c@{}} Average number of \\ includes per clause \end{tabular}},
	xlabel = Training epoch number,
	clip=false,
	legend style={at={(axis cs:2,38)},anchor=west,font=\scriptsize},
	ylabel style={yshift=-0.2cm}
	]		
	\addplot [semithick, blue] table [y=size, x=epoch] {Data/vanillaTM_acc_size.dat};
	\addlegendentry{Vanilla TM}
	\addlegendimage{ultra thin, red, mark=triangle*}\addlegendentry{ETHEREAL after training}
	\addlegendimage{ultra thin, red, mark=*}\addlegendentry{ETHEREAL after exclusion}
	\addplot [ultra thin, red] table [y=size, x=epoch]{Data/excludeTM_acc_size.dat};
	\addplot [only marks, red, mark=triangle*, mark size=1.5pt, ultra thin] table [y=size, x=epoch]{Data/excludeTM_acc_size_OnlyRetrain.dat};	
	\addplot [only marks, red, mark=*, mark size=1.5pt, ultra thin] table [y=size, x expr=\thisrow{epoch}+1]{Data/excludeTM_acc_size_OnlyExclude.dat};
	\draw[thick, densely dotted] (axis cs:35.5, 15.5) rectangle (axis cs:41.5,21.5);
	\draw[fill=white,thick, densely dotted] (axis cs:39,22.5) rectangle (axis cs:53.5,35);
	\coordinate[] (pt) at (axis cs:36,20);
	\end{axis}

	\node[pin=20:{%
	\begin{tikzpicture}[baseline,trim axis left,trim axis right,yscale=0.2, xscale=0.25]
	\begin{axis}[
	xmin=36,xmax=41,
	xtick={36,37,38,39,40,41},
	ymin=16.5,ymax=20.5,
	ytick={18,20},
	enlargelimits,
	grid=major,
	grid style={dashed,gray!50},
	ticklabel style = {font=\Huge}
	]
	\addplot [very thick,red] table [y=size, x=epoch]{Data/excludeTM_acc_size.dat};
	\addplot [only marks, red, mark=triangle*, mark size=6pt] table [y=size, x=epoch]{Data/excludeTM_acc_size_OnlyRetrain.dat};	
	\addplot [only marks, red, mark=*, mark size=6pt] table [y=size, x expr = \thisrow{epoch}+1]{Data/excludeTM_acc_size_OnlyExclude.dat};
	\end{axis}
	\end{tikzpicture}%
	}] at (pt) {};	
	

	\end{tikzpicture}

}
	\caption{(a) Accuracy and (b) model size, for vanilla and ETHEREAL TMs, for MNIST. ETHEREAL causes an accuracy drop of 0.8\% (from 95.8\% to 95\%) but realizes a 46.6\% reduction in model size, where the average number of includes per clause is reduced from 36.3 to 19.4.}
	\label{fig:exclude_training}

\Description[accuracy and size during training for ETHEREAL]
    
\end{figure}