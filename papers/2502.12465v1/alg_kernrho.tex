\begin{algorithm}[tp]
\caption{$\KernRho((x\ind{i},a\ind{i}_{1:H})_{i=1}^n, B,\gamma,\epapx,\epopt)$}\label{alg:kernrho}
\begin{algorithmic}[1]
\State \textbf{input:} Samples $(x\ind{i},a_{1:H}\ind{i})_{i=1}^n$; RKHS norm bound $B\geq 1$; program tolerances $\gamma,\epapx>0$; optimization error tolerance $\epopt>0$.
\State For each $1 \leq i \leq n$ and $a \in \MA^H$, compute $\uop{x\ind{i}}{a}$ by
\[\uop{x\ind{i}}{a}_h \gets 
\begin{cases} 
\phi(x\ind{i},a_{1:h-1}, 1) - \phi(x\ind{i},a_{1:h-1}, 0) & \text{ if } a_h = 0 \\ 
\phi(x\ind{i},a_{1:h-1}, 0) - \phi(x\ind{i},a_{1:h-1}, 1) & \text{ if } a_h = 1
\end{cases}.
\]
\State Compute $\Sigma \in \RR^{n2^H \times n2^H}$ by
\begin{equation} 
\Sigma_{(i,a),(i',a')} \gets K(\uop{x\ind{i}}{a}, \uop{x\ind{i'}}{a'}) = \prod_{h=1}^H \frac{1}{1 - \frac{1}{2}\langle \uop{x\ind{i}}{a}_h, \uop{x\ind{i'}}{a'}_h\rangle}.
\label{eq:sigma-def}
\end{equation}
\State $T \gets 4C_{\ref{thm:sp-pgd}}^2 2^{2H+2} B/(\gamma^3 \epopt^2)$, $\eta \gets B\gamma^{3/2}2^{-H-1}\sqrt{2/T}$, $\epproj \gets 1/(16BT^4)$
\State Let $\Oproj$ implement $\epproj$-approximate projection onto the (convex) set
\begin{align} 
\MY &:= \Bigg\{y \in \RR^{n2^H}:  \left(\forall i\in[n],a\in\MA^H: e_{i,a} \Sigma^{1/2} y \geq \gamma\right) \\ 
&\qquad\land \left(\forall i \in [n]: 1-\epapx \leq \sum_{a\in\MA^H} e_{i,a} \Sigma^{1/2} y \leq 1+\epapx\right)\Bigg\}.
\label{eq:y-def}
\end{align}
\State Let $\Ovec$ implement evaluation queries to the vector field
\[g(\alphatil,\betatil) := \left(\grad_{\alphatil}\left[\frac{1}{n}\sum_{i=1}^n \tau\left(\frac{e_{i,a\ind{i}}\Sigma^{1/2}\alphatil}{e_{i,a\ind{i}}\Sigma^{1/2}\betatil}\right)\right],-\grad_{\betatil}\left[\frac{1}{n}\sum_{i=1}^n \tau\left(\frac{e_{i,a\ind{i}}\Sigma^{1/2}\alphatil}{e_{i,a\ind{i}}\Sigma^{1/2}\betatil}\right)\right]\right).\]
\State Compute $(\alphatil_t,\betatil_t)_{t=1}^T \gets \PGD(\Ovec,\Oproj\oplus\Oproj,T,\eta)$.\label{line:pgd-apply}
\Comment{See \cref{alg:pgd}.}
\State Compute 
\begin{equation} \wh\alpha \gets \Sigma^{-1/2} \Proj_{\vspan(\Sigma)} \left(\frac{1}{T}\sum_{t=1}^T \alphatil_t\right).\label{line:wh-alpha}\end{equation}
\State \textbf{return:} policy $\pihat:\MX \to \Delta(\MA^H)$ defined by
\[\pihat(\cdot|x) := \argmin_{\mu \in \Delta_\gamma(\MA^H)} \sum_{a \in \MA^H} \left| \mu(a) - \sum_{i \in [n]}\sum_{a' \in \MA^H} \wh\alpha_{i,a'} K(\uop{x\ind{i}}{a'}, \uop{x}{a})\right|.\]
\end{algorithmic}
\end{algorithm}
