% !TEX root = main.tex

\section{\Sandwich reachability sets} \label{sec:tools}
In this section we introduce the crucial concept of \emph{\sandwich} sets.
In order to motivate it, we start by sketching the overall idea of the
proof of Lemma \ref{lem:main} (given in Section \ref{sec:mainproof}). 

Given a finite set $P\subseteq \N^d$ and $B\in\N$, we set:
%
\begin{align*}
P^* \ =  \ & \setof{p_1 + \ldots + p_k}{k\geq 0, \ p_1, \ldots, p_k \in P} \\
P^{\leq B} \ =  \ & \setof{p_1 + \ldots + p_k}{B\geq k\geq 0, \ p_1, \ldots, p_k \in P}.
\end{align*}
%
Sets of the form $b + P^* = \setof{b+p}{p\in P^*}$, for $b\in\N^d$ and finite $P\subseteq\N^d$,
are called \emph{linear},
and finite unions of linear sets are called \emph{semi-linear}.


\para{Idea of the proof of Lemma \ref{lem:main}}

Let $V=\ktvass$ be a $k$-component \tvass  that has a path $s=q(w) \tran q'(w')=t$.
%
If $V$ is diagonal and wide,
%, namely $V_1$ is forward-diagonal and $V_k$ is backward-diagonal, and also wide,
we use the pumping cycles $q(w) \tran q(w+\Delta)$ in $V_1$ and
$q'(w'+\Delta') \tran q'(w')$ in $V_k$ to lift a $\Z$-path $s\tran t$, \plb
due to Lemma \ref{lem:zvass-plb}, until it becomes a path
(as in Case 1 in the proof of Lemma \ref{lem:1comp}).
%in Lemma \ref{lem:dw} in Section \ref{sec:mainproof}).

On the other hand, if $V$ is non-diagonal or non-wide, our strategy is to reduce the number of components
by 1, and to rely on the induction assumption for $k-1$,
by replacing the first component $V_1$ 
by one of finitely many \geomvass 
(as in Cases 2 and 3 of the proof of Lemma \ref{lem:1comp}).
Relying on the fact that the reachability sets in a \geomvass are semi-linear \cite{DBLP:conf/icalp/FuYZ24},
the proof could go as follows (yielding however only the
already known \tower upper bound \cite{DBLP:conf/icalp/FuYZ24}).
%
Using any of the linear sets $L = a +P^*$
describing the set $\reach_{q_2}(V,s)$, where $q_2$
is the source state of the second component $V_2$,
transform $V$ into a $(k-1)$-component \tvass $V'$ by dropping the first component $V_1$
and the first bridge $u_1$, and by adding to the remaining $(k-1)$-component
\tvass $(V_2)u_2 \ldots u_{k-1}(V_k)$ the self-looping transitions
$
(q_2, r, q_2),
$
one for every period $r\in P$.
The source configuration of $V'$ is $s' = q_2(a)$, i.e., its vector is the base of $L$.
The transformation preserves behaviour of $V$.
In one direction, a path $s\tran q_2(x) \tran t$ in $V$ crossing through $q_2(x)$ for 
some  $x\in L$ has a corresponding path $p_2(a) \tran p_2(x)\tran t$ in $V'$.
Conversely, each path $q_2(a) \tran q_2(x) \tran t$ in $V'$
gives rise to a path $s\tran t$ in $V$, by replacing executions of the self-looping transitions
$q_2(a) \tran q_2(x)$
(\mywlog executed in the beginning), by a path $s\tran q_2(x)$ in $V_1$,
bounded polynomially due to Lemma \ref{lem:1comp}.
However, $\size(V')$ may blow-up exponentially with respect to $\size(V)$, as bases and periods
of $L$ areonly bounded exponentially, 
and therefore
this approach could only yield a $k$-fold exponential bound on the length of the shortest path
in $k$-component \tvass.

%\smallskip

\Sandwich sets are designed as a remedy against the $k$-fold exponential blowup.
The idea is to measure the norms of base and periods of a semi-linear set $L$ 
parametrically with respect to, intuitively speaking, 
the prospective length $B$ of a path $s'\tran t$ in $V'$.
This allows us to control the blow-up of size of $V'$,
also parametrically with $B$, but requires
going outside of semi-linear sets and considering their \emph{$B$-approximations},
namely sets sandwiched between $a+P^{\leq B}$ and $a+P^*$,
good enough for correctness of the above-described transformation
of $V$ to $V'$.
As the outcome, the exponent of our bound on length of the shortest path in $k$-component \tvass
is, roughly speaking, square of the exponent of the respective bound in $(k-1)$-component \tvass. 
For $k$-component \tvass this yields exponent doubly-exponential in $k$, and hence the bound triply-exponential is $k$.
The rigorous reasoning is given in the proof of Lemma \ref{lem:ne} in Section \ref{sec:mainproof}.


\para{\Sandwich sets}

Let $B\in \N$.
By a $B$-\emph{approximation}
of a linear set $a + P^*\subseteq \N^d$ we mean any set $S\subseteq \N^d$ satisfying 
$
a + P^{\leq B} \subseteq S \subseteq a+P^*.
$
%
%\begin{definition}  \rm
A set $X\subseteq \N^d$ is \emph{\kanapka {$A$} {$B$}}
if it is a finite union of:

\begin{itemize}
  \item linear sets $a + P^* \subseteq \N^d$ with $\norm(a) \leq B \cdot A$ and
  $\norm(P) \leq A$; and
  \item $B$-approximations of linear sets $a + P^* \subseteq \N^d$ with $\norm(a) \leq A$ and
  $\norm(P) \leq A$.
\end{itemize}
%\end{definition}
%

\noindent
Thus $X$ either includes 
$B$-approximation of a linear set $a+P^*$, whose norm of base is bounded by $A$,
or $X$ includes 
a whole linear set $a+P^*$, whose norm of base is only bounded by $B\cdot A$.
In both cases, norms of periods are bounded by $A$.

%\begin{definition} \rm
%Let $d\in\{2,3\}$.
We say that a class $\C$ of \parvass d is \emph{\parsandwich{$F$}} 
if for every \vass $(V, s)$ in $\C$, its state $q$,
and $B\in\N$,
the set $\reach_q(V,s)$ is \kanapka {$F(M)$} {$B$}, where $M=\size(V,s)$.
The class $\C$ is \emph{\sandwich} if it is \parsandwich{$F$}, for some nondecreasing 
polynomial $F$.
%
%a finite union of:
%
%\begin{itemize}
%  \item linear sets $a + P^* \subseteq \N^d$ with $\norm(a) \leq B \cdot F(M)$ and
%  $\norm(P) \leq F(M)$; and
%  \item $B$-approximations of linear sets $a + P^* \subseteq \N^d$ with $\norm(a) \leq F(M)$ and
%  $\norm(P) \leq F(M)$.
%\end{itemize}
%\end{definition}


\input{example}

In our subsequent reasoning we rely on the core technical fact:
%proved in Section \ref{sec:sandwich}:
%  
\begin{lemma}\label{lem:2vass-sandwich}
\dvass are \sandwich.
\end{lemma}

The proof of Lemma~\ref{lem:2vass-sandwich} is moved to the Appendix. We sketch here the intuition behind it, since
it is one of our main technical contributions. We first show that it is enough to show Lemma~\ref{lem:2vass-sandwich}
for a simple class of \dvass, called \dslps, which are of the form $\alpha_0 \beta_1^* \alpha_2 \ldots \alpha_{k-1} \beta_k^* \alpha_k$,
where $\alpha_i$ are fixed sequences of transitions and the loops $\beta_i$ are single transitions. This reduction uses standard techniques,
namely Theorem 1 in~\cite{BlondinFGHM15} stating that the reachability relation of a \dvass can be expressed as a union of reachability relations of a \dlps (\dlps are \dslps without the assumption that $\beta_i$ are single transitions) and Theorem 15 in~\cite{DBLP:conf/lics/EnglertLT16} providing the reduction from \dlps to \dslps. Next, we simplify the \dslps even more, using 
%Filip's lemma - to arXiv
Theorem 4.16 in~\cite{DBLP:conf/focs/0001CMOSW24}, which states that any two vectors reachable by an \dslps can be reached
also by a path of the \dslps of a special form: except a short prefix and suffix it zigzags all the time between configurations close to vertical axis to configurations close to horizontal axis. Thus, to prove Lemma~\ref{lem:2vass-sandwich}
it essentially remains to show polynomial approximability for zigzagging paths.
To achieve that, we roughly speaking
investigate how application of two consecutive loops $\beta \in \N_+ \times \N_-$ and $\beta' \in \N_- \times \N_+$
affects the set of reachable configurations on some vertical line close to the vertical axis. We show that arithmetic sequence
is transformed into a finite union of arithmetic sequences such that the difference is kept at most polynomial in size of the \dslps
and the first term grows additively by at most a polynomial value. All that allows us to conclude that the set of vectors
reachable by zigzagging paths is a union of sets of a form similar to $a + Q^* + P^{\leq T}$.
This quite easily implies polynomial approximability.

\input{sandwich}

In the proof of Lemma~\ref{lem:main} we actually need polynomial approximability not only for \dvass, but also for
its generalisation, \geomvass. It is stated below and shown in the Appendix using Lemma~\ref{lem:2vass-sandwich}

\begin{lemma} \label{lem:geom-sandwich}
\Geomvass are \sandwich.
\end{lemma}
%
\begin{appendixproof}[Proof of Lemma~\ref{lem:geom-sandwich}]
Fix an arbitrary \geomvass $(V, s)$ and let $M = \size(V,s)$.
Norms of vectors generating $\cone V$ --- i.e., effects of simple cycles --- are at most $M$, 
as no transition repeats along a simple cycle.
The effect $\delta \in \Z^3$  of each simple cycle
satisfies $\innprod a \delta = 0$, where $a\in\Z^3$ is a vector orthogonal to $\Lin V$,
or equivalently, orthogonal to some two effects of simple cycles.
The vector $a$ is thus an integer solution of a system of 2 linear equations with 3 unknowns,
where absolute values of coefficients are bounded by $M$.
By Lemma \ref{lem:taming}, there is such an integer solution 
$a=(a_1, a_2, a_3)$ with $\norm(a)\leq D=\OO(M^2)$.


In consequence, on every path $s \tran t$ the value of inner product with $a$ is bounded polynomially
with respect to $M$:
%
\begin{claim} \label{claim:axx}
Every configuration $q(x)\in \reach(V,s)$  satisfies
$-C \leq \innprod a x \leq C$, where $C = \OO(M\cdot D)$. 
\end{claim}
%

We rely on the construction of \cite[Lemma 5.1]{Zhang-geom}, which transforms a 
\geomvass $(V,s )$ into a \dvass $(\essdvass V, \essdvass s)$ of size at most $R(M)$
for some polynomial $R$, by dropping on of dimensions of $V$.

\para{Case I: $a$ contains both positive and negative numbers}
\Wlog assume that $a_1, a_2 \geq 0$ and $a_3<0$,
in which case it is the third coordinate which is dropped 
by the construction of \cite[Lemma 5.1]{Zhang-geom}.
States of $\essdvass V$ are of the form $\pair q c$, where $q\in Q$ and $c\in\setfromto {-C} C$, 
plus some further auxiliary states, omitted here.
Due to Claim \ref{claim:axx},
there is a one-to-one correspondence between
reachable configurations in $V$ and reachable configurations in $\essdvass V$:
\[
e = q(x_1, x_2, x_3) \quad \longmapsto \quad
\essdvass e = \pair q c(x_1, x_2), 
\qquad
\text{ where } c = \innprod a x.
\]
%
The tight correspondence between paths of $V$ and $\essdvass V$,
 given in Claim \ref{claim:V321} below, is essentially 
Lemma 5.1 of \cite{Zhang-geom}:
%
\begin{claim} \label{claim:V321}
For every configurations $s,u$,
here is a path $s \tran u$ in $\essdvass V$
if, and only if,
there is a path $\essdvass s \tran \essdvass u$ in $\essdvass V$.
\end{claim}
%
By Lemma \ref{lem:2vass-sandwich}, there is a polynomial $F$ such that 
for every $B\in\N$,
in the \dvass
$(\essdvass V, \essdvass s)$ obtained by the above construction, 
for every its state $\pair q c$, the set 
$\reach_{\pair q c}(\essdvass V, \essdvass s)$ is \kanapka {$F(M')$} {$B$}, where
$M'=\size(\essdvass V, \essdvass s) \leq R(M)$, and hence also
\kanapka {$F(R(M))$} {$B$}.
We claim that for every state $q\in Q$, for every $B\in\N$, 
the set $\reach_q(V,s)$ is \kanapka {$G(F(R(M)))$} {$B$}, for some nondecreasing polynomial $G$.
Indeed, for any $B\in\N$, any ($B$-approximation of) a linear set 
$L = w + P^*\subseteq \N^2$, where $w=(w_1, w_2)$, witnessing that
$\reach_{\pair q c}(\essdvass V,\essdvass s)$  is \kanapka {$F(R(M))$} {$B$}
is transformed to a ($B$-approximation of) linear set $L'$ witnessing that
$\reach_{q}(V,s)$  is \kanapka {$G(F(R(M)))$} {$B$}, as follows.
Take as base the unique vector $w'=(w_1, w_2, w_3)$ such that $a_1 w_1 + a_2 w_2 + a_3 w_3 = c$.
For every period $p=(p_1, p_2) \in P$, take into the set $P'$  the unique vector
$p'=(p_1, p_2, p_3)$ such that $a_1 p_1 + a_2 p_2 + a_3 p_3 = 0$.
Since $a_3>0$, it is guaranteed that $p_3 \geq 0$, and therefore $p'\in\N^3$.
Let the polynomial $G$ bound the blowup of $\norm(b')$ with respect to $\norm(b)$, and 
$\norm(p')$ with respect to $\norm(p)$, for instance
$G(x) = M \cdot x + B$.
The union of all ($B$-approximations of) 
so described sets $L' = w' + (P')^*$, for all $c\in\setfromto {-C} C$, provides the witness that
$\reach_{q}(V,s)$ is \kanapka {$G(F(R(M)))$} {$B$}.

\para{Case II: $a$ is non-negative or non-positive}
\Wlog assume $a\geq \vec 0$ and $a_3 > 0$.
By Claim \ref{claim:axx}, for each $q(x) \in \reach(V,s)$
we thus have $x_3 \leq C$.
%
We transform $(V,s)$ into $(\essdvass V, \essdvass s)$ 
with states of the form $\pair q c$, where $q\in Q$ and $c\in\setfromto {0} C$, 
by storing the third coordinate in state:
\[
e = q(x_1, x_2, x_3) \quad \longmapsto \quad
\essdvass e = \pair q c(x_1, x_2), 
\qquad
\text{ where } c = x_3.
\]
As above, $\size(\essdvass V, \essdvass s) \leq R(M)$, for a polynomial $R$.
The argument  that for every $B\in\N$,
the set $\reach_{q}(V,s)$ is \kanapka {$G(F(R(M)))$} {$B$}, is similar to Case I (but simpler).
\end{appendixproof}

%
%\begin{lemma} \label{lem:nondiag-sandwich}
%Non-forward-diagonal lollypop \tvass are \sandwich.
%%\slawek{uwaga na $\norm(a) \leq 2R(M) \cdot B$}
%\end{lemma}
%%
%%\begin{proof}
%\begin{proof}[Proof of Lemma \ref{lem:nondiag-sandwich}]
%%\slawek{could go to appendix}
%Exactly as in Case 3 of the proof of Lemma \ref{lem:1comp}, one can transform
%a non-forward-diagonal lollypop \tvass $(V, s)$ into
%three \geomvass $(V_1, s_1), (V_2, s_2), (V_3, s_3)$.
%In each configuration of the three \dvass, the value of the
%missing coordinate is determined by state.
%By Claim \ref{claim:nondiag2vass}, the lengths of paths in $V$ are the same as (jointly) the 
%paths in the three \geomvass, and
%by Claim \ref{claim:nondiagsize} the size of each $(V_j, s_j)$  is bounded by
%$R(M)$, where $M = \size(V,s)$.
%The blowup of the transformation is thus bounded by a nondecreasing polynomial $R$.
%We combine the transformation with Lemma \ref{lem:geom-sandwich},
%according to which there is a nondecreasing polynomial $F$
%such that the class of \geomvass is \parsandwich{$F$},
%to deduce that
%the class of non-forward-diagonal 1-component \tvass is \parsandwich{$(F(R(\_))$}.
%Indeed, all ($B$-approximations of) linear sets witnessing that
%$\reach_{\pair q b}(s_j)$ in $V_j$ is \kanapka {$F(R(M))$} {$B$}, fro all $b$ and $j$,
%jointly witness that
%$\reach_{q}(s)$ in $V$ 
%is \kanapka {$F(R(M))$} {$B$}.
%%by adding the missing coordinate as follows:
%%add the missing coordinate in the base vector $b$ as determined by the target state $q$;
%%and in each period vector $v\in P$, add the missing coordinate 0.
%%\end{proof}
%\end{proof}
%
