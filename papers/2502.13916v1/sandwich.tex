% !TEX root = main.tex

%\section{Proof of Lemma~\ref{lem:2vass-sandwich}: \dvass are \sandwich}\label{sec:sandwich}

\begin{appendixproof}[Proof of Lemma~\ref{lem:2vass-sandwich}]
We extend the definition of nondecreasing functions to many-argument ones:
a function $f: \N^k \to \N$ is \emph{nondecreasing} if it is monotonic
in every argument and $f(n_1, \ldots, n_k) \geq n_1 + \ldots + n_k$.
In the sequel we often bound certain quantities polynomially, but an exact polynomial is irrelevant. 
We thus say that a value $n$ is \emph{polynomially bounded} in $n_1, \ldots, n_k$
if there exists a nondecreasing polynomial $P: \N^k \to \N$ such that $n \leq P(n_1, \ldots, n_k)$
for all $n_1, \ldots, n_k \in \N$. 
We also write $n \leq \poly(n_1, \ldots, n_k)$.

\para{Linear path schemes}
A $d$-dimensional \emph{linear path scheme} ($d$-\LPS in short, or \LPS if dimension is irrelevant) 
is a sequential \vass where every component is either trivial (a singleton) or a simple cycle,
i.e., a \vass whose control graph is a simple path with disjoint simple cycles attached to some states of the path.
We write down \LPS in the following form 
\[
%\Lambda \ = \ 
\alpha_0\beta_1^* \alpha_1 \cdots \alpha_{k-1} \beta_{k}^* \alpha_k,
\]
where each $\alpha_i$ and $\beta_i$ is  a fixed sequence of transitions. 
Thus the cycles $\beta_i$ of an \lps may be repeated arbitrarily many times (possibly zero). 
An \LPS is \emph{simple} (\SLPS) when all $\beta_i$ are single transitions, i.e.,
each component is either trivial or a single self-loop transition.
When considering the reachability relation in a $d$-\LPS, we often implicitly take the first and the last state
of the \LPS as the source and target state, respectively, and consider the reachability $w\tran w'$ between
vectors $w,w'\in\N^d$ only.
% for two vectors $s, t \in \N^d$, denoted $s \trans{\Lambda} t$, instead of reachability from one configuration to another. This is just a shortening of notation meaning that we consider reachability from $p(s)$ to $q(t)$ where $p$ is the first state of $\Lambda$ (before $\alpha_1)$ and $q$ is the last state (after $\alpha_n$) of $\Lambda$.

%\begin{lemma}\label{lem:two-slps}
%There is a nondecreasing polynomial $P$ such that for every \dvass $V$ together with its two states $p$ and $q$,
%such that $\size(V) = M$ there is a finite set $\Gamma$ of \dslps, each of size at most $P(M)$,
%such $p(u) \tran q(v)$ in $V$ if and only if $u \trans{\Lambda} v$ for some \dslps $\Lambda \in \Gamma$.
%\end{lemma}

%\wojtek{Maybe remove Lemma~\ref{lem:two-slps} and move its proof directly to the proof of Lemma~\ref{lem:2vass-sandwich}.}

\begin{lemma}\label{lem:two-slps}
For every \dvass $V$ and two its states $q$, $q'$,
there is a finite set $\Gamma$ of \dslps of size polynomially bounded in $\size(V)$,
such that for all $w,w'\in\N^2$,
\begin{align*} %\label{eq:slps}
 \ \ q(w) \tran q'(w') \text{ in } V \ \iff \ w \tran w' \text{ in some  \dslps in } \Gamma.
\end{align*}
\end{lemma}

\begin{proof}
The claim follows by combination of
Theorem 3.1 from~\cite{DBLP:journals/jacm/BlondinEFGHLMT21}, due to which we get
a finite set $\Gamma$ of \dlps of size polynomially bounded in $\size(V)$ that satisfies the claim,
with Lemma 5.2 from~\cite{DBLP:journals/jacm/BlondinEFGHLMT21} 
(or Theorem 15 from~\cite{DBLP:conf/lics/EnglertLT16}), due to which
we can transform every \dlps $\lambda$ into an \dslps of size polynomially bounded in $\size(\Lambda)$.
%We get that the size of the obtained \dslps are polynomially bounded in the size of the input \dlps.
%Therefore, the resulting \dslps have size at most polynomial also wrt. the size of the considered \dvass, as required.
%Finally, notice that one can upper-bound any polynomial by a nondecreasing polynomial.
%Indeed, it is sufficient to take absolute values of the coefficients, and possibly add the $P(x) = x$, if the starting polynomial is a constant.
\end{proof}

%Here is the previous formulation of the main sandwich lemma, probably not useful  now.
%
%\begin{lemma}\label{lem:two-sandwich}
%There exists a polynomial $R$ such that for any $2$-VASS of size $M$,
%any configuration $s$, any state $q$ and any numbers $N, K, N_t \in \N$
%the set $\reach_q(s)$ is a finite union of:
%\begin{itemize}
%  \item linear sets $a_i + Q_i^* \subseteq \N^2$ such that $\norm(a_i) \leq B_\bg$, $\norm(Q_i) \leq R(M)$, and
%  \item sandwich sets $S_i \subseteq \N^2$ such that there are $b_i \in \N^2$, $P_i \subseteq_{\fin} \N^2$ with $\norm(b_i) \leq B_\sml$,
%  $\norm(P_i) \leq R(M)$ and $b_i + P_i^{\leq B_\bg} \subseteq S_i \subseteq b_i + P_i^*$,
%\end{itemize}
%where $N_s = \norm(s)$, $B_\sml = (N_s + N_t) \cdot (2N \cdot R(M))^K$ and $B_\bg = (N_s + N_t) \cdot (2 N \cdot R(M))^{2K}$. 
%\end{lemma}
%
%\vskip 5cm

%The following lemma, together with Lemma \ref{lem:two-slps}, immediately imply Lemma~\ref{lem:2vass-sandwich}:

%\begin{lemma}\label{lem:slps-sandwich}
%There exists a polynomial $R$ such that for any $2$-SLPS with of norm $N$ and with $n$ states,
%and any vector $s \in \N^2$ with $N_s = \norm(s)$ and any numbers $K, N_t, N_R \in \N$
%the set $\reach(s)$ is a finite union of:
%\begin{itemize}
%  \item linear sets $a_i + Q_i^* \subseteq \N^2$ such that $\norm(a_i) \leq 2R(N) \cdot B_\bg$, $\norm(Q_i) \leq R(N)$, and
%  \item sandwich sets $S_i \subseteq \N^2$ such that there are $b_i \in \N^2$, $P_i \subseteq_{\fin} \N^2$ with $\norm(b_i) \leq B_\sml$,
%  $\norm(P_i) \leq R(N)$ and $b_i + P_i^{\leq B_\bg} \subseteq S_i \subseteq b_i + P_i^*$,
%\end{itemize}
%where
%%$B_\sml = (N_s + N_t + nN) \cdot (2 N_R \cdot R(N))^K$ and $B_\bg = (N_s + N_t + nN) \cdot (2 N_R \cdot R(N))^{4K}$. 
%$B_\sml = (N_s + N_t + n \cdot R(N))$ and $B_\bg = (N_s + N_t + nN) \cdot (2 (N_R + R(N)))^{K+1}$. 
%\end{lemma}

%\begin{lemma}\label{lem:slps-sandwich}
%There exists a polynomial $Q$ such that for every $2$-SLPS $\Lambda$,
%any vector $s \in \N^2$ such that $M = \max(\size(\Lambda), \norm(s))$ and any number $B \in \N$
%the set $\reach(s)$ is a finite union of:
%\begin{itemize}
%  \item linear sets $a_i + Q_i^* \subseteq \N^2$ such that $\norm(a_i) \leq B \cdot Q(M)$, $\norm(Q_i) \leq Q(M)$, and
%  \item sandwich sets $S_i \subseteq \N^2$ such that there are $b_i \in \N^2$, $P_i \subseteq_{\fin} \N^2$ with $\norm(b_i) \leq Q(M)$,
%  $\norm(P_i) \leq Q(M)$ and $b_i + P_i^{\leq B} \subseteq S_i \subseteq b_i + P_i^*$.
%\end{itemize}
%\end{lemma}

\begin{lemma}\label{lem:slps-sandwich}
\dslps are \sandwich.
\end{lemma}

Before proving Lemma~\ref{lem:slps-sandwich}, we use it together with Lemma~\ref{lem:two-slps}
to prove Lemma~\ref{lem:2vass-sandwich}.
%
To this aim consider a \dvass $(V, s)$ where $s=p(w)$, and its state $q$, and let $M=\size(V,s)$.
%$M = \max(\size(V), \norm(s))$.
By Lemma~\ref{lem:two-slps} we get a finite set $\Gamma$ of \dslps such that:
\[
\reach_q(V,s) \ = \ \bigcup_{\Lambda \in \Gamma} \reach(\Lambda, w).
\]
Moreover, for some nondecreasing polynomial $F$, every $\Lambda \in \Gamma$ satisfies
$\size(\Lambda) \leq F(M)$.
By Lemma~\ref{lem:slps-sandwich}, there is a nondecreasing polynomial $G$
such that for every $\Lambda \in \Gamma$ and $B\in\N$, 
the set $\reach(\Lambda,w)$
is 
\kanapka {$G(\size(\Lambda,w))$} {$B$}.
Combining the last two statements, we deduce that $\reach_q(V, s)$ is
\kanapka {$G(F(M))$} {$B$} for every $B\in\N$, as required.
%
Lemma~\ref{lem:2vass-sandwich} is thus proved (once we prove
Lemma~\ref{lem:slps-sandwich}).
\end{appendixproof}

\begin{appendixproof}[Proof of Lemma~\ref{lem:slps-sandwich}]
%
We generalise finite prefixes $P^{\leq B}$ of $P^*$ as follows.
Let $P = \set{p_1, \ldots, p_m}$. 
For a positive vector $c \in (\Npos)^m$ and $T \in \N$ we define
\[
P^{x \cdot c \leq T} := \setof{\Sigma_{i=1}^m n_i \cdot p_i}{\Sigma_{i=1}^m n_i \cdot c_i \leq T}.
\]
In particular, $P^{\leq T} = P^{x\cdot \vec 1  \leq T}$.
In the sequel, sets of the form
\begin{align} \label{eq:hybrid}
a + P^{x \cdot c \leq T} + Q^*,
\end{align}
for $a\in\N^2$, $c \in (\Npos)^{\card P}$ and $P,Q\subseteqfin \N^2$, 
we call \emph{hybrid} sets.

%\begin{lemma}\label{lem:sandwich-raw}
%There exists a nondecreasing polynomial $R$ such that for every $2$-SLPS $\Lambda$,
%any vector $s \in \N^2$ and $M = \max(\size(\Lambda), \norm(s))$ the set of vectors reachable by $\Lambda$ from $s$ is a finite union of sets $S$ of the following form.
%For each $S$ there exists a base vector $b \in \N^2$, sets of periods vectors $P, Q \subseteq_\fin \N^2$, vector $c \in \N^{|P|}$ and threshold $T \in \N$
%such that
%\[
%S = b + P^{c \cdot x \leq T} + Q^*,
%\]
%where $\norm(b), \norm(P \cup Q), \norm(c) \leq R(M)$ and $c_i \geq 1$ for each $i \in [1, |P|]$.
%\end{lemma}

\begin{lemma}\label{lem:sandwich-raw}
For every \dslps $(\Lambda,s)$,
% any vector $s \in \N^2$ and $M = \size(\Lambda, s)$
the set $\reach(\Lambda,s)$ is a finite union of hybrid sets \eqref{eq:hybrid}, 
% of vectors reachable by $\Lambda$ from $s$ is a finite union of sets $S$ of the following form.
%For each $S$ there exists a base vector $b \in \N^2$, sets of periods vectors $P, Q \subseteq_\fin \N^2$, vector $c \in \N^{|P|}$ and threshold $T \in \N$ such that
%\[
%S = b + P^{c \cdot x \leq T} + Q^*,
%\]
where $\norm(a),  \norm(c), \norm(P \cup Q)$ are bounded polynomially in $\size(\Lambda,s)$.
% and $c_i \geq 1$ for each $i \in [1, |P|]$.
\end{lemma}

Before proving Lemma~\ref{lem:sandwich-raw} we use it to prove Lemma~\ref{lem:slps-sandwich}.
We need to argue that there is a nondecreasing polynomial $F$ such that 
for every \dslps $(\Lambda, s)$ and $B\in\N$, the set $\reach(\Lambda,s)$ is
\kanapka {$F(M)$} {$B$}, where $M=\size(\Lambda,s)$.
%
%Recall that according to the definition of polynomial approximability
%we need to prove that for each $B \in \N$ there is a polynomial $F$ such that for $M = \size(\Lambda, s)$
%the set of points reachable from $s$ via $\Lambda$ is a finite union of:
%\begin{itemize}
%  \item linear sets $S = a + Q^* \subseteq \N^2$ such that $\norm(a) \leq B \cdot F(M)$, $\norm(Q) \leq F(M)$, and
%  \item $B$-approximations of linear sets, namely $S \subseteq \N^2$ such that there are $a \in \N^2$, $Q \subseteq_{\fin} \N^2$ with $\norm(a), \norm(Q) \leq F(M)$, and $a + Q^{\leq B} \subseteq S \subseteq a + Q^*$.
%\end{itemize}
%By Lemma~\ref{lem:sandwich-raw} we have that the considered set is a finite union of sets
%$S$ of the form
%\[
%S = b + P^{c \cdot x \leq T} + Q^*
%\]
%with $\norm(b), \norm(P \cup Q), \norm(c) \leq R(M)$ for some nondecreasing polynomial $R$
%and $c_i \geq 1$ for each $i \in [1, |P|]$.
We fix the nondecreasing polynomial $F(x) = R(x) + R^2(x)$, where $R$ is a polynomial witnessing 
Lemma~\ref{lem:sandwich-raw}, and some arbitrary $B \in \N$,
and prove that each hybrid set $H$ \eqref{eq:hybrid} 
of Lemma~\ref{lem:sandwich-raw} is
\kanapka {$F(M)$} {$B$}.
% 
%It is enough to check each set $S$ separately, namely to check that for each $B \in \N$
%the set $S$ is $(F(M), B)$-approximately semi-linear.
%Fix $B \in \N$.
% and consider the set $b + P^{c \cdot x \leq T} + Q^*$ for some $T \in \N$.
%
We distinguish two cases.
If $T \geq R(M) \cdot B$ then, since $\norm(c)\leq R(M)$, we have
%because each entry of $c$ is at most $R(M)$, we have that
\[
a + (P \cup Q)^{\leq B} \ \subseteq \ H \ \subseteq \ a + (P \cup Q)^*,
\]
and $\norm(a), \norm(P \cup Q) \leq R(M) \leq F(M)$, as required. 
%
On the other hand, if  $T < R(M) \cdot B$ then $H$ is a finite union
of linear sets of the form $u + Q^*$ for $u \in b + P^{c \cdot x \leq T}$, where
\begin{align*}
\norm(u) \ \leq \ \norm(a) + \norm(P) \cdot T 
\ \leq \ R(M) + R(M)^2 \cdot B \leq  F(M) \cdot B,
\end{align*}
as required. 
As before,  $\norm(Q) \leq R(M) \leq F(M)$.
This completes the proof of Lemma~\ref{lem:slps-sandwich} (once
we prove Lemma~\ref{lem:sandwich-raw}). 
\end{appendixproof}
%\begin{align*}
%\norm(u) & \leq \norm(b) + \norm(P) \cdot T \\
%& \leq \norm(s) + n \cdot R(N) + R(N) \cdot B 
%& \leq B + B + R(N) \cdot B = B \cdot (R(N) + 2)  \\
%& \leq B \cdot 2 R'(N)
%\end{align*}
%for $R'(x) = R(x) + 2$. The second to last inequality holds as clearly $\norm(s) \leq B$ and $n \cdot R(N) \leq B$.
%Thus we get Lemma~\ref{lem:slps-sandwich} for the polynomial $R'$.


\begin{appendixproof}[Proof of Lemma~\ref{lem:sandwich-raw}]
The proof occupies the rest of this section.
%The rest of this subsection is devoted to the proof of Lemma~\ref{lem:sandwich-raw}.
We rely on an insightful characterisation of paths of \slps \cite[Theorem 4.16]{DBLP:conf/focs/0001CMOSW24},
which we state below using a slightly different terminology.
%We formulate an easy consequence of this theorem here, in a slightly different and simpler phrasing.
%Before we need to define a few notions.
%
Speaking informally, a \emph{detailing} of an \slps 
$\Lambda = \alpha_0 \beta_1^* \alpha_1 \ldots \alpha_{k-1} \beta_k^* \alpha_k$
is any \slps obtained by fixing exponents of some of the cycles of $\Lambda$.
Formally, a detailing of $\Lambda$ is any $\Lambda'$ obtained by choosing a subset $S \in [1,k]$ and,
for all $i \in S$, by replacing the cycle $\beta_i$ by a path $\beta_i^{n_i}$, for some $n_i\in\N$, 
which becomes an infix of the simple path of $\Lambda'$.
The number of cycles of $\Lambda'$ is thus $k-\card{S}$.
%
An \dslps is \emph{zigzagging} if the effect of its every cycle $\beta_i$ 
belongs either to the quadrant $\Npos \times (-\Npos)$,
or to the quadrant $(-\Npos) \times \Npos$, and additionally effects of every two consecutive cycles belong 
to different quadrants
(the effects of cycles $\beta_1, \ldots, \beta_k$ thus alternate between quadrants), and the effect of the first cycle belongs to $\Npos \times (-\Npos)$ and the effect of the last cycle belongs to $(-\Npos) \times \Npos$.
Finally, an \slps is \emph{short} if it contains at most three cycles, $k\leq 3$.
For $B\in\N$,
a path 
\[
s_0 \trans{\alpha_0} t_0 \trans{\sigma_1} s_1 \trans{\alpha_1} t_1 \ \cdots \ s_{k-1} \trans{\alpha_{k-1}} t_{k-1} \trans{\sigma_{k}} s_k \trans{\alpha_k} t_k
\]
of an \dslps,
where $\sigma_i \in\beta^*$ for $i\in\setto k$, is called \emph{$B$-close} if all the vectors $x\in \{s_0, t_0, s_1, t_1, \ldots, s_k, t_k\}$,
called \emph{midpoints} below,
are \emph{$B$-close} to some axis, namely either $x\in \setfromto 0 B \times \N$ or 
$x\in \N\times\setfromto 0 B$.

\begin{theorem}[Thm 4.16 in~\cite{DBLP:conf/focs/0001CMOSW24}]\label{thm:2slps-zigzag}
For every \dslps $\Lambda$ there is $B\leq \poly(\size(\Lambda))$
such that for every path $s \tran t$ in $\Lambda$ 
there is a detailing $\Lambda' = \Lambda_1 \Lambda_2 \Lambda_3$ of $\Lambda$  
of $\size(\Lambda')\leq \poly(\size(\Lambda))$ and $u, u' \in \setfromto 0 B \times \N$ such that
\begin{enumerate}
%  \item $\size(\Lambda') \leq \poly(M)$,
 %$P(\size(\Lambda))$,
  \item $\Lambda_1$ and $\Lambda_3$ are short, 
  \item $\Lambda_2$ is zigzagging,
  \item there are paths $s \tran u$ in $\Lambda_1$, 
  a $B$-close path $u \tran u'$ in $\Lambda_2$, and 
  $u'\tran t$ in $\Lambda_3$.
\end{enumerate}
%For any $2$-SLPS $\Lambda$, vectors $s, t \in \N^2$ such that $s \trans{\Lambda} t$ and $M = \max(\norm(s), \size(\Lambda))$
%there exists a bound $B = \poly(M)$ and a detailing $\Lambda'$ of $\Lambda$ such that $\Lambda' = \Lambda_1 \Lambda_2 \Lambda_3$
%with the following properties
%\begin{itemize}
%  \item $\size(\Lambda') \leq \poly(M)$,
% %$P(\size(\Lambda))$,
%  \item $\Lambda_1$ and $\Lambda_3$ are short, while $\Lambda_2$ is zigzagging
%  \item there are $u_1, u_2 \in [0,B] \times \N$ such that $s \trans{\Lambda_1} u_1 \trans{\pi} u_2 \trans{\Lambda_3} t$
%  for some $B$-close $\Lambda_2$-path $\pi$.
%\end{itemize}
\end{theorem}

%Due to Theorem~\ref{thm:2slps-zigzag}, in the proof of 
%Lemma~\ref{lem:sandwich-raw} we may safely restrict to paths of the above form. 
Fix in the sequel $B$ given by Theorem~\ref{thm:2slps-zigzag}.
There are only finitely many detailings $\Lambda'$ of $\Lambda$ of a bounded size,
only finitely many possible decompositions of $\Lambda'$ into $\Lambda_1$, $\Lambda_2$ and $\Lambda_3$,
and only finitely many values of $u_1, u'_1\in\setfromto 0 B$.
By Theorem~\ref{thm:2slps-zigzag}, vectors $t$ reachable from $s$ in $\Lambda$ are exactly those
reachable from $s$ in some of detailing $\Lambda'$.
Therefore it is enough
to show Lemma~\ref{lem:sandwich-raw} for the set of vectors $t\in\N^2$ reachable by paths as in point 3 above,
in a fixed \slps $(\Lambda',s)$, where $\Lambda' = \Lambda_1 \Lambda_2 \Lambda_3$ satisfies points 1, 2 above,
and where $u_1 = b$ and $u'_1 = b'$ for some fixed $b,b'\in\setfromto 0 B$.

In a path $u\tran u'$, every second midpoint is $B$-close to one axis,
say $x\in \setfromto 0 B \times \N$,
while the remaining midpoints are $B$-close to the other one.
We relax this requirement slightly, by dropping the latter condition.
A path $u \tran u'$  in the zigzagging \slps $\Lambda_2$
is \emph{$B$-vertical-close} if $u$, $u'$ and every second midpoint $x$
are $B$-close to the vertical axis, namely $x \in \setfromto 0 B \times \N$
(thus the remaining endpoints on the path do not have to be $B$-close to the horizontal axis).
In order to have more flexibility in the proof of Lemma~\ref{lem:sandwich-raw},
in the sequel we consider those paths in $\Lambda'$, as in point 3 in Theorem~\ref{thm:2slps-zigzag}, where the infix
$u\tran u'$ is $B$-vertical-close but not necessarily $B$-close.
Notice that by relaxing the condition to $B$-vertical-closeness
we enlarge the set of considered paths, but do not enlarge the set of reachable points,
as every $t$ such that $s \tran t$ is already reachable by the paths with the middle path being even $B$-close.
We denote by $\reach(\Lambda', s)$ the set of all vectors $t\in\N^2$ reachable by such a path $s\tran t$ with
the middle part being $B$-vertical-close.

We formulate below Claims \ref{cl:prefix}, \ref{cl:infix} and \ref{cl:suffix}
(taking care of a prefix, infix, and suffix, respectively, of a path $s\tran t$), 
show how they imply Lemma~\ref{lem:sandwich-raw}, and finally proceed with the proofs of the three claims.
To this aim we introduce some more notation.
Given a start $a \in \N$, a difference $r \in \N$, and a bound $T \in \N_\infty = \N\cup\{\infty\}$,
the set $a + \{r\}^{\leq T}$ is called \emph{$(a, r, T)$-arithmetic}. 
We omit brackets and write $a + r^{\leq T}$.
In particular, $a + r^{\leq 0} = \{a\}$.
%The first claim essentially says that it is enough to consider only a finite number
%of arithmetic sequences for vectors reachable from $s$ by a short $2$-SLPS.
A \dslps  $\alpha_1 \beta_1^* \alpha_2 \beta_2^*$ is \emph{one-turn} if 
$\eff(\beta_1) \in \Npos  \times -\Npos$ and $\eff(\beta_2) \in -\Npos  \times \Npos$
(it is thus a special case of short zigzagging \dslps).
%
For a set $S\subseteq \N^2$, we use the notation $\reach(\Lambda, S) = \bigcup_{s\in S} \reach(\Lambda, s)$.

In Claims \ref{cl:prefix}, \ref{cl:infix} and \ref{cl:suffix}, we focus on source/target vectors
in $\setfromto 0 B \times \N$ and, intuitively speaking, on arithmetic subsets of each 'line' $\{b\}\times \N$.
First, Claim \ref{cl:prefix} states that the reachability set of a short \dslps, intersected with each line,
is a finite union of arithmetic sets.
Second, Claim \ref{cl:infix} states that the reachability set of a one-turn \dslps from 
an arithmetic set inside a line, intersected with another line, is a finite union of arithmetic sets.
Importantly, the starting point grows only additively, by a polynomially bounded amount, 
as we will apply Claim \ref{cl:infix} $\OO(k)$ times.
Finally, Claim \ref{cl:suffix} states that the reachability set of a short \dslps, from an arithmetic set
inside a line, is a finite union of hybrid sets.
All quantities in the claims are bounded polynomially.

\begin{claim}\label{cl:prefix}
For every short \dslps $(\Lambda,s)$ 
%$M = \size(\Lambda, s)$  
and $u_1 \in [0,B]$,
the set $\{u_2 \mid (u_1, u_2) \in \reach(\Lambda,s)\}$ is a finite union of $(a, r, T)$-arithmetic sets, where
$a \leq \poly(B,M)$, $r \leq \poly(M)$, and $M=\size(\Lambda,s)$.
\end{claim}
%
\begin{claim}\label{cl:infix}
Let $\Lambda$ be a one-turn \dslps,
and $S_1 = a + r^{\leq K}$ for some $a, r, K \in \N$.
Let $u_1, v_1 \in [0, B]$.
The set $R(S_1) := \{v_2 \mid \exists_{u_2 \in S_1} (u_1, u_2) \tran (v_1, v_2) \text{ in } \Lambda\}$
is a finite union of $(a', r', T')$-arithmetic sets with
$a' \leq a + \poly(B,M,r)$ and $r' \leq \max(\poly(M),r)$, where $M=\size(\Lambda)$.
\end{claim}

%
%The last claim takes care about the short suffix of the $2$-SLPS.
%
%\begin{claim}\label{cl:suffix}
%There is a polynomial $R$ such that for every short $2$-SLPS $\Lambda$ such that $M=\size(\Lambda)$, $S_1 = b_1 + \set{p_1}^{\leq T}$
%and $N = \norm(p_1)$ the set $S_2 = \reach_{\Lambda}(S_1)$
%is a finite union of sets $b_2 + P_2^{a \cdot x \leq T} + Q_2^*$ for $\norm(P_2 \cup Q_2), \norm(a) \leq R(N) \cdot R(M)$, $\norm(b_2) \leq (\norm(b_1)+1) \cdot R(N) \cdot R(M)$ and additionally $a_i \geq 1$ for each $i$. 
%\end{claim}
%
\begin{claim}\label{cl:suffix}
For every short \dslps $\Lambda$ and $u= (u_1, u_2), p = (p_1, p_2)\in\N^2$, 
the set $\reach(\Lambda, u + \set{p}^{\leq T})$
is a finite union of hybrid sets \eqref{eq:hybrid},
where $\norm(a), \norm(c), \norm(P), \norm(Q) \leq \poly(\size(\Lambda), \norm(u),\norm(p))$.
\end{claim}

We use the three  claims to derive Lemma~\ref{lem:sandwich-raw}.
As said above,
we consider a fixed \slps $\Lambda' = \Lambda_1 \Lambda_2 \Lambda_3$ and source $s\in\N^2$,
and focus on the set $\reach(\Lambda', s)$ of vectors $t\in\N^2$ such that
there are paths 
%
\begin{align} \label{eq:paths}
\text{$s \tran u$ in $\Lambda_1$,  \ \  
a $B$-vertically close path $u \tran u'$ in $\Lambda_2$, \ \ 
and   $u'\tran t$ in $\Lambda_3$,}
\end{align}
%
for some $u,u'\in \setfromto 0 B \times \N$, where 
$u_1 = b$ and $u'_1 = b'$ are fixed.
Let $M':=\size(\Lambda',s) \leq \poly(M)$.
%
%we aim at characterising the set of vectors $t \in \N^2$ such that
%there is $B \leq \poly(M)$, $u_1, u_2 \in [0, B] \times \N$ and paths $s \trans{\Lambda_1} u_1 \trans{\pi} u_2 \trans{\Lambda_3} t$
%where $\pi$ is a $B$-vertical-close $\Lambda_2$-path. Let us fix some $x_1, x_2 \in [0,B]$ such that $u_1[1] = x_1$ and $u_2[1] = x_2$.
%
%Recall that $M = \size(\Lambda, s)$ and by Theorem~\ref{thm:2slps-zigzag} we have that $\size(\Lambda') \leq \poly(M)$.
First, by Claim~\ref{cl:prefix}, the set
$\{u_2 \mid (u_1, u_2) \in \reach(\Lambda_1,s)\}$ is a finite union of $(a, r, T)$-arithmetic sets,
where $a, r$ are bounded polynomially in $M'$ and $B$.
%
Second,
a path $u\tran u'$ is a concatenation of $\ell\leq \size(\Lambda_2) \leq \poly(M')$
paths of one-turn \slps. 
By $\ell$-fold application of Claim~\ref{cl:infix}, the set
$\{u'_2 \mid (u'_1, u'_2) \in \reach(\Lambda_1 \Lambda_2,s)\}$
is a finite union of arithmetic sets
$a' + (r')^{\leq T'}$, where
%\begin{equation}\label{eq:rprim}
$a', r' \leq \poly(\size(\Lambda_2)) \leq \poly(M')$.
%\end{equation}
Indeed, the bound on $a'$ comes from $\ell$-fold addition of values bounded by 
$\poly(B, \poly(M'), r)\leq \poly(B, \poly(M'), \poly(M'))$,
itself bounded by $\poly(M')$:
%
\begin{equation}\label{eq:aprim}
a' \leq a + \ell \cdot \poly(M') \leq a + \poly(M') \leq \poly(M').
\end{equation}
%
Finally, by Claim~\ref{cl:suffix} the set $\reach(\Lambda',s)$ is a finite union of hybrid sets \eqref{eq:hybrid},
where
$
\norm(a)$, $\norm(c)$, $\norm(P \cup Q) \leq \poly(M', B) \leq \poly(M).
$ 
%By equations~\eqref{eq:rprim}~and~\eqref{eq:aprim} we have $N = \max(a', r') \leq \poly(M)$.
%Therefore
%\[
%\norm(c), \norm(b), \norm(P \cup Q) \leq \poly(M),
%\]
We conclude the proof of Lemma~\ref{lem:sandwich-raw}, keeping in mind that
it still remains to demonstrate Claims~\ref{cl:prefix},~\ref{cl:infix},~and~\ref{cl:suffix}.

\medskip

Here is  a corollary of Lemma~\ref{lem:taming}, useful in the proofs of the three claims:
%
\begin{lemma}\label{lem:solutions}
Consider a system $A\cdot x = b$ of $m$ Diophantine linear equations with $n$ unknowns,
where absolute values of coefficients are bounded by $N$.
Then, the set of solutions is of a form $U+P^*$, where
$\norm(U \cup P) \leq \poly(nN)^{\poly(n,m)}$.
\end{lemma}

\begin{proof}
The solution set is of the form $U+P^*$,
where $U$ is the set of pointwise minimal nonnegative integer solutions of the system,
and $P$ is the set of pointwise minimal nonnegative integer solutions of its homogeneous version
$A\cdot x = \vec 0$.
By Lemma~\ref{lem:taming} each element of $U \cup P$ has norm at most $M= \Oo(nN)^m$.
Therefore, the number of different solutions is at most $(M+1)^n$, which implies 
$\norm(U \cup P) \leq \poly(nN)^{\poly(n,m)}$.
\end{proof}
%
In the sequel we apply Lemma~\ref{lem:solutions} in case when $n$ and $m$ are constants,
in which case Lemma \ref{lem:solutions} yields the bound $\norm(U+P) \leq \poly(N)$.

\begin{proof}[Proof of Claim~\ref{cl:prefix}]
For $d \in \setto 2$ and
a path $\gamma$, let $\eff_j(\gamma)$ denote the $j$-th coordinate of $\eff(\gamma)$, and
let $\drop_j(\gamma)\in\N$ be the maximal value of $-\eff_j(\delta)$, where $\delta$ ranges over prefixes of $\gamma$,
that is  the maximal amount by which the $j$-th coordinate can be decreased along $\gamma$.

\Wlog we assume that $\Lambda$ has exactly three loops, 
$\Lambda = \alpha_1\beta_1^{*}\alpha_2\beta_2^{*}\alpha_3\beta_3^{*}\alpha_4$. 
We describe paths $s = (s_1, s_2) \tran (u_1, u_2)$ in $\Lambda$,
\begin{align*}
(s_1, s_2) = \ & 
(a^1_1, a^1_2) \trans{\alpha_1} (b^1_1, b^1_2) \trans{\beta_1^{n_1}}
(a^2_1, a^2_2) \trans{\alpha_2} (b^2_1, b^2_2) \trans{\beta_2^{n_2}} \\
& (a^3_1, a^3_2) \trans{\alpha_3} (b^3_1, b^3_2) \trans{\beta_3^{n_3}}
(a^4_1, a^4_2) \trans{\alpha_4} (b^4_1, b^4_2) = (u_1, u_2),
\end{align*}
by the following system of linear Diophantine inequalities, with unknowns 
$a^{i}_1, a^{i}_2, b^{i}_1, b^{i}_2$, for $i\in\setto 4$, and $n_i$, for $i\in\setto 3$,
ensuring that the effects of $\alpha_i$ and $\beta_i^{n_i}$ are respected, 
and that all points along $\alpha_i$ remain nonnegative 
:
%
%\begin{itemize} 
%\item $a^{i}_1, a^{i}_2$, for $i\in\setto 4$, denoting the midpoint just before the execution of $\alpha_{i}$ 
%(for $i=1$, the source);
%\item $b^{i}_1, b^{i}_2$, for $i\in\setto 4$, denoting the midpoint just after  the execution of $\alpha_{i}$
%(for $i=4$, the target);
%\item $n_i$, for $i\in\setto 3$, denoting the number of times $\beta_i$ is executed.
%\end{itemize}
%
%\noindent
%Therefore the path from $s$ to $t$ has the following form:
%
%The following system of inequalities $\U$ guarantees that the path of $\Lambda$ is inside the positive quadrant.
%
\begin{align*}
a^{i}_j + \eff_j(\alpha_i) \ = \ & \ b^{i}_j  & a^1_j \ = \ & \ s_j \\
b^{i}_j + n_i \cdot \eff_j(\beta_i) \ = \ & \ a^{i+1}_j & b^4_1 \ = \ & \ u_1 \\
a^i_j - \drop_j(\alpha_i) \ \geq \ & \ 0 
\end{align*}
%
Notice that each $\beta_i$ is a single transition, so nonnegativity of $(b_i^1, b_i^2)$ and $(a_{i+1}^1, a_{i+1}^2)$
implies that all the vectors along  $\beta_i^{n_i}$ are also nonnegative. Therefore, we do not need to
add an analog of $a^i_j - \drop_j(\alpha_i) \geq 0$ for $\beta_i$ to the above system.
%
%\begin{enumerate}[(1)]
%\item For each $i \in [1,4]$ and $d \in [1,2]$ we take care of the effect of $\alpha_i$:\label{eq:LPS_eff_1}
%$$a_{i}^d + \eff_d(\alpha_i) = b_{i}^d$$
%\item For each $i \in [1,3]$ and $d \in [1,2]$ we take care of the effect of $\beta_i$:\label{eq:LPS_eff_2}
%$$b_{i}^d + n_i \cdot \eff_d(\beta_i) = a_{i+1}^d$$
%\item For each $i \in [1,4]$ and $d \in [1,2]$ we take care that counter remains nonnegative along $\alpha_i$
%$$a_i^d + \drop_d(\alpha_i) \geq 0$$ \label{eq:LPS_non}
%\item For each $d \in [1,2]$ we take care that a path starts in $s$.
%$$a_1^d = s_d$$\label{eq:LPS_start}
%\item We take care that the first coordinate of the target is equal to $x$.
%$$b_4^1 = x$$\label{eq:LPS_end}
%\end{enumerate}
%Notice that . 
By adding dummy variables we change inequalities into equations,
thus obtaining a system $\U$ of linear Diophantine equations.
All the coefficients in $\U$ are bounded by $\max(B, M)$, 
and all coefficients in its homogeneous version are bounded by $M$.
Therefore, by Lemma~\ref{lem:solutions} the solution set of $\U$ is $U+P^*$,
where $\norm(U) \leq \poly(B,M)$ and $\norm(P) \leq \poly(M)$.
By projecting the solution set to the variable $b^4_2$, we deduce that
the set $S:=\{u_2 \mid (u_1, u_2) \in \reach(\Lambda,s)\}$ is a finite union of 
linear sets $a+X^*$, where $a \leq P_1(B,M)$ and $X \subseteq [0,P_2(M)]$,
for some nondecreasing polynomials $P_1, P_2$.
%
% $a \leq \poly(B,M)$ and $X \subseteqfin \N$, such that
%for each $x \in X$ we have $x \leq \poly(M)$.
%
%$(a, r, T)$-arithmetic sets, where
%$a \leq \poly(B,M)$, $r \leq \poly(M)$, and $M=\size(\Lambda,s)$.
%
\begin{claim}\label{cl:linear-1dim}
For every $a,b \in \N$ and $B \subseteq [1,b]$, the linear set $a+B^*$ is a finite union
of arithmetic sets $c + d^*$, where $c \leq a+b^3$ and $d \leq b$.
\end{claim}
\begin{proof}
Let $B = \set{b_1, \ldots, b_m}$.
Let $n \in a + B^*$, and let $(k_1, \ldots, k_m) \in \N^m$ be the lexicographically smallest vector such that
$n = a + \sum_{i=1}^m k_i \cdot b_i$.
We observe that $k_i < b$ for all $i\in\setto {m-1}$ since,
% may hold for at most one $i\in\setto m$.
supposing $k_i \geq b$ for
$i < m$, we would get a lexicographically smaller  vector
\[
(k_1, \ldots, k_{i-1}, k_i - b_m, k_{i+1}, \ldots, k_m+ b_i) \in \N^m
\]
with the same property. 
Thus $n \in a + r + b_m^*$,
where $r = \sum_{i<m} k_i \cdot b_i \leq b^3$. 
As $n\in a+ B^*$ was chosen arbitrarily, we deduce
%This means any $n \in a+B^*$ satisfies $n \in c+b_i^*$, where $c \leq a+b^3$. In consequence
\[
a+B^* \ = \bigcup_{c \leq a+b^3, c \in a+B^*} c + b_m^*,
\]
which concludes the proof of Claim~\ref{cl:linear-1dim}.
\end{proof}
%
By Claim~\ref{cl:linear-1dim}, the set $S$ is a finite union of arithmetic sets  $a+x^*$, where 
$a \leq P_1(B,M) + P_2(M)^3$ and $x \leq P_2(M)$,
which concludes the proof of Claim~\ref{cl:prefix}.
Notice that we actually get $T = \infty$ or $T=0$ in all the arithmetic sets, but that is not needed for our considerations.
\end{proof}

\input{claim}


\begin{proof}[Proof of Claim~\ref{cl:suffix}]
\Wlog we assume $\Lambda = \alpha_1\beta_1^*\alpha_2\beta_2^*\alpha_3\beta_3^*\alpha_4$.
Let $S_1 = b + \set{p}^{\leq T}$  and $S_2 = \reach_{\Lambda}(S_1)$. Recall, that $\eff_j(\gamma)$ denotes the $j$-th coordinate of $\eff(\gamma)$, and
$\drop_j(\gamma)\in\N$ is the maximal value of $-\eff_j(\delta)$, where $\delta$ ranges over prefixes of $\gamma$,
that is  the maximal amount by which the $j$-th coordinate can be decreased along $\gamma$.

Similarly as in the proof of Claim~\ref{cl:prefix} we describe paths $s = (s_1,s_2) \tran (t_1, t_2) = t$ in $\Lambda$,
\begin{align*}
(s_1, s_2) = &
(a_1^1, a_2^1) \trans{\alpha_1} (b_1^1, b_2^1) \trans{\beta_1^{n_1}}
(a_1^2, a_2^2) \trans{\alpha_2} (b_1^2, b_2^2) \trans{\beta_2^{n_2}} \\
& (a_1^3, a_2^3) \trans{\alpha_3} (b_1^3, b_2^3) \trans{\beta_3^{n_3}}
(a_1^4, a_2^4) \trans{\alpha_4} (b_1^4, b_2^4) = (t_1, t_2).
\end{align*}
Notice that $(s_1, s_2) = (a_1^1, a_2^1) \in S_1$, so $(a_1^1, a_2^1) = u + p^n$ for some $n \in \N$. The following system of linear Diophantine inequalities $\U$ with unknowns $a_1^i, a_2^i, b_1^i, b_2^i$ for $i \in [1,4]$, and $n_i$, for $i \in [1,3]$, and unknown $n$, ensures that the effects of $\alpha_i$ and $\beta_i^{n_i}$ are respected, and that all points along $\alpha_i$ remain nonnegative and that $s \in S_1$:

\begin{align*}
a^{i}_j + \eff_j(\alpha_i) \ = \ & \ b^{i}_j  & a^1_j \ = \ & \ u_j + n \cdot p_j \\
b^{i}_j + n_i \cdot \eff_j(\beta_i) \ = \ & \ a^{i+1}_j & n \ \leq \ & \ T \label{eq:LPS_bound} \\
a^i_j - \drop_j(\alpha_i) \ \geq \ & \ 0 
\end{align*}
Notice that each $\beta_i$ is a single transition, so nonnegativity of $(b_i^1, b_i^2)$ and $(a_{i+1}^1, a_{i+1}^2)$
implies that all the vectors along  $\beta_i^{n_i}$ are also nonnegative. Therefore, we do not need to
add an analog of $a^i_j - \drop_j(\alpha_i) \geq 0$ for $\beta_i$ to the above system. We first focus on the solutions of $\U$ without the equation $n \leq T$, 
and inequalities $a^i_j - \drop_j(\alpha_i) \geq 0$ transformed into equations with dummy variables on the right, similarly as in the proof of Claim~\ref{cl:prefix}. Let us call such system $\U'$. All the coefficients of $\U'$ are bounded by $\max(M, \norm(u), \norm(p))$. By Lemma~\ref{lem:solutions} set of solutions of $\U'$ can be described as $L(U, V)$ for $\norm(U \cup V) \leq \poly(M, \norm(u), \norm(p))$.

%$\norm(U \cup P) \leq R(N) \cdot R(M)$ for some polynomial $R$. After adding equalities~\eqref{eq:LPS_end2} by Proposition~\ref{prop:fix_variables} we get solutions of the form $L(U', P')$ for $\norm(U') \leq R(N) \cdot R(M) \cdot (\norm(b_1) + 1)$ and $\norm(P') \leq R(N) \cdot R(M)$.

Now we have to care about the last inequality, namely $n \leq T$. If for some $a \in U$ we have $n > T$ then we can remove it from $U$. Let $U'$ be the set $U$ without the removed elements.
As the set $U'$ is finite it is enough to prove the conclusion of Claim~\ref{cl:suffix} separately for each $a \in U'$. Fix $a \in U'$.
We have $\norm(a), \norm(V) \leq \poly(M, \norm(u), \norm(p))$.
It is enough to prove that elements of the set $L(a, V)$ that additionally satisfy $n \leq T$, projected to the variables
$b^4_1$ and $b^4_2$ can be described as a finite union of the sets of the form we need.

Let us consider all the elements of set $V$. Let $Q \subseteq V$ be the set of these elements $v \in V$,
for which $v[n] = 0$ (that means that unknown $n$ is equal to $0$ in elements $v$),
while $P = V \setminus Q$ be the set of the other elements $v \in V$,
so that for which $v[n] > 0$.
Notice that using elements in $Q$ does not influence satisfying $n \leq T$, therefore they
can be used unbounded number of times.
Let $P = \set{p_1, \ldots, p_\ell}$ and let $p_i[n] = c_i$. For each $x \in L(a, V)$ we have $x = a + q + \Sigma_{i=1}^{\ell}k_i \cdot p_i$ where $q \in Q^*$. Hence, in order to satisfy $n \leq T$ we have to satisfy $\innprod c k \leq (T - a[n])$, where $c = (c_1, \ldots, c_\ell) \in \N_{>0}^\ell$ and $k = (k_1, \ldots, k_\ell) \in \N^\ell$.
As $c \in \N_{>0}^\ell$, if $T - a[n] < 0$ then the set of solutions is empty. Otherwise, the set of solutions can be represented as $a+P^{c \cdot x \leq T - a[n]}+Q^*$. Recall that $\norm(a), \norm(P \cup Q) \leq \poly(M, \norm(u), \norm(p))$, and additionally $c \in \N_{>0}^{\ell}$. Additionally $\norm(c) \leq \ell \cdot \norm(P)$, where
$\ell$ is the number of elements in $P$, thus $\ell \leq (\norm(P) + 1)^k$, where $k$ is the number of unknowns in $\mathcal U$
(so $k$ is a constant).
In consequence $\norm(c) \leq \poly(M, \norm(u), \norm(p))$. Summarising, the projection
of $a+P^{c \cdot x \leq T - a[n]}+Q^*$ into variables $b^4_1$ and $b^4_2$ is of the required form.
\end{proof}
%
Claims \ref{cl:prefix}, \ref{cl:infix} and \ref{cl:suffix} are thus shown, and hence so is Lemma~\ref{lem:sandwich-raw}.
%
\end{appendixproof}
