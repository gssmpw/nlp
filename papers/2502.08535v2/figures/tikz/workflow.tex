\begin{figure}
  \centering
  
  \tikzstyle{flow} = [fill=Cyan, minimum width=1cm, minimum height=9pt, inner sep=2pt]
  \begin{tikzpicture}[
    node distance=2cm,
    on grid,
    auto]

  %%% FIREWALL
  \node (ap) {\includegraphics[scale=0.06]{figures/testbed/wireless-ap.png}};
  \node (firewall)[xshift=0.3cm,yshift=-0.25cm,label={[align=center,yshift=0.2cm]below:{LAN AP\\+ firewall}}] at (ap) {\includegraphics[scale=0.05]{figures/testbed/firewall.png}};

  %%% DEVICE EVENTS
  % Device
  \node (device) [left=1.5cm of ap,label={[yshift=0.1cm]below:{device}}] {\includegraphics[scale=0.04]{figures/workflow/cpu.png}};
  \draw[->,thick,Cyan] (device) -- (ap) node[midway,above,label={[black,yshift=-0.1cm]above:{pkts}}] {\includegraphics[scale=0.02]{figures/workflow/box.png}};
  % Event trigger
  \node (event) [left=1.2cm of device,label={[align=center,yshift=0.1cm]below:{interaction\\trigger}}] {\includegraphics[scale=0.05]{figures/workflow/phone.png}};
  \draw[->,thick] (event) -- (device);

  % PCAP files
  \node (pcap) [right=2cm of ap,label={[yshift=0.1cm]below:{PCAPs}}] {\includegraphics[scale=0.07]{figures/workflow/files.png}};
  \draw[->,thick] (ap) -- (pcap);

  %%% Signature extraction
  \node (sig-ex) [right=1.7cm of pcap,label={[align=center,yshift=0.1cm] below:{Signature\\extraction}}] {\includegraphics[scale=0.06]{figures/workflow/gears.png}};
  %\node[right=2cm of pcap, rounded corners, fill=blue!20, align=center, text centered] (sig-ex) {Signature\\extraction};
  \draw[->,thick] (pcap) -- (sig-ex);
  % Background
  \begin{scope}[on background layer]
    \coordinate [above=0.6cm of sig-ex,xshift=-0.7cm] (sig-ex-top-left);
    \coordinate [below=1.2cm of sig-ex,xshift=0.7cm] (sig-ex-bottom-right);
    \draw [rounded corners, draw=none, fill=blue!20] (sig-ex-top-left) rectangle (sig-ex-bottom-right);
  \end{scope}

  % Event signature
  \node (ev-sig) [below=2.3cm of sig-ex, label={[yshift=0.1cm,align=center]below:{Event\\signature}}] {\includegraphics[scale=0.07]{figures/workflow/file.png}};
  \draw[->,thick] ([yshift=-0.6cm]sig-ex.south) -- (ev-sig);

  % Extracted network flows
  \node[flow, left=1.75cm of ev-sig] (flow-c) {$c$};
  \node[flow, above=0.5cm of flow-c, fill=Cyan] (flow-b) {$b$};
  \node[flow, below=0.5cm of flow-c, fill=Cyan, label={[yshift=-0.2cm]below:{Flow IDs}}] (flow-d) {$d$};
  \coordinate [above=0.3cm of flow-b, xshift=-0.7cm] (rect-top-left);
  \coordinate [below=0.3cm of flow-d, xshift=0.7cm] (rect-bottom-right);
  \draw (rect-top-left) rectangle (rect-bottom-right);

  % Arrows: Event signature -> flows
  \node (split) [circle, fill=black, inner sep=1pt, left=0.75cm of ev-sig] {};
  \draw[thick] (ev-sig) -- (split.center);
  \draw[->,thick] (split.center) -- (flow-c);
  \draw[->,thick] (split.center) |- (flow-b);
  \draw[->,thick] (split.center) |- (flow-d);

  %%% TREE
  \begin{scope}[
    font=\scriptsize,
    level distance=0.7cm,
    edge from parent/.style={draw,-latex},
    every node/.style={circle, draw, minimum size=0.5cm, inner sep=0pt},
    level 1/.style={sibling distance=1.6cm},
    level 2/.style={sibling distance=0.6cm}
    ]
    % Draw the binary tree
    \node (tree-root) [left=3cm of flow-c,yshift=1cm] {}
        child {node (tree-left) {}
            child {node {}}
            child {node {}}
        }
        child {node (tree-right) {}
            child {node[dotted] {$b$} edge from parent[dotted]}
            child {node[dotted] {$c$} edge from parent[dotted]}
            child {node[dotted] {$d$} edge from parent[dotted]}
        };

    \draw[red, thick, rotate=-40] (tree-root)[xshift=0.5cm] ellipse (0.9cm and 0.5cm);
  \end{scope}
  \node (tree-caption) [below=2cm of tree-root,align=center] {Multi-level event signature tree};

  % Arrow: flows to tree
  \draw[->,thick] ([xshift=-0.2cm,yshift=-0.4cm]flow-c.west) -- ([xshift=0.8cm,yshift=-0.7cm]tree-right.east);

  % Arrow: tree -> AP
  \draw[->, red, thick] ([yshift=0.1cm]tree-root.north) -- (ap);

  %% Output profile
  \node (profile) [left=1.75cm of tree-left,yshift=0.25cm,label={[align=center,yshift=0.1cm]below:{multi-level\\profile}}] {\includegraphics[scale=0.07]{figures/workflow/profile.png}};
  \draw[->, thick] ([xshift=-0.3cm,yshift=0.2cm]tree-left.west) -- ([yshift=-0.05cm]profile.east);

  \end{tikzpicture}
  %\vspace{-2mm}
  \caption{Overview of the profiling workflow}
  %\vspace{-5mm}
  \label{fig:workflow}
\end{figure}