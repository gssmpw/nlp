\begin{figure}
    \centering
    
    \begin{tikzpicture}[node distance=2cm,on grid,auto]
  
        %%% NODES %%%
      
        % Routers
        \node (ap){\includegraphics[scale=0.06]{figures/testbed/wireless-ap.png}};
        \node (router)[right=1.3cm of ap,yshift=1cm]{\includegraphics[scale=0.07]{figures/testbed/router.png}};
  
        %% IP devices
        \node (phone) [right=1.3cm of ap,yshift=0cm] {\includegraphics[scale=0.05]{figures/testbed/smartphone.png}};
        % Plugs
        \node (wifi-plug-1)[left=2.5cm of ap, yshift=8mm]{\includegraphics[scale=0.035]{figures/testbed/power-socket.png}};
        \node (wifi-plug-2)[left=0.6cm of wifi-plug-1]{\includegraphics[scale=0.035]{figures/testbed/power-socket.png}};
        \node (wifi-plug-3)[left=0.6cm of wifi-plug-2]{\includegraphics[scale=0.035]{figures/testbed/power-socket.png}};
        % Cameras
        \node (camera-1)[left=2.5cm of ap]{\includegraphics[scale=0.05]{figures/testbed/camera.png}};
        \node (camera-2)[left=0.8cm of camera-1]{\includegraphics[scale=0.05]{figures/testbed/camera.png}};
        \node (camera-3)[left=0.8cm of camera-2]{\includegraphics[scale=0.05]{figures/testbed/camera.png}};
        % Lights
        \node (wifi-light-1)[left=2.5cm of ap, yshift=-8mm]{\includegraphics[scale=0.05]{figures/testbed/light-bulb.png}};
        \node (wifi-light-2)[left=0.7cm of wifi-light-1]{\includegraphics[scale=0.05]{figures/testbed/light-bulb.png}};
  
        % Hubs / Gateways
        \node (hue-bridge)[below=1cm of ap]{\includegraphics[scale=0.05]{figures/testbed/gateway.png}};
        \node (st-hub)[above=1cm of ap]{\includegraphics[scale=0.05]{figures/testbed/gateway.png}};
  
        % Zigbee devices
        \node (hue-light)[left=1.2cm of hue-bridge]{\includegraphics[scale=0.05]{figures/testbed/light-bulb.png}};
        \node (st-plug)[left=1.2cm of st-hub]{\includegraphics[scale=0.035]{figures/testbed/power-socket.png}};
  
        % Internet
        \node (internet)[right=1.7cm of router]{\includegraphics[scale=0.08]{figures/testbed/cloud.png}};
  
  
        %%% EDGES %%%
  
        % WAN
        \draw [wan]    (ap)          -- (router);
        \draw [wan]    (router)      -- (internet);
  
        % Wired LAN
        \draw [lan]    ([yshift=-0.1cm]hue-bridge.north)  -- ([yshift=0.1cm]ap.south);
        \draw [lan]    ([yshift=0.1cm]st-hub.south) -- ([yshift=-0.1cm]ap.north);
  
        % WLAN
        \draw [wlan] (phone)       -- (ap);
        \draw [wlan] (wifi-plug-1)  -- (ap);
        \draw [wlan] (camera-1)    -- (ap);
        \draw [wlan] (wifi-light-1)  -- (ap);
  
        % Zigbee
        \draw [zigbee]   (hue-light)  -- (hue-bridge);
        \draw [zigbee]   (st-plug)     -- (st-hub);
  
  
        %%% LEGEND %%%
  
        % Caption
        \node (legend)  [below=7.5mm of internet,xshift=-6mm] {\textbf{Legend}};
        % WAN
        \node (wan-a)   [below=0.1cm of legend.south west] {};
        \node (wan-b)   [right=0.6cm of wan-a] {};
        \draw [wan]     (wan-a) -- (wan-b);
        \node (wan-key) [right=0.4cm of wan-a.east] {WAN};
        % Wired LAN
        \node (lan-a)   [below=0.3cm of wan-a] {};
        \node (lan-b)   [right=0.6cm of lan-a] {};
        \draw [lan]     (lan-a) -- (lan-b);
        \node (lan-key) [right=0.4cm of lan-a.east] {Wired LAN};
        % WLAN
        \node (wlan-a) [below=0.3cm of lan-a] {};
        \node (wlan-b) [right=0.6cm of wlan-a] {};
        \draw [wlan]   (wlan-a) -- (wlan-b);
        \node (wlan-key) [right=0.4cm of wlan-a.east] {WLAN};
        % Zigbee
        \node (zigbee-a) [below=0.3cm of wlan-a] {};
        \node (zigbee-b) [right=0.6cm of zigbee-a] {};
        \draw [zigbee]   (zigbee-a) -- (zigbee-b);
        \node (zigbee-key) [right=0.4cm of zigbee-a.east] {Zigbee};
        % Box
        \coordinate [above=0.25cm of legend,xshift=-0.65cm] (rect-top-left);
        \coordinate [below=0.25cm of zigbee-key,xshift=1.15cm] (rect-bottom-right);
        \draw [ultra thin] (rect-top-left) rectangle (rect-bottom-right);
  
    \end{tikzpicture}
    %\vspace{-2mm}
    \caption{Experimental Smart Home network.}
    %\vspace{-5mm}
    \label{fig:testbed}
  \end{figure}