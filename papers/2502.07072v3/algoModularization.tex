\begin{algorithm}
\caption{Repairing Intent}
\label{algo:repair}
\begin{algorithmic}[1]
\Function{Repair}{$\pi_\theta$, $\pi_{\theta_{ref}}$, $D^E$, $D^R$, $D^N$, $\alpha$}
  \Repeat
    \State $X^R, Y^R \gets \text{batch}(D^R)$\label{algorp:1}\algorithmiccomment{Get a good batch}
    \State $X^E, Y^E \gets \text{batch}(D^E)$\label{algorp:2}\algorithmiccomment{Get corresponding bad batch as slicing criteria}
    \State $X^N, Y^N \gets \text{batch}(D^N)$\label{algorp:3}\algorithmiccomment{Get a normal batch}

    \State $\theta_\text{slice} \gets \text{Slice}(\pi_\theta,X^E, Y^E)$\algorithmiccomment{Sliced parameters}\label{algorp:4}

    \State $L_1 \gets \text{NLL}(X^R, Y^R, \theta_{\text{slice}})$\algorithmiccomment{Repair loss}\label{algorp:5}
    \State $L_2 \gets \text{KL}(X^N, Y^N, \theta_{\text{slice}}, \theta_{\text{ref}})$\algorithmiccomment{KL loss}\label{algorp:6}
    \State $L \gets \alpha \cdot L_1 + L_2$\label{algorp:7}\algorithmiccomment{Total loss}
    \State $G \gets \nabla(L, \theta_\text{slice})$\algorithmiccomment{Gradients w.r.t slice}\label{algorp:8}
    \State $update(\theta_{\text{slice}}, G)$\algorithmiccomment{Update parameters of $M$}\label{algorp:9}
  \Until{convergence}\label{algorp:10}
  \State \textbf{return} $\pi_{\theta}$\algorithmiccomment{Return repaired model}\label{algorp:11}
\EndFunction
\end{algorithmic}

\end{algorithm}
