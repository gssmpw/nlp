\section{Study Design}
\label{Section:methodology}


\begin{figure*}[t]
\centering 
\includegraphics[width=1.0\textwidth]{Images/Approach-v2.pdf}
\caption{\textcolor{black}{Overview of the empirical study design, highlighting the 3 main phases: Dataset Extraction, Selection of Quality Attributes and Software Metrics, and Data Analysis.}}
\label{fig:approach_overview}
\end{figure*}

Our primary objective is to explore the alignment between developers' perceptions of code duplicate removal (as anticipated by developers) and the actual improvement in software quality (as evaluated by quality metrics). Specifically, our aim is to address the following research questions.
\begin{boxK}
\textbf{RQ$_1$}: \textcolor{black}{What is the quantitative code quality assessment of code duplications that have been intentionally removed by developers?}

\textbf{RQ$_2$}: \textcolor{black}{What are the refactoring operations associated with code duplicate removal?}
\end{boxK}

To address our research questions, we conducted a three-phase empirical study. \textcolor{black}{An overview of the experiment methodology is depicted in Figure \ref{fig:approach_overview}. The initial phase involves extracting a substantial number of open-source Java projects along with their instances of refactoring throughout their development history, specifically focusing on commit-level code changes for each project under consideration. In the second phase, we select software quality metrics to compare their values before and after the identified refactoring commits. Subsequently, the third phase involves analyzing commit messages to identify refactoring commits where developers document their perception of code duplicate removal. In the next subsection, we discuss each phase in detail.}

\subsection{Extracted Dataset}

Our study uses the SmartSHARK MongoDB Release 2.2 dataset  \citep{trautsch2021msr}. This dataset contains a wide range of information for 128 open-source Java projects, such as commit history, issues, refactorings, code metrics, mailing lists, and continuous integration data. All Java projects are part of the Apache ecosystem and utilize GitHub as their version control repository and JIRA for issue tracking. SmartSHARK utilizes \texttt{RefDiff} \citep{silva2017refdiff} and \texttt{RefactoringMiner} \citep{tsantalis2018accurate} to mine refactoring operations. \textcolor{black}{This study is motivated to investigate code duplication-aware refactoring practices in Apache projects. A recent study \citep{xiao2024empirical} highlights the Apache Software Foundation as a prominent example of successful open-source software communities \citep{mockus2002two,mockus2000case,crowston2006assessing}. Both practitioners and researchers have been extracting valuable insights and gaining experience from Apache's effective practices to drive the open-source movement forward \citep{rigby2008open,duenas2007apache,weiss2006evolution}. Furthermore, Apache is a collaborative environment where engineers from major corporations such as IBM, Google, Yahoo, Sun, and Oracle volunteer to develop open-source software infrastructure \citep{severance2012apache}.} 

%  this study is motivated to investigate the usage of mocking frameworks in Apache projects since Apache Software Foundation has been widely recognized
% and researched as a distinguished example of successful open-source software communities (Mockus et al. 2002, 2000; Crowston and Howison 2006). Practitioners and researchers
% have been gaining experience and insights from the successful practices of Apache projects
% to lead the open-source movement (Rigby et al. 2008; Duenas et al. 2007; Weiss et al. 2006).
% In addition, Apache provides a meeting point where engineers from large companies like
% IBM, Google, Yahoo, Sun, and Oracle work as volunteers to build open-source software
% infrastructure (Severance 2012).

To extract the relevant information, we built custom scripts to extract data pertinent to our study (\ie commits, metrics, refactorings) from
the source dataset into an SQLite database for analysis. First, we extract all commits with the keyword `duplicat*' and `code clone', discussed later in Section \ref{dataanslysis}. Next,
we extract all refactoring operations. However, due to the use of two refactoring mining tools, there are duplicate operations in the source data. \textcolor{black}{Hence, our next step is to remove all duplicates by comparing the refactoring descriptions. After that, we select all
commits associated with a refactoring operation. Using both refactoring mining tools allowed us to mitigate the limitations of relying on a single tool and ensured a more diverse and thorough dataset.} Table \ref{Table:DATA_Overview} summarizes the extracted data.




\subsection{Quality Attributes \& Quality Metrics Selection}
To setup a comprehensive set of quality attributes for evaluation in our study, we initially analyze existing studies to identify commonly recognized software quality attributes \citep{chidamber1994metrics,lorenz1994object,mccabe1976complexity, henry1981software, nejmeh1988npath, Destefanis:2014:SMA:2813544.2813555}. Next, we assess whether the metrics evaluate various object-oriented design aspects, mapping each internal quality attribute to the corresponding structural metric(s). %For example, the Response For Class (RFC) metric is typically used to measure Coupling and Complexity quality attributes. 
  Additionally, we extract associations between metrics (such as the CK suite \citep{chidamber1994metrics}, McCabe \citep{mccabe1976complexity}, and Lorenz and Kidd's book \citep{lorenz1994object}) and internal quality attributes from the literature review. \textcolor{black}{Tables \ref{Table:Quality Metrics in Related Work} and \ref{Table:Quality Metrics in Related Work-v2} summarize the extracted metrics.}

Subsequently, we examined the extracted metrics to determine whether these metrics exist in the SmartSHARK dataset, calculated using OpenStaticAnalyzer\footnote{https://github.com/sed-inf-u-szeged/OpenStaticAnalyzer}. The extraction process results in 32 distinct structural metrics as shown in Table \ref{Table:Quality Metrics Used in This Study.}. The list of metrics is (1) well-known and defined in the literature, and (2) can assess different code-level elements, \ie method, class, package. % and (3) can be calculated by existing static analysis tools. 

%We also adopted NOA andNOO since they measure quality aspects of a class that are not takeninto account by the CK metrics

\subsection{Data Analysis}
\label{dataanslysis}

\input{Tables/ProjectOverview}

After extracting all refactoring commits, we want to keep only commits where refactoring is documented. We continue to filter them, using the content of their messages at this stage. We use a keyword-based search to find commits whose messages contain the keywords (\ie `duplicat*' or `code clone*'). We selected these keywords because these keywords are naturally used by developers to articulate their intent regarding code duplication \citep{alomar2019can,alomar2021we}. However, it is worth mentioning that we did not find any commits with the keyword `code clone'. Therefore, all the commits in our dataset solely include the keyword `duplicat'.

This keyword-based filtering selected 2,169,916 commit messages. %We notice that the ratio of these commits is very small compared to the total number of refactoring commits, \ie \hl{\#}. However, these observations are consistent with previous studies \citep{murphy2012we,szoke2014bulk} as developers typically do not provide details when documenting their refactorings. 
To ensure that these commits reported developers' intention to remove code duplication, we manually inspected and read through 322 distinct refactoring commits to remove false positives. An example of a discarded commit is: \say{\textit{DeferredDuplicates.java}}. We discarded this commit because the keyword `duplicat' is actually part of the identifier name of the class. In the case of doubts about including a certain commit, it was excluded. This step resulted in considering 322 commits. Our goal is to have a \textit{gold set} of commits in which the developers explicitly reported the removal of duplicate code. This \textit{gold set} will serve to check later if there is an alignment between the real quality metrics affected in the source code, and the code duplicate removal as documented by developers. 
 An example of commit messages belonging to the \textit{gold set}, is showcased in the following commit message  \say{\textit{Refactored JavaClass and FieldOrMethod to avoid a code duplication}}. %This commit message shown in Figure \ref{fig:commit message} suggests that the developers performed a code refactoring to eliminate code duplication. Figures \ref{fig:duplicate 1} and \ref{fig:duplicate 2} depict the two instances of code duplication present in the codebase. The developer employed the `Extract Method' refactoring technique (see Figure \ref{fig:method extraction}), which involves isolating a code fragment and relocating it to form a new method, subsequently replacing all occurrences of that fragment with a call to the newly created method.

\input{Tables/Metrics}
We perform a qualitative analysis of intriguing instances of alignment or disparity between the removal of code duplication as perceived by developers and its evaluation through quality metrics. To do this, the author manually inspects the commits, which involves analyzing the diff code alongside the metrics profile of the affected code elements before and after the commit.

\begin{comment}

\begin{itemize}
    \item commit id for those commits that contain either “\%duplicat\%” or “\%code clone\%” in the commit message
    \item Refactoring type is `extract method'
    \item code entity is method
\end{itemize}



\begin{figure*}[htbp]
	\centering
    \includegraphics[scale = 0.35]{Images/CommitMessage.png}   
    \caption{Commit message indicating the removal of code duplication \citep{commons-bcel}.}
    \label{fig:commit message}

\vspace{0.70cm}

	\centering
    \includegraphics[width=0.5\textwidth]{Images/DuplicateMethod1.png}   
    \caption{Code snippet depicting the first instance of code duplication before refactoring \citep{commons-bcel}.}
    \label{fig:duplicate 1}

\vspace{0.70cm}

\centering 
\includegraphics[scale = 0.2]{Images/DuplicateMethod2.png}
\caption{Code snippet depicting the second instance of code duplication before refactoring \citep{commons-bcel}.}
\label{fig:duplicate 2}

\vspace{0.70cm}

\centering 
%\scalebox{0.8}{\includegraphics[width=\columnwidth]{Images/DiffPreconditionChecking.PNG}}
\includegraphics[scale = 0.2]{Images/ExtractedMethod.png}
\caption{Code snippet depicting the removal of the duplicated code through the `Extract Method' refactoring \citep{commons-bcel}.}
\label{fig:}
\label{fig:method extraction}
\vspace{0.70cm}


\end{figure*}
\end{comment}

The resulting commits correspond to our data points, each data point is represented by a set of \textit{pre-refactoring} and \textit{post-refactoring} Java files. These data points will be used in the experiments, to measure the effect of changes in terms of structural metrics, with respect to the quality attribute, announced in the commit message.

