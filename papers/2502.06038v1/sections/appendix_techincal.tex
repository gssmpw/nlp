\section{Proofs for Generic Framework}
\label{sec:proofs_framework}

\subsection{Proofs for Blowup and Shift Bounds}
We first need to bound the variance and expectation of the columns of $\Embed \cdot X$:
\begin{lemma}[Bounds on Expectation and Variance]
	\label{lem:boundsVar}
	Let $X \in \InpSpace$ be an input sequence.
	% Write $X = (s | X_{\text{free}} | q)$$
 %    \left(\bigtimes_{i = 1}^{\ndes} \{ \desSet_i\} \right) \times X_{\text{free}} \times \{\vecQuery\}$, where
	% $\desSet_i$ are the desired token sets,
	% $X_{\text{free}}$ consists of the possible free tokens, and
	% $\vecQuery$ is the query token.
	Then for any column $j$, the expectation $\mu_j$ of the $j$-th column of $\Embed \cdot X$ satisfies:
	\begin{align*}
		\frac{1}{\nctx} &\left(
			\sum_{i=1}^{\ndes} \Embed[\desSet_i] \vec{e}_j^T + 
			\nfree \min_{x \in [\dVocab]} (\Embed[x] \vec{e}_j^T) + 
			\Embed[q]\vec{e}_j^T
		\right)
		\leq \mu_j  \\
				&\leq
				\frac{1}{\nctx}\left(
					\sum_{i=1}^{\ndes} \Embed[\desSet_i]\vec{e}_j^T + 
					\nfree \max_{x \in [\dVocab]} (\Embed[x]\vec{e}_j^T) + 
					\Embed[q]\vec{e}_j^T
				\right)
		\end{align*}
		Let $\mu_j^{\min}$ and $\mu_j^{\max}$ denote the lower and upper bounds for the $j$-th column respectively.
		Then, we can bound the variance of the $j$-th column of $\vec{x} \Embed$ by
		\begin{align*}
			\frac{1}{\nctx} &\bigg[
				\min_{\mu' \in [\mu_j^{\min}, \mu_j^{\max}]}  \sum_{i = 1}^s \left(\Embed[\desSet_i] \vec{e}_j^T -  \mu' \right)^2 + \nfree \cdot \min_{x \in [\dVocab]} \left( \Embed[x] \vec{e}_j^T -  \mu' \right)^2 + \left( \Embed[q] \vec{e}_j^T -  \mu' \right)^2
			\bigg] \\
					&\leq \Var_j[(\Embed \cdot X)[:, j]] \leq \\
				\frac{1}{\nctx} &\bigg[
					\sum_{i = 1}^s \max_{\mu' \in [\mu_j^{\min}, \mu_j^{\max}]} \left(\Embed[\desSet_i] \vec{e}_j^T -  \mu' \right)^2 + \nfree \cdot \max_{x \in [\dVocab]} \left( \Embed[x] \vec{e}_j^T -  \mu' \right)^2 + \left( \Embed[q] \vec{e}_j^T -  \mu' \right)^2
				\bigg].
				\end{align*}
				We define $\Var_j^{\min}, \Var_j^{\max}$ to be the lower and upper bounds respectively.
			\end{lemma}
			\begin{proof}
				The bounds on $\mu_j$ follow as we minimize and maximize the contribution of each free row.
				The proof of for variance bounds follows similarly.
			\end{proof}

We now have a simple proof for \cref{lem:boundsBS} restated below:
\begin{lemma}[Blowup and Shift Bounds]
	We bound blowup and shift: for every $B_j \in \blowupSet_j$ and $S_j \in \shiftSet_j$
	\[
		\frac{\gamma}{\sqrt{\Var_j^{\max} + \eps}} \leq B_j \leq \frac{\gamma}{\sqrt{\Var_j^{\min} + \eps}}
	\]
	and
	\begin{align*}
	&\min\left(B_j^{\min} \mu_j^{\min}, B_j^{\min} \mu_j^{\max}, B_j^{\max}, \mu_j^{\min}, B_j^{\max} \mu_j^{\max}\right)
	\leq
	S_j\\
	&\leq
	\max\left(B_j^{\min} \mu_j^{\min}, B_j^{\min} \mu_j^{\max}, B_j^{\max}, \mu_j^{\min}, B_j^{\max} \mu_j^{\max}\right)
	\end{align*}
\end{lemma}
\begin{proof}
	Given the bounds on expectation and variance, $B^{\min}, B^{\max}$ follow trivially from the definition of blowup and shift sets.
	$S^{\min}$ (resp. $S^{\max}$) follow from a minimization (maximization) over the possible shifts given the blowup bounds.
\end{proof}

\subsection{Appendix for Bounding Worst-case Deviation of $\fenc$}
\label{sec:appConcrcase}

Recall the definition of blowup and shift sets from \cref{def:blowup_shift}.
			Let $B^{\min}, B^{\max}$ be the vectors $(B_1^{\min}, \dots, B_\dEmb^{\min})$ and $(B_1^{\max}, \dots, B_\dEmb^{\max})$ respectively.
			Define $S^{\min}, S^{\max}$ analogously.
			We restate \cref{lem:WD_fenc} for convenience:
			\begin{lemma}[Worst-case deviation of $\fenc$, \cref{lem:WD_fenc}]
				\label{lem:worst_case_deviation}
				Let $\vec{x} \in \InpSpace$.
				Then,
				\[
					\WD(\vece_{\nctx} \cdot \fenc; \InpSpace \times \blowupSet \shiftSet)_\infty \leq 
					\max_{t \in [\dVocab]} 
					\max_{j \in [\dEmb]}
					\max_{B \in [\vec{0}, B^{\max} - B^{\min}]}
					\left|X[t] \cdot \Embed \cdot \diag(B) \cdot \vec{e}_j\right| + \left|S_j^{\max} - S_j^{\min}  \right|
                    \]	
				where the inner maximum term can be computed via a simple linear program.
			\end{lemma}
			\begin{proof}
                    First, note that for $j \in [\dEmb]$,
				\begin{align*}
					\WD(\vece_{j}^T \cdot (\fenc)^T; \InpSpace \times \blowupSet \shiftSet)_\infty 
						&= \max_{t, B, S, B', S'} \left\|
						X[t] \cdot E \cdot \diag(B) + S - X[t] \cdot E \cdot \diag(B') - S'
						\right\|_\infty \\
						&\leq max_{t, B, S, B', S'}
						\left|\left(X[t] \cdot E \cdot (\diag(B) - \diag(B')) + S - S'\right) \cdot \vec{e}_j\right| \\
						&\leq max_{t, B, B'}  \left|\left(X[t] \cdot E \cdot (\diag(B) - \diag(B')) \right) \cdot \vec{e}_j\right| + |S_j^{\max} - S_j^{\min}|.
				\end{align*}		
				Note then that $\diag(B)_j - \diag(B')_j$ is constrained by $B^{\max}_j - B^{\min}_j$.
                We can then maximize over $j$ to get
                \begin{align*}
                    \WD(\vece_\nctx \cdot \fenc; \InpSpace \times \blowupSet \shiftSet)_\infty 
                    &\leq 
                    \WD(\fenc; \InpSpace \times \blowupSet \shiftSet)_\frobInf  \\
                    &\leq \max_{t, B, B'} \max_j  \left|\left(X[t] \cdot E \cdot (\diag(B) - \diag(B')) \right) \cdot \vec{e}_j\right| + |S_j^{\max} - S_j^{\min}|
				\end{align*}
                as desired.
			\end{proof}



\subsection{Proofs and Subalgorithms for Attention Bounds}
\begin{definition}[$\ell^{min}$, $\ell^{max}$] \label{def:lminlmax}
	We use $\ell^{\min}_i$ to denote 
	a worst-case lower bound on the smallest possible logit at the $i$-th position of the input to the softmax in model $\Model$. 
	Similarly, we use $\ell^{\max}_i$ to denote a worst-case upper bound on the largest possible logit at the $i$-th position of the input to the softmax in model $\Model$.
\end{definition}

We provide the algorithm to find the extremal values $\vec{\ell}^{\min}$ and $\vec{\ell}^{\max}$ in \cref{alg:lminlmax}.
At a high level, the algorithm computes upper and lower bounds for each position in the input sequence prior to the softmax.
The bounds make use of the upper and lower bounds on the blowup and shift sets, $\blowupSet \shiftSet$.


\begin{algorithm}[h] 
	\caption{
        Algorithm to find $\vec{\ell}^{\min}$ and $ \vec{\ell}^{\max}$.
        To find the minimums and maximums over $\blowupSet \shiftSet$, we use the point-wise upper and lower bounds on the blowup and shift sets alongside the bounds obtained from \cref{alg:bilin}.}
	\label{alg:lminlmax}
	\begin{algorithmic}
		\STATE {\bfseries Input:}  $\blowupSet\shiftSet, \Model$
		\STATE
		\FOR{$k \in [\nfix]$}
		\STATE Let \begin{align*}
		\vec{\ell}^{\min}_k = \frac{1}{\sqrt{\dEmb}} \min_{B, S  \in \blowupSet\shiftSet} (\vece_{q} E \cdot \diag(B) + S) \cdot Q \PosRot_{k, \nctx} 
		K^T \cdot  (\vece_{\desSet_k} E \cdot  \diag(B) + S)^T
		\end{align*}
		and 
		\[
		\vec{\ell}^{\max}_k = \frac{1}{\sqrt{\dEmb}}  \max_{B, S \in \blowupSet\shiftSet} (\vece_{q} E \cdot \diag(B) + S) \cdot Q \PosRot_{k, \nctx} K^T \cdot  (\vece_{\desSet_k} E \cdot  \diag(B) + S)^T
		\]
		\ENDFOR
		\STATE
		\FOR{$k \in (\nfix, \nctx)$}
		\STATE Let \[
		\vec{\ell}^{\min}_k = \frac{1}{\sqrt{\dEmb}} \min_{t \in [\dVocab]} \min_{B, S \in \blowupSet\shiftSet} (\vece_q E \cdot \diag(B) + S) \cdot Q \PosRot_{k, \nctx} K^T \cdot  (\vece_t E \cdot  \diag(B) + S)^T
		\]
		and 
		\[
		\vec{\ell}^{\max}_k = \frac{1}{\sqrt{\dEmb}} \max_{t \in [\dVocab]} \max_{B, S \in \blowupSet\shiftSet} (\vece_q E \cdot \diag(B) + S) \cdot Q \PosRot_{k, \nctx} K^T \cdot  (\vece_t E \cdot  \diag(B) + S)^T
		\]
		\ENDFOR
		\STATE
		\STATE Set the extremal values of the query token:
		\[
		\vec{\ell}^{\min}_\nctx = \frac{1}{\sqrt{\dEmb}} \min_{B, S \in \blowupSet\shiftSet} (\vece_{q} E \cdot \diag(B) + S) \cdot Q \PosRot_{k, \nctx} K^T \cdot  (\vece_{q} E \cdot  \diag(B) + S)^T
		\]
		and
		\[
		\vec{\ell}^{\max}_\nctx = \frac{1}{\sqrt{\dEmb}}  \max_{B, S \in \blowupSet\shiftSet} (\vece_{q} E \cdot \diag(B) + S) \cdot Q \PosRot_{k, \nctx} K^T \cdot  (\vece_{q} E \cdot  \diag(B) + S)^T
		\]
		\STATE
		\STATE Return $\vec{\ell}^{\min}, \vec{\ell}^{\max}$
	\end{algorithmic}
\end{algorithm}


\begin{algorithm}[h] 
	\caption{Simple algorithm to bound the minimum of $\vec{x} A \vec{y}^T$ for $X^{\min}_i \leq \vec{x}_i \leq X^{\max}_i$ and $Y^{\min}_i \leq \vec{y}_i \leq Y^{\max}_i$.
        To find the maximum, switch the minimum to maximum and vice versa.
    }
	\label{alg:bilin}
	\begin{algorithmic}
            \STATE \textbf{Input:} $A, X^{\min}, X^{\max}, Y^{\min}, Y^{\max}$
            \STATE
            \STATE $m \leftarrow 0$
            \FOR{$i = 1$ to $n$}
            \FOR{$j = 1$ to $m$}
            \IF{$A_{ij} > 0$}
            \STATE $m \leftarrow m + A_{ij} \cdot \max\left(X^{\min}_i Y^{\min}_j, X^{\max}_i Y^{\min}_j, X^{\min}_i Y^{\max}_j, X^{\max}_i Y^{\max}_j \right)$
            \ELSE
            \STATE $m \leftarrow m + A_{ij} \cdot  \min\left(X^{\min}_i Y^{\min}_j, X^{\max}_i Y^{\min}_j, X^{\min}_i Y^{\max}_j, X^{\max}_i Y^{\max}_j \right)$
            \ENDIF
            \ENDFOR
            \ENDFOR
            \STATE Return $m$
        \end{algorithmic}
\end{algorithm}

\begin{proof}[Proof sketch for \cref{lem:lminlmax} (correctness of \cref{alg:lminlmax})]
	In \cref{alg:lminlmax}, for each position $k$, we compute the minimum and maximum logit for the $k$-th position by maximizing over possible blowup and shift sets and input tokens for the free tokens.
	Moreover, \cref{alg:bilin} computes an upper and lower bound for the restricted bilinear form which \cref{alg:lminlmax} uses to compute the extremal values.

    The correctness of the bilinear bound in \cref{alg:bilin} follows from a series of relaxations when writing out the explicit formula for the bilinear multiplication.
    To prove an upper-bound, we have that 
    \begin{align*}
        m &= \sum_{i} x_i A_{i, j} y_j \\
        &\leq \sum_i \max (A_{i, j} X_i^{\min} Y_i^{\min},  A_{i, j} X_i^{\min} Y_i^{\max}, A_{i, j} X_i^{\max} Y_i^{\min}, A_{i, j} X_i^{\max} Y_i^{\max}).
    \end{align*}
    Then, if $A_{i, j}$ is negative, we can factor the coefficient out of the maximization and flip to a minimization. Otherwise, we can simply factor $A_{i, j}$ out of the maximization.
    Thus, \cref{alg:bilin} gives a valid upper-bound. The lower-bound follows analogously.
\end{proof}

We now prove \cref{lem:min_max_softmax}, restated here:

\begin{lemma}[Minimum and Maximum after Softmax]
	\begin{equation}
		\label{eq:softmax_upper}
		\ssMinFB \leq
		\sum_{j \in (\nfix, \nctx)} \softmax(\ell_j) \leq
		\ssMaxFB
	\end{equation}
	aswell as,
	\begin{align}
		\label{eq:softmax_lower}
		\ssMinRB \leq
		\sum_{j \in [\nfix] \cup \{\nctx\}} \softmax(\ell_j) \leq
		\ssMaxRB.
	\end{align}
\end{lemma}
\begin{proof}[Proof of \cref{lem:min_max_softmax}]
	We will prove the right hand side of \cref{eq:softmax_upper} and the left hand side of \cref{eq:softmax_lower} as the other follow by the same proof.
	Note the second inequality follows from the first inequality and the fact that the sum of the attention weights is $1$.

	Now, we will show the first inequality.
	Clearly, smaller values of $\vec{\ell}_i$ results in larger value of $\softmax(\vec{\ell}_j)$.
	Then, let $\vec{\eta}$ be a vector where $\sum_{j \in (\ndes, \nctx]} \softmax(\vec{\eta}_j) > \sum_{j \in (\ndes, \nctx]} \softmax(\vec{\ell}_j)$.
	Then, we have that
	\begin{align*}
		0 &\leq \left[\left(\sum_j e^{\vec{\eta}_j}\right) - \left(\sum_j e^{\vec{\ell}_j}\right)\right] \left(\sum_i e^{\vec{\ell}_i}\right)  \\
		\Rightarrow &\left(\sum_j e^{\vec{\eta}_j} \right)\left(\sum_i e^{\vec{\ell}_i} + \sum_j e^{\vec{\ell}_j} \right) \leq
        \left(\sum_j e^{\vec{\ell}_j}\right) \left(\sum_i e^{\vec{\eta}_i} + \sum_j e^{\vec{\eta}_j}\right) \\
		\Rightarrow & \frac{\sum_j e^{\vec{\eta}_j}}{\sum_i e^{\vec{\ell}_i} + \sum_j e^{\vec{\eta}_j}} \leq 
        \frac{\sum_j e^{\vec{\ell}_j}}{\sum_i e^{\vec{\ell}_i} + \sum_j e^{\vec{\ell}_j}}.
	\end{align*}
\end{proof}

\newcommand{\free}{\text{free}}
\newcommand{\fix}{\text{fix}}
Finally, we prove the bound on worst-case deviation of attention (\cref{lem:att_bound}):
\begin{lemma}
	Worst-case deviation of attention is bounded as follows,
	\begin{align*}
		\WD(\vecNctx \cdot f^{\attnH}_{\ndes \mid r, q} ; \InpSpace \times \blowupSet \shiftSet)_\infty
	     &\leq
	     2 \cdot (\ssMaxRB - \ssMinRB) \cdot \max_{B, S}\norm{\Embed[[\nfix] \cup \{\nctx\}, :] \cdot \diag(B) + S}_{\frobInf} \\
		&+ 2 \cdot \ssMaxFB \cdot \max_{B, S} \norm{(E \cdot \diag(B) + S) \cdot V}_{\frobInf}
        + \ssMaxFB  \norm{V}_\infty \cdot \max_{t \in s \cup \{q\}} \WD(\fenc; \{\vece_t\} \times \blowupSet \shiftSet\}))_\infty
	\end{align*}
        where $V$ is the value matrix in the attention head (see \cref{sec:appendix_model}).
\end{lemma}
\begin{proof}[Proof of \cref{lem:att_bound}]
	\label{proof:att_bound}
	Define $\vec{p}(X) \in \R^{\nctx}$ as the probability vector for the query token post-softmax.
	I.e.
	\[
		\vec{p}_j = \softmax(\vec{\ell}_j) \text{ for } j \in [\nctx]
	\]
	where \[
		\vec{\ell} = \frac{\vecNctx \cdot(Y \cdot \RoPE(Q) \RoPE(K^T) Y^T}{\sqrt{\dEmb}}
	\]
	for $Y = X \Embed \cdot \diag(B(X)) + S(X)$.
	Moreover, let $\vec{p}(X)_{\free} = \vec{p}(X)[(\nfix, \nctx)]$ (i.e.\ the values corresponding to the free tokens) and $\vec{p}(X)_{\fix} = \vec{p}(X)[[\nfix] \cup \{\nctx\}]$ (the values corresponding to the fixed and query token).
	Now, we re-write the worst-case deviation of the attention head: for $X, X' \in \InpSpace$, $(B, S), (B', S') \in \blowupSet \shiftSet$,
	\begin{align*}
		\WD&(\vecNctx \cdot f^{\attnH}_{\ndes \mid r, q} ; \InpSpace \times \blowupSet \shiftSet)_\infty
			\leq  \max_{X, X', (B, S), (B', S')} 
			\norm{\vec{p}(X) \cdot (X \Embed \cdot \diag(B) + S) V - \vec{p}(X') \cdot (X \Embed \cdot \diag(B') + S') V}_\infty \tag{by definition of an attention head} \\
		   &\leq \max_{X, X', (B, S), (B', S')} \bigg\|\vec{p}(X)_\fix \cdot (X[[\nfix] \cup \{\nctx\}:, ] \Embed \cdot \diag(B) + S) V + \vec{p}(X)_\free \cdot (X[(\nfix, \nctx):, ] \Embed \cdot \diag(B) \\ &+ S) V - \vec{p}(X')_\fix \cdot (X'[[\nfix] \cup \{\nctx\}:, ] \Embed \cdot \diag(B') + S') V - \vec{p}(X')_\free \cdot (X'[(\nfix, \nctx):, ] \Embed \cdot \diag(B) + S) V \bigg\| \\
		   &\leq \max_{X, X', (B, S), (B', S')} \bigg\|\vec{p}(X)_\fix \cdot (X[[\nfix] \cup \{\nctx\}:, ] \Embed \cdot \diag(B) + S) V - \vec{p}(X')_\fix \cdot (X'[[\nfix] \cup \{\nctx\}:, ] \Embed \cdot \diag(B') \\ &+ S') V\bigg\| + \bigg\|\vec{p}(X)_\free \cdot (X[(\nfix, \nctx):, ] \Embed \cdot \diag(B) + S) V - \vec{p}(X')_\free \cdot (X'[(\nfix, \nctx):, ] \Embed \cdot \diag(B) + S) V \bigg\|.
		   \tag{by triangle inequality} \\
	\end{align*}
	Now, we will bound the two norms in the above equation separately.
	First, note that $\ssMinFB \leq \sum \vec{p}(X)_\free \leq \ssMaxFB$ and $\ssMinRB \leq \sum \vec{p}(X)_\fix \leq \ssMaxRB$ by definition of the extremal values (\cref{def:soft-extrem-values}).
	For the case of the free tokens,
	\begin{align*}
		&\max_{X, X', B, B', S, S'} \bigg\|\vec{p}(X)_\free \cdot (X[(\nfix, \nctx):, ] \Embed \cdot \diag(B) + S) V - \vec{p}(X')_\free \cdot (X'[(\nfix, \nctx):, ] \Embed \cdot \diag(B) + S) V \bigg\|_\infty
		\\
		&\leq 2 \cdot \max_{X, B, S} \bigg\|\vec{p}(X)_\free \cdot (X[(\nfix, \nctx):, ] \Embed \cdot \diag(B) + S) V \bigg\|_\infty \tag{by triangle inequality} \\
		&\leq 2 \cdot \max_{B, S} \sum_{i \in (\nfix, \nctx)} \vec{p}(X)_\free[i]  \cdot \left\| (X[i, :] \Embed \cdot \diag(B) + S) V \right\|_\infty \tag{by  triangle inequality} \\
		&\leq 2 \cdot \max_{B, S} \max_i \ssMaxFB \cdot \left\|(X[i, :] \Embed \cdot \diag(B) + S) V \right\|_\infty \tag{by definition of $\vec{p}(X)_\free$} 
	\end{align*}
	where the last inequality follows from the fact that $\vec{p}(X)_\free$ is non-negative and the sum is at most $\ssMaxFB$.
	Finally, note that $\max_i \ssMaxFB \| X[i, :] \Embed \cdot \diag(B) + S) V\| \leq \ssMaxFB\max_{t \in [\dVocab]} \|\Embed[t, :] \cdot (\diag(B) + S) V\|$ as the maximum free token contribution is at most the maximum contribution from any possible token.
	Finally, for the free tokens, we get a bound
	\[
		2 \cdot \ssMaxFB \cdot \max_{B, S, t \in [\dVocab]} \norm{(\Embed[t] \cdot \diag(B) + S) V}_\infty 
		= 2 \cdot \ssMaxFB \cdot \max_{B, S} \norm{(\Embed \cdot \diag(B) + S) V}_\frobInf.
	\]
	We now bound the fixed tokens contribution:
	\[
		\max_{X, X', (B, S), (B', S')} \bigg\|\vec{p}(X)_\fix \cdot (X[[\nfix] \cup \{\nctx\}:, ] \Embed \cdot \diag(B) + S) V - \vec{p}(X')_\fix \cdot (X'[[\nfix] \cup \{\nctx\}:, ] \Embed \cdot \diag(B') + S') V\bigg\|
	\]
	We start by noting that the fixed tokens must be an element of $\desSet \cup \{q\}$ and are, by definition, fixed for all $X$
	And so,
	\begin{align*}
		&\max_{X, X', (B, S), (B', S')} \bigg\|\vec{p}(X)_\fix \cdot (X[[\nfix] \cup \{\nctx\}:, ] \Embed \cdot \diag(B) + S) V - \vec{p}(X')_\fix \cdot (X'[[\nfix] \cup \{\nctx\}:, ] \Embed \cdot \diag(B') \\ &+ S') V\bigg\| = \max_{X, X', (B, S), (B', S')} \bigg\|(\vec{p}(X)_\fix \cdot (\Embed[s \cup \{q\}, :] \cdot \diag(B) + S) V - \vec{p}(X')_\fix \cdot (\Embed[s \cup \{q\}, :] \cdot \diag(B') + S') V\bigg\| \\
		&\leq \max_{X, X', (B, S), (B', S')} \sum_i \bigg\|\vec{p}(X)_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B) + S) V - \vec{p}(X')_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B') + S') V\bigg\| \tag{by the triangle inequality}
	\end{align*}
	where $t_i$ is the $i$-th fixed token.
	Now, we want to re-write the last line to factor out the differing blowup and shift values.
	\begin{align*}
		&\max_{X, X', (B, S), (B', S')} \sum_i \bigg\|\vec{p}(X)_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B) + S) V - \vec{p}(X')_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B') + S') V\bigg\| \\
		&= \max_{X, X', (B, S), (B', S')} \sum_i \bigg\|\vec{p}(X)_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B) + S) V \\
		-& \vec{p}(X')_\fix[i] \cdot (\Embed[t_i, :] \cdot (\diag(B) + S - (\diag(B) + S - \diag(B') - S')) V\bigg\| \\
		 &\leq \max_{X, X', (B, S)} \sum_i \bigg\|\vec{p}(X)_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B) + S) V - \vec{p}(X')_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B) + S) V\bigg\| \\
		+& \max_{X, (B, S), (B', S')} \sum_i \vec{p}(X)_\fix[i] \cdot \bigg\| (\Embed[t_i, :] \cdot \diag(B) + S) V - (\Embed[t_i, :] \cdot \diag(B') + S') V\bigg\| \tag{By the triangle inequality}
	\end{align*}
	We now bound the two terms separately.
	For the second term, we have that
	\begin{align*}
		&\max_{X', (B, S), (B', S')} \sum_i \vec{p}(X')_\fix[i] \cdot \bigg\| (\Embed[t_i, :] \cdot \diag(B) + S) V - (\Embed[t_i, :] \cdot \diag(B') + S') V\bigg\| \\
		&\leq \max_{(B, S), (B', S')} \max_i \ssMaxRB \cdot \bigg\| (\Embed[t_i, :] \cdot \diag(B) + S) - (\Embed[t_i, :] \cdot \diag(B') + S')\bigg\| \cdot \norm{V}_\infty \tag{By definition of $\vec{p}(X')_\fix$} \\
		&\leq \norm{V}_\infty \cdot \ssMaxRB \max_{t \in s \cup \{q\}} \WD(\fenc; \{\vece_{t}\} \times \blowupSet \shiftSet).
	\end{align*}

	For the first term, we get
	\begin{align*}
		&\max_{(B, S), X, X'} \sum_i \bigg\|\vec{p}(X)_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B) + S) V - \vec{p}(X')_\fix[i] \cdot (\Embed[t_i, :] \cdot \diag(B) + S) V\bigg\| \\	
		&= \max_{(B, S), X,X'} \sum_i \bigg\|\left(\vec{p}(X)_\fix[i] - \vec{p}(X')_\fix[i]\right) \cdot (\Embed[t_i, :] \cdot \diag(B) + S) V \bigg\|\\
		&= \max_{(B, S), X, X'} \sum_i \left(\vec{p}(X)_{\fix}[i] - \vec{p}(X')_{\fix}[i]\right) \cdot \bigg\|(\Embed[t_i, :] \cdot \diag(B) + S) V \bigg\|\\
		&\leq \max_{(B, S), i} (\ssMaxFB - \ssMinFB) \cdot \bigg\|(\Embed[t_i, :] \cdot \diag(B) + S) V \bigg\|
	\end{align*}
	where the last inequality follows from the fact that $\vec{p}(X)_\fix[i] - \vec{p}(X')_\fix[i]$ is at most $\ssMaxFB - \ssMinFB$.
	Then, by definition of the $\frobInf$ norm, we have that
	\[
		\max_{(B, S), i} (\ssMaxFB - \ssMinFB) \cdot \bigg\|(\Embed[t_i, :] \cdot \diag(B) + S) V \bigg\| = (\ssMaxFB - \ssMinFB) \cdot \max_{B, S} \norm{(\Embed[s \cup \{q\}, :] \cdot \diag(B) + S) V}_\frobInf.
	\]

	Putting the above together, we get the desired bound:
	\begin{align*}
		\WD(\vecNctx \cdot f^{\attnH}_{\ndes \mid r, q} ; \InpSpace \times \blowupSet \shiftSet)_\infty
	     &\leq
	     (\ssMaxRB - \ssMinRB) \cdot \max_{B, S}\norm{\Embed[\desSet \cup \{q\}, :] \cdot \diag(B) + S}_{\frobInf} \\
	     &+ 2 \ssMaxFB \cdot \max_{B, S} \norm{(E \cdot \diag(B) + S) \cdot V}_{\frobInf}.
	     + \norm{V}_\infty \ssMaxRB \max_{t \in s \cup \{q\}} \WD(\fenc; \{\vece_{t}\} \times \blowupSet \shiftSet).
	\end{align*}

\end{proof}


\subsection{Proofs for MLP Bounds}
\begin{proof}[Proof of \cref{lem:mlpbound}]
	\label{proof:mlp_bound}
	The second statement follows from $\vec{e}_\nctx \cdot f^{\Iden}_{\ndes \mid r, q} = \fenc$ directly.
	Then, the first statement follows from the Lipschitz constant of the MLP:
	\begin{align*}
		\norm{\MLP(\vec{e}_\nctx \Embed B + S) - \MLP(\vec{e}_\nctx \Embed B' + S')}_\infty
			&\leq \LipMLP_\infty \cdot \norm{\vec{e}_\nctx \Embed B + S - \vec{e}_\nctx \Embed B' + S'}_\infty \\ &\leq \LipMLP_\infty \cdot \WD(\vec{e}_\nctx \cdot  \fenc; \InpSpace \times \blowupSet \shiftSet)_\infty.
	\end{align*}
\end{proof}

\subsection{Proof of \cref{thm:InpRes}}
\label{subsec:InpResProof}
First we will restate \cref{thm:InpRes} for convenience:
\begin{theorem}
	%The model $\desF{\ModelFinal}$ over domain $[X]$ if 
	If
	\begin{align*}
	    &\WD(\desF{\Model}; \InpSpace)_\infty
	  \\&< \peakToPeak(\desF{\Model}, X) / 2,
	\end{align*}
	then the output of model $\desF{\Model}$ is fixed for all inputs in $\InpSpace$.
	Moreover, we can use \cref{alg:overwhelmCheckDet} to produce an upper bound $W$ for $\WD(\desF{\Model}; \InpSpace)_\infty$.
\end{theorem}
\begin{proof}
	We first make use of \cref{thm:metathm} to prove the first statement of the above theorem.
	Now, we just need to prove that the bound, $W$ in \cref{alg:overwhelmCheckDet}, is a valid bound on the lift $\WD(\desF{\Model}; \InpSpace \times \blowupSet \shiftSet)_\infty$.
	By the monotonicity of lifting, we then have that $\WD(\desF{\Model}; \InpSpace)_\infty \leq \WD(\desF{\Model}; \InpSpace \times \blowupSet \shiftSet)_\infty.$

	First note that, by \cref{lemma:worst_case_deviation_properties}, we have that
	\begin{align*}
		\WD(\desF{\Model}; \InpSpace \times \blowupSet \shiftSet)_\infty &\leq \Lip(\Unembed)_\infty \cdot (\WD(f^{\attnH}; \InpSpace \times \blowupSet \shiftSet)_\infty \\ &+ \WD(f^{\MLP}; \InpSpace \times \blowupSet \shiftSet)_\infty + \WD(f^{\Iden}; \InpSpace \times \blowupSet \shiftSet)_\infty) 
	\end{align*}
	where
	\[
		f^{\component}(X, (B, S)) = \component \circ \fenc(X, (B, S)) 
	\]
	and
	\[
		\fenc(X, (B, S)) = (X \cdot \Embed \cdot \diag(B) + S).
	\]
	Then, we can use \cref{lem:att_bound} to get that $W^\attn$ is a valid bound on the worst-case deviation of $f^{\attnH}$.
	Then, we use \cref{lem:mlpbound} to get that $\Lip(\MLP)_\infty \cdot \WD(\fenc; \InpSpace \times \blowupSet\shiftSet)$ is a valid bound on the worst-case deviation of $f^{\MLP}$.
	Finally, we use \cref{lem:WD_fenc} to get the bound on $\fenc$.
\end{proof}
%\subsection{Lipschitz Constant of the Later Layers}
%\label{subsec:later_layer_lip}
%
%\subsubsection{Lipschitz Constant of Query and Key}
%\label{subsubsec:query_key_lip}
%
%\lev{TODO check, and cite for quad form
%also use picture on this medium post %https://medium.com/@ngiengkianyew/understanding-rotary-positional-encoding-40635a4d078e
%for rotary encodings explanation...
%}
%\begin{lemma}
%	\label{lem:quad_form_lip}
%	Let $f(x,y) = x^T A y$ where $A = Q \cdot \diag(R(\theta_i)) \cdot K^T$ and $R(\theta_i)$ are 2×2 rotation matrices.
%	For all $p$-norms with $p \geq 2$, the Lipschitz constant of the query and key matrices is bounded by \lev{TODO fix}:
%	$$\|f(x_1,y_1) - f(x_2,y_2)\| \leq \|A\|(\|x_1-x_2\|\|y_1\| + \|x_2\|\|y_1-y_2\|)$$
%	with $\|A\| \leq \|Q\|\|K\|$.
%\end{lemma}
%\begin{proof}
%	Consider the difference of bilinear forms $f(x_1,y_1) - f(x_2,y_2) = x_1^TAy_1 - x_2^TAy_2$.
%	This can be rewritten as $(x_1^T-x_2^T)Ay_1 + x_2^TA(y_1-y_2)$ by adding and subtracting $x_2^TAy_1$.
%	Applying the triangle inequality and submultiplicativity of norms yields \[
%		\|f(x_1,y_1) - f(x_2,y_2)\| \leq \|A\|(\|x_1-x_2\|\|y_1\| + \|x_2\|\|y_1-y_2\|).
%	\]
%	The operator norm of $A$ can be bounded as \[
%		\|A\|_p = \|Q \cdot \diag(R(\theta_i)) \cdot K^T\| \leq \|Q\|\|\diag(R(\theta_i))\|\|K\| \leq \|Q\|\|K\|
%	\]
%	where the last inequality follows from the fact that rotation matrices have norm at most 1 for all $p \geq 2$.
%	\lev{TODO: specify $p \geq 2$}
%\end{proof}
%
%%\begin{lemma}
%%	\lev{TODO: check rotation}
%%	Let $f(x) = x^T A x$ where $A = Q \cdot \text{diag}(R(\theta_i))  \cdot K^T$ and $R(\theta_i)$ are 2×2 rotation matrices. Then the Lipschitz constant $\Lip(f)_p$ for norm $1 \leq p \leq \infty$ of $f$ is bounded by:
%%	\[
%%		\Lip(f)_p \leq 2\norm{Q}_p \norm{K^T}_p
%%	\]
%%	where $\|\cdot\|$ denotes the operator norm.
%%\end{lemma}
%%
%%\begin{proof}
%%	First, recall that for any differentiable function $f$, the Lipschitz constant $L$ is given by:
%%	$$L = \sup_{x \neq y} \frac{\|\nabla f(x) - \nabla f(y)\|_p}{\|x-y\|_p}$$
%%	For quadratic forms, this equals: \lev{TODO: citation here}
%%	$$L = \sup_{\|x\|=1} \|\nabla f(x)\|$$
%%	So, we can then calculate the gradient:
%%	\[
%%		\nabla f(x) = (A + A^T)x = (Q \cdot \text{diag}(R(\theta_i))\cdot K^T + K\cdot \text{diag}(R(\theta_i)^T)\cdot Q^T)x
%%	\]
%%	For any rotation matrix $R(\theta)$:
%%	\begin{align*}
%%		R(\theta) &= \begin{bmatrix} \cos(\theta) & -\sin(\theta) \\ \sin(\theta) & \cos(\theta) \end{bmatrix} \\
%%	\end{align*}
%%	which implies that $\|R(\theta)\|_p \leq 1$.
%%	Also, by the submultiplicativity of operator norms:
%%	$$\|A\| = \|Q \cdot \text{diag}(R(\theta_i)) \cdot K^T\| \leq \|Q\| \|\text{diag}(R(\theta_i))\| \|K^T\|$$
%%	Finally, since $\|\text{diag}(R(\theta_i))\| = \max_i \|R(\theta_i)\| \leq 1$,
%%	we get that $\|A\| \leq \|Q\| \|K\|$.
%%	Therefore,
%%	\[
%%		L = \|\nabla f\| = \|A + A^T\| \leq \|A\| + \|A^T\| = 2\|A\| \leq 2\|Q\| \|K\|.
%%	\]
%%\end{proof}
%%
