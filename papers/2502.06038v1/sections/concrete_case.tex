\newcommand{\ModelFinalC}{{\ModelFinal}'}
\newcommand{\eqclassAlgWD}{\texttt{BoundSoftmax}\WD}
\newcommand{\findAlpha}{\texttt{Find}\_\beta}
\newcommand{\findAlphaMin}{\text{Algorithm to find }\ssMinFA}
\newcommand{\findAlphaMax}{\text{Algorithm to find }\ssMaxFA}
\newcommand{\findAlphaMinR}{\text{Algorithm to find }\ssMinRA}
\newcommand{\findAlphaMaxR}{\text{Algorithm to find }\ssMaxRA}
\newcommand{\obj}{\text{objective}}
\newcommand{\freeToks}{\texttt{FreeToks}}

\newcommand{\minBilin}{\texttt{MinBilinear}}
\newcommand{\maxBilin}{\texttt{MaxBilinear}}
\newcommand{\lowerBounds}{\vec{r}^{\min}}
\newcommand{\upperBounds}{\vec{r}^{\max}}

\subsubsection{Bounding the Encoding Function}
\label{sec:concrcase}
We upper bound the worst-case deviation for $\fenc$ using
bounds on the ``blowup and shift'' in \cref{lem:boundsBS}:
\begin{lemma}[Worst-case deviation of $\fenc$]
	\label{lem:WD_fenc}
	\begin{align*}
		\WD&(\vec{e}_\nctx \cdot \fenc; \InpSpace \times \blowupSet \shiftSet)_\infty \leq 
		\\ \max_{t \in [\dVocab]} &
		\max_{j \in [\dEmb]}
		\max_{B \in [\vec{0}, B^{\max} - B^{\min}]} \\
		&\left|X[t] \cdot \Embed \cdot \diag(B) \cdot \vec{e}_j\right| + S_j^{\max} - S_j^{\min}
	\end{align*}
	where the inner maximum term can be computed via a simple linear program.
\end{lemma}

%Finally, we provide an algorithm which bounds the extremal values of the softmax, $\ssMinFB, \ssMaxFB, \ssMinRB, \ssMaxRB$ in \lev{TODO: appendix or not>}.
%Our algorithm for computing the extremal values of the softmax requires upper and lower bounding a bilinear form: we provide a simple, though non-optimal, algorithm for this task in \cref{fig:bilinOpt} in \cref{sec:appConcrcase}.
%			Now, we have the bound for $\fenc$, we simply need to bound the extremal values of softmax, $\softSumMinF, \softSumMaxF, \softSumMinR, \softSumMaxR$, to get a bound on the worst-case deviation.
%			\lev{TODO: alg reference here? I.e. point to lemma/ algorithm}


\iffalse
\begin{figure}[H]
	\begin{mdframed}
		$\findAlphaMinR:$%(\desF{\Model})$
		\begin{itemize}
			\item Let $\fenc(\vec{e}) = \vec{e} \cdot \Embed \cdot \diag(B) + S$
			\item For $j \in [s]$, let 
				\begin{align*}
					\vec{\ell}[j] = \frac{1}{\sqrt{\dEmb}} 
					\minBilin\bigg(Q \PosRot_{j, \nctx} K^T, \Embed[\desSet_j] \cdot \diag(B^{\min}) + S^{\min}, \\
					\Embed[\desSet_j] \cdot \diag(B^{\max}) + S^{\max} \bigg)
				\end{align*}
			\item Return $\sum_j \exp\left(\vec{\ell}_j\right)$
		\end{itemize}
		$\findAlphaMaxR:$%(\desF{\Model})$
		\begin{itemize}
			\item Let $\fenc(\vec{e}) = \vec{e} \cdot \Embed \cdot \diag(B) + S$
			\item For $j \in [s]$, let 
				\begin{align*}
					\vec{\ell}[j] = \frac{1}{\sqrt{\dEmb}} 
					\maxBilin\bigg(Q \PosRot_{j, \nctx} K^T, \Embed[\desSet_j] \cdot \diag(B^{\min}) + S^{\min}, \\
					\Embed[\desSet_j] \cdot \diag(B^{\max}) + S^{\max} \bigg)
				\end{align*}
			\item Return $\sum_j \exp\left(\vec{\ell}_j\right)$
		\end{itemize}
		$\findAlphaMax:$%(\desF{\Model})$
		\begin{itemize}
			\item Let $\fenc(\vec{e}) = \vec{e} \cdot \Embed \cdot \diag(B) + S$
			\item For $j \in (\ndes, \nctx]$, let 
				\begin{align*}
					\vec{\ell}[j] = \frac{1}{\sqrt{\dEmb}} \max_{t \in [\dVocab]} 
					\maxBilin\bigg(Q \PosRot_{j, \nctx} K^T, \Embed[t] \cdot \diag(B^{\min}) + S^{\min}, \\
					\Embed[t] \cdot \diag(B^{\max}) + S^{\max} \bigg)
				\end{align*}
			\item Return $\sum_j \exp\left(\vec{\ell}_j\right)$
		\end{itemize}

	\end{mdframed}
	\caption{The algorithm $\findAlpha$ which computes the pre-softmax logits for a given model $\Model$.
	}
	\label{fig:find_ell_alg}
\end{figure}

\fi

%	\begin{algorithm}[H] \label{alg:overwhelmCheckDetLP}
%		\SetKwInOut{Input}{Input}\SetKwInOut{Output}{Output}
%		\Input{$\ssMinRB, \ssMaxRB, \ssMaxFB, \softSumMaxR$}
%		\Output{\lev{TODO}} 
%		Calculate \begin{align*}
%			W^{\attn} &= 2 \cdot (\ssMaxRB - \ssMinRB) \cdot \left(\max_{B \in [B^{\min}, B^{\max}]} |E[\desSet, j] \cdot \diag(B)|  + \max(\norm{S^{\min}}_\infty, \norm{S^{\max}}_\infty \right) \\
%				  &+ 2 \cdot \ssMaxFB \cdot \max_{B, S} \norm{(E B + S) \cdot V}_{\frobInf}
%		\end{align*}
%		as in \cref{lem:att_bound}.
%		\\
%		Calculate $W = \Lip(\Unembed) \cdot \left(W^{\attn} + \LipMLP_\infty \cdot W^{\fenc} + W^{\fenc}\right)$ 
%		as per \cref{lem:mlpbound} and 
%		\\
%		Calculate $\peakToPeak(\desF{\Model}, \InpSpace)$ by evaluating $\desF{\Model}$ on $X \gets \InpSpace$ \\
%		\If{
%		$W < \peakToPeak(\desF{\Model}, \InpSpace) / 2$ }{\Return ``Squashed''
%	}
%	\Else{\Return ``Inconclusive''}
%	\caption{Meta Algorithm for Calculating bound on $\WD(\desF{\Model}, [X])$}
%\end{algorithm} 

