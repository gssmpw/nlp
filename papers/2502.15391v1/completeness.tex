% A decidable subclass
% Main challenge: present this in a way that doesn't make it look too artificial.

\newcommand{\tcount}[2]{\#_{#1}(#2)}
\newcommand{\fromcount}[2]{\tcount{{#1}\to}{#2}}
\newcommand{\tocount}[2]{\tcount{\to{#1}}{#2}}

\section{A Decidable Fragment}
\label{sec:pebble-passing}

We have shown that the parameterized coverability problem is
undecidable, for systems with fairly simple network topologies
(chains) and unrestricted process types
(\thmref{thm:undecidability}). We refine this result by proving that
only restricting the process types, but not the topology of the
network, suffices to recover decidability. Albeit based on a simple
communication pattern (\ie passing a pebble from one node to a
neighbour having no pebble), our decidable fragment is non-trivial: we
found it to be in \twoexptime, with a \pspace-hard lower bound.
 
%% with arbitrary architectures and process types, the
%% coverability problem is undecidable (\thmref{thm:undecidability}).
%% With the purpose of exhibiting a decidable subclass, we explore the
%% contribution of the architecture to the complexity of the problem by
%% restricting process types to take only a predetermined shape.  We show
%% that this restriction is sufficient to make the coverability problem
%% decidable but nontrivial (we exhibit a \textsf{2EXPTIME} algorithm,
%% and a \textsf{PSPACE}-hardness lower bound).

\subsection{Pebble-Passing Systems}

The class of pebble-passing systems (\ppstext) is defined by restricting
the process types and interactions of a system, as in
\figref{fig:send-recv}. We give the formal definition below:

\begin{definition}\label{def:pebble-passing-systems}
  Let $\ptypes_\pps$ be a set of process types, where
  $\placeof{\ptype} = \set{q^\ptype_\bot, q^\ptype_\top}$ and
  $\transof{\ptype} = \obstransof{\ptype} = \set{\send, \recv}$, such
  that $\prepost{\send} = (q^\ptype_\top, q^\ptype_\bot)$ and
  $\prepost{\recv} = (q^\ptype_\bot, q^\ptype_\top)$, for each $\ptype
  \in \ptypes_\pps$. Let
  $\ealpha_\pps\isdef\set{(\send,\recv),(\recv,\send)}$ be a set of
  edge labels. A system $\asys=(\verts,\edges,\vlab)$ over
  $\ptypes_\pps$ and $\ealpha_\pps$ is said to be
  \emph{pebble-passing}.
\end{definition}
Intuitively, a token in $q^\ptype_\top$ (\ie $\amark(q^\ptype_\top) =
1$) represents the ownership of a ressource, called \emph{pebble}, and
a token in $q^\ptype_\bot$ is the absence of a pebble, called
\emph{hole}. Since each process type is automata-like (\ie has a token
in exactly one place), each node of the system can have either a
pebble or a hole, in all the reachable markings of its behavior
(\autoref{def:behavior}). An edge $(v, (\send, \recv), v')$
(\resp $(v, (\recv, \send), v')$) will be denoted $v \to v'$
(\resp $v' \to v$). Intuitively, firing an interaction $v \to v'$
moves a pebble from $v$ to $v'$ and simultaneously moves a hole from
$v'$ to $v$. Thus each transition preserves the total numbers of
pebbles and holes in the system, respectively. 

%% That is, every process type $\ptype \in
%% \ptypes$ has places $\placeof{\ptype} = \set{q^\ptype_\bot,
%%   q^\ptype_\top}$ and transitions $\transof{\ptype} =
%% \obstransof{\ptype} = \set{\send, \recv}$, all observable, of the form
%% $(\pre{\send},\post{\send}) = (q^\ptype_\top, q^\ptype_\bot)$ and
%% $(\pre{\recv},\post{\recv}) = (q^\ptype_\bot, q^\ptype_\top)$. We
%% interpret a token in $q^\ptype_\top$ (when $\amark(q^\ptype_\top) =
%% 1$) to represent ownership of a ressource, that we call \emph{pebble}
%% in the following, and a token in $q^\ptype_\bot$ is the absence of a
%% pebble, that we call a \emph{hole}. Since each process type has a
%% token in exactly one place, each vertex of the system has either a
%% pebble or a hole, in all reachable markings.

\input{figure-send-recv-restriction.tex}

%% \mycomment{Arnaud}{We then say that a system
%% $\asys=(\verts,\edges,\vlab)$ is a \emph{pebble-passing system},
%% whenever every edge in $\edges$ is of the form $(v, (\send, \recv),
%% v')$ or $(v, (\recv, \send), v')$. }We further assume that every
%% interaction $(v, (t, t'), v')$ is of the form $(v, (\send, \recv),
%% v')$ or $(v, (\recv, \send), v')$, which we shorten respectively to
%% $(v \to v')$ and $(v' \to v)$.  Intuitively, firing an interaction
%% $(v \to v')$ moves a pebble from $v$ to $v'$ and simultaneously
%% moves a hole from $v'$ to $v$.  Thus every interaction preserves
%% the total number of pebbles in the system.  For this reason we call
%% this the class of \emph{pebble-passing systems}.

Pebble-passing systems have very strict constraints on their process
types and interactions, but no constraints on the set of network
topologies, other than that it is definable by an \hrtext{} grammar
written with constants of the form $(\send,\recv)_{\asrc_1,\asrc_2}$
or $(\recv,\send)_{\asrc_1,\asrc_2}$, for some source labels
$\asrc_1,\asrc_2 \in \sourcelabels$, where $\sourcelabels$ is the set
of source labels that may occur in a grammar. We denote by $\hr_\pps$
the signature of these grammars. The rest of this section is concerned
with the proof of the following theorem:

\begin{theorem}\label{thm:pebble-passing}
  The $\paramcover{}{}{}$ problem for grammars written using the
  $\hr_\pps$ signature is in \twoexptime\ and \pspace-hard.
\end{theorem}
The proof of \thmref{thm:pebble-passing} is organized as
follows. The double exponential upper bound relies on a result showing
that, in order to cover a target marking $\mtarget$ it is sufficient
to consider only firing sequences that cross (\ie move a pebble to and
from) each place at most $K$ times, where $K$ is the size of the unary
encoding of $\mtarget$. Based on this result (\lemref{lem:cover-soft-cap}),
we define a finite algebra $\algof{F}$
(\figref{fig:alg-zoo}), having the property that the coverability
problem reduces to a membership test on the language of the input
grammar in $\algof{F}$. The upper bound follows from the fact that
$\alangof{}{\algof{F}}{\grammar}$ is computable in double exponential
time (see \propref{prop:alg-flows} for a precise estimation). The
lower bound uses a polynomial reduction from the emptiness problem for
$2$-way nondeterministic automata~\cite{2nfa}.

%% The remainder of this section constitutes the proof of this
%% theorem, given by preliminary tools in
%% \secref{sec:pebble-fire-chara}, and an algorithm that computes a
%% fixed point over a domain of size $2^{(K+1)^{2(|\sourcelabels| +
%% |\ptypes|)}}$ in \secref{sec:pebble-algo} (where $K =
%% \sum_{q\in\places} \mtarget(q)$) for decidability.  The hardness
%% can be proven by a reduction from the known \textsf{PSPACE}-hard
%% problem of deciding if the language of a 2NFA (2-directional
%% Nondeterministic Finite Automaton) is empty (see \cite{2nfa}).

\subsection{Firing Sequences}
\label{sec:pebble-fire-chara}

For the rest of this section, let $\open{\asys}= (\asys,\sources)$ be
a fixed open pebble-passing system, having an underlying system
$\asys=(\verts,\edges,\vlab)$ whose behavior is $\behof{\asys} \isdef
(\anet,\amark_0)$. Below, we introduce an equivalent characterization
of the firing sequences of $\behof{\asys}$.

The \emph{footprint} of a marking $\amark$ is a mapping $\fpof{\amark}
: \verts \to \set{0,1}$ defined as $\fpof{\amark}(v) \isdef
\amark(q^{\vlab(v)}_\top,v)$, for each vertex $v \in \verts$. Note
that $\fpof{\amark}$ evaluates to $1$ on pebble and to $0$ on hole
vertices. We say that a marking footprint $\pi$ is \emph{valid over
  $\mathcal{V}\subseteq\verts$} iff $0 \leq \pi(v) \leq 1$ for each
vertex $v \in \mathcal{V}$, \resp \emph{valid}, when
$\mathcal{V}=\verts$ follows from the context.

Given a subset of states $\mathcal{Q} \subseteq
\placeof{\ptypes}$ and a marking to cover $\mtarget: \mathcal{Q}
\rightarrow\nat$, the coverability problem asks for the existence of a
reachable marking $\amark:\placeof{\anet} \rightarrow\set{0,1}$ such
that, for each process type $\ptype\in\ptypes$ and each place $q \in
\mathcal{Q}$: 
\begin{align}
  \cardof{\set{v\in\vlab^{-1}(\ptype) \mid \fpof{\amark}(v) = 0}} \geq & \mtarget(q^\ptype_\bot) \label{eq1:cover} \\
  \cardof{\set{v\in\vlab^{-1}(\ptype) \mid \fpof{\amark}(v) = 1}} \geq & \mtarget(q^\ptype_\top) \label{eq2:cover}
\end{align}
The footprint $\fpof{v \to v'} : \verts \to \ints$ of an edge $v\to v'
\in \edges$ is defined as $\fpof{v \to v'}(u) \isdef 1$ if $u = v$,
$-1$ if $u = v'$ and $0$, otherwise.
%% \begin{align*}
%%   \fpof{v \to v'}(u) \isdef \left\{\begin{array}{ll}
%%   1 & \text{, if } u = v \\
%%   -1 & \text{, if } u = v' \\
%%   0 & \text{, otherwise}
%%   \end{array}\right.
%% \end{align*}
We extend footprints to sequences of edges $\vec{e} \in \edges^*$ as
in $\fpof{\vec{e}} \isdef \sum_{e \in \vec{e}} \tau_e$. Because each
edge $v \to v' \in \edges$ corresponds to the transition that moves a
token from $(q^{\vlab(v)}_\top,v)$ to $(q^{\vlab(v)}_\bot,v)$ (\resp
from $(q^{\vlab(v')}_\bot,v')$ to $(q^{\vlab(v')}_\top,v')$) in the PN
$\behof{\asys}$, we shall abuse notation and write $\behof{v \to v'}$
for the transition corresponding to $v \to v'$ in $\behof{\asys}$ and
$\behof{\vec{e}}$ for the sequence of transitions corresponding to
$\vec{e} \in \edges^*$.

%% One can easily check that, for any two automata-like markings
%% $\amark,\amark'$, the difference $\pi_{\amark'} - \pi_{\amark}$ is the
%% footprint of balanced sequence of edges. In fact, we can further say
%% that whenever

We remark that, for each firing sequence $\amark \fire{\abeh(\vec{e})}
\amark'$, we have $\fpof{\amark'} - \fpof{\amark} =
\fpof{\vec{e}}$. Intuitively, $\fpof{\vec{e}}$ is a witness of the fact
that the effect of firing the transitions $\abeh(\vec{e})$ is to move
pebbles from $\set{v \mid \fpof{\vec{e}}(v) = -1}$
to $\set{v \mid \fpof{\vec{e}}(v) = 1}$;
the vertices from $\set{v \mid \fpof{\vec{e}}(v) = 0}$ may store pebbles in between,
but are ultimately restored to their initial state.

%% \mycomment{Arnaud}{Let $\asys=(\verts,\edges,\vlab)$ be a \emph{pebble-passing system} with  $\behof{\asys} \isdef
%%    (\anet,\amark_0)$}.
%% Pebbles and holes give an alternative reading of the marking:
%% an automata-like marking $\amark$ \mycomment{Arnaud}{I would define them more formally.}(there is exactly one token per process)
%% is interpreted by a \emph{marking signature} $\pi_\amark : \verts \to \{0,1\}$ defined by
%% $\pi_\amark(v) = \amark(q^{\vlab(v)}_\top,v)$.
%% Thus the marking signature evaluates to 0 on vertices that are in state $q_\bot$
%% and 1 on vertices that are in state $q_\top$,
%% or in other words it evaluates to 0 for holes and 1 for pebbles.
%% \mycomment{Arnaud}{With this point of view, given a subset of states $\mathcal{Q}
%%   \subseteq \placeof{\ptypes}$ and a marking to cover $\mtarget: \mathcal{Q}
%%   \rightarrow\nat$, we can reinterpret the coverability problem as searching for a reachable marking $\amark:\placeof{\anet} \rightarrow\{0,1\}$ ...} With this point of view, a coverability query $\mtarget$ is reinterpreted
%% as looking for a reachable marking $\amark$ such that 
%% $\cardof{\set{v\in\vlab^{-1}(\ptype) \mid \pi_\amark(v) = 0}} \geq \mtarget(q^\ptype_\bot)$
%% and $\cardof{\set{v\in\vlab^{-1}(\ptype) \mid \pi_\amark(v) = 1}} \geq \mtarget(q^\ptype_\top)$
%% for every $\ptype\in\ptypes$.

%% We also define a \emph{sequence signature}
%% $\tau_\vec{t} : \verts \to \ZZ$ characterized by
%% $\tau_{(u \to u')}(v) = \left\{\begin{array}{ll}
%%   1 & \text{when } v = u' \\
%%   -1 & \text{when } v = u \\
%%   0 & \text{otherwise}
%% \end{array}\right.$
%% and $\tau_\vec{t} = \sum_{t \in \vec{t}} \tau_t$.
%% We say that $\tau_\vec{t}$ is \emph{balanced} when $-1 \leq \tau_\vec{t} \leq 1$.
%% We easily check that for any two automata-like markings $\amark,\amark'$,
%% the quantity $\pi_{\amark'} - \pi_{\amark}$ is a balanced sequence signature.
%% In fact we can further say that whenever  $\amark \fire{\vec{t}} \amark'$
%% we have $\pi_{\amark'} - \pi_{\amark} = \tau_\vec{t}$.
%% Intuitively, $\tau_\vec{t}$ is a witness that the overall effect of firing
%% $\vec{t}$ is to ``pick up'' pebbles from $\{v \mid \tau_\vec{t}(v) = -1\}$
%% and ``move'' them to $\{v \mid \tau_\vec{t}(v) = 1\}$.
%% Vertices in $\{v \mid \tau_\vec{t}(v) = 0\}$ may be used as intermediate storage,
%% but are ultimately restored to their initial state.

We denote by $\tcount{e}{\vec{e}}$ the number of times the edge $e$
occurs in the sequence $\vec{e}$. We use the shorthands
$\fromcount{u}{\vec{e}} \isdef \sum_{u'\in\verts}\tcount{u \to
  u'}{\vec{e}}$ and $\tocount{u}{\vec{e}} \isdef
\sum_{u'\in\verts}\tcount{u' \to u}{\vec{e}}$. We define the following
partial orders between sequences of edges: $\vec{e'} \preceq \vec{e}
\iffdef \tcount{e}{\vec{e'}} \leq \tcount{e}{\vec{e}}$, for each $e
\in \edges$, and $\vec{e'} \sqsubseteq \vec{e} \iffdef \vec{e'}
\preceq \vec{e} \text{ and } \fpof{\vec{e'}} = \fpof{\vec{e}}$.
%% An unordered subsequence $\vec{e'} \subseteq \vec{e}$ is characterized
%% by $\tcount{e}{\vec{e'}} \leq \tcount{e}{\vec{e}}$ for all $e \in
%% \verts \times \verts$.  We additionally define the order relation
%% $\sqsubseteq$ on sequences of edges as $\vec{e'} \sqsubseteq \vec{e}$
%% (read: $\vec{e'}$ is an equivalent subsequence of $\vec{e}$) when
%% $\vec{e'} \subseteq \vec{e}$ and $\tau_\vec{e'} = \tau_\vec{e}$.
%% In general a sequence signature (even balanced) cannot be added
%% to an arbitrary marking signature to obtain a marking signature,
%% and even if it did it does not guarantee that the sequence is indeed
%% fireable. The following lemma states the conditions
%% under which this does hold.
%% \mycomment{Arnaud}{In the next lemma, $\amark_0$ being the intial marking of the system's behavior, I'd simply use $\amark$ (the proof needs to be updated to.)}
The following lemma characterizes the existence of fireable
sub-sequences:

\begin{lemmaE}[][category=proofs] % [Extraction of an Equivalent Fireable Subsequence]
  \label{lem:fireable-subsequence}
  For each marking $\amark$ and each sequence of edges
  $\vec{e}$, the following are equivalent: \begin{compactenum}[(i)]
    %
  \item $\fpof{\amark} + \fpof{\vec{e}}$ is a valid marking footprint,
    %
  \item there exists a sequence of edges $\vec{e'} \sqsubseteq
    \vec{e}$ such that $\abeh(\vec{e'})$ is fireable from $\amark$.
    %
  \end{compactenum}
\end{lemmaE}
\begin{proofE}
  $(ii) \Rightarrow (i)$ is easy: if $\abeh(\vec{e'})$ is fireable from $\amark$,
  then there exists some $\amark \fire{\abeh(\vec{e'})} \amark'$.
  We write $\fpof{\amark'} - \fpof{\amark} = \fpof{\vec{e'}}$,
  and the knowledge that $\fpof{\vec{e'}} = \fpof{\vec{e}}$
  gives $\fpof{\amark} + \fpof{\vec{e}} = \fpof{\amark'}$
  which is a marking footprint because $\amark'$ is an automata-like marking.

  For $(i) \Rightarrow (ii)$, we proceed by induction on the length of $\vec{e}$.
  When $\vec{e}$ is empty, an obvious (and in fact the only) candidate for $\vec{e'}$
  is the empty sequence which has signature $\fpof{\epsilon} = 0$ everywhere,
  and is obviously fireable.

  In general when $\vec{e}$ is nonempty, we reinterpret $\vec{e}$ as a
  directed multigraph, where each edge $u \to v$ has multiplicity
  $\tcount{(u \to v)}{\vec{e}}$.  As does any nonempty directed
  multigraph, either it contains an elementary cycle, or it is acyclic and it
  contains a maximal nonempty path.
  \begin{itemize}
    \item In the case of a cycle $\vec{e} \supseteq \vec{c} = u_0 \to
      u_1 \to u_2 \cdots u_{k-1} \to u_0$, we make the observation
      that $\fpof{\vec{c}} = 0$ everywhere. Note that an elementary
      cycle is characterized by every vertex involved having incoming
      and outgoing degree exactly 1 each, so $\fpof{\vec{c}}(u_i) =
      \fpof{\to u_i}(u_i) + \fpof{u_i \to}(u_i) = 1 - 1 = 0$.  We
      deduce that $\vec{e} \setminus \vec{c} \sqsubseteq \vec{e}$,
      where $\vec{e} \setminus \vec{c}$ is naturally the sequence
      obtained by removing from $\vec{e}$ an occurrence of each
      transition from $\vec{c}$. Applying the inductive hypothesis to
      $\vec{e} \setminus \vec{c}$ which is strictly shorter than
      $\vec{e}$ gives $\vec{e'}$ fireable and $\vec{e'} \sqsubseteq
      \vec{e} \setminus \vec{c} \sqsubseteq \vec{e}$ where we conclude
      by transitivity of $\sqsubseteq$.
    \item Otherwise we have a directed acyclic graph,
      and a maximal path $\vec{e} \supseteq \vec{p} = u_0 \to u_1 \to u_2 \cdots u_{k-1} \to u_k$
      of that graph.
      First observe that a path from $u_0$ to $u_k$ has the same footprint
      as the single edge $u_0 \to u_k$ (evaluating to $-1$ on $u_0$, $1$ on $u_k$,
      and all intermediate vertices cancel out).
      Secondly we have assumed by $(i)$ that
      $0 \leq \fpof{\amark_0}(u_0) + \fpof{\vec{p}}(u_0)$ which means $\fpof{\amark_0}(u_0) = 1$,
      and $\fpof{\amark_0}(u_k) + \fpof{\vec{p}}(u_k) \leq 1$ which means $\fpof{\amark_0}(u_k) = 0$.
      The discrete quantity $\fpof{\amark_0}(u_i)$,
      going from 1 at $i=0$ to 0 at $i=k$,
      must for some value $i_0$ in between satisfy simultaneously
      $\fpof{\amark_0}(u_{i_0}) = 1$ and $\fpof{\amark_0}(u_{i_0+1}) = 0$.
      Thus $e_{i_0} = u_{i_0} \to u_{i_0+1}$ occurs in $\vec{e}$ and $\abeh(e_{i_0})$ is fireable.
      This yields $\amark_1$ a marking such that $\fpof{\amark_1} = \fpof{\amark} + \fpof{e_{i_0}}$,
      on which we apply the inductive hypothesis for $\vec{e} \setminus e_{i_0}$
      (at this point we need to show that $\fpof{\amark_1} + \fpof{\vec{e} \setminus e_{i_0}}$ is a marking footprint,
      this comes from $\fpof{\amark_1} + \fpof{\vec{e} \setminus e_{i_0}} = (\fpof{\amark} + \fpof{e_{i_0}}) + (\fpof{\vec{e}} - \fpof{e_{i_0}}) = \fpof{\amark} + \fpof{\vec{e}}$).
      Having thus obtained $\vec{e''} \sqsubseteq \vec{e} \setminus e_{i_0}$
      fireable from $\amark_1$,
      we construct $\vec{e'} \isdef e_{i_0}; \vec{e''} \sqsubseteq \vec{e}$
      which is fireable from $\amark$.
  \end{itemize}
  We thus conclude that $\fpof{\amark} + \fpof{\vec{e}}$ is a valid
  marking signature if and only if there exists some equivalent subsequence of $\vec{e}$
  that is actually fireable from $\amark$.
  \qed
\end{proofE}
\begin{proofSketch}
  By induction on the length of a firing sequence.
  After ensuring that $\vec{e}$ is acyclic, pick any maximal path and use combinatorial arguments
  to show that some transition along that path is fireable.
  \qed
\end{proofSketch}

%% This lemma is unsurprisingly the most useful in the direction ``(i)
%% $\Rightarrow$ (ii)'', because, in order to obtain a fireable
%% subsequence of a given sequence of edges $\vec{e}$, equivalent
%% fireable subsequence it suffices to show that $\fpof{\amark} +
%% \fpof{\vec{e}}$ is a valid footprint.
%Examples include
%\begin{enumerate}[(A)]
%  \item if $\vec{t_1}$ and $\vec{t_2}$ are both fireable from the same initial
%    configuration $\amark_0$ and if $\vec{t_1} + \vec{t_2}$ is balanced,
%    then there exists a fireable $\vec{t'} \sqsubseteq \vec{t_1}; \vec{t_2}$
%    (what this means is that two independently fireable sequences
%    admit a fireable interleaving; this will be used indirectly in \mycomment{Neven}{Ref});
%  \item if $\amark_0 \fire{\vec{t}} \amark'$, $\vec{p} \subseteq \vec{t}$,
%    and $\pi_{\amark'} - \tau_\vec{p}$ is a marking signature,
%    then there exists a fireable $\vec{t'} \sqsubseteq \vec{t} \setminus \vec{p}$
%    (what this means is that given a firing sequence we can ``cancel''
%    a subsequence $\vec{p}$ if it is compatible with the final marking of $\vec{t}$;
%    this will be used explicitly in \mycomment{Neven}{Ref} in the case of $\vec{p}$ a path).
%  \item if $\amark_0 \fire{\vec{t}} \amark'$, $\vec{c} \subseteq \vec{t}$,
%    and $\vec{c}$ is a cycle,
%    then there exists a fireable $\vec{t'} \sqsubseteq \vec{t} \setminus \vec{c} \sqsubseteq \vec{t}$
%    (what this means is that given a firing sequence we can ``cancel''
%    an arbitrary cyclic subsequence to reach the same final marking;
%    the consequence is that any coverable marking is also coverable by an acyclic
%    firing sequence).
%\end{enumerate}
Using the previous lemma, we prove that, in order to cover a given
marking $\mtarget$, it suffices to consider only those firing
sequences that cross each vertex a bounded number of times, where the
bound is the size of the unary encoding of $\mtarget$.
To that end, we define the \emph{degree} of a sequence $\vec{e} \in \edges^*$
as the maximum number of occurrences of one vertex in the sequence, \ie
$\deg(\vec{e}) \isdef \max\{\fromcount{u}{\vec{e}}, \tocount{u}{\vec{e}} \mid u\in\verts\}$.
From now on, the domain of $\mtarget$ will implicitly be the set $\mathcal{Q}
\subseteq \placeof{\ptypes}$. To simplify the following statement, we
say that $\amark : \placeof{\anet} \rightarrow \nat$ \emph{covers}
$\mtarget$ iff $\sum_{(q,v)\in\placeof{\anet}} \amark(q,v) \geq
\mtarget(q)$, for each $q \in \mathcal{Q}$ and that $\mtarget$ is
\emph{coverable} by $\asys$ iff there exists
$\amark\in\reach{\behof{\asys}}$ that covers $\mtarget$. Since, in a
pebble-passing system, markings can be equated to their footprints, we
say that $\fpof{\amark}$ covers $\mtarget$ whenever $\amark$ and
$\mtarget$ satisfy the conditions (\ref{eq1:cover}) and (\ref{eq2:cover}) above.

%% \mycomment{Arnaud}{Rewrite the lemma more fomally: Let $\mathcal{Q}
%%   \subseteq \placeof{\ptypes}$ and a marking to cover $\mtarget: \mathcal{Q}
%%   \rightarrow\nat$  and  $K \isdef \sum_{q \in \places} \mtarget(q)$. There exists $\amark \in\cover{\behof{\asys}}$) s.t. 
%%   $\sum_{v \in \vertof{\asys}:q \in \placeof{\vlabof{\asys}(v)}} \amark(q,v)=\mtarget(q) \text{, for all } q \in \mathcal{Q}$
%% iff there exists a marking $\amark' \in \reach{\behof{\asys}}$ such that  $\sum_{v \in \vertof{\asys}:q \in \placeof{\vlabof{\asys}(v)}}
%%   \amark'(q,v)\geq \mtarget(q) \text{, for all } q \in
%%   \mathcal{Q}$ and $\amark_0\fire{\vec{t}} \amark'$ for a firing sequence $\vec{t}$ verifying $\max(\tcount{(\_ \to u)}{\vec{t}}, \tcount{(u \to \_)}{\vec{t}}) \leq
%%   K$}

%% \mycomment{Arnaud}{Or maybe it is worth definining what it means for a marking $\amark$ to cover $\mtarget$ since we use this as well in the next Lemma}
\begin{lemmaE}[][category=proofs] \label{lem:cover-soft-cap}
  A marking $\mtarget$ is coverable by $\asys$ iff there exists
  $\vec{e} \in \edges^{*\leq K}$ such that $\fpof{\amark_0} +
  \fpof{\vec{e}}$ covers $\mtarget$, where $K \isdef \sum_{q \in
    \mathcal{Q}} \mtarget(q)$, and $\edges^{*\leq K} \isdef
  \set{\vec{e} \in \edges^* \mid \deg(\vec{e}) \leq K}$.
\end{lemmaE}
\begin{proofE}
  The $(\Leftarrow)$ direction is easy, since the condition that
  $\fpof{\amark_0} + \fpof{\vec{e}}$ covers $\mtarget$
  alone implies that $\mtarget$ is coverable (through \lemref{lem:fireable-subsequence}
  and what it means for a footprint to cover a marking).

  We focus on the proof $(\Rightarrow)$, and assume that $\mtarget$ is coverable by $\asys$.
  In order to prove the existence of a sequence that satisfies the requirement,
  we proceed by as such: we assume that we have a minimal (in terms of length)
  firing sequence $\behof{\vec{e}}$ that covers $\mtarget$ in $\asys$,
  deduce independently that it must satisfy be such that
  $\fpof{\amark_0} + \fpof{\vec{e}}$ covers $\mtarget$
  and assume by contradiction that this firing sequence must
  have degree at least $K+1$, in other words it must
  fire at least $K+1$ times an incoming or outgoing
  (assume without loss of generality that it is incoming, the other proof is identical)
  transition for some vertex $u$.
  We then construct a strictly shorter sequence that also covers
  the marking, thereby contradicting the hypothesis of minimality.

  We first ensure that $\vec{e}$ is acyclic:
  a cycle $\vec{c}$ is characterized by $\fpof{\vec{c}} = 0$ everywhere,
  since in a cycle every vertex involved has as many incoming as outgoing edges occurring.
  Thus $\fpof{\vec{e} \setminus \vec{c}} = \fpof{\vec{e}} - \fpof{\vec{c}} = \fpof{\vec{e}}$:
  if $\fpof{\amark_0} + \fpof{\vec{e}}$ is a marking signature,
  then so is $\fpof{\amark_0} + \fpof{\vec{e} \setminus \vec{c}}$.
  Necessarily if $\behof{\vec{e}}$ is fireable and $\vec{e}$ contains a cycle $\vec{c}$,
  then there is also an equivalent subsequence of $\vec{e} \setminus \vec{c}$
  that is fireable. This would contradict the minimality of $\vec{e}$.

  Now that $\vec{e}$ is acyclic, if there still exists a vertex $u$
  with in-degree at least $K+1$,
  denote by $i_1 < \cdots < i_{K+1}$ a set of indices of $K+1$ occurrences
  in $\vec{e}$ of an edge leading to $u$.
  In that situation, \figref{algo:path-decomposition} will compute a partial assignment
  $p$ of edges to disjoint paths from 1 to $K+1$, such that
  all of these paths go through $u$

  \begin{figure}[h!]
    {\small\begin{algorithmic}[0]
      \STATE \textbf{input}: $\vec{e} = (w_0 \to v_0); (w_1 \to v_1); ...$ a fireable sequence of edges (\ie $\behof{\vec{e}}$ is a firing sequence)
      \STATE \textbf{input}: $u$ a vertex that occurs in $\vec{e}$
      \STATE \textbf{output}: $p : [0, |\vec{e}|[ \to \nat^?$ a decomposition of $\vec{e}$ in paths with distinct endpoints
    \end{algorithmic}
    \begin{algorithmic}[1]
      \STATE $n \gets 0$
      \STATE $p \gets (\_ \mapsto \bot)$
      \COMMENT{how to interpret $p$: if $p(i) = n$ it means that $\vec{e}_i$ is assigned to the $n$'th path}
      \FOR{$|\vec{e}| > i \geq 0$ \DECR}
        \STATE \textbf{invariant}: every $p^{-1}(n')$ for $n' \leq n$ is a path
        \IF{$v_i = u$} \COMMENT{This edge is incoming for $u$, we want one path that goes through it}
          \STATE $p(i) \gets n$
          \STATE $u^- \gets w_i$
          \STATE $u^+ \gets v_i$
          \FOR{$i < j < |\vec{e}|$ \INCR}
            \STATE \textbf{invariant}: $p^{-1}(n)$ is a path from $u^-$ to $u^+$
            \IF{$p(j) = \bot$} \COMMENT{$\vec{e}_i$ is not yet part of a path}
              \IF{$w_j = u^+$} \COMMENT{$u^+$ is the end of the path $p^{-1}(n)$, so $u^+ \to v_j$ can extend it}
                \STATE $p(j) \gets n$
                \STATE $u^+ \gets v_j$ \COMMENT{And of course $v_j$ is the new end of $p^{-1}(n)$}
              \ENDIF
              \IF{$v_j = u^-$} \COMMENT{$u^-$ is the start of the path $p^{-1}(n)$ so $w_j \to u^-$ can extend it}
                \STATE $p(j) \gets n$
                \STATE $u^- \gets w_j$ \COMMENT{And of conrse $w_j$ is the new start of $p^{-1}(n)$}
              \ENDIF
            \ENDIF
          \ENDFOR
          \STATE $n \gets n + 1$ \COMMENT{No other edges can be added to this path, so we handle the next}
        \ENDIF
      \ENDFOR
    \end{algorithmic}}
    \caption{Decomposing a sequence into paths.
      The fact that these paths have distinct endpoints is enforced by the specific shape that they have,
      as interleavings of one positive and one negative path that each independently appear in that order in $\vec{e}$.
    }
    \label{algo:path-decomposition}
  \end{figure}

  We thus have $K+1$ paths.
  Though these paths are not completely ordered,
  they do have a specific shape that guarantees that their endpoints are distinct.
  We call \emph{positive path} an ordered path $(u_0 \to u_1); (u_1 \to u_2); (u_2 \to u_3); \ldots$
  that occurs in that order as a subsequence of $\vec{e}$.
  We call \emph{negative path} an ordered path $(u_1 \to u_0); (u_2 \to u_1); (u_3 \to u_2); \ldots$
  that occurs in that order as a subsequence of $\vec{e}$.
  The paths we are interested in are interleavings of one positive path starting from $u$,
  and one negative path ending in $u$.
  For example, $(w_1 \to u); (u \to v_1); (w_2 \to w_1); (w_3 \to w_2); (v_1 \to v_2); (v_2 \to v_3); (w_4 \to w_3); (v_3 \to v_4); (v_4 \to v_5); (w_5 \to w_4)$
  satisfies this criterion as it is an interleaving
  of the positive path
  $(u \to v_1); (v_1 \to v_2); (v_2 \to v_3); (v_3 \to v_4); (v_4 \to v_5)$
  starting from $u$
  and the negative path
  $(w_1 \to u); (w_2 \to w_1); (w_3 \to w_2); (w_4 \to w_3); (w_5 \to w_4)$
  ending in $u$.

  The reason these kinds of paths are relevant is that in the specific context where they occur
  as an ordered subsequence of a firing sequence of a pebble-passing system,
  the end of a maximal positive path has a pebble in the final marking,
  and the start of a maximal negative path has a hole in the final marking.
  Since it is impossible to move a pebble (\resp hole) to a vertex that already contains one,
  two maximal positive paths that use disjoint sets of edges cannot have the same end,
  and two maximal negative paths that use disjoint sets of edges cannot have the same start.
  By being interleavings of each a maximal positive path and a maximal negative path,
  the $K + 1$ paths we have just created must have pairwise distinct starts and ends.

  Put into equations this means
  each path $\vec{p}_j$ from $u_0^j$ to $u_{k_j}^j$ contains the edge $e_{i_j}$,
  whose endpoints satisfy $u_0^j \ne u_0^{j'}$ and $u_{k_j}^j \ne u_{k_{j'}}^{j'}$ whenever $j \ne j'$,
  and because the paths are maximal we have $\fpof{\amark'}(u_0^j) = 0$
  and $\fpof{\amark'}(u_{k_j}^j) = 1$ for every $j$.
  This last point implies that each sequence $\vec{e} \setminus \vec{p_j}$ is fireable from $\amark_0$:
  $\fpof{\vec{p}_j}$ evaluates to $-1$ on $u_0^j$, $1$ on $u_{k_j}^j$, and 0 everywhere else,
  and thus $0 \leq \fpof{\amark'} - \fpof{\vec{p}_j} \leq 1$.

  A coverability query, as we recall from Equations \eqref{eq1:cover} and \eqref{eq2:cover},
  is simply a requirement of cardinality for sets of the form $\{v \mid \fpof{\amark'}(v) = 1\}$
  or $\{v \mid \fpof{\amark'}(v) = 0\}$ for specific process types.
  A marking $\mtarget$ can be covered by looking at $K$ such vertices.
  The previous construction has given us $K+1$ pairs of one vertex of each of
  these two sets, so there is at least one path where both endpoints are
  irrelevant to the marking,
  in other words one path $p_{j_0}$ from $u_0$ to $u_k$
  where in fact the inequalities
  $\cardof{\set{v \kerof{\vlab} u_0 \mid (\fpof{\amark_0} + \fpof{\vec{e}})(v) = 0}} > \mtarget(q^{\vlab(u_0)}_\bot)$
  and
  $\cardof{\set{v \kerof{\vlab} u_k \mid (\pi_{\amark_0} + \fpof{\vec{e}})(v) = 1}} > \mtarget(q^{\vlab(u_k)}_\top)$
  are strict.
  It follows that a final marking with one fewer pebble in $\vlab(u_k)$ and one fewer hole in $\vlab(u_0)$
  would still cover $\mtarget$.
  One such marking is given by the application of \lemref{lem:fireable-subsequence}
  to $\vec{e} \setminus \vec{p}_{j_0}$ as mentioned above.
  We have thus reached a different marking than $\amark'$ but that nevertheless
  still covers $\mtarget$, and done so in strictly fewer steps.
  This is a contradiction.

  Thus the proof by contradiction ends and we deduce that there must exist
  a sequence that in addition to covering $\mtarget$ also has degree at most $K$.
\end{proofE}

% \subsection{Proof of \thmref{thm:pebble-passing}: decidability} \label{sec:pebble-algo}

%% An immediate consequence of \lemref{lem:fireable-subsequence} and
%% \lemref{lem:cover-soft-cap} is that, in order to check the
%% coverability of a marking $\mtarget$, it suffices to consider
%% sequences of edges that cross each vertex at most $K$ times, where $K$
%% is the size of the unary encoding of $\mtarget$:

%% \begin{lemma}\label{lem:alg-justification}
%%   Let $\mathcal{Q} \subseteq \placeof{\ptypes}$ be a set of places and
%%   $\mtarget: \mathcal{Q} \rightarrow\nat$ be a marking. Then, the
%%   following are equivalent: \begin{compactenum}
%%     %
%%   \item there exists $\amark\in\reach{\behof{\asys}}$ such that
%%     $\sum_{(q,v)\in\placeof{\anet}} \amark(q,v) \geq \mtarget(q)$, for
%%     each $q \in \mathcal{Q}$,
%%     %
%%   \item there exists a sequence $\vec{e}\in\edges^*$ of edges, that
%%     crosses each vertex at most $K$ times and a marking $\amark$
%%     satisfying (\ref{eq1:cover}) and (\ref{eq2:cover}), such that
%%     $\amark_0 \fire{\behof{\vec{e}}} \amark$.
%%     %
%%   \end{compactenum}
%% \end{lemma}

% \mycomment{Arnaud}{I think we could remove this lemma and say in the text that thanks to the two previous lemma it is enough to look at balanced sequence verifying the two conditions}
%\begin{lemma}
%  \label{lem:alg-justification}
%  For any marked net $(\anet,\amark_0) = \behof{\asys}$ and any target marking $\mtarget$,
%  the following statements are equivalent:
%  \begin{enumerate}[(i)]
%    \item there exists a firing sequence $\vec{t}$ of $\anet$ such that
%      $\amark_0 \fire{\vec{t}} \amark'$ and $\amark'$ covers $\mtarget$;
%    \item there exists a balanced sequence $\vec{t}$ of $\anet$ passing through
%      each node at most $K$ times such that
%      $\pi_{\amark'} \isdef \pi_{\amark_0} + \tau_\vec{t}$ satisfies
%      $\cardof{\set{v\in\vlab^{-1}(\ptype) \mid \pi_{\amark'}(v) = 0}} \geq \mtarget(q^\ptype_\bot)$
%      and
%      $\cardof{\set{v\in\vlab^{-1}(\ptype) \mid \pi_{\amark'}(v) = 1}} \geq \mtarget(q^\ptype_\top)$
%      for every $\ptype$.
%  \end{enumerate}
%\end{lemma}

\subsection{Flows}

To check coverability, we consider a finite algebra $\algof{F}$ whose
elements represent the sequences of edges that cross each vertex at
most $K$ times. The domain of $\algof{F}$ is $\universeOf{F} \subseteq
\pow{[0,K]^\sourcelabels \times [0,K]^\sourcelabels \times
  [0,K]^\mathcal{Q}}$. The elements $(f^+,f^-,n) \in \universeOf{F}$
represent sequences of edges, such that $f^+(\asrc)$ (\resp
$f^-(\asrc)$) is the in-degree (\resp out-degree) of the
$\asrc$-source of $\asys$ and $n(q)$ is the number of tokens that end
in $q \in \mathcal{Q}$. Intuitively, a tuple $(f^+,f^-,n)$ witnesses
the existence of a sequence that covers $n$, that can later be
combined with other sequences which compensate its surplus $f^+$ and
deficit $f^-$ on the sources of $\asys$.
%% This makes $n$ the quantity of interest
%% ($n = \mtarget$ means we have covered out target marking),
%% while $f^-$ and $f^+$ are only useful while the construction is unfinished.

Formally, we define the following mappings, where
$\universeOf{S}$ denotes the set of open systems, \ie systems with
sources:
\begin{align*}
  \omega : & ~\edges^{*\leq K} \times
  \verts^\sourcelabels \rightarrow \interv{0}{K}^\sourcelabels \times
  \interv{0}{K}^\sourcelabels \times \interv{0}{K}^\mathcal{Q} \\
  \omega(\vec{e},\sources) = & (f^+,f^-,n) \iffdef
  \left\{\begin{array}{l} f^+(\asrc) =
  \fromcount{\sources(\asrc)}{\vec{e}} \hspace*{8mm} f^-(\asrc) =
  \tocount{\sources(\asrc)}{\vec{e}} \\
  n(q^\ptype_\bot) = \min(\mtarget(q^\ptype_\bot), \cardof{\set{v\in\vlab^{-1}(\ptype)
      \setminus \img{\sources} \mid
      (\fpof{\initmarkof{\ptype}}+\fpof{\vec{e}})(v) = 0}}) \\
  n(q^\ptype_\top) = \min(\mtarget(q^\ptype_\top),
  \cardof{\set{v\in\vlab^{-1}(\ptype) \setminus \img{\sources} \mid
      (\fpof{\initmarkof{\ptype}}+\fpof{\vec{e}})(v) = 1}})
  \end{array}\right.
  \\[1mm]
  \eta : & ~\universeOf{S} \rightarrow \pow{\interv{0}{K}^\sourcelabels \times \interv{0}{K}^\sourcelabels \times \interv{0}{K}^\mathcal{Q}} \\
  \eta(\asys,\sources) \isdef & \set{\omega(\vec{e},\sources) \mid \vec{e} \in \edgeof{\asys}^{*\leq K},~ \fpof{\initmarkof{\behof{\asys}}}+\fpof{\vec{e}} \text{ is a valid marking footprint over } \vertof{\asys}\setminus\img{\sources}}
\end{align*}

%% Formally, $(f^+,f^-,n)$
%% denotes the set of sequences $\vec{e}$ where, for each source
%% label $\asrc \in \sourcelabels$, each place $q \in \mathcal{Q}$ and
%% each marking $\amark \in \reach{\behof{\asys}}$ such that $\amark_0
%% \fire{\behof{\vec{e}}} \amark$: \begin{align*}
%%   \fromcount{\sources(\asrc)}{\vec{e}} = & f^+(\asrc) \hspace*{8mm} \cardof{\set{v\in\vlab^{-1}(\ptype) \setminus \img{\sources} \mid \pi_{\amark}(v) = 0}} = n(q^\ptype_\bot) \\
%%   \tocount{\sources(\asrc)}{\vec{e}} = & f^-(\asrc) \hspace*{8mm} \cardof{\set{v\in\vlab^{-1}(\ptype) \setminus \img{\sources} \mid \pi_{\amark}(v) = 1}} = n(q^\ptype_\top) 
%% \end{align*}
%% for which each component
%% tracks one of the criteria in \lemref{lem:alg-justification}:
%% $f^+(\sigma)$ and $f^-(\sigma)$ are the in- and out-degree of
%% $\sources(\sigma)$, while $n(q)$ counts whether $\mtarget(q)$ has been
%% covered.  More formally, $\vec{t}$ is represented by $(f^+,f^-,n)$
%% such that for every $\sigma\in\sourcelabels$ and every $q\in\places$:
%% \begin{itemize}
%%   \item $\tcount{(\sources(\sigma) \to \_)}{\vec{t}} = f^+(\sigma)$,
%%   \item $\tcount{(\_ \to \sources(\sigma))}{\vec{t}} = f^+(\sigma)$,
%%   \item $\cardof{\set{v\in\vlab^{-1}(\ptype) \setminus \img{\sources} \mid \pi_{\amark'}(v) = 0}} = n(q^\ptype_\bot)$,
%%   \item $\cardof{\set{v\in\vlab^{-1}(\ptype) \setminus \img{\sources} \mid \pi_{\amark'}(v) = 1}} = n(q^\ptype_\top)$.
%% \end{itemize}

We define the finite algebra of \emph{flows} $\algof{F}$ using
\propref{prop:cong-homo}, where $\eta$ is taken to be the
homomorphism between $\algof{S}$ and $\algof{F}$:

\begin{lemmaE}[][category=proofs]\label{lemma:cong-sys-flow}
  $\kerof{\eta}$ is a \hrtext{} congruence. 
\end{lemmaE}
\begin{proofE} Excluding the trivial case of an edge,
  we perform a case analysis.
  \begin{itemize}
    \item \underline{$\rename{\alpha}{\algof{S}}$}: we assume $(\asys,\sources)
      \kerof{\eta} (\asys',\sources')$.  We pick any
      $\omega(\vec{e},\sources\circ\alpha^{-1})$ in
      $\eta(\rename{\alpha}{\algof{S}}(\asys,\sources))$, and prove
      that it also occurs in
      $\eta(\rename{\alpha}{\algof{S}}(\asys',\sources'))$.  First we
      notice that $\rename{\alpha}{\algof{S}}(\asys,\sources)$ has the
      same edges as $(\asys,\sources)$, and thus the same set of
      sequences of transitions.  This means that
      $\omega(\vec{e},\sources) \in \eta(\asys,\sources)$.  The
      initial equivalence gives the existence of a matching
      $\omega(\vec{e},\sources) = \omega(\vec{e'},\sources') \in
      \eta(\asys',\sources')$, and thus a candidate is
      $\omega(\vec{e'},\sources'\circ\alpha^{-1})$.  Since
      $\img{\sources}$ and $\img{\sources'}$ are unchanged by a
      composition on the right by $\alpha^{-1}$, we maintain
      $\omega(\vec{e'},\sources'\circ\alpha^{-1}) =
      \omega(\vec{e},\sources\circ\alpha^{-1})$ and thus
      $\eta(\rename{\alpha}{\algof{S}}(\asys,\sources)) \subseteq
      \eta(\rename{\alpha}{\algof{S}}(\asys',\sources'))$.  The
      symmetry of the definition makes this actually an equality.
    %
    \item \underline{$\restrict{\tau}{\algof{S}}$}:
      we assume $(\asys,\sources) \kerof{\eta} (\asys',\sources')$.
      Once again $\restrict{\tau}{\algof{S}}(\asys,\sources)$ has the same edges as $(\asys,\sources)$,
      so this time the difficulty comes from the fact that $\img{\sources}$ shrinks,
      not from the set of sequences to consider.
      The key observation to make is that we always have
      $\fpof{\vec{e}}(v) = \tocount{v}{\vec{e}} - \fromcount{v}{\vec{e}}$,
      and this holds in particular for $v = \sources(\asrc)$,
      where additionally $\fpof{\vec{e}}(\sources(\asrc)) = f^+(\asrc) - f^-(\asrc)$.
      What this means is that when the equivalence $\kerof{\eta}$
      imposes $f^+ = f'^+$ and $f^- = f'^-$, it also guarantees that
      $\fpof{\initmarkof{\behof{\asys}}} + \fpof{\vec{e}}$
      is a valid marking footprint on $\sources(\asrc)$ if and only if
      $\fpof{\initmarkof{\behof{\asys'}}} + \fpof{\vec{e'}}$
      is a valid marking footprint on $\sources'(\asrc)$.
      The same reasoning goes for the more specific criterion that
      $(\fpof{\initmarkof{\ptype}} + \fpof{\vec{e}})(\sources(v)) = 0 \text{ or } 1$,
      from which we get that after restriction the two tuples are still in accordance
      and thus $\eta(\restrict{\tau}{\algof{S}}(\asys,\sources))
        = \eta(\restrict{\tau}{\algof{S}}(\asys',\sources'))$.
    %
    \item \underline{$\pop{\algof{S}}$}: take $(\asys_1,\sources_1)
      \kerof{\eta} (\asys'_1,\sources'_1)$ and $(\asys_2,\sources_2)
      \kerof{\eta} (\asys'_2,\sources'_2)$.  We write
      $(\asys,\sources) = (\asys_1,\sources_1) \pop{\algof{S}}
      (\asys_2,\sources_2)$, and similarly for $(\asys',\sources')$.
      We consider a sequence $\vec{e} \in \edgeof{\asys}^{*\leq K}$
      and aim to prove that one can find $\vec{e'} \in
      \edgeof{\asys'}^{*\leq K}$ that results in the same tuple
      through $\omega$. By definition of $\pop{\algof{S}}$ we have
      $\edgeof{\asys} = \edgeof{\asys_1} \uplus \edgeof{\asys_2}$.  We
      can thus partition $\vec{e}$ into two subsequences: $\vec{e}_i$
      holds all edges from $\asys_i$ ($i = 1,2$).  To these two
      subsequences naturally correspond through the equivalence
      $\kerof{\eta}$ two sequences of $\edgeof{\asys'_1}$ and
      $\edgeof{\asys'_2}$ respectively, which we write $\vec{e}'_1$
      and $\vec{e}'_2$.  Since $\vec{e}' \isdef \vec{e}'_1 ;
      \vec{e}'_2$ is a good candidate for our solution, we take a
      moment to write the relationships between the various tuples
      involved:
      \begin{itemize}
        \item $f^+ = f^+_1 + f^+_2$, $f'^+ = f'^+_1 + f'^+_2$,
          $f^- = f^-_1 + f^-_2$, and $f'^- = f'^-_1 + f'^-_2$:
          these hold because they are defined from elementary
          $\tcount{e}{\vec{e}}$ which due to the partition of edges
          satisfy additive properties;
        \item $n(q) = n_1(q) + n_2(q)$, and $n'(q) = n'_1(q) + n'_2(q)$:
          these hold because during a composition the sets of vertices that
          are not sources are disjoint in the result;
        \item and naturally $\fpof{\vec{e}} = \fpof{\vec{e}_1} + \fpof{\vec{e}_2}$,
          and $\fpof{\vec{e}'} = \fpof{\vec{e}'_1} + \fpof{\vec{e}'_2}$
          because once again the sets of edges are disjoint each time.
      \end{itemize}
      In the output of a composition, the set $\vertof{\asys}\setminus\img{\sources}$
      of vertices that are not sources is a disjoint union of the vertices that were not sources
      from the two graphs that were composed, thus the condition
      ``is a valid marking footprint over $\vertof{\asys}\setminus\img{\sources}$''
      is easily preserved.
      Thus $\eta(\asys,\sources) = \eta(\asys',\sources')$.
  \end{itemize}
  We conclude that $\kerof{\eta}$ is a \hrtext{} congruence.
  \qed
\end{proofE}

The remainder of the proof for the upper bound from
\thmref{thm:pebble-passing} relies on the fact that the interpretation of
the \hrtext{} signature in $\algof{F}$ is effectively computable. The
size of the grammar $\grammar$ is the total number of occurrences of a
nonterminal or function symbol in a rule from $\grammar$, denoted as
$\sizeof{\grammar}$.

\newcommand{\closedstp}[3]{\mathsf{closed}^{#1}_{#2}({#3})}

\begin{propositionE}[][category=proofs]\label{prop:alg-flows}
  The size of each element $f \in \universeOf{F}$ is
  $2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log K)}$
  and the function $\aop^\algof{F}(f_1,\ldots,f_n)$ can be computed in
  time $2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log
    K)}$, for each \hrtext-function symbol $\aop$ of arity $n\geq0$
  and all elements $f_1,\ldots,f_n \in \universeOf{F}$. Moreover, for
  each grammar $\grammar$ using source labels from $\sourcelabels$,
  the language $\alangof{}{\algof{F}}{\grammar}$ is computable in time
  $2^{\sizeof{\grammar} \cdot
    2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log
      K)}}$.
\end{propositionE}
\begin{proofE}
  % During a restriction $\restrict{\tau}{\algof{S}}(\asys,\sources)$,
  We denote by $\closedstp{\sources}{\tau}{\ptype}$ the set of source
  labels such that $\asrc \in \closedstp{\sources}{\tau}{\ptype}$ iff
  $\asrc\in\dom{\sources}$ and $\asrc\not\in\tau$ and the
  $\ptypeof{\asrc} = \ptype$.  We define $\fpof{\initmark}(\ptype)
  \isdef \amark_0(q^\ptype_\top)$. The function $\delta_x$ outputs 1
  on $x$ and $0$ everywhere else (Kronecker delta). For a function $f$
  with domain $\sourcelabels$, we denote by $\proj{f}{\tau}$ the
  restriction of $f$ to the source labels in $\tau \subseteq
  \sourcelabels$. The inference rules below define the operations of
  $\algof{F}$: 
  \begin{prooftree}
    \AxiomC{$
      0 \leq k \leq K
    $}
    \RightLabel{Edge}
    \UnaryInfC{$
      (k \cdot \delta_{\sigma_2}, k \cdot \delta_{\sigma_1}, 0) \in \sgraph{(\send,\recv)}{\asrc_1}{\asrc_2}{\algof{F}}
    $}
  \end{prooftree}
  \begin{prooftree}
    \AxiomC{$
      (f^+,f^-,n) \in F
    $}
    \RightLabel{Rename}
    \UnaryInfC{$
      (f^+\circ\alpha^{-1}, f^-\circ\alpha^{-1}, n)
      \in \rename{\alpha}{\algof{F}} (F)
    $}
  \end{prooftree}
  \begin{prooftree}
    \AxiomC{$
      \begin{array}{c}
        (f^+_1,f^-_1,n_1) \in F_1 \qquad
        (f^+_2,f^-_2,n_2) \in F_2 \\
        f^+_1 + f^+_2 \leq K \qquad
        f^-_1 + f^-_2 \leq K
      \end{array}
    $}
    \RightLabel{Compose}
    \UnaryInfC{$
      (f^+_1 + f^+_2, f^-_1 + f^-_2, \min(\mtarget, n_1 + n_2)) \in F_1 \pop{\algof{F}} F_2
    $}
  \end{prooftree}
  \begin{prooftree}
    \AxiomC{$
      \begin{array}{c}
        (f^+, f^-, n) \in F \\
        \forall\sigma\in\closedstp{\sources}{\tau}{\ptype}.\ f^+(\asrc) - f^-(\asrc) + \fpof{\initmark(\ptypeof{\asrc})} \in \set{0,1} \\
        \forall\ptype.\ d_n(q^\ptype_\bot) \isdef \cardof{\set{\asrc\in\closedstp{\sources}{\tau}{\ptype} \mid f^+(\asrc) - f^-(\asrc) + \pi_{init}(\ptype) = 0}} \\
        \forall\ptype.\ d_n(q^\ptype_\top) \isdef \cardof{\set{\asrc\in\closedstp{\sources}{\tau}{\ptype} \mid f^+(\asrc) - f^-(\asrc) + \pi_{init}(\ptype) = 1}} \\
      \end{array}
    $}
    \RightLabel{Restrict}
    \UnaryInfC{$
      (\proj{f^+}{\tau}, \proj{f^-}{\tau}, \min(\mtarget, n + d_n))
      \in \restrict{\tau}{\algof{F}}(F)
    $}
  \end{prooftree}
  First we prove that these inference rules are compatible with $\eta$
  defined earlier, \ie for any ground \hrtext{} term $\theta$, we have
  $\eta(\theta^\algof{S}) = \theta^\algof{F}$.
  \begin{itemize}
    \item \underline{$(\send,\recv)^\algof{F}_{\asrc_1,\asrc_2}$}:
      the firing sequences of $(\send,\recv)^\algof{S}_{\asrc_1,\asrc_2}$
      are a single edge repeated arbitrarily many times.
      Of these the firing sequences that use each vertex at most $K$ times
      are exactly the $\vec{e}_k$ of footprint
      $\fpof{\vec{e}_k}$ that equals $-k$ on $\sources(\asrc_1)$,
      $+k$ on $\sources(\asrc_2)$, and $0$ everywhere else.
      The set $\verts\setminus\img{\sources}$ is empty and thus $n$ is 0 everywhere.
      This generates exactly the set that the rule Edge produces.
    \item \underline{$\rename{\alpha}{\algof{F}}$}: by applying the
      same renaming to $f^+$ and $f^-$ as we do to the graph, we
      obviously preserve the relationship between the two.
    \item \underline{$\pop{\algof{F}}$}:
      without the constraints of finiteness,
      we would simply take $f^+_1 + f^+_2$, $f^-_1 + f^-_2$, and $n_1 + n_2$.
      The additional constraints are translated exactly from their
      equivalent in the definition of $\eta$:
      we require $f^+_1 + f^+_2 \leq K$ and $f^-_1 + f^-_2 \leq K$
      to conform to the rule that the sequence we consider must belong
      to $\edges^{*\leq K}$ (recall that $f^+$ and $f^-$ are incoming
      and outgoing degrees, so if one of them exceeds $K$ then the overall
      sequence has degree greater than $K$),
      and apply $\min(\mtarget, ...)$ so that $n$ remains bounded by $\mtarget$
      just like how it is defined in $\omega$.
      Since we apply exactly the same constraints to $(f^+,f^-,n)$ here
      as we did in the original definition of $\omega$,
      we obtain the same final set of tuples.
    \item \underline{$\restrict{\tau}{\algof{F}}$}: the key property
      is that $\closedstp{\sources}{\tau}{\ptype} =
      \text{ptype}^{-1}(\ptype) \cap (\dom{\sources} \setminus
      (\dom{\proj{\sources}{\tau}}))$.  This is relevant because it
      implies $(\vlab^{-1}(\ptype) \setminus
      \img{\proj{\sources}{\tau}}) = (\vlab^{-1}(\ptype) \setminus
      \img{\sources}) \uplus
      \sources(\closedstp{\sources}{\tau}{\ptype})$, in which the
      first two terms have the same shape as one that occurs in the
      definition of $n$ for $\omega$, and the third gives the
      definition of $d_n$ in rule Restrict above.  This means that
      given $n$ and $n'$ from tuples in $\eta(\asys,\sources)$ and
      $\eta(\restrict{\tau}{\algof{S}}(\asys,\sources))$, we indeed
      have $n' = n + d_n$.  The constraint $0 \leq f^+(\asrc) -
      f^-(\asrc) + \fpof{\initmarkof{\ptypeof{\asrc}}} \leq 1$ from
      the premiss of the Restrict rule enforces the requirement
      ``$\fpof{\initmarkof{\behof{\asys}}} + \fpof{\vec{e}}$ is a
      valid marking footprint'' for all vertices that were added to
      $\vertof{\asys}\setminus\img{\sources}$ by the restriction.  The
      rest of the definition follows the same principles as for the
      other cases: $f^+(\asrc) - f^-(\asrc)$ has already been
      justified to be a synonym for $\fpof{\vec{e}}(\sources(\asrc))$,
      $f^+$ and $f^-$ must be constrained to their new domain, and $n
      + d_n$ must not exceed $\mtarget$.
  \end{itemize}
  Therefore $\algof{F}$ defined explicitly here is compatible
  with its implicit definition in \lemref{lemma:cong-sys-flow}.

  Since each tuple in an element of $\universeOf{F}$ is of size
  \[\cardof{[0,K]^\sourcelabels \times [0,K]^\sourcelabels \times
    [0,K]^\mathcal{Q}} = (K+1)^{2\cardof{\sourcelabels} +
    2\cardof{\ptypes}}\] each element of $\universeOf{F}$ is of size 
  $2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log K)}$.
  From the definition of the inference rules, Edge takes
  constant time to apply, Rename and Restrict take linear time, and
  Compose takes quadratic time in the size of their arguments. Then,
  evaluating the interpretation of any \hrtext{} function symbol takes
  $2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log K)}$
  time. Because the domain of the algebra $\algof{F}$ is
  finite, the language $\alangof{}{\algof{F}}{\grammar}$ can be
  computed by a finite iteration of the Kleene sequence
  $\overrightarrow{\emptyset},
  \sem{\grammar}(\overrightarrow{\emptyset}),\sem{\grammar}(\overrightarrow{\emptyset})
  \cup \sem{\grammar}^2(\overrightarrow{\emptyset}), \ldots$, where
  $\sem{\grammar}$ is the function that maps any valuation of the
  nonterminals in $\grammar$ to the sets obtained by applying the
  rules of $\grammar$ and $\overrightarrow{\emptyset}$ assigns the
  empty set to each such nonterminal. Since each element of
  $\algof{F}$ is of size
  $2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log K)}$,
  there are at most
  $2^{2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log
      K)}}$ such elements, hence the Kleene iteration takes at most as
  many steps to reach a fixpoint. Moreover, computing each step of the
  Kleene iteration takes $\sizeof{\grammar} \cdot
  2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log K)}$
  time, hence the entire language can be computed in time
  $2^{\sizeof{\grammar} \cdot
    2^{\bigO((\cardof{\sourcelabels}+\cardof{\ptypes}) \cdot \log
      K)}}$.\qed
\end{proofE}

\noindent Deciding whether $\mtarget$ is coverable by some instance
$\asys \in \alangof{}{\algof{S}}{\grammar}$, for a given \hrtext{}
grammar $\grammar$, is done by checking
$\restrict{\emptyset}{\algof{F}}(\alangof{}{\algof{F}}{\grammar}) \cap
\set{(0,0,\mtarget)} \stackrel{?}{=} \emptyset$. We apply
$\restrict{\emptyset}{}$ to $\alangof{}{\algof{F}}{\grammar}$ to
ensure that the sequences of edges considered lead to valid marking
footprints on every vertex of a system $(\asys,\sources) \in
\alangof{}{\algof{S}}{\grammar}$, including the sources from
$\img{\sources}$, that were exempt from satisfying this condition (see
the above definition of $\eta$). The latter emptiness check applies
the Filtering Theorem (\thmref{thm:filtering}), leading to an overall
\twoexptime\ upper bound.


The \pspace\ lower bound is obtained by a polynomial reduction from
the \pspace-complete emptiness problem for 2-way nondeterministic
finite automata (\twonfa). The idea of the reduction is to simulate a
run of a \twonfa{} by a grid-like system, such that the horizontal
axis corresponds to the length of the word and the vertical axis to
the number of control states of the automaton. A run of the \twonfa{}
is modeled by an execution of the system that moves a pebble
left/right to the next control state given by the transition relation
of the automaton. \ifLongVersion\else
Formal details can be found in \appref{app:lower-bound}. 
\fi

\begin{textAtEnd}[category=hardness]
% \subsection*{Proof of \thmref{thm:pebble-passing}: lower bound} \label{sec:pebble-hard}

In order to demonstrate that our restriction has not made the problem
trivial, we show that it remains \textsf{PSPACE}-hard to decide
coverability.  This is done by reduction from the known
\textsf{PSPACE}-complete problem of deciding the emptiness of the
language of a 2NFA (2-way Nondeterministic Finite Automaton,
\cite{2nfa}), which is essentially a read-only Turing Machine.

\begin{definition}{\textbf{2NFA.}}
  A 2NFA is a tuple $\automata = (Q, A, \delta, q_0, q_f)$,
  where $Q$ denotes the set of states (of which $q_0$ is the initial state
  and $q_f$ is the accepting state)
  and $A$ denotes the alphabet.
  Compared to a regular automaton, the transition function
  $\delta : Q \times (A \uplus \set{\langle,\rangle}) \to \pow{Q \times \set{\leftarrow, \rightarrow}}$
  also dedermines the direction in which the next letter is read
  ($\langle \cdots \rangle$ mark the beginning and end of words).
\end{definition}

\begin{lemma}
  The emptiness problem for a 2NFA reduces to coverability in pebble-passing systems.
  Knowing that emptiness is \textsf{PSPACE}-complete, this implies that
  coverability is \textsf{PSPACE}-complete.
\end{lemma}
\begin{proof}
  We need three process types: $\ptypes = \set{\ptype_i, \ptype_f, \ptype}$,
  representing respectively the initial, final, and any other state.
  We pick the set of sources $\sourcelabels \isdef Q \times \set{\leftarrow, \rightarrow} \cup {\mathsf{init}}$.
  The grammar $\grammar_\automata$ constructs systems that simulate the execution
  of $\automata$ on an arbitrary word of $\langle A^* \rangle$.

  Given a 2NFA $\automata$, construct the following grammar $\grammar_\automata$:
  \input{figure-2nfa/gram.tex}
  on which we ask the coverability query $\mtarget : \left\{\begin{array}{ll}q^{\ptype_f}_\top & \mapsto 1 \\ \_ & \mapsto 0\end{array}\right.$.
  When the grammar unfolds successively the nonterminals $X_{a_1}, T_{a_1 a_2}, X_{a_2}, T_{a_2 a_3}, X_{a_3}, ...$
  it simulates the behavior of $\automata$ on the word $a_1 a_2 a_3 \cdots$,
  in that if $\automata$ is reading the $i$'th letter while in state $q$
  then the token is currently on place $q_1$ of the process
  which at depth $i$ of unfolding the grammar was labeled by the source $(q, \rightarrow)$.
  Applied to $q_f$ this means that the place $q^{\ptype_f}_1$ can have a token
  exactly when the automaton reaches state $q_f$.
  The grammar ensures that any word in $A^*$ can be generated in this manner,
  and thus that $\mtarget$ is coverable if and only if the language is nonempty.
\end{proof}

\begin{example}
  In \figref{fig:2nfa-example} we show how this construction turns an example automata
  into a pebble-passing system that simulates its execution on a given word.
\end{example}

\input{figure-2nfa/rendered.tex}
\end{textAtEnd}


