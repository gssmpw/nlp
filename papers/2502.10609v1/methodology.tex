%\input{sections/latex_figures/figure_4.tex} % Chesapeake bay rasterized and persistend parameter

\section{Methodology}\label{sec:methods}
%
%\begin{itemize}
%	\item Creates a background grid bounding the object to be meshed
%	\item Using winding numbers, checks if a user defined number of points in each background grid face are in or out of the object being sculpted
%	\item Computes the volume fraction of each background grid cell from winding number output
%	\item Includes background grid faces in the final mesh if the volume fraction is above or equal to a user defined cut off
%	\item Explore topology of resulting meshes using a persistent homology
%	\item Note that because we work first on grid cells, our filtration operates on the dual of the intended quadrilateral mesh
%	\item Finally creates mesh based on desired topology
%\end{itemize}
%
%{\Rd Originally, we wanted to use persistent homology to tell us important points where the mesh changes as background mesh refinement increased.
%However, the following are counter-examples, and why we choose a fixed mesh refinement}
%\begin{itemize}
%	\item The homology does not always behave monotonically
%	\item Example of oscillations between in and out of face
%	\item Sharp angles
%	\item Other examples
%\end{itemize}

\input{figure_4.tex} % Chesapeake bay rasterized and persistend parameter

%{\Rd The \briancode{} algorithm proceeds as shown in \cref{fig:flowchart}. 
%It first defines a background grid and then calculates the volume fraction for each cell using a generalized the winding number \cite{Jacobson:2013}. 
%The dual of the mesh is then triangulated for the persistent homology calculation, which will be explained hereafter. 
%Given the persistent homology a volume fraction threshold is selected. 
%The subsequent mesh is then input to the anti-aliasing algorithm to remove undesired topology. 
%}

%We begin with a planar input domain.
\paragraph{Volume Fractions.}
Herein we study both 2D and 3D domains.
We define a regular background grid, e.g. by subdividing an axis-aligned bounding box.
This grid is a cubical quadrilateral or hexahedral complex, depending on the domain dimension.
% winding numbers already covered in prior section
%Using generalized winding numbers, a user-defined set of points in each background cell is checked to quantify whether the a cell is interior or exterior.
%For watertight geometries with correctly-oriented boundaries, winding numbers are either 0 or 1 for each point.
%For geometry with gaps winding numbers are between 0 and 1, and invalid geometries may give values outside these bounds.
The volume fraction of each maximal-dimension cell is computed as the average of the winding numbers of its sample points.
Sample points lie in an $s^d$ array, as shown in \cref{fig:subcell_pts}.  
%We study how the topology changes as we lower the volume fraction threshold for including a cell in the output mesh.
(Recall we calculate persistent homology based on volume fractions, with the goal that the user may select the volume fraction that achieves their desired mesh topology.)

\begin{figure}[!htb]
\centering
\subfloat[Vertex, even ]{
	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.23\columnwidth,,clip]{sample_pts_vertex.png}}
\subfloat[Vertex, odd ]{
	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.23\columnwidth,,clip]{sample_pts_vertex_3x3.png}
	\label{fig:odd_vert}}
\subfloat[Edge, even ]{
	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.23\columnwidth,,clip]{sample_pts_edge.png}}
\subfloat[Edge, odd ]{
	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.23\columnwidth,,clip]{sample_pts_edge_3x3.png}
	\label{fig:odd_edge}}
\caption{Sample $s \times s$ arrays are shown. Samples contained by the red dashed lines define vertex and edge volume fractions in 2D. We use only even sample arrays.}
\label{fig:subcell_pts}
\end{figure}

%A quadrilateral cell is included in the quadrilateral mesh if the volume fraction for the cell is above or equal to a user defined cut off.
%To explore variations in mesh topology, the above-defined volume fraction is used as the persistence parameter over a filtration of the background grid. 

%\begin{figure}[!htb]
%\centering
%\subfloat[1x1 ]{
%	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.24\columnwidth,,clip]{sections/latex_figures/sample_pts/1x1.png}}
%\subfloat[2x2 ]{
%	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.24\columnwidth,,clip]{sections/latex_figures/sample_pts/2x2.png}}
%\subfloat[3x3 ]{
%	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.24\columnwidth,,clip]{sections/latex_figures/sample_pts/3x3.png}}
%\subfloat[4x4 ]{
%	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.24\columnwidth,,clip]{sections/latex_figures/sample_pts/4x4.png}}
%\caption{Sample $s \times s$ arrays in 2D are shown.}
%\label{fig:sample_pts}
%\end{figure}
% could skip the first figure entirely, as the second covers it reasonably.
% Use ``vertices'' and not ``nodes'' except when discussing smoothing in the introduction

\paragraph{Volume-Fraction Persistence Parameter.}
% first define the filtration
% then convert it to simplices 
The persistence parameter used herein is the volume-fraction threshold, ordered from 1 down to 0 (i.e. by decreasing value).
%This adds top-dimensional cells with the highest volume fractions first.
%That is, the filtration order contains the top-dimensional cells by decreasing volume fraction.
By defining volume fractions only for cells of maximal dimension, a mesh is defined by including all cells with volume fraction greater than or equal to the chosen threshold, and removing all others.
The order that cells are added to the mesh as a function of the persistence parameter is demonstrated on a topologically invalid representation of the Chesapeake Bay in \cref{fig:volfrac_chesapeake}.
The persistent homology diagram is displayed in \cref{fig:persistence_diagram}.
These images illustrate significant topological aliasing, which limits the utility of these meshes.
In what follows, we aim to mitigate these rasterization effects.
%{\Rd move \cref{fig:persistence_diagram,fig:volfrac_chesapeake} here. Talk about the figures.

\paragraph{Sub-cell Volume Fractions.}
To assist in topological anti-aliasing, we also define volume fractions for all lower-dimensional grid cells.
For any such $n$-cell, its sample points are those in a (fictitious) grid cell centered at that $n$-cell; see \cref{fig:subcell_pts}.
We use only even numbers $s$ of sample points because these samples do not lie on cell boundaries.
Volume fractions for these lower-dimensional cells are computed as averages of winding numbers associated with sample points contained in the fictitious grid cell, in a manner analogous to cells of maximal dimension.
As before, only cells with volume fraction greater than or equal to a prescribed threshold will remain in the cell complex. All others are omitted.
Omitted cells are called ``exterior'' cells, while remaining cells are called ``interior'' cells.
We call this sampling process ``\emph{subgrid sampling}.''


%\begin{figure}[!htb]
%\centering
%\subfloat[Vertex, even ]{
%	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.24\columnwidth,,clip]{sections/latex_figures/sample_pts/vertex.png}}
%\subfloat[Vertex, odd ]{
%	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.24\columnwidth,,clip]{sections/latex_figures/sample_pts/vertex_3x3.png}
%	\label{fig:odd_vert}}
%\subfloat[Edge, even ]{
%	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.24\columnwidth,,clip]{sections/latex_figures/sample_pts/edge.png}}
%\subfloat[Edge, odd ]{
%	\includegraphics[trim=30cm 2cm 26cm 2cm, width=0.24\columnwidth,,clip]{sections/latex_figures/sample_pts/edge_3x3.png}
%	\label{fig:odd_edge}}
%\caption{Samples defining vertex and edge volume fractions in 2D. We use only even sample arrays.}
%\label{fig:subcell_pts}
%\end{figure}

\paragraph{Anti-aliasing.}
To address the undesirable rasterization effects introduced by our background grid (including pinch and archipelago removal), we employ subgrid sampling as an anti-aliasing method.

\input{figure_2.tex} % primal-dual-tet image for persistent homology in Aleph picture


In 2D, the only possible pinch is two quads meeting at a pinch vertex, whereas in 3D there are 11 possible configurations of pinched edges and vertices.
These are shown in \cref{fig:3d_nonmanifold}.
% \cref{fig:two_d_nonmanifold} and .
To find pinches, we consider each vertex and the neighborhood of cells containing it, 
i.e., $2 \times  2$ quads in 2D and $2 \times 2 \times 2$ hexes in 3D.
If the neighborhood corresponds to a pinch case, the pinch vertices and edges are queued.
Each pinch in the queue is processed in a way that is compatible with processing nearby pinches.
The  pinches are connected if the subcells (vertices or edges) are interior, and disconnected if they are exterior. 
Each pinch is repaired by splitting cells (either mesh cells or their complement) using predefined splits, and discarding or adding some of the split cells.
The splits are shown in \cref{fig:templates}.
In 2D, the template is a one-to-five split.
In 3D, pinch edges are repaired before vertices.
The edge-repair template is a one-to-seven split. 
For pinch vertices, we follow with a two-to-six split of any pairs of hexes from two different one-to-seven splits that share a face; see \cref{fig:3d_split_2_6}.

\begin{figure}[!htb]
\centering
\subfloat[Mesh]{\includegraphics[trim=17cm 4cm 8cm 4cm,width=0.45\columnwidth,clip]{pinches_in_series_all_faces.png}}
\hfill
\subfloat[Separated]{\includegraphics[trim=17cm 4cm 8cm 4cm,width=0.45\columnwidth,clip]{pinches_in_series_separated.png}}
\\
\subfloat[Connected]{\includegraphics[trim=17cm 4cm 8cm 4cm, width=0.45\columnwidth,clip]{pinches_in_series_connected.png}}
\hfill
\subfloat[Both]{\includegraphics[trim=17cm 4cm 8cm 4cm, width=0.45\columnwidth,clip]{pinches_in_series_both.png}}
\caption{Adjacent pinches must be resolved the same way. Here the resolved mesh is shown for different configurations of ``inside'' vertices (red).}
\label{fig:pinches_in_series}
\end{figure}

\begin{figure}[!htb]
\centering
\subfloat[Vol. Frac.: 1.0]{\includegraphics[trim=15cm 2cm 11cm 2cm,width=0.4\columnwidth,clip]{edges_connecting_1.png}}
\hfill
\subfloat[Vol. Frac.: 0.75]{\includegraphics[trim=15cm 2cm 11cm 2cm,width=0.4\columnwidth,clip]{edges_connecting_0.75.png}}
\\
\subfloat[Vol. Frac.: 0.5]{\includegraphics[trim=15cm 2cm 11cm 2cm,width=0.4\columnwidth,clip]{edges_connecting_0.5.png}}
\hfill
\subfloat[Vol. Frac.: 0.25]{\includegraphics[trim=15cm 2cm 11cm 2cm,width=0.4\columnwidth,clip]{edges_connecting_0.25.png}}
\caption{Faces are connected using templates when ``inside'' edges (red) create a continuous bridge between components.}
\label{fig:connecting_edges}
\end{figure}

To separate cells, splits are performed on the cells of the mesh itself, and child cells that contain pinch vertices or edges are removed, as shown in \cref{fig:cases_separated}.
To connect cells, splits are performed on the complement of the mesh, and child cells that contain pinches are added to the mesh, as illustrated in \cref{fig:cases_connected}.
A single mesh can use both separations and connections in different regions.
However, we require that all adjacent pinches must be resolved in the same way to ensure validity of the resulting mesh.
Two sets of pinches separated by cells without pinches can be resolved in opposite ways.
Our rules occasionally indicate that adjacent pinches should be resolved in opposite ways.
We pre-select whether we connect or separate these cases, see \cref{fig:pinches_in_series}.
%This is shown in \cref{fig:pinches_in_series,fig:diagonal_subcells}.

\begin{figure}[!htb]
\centering
\subfloat[Subcells]{
	\includegraphics[trim=10.833cm 16.667cm 11.662cm 8.333cm,width=0.98\columnwidth,clip]{jaggies_subcells.png}}
\\
\subfloat[Anti-aliased]{
	\includegraphics[trim=13cm 20cm 14cm 10cm,width=0.98\columnwidth,clip]{antialiased_jaggies.png}}
\caption{Subgrid sampling and anti-aliasing performed on \cref{fig:jaggies}.}
\label{fig:jaggies_subcells}
\end{figure}

\begin{figure}[!htb]
\centering
\subfloat[Subcells]{
	\includegraphics[trim=30cm 9.167cm 27.5cm 8.333cm,width=0.46\columnwidth,clip]{diagonal-subcells.png}}
\hspace{8pt}
\subfloat[Anti-aliased]{
	\includegraphics[trim=36cm 11cm 33cm 10cm, width=0.46\columnwidth,clip]{diagonal-mended.png}}
\caption{Subgrid sampling and anti-aliasing are performed on \cref{fig:diagonal}.}
\label{fig:diagonal_subcells}
\end{figure}

When separating pinches, the configuration in \cref{fig:case3} is the only exception to the rule of removing all the child cells that share the pinch edge. 
The one-to-seven split is performed on the hexahedra sharing the pinch edge, and all the child hexahedra that contain that edge are removed. 
This turns the central vertex into a pinch. To prevent that, one additional child hexahedron is removed. 
In the orientation of  \cref{fig:case3}, the removed hex is the rightmost child of the top hex, which contains the central vertex; see \cref{fig:case3_separated}.

%Lastly, we note that Although not shown in this work, to further inform how ``interior'' or ``exterior'' a cell is, we intend to use quadtree type refinement based on the winding number data. The volume fraction for the child cells will be computed using multiple sample points. Given a user defined threshold, the difference in volume fractions will determine if a parent cell is to be refined.

For resolving archipelagos, all the connected components of the mesh are identified.
%\begin{itemize}
%\item Check if any pair of connected components are connected by edges that are ``in'' 
%\item Connect them with template geometry 
%\item Check remaining connected components with fewer than a user defined number of highest dimensional cells
%\item If these connected components contain less than m subcells that are interior to the geometry, that connected component is removed. 
%\end{itemize}
For any pair of connected components, if the edges that connect them are interior to the geometry, the components are joined using templates along those edges.
The remaining connected components that contain fewer than a user-defined number of highest-dimensional cells are removed.
% Scott: I don't know why we need a queue. The components are independent and can be removed in any order.
%added to a queue. 
%For each component, if fewer than $x$ subcells are contained within, then that component is removed.
This process is demonstrated in \cref{fig:connecting_edges}. %fig:jaggies_subcells}.
In \cref{fig:diagonal_subcells,fig:jaggies_subcells} the utility of the anti-aliasing algorithm is demonstrated on the unaligned gap and sharp angle of \cref{fig:diagonal,fig:jaggies} respectively.
%This process is demonstrated in \cref{fig:diagonal_subcells,fig:jaggies_subcells}.


%Lastly, we note that Although not shown in this work, to further inform how ``interior'' or ``exterior'' a cell is, we intend to use quadtree type refinement based on the winding number data. The volume fraction for the child cells will be computed using multiple sample points. Given a user defined threshold, the difference in volume fractions will determine if a parent cell is to be refined.







\paragraph{Transferring Persistent Parameters to Simplices.}
Having a framework by which topological anti-aliasing can be performed on the mesh by use of subgrid sampling and templates, we now turn our attention to ensuring that the topological anti-aliasing defined above is accurately represented in persistent homology calculations.
Because most open-source persistent homology software employs simplicial complexes, we first 
transform the cubical filtration into a topologically-equivalent simplicial filtration.
In what follows, we prioritize consistent pinch resolution, over archipelago resolution.
As a result, we make the assumption in 2D that an edge shared by two interior quadrilaterals will also be interior, and that an edge shared by two interior vertices must also be interior.
Similarly, in 3D, a face shared by two interior hexahedra will be interior, as will a face bounded by four interior edges and vertices.
We first focus on the 2D framework, followed by 3D.

In 2D, a primal vertex induces a dual 2-cell, and a primal edge induces a dual edge, and a primal quad induces a dual vertex.
%In 3D, a primal vertex dualizes to a 3-cell, an edge to a 2-cell, a quad to a 1-cell, and a hex to a 0-cell.
Each dual vertex is assigned the filtration value of its corresponding primal face's volume fraction.
%{\Rd propose: "Each 1-cell divides into two edges with a shared vertex at the 1-cell midpoint." would have to change the 4-triangles to 8-triangles, etc.}
% For structured grids, dual 2-cells are quadrilaterals.
The dual mesh is then further subdivided into a simplicial mesh.
To create the simplicial mesh, an additional simplicial vertex is introduced at the centroid of each dual 2-cell. 
Simplices are then formed as the join of each dual face's edge with the simplicial centroid vertex.
This simplicial vertex corresponds to a vertex on the primal mesh, and takes the filtration value of the corresponding primal vertex's volume fraction.
However, to preclude the introduction of spurious topological artifacts (and consistent with previous computations), we also require that this volume fraction be between the maximal and minimal volume fraction of the surrounding four vertices.
The filtration value of this simplicial vertex then informs whether two primal faces connected with a pinch should be topologically separated or connected.
Having thus defined filtration values for all vertices of the induced simplicial complex, we then use a Vietoris–Rips complex to calculate persistent homology, meaning that 
at persistence value $k \in \mathbb{R}$, all vertices with persistence parameter value greater than or equal to $k$ are added to the filtration, then all edges between already-added vertices, then all triangles formed by already-added edges.
%For structured grids, this transforms every dual face into four simplicial faces with a common vertex at the centroid of the dual face.
%In the primal mesh, the centroid of these dual faces can be associated with vertices in the primal meshes.
%with each dual 2-cell  each of which is subdivided into 4 triangles with a shared vertex at the 2-cell centroid.


In 3D, a primal vertex induces a dual volume cell, and a primal edge induces a dual face, a primal face induces a dual edge, and a primal volume induces a dual vertex.
As in 2D, each dual vertex is assigned the filtration value of its primal volume.
To generate a simplicial mesh from the dual mesh, each dual face is subdivided into four triangles with a new vertex introduced, as in 2D.
Here, the additional vertex corresponds to a primal edge and will take the filtration value of the volume fraction of this primal edge, subject to constraints keeping the filtration value between the maximal and minimal values of the surrounding four simplices of the dual face.
Each dual volume is then subdivided into 24 tetrahedra by introducing a single simplicial vertex at the centroid of the dual volume and taking the join of this vertex with each of the 24 triangles defined on the (subdivided) faces of the dual volume.
Again, this new simplicial vertex will correspond to a vertex on the primal mesh, and consequently takes a filtration value of the volume fraction of this primal mesh vertex (again subject to the constraint that the filtration value must be between the maximal and minimal values of the 26 surrounding vertices).
The filtration values of the simplicial vertices corresponding to primal vertices and primal edges is then locally consistent with the procedures performed resolve pinch points, and will have identical persistent homology.
%
This conversion process, from a cubical primal cell complex into a simplicial one with an identical filtration is illustrated in \cref{fig:subdivision,fig:3d_subdivision}.

For the sake of completeness, we also note that similar primal-to-dual-to-simplicial operations could be performed on unstructured background meshes.
In the 2D case, each dual cell of maximal dimension and with $k$ sides would be subdivided into $k$ triangles.
In 3D, each dual cell of maximal dimension and with $\ell$ faces,  with the $i$th face having $k_i$ sides, would subdivide into $\sum_{i=1}^\ell k_i$ tetrahedra.

Finally, we note that for a truly general framework, a vertex in the above-defined simplicial complexes would need to be defined for each cell in the primal complex.
Particularly, in 2D we currently introduce vertices corresponding to primal faces and vertices, but not for primal edges.
This would require splitting every dual face into 8 simplices, rather than 4.
In 3D, we introduce vertices for all cells except for primal faces, and would require splitting every dual volume into 48 tetrahedra, rather than 24.
Given the challenges of navigating this topological space in a meaningful way (as well as the additional computational expense incurred by such a navigation), we leave this for future work.





\begin{figure}[!tb]
	\centering
	\subfloat[Primal volume fractions]{
		\includegraphics[trim=0.6cm 2.8cm 22.8cm 1.4cm, width=0.4\columnwidth,clip]{subdivision_to_triangulation_setup.png}\label{fig:primalVF}
	}
	\;\;
	\subfloat[Dual volume fractions]{
		\includegraphics[trim=12cm 2.8cm 11.4cm 1.4cm, width=0.4\columnwidth,clip]{subdivision_to_triangulation_setup.png}\label{fig:dualVF}
	}
	\;\;
	\subfloat[Connected simplices]{
		\includegraphics[trim=0.6cm 2.2cm 22.8cm 1.4cm, width=0.4\columnwidth,clip]{subdivision_to_triangulation_no_coloring.png}
		\label{fig:connected_simplicies}
	}
	\;\;
	\subfloat[Disconnected simplices]{
		\includegraphics[trim=12cm 2.2cm 11.4cm 1.4cm, width=0.4\columnwidth,clip]{subdivision_to_triangulation.png}
		\label{fig:separated_simplicies}
	}
\caption{An example of converting 2D cell volume fractions into a filtration of a simplicial complex. 
	Numbers are proportional to volume fraction.
	\protect{\Cref{fig:primalVF}} shows the ordering of grid cells from high to low. 
	\protect{\Cref{fig:dualVF}} shows the dual grid with vertex values transferred from grid cells.
	In \cref{fig:connected_simplicies,fig:separated_simplicies} the dual complex is subdivided into a simplicial complex
	and the threshold is set so that all cells with value 4 or more are added.
	The choice of volume fraction for the introduced vertices (in bold) determines the connectivity near pinches. 
%	Alternative choices of volume fractions for these vertices could also be defined using subgrid sampling.
	}\label{fig:subdivision}
\end{figure}	





\begin{figure}[!h]
	\centering
		\includegraphics[trim=5cm 0cm 8cm 0cm, width=0.3\columnwidth,clip]{original_screen_shot.jpg}
		\hfill
%	\label{fig:original}
		\includegraphics[trim=5cm 0cm 8cm 0cm, width=0.3\columnwidth,clip]{dual_screen_shot.jpg}
		\hfill
%	\label{fig:dual}
		\includegraphics[trim=5cm 0cm 8cm 0cm, width=0.3\columnwidth,clip]{tets_screen_shot.jpg}
%	\label{fig:tets}
	\caption{The conversion process taking two adjacent 3D hexes into a tetrahedral simplicial complex with an equivalent filtration is shown.}
\label{fig:3d_subdivision}
\end{figure}



























