\newcommand{\pluseq}{\mathrel{{+}{=}}}

{    \SetKwComment{Comment}{}{}
\SetInd{4mm}{0.5mm}

\begin{algorithm}[t]
    \KwIn{$N_{\mathrm{epochs}}$, $f_{\mathrm{loc}}$}
    
    \KwData{$(u_i,y_i)_{i=1}^N$}
    
    \KwOut{$f_{\mathrm{loc}}(\cdot)$, trained for joint alignment}
    %Initialize $f_{loc}$, ($f_{classifier}$ if MT)
    %$\mu \gets  \bzero_{H\times W\times C}$
    % \For{$i\in \set{1,\ldots,N_\mathrm{epochs}}$}    {
    
    %\textbf{for} each epoch \textbf{do}

    \For{each epoch and  each batch $j\in \set{1,\ldots,N_\mathrm{batches}}$}  { 
        $\Lcal_{\mathrm{batch}} \gets 0$

        $(u_i, y_i)_{i=1}^{N_j} \gets \text{batch}_{j}$

       $(\btheta_i)_{i=1}^{N_j} \gets (f_{\mathrm{loc}}(u_i))_{i=1}^{N_j}$

        % $\bV_{j} \gets ( u_j\circ {T^{\btheta_j}})$ \Comment{ // transform batch}
        %\textbf{for} $k\in \set{1,\ldots,K}$ \textbf{do}
        \For{$k\in \set{1,\ldots,K}$}{
       % \Comment{ // Forward alignment}
        $ \mu_k=\frac{1}{N_k}\sum_{i:y_i=k}(u_i\circ T^{\btheta_i})$ 
        
      %  \Comment{ // Backwards alignment}
        $\Lcal_{\mathrm{ICAE}}=
        \frac{1}{N_K}\sum_{i:y_i=k}\| \mu_k\circ T^{-\btheta_i}-u_i\|_{\ell _2}^{2}$
        
        $\Lcal_{\mathrm{batch}} \pluseq \Lcal_{\mathrm{ICAE}}$
        }
        % \If{triplet}{
        %     $ u_j^{emb}=f_{emb}( u_j)$  \Comment{ // embedding}

        %     $\tilde{y}_j = f_{classifier}( u_j^{emb})$

        %     $\Lcal_\mathrm{batch} \pluseq \lambda_{ce}\cdot F_{ce}(\tilde{y}_j, y_{j})$ \Comment{// eq. \ref{eqn:ce}}
        % }
        


    Perform an optimization step to minimize $\Lcal_\mathrm{batch}$
    }

    % }
    \caption{The JA training  with an ICAE loss}   \label{Alg:training}
\end{algorithm}
}