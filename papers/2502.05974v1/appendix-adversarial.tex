\section{Omitted Proofs in \pref{sec: model-free adversarial}}
% We state the detailed regret bound here with the order of every variable.
\label{app:model-free full proof}


\subsection{Specific instances that satisfies \pref{def:adv bilinear}}
In this section, we provide examples that satisfy \pref{def:adv bilinear}. Let $d_{P,h}^\pi$ be the occupancy measure induced by policy $\pi$, transition $P$ at step $h$.
Analog to Bellman residual decomposition, for any $\pi$ and $f \in \calF^{\pi}$, we have
\begin{align*}
    &f(\pi; R) - V_{P, R}(\pi) 
    \\&= \sum_{h=1}^H\left(\E_{(s_h,a_h) \sim d_{P, h}^\pi}\left[f(s_h, a_h; R)\right] - \E_{(s_{h+1},a_{h+1}) \sim d_{P, h}^\pi}\left[f(s_{h+1}, a_{h+1}; R)\right]\right) - \sum_{h=1}^H \E_{(s_h,a_h) \sim d_{P,h}^\pi}\left[R(s_h,a_h)\right]
    \\&= \sum_{h=1}^H \E^{\pi, P}\left[f(s_h, a_h; R) - R(s_h, a_h) - \E_{a_{h+1} \sim \pi(\cdot|s_{h+1})}\left[f(s_{h+1}, a_{h+1}; R)\right]\right]
\end{align*}
\paragraph{Low-rank MDPs} For low-rank MDPs, there exists feature $\varphi$ and $\psi$ such that the transition $P(s'|s,a) = \varphi(s,a)^\top \psi(s')$. We have 
\begin{align*}
    d_{P, h}^\pi(s) &= \sum_{s',a'} d_{P, h-1}^{\pi}(s',a') P(s|s', a')
    \\&= \sum_{s',a'} d_{P, h-1}^{\pi}(s',a') P(s|s', a')
    \\&= \sum_{s',a'} d_{P, h-1}^{\pi}(s',a') \left\langle \varphi(s',a'), \psi_h(s)\right\rangle
    \\&= \left\langle \underbrace{\sum_{s',a'} d_{P, h-1}^{\pi}(s',a')\varphi(s',a')}_{\varphi_h(\pi)}, \psi_h(s)\right\rangle
 \end{align*}
 Thus, 
 \begin{align*}
     &\E^{\pi, P}\left[f(s_h, a_h; R) - R(s_h, a_h) - \E_{a_{h+1} \sim \pi(\cdot|s_{h+1})}\left[f(s_{h+1}, a_{h+1}; R)\right]\right]
     \\&= \sum_{s_h,a_h} d_{P, h}^\pi(s_h)\pi(a_h|s_h)\left(f(s_h, a_h; R) - R(s_h, a_h) - \E_{s_{h+1} \sim P(\cdot|s_h, a_h)}\E_{a_{h+1} \sim \pi(\cdot|s_{h+1})}\left[f(s_{h+1}, a_{h+1}; R)\right]\right)
     \\&= \scalebox{0.95}{$\displaystyle\left\langle \underbrace{\varphi_h(\pi)}_{X_h(\pi, P)}, 
     \underbrace{\sum_{s_h, a_h} \psi_h(s_h)\pi(a_h|s_h)\left(f(s_h, a_h; R) - R(s_h, a_h) - \E_{s_{h+1} \sim P(\cdot|s_h, a_h)}\E_{a_{h+1} \sim \pi(\cdot|s_{h+1})}\left[f(s_{h+1}, a_{h+1}; R)\right]\right)}_{W_h(f, R; P)}\right\rangle $}
 \end{align*}
%$X$ and $W$ are defined as the concatenation of $X_h, W_h, \forall h \in [H]$. 
For any $\pi' \in \Pi$ and $f' \in \calF^{\pi'}$, any $o_h = (s_h, a_h, s_{h+1})$, define $$\ellest_h(f', o_h, R) = |\calA| \pi'(a_h|s_h)\left(f'(s_h, a_h; R) - R(s_h, a_h) - \E_{a_{h+1} \sim \pi'(\cdot|s_{h+1})}\left[f'(s_{h+1}, a_{h+1}; R)\right]\right).$$
Let $\pi_{\unif}$ be the uniform policy over $\calA$, and $\esttt(\pi) = \pi_{\unif}$ for every $\pi$, we have
\begin{align*}
    &\left\langle X_h(\pi; P), W_h(f', R, P)\right\rangle
    \\&= \sum_{s_h,a_h} d_{P, h}^\pi(s_h)\pi'(a_h|s_h)\left(f'(s_h, a_h; R) - R(s_h, a_h) - \E_{s_{h+1} \sim P(\cdot|s_h, a_h)}\E_{a_{h+1} \sim \pi'(\cdot|s_{h+1})}\left[f'(s_{h+1}, a_{h+1}; R)\right]\right)
    \\&= \E^{\pi\, \circ_h\, \pi_{\unif},\, P}\left[\ellest_h(f', o_h, R)\right]
     \\&= \E^{\pi\, \circ_h\, \esttt(\pi),\, P}\left[\ellest_h(f', o_h, R)\right].
\end{align*}
\paragraph{Low-occupancy MDPs} For low-occupancy MDPs, there exists features $\varphi$ and $\psi$ such that the state-action occupancy $d^\pi_{P,h}(s,a) = \varphi_h(\pi)^\top \psi_h(s, a)$. We have 
 \begin{align*}
     &\E^{\pi, P}\left[f(s_h, a_h; R) - R(s_h, a_h) - \E_{a_{h+1} \sim \pi(\cdot|s_{h+1})}\left[f(s_{h+1}, a_{h+1}; R)\right]\right]
     \\&= \sum_{s_h,a_h} d_{P, h}^\pi(s_h,a_h)\left(f(s_h, a_h; R) - R(s_h, a_h) - \E_{s_{h+1} \sim P(\cdot|s_h, a_h)}\E_{a_{h+1} \sim \pi(\cdot|s_{h+1})}\left[f(s_{h+1}, a_{h+1}; R)\right]\right)
     \\&= \scalebox{0.96}{$\displaystyle\left\langle \underbrace{\varphi_h(\pi)}_{X_h(\pi, P)}, 
     \underbrace{\sum_{s_h, a_h} \psi_h(s_h, a_h)\left(f(s_h, a_h; R) - R(s_h, a_h) - \E_{s_{h+1} \sim P(\cdot|s_h, a_h)}\E_{a_{h+1} \sim \pi(\cdot|s_{h+1})}\left[f(s_{h+1}, a_{h+1}; R)\right]\right)}_{W_h(f, R; P)}\right\rangle $}
 \end{align*}
%$X$ and $W$ are defined as the concatenation of $X_h, W_h, \forall h \in [H]$. 
For any $\pi' \in \Pi$ and $f' \in \calF^{\pi'}$, any $o_h = (s_h, a_h, s_{h+1})$, define $$\ellest_h(f', o_h, R) = \left(f'(s_h, a_h; R) - R(s_h, a_h) - \E_{a_{h+1} \sim \pi'(\cdot|s_{h+1})}\left[f'(s_{h+1}, a_{h+1}; R)\right]\right).$$
We have
\begin{align*}
    &\left\langle X_h(\pi; P), W_h(f', R, P)\right\rangle
    \\&= \sum_{s_h,a_h} d_{P, h}^\pi(s_h, a_h)\left(f'(s_h, a_h; R) - R(s_h, a_h) - \E_{s_{h+1} \sim P(\cdot|s_h, a_h)}\E_{a_{h+1} \sim \pi'(\cdot|s_{h+1})}\left[f'(s_{h+1}, a_{h+1}; R)\right]\right)
    \\&= \E^{\pi,\, P}\left[\ellest_h(f', o_h, R)\right].
\end{align*}
In this instance, $\esttt(\pi) = \pi$ for every $\pi$.





\subsection{Proof of \pref{thm:mf-f}}\label{app: odec}
In this section, we give a proof to \pref{thm:mf-f}, which is similar to \cite{foster2024model} with adaptation to more general partition. To start, we first define an extension to model-free optimistic DEC with bilinear divergence introduced in \cite{foster2024model}.  Given the definition of $f^\phi, \pi^\phi, \pi^\phi_{est}, \Phi$ and $D_{bi}^\pi$ discussed in \pref{sec: model-free adversarial}. We define
\begin{align*}
    \odec_{\eta}^{bi}(\calM, \Phi) = \max_{\rho \in \Delta(\Phi)}\min_{p \in \Delta(\Pi)}\max_{(P,R) \in \calM}\E_{\pi \sim p}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^\phi, R) - V_{P,R}(\pi)  - \frac{1}{\eta} D_{bi}^{\pi}(\phi||P, R)\right].
\end{align*}
This complexity have the following bounds.  
\begin{lemma}
If $\pi^{\phi}_{est} = \pi^{\phi}$ for all $\phi$, we have
\begin{align*}
     \odec_{\eta}^{bi}(\calM, \Phi) \le \frac{\eta dH}{4}. 
\end{align*}
If $\pi^{\phi}_{est} \neq \pi^{\phi}$ for some $\phi$,  we have
\begin{align*}
     \odec_{\eta}^{bi}(\calM, \Phi) \le H\sqrt{\frac{\eta d}{2}}. 
\end{align*}
\label{lem:odec-bound}
\end{lemma}

\begin{proof}
For any $\rho \in \Delta(\Phi)$, we will bound
\begin{align*}
    &\min_{p \in \Delta(\Pi)}\max_{(P,R) \in \calM}\E_{\pi' \sim p}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P, R)}(\pi')  - \frac{1}{\eta} D_{bi}^{\pi'}(\phi||P, R)\right] 
    \\&= \min_{p \in \Delta(\Pi)}\max_{\nu \in \Delta(\calM)}\E_{(P, R) \sim \nu}\E_{\pi' \sim p}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P, R)}(\pi') - \frac{1}{\eta} D_{bi}^{\pi'}(\phi||P, R)\right]
    \\&= \max_{\nu \in \Delta(\calM)}\min_{p \in \Delta(\Pi)}\E_{(P, R) \sim \nu}\E_{\pi' \sim p}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P, R)}(\pi') - \frac{1}{\eta} D_{bi}^{\pi'}(\phi||P, R)\right] \tag{\pref{lem:minmax}}
\end{align*}
For any $\nu \in \Delta(\calM)$, we choose $p$ such that $\pi' \sim p$ is equivalent to sampling $\phi' \sim \rho$ and play $\pi^{\phi'}_{\alpha}$ where $\pi^{\phi'}_{\alpha}$ is the randomized policy such that for every step $h$, play $\pi^{\phi'}$ with probability $1-\alpha/H$ and play $\pi_{est}^{\phi'}$ with probability $\alpha/H$. The policy choice for any step $h$ is independent. Thus, with probability $(1-\frac{\alpha}{H})^H \ge 1-\alpha$, $\pi^{\phi'}$ is played for every $H$. Using such $p$, since $V_M(\pi) \in [0,1]$ for any $M,\pi$, we only need to bound
% \begin{align}
% &\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi')  - \frac{\eta}{4} D_{bi}^{\pi'}(\phi||P, R)\right] \nonumber
% \\&= \E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}_{\alpha})  - \frac{\eta}{4} D_{bi}^{\pi^{\phi'}}(\phi||P, R)\right]
% \\&\le 2\alpha H + \E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'})  - \frac{\eta}{4} D_{bi}^{\pi^{\phi'}}(\phi||P, R)\right]
% \label{eq:model-free full}
% \end{align}
\begin{align}
&\E_{\pi' \sim p}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi')\right] \nonumber
\\&= \E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}_{\alpha})\right] \nonumber
\\&\le \alpha  + \E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}) \right]. 
\label{eq:model-free full}
\end{align}
For any $P, R$, we have
\begin{align*}
&\E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}) \right]
\\&= \E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi}) \right]
    \\&\leq \sum_{h=1}^H  \E_{\phi \sim \rho}\left[\left|\langle X_h(\phi; P), W_h(\phi, R; P)\rangle\right|\right]. \tag{Bilinear property \pref{def:adv bilinear}}
\end{align*}
Define $\Sigma_h = \E_{\phi \sim \rho}\left[X_h(\phi; P)X_h(\phi; P)^\top\right]$ and let $\Sigma_h^{\dagger}$ be its pseudo-inverse, we have
\begin{align*}
    &\E_{\phi \sim \rho} \left[
\left|\langle X_h(\phi; P), W_h(\phi, R; P)\rangle\right|
\right] 
\\&= \E_{\phi \sim \rho}\left[
\left|\left\langle \left(\Sigma_h^\dagger\right)^{\frac{1}{2}}X_h(\phi; P), \Sigma_h^{\frac{1}{2}}W_h(\phi, R; P)\right\rangle\right|
\right]
\\&\le \sqrt{\E_{\phi \sim \rho}\left[\left\|\left(\Sigma_h^\dagger\right)^{\frac{1}{2}}X_h(\phi; P)\right\|_2^2\right]} \sqrt{\E_{\phi \sim \rho}\left[\left\|\Sigma_h^{\frac{1}{2}}W_h(\phi, R; P)\right\|_2^2\right]}
\end{align*}
We have
\begin{align*}
&\E_{\phi \sim \rho} \left[\left\|\Sigma_h^{\frac{1}{2}}W_h(\phi, R; P)\right\|_2^2\right] 
\\&= \E_{\phi \sim \rho}\left[\left\langle \Sigma W_h(\phi, R; P), W_h(\phi, R; P) \right\rangle\right]
\\&= \E_{\phi \sim \rho} \left[\left\langle \E_{\phi' \sim \rho}\left[X_h(\phi'; P)X_h(\phi'; P)^\top\right] W_h(\phi, R; P), W_h(\phi, R; P) \right\rangle\right]
\\&= \E_{\phi \sim \rho}\E_{\phi' \sim \rho} \left[\left\langle X_h(\phi'; P) , W_h(\phi, R; P)\right\rangle^2\right]
\end{align*}
Moreover, 
\begin{align*}
    \E_{\phi \sim \rho}\left[\left\|\left(\Sigma_h^\dagger\right)^{\frac{1}{2}}X_h(\phi; P)\right\|_2^2\right] \le d
\end{align*}
Thus, by Cauchy-Schwarz inequality, for any $P, R$, we have
\begin{align}
    &\E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}) \right] \nonumber
    \\&\le \sqrt{ dH\sum_{h=1}^H \E_{\phi \sim \rho}\E_{\phi' \sim \rho} \left[\left\langle X_h(\phi';P) , W_h(\phi, R; P)\right\rangle^2\right]} \nonumber
    \\&= \sqrt{dH \sum_{h=1}^H \E_{\phi \sim \rho}\E_{\phi' \sim \rho}\left[\left( \E^{\pi^{\phi'}\,\circ_h \, \pi^{\phi'}_{est} , \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right]} 
    %&= \sqrt{dH \sum_{h=1}^H \E_{\phi \sim \rho}\E_{\pi'\sim p}\left[\left( \E^{\pi'\circ_h \, \esttt(\pi') , \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right]} 
    \label{eq:bilinear est}
\end{align}
\textbf{(1)} If $\pi^\phi_{est} = \pi^\phi$ for all $\phi$, we can set $\alpha = 0$ and combine \pref{eq:bilinear est} and \pref{eq:model-free full} to conclude that for any $P,R$
\begin{align*}
    &\E_{\pi' \sim p}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi') - \frac{1}{\eta} D_{bi}^{\pi'}(\phi||P, R)\right] \\
    &\leq \sqrt{dH \sum_{h=1}^H \E_{\phi \sim \rho}\E_{\phi' \sim \rho}\left[\left( \E^{\pi^{\phi'}\,\circ_h \, \pi^{\phi'}_{est} , \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right]}  - \frac{1}{\eta} \E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[D_{bi}^{\pi^{\phi'}}(\phi||P, R)\right] \\
    &\leq \sqrt{dH \E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[D_{bi}^{\pi^{\phi'}}(\phi||P, R)\right]}  - \frac{1}{\eta} \E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[D_{bi}^{\pi^{\phi'}}(\phi||P, R)\right] \\
    &\leq \frac{\eta dH}{4}. 
\end{align*}
\textbf{(2)} If $\pi^\phi_{est} \neq \pi^\phi$ for some $\phi$, we need additional analysis. For any $h$,  $\pi_{\alpha}^{\phi'}$ select $\pi^{\phi'}$ with probability $1-\frac{\alpha}{H}$ and  select $\pi_{est}^{\phi'}$ with probability $\frac{\alpha}{H}$ independently. We define the event $\mathcal{E}_h$ as choosing $\pi^{\phi'}$ before step $h-1$ and choosing $\pi^{\phi'}_{est}$ at step $h$. We have $\mathbb{P}\left(\mathcal{E}_h\right) = \left(1-\frac{\alpha}{H}\right)^{h-1}\frac{\alpha}{H} \ge  \left(1-\frac{\alpha}{H}\right)^{H-1}\frac{\alpha}{H}$ from the independence. We have for any $h\in[H]$, 
\begin{align*}
    %\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[D_{bi}^{\pi'}(\phi||P, R)\right] &= 
    &\E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[\left(\E^{\pi_{\alpha}^{\phi'}, \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right]
    \\& \ge \mathbb{P}\left(\mathcal{E}_h\right)\cdot \E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[\left(\E^{\pi^{\phi'}\,\circ_h \pi_{est}^{\phi'}, \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right] 
    \\&\ge \left(1-\frac{\alpha}{H}\right)^{H-1}\frac{\alpha}{H}\E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[\left(\E^{\pi^{\phi'}\,\circ_h \pi_{est}^{\phi'}, \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right]
    \\&\ge \frac{\alpha}{2H}\E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[\left( \E^{\pi^{\phi'}\,\circ_h \pi_{est}^{\phi'}, \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right] \tag{$\alpha \le \frac{1}{2}$}. 
\end{align*}
Therefore, 
\begin{align*}
    \E_{\pi' \sim p}\E_{\phi \sim \rho}\left[D_{bi}^{\pi'}(\phi||P, R)\right] 
    &= \E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[\sum_{h=1}^H \left(\E^{\pi_{\alpha}^{\phi'}, \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right] \\
    &\geq \frac{\alpha}{2H}\E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[\sum_{h=1}^H \left( \E^{\pi^{\phi'}\,\circ_h \pi_{est}^{\phi'}, \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right]. 
\end{align*}

Combining this equation with \pref{eq:bilinear est} and \pref{eq:model-free full}, we have
\begin{align*}
    &\E_{\pi' \sim p}\E_{\phi \sim \rho}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi')- \eta D_{bi}^{\pi'}(\phi||P, R)\right] \\
    &\le \alpha + \sqrt{dH \sum_{h=1}^H \E_{\phi \sim \rho}\E_{\phi' \sim \rho}\left[\left( \E^{\pi^{\phi'}\,\circ_h \, \pi^{\phi'}_{est} , \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right]} \\
    &\qquad \qquad - \frac{1}{\eta} \cdot \frac{\alpha}{2H}\E_{\phi' \sim \rho}\E_{\phi \sim \rho}\left[\sum_{h=1}^H \left( \E^{\pi^{\phi'}\,\circ_h \pi_{est}^{\phi'}, \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right].
    \\&\leq  \alpha + \frac{\eta dH^2}{2 \alpha}
\end{align*}
Thus, by setting $\alpha = H\sqrt{\eta d}$, we have
\begin{align*}
     \E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi') - \frac{1}{\eta} D_{bi}^{\pi'}(\phi||P, R)\right] \le H\sqrt{\frac{\eta d}{2}}. 
\end{align*}
\end{proof}
We restate \pref{thm:mf-f} here with more detailed dependencies with the language of partition defined in \pref{sec: model-free adversarial}. 

\noindent \textbf{Theorem 10} \ \ Assume $|\ellest_h(\cdot, \cdot, \cdot)| \le L$.    For bilinear class defined in \pref{def:adv bilinear}, \pref{alg:MAF} ensures with probability $1-\delta$: 
\begin{itemize}
    \item If $\pi^\phi_{\text{est}} = \pi^\phi$ for any $\phi$, then $ \Reg \le \order\left( HL\sqrt{d \log\left(T|\Phi|/\delta\right)} T^{\frac{3}{4}}\right)$.
    \item If $\pi^\phi_{\text{est}} \neq \pi^\phi$ for some $\phi$, then $\Reg \le \order\left(HL^{\frac{2}{3}}d^{\frac{1}{3}}\log\left(T|\Phi|/\delta\right)^{\frac{1}{3}}T^{\frac{5}{6}}\right)$.
\end{itemize}




\begin{proof}
We first analyze the regret of optimistic exponential weights, the proof is almost the same as \cite{foster2024model}. %Since the transition is fixed as $P^\star$, we have $\left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest(\phi, o_k^i, R_k)\right)^2 = \widehat{D}_{bi}^{\pi'}(\phi||P^\star, R_k)$. \cw{defined where? } 
Choosing comparator as $\phi^\star = \phi_{f^\star, \pi^\star}$ where $f^\star = Q_{P^\star}^{\pi^\star}$. The reward function used in exponential weights is
\begin{align*}
    g_k(\phi) = \eta f^{\phi}(\pi^{\phi}; R_k) - \sum_{h=1}^H  \left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi, o_{k,h}^i, R_k)\right)^2.
\end{align*}
 Since $f(\pi, R) \leq [0,1]$ for any $f, \pi, R$, and $|\ellest_h(\cdot, \cdot, \cdot)| \le L$, we have $|g_k(\phi)| \le \eta  + HL^2$.  From \pref{lem:EXP}, if  $\gamma \le \frac{1}{4\eta  + 4HL^2}$ we have
\begin{align}
    &\sum_{k=1}^K \E_{\phi \sim \rho_k}\Bigg[\eta f^{\phi^\star}(\pi^{\phi^\star}; R_k) - \eta f^{\phi}(\pi^{\phi}; R_k) \nonumber
    \\& \quad + \sum_{h=1}^H \left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi, o_{k,h}^i, R_k)\right)^2-  \sum_{h=1}^H \left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi^\star, o_{k,h}^i, R_k)\right)^2\Bigg]  \nonumber
    \\&\le \frac{\log(|\Phi|)}{\gamma} + \gamma \sum_{k=1}^K \E_{\phi \sim \rho_k}\left[g_k(\phi)^2\right] \nonumber
    % \\&\le \frac{\log(|\Phi|)}{\gamma} + 2\gamma H \sum_{k=1}^K \sum_{h=1}^H \E_{\phi \sim \rho_k}\left[\left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi, o_{k,h}^i, R_k)\right)^2\right] + \frac{2\gamma K}{\eta^2}
    % \nonumber
    \\&\le \frac{\log(|\Phi|)}{\gamma} + \frac{1}{2} \sum_{k=1}^K \sum_{h=1}^H  \E_{\phi \sim \rho_k}\left[\left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi, o_{k,h}^i, R_k)\right)^2\right] + 2\eta^2 \gamma K.  \tag{$\gamma \le \frac{1}{4HL^2}$} \nonumber
\end{align}
Rearraging the inequality, we have
\begin{align}
&\sum_{k=1}^K \E_{\phi \sim \rho_k}\left[\eta f^{\phi^\star}(\pi^{\phi^\star}; R_k) - \eta f^{\phi}(\pi^{\phi}; R_k) + \frac{1}{2}\sum_{h=1}^H \left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi, o_{k,h}^i, R_k)\right)^2\right] \nonumber
\\&\le  \sum_{k=1}^K \sum_{h=1}^H \left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi^\star, o_{k,h}^i, R_k)\right)^2 +  \frac{\log(|\Phi|)}{\gamma} + 2\eta^2 \gamma K 
\label{eq:opt-exp-start}
\end{align}
By Hoeffding's inequality and union bound, with probability at least $1-\delta$, for any $k\in[K]$, $h\in[H]$, and any $\phi \in \Phi$, we have
\begin{align*}
    \left|\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi, o_{k,h}^i, R_k) -  \E^{ \pi_k,\, P^\star}\left[\ellest_h(\phi, o_h, R_k)\right]\right| \le L\sqrt{\frac{2\log\left(KH|\Phi|/\delta\right)}{\tau}} = \epsilon_{conc}. 
\end{align*}
Thus, given $D_{bi}^{\pi'}(\phi||P, R) = \sum_{h=1}^H  \left(\E^{\pi', P}\left[\ellest_h(\phi, o_h, R)\right]\right)^2$, we have 
\begin{align}
     \sum_{h=1}^H  \left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest_h(\phi, o_{k,h}^i, R_k)\right)^2 \le 2 D_{bi}^{\pi_k}(\phi||P^\star, R_k) + 2H\epsilon_{conc}^2.
     \label{eq:conc1}
\end{align}

\begin{align}
     \sum_{h=1}^H \left(\frac{1}{\tau} \sum_{i \in [\tau]}\ellest(\phi, o_{k,h}^i, R_k)\right)^2 \ge \frac{1}{2}D_{bi}^{\pi_k}(\phi||P^\star, R_k) -H\epsilon_{conc}^2. 
     \label{eq:conc2}
\end{align}
From Lemma A.3 in \cite{foster2021statistical}, with probability at least $1-\delta$, for any $\phi \in \Phi$, we have
\begin{align*}
   \frac{1}{2}\sum_{k=1}^K \E_{\pi \sim p_k}\left[D_{bi}^{\pi}(\phi||P^\star, R_k)\right] \le   \sum_{k=1}^K D_{bi}^{\pi_k}(\phi||P^\star, R_k) + 4HL^2\log(|\Phi|/\delta). 
\end{align*}
Combining \pref{eq:opt-exp-start}, \pref{eq:conc1} and \pref{eq:conc2}, and the fact that $D_{bi}^{\pi}(\phi^\star||P^\star, R) = 0$ for any $\pi$ and $R$, we have
\begin{align*}
     &\sum_{k=1}^K \E_{\phi \sim \rho_k}\left[\eta f^{\phi^\star}(\pi^{\phi^\star}; R_k) - \eta f^{\phi}(\pi^{\phi}; R_k) + \frac{1}{8} \E_{\pi \sim p_k}\left[D_{bi}^{\pi}(\phi||P^\star, R_k)\right]\right]  
    % \\&\le \frac{\log(|\Phi|)}{\gamma} + \gamma \left(HL^2 + \frac{H}{\eta}\right)^2 K + 3K\epsilon_{conc}^2 + \frac{1}{2}L^2\sqrt{2K\log(|\Phi|/\delta|)}
    \\&\le \frac{\log(|\Phi|)}{\gamma} + \frac{2\gamma K}{\eta^2}  + \frac{6L^2KH\log\left(KH|\Phi|/\delta\right)}{\tau} +  4HL^2\log(|\Phi|/\delta)
\end{align*}
Choose $\gamma = \min\{\eta \sqrt{\frac{\log(|\Phi|)}{K}}, \frac{1}{4\eta + 4HL^2}\}$, we have 
\begin{align}
    &\sum_{k=1}^K \E_{\phi \sim \rho_k}\left[ f^{\phi^\star}(\pi^{\phi^\star}; R_k) - f^{\phi}(\pi^{\phi}; R_k) + \frac{1}{8\eta} \E_{\pi \sim p_k}\left[D_{bi}^{\pi}(\phi||P^\star, R_k)\right]\right]  \nonumber
    \\& \le \order\left(\sqrt{K\log(|\Phi|)} + HL^2\log(|\Phi|) +
 \frac{ L^2KH\log\left(KH|\Phi|/\delta\right)}{\eta\tau} +  \frac{1}{\eta} HL^2\log(|\Phi|/\delta)\right). %\nonumber
% \\& \le \order\left(\sqrt{K\log(|\Phi|)} + \eta L^2 \log(|\Phi|) + \frac{\eta KL^2\log\left(K|\Phi|/\delta\right)}{\tau} +  \eta L^2\log(|\Phi|/\delta)\right)
 \label{eq:term1-bound}
\end{align}
% Let $\ell_k = \frac{1}{\tau}\sum_{i \in [\tau]}\ell_k^i$ be the average loss in the $k$-th epoch. Recall that 
% for any $f \in \mathcal{Q}$, define $V_f^\pi = \E_{a \sim \pi(\cdot|s)}\left[f(s,a)\right]$. Define $f^\pi_{\star} = Q^\pi_{P^\star} \in \mathcal{Q}$. For simplicity, let $f^\star = Q^{\pi^\star}_{P^\star} $. Thus, $V^\pi_{P^\star}(s, \ell_k) = \E_{a \sim \pi(\cdot|s)}\left[Q^\pi_{P^\star}(s,a)\right] = V^\pi_{f^\pi_\star}(s, \ell_k)$ 
Since  $f^{\phi^\star} = Q_{P^\star}^{\pi^\star}$ and $\pi^{\phi^\star} = \pi^\star$, we have $V_{(P^\star, R)}(\pi^\star) = f^{\phi^\star}(\pi^{\phi^\star}; R)$ for any $(P,R,\pi^\star) \in \phi^\star$. Regret can be decomposed to
\begin{align}
&\frac{1}{\tau}\Reg \nonumber
\\&=\sum_{k=1}^K V_{(P^\star, R_k)}(\pi^\star)  - \sum_{k=1}^K \E_{\pi \sim p_k}\left[V_{(P^\star, R_k)}(\pi)\right] \nonumber
\\&= \sum_{k=1}^K f^{\phi^\star}(\pi^{\phi^\star}, R_k)  - \sum_{k=1}^K \E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R_k)\right]
 + \sum_{k=1}^K \E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R_k)\right]  -  \sum_{k=1}^K \E_{\pi \sim p_k}\left[V_{(P^\star, R_k)}(\pi)\right] \nonumber
 \\&= \underbrace{\sum_{k=1}^K \E_{\phi \sim \rho_k}\left[ f^{\phi^\star}(\pi^{\phi^\star}; R_k) - f^{\phi}(\pi^{\phi}; R_k)  + \frac{1}{8\eta} \E_{\pi' \sim p_k}\left[D_{bi}^{\pi'}(\phi||P^\star, R_k)\right]\right]}_{\textbf{term1}} \nonumber
\\&\qquad + \underbrace{\sum_{k=1}^K \E_{\pi' \sim p_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R_k) - V_{(P^\star, R_k)}(\pi') - \frac{1}{8\eta} D_{bi}^{\pi'}(\phi||P^\star, R_k)\right]}_{\textbf{term2}} \label{eq:reg-dec}
\end{align}


\textbf{term1} is bounded through \pref{eq:term1-bound}. For \textbf{term2}, we have
\begin{align*}
\textbf{term2} &\le \sum_{k=1}^K \max_{(P,R) \in \calM}\E_{\pi' \sim p_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi') - \frac{1}{8\eta} D_{bi}^{\pi'}(\phi||P, R)\right]
    \\&= \sum_{k=1}^K \underbrace{\min_{p \in \Delta(\Pi)}\max_{(P,R) \in \calM}\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi')  - \frac{1}{8\eta} D_{bi}^{\pi'}(f, \pi||P, R)\right]}_{\le \odec^{bi}_{8\eta}(\calM, \Phi)}
\end{align*}
From \pref{lem:odec-bound}, we have
% We now bound this complexity in our setting
% \begin{align*}
%     &\min_{p \in \Delta(\Pi)}\max_{(P,R) \in \calM}\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P, R)}(\pi')  - \frac{\eta}{4} D_{bi}^{\pi'}(\phi||P, R)\right] 
%     \\&= \min_{p \in \Delta(\Pi)}\max_{\nu \in \Delta(\calM)}\E_{(P, R) \sim \nu}\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P, R)}(\pi') - \frac{\eta}{4} D_{bi}^{\pi'}(\phi||P, R)\right]
%     \\&= \max_{\nu \in \Delta(\calM)}\min_{p \in \Delta(\Pi)}\E_{(P, R) \sim \nu}\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P, R)}(\pi') - \frac{\eta}{4} D_{bi}^{\pi'}(\phi||P, R)\right] \tag{\pref{lem:minmax}}
% \end{align*}
% For any $\nu \in \Delta(\calM)$, we choose $p$ such that $\pi' \sim p$ is equivalent to sampling $\phi' \sim \rho_k$ and play $\pi^{\phi'}_{\alpha}$ where $\pi^{\phi'}_{\alpha}$ is the randomized policy such that for every step $h$, play $\pi^{\phi'}$ with probability $1-\alpha/H$ and play $\pi_{est}^{\phi'}$ with probability $\alpha/H$. Thus, with probability $(1-\frac{\alpha}{H})^H \ge 1-\alpha$, $\pi^{\phi'}$ is played for every $H$. Using such $p$, we only need to bound
% % \begin{align}
% % &\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi')  - \frac{\eta}{4} D_{bi}^{\pi'}(\phi||P, R)\right] \nonumber
% % \\&= \E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}_{\alpha})  - \frac{\eta}{4} D_{bi}^{\pi^{\phi'}}(\phi||P, R)\right]
% % \\&\le 2\alpha H + \E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'})  - \frac{\eta}{4} D_{bi}^{\pi^{\phi'}}(\phi||P, R)\right]
% % \label{eq:model-free full}
% % \end{align}

% \begin{align}
% &\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi')\right] \nonumber
% \\&= \E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}_{\alpha})\right] \nonumber
% \\&\le 2\alpha H + \E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}) \right]
% \label{eq:model-free full}
% \end{align}
% For any $P, R$, we have
% \begin{align*}
% &\E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}) \right]
% \\&= \E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi}) \right]
%     \\&= \E_{\phi \sim \rho_k}\left[\left|\langle X(\phi; P), W(\phi, R; P)\rangle\right|\right] \tag{Bilinear definition}
% \end{align*}
% Define $\Sigma = \E_{\phi \sim \rho_k}\left[X(\phi; P)X(\phi; P)^\top\right]$ and let $\Sigma^{\dagger}$ be its pseudo-inverse, we have
% \begin{align*}
%     &\E_{\phi \sim \rho_k} \left[
% \left|\langle X(\phi; P), W(\phi, R; P)\rangle\right|
% \right] 
% \\&= \E_{\phi \sim \rho_k}\left[
% \left|\left\langle \left(\Sigma^\dagger\right)^{\frac{1}{2}}X(\phi; P), \Sigma^{\frac{1}{2}}W(\phi, R; P)\right\rangle\right|
% \right]
% \\&\le \sqrt{\E_{\phi \sim \rho_k}\left[\left\|\left(\Sigma^\dagger\right)^{\frac{1}{2}}X(\phi; P)\right\|_2^2\right]} \sqrt{\E_{\phi \sim \rho_k}\left[\left\|\Sigma^{\frac{1}{2}}W(\phi, R; P)\right\|_2^2\right]}
% \end{align*}
% We have
% \begin{align*}
% &\E_{\phi \sim \rho_k} \left[\left\|\Sigma^{\frac{1}{2}}W(\phi, R; P)\right\|_2^2\right] 
% \\&= \E_{\phi \sim \rho_k}\left[\left\langle \Sigma W(\phi, R; P), W(\phi, R; P) \right\rangle\right]
% \\&= \E_{\phi \sim \rho_k} \left[\left\langle \E_{\phi' \sim \rho_k}\left[X(\phi'; P)X(\phi'; P)^\top\right] W(\phi, R; P), W(\phi, R; P) \right\rangle\right]
% \\&= \E_{\phi \sim \rho_k}\E_{\phi' \sim \rho_k} \left[\left\langle X(\phi'; P) , W(\phi, R; P)\right\rangle^2\right]
% \end{align*}
% Moreover, 
% \begin{align*}
%     \E_{\phi \sim \rho_k}\left[\left\|\left(\Sigma^\dagger\right)^{\frac{1}{2}}X(\phi; P)\right\|_2^2\right] \le d
% \end{align*}
% Thus, by AM-GM inequality, for any $P, R$, we have
% \begin{align}
%     &\E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}) \right] \nonumber
%     \\&\le \frac{d}{\eta} + \frac{\eta}{4}\E_{\phi \sim \rho_k}\E_{\phi' \sim \rho_k} \left[\left\langle X(\phi';P) , W(\phi, R; P)\right\rangle^2\right] \nonumber
%     \\&= \frac{d}{\eta} + \frac{\eta}{4}\E_{\phi \sim \rho_k}\E_{\phi' \sim \rho_k}\left[\left(\sum_{h=1}^H \E^{\pi^{\phi'}\,\circ_h \, \pi^{\phi'}_{est} , \,P}\left[\ellest_h(\phi, o_h; R)\right]\right)^2\right] \label{eq:bilinear est}
% \end{align}
\textbf{(1)} If $\pi^{\phi}_{est} = \pi^{\phi}$, $\textbf{term2} \le O\big(\eta dH\big)$. Combining with \pref{eq:term1-bound} and regret decomposition \pref{eq:reg-dec}, we have 
\begin{align*}
    \frac{1}{\tau}\Reg \le \order\left(\eta dHK + \sqrt{K\log(|\Phi|)} + \frac{ L^2KH\log\left(KH|\Phi|/\delta\right)}{\eta\tau} +  \frac{1}{\eta} L^2 H\log(|\Phi|/\delta)\right)
\end{align*}
and thus (recall $T=K\tau$)
\begin{align*}
    \Reg \le \order\left(\eta dHT + \sqrt{T\tau\log(|\Phi|)} + \frac{ L^2TH\log\left(TH|\Phi|/\delta\right)}{\eta\tau} +  \frac{\tau}{\eta} L^2 H\log(|\Phi|/\delta)\right).
\end{align*}
Setting $\eta =  Ld^{-\frac{1}{2}} (\log(|\Phi|/\delta))^{\frac{1}{2}} T^{-\frac{1}{4}}$, $\tau = \sqrt{T}$, then $K = \frac{T}{\tau} = \sqrt{T}$, we have
\begin{align*}
    \Reg \le \tilde{\order}\left( HL\sqrt{d \log\left(|\Phi|/\delta\right)} T^{\frac{3}{4}}\right). 
\end{align*}
\textbf{(2)} If $\pi^{\phi'}_{est} \neq \pi^{\phi'}$, $\textbf{term2} \le \order\big(H\sqrt{\eta d}\big)$. 
% Combining this equation with \pref{eq:bilinear est} and \pref{eq:model-free full}, we have
% \begin{align*}
%     \E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi')\right] &\le 2\alpha H + \frac{dH}{4\eta} + \frac{\eta}{4}\cdot \frac{2H}{\alpha} \E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[D_{bi}^{\pi'}(\phi||P, R)\right] 
%     \\&=  2\alpha H + \frac{dH^2}{2\eta \alpha} + \frac{\eta}{4}\E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[D_{bi}^{\pi'}(\phi||P, R)\right] \tag{redefine $\eta \leftarrow \eta \frac{2H}{\alpha}$}
% \end{align*}
% Thus, by setting $\alpha = \sqrt{\frac{d}{\eta}}$, we have
% \begin{align*}
%      \E_{\pi' \sim p}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi') - \frac{\eta}{4} D_{bi}^{\pi'}(\phi||P, R)\right] \le \order\left(H^2\sqrt{\frac{d}{\eta}}\right)
% \end{align*}
Combining with \pref{eq:term1-bound} and regret decomposition \pref{eq:reg-dec}, we have 
\begin{align*}
    \frac{1}{\tau}\Reg \le \order\left(H\sqrt{\eta d}K + \sqrt{K\log(|\Phi|)} +  \frac{ L^2KH\log\left(KH|\Phi|/\delta\right)}{\eta \tau} +  \frac{1}{\eta} L^2H\log(|\Phi|/\delta)\right)
\end{align*}
and thus 
\begin{align*}
   \Reg \le \order\left(H\sqrt{\eta d}T + \sqrt{T\tau\log(|\Phi|)} +  \frac{ L^2TH\log\left(TH|\Phi|/\delta\right)}{\eta \tau} +  \frac{\tau}{\eta} L^2H\log(|\Phi|/\delta)\right).
\end{align*}
Setting $\eta = L^{\frac{4}{3}}d^{-\frac{1}{3}}(\log(|\Phi|/\delta))^{\frac{2}{3}} T^{-\frac{1}{3}}$, $\tau = \sqrt{T}$, then $K = \frac{T}{\tau} = \sqrt{T}$, we have
\begin{align*}
    \Reg \le \order\left(H L^{\frac{2}{3}}\left(d\log\left(|\Phi|/\delta\right)\right)^{\frac{1}{3}}T^{\frac{5}{6}}\right). 
\end{align*}
% Thus, by AM-GM inequality, for any $P, R$, we have
% \begin{align*}
%     &\E_{\phi' \sim \rho_k}\E_{\phi \sim \rho_k}\left[f^{\phi}(\pi^{\phi}; R) - V_{(P,R)}(\pi^{\phi'}) \right]
%     \\&\le \frac{dH}{\eta} + \frac{\eta}{4}\E_{\phi \sim \rho_k}\E_{\phi' \sim \rho_k} \left[\left\langle X(\phi';P) , W(\phi, R; P)\right\rangle^2\right]
%     \\&= \frac{dH}{4\eta} + \frac{\eta}{4}\E_{\phi \sim \rho_k}\E_{\phi' \sim \rho_k}\left[\left(\E^{\pi^{\phi'}, P}\left[\ellest(\phi, o; R)\right]\right)^2\right]
%     \\&= \frac{dH}{4\eta} + \frac{\eta}{4}\E_{\phi \sim \rho_k}\E_{\phi' \sim \rho_k}\left[D_{bi}^{\pi^{\phi'}}(\phi||P, R)\right]
% \end{align*}

\end{proof}
