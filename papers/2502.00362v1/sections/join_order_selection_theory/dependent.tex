\subsection{Cost-function dependent validity}\label{subsubsection:cost_function_dependent}

Considering the cost function generation in the previous subsections, we have generated higher-order terms that encode valid join trees at rank $r = |V| - 2$. Considering the Alg.~\ref{alg:hubo_term_construction}, we can access these terms with $\texttt{HUBO[set of all relations]}$. Let us denote this set of terms as $H$. For example, one of those terms is represented in Fig.~\ref{fig:subgraph_generation}. The first validity constraint forces the model to select exactly one of these terms as true, which requires the final join tree to contain all the relations.

\textbf{Select one valid plan.} We utilize a generalized one-hot (or $k$-hot) encoding from QUBO formulations \cite{lucas_2014, Schonberger_Trummer_Mauerer_2023}. The encoding constructs a constraint that reaches its minimum when precisely $k$ variables are selected to be true from a given set of binary variables. In the generalized formulation, we construct an objective minimized when exactly $k$ terms are selected true from a set of higher-order terms. Let $H$ be the set of higher-order terms at rank $r = |V| - 2$. This functionality generalizes to higher-order cases with the following formulation:
\begin{equation}\label{eq:hubo_combinations}
    H_0 = \left( 1 - \sum_{h \in H} h \right)^2,
\end{equation}
where $h = \prod_{r = 0}^{|V| - 2} x_{i_r, j_r}^{r}$ for some indices $i_r$ and $j_r$ for $r = 0, \ldots, |V| - 2$ that depend on the query graph. The objective $H_0$ is always non-negative since it is squared. It is positive except when exactly one of the terms in the sum $\sum_{h \in H} h$ is $1$ when $H_0$ evaluates to $0$. The sum $\sum_{h \in H} h$ evaluates to $1$ when there is exactly one term $h$ such that all the variables in the product $\prod_{r = 0}^{|V| - 2} x_{i_r, j_r}^{r}$ are true. This combination is the valid join tree that the objective function returns as a solution to the minimization problem. Since these terms $h \in H$ have already been generated for the cost HUBO, we create this constraint based on them. Thus, we call this validity constraint cost-dependent.

\textbf{Every rank must appear exactly once in the solution.}
It is still possible to obtain solutions that include unnecessary true variables that do not affect the minimum of the final HUBO function. For example, consider the plan in Fig.~\ref{fig:subgraph_generation}. The HUBO that encodes this plan would have the same minimum even if we set that $x_{0,2}^{1} = 1$ because this variable would always be multiplied with variables set to $0$, and thus, activating a single variable would not affect the total cost. While we can solve this problem with classical post-processing, we still decided to fix it in the model itself. We include a constraint that every rank should appear exactly once in the solution. This is also an instance of one-hot encoding \cite{dimod_generators_combinations} and encoded with the following quadratic objective:
\begin{equation}\label{eq:every_rank_has_one_join}
    H_1 = \sum_{r = 0}^{|V| - 2}\left( 1 - \sum_{(R_i, R_j) \in E} x_{i,j}^{r} \right)^2.
\end{equation}
The objective $H_1$ is minimized when exactly one variable of type $x_{i,j}^{r}$ is selected to be true for each $0 \leq r <|V|- 1$.