\section*{Summary of Appendix}

\begin{itemize}
\item \S\ref{sec:theory} presents a formal proof supporting our mathematical formulation.
\item \S\ref{sec:algorithm} details the \emph{CellFlow} algorithm.
\item \S\ref{sec:experimental} provides additional experimental details.
\item \S\ref{sec:batch_effect} offers a more in-depth discussion of batch effects.
\item \S\ref{sec:data} describes the datasets used in our study.
\item \S\ref{sec:comparison} includes qualitative comparisons of \emph{CellFlow} against baselines.
\item \S\ref{sec:trajectory} presents additional visualization of bidirectional trajectories between control images and perturbed images.
\item \S\ref{sec:results_appendix} provides additional tables comparing our method to baselines in out-of-distribution scenarios.
\item \S\ref{sec:related_appendix} provides a table to compare our work with related works.
\end{itemize}


\newpage
\section{Theory Proof}
\label{sec:theory}

\begin{center}
\begin{tikzpicture}[->, >=stealth, node distance=2cm, font=\sffamily]
    \node[draw, circle, fill=gray!30] (b) {$B$};
    \node[draw, circle, fill=gray!30, right of=b] (c) {$C$};
    \node[draw, circle, fill=gray!30, below left=of b] (x0tilde) {$\tilde{X_0}$};
    \node[draw, circle, below of=b] (x0) {$X_0$};
    \node[draw, circle, fill=gray!30, below of=c] (x1) {$X_1$};
    \draw (b) -- (x0);
    \draw (c) -- (x1);
    \draw (x0) -- (x1);
    \draw (b) -- (x0tilde);
\end{tikzpicture}
\end{center}

\setcounter{prop}{0}
\begin{prop}
    \label{prop:cond2}
    Given random variables $B$, $C$, $X_0$, $\tilde{X_0}$, and $X_1$ following the graphical model above with joint distribution $p(b, c, x_0, \tilde{x_0}, x_1)$, the distribution $p(x_1|x_0,c)$ can be better approximated by the conditional distribution $p(x_1|\tilde{x_0},c)$ than $p(x_1|c)$ in expectation. Formally,
    $$\mathbb{E}_{p(x_0, \tilde{x_0}, c)}\left[ D_{\text{KL}}(p(x_1|x_0,c)||p(x_1|\tilde{x_0},c)) \right] \leq \mathbb{E}_{p(x_0, c)}\left[ D_{\text{KL}}(p(x_1|x_0,c)||p(x_1|c)) \right]$$
\end{prop}

\begin{proof}
    According to the definition of conditional mutual information, the term on the right-hand side can be expressed as:
    \begin{equation}
    \begin{split}
        \mathbb{E}_{p(x_0, c)}\left[ D_{\text{KL}}(p(x_1|x_0,c)||p(x_1|c)) \right] &= \int p(x_0, c) p(x_1|x_0,c) \log \frac{p(x_1|x_0,c)}{p(x_1|c)} dx_1dx_0dc \nonumber\\
        &= \int p(c) \mathbb{E}_{p(x_0,x_1|c)} \left[ \log \frac{p(x_1,x_0|c)}{p(x_1|c) p(x_0|c)}\right] dc \nonumber\\
        &= \mathbb{E}_{p(c)} \left[ D_{\text{KL}}(p(x_1,x_0|c)||p(x_1|c)p(x_0|c)) \right] = I(X_1;X_0|C)
    \end{split}
    \end{equation}

    Based on the graphical model, we have the conditional independence $X_1 \indep \tilde{X_0}|X_0,C$. Thus, we have $p(x_1|x_0,c)=p(x_1|x_0, \tilde{x_0},c)$. Similarly, we can express the term on the right-hand side as conditional mutual information:
    \begin{equation}
        \begin{split}
            \mathbb{E}_{p(x_0, \tilde{x_0}, c)}\left[ D_{\text{KL}}(p(x_1|x_0,c)||p(x_1|\tilde{x_0},c)) \right] &= \mathbb{E}_{p(x_0, \tilde{x_0}, c)}\left[ D_{\text{KL}}(p(x_1|x_0, \tilde{x_0},c)||p(x_1|\tilde{x_0},c)) \right]\nonumber\\
            &= \int p(x_0, \tilde{x_0}, c) p(x_1|x_0,\tilde{x_0},c) \log \frac{p(x_1|x_0, \tilde{x_0},c)}{p(x_1|\tilde{x_0},c)} dx_1d\tilde{x_0}dx_0dc \nonumber\\
            &= I(X_1;X_0|\tilde{X_0},C)
        \end{split}
    \end{equation}

Further, based on the property of conditional mutual information, we have
\begin{equation}
    \begin{split}
    I(X_1;X_0|C)&=I(X_1;X_0|\tilde{X_0},C) + I(X_1;\tilde{X_0}|C) - I(X_1;\tilde{X_0}|X_0,C)\nonumber\\
    &=I(X_1;X_0|\tilde{X_0},C) + I(X_1;\tilde{X_0}|C)
    \end{split}
\end{equation}
where the second equality is due to the conditional independence relationship $X_1 \indep \tilde{X_0}|X_0,C$, and $I(X_1;\tilde{X_0}|X_0,C)=0$

Therefore, 
\begin{equation}
    \begin{split}
    \mathbb{E}_{p(x_0, c)}\left[ D_{\text{KL}}(p(x_1|x_0,c)||p(x_1|c)) \right] &= \mathbb{E}_{p(x_0, \tilde{x_0}, c)}\left[ D_{\text{KL}}(p(x_1|x_0,c)||p(x_1|\tilde{x_0},c)) \right] + I(X_1;\tilde{X_0}|C) \nonumber\\
    &\geq \mathbb{E}_{p(x_0, \tilde{x_0}, c)}\left[ D_{\text{KL}}(p(x_1|x_0,c)||p(x_1|\tilde{x_0},c)) \right] 
    \end{split}
\end{equation}

The inequality holds strictly when $I(X_1;\tilde{X_0}|C)>0$, i.e., $X_1\notindep \tilde{X_0}|C$, which generally holds true when batch effect exists and variables $X_0$ and $\tilde{X_0}$ are associated by $B$ according to the graphical model.

\end{proof}


\newpage
\section{\emph{CellFlow} Algorithm}
\label{sec:algorithm}

\input{tabs/algorithm}
Algorithm \ref{alg:celldiff} provides a detailed overview of the \emph{CellFlow} algorithm, covering both training and inference. During training, the model learns to predict velocity between an initial and target distribution by interpolating between samples, applying noise and condition dropout, and optimizing an L2 loss between predicted and true velocities. In inference, the trained model iteratively updates a sample from the initial distribution toward the target distribution using classifier-free guidance, ultimately generating a new sample that aligns with the target distribution.

\section{Experimental Details}
\label{sec:experimental}

\textbf{Model architecture.} \emph{CellFlow} employs a UNet-based velocity field parameterization with input and output channels matching the dataset. It features four stages for downsampling and upsampling, with each stage halving or doubling the resolution and using a hidden size of 128. This hierarchical UNet design focuses on efficient 2D spatial learning for pixel-level flow matching.

\textbf{Perturbation encoding.} We encode perturbations following IMPA’s approach~\cite{palma2023predicting}. For chemical embeddings, we use 1024-dimensional Morgan Fingerprints generated with RDKit. For gene embeddings, CRISPR and ORF embeddings combine Gene2Vec with HyenaDNA-derived sequence representations, resulting in final dimensions of 328 and 456, respectively.

\textbf{Training details.} Models are trained for 100 epochs on 4 A100 GPUs using the Adam optimizer with a learning rate of 1e-4 and a batch size of 128, requiring 8, 16, and 36 hours for BBBC021, RxRx1, and JUMP, respectively. The noise injection probability, condition drop probability, and classifier-free guidance strength are set to 0.5, 0.2, and 1.2, respectively. Models are selected based on the lowest FID scores on the validation set.


\newpage
\section{Batch Effects}
\label{sec:batch_effect}

\textbf{1. What Are Batch Effects in Microscopy Experiments?}  

Batch effects refer to a form of \textit{distribution shift} in microscopy experiments, where non-biological variations arise due to differences in experimental conditions across imaging sessions or batches. These effects can be classified as a type of \textit{covariate shift}, where technical factors alter the distribution of input features, including:

\begin{itemize}[itemsep=0pt, parsep=0pt, topsep=0pt]
    \item \textbf{Microscope or camera settings} – Variations in sensor sensitivity, illumination, resolution, or imaging modalities.
    \item \textbf{Experimental procedures} – Differences in sample preparation, staining protocols, reagent batches, or handling by different researchers.
    \item \textbf{Environmental conditions} – Changes in temperature, humidity, or laboratory-specific conditions that may be difficult to control.
\end{itemize}

As a result, images of biologically identical cells may appear different solely due to variations in imaging conditions rather than biological differences.

\textbf{2. Why Do Batch Effects Matter?}  

Batch effects pose a major challenge to reproducible biomedical research by obscuring true biological effects of perturbations. Additionally, machine learning models may inadvertently learn batch-specific artifacts instead of meaningful biological patterns. Key issues caused by batch effects include:

\begin{itemize}[itemsep=0pt, parsep=0pt, topsep=0pt]
    \item \textbf{Poor generalization} – Models trained on batch-affected images may fail to classify new samples from a different experimental setup.
    \item \textbf{False discoveries} – Uncorrected batch effects can confound biological signals, leading to misleading conclusions.
    \item \textbf{Reduced reproducibility} – Results may not replicate across laboratories or imaging systems due to unaccounted technical biases.
\end{itemize}

\textbf{3. Visualization of Batch Effects}  

Figure~\ref{fig:batch_effect} visualizes three batches of BBBC021 images using PCA, showing that each batch forms a distinct cluster. Notably, control (ctrl) and perturbed (trt) images from the same batch cluster together, rather than forming separate control and target clusters. This illustrates the \textbf{batch effect}—a systematic bias within each batch that is unrelated to the perturbation itself.

\textbf{4. How \emph{CellFlow} Addresses Batch Effects?}  

\emph{CellFlow} mitigates batch effects by using control images as initialization during both training and inference, transporting them to target images within the same batch. This ensures that the model learns only the \textbf{relative difference} between control and perturbed images. By conditioning on control images from different batches, \emph{CellFlow} effectively captures the \textbf{true perturbation effect} while preserving batch-specific artifacts. Figure~\ref{fig:batch_effect} demonstrates this, showing that predicted images remain within the same batch cluster when given a control image from that cluster.

\vspace{-1em}
\begin{figure*}[htbp]
    \centering
    \includegraphics[width=0.49\linewidth]{imgs/batch_effect.png}
    \caption{\textbf{Visualization of batch effects in BBBC021 and how \emph{CellFlow} addresses batch effects.}  }
    \vspace{-1em}
    
    \label{fig:batch_effect}
\end{figure*}


\newpage
\section{Datasets}
\label{sec:data}
As described below, all data used in this study are publicly available and utilized under their respective licenses. No new data were generated for this study.

\textbf{BBBC021 dataset.}  
We utilized the BBBC021v1 image set~\cite{caie2010high}, available from the \href{https://bbbc.broadinstitute.org/BBBC021}{Broad Bioimage Benchmark Collection}~\cite{ljosa2012annotated}. The BBBC021 dataset focuses on chemical perturbations in MCF-7 breast cancer cells, serving as a robust benchmark for image-based phenotypic profiling. It comprises 97,504 fluorescent microscopy images of cells treated with 113 small molecules across eight concentrations, targeting diverse cellular mechanisms such as actin disruption, Aurora kinase inhibition, and microtubule stabilization. Each image includes multi-channel labels for DNA, F-actin, and beta-tubulin, facilitating detailed morphological analysis. Metadata provides mechanism-of-action (MOA) annotations for compounds and experimental conditions, enabling applications in mechanistic prediction and phenotypic similarity analysis. Table \ref{tab:moa} shows MoA classes for all BBBC021 perturbations. Images were processed at a resolution suitable for segmentation and deep learning tasks.

\textbf{RxRx1 dataset.}  
The RxRx1 dataset~\cite{sypetkowski2023rxrx1}, available under a \href{https://creativecommons.org/licenses/by-nc-sa/4.0/}{CC-BY-NC-SA-4.0 license} from Recursion Pharmaceuticals at \href{https://www.rxrx.ai/rxrx1\#Download}{rxrx.ai}, focuses on genetic perturbations using CRISPR-mediated gene knockouts. It contains 170,943 images representing 1,042 genetic perturbations in HUVEC cells, with control conditions to address experimental variability. Images were captured across six channels, including nuclear and cytoskeletal markers, enabling high-dimensional phenotypic analysis. Preprocessing steps included segmentation, cropping, and resizing to standardize the data for computational analysis. This dataset supports tasks such as feature extraction, phenotypic clustering, and representation learning.

\textbf{JUMP dataset (CPJUMP1).}  
The JUMP dataset~\cite{chandrasekaran2023jump}, available under a \href{https://creativecommons.org/publicdomain/zero/1.0/deed.en}{CC0 1.0 license}, integrates both genetic and chemical perturbations, offering the most comprehensive image-based profiling resource to date. It includes approximately 3 million images capturing the phenotypic responses of 75 million single cells to genetic knockouts (CRISPR/ORF) and chemical perturbations. Key features include:  

\begin{itemize}
    \item \textbf{Chemical-genetic pairing:} Perturbations targeting the same genes are tested in parallel to assess phenotypic convergence or divergence.  
    \item \textbf{Controlled conditions:} Imaging was standardized across cell types (U2OS and A549), time points (short and extended durations), and experimental setups.  
    \item \textbf{Primary group:} Forty plates profiling CRISPR knockouts and ORF overexpression.  
    \item \textbf{Secondary group:} Additional plates exploring extended experimental conditions.  
\end{itemize}

The JUMP dataset uniquely enables the study of phenotypic relationships between genetic and chemical perturbations and supports the development of predictive models for multi-modal cellular responses. Public access to the dataset and associated analysis pipelines is available via \href{https://broad.io/cpjump1}{Broad's JUMP repository}.

\begin{table}[htbp]
    \centering
    \small
    \rowcolors{2}{white}{light-light-gray}
    \setlength\tabcolsep{6pt}
    \renewcommand{\arraystretch}{1.1}
    \begin{tabular}{ll}
        \toprule
        \textbf{Compound} & \textbf{MoA} \\
        \midrule
        Cytochalasin B & Actin disruptors \\
        Cytochalasin D & Actin disruptors \\
        Latrunculin B & Actin disruptors \\
        AZ258 & Aurora kinase inhibitors \\
        AZ841 & Aurora kinase inhibitors \\
        Mevinolin/Lovastatin & Cholesterol-lowering \\
        Simvastatin & Cholesterol-lowering \\
        Chlorambucil & DNA damage \\
        Cisplatin & DNA damage \\
        Etoposide & DNA damage \\
        Mitomycin C & DNA damage \\
        Camptothecin & DNA replication \\
        Floxuridine & DNA replication \\
        Methotrexate & DNA replication \\
        Mitoxantrone & DNA replication \\
        AZ138 & Eg5 inhibitors \\
        PP-2 & Epithelial \\
        Alsterpaullone & Kinase inhibitors \\
        Bryostatin & Kinase inhibitors \\
        PD-169316 & Kinase inhibitors \\
        Colchicine & Microtubule destabilizers \\
        Demecolcine & Microtubule destabilizers \\
        Nocodazole & Microtubule destabilizers \\
        Vincristine & Microtubule destabilizers \\
        Docetaxel & Microtubule stabilizers \\
        Epothilone B & Microtubule stabilizers \\
        Taxol & Microtubule stabilizers \\
        ALLN & Protein degradation \\
        Lactacystin & Protein degradation \\
        MG-132 & Protein degradation \\
        Proteasome inhibitor I & Protein degradation \\
        Anisomycin & Protein synthesis \\
        Cyclohexamide & Protein synthesis \\
        Emetine & Protein synthesis \\
        DMSO & DMSO \\
        \bottomrule
    \end{tabular}
    \caption{\textbf{Modes of action (MoA) for compounds in BBBC021.}}
    \label{tab:moa}
\end{table}


\newpage
\section{Qualitative Comparison}
\label{sec:comparison}

In this section, we present additional generated samples to further demonstrate the effectiveness of our method. Figures \ref{fig:qualitative_bbbc}, \ref{fig:qualitative_rxrx1}, and \ref{fig:qualitative_jump} show qualitative comparisons on the BBBC021, RxRx1, and JUMP datasets, respectively. Our approach more accurately captures key biological effects, whereas images generated by IMPA fail to reflect real biological responses, and those from PhenDiff appear blurry with significant detail loss.

\begin{figure*}[htbp]
    \centering
    \includegraphics[width=0.8\linewidth]{imgs/qualitative_bbbc.pdf}
    \caption{\textbf{More qualitative comparisons of generated samples on BBBC021.}  }
    \label{fig:qualitative_bbbc}
\end{figure*}
\begin{figure*}[htbp]
    \centering
    \includegraphics[width=0.8\linewidth]{imgs/qualitative_rxrx1.pdf}
    \caption{\textbf{More qualitative comparisons of generated samples on RxRx1.}  }
    \label{fig:qualitative_rxrx1}
\end{figure*}
\begin{figure*}[htbp]
    \centering
    \includegraphics[width=0.8\linewidth]{imgs/qualitative_cpg.pdf}
    \caption{\textbf{More qualitative comparisons of generated samples on JUMP.}  }
    \label{fig:qualitative_jump}
\end{figure*}


\section{Trajectory}
\label{sec:trajectory}

\textbf{Forward interpolation.} Our generation process aims to transform a control image into its corresponding perturbed image using our flow matching model. This is achieved by iteratively solving an ODE, where the velocity field predicted by the model guides the transformation at each timestep. As iterations progress, the image gradually evolves towards its final state at $t = 1$, representing the fully perturbed cell morphology.

\textbf{Backward interpolation.} Due to the bidirectional nature of our model, we can also perform a reversible generation process by inverting the velocity direction. This allows us to start from the perturbed image and gradually recover the original control image, demonstrating the reversible capabilities of our method.

\textbf{Trajectory examples.} Figures \ref{fig:bbbc_trajectory1} and \ref{fig:bbbc_trajectory2} illustrate these bidirectional transformations. The top section of each figure depicts the forward trajectory, where the control image is progressively updated based on the learned velocity field, ultimately generating the perturbed image at $t = 1$. The bottom section shows the reverse trajectory, where the process is reversed, progressively reconstructing the original control image. This capability, which is absent in diffusion-based methods, offers a promising approach for simulating morphological trajectories during perturbation responses. Moreover, \emph{CellFlow}’s reversible distribution transformation enables modeling of backward transitions in cell states, with potential applications in studying recovery dynamics and predicting treatment outcomes.

To further demonstrate our approach, we present trajectory examples for two drugs. The first, PP-2, reduces cell adhesion and disrupts actin reorganization, leading to a more dispersed cell distribution. In Figure \ref{fig:bbbc_trajectory1}, the forward trajectory shows cells transitioning from a clustered to a more diffuse state, while the reverse trajectory restores the original aggregation. The second, Chlorambucil, induces pyknosis (nuclear shrinkage). In Figure \ref{fig:bbbc_trajectory2}, the forward process shows one of the three nuclei undergoing cell death or division, leaving only two nuclei in the final state, while the reverse trajectory reconstructs the original three-nucleus configuration. These results highlight our method’s ability to capture biologically meaningful morphological transitions in both directions.

\begin{figure*}[htbp]
    \centering
    \includegraphics[width=\linewidth]{imgs/bbbc_trajectory.jpg}
    \caption{\textbf{(1/2) Bidirectional interpolation trajectory in BBBC021.}  }
    \label{fig:bbbc_trajectory1}
\end{figure*}
\begin{figure*}[htbp]
    \centering
    \includegraphics[width=\linewidth]{imgs/bbbc_trajectory2.jpg}
    \caption{\textbf{(2/2) Bidirectional interpolation trajectory in BBBC021.}  }
    \label{fig:bbbc_trajectory2}
\end{figure*}


\newpage
\section{More Results}
\label{sec:results_appendix}

\textbf{Out-of-distribution generalization.} Table \ref{tab:ood_per_class} reports results on the out-of-distribution (OOD) set in BBBC021, evaluating performance on perturbations absent from the training set. This highlights our method’s strong generalization ability to novel chemical perturbations. The FID score measures the similarity between generated and real distributions, with lower values indicating a closer match. As shown in the table, our method effectively captures the biological effects of each perturbation, generating images that closely resemble real cellular responses. Robust OOD generalization is essential for biological research, enabling the exploration of untested interventions, analysis of unknown cellular responses, and the design of new drugs by simulating effects before experimental validation.

\begin{table}[htbp]
    \rowcolors{2}{white}{light-light-gray}
    \centering
    \setlength\tabcolsep{3pt}
    \small
    \begin{tabular}{lcccccccc}
        \toprule
        Method
        & AZ841 & Cyclohexamide & Cytochalasin D & Docetaxel & Epothilone B & Lactacystin & Latrunculin B & Simvastatin \\
        \midrule
        PhenDiff & 136.5 & 224.0 & 180.3 & 160.1 & 131.5 & 139.7 & 132.5 & 108.9 \\
        IMPA & 131.7 & 189.9 & 180.6 & 130.6 & 120.7 & 133.7 & 128.5 & \textbf{79.7} \\
        CellFlow & \textbf{84.1} & \textbf{99.5} & \textbf{129.4} & \textbf{81.9} & \textbf{93.7} & \textbf{106.9} & \textbf{97.9} & 90.9 \\
        \bottomrule
    \end{tabular}
    \caption{\textbf{Out-of-distribution generalization results per perturbation.}}
    \label{tab:ood_per_class}
\end{table}

\section{Related Works}
\label{sec:related_appendix}

Table~\ref{tab:related} presents a brief comparison of our work with existing methods for cellular morphology generation.

\begin{table*}[htbp]
    \small
    \centering
    \rowcolors{2}{white}{light-light-gray}
    \setlength\tabcolsep{6pt}
    \renewcommand{\arraystretch}{1.1}
    \begin{tabular}{lccc}
    \toprule
    Paper & Generative Model & Use Control Image & How to Use Control Image \\
    \midrule
    Mol2Image~\cite{yang2021mol2image} & Normalizing Flows & No & - \\
    IMPA~\cite{palma2023predicting} & GAN & Yes & Add AdaIn layers to GAN \\
    MorphoDiff~\cite{navidi2024morphodiff} & Diffusion & No & - \\
    PhenDiff~\cite{bourou2024phendiff} & Diffusion & Yes & Map control to noise then to target \\
    LUMIC~\cite{hung2024lumic} & Diffusion & Yes & Add DINO embedding as condition \\
    pDIFF~\cite{cook2024diffusion} & Diffusion & No & - \\
    CellFlow (Ours) & Flow Matching & Yes & Initialization as source distribution \\
    \bottomrule
    \end{tabular}
    \caption{\textbf{Related works on cell morphology generation.}}
    \label{tab:related}
\end{table*}
