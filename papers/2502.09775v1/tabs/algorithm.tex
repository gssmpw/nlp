\begin{algorithm}[htbp]
\caption{\emph{CellFlow} Algorithm}
\label{alg:flow_matching}

\begin{minipage}{\linewidth}
\begin{algorithmic}
\STATE \hspace{-1em}\textbf{Training Process:}
\INPUT Initial distribution $p_0$, target distribution $p_1$, perturbation $c$, 
neural network $v_\theta(x_t, t, c)$, noise injection probability $p_n$, condition drop probability $p_c$, learning rate $\eta$, number of iterations $N$
\OUTPUT Trained neural network $v_\theta$

\FOR{each iteration $i = 1, \ldots, N$}
    \STATE Sample $x_0 \sim p_0$ and $x_1 \sim p_1$
    \STATE Sample $t \sim \text{Uniform}[0, 1]$
    \STATE Inject noise $x_0 \gets x_0 + \epsilon$, $\epsilon \sim \mathcal{N}(0,I)$ with $p_n$
    \STATE Drop condition $c \gets \phi$ with $p_c$
    \STATE Interpolate $x_t \gets t x_1 + (1-t)x_0$
    \STATE Compute true velocity $v(x_t, t, c) \gets x_1 - x_0$
    \STATE Predict velocity using neural network $v_\theta(x_t, t, c)$
    \STATE Compute loss $\mathcal{L} \gets \| v_\theta(x_t, t, c) - v(x_t, t, c) \|_2^2$
    \STATE Update $\theta$ using gradient descent $\theta \gets \theta - \eta \nabla_\theta \mathcal{L}$
\ENDFOR
\vspace{1em}
\STATE \hspace{-1em}\textbf{Inference Process:}
\INPUT Initial sample $x_0 \sim p_0$, perturbation $c$, step size $\Delta t$, classifier-free guidance strength $\alpha$
\OUTPUT Generated sample $x_1 \sim p_1$
\STATE Initialize $x_t \gets x_0$
\FOR{$t = 0$ to $1$ with step size $\Delta t$}
    \STATE Computer velocity with classifier-free guidance $v_\theta^\text{CFG}(x_t, t, c) \gets \alpha v_\theta(x_t, t, c) + (1-\alpha) v_\theta(x_t, t, \emptyset)$
    \STATE Update $x_t \gets x_t + \Delta t \cdot v_\theta^\text{CFG}(x_t, t, c)$
\ENDFOR
\STATE Output final state $x_1 \gets x_t$
\end{algorithmic}
\end{minipage}
\label{alg:celldiff}
\end{algorithm}