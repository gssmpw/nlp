\algrenewcommand\algorithmicindent{0.4em}%

\begin{lstlisting}[language=C++,
                   label=algorithm:rewrite-demo:rewritten,
                   caption=Transformed loop from Listing~\ref{algorithm:rewrite-demo:vanilla},
                   basicstyle=\footnotesize]
void kernel(Data *buf, int size) {
  // define the SoA proxy view 
  struct Data_view_3360 {
    double &a;
    double &b;
    Data_view_3360 &operator[](int i) { return *this; }
    Data_view_3360 &operator*() { return *this; }
  };

  // helper data structure to handle the [] operator
  struct Data_SoaHelper_3360 {
    double *a;
    double *b;
    Data_view_3360 operator[](int i) {
      return Data_view_3360{a[i],b[i],};
    }
  };

  // allocate the SoA buffer
  alignas (64) char __soa_buf_3360[16 * size];
  double * __restrict__ a_3360 
    = (double*) (__soa_buf_3360 + 8 * size);
  double * __restrict__ b_3360 
    = (double*) (__soa_buf_3360 + 0 * size);

  // prologue - populate SoA buffers
  for (int i = 0; i < size; i++) {
    a_3360[i] = *((double*) (((char*) &buf[i]) + 0));
    b_3360[i] = *((double*) (((char*) &buf[i]) + 8));
  }

  // original loop
  for (int i = 0; i < size; i++) {
    // helper variables
    // buf masks accesses to AoS data
    auto Data_SoaHelper_instance_3360
      = Data_SoaHelper_3360{a_3360,b_3360,};
    auto buf = Data_SoaHelper_instance_3360[i];
  
    buf[i].a += buf[i].b;
  }

  // epilogue - populate AoS data
  for (int i = 0; i < size; i++) {
    *((double*) (((char*) &buf[i]) + 0)) = a_3360[i];
  }
}
\end{lstlisting}
