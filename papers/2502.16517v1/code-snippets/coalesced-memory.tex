\begin{lstlisting}[language=C++,
                   label=algorithm:kernel-variants:coalesced,
                   caption=Rewrite of the algorithm exploiting the fact that we know that some particle chunks are stored consecutively in memory,
                   basicstyle=\footnotesize]
void ForAllParticlePairs(list<Particle*> localParticles,
                         list<Particle*> activeParticles,
                         list<int> localParticleChunkSizes,
                         list<int> activeParticleChunkSizes) {
  int globalLPidx = 0;
  for (int lPChunkSize : localParticleChunkSizes) {
    auto *lPChunk = localParticles[globalLPidx];
    for (int lPidx=0; lPidx < lPChunkSize; lPidx++) {
      int globalAPidx = 0;
      for (int aPChunkSize: activeParticleChunkSizes) {
        auto *aPChunk = activeParticles[globalAPidx];
        for (int aPidx=0; aPidx <a PChunkSize; aPidx++) {
         if (DensityPredicate(lPChunk[lPidx], aPChunk[aPidx]))
            Density(lPChunk[lPidx], aPchunk[aPidx]);
        }
      }
      globalAPidx += aPChunkSize;
    }
    globalLPidx += lPChunkSize;
  }
}
\end{lstlisting}
