\paragraph{Case 1: $\tilde{s}' = s_{t+1}$}
\noindent
\begin{proof}
Consider the following disjoint cases:
\begin{itemize}
    \item $P(s_{t+1} \mid \tilde{s}, \tilde{a}) = 0$
    \item $P(s_{t+1} \mid \tilde{s}, \tilde{a}) > 0$ and $P(s_{t+1} \mid \tilde{s}, \tilde{a}) \geq P(s_{t+1} \mid s_t, a_t)$
    \item $P(s_{t+1} \mid \tilde{s}, \tilde{a}) > 0$ and $P(s_{t+1} \mid \tilde{s}, \tilde{a}) < P(s_{t+1} \mid s_t, a_t)$
\end{itemize}

\paragraph{Case 1(a): $P(s_{t+1} \mid \tilde{s}, \tilde{a}) = 0$}
\noindent
\begin{proof}
If $P(s_{t+1} \mid \tilde{s}, \tilde{a}) = 0$, then \\$\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, s_{t+1}} \cdot \theta_{u_t} = 0$ to satisfy \eqref{proofeq:interventional constraint}. Therefore, the maximum counterfactual probability $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a})$ is:

\[
\max_{\theta}\left(\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, s_{t+1}} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} = 0\right)
\]

If we can show that there exists a $\theta$ such that

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} = 0
\]

and $\theta$ satisfies the constraints in the optimisation problem, we know that this results in the maximum possible counterfactual transition probability for $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a})$. We can assign $\theta$ as follows:

\[
\forall s' \in \mathcal{S}, \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)\\
\]

\[
\forall s' \in \mathcal{S}, \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a}) \cdot (1 - P(s_{t+1} \mid s_t, a_t))\\
\]

which results in a counterfactual probability of $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a}) = \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1}}}{\theta_{u_t}} \\= \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} = P(s_{t+1} \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t) = 0$.\\

This assignment of $\theta$ satisfies the constraints of the linear optimisation problem, as follows:

\begin{itemize}
    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1}}}{\theta_{u_t}} = \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 1 - P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\forall s' \in \mathcal{S}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} + \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a}) = \dfrac{\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} = \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)} \\= P(s_{t+1} \mid \tilde{s}, \tilde{a}) \geq P(s_{t+1} \mid \tilde{s}, \tilde{a})$ so Mon1 \eqref{proofeq:monotonicity1} holds.
    \item $\forall s' \in \mathcal{S}\setminus \{s_{t+1}\}$:
    \begin{align*}
        \tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) 
        &= \dfrac{\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t}}{P(s_{t+1} | s_t, a_t)}
        \\ &= \dfrac{P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)} \\ &= P(s' \mid \tilde{s}, \tilde{a}) \\ &\leq P(s' \mid \tilde{s}, \tilde{a})
    \end{align*}
    so Mon2 \eqref{proofeq:monotonicity2} holds.
    \item Because $P(s_{t+1} \mid \tilde{s}, \tilde{a}) = 0$ and $P(s_{t+1} \mid s_t, a_t) > 0$ (since this was observed):
    \[\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} = 0\]
    
    Therefore, $\forall s' \in \mathcal{S}$
    \[
    \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} \leq \dfrac{P(s' \mid \tilde{s}, \tilde{a})}{P(s' \mid s_t, a_t)}
    \]

    so CS \eqref{proofeq:counterfactual stability} holds $\forall s' \in \mathcal{S}$.
    
    \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
    
    \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} + \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 1$, satisfying \eqref{proofeq:valid prob2}.
\end{itemize}

Therefore,

\[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) =
\max_{\theta}\left(\dfrac{\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, s_{t+1}} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)}\right) = \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}
\]
\end{proof}

\paragraph{Case 1(b): $P(s_{t+1} \mid \tilde{s}, \tilde{a}) > 0$ and $P(s_{t+1} \mid \tilde{s}, \tilde{a}) \geq P(s_{t+1} \mid s_t, a_t)$}
\noindent
\begin{proof}
From Lemma \ref{lemma:absolute max cf prob}, we have:

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} \leq \min(P(s_{t+1} \mid s_t, a_t), P(s_{t+1} \mid \tilde{s}, \tilde{a}))
\]

Therefore, 

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} \leq P(s_{t+1} \mid s_t, a_t)
\]

If we can show that there exists a $\theta$ such that

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} = P(s_{t+1} \mid s_t, a_t)
\]

and $\theta$ satisfies the constraints in the optimisation problem, we know that this results in the maximum possible counterfactual transition probability for $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a})$. We can assign $\theta$ as follows:

\begin{align*}
    \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} &= P(s_{t+1} \mid s_t, a_t)\\
    \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} &= P(s_{t+1} \mid \tilde{s}, \tilde{a}) - P(s_{t+1} \mid s_t, a_t)\\
    \forall s' \in \mathcal{S}\setminus \{s_{t+1}\} \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} &= 0\\
   \forall s' \in \mathcal{S}\setminus \{s_{t+1}\} \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} &= P(s' \mid \tilde{s}, \tilde{a})\\
\end{align*}

This assignment of $\theta$ satisfies the constraints of the linear optimisation problem, as follows:

\begin{itemize}
    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} + \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq s_{t+1}}}{\theta_{u_t}} = P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} + \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq s_{t+1}}}{\theta_{u_t}} = 1 - P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\forall s' \in \mathcal{S}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} + \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a}) = \dfrac{\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} = \dfrac{P(s_{t+1} \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)} = 1 \geq P(s_{t+1} \mid \tilde{s}, \tilde{a})$ so Mon1 \eqref{proofeq:monotonicity1} holds.
    \item $\forall s' \in \mathcal{S}\setminus \{s_{t+1}\}$:
    \begin{align*}
        \tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) 
        &= \dfrac{\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t}}{P(s_{t+1} | s_t, a_t)}
        \\ &= \dfrac{0}{P(s_{t+1} \mid s_t, a_t)} \\ &= 0 \\ &\leq P(s' \mid \tilde{s}, \tilde{a})
    \end{align*}
    so Mon2 \eqref{proofeq:monotonicity2} holds.
    \item CS \eqref{proofeq:counterfactual stability} vacuously holds for the transition $\tilde{s}, \tilde{a} \rightarrow s_{t+1}$, because $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} = \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}$. Also, $\forall s' \in \mathcal{S}\setminus \{s_{t+1}\}, \tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) = 0$
    which satisfies CS \eqref{proofeq:counterfactual stability}.
    
    \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
    
    \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} + \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 1$, satisfying \eqref{proofeq:valid prob2}.
\end{itemize}

Therefore,
\[
\max_{\theta}\left(\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, s_{t+1}} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}\right) = P(s_{t+1} \mid s_t, a_t)
\]
and
\[
\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) =
\max_{\theta} \left( \dfrac{\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, s_{t+1}} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} \right) = \dfrac{P(s_{t+1} \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)} = 1
\]

\end{proof}

\paragraph{Case 1(c): $P(s_{t+1} \mid \tilde{s}, \tilde{a}) > 0$ and $P(s_{t+1} \mid \tilde{s}, \tilde{a}) < P(s_{t+1} \mid s_t, a_t)$}
\noindent
\begin{proof}
From Lemma \ref{lemma:absolute max cf prob}, we have:

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} \leq \min(P(s_{t+1} \mid s_t, a_t), P(s_{t+1} \mid \tilde{s}, \tilde{a}))
\]

Therefore, 
\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} \leq P(s_{t+1} \mid \tilde{s}, \tilde{a})
\]

If we can show that there exists a $\theta$ such that

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} = P(s_{t+1} \mid \tilde{s}, \tilde{a})
\]

and $\theta$ satisfies the constraints in the optimisation problem, we know that this results in the maximum possible counterfactual transition probability for $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a})$. We can assign $\theta$ such that:

\begin{align*}
\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} &= P(s_{t+1} \mid \tilde{s}, \tilde{a})\\
\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq s_{t+1}}}{\theta_{u_t}} &= P(s_{t+1} \mid s_t, a_t) - P(s_{t+1} \mid \tilde{s}, \tilde{a})\\
\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} &= 0\\
\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq s_{t+1}}}{\theta_{u_t}} &= \sum_{s' \in \mathcal{S}\setminus \{s_{t+1}\}}{P(s' \mid \tilde{s}, \tilde{a})} - \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq s_{t+1}}}{\theta_{u_t}}\\
\end{align*}

However, it is not immediately clear whether this assignment of $\theta$ is possible, because the Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} constraints limit $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq s'}}{\theta_{u_t}}$ for all $s' \in \mathcal{S}\setminus \{s_{t+1}\}$. In particular, there exists a set $S_{CS} \subset \mathcal{S}$ of states which must have a counterfactual transition probability $\tilde{P}_{t}(s' \mid \tilde{s}, \tilde{a}) = 0$ to satisfy CS \eqref{proofeq:counterfactual stability} (i.e., $\forall s' \in S_{CS}, \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}>\dfrac{P(s' \mid \tilde{s}, \tilde{a})}{P(s' \mid s_t, a_t)}$ and $P(s' \mid s_t, a_t) > 0$). This means that $\forall s' \in S_{CS}$ we must assign $\theta$ such that:

\begin{align*}
    \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} &= 0\\
    \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} &= P(s' \mid \tilde{s}, \tilde{a})\\
\end{align*}

As this results in $\tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) = 0$:

\begin{equation}
\label{eq: theta for CS states}
  \begin{aligned}
    \tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) &= \dfrac{\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t}}{P(s_{t+1} | s_t, a_t)} \\ &= \dfrac{0}{P(s_{t+1} \mid s_t, a_t)}\\ &= 0
\end{aligned}  
\end{equation}

Let $S_{other}$ be the set of all other states $s \in \mathcal{S}\setminus{\{s_{t+1}\}\cup S_{CS}}$. $\forall s' \in S_{other}$, if $P(s' \mid \tilde{s}, \tilde{a})>0$ and $P(s' \mid s_t, a_t)>0$, then $\tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) \leq {P}(s' \mid \tilde{s}, \tilde{a})$ to satisfy Mon2 \eqref{proofeq:monotonicity2}. Because we do not know whether $P(s' \mid \tilde{s}, \tilde{a})>0$ and $P(s' \mid s_t, a_t)>0$ for all $s' \in S_{other}$, we have to assume that this condition holds for all $s' \in S_{other}$, and assign $\theta$ with this assumption. This means, $\forall s' \in S_{other}$:

\begin{equation}
\label{eq: theta for other states}
  \begin{aligned}
    \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} &\leq P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)\\
    \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} &\geq P(s' \mid \tilde{s}, \tilde{a}) - (P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t))\\
\end{aligned}  
\end{equation}

as this ensures each counterfactual transition probability satisfies Mon2 \eqref{proofeq:monotonicity2}, as follows:

\begin{align*}
    \tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) &= \dfrac{\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t}}{P(s_{t+1} | s_t, a_t)} \\ &\leq \dfrac{P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)}\\ &= P(s' \mid \tilde{s}, \tilde{a})
\end{align*}

Therefore, to show that there exists a valid assignment of $\theta$, we must prove that under the Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} constraints:

\[\max_{\theta} \left(\sum_{s' \in \mathcal{S}\setminus \{s_{t+1}\}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}}\right) \geq P(s_{t+1} \mid s_t, a_t) - P(s_{t+1} \mid \tilde{s}, \tilde{a}) \] 

This is proven in Lemma \ref{lemma: existence of theta for overlapping case.}. Now, we can prove that this assignment of $\theta$ satisfies the constraints of the linear optimisation problem, as follows:

\begin{itemize}
    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} + \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq s_{t+1}}}{\theta_{u_t}} = P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} + \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq s_{t+1}}}{\theta_{u_t}} = 1 - P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} + \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\= P(s' \mid \tilde{s}, \tilde{a})$, therefore it is possible to assign $\theta$ such that \\$\forall s' \in \mathcal{S}\setminus\{\tilde{s}'\}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$, satisfying \eqref{proofeq:interventional constraint}.
    \item $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a}) = \dfrac{\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} = \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} \geq P(s_{t+1} \mid \tilde{s}, \tilde{a})$ so Mon1 \eqref{proofeq:monotonicity1} holds.
    
    \item Lemma \ref{lemma: existence of theta for overlapping case.} proves that we can assign $\theta$ such that Mon2 \eqref{proofeq:monotonicity2} holds.
    \item CS \eqref{proofeq:counterfactual stability} vacuously holds for the transition $\tilde{s}, \tilde{a} \rightarrow s_{t+1}$, because $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} = \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}$. Also, Lemma \ref{lemma: existence of theta for overlapping case.} proves that we can assign $\theta$ such that CS \eqref{proofeq:counterfactual stability} holds for all other transitions.
    
    \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
    
    \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} + \sum_{s' \in \mathcal{S}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 1$, satisfying \eqref{proofeq:valid prob2}.
\end{itemize}

Therefore,
\[
\max_{\theta}\left(\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, s_{t+1}} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}\right) = P(s_{t+1} \mid \tilde{s}, \tilde{a})
\]
and
\[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) =
\dfrac{\max_{\theta}\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, s_{t+1}} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} = \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}
\]
\end{proof}

These three sub-cases can be simplified to:

\[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \dfrac{\min\left(P(s_{t+1} \mid s_t, a_t), P(s_{t+1} \mid \tilde{s}, \tilde{a})\right)}{P(s_{t+1} \mid s_t, a_t)}\]
\end{proof}