\pagebreak
\paragraph{Case 3: $\tilde{s}' \neq s_{t+1}$, $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\leq\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$, and $P(\tilde{s}' \mid s_t, a_t) >0$}
\noindent
\begin{proof}
Because $P(\tilde{s}' \mid s_t, a_t) >0$, $\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) \leq P(\tilde{s}' \mid \tilde{s}, \tilde{a})$ to satisfy Mon2 \eqref{proofeq:monotonicity2}. Therefore,
\begin{equation}
\label{eq: overlapping constraint 1}
\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} \leq P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t) 
\end{equation}

so that \[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \dfrac{\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} \leq \dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})\]

Clearly, this is less than the maximum possible counterfactual probability proven in Lemma \ref{lemma:absolute max cf prob}: \[\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} \leq P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t) \leq \min\left(P(s_{t+1} \mid s_t, a_t), P(\tilde{s}' \mid \tilde{s}, \tilde{a})\right)\]

Also, $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a}) \geq P(s_{t+1} \mid \tilde{s}, \tilde{a})$ to satisfy Mon1 \eqref{proofeq:monotonicity1}. Therefore,

\begin{equation}
\label{eq: overlapping constraint 2}
\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, s_{t+1}} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} \geq P(s_{t+1} \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)    
\end{equation}

Since $\forall s,s' \in \mathcal{S}, \forall a \in \mathcal{A}, \forall u_t \in U_t, \mu_{s, a, u_t, s'} = 1 \iff f(s, a, u_t) = s'$ by definition of $\mu$, Eq. \eqref{eq: overlapping constraint 1} and Eq. \eqref{eq: overlapping constraint 2} are equivalent to:

\begin{equation}
\label{eq: overlapping constraint 3}
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \leq P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)     
\end{equation}
and

\begin{equation}
\label{eq: overlapping constraint 4}
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t}\geq P(s_{t+1} \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)     
\end{equation}

respectively. As these notations are equivalent, we will use this second notation for brevity and clarity. Consider the following disjoint cases:
\begin{itemize}
    \item $P(s_{t+1} \mid s_t, a_t) - (P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})) < P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)$
    \item $P(s_{t+1} \mid s_t, a_t) - (P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})) \geq P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)$
\end{itemize}

\pagebreak
\paragraph{Case 3(a): $P(s_{t+1} \mid s_t, a_t) - (P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})) < P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)$}
\noindent
\begin{proof}
We can assign $\theta$ as follows:

\[
\begin{cases}
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} = P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})\\
    
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} = P(s_{t+1} \mid s_t, a_t) - (P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})) \\
    
    \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 0\\
    
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} = P(s_{t+1} \mid \tilde{s}, \tilde{a}) - \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} \\
    
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} = P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} \\
    
    \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}P(\tilde{s}' \mid \tilde{s}, \tilde{a})\\
\end{cases}
\]

This assignment of $\theta$ satisfies the constraints of the linear optimisation problem, as follows:

\begin{itemize}        
    \item $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1}}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\ = P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.

    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\=1 -
    P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.
    
    \item $\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})$, \\satisfying \eqref{proofeq:interventional constraint}.

    \item $\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} = P(s_{t+1} \mid \tilde{s}, \tilde{a})$, \\satisfying \eqref{proofeq:interventional constraint}.
    
    \item $\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} \\+ \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} = 1 - P(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}P(s' \mid \tilde{s}, \tilde{a})$, \\therefore it is possible to assign $\theta$ such that \\$\forall s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$,
    satisfying \eqref{proofeq:interventional constraint}.

    \item \eqref{eq: overlapping constraint 4} holds, therefore Mon1 \eqref{proofeq:monotonicity1} is satisfied.
    
    \item \eqref{eq: overlapping constraint 3} holds, therefore $\tilde{P}_t(\tilde{s}' \mid \tilde{s}, \tilde{a}) \leq P(\tilde{s}' \mid \tilde{s}, \tilde{a})$. Also, because \\$\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 0$, the counterfactual probability of all other \\transitions $\tilde{s}, \tilde{a} \rightarrow s'$ where $s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}$ will be $\tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) = 0 \leq \tilde{P}_t(s' \mid \tilde{s}, \tilde{a})$. Therefore, Mon2 \eqref{proofeq:monotonicity2} is satisfied.

    \item CS \eqref{proofeq:counterfactual stability} is vacuously satisfied for the transitions $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$ and $\tilde{s}, \tilde{a} \rightarrow s_{t+1}$ because \\$\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\leq\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$ (from conditions of Case 3) and $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} = \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}$. Also, because $\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 0$, the counterfactual probability of all other transitions $\tilde{s}, \tilde{a} \rightarrow s'$ where $s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}$ will be $\tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) = 0$, which satisfies CS \eqref{proofeq:counterfactual stability} for these transitions.

    \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
    
    \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} +  \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\+ \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + 
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 1$, satisfying \eqref{proofeq:valid prob2}.
\end{itemize}

All the constraints are satisfied, so this is a valid assignment of $\theta$ for this state-action pair.
\end{proof}
\paragraph{Case 3(b): $P(s_{t+1} \mid s_t, a_t) - (P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})) \geq P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)$}
\noindent
\begin{proof}
If $P(s_{t+1} \mid s_t, a_t) - (P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})) \geq P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)$, this implies $P(s_{t+1} \mid s_t, a_t) \geq P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)$. Therefore, we can assign $\theta$ as follows:

 \[
    \begin{cases}
        P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a}) \leq \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} \leq P(s_{t+1} \mid \tilde{s}, \tilde{a}) \\
        
        \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} = P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)\\
        
        0 \leq \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \leq \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)\\
        
        \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} = P(s_{t+1} \mid \tilde{s}, \tilde{a}) - \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} \\
        
        \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} = P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} \\
        
        \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}}\\
    \end{cases}
\]

s.t. $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\= P(s_{t+1} \mid s_t, a_t)$.\\\\

We do not know exactly how much probability will be assigned to $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}}$ and $\sum_{s' \in \mathcal{S} \setminus \{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t)= s'}}{\theta_{u_t}}$. However, if $\theta$ satisfies the above assignment then $\theta$ will always satisfy the constraints of the optimisation problem, as follows:

\begin{itemize}        
    \item $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1}}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\ = P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}.

    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\=1 -
    P(s_{t+1} \mid s_t, a_t)$, satisfying \eqref{proofeq:interventional constraint}
    
    \item $\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})$, \\satisfying \eqref{proofeq:interventional constraint}.


    \item $\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} = P(s_{t+1} \mid \tilde{s}, \tilde{a})$, \\satisfying \eqref{proofeq:interventional constraint}.

    \item $\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} \\= 1 - P(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}P(s' \mid \tilde{s}, \tilde{a})$, therefore it is possible to assign $\theta$ such that $\forall s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$, satisfying \eqref{proofeq:interventional constraint}.

    \item \eqref{eq: overlapping constraint 4} holds, therefore Mon1 \eqref{proofeq:monotonicity1} is satisfied.
    
    \item \eqref{eq: overlapping constraint 3} holds, so Mon2 \eqref{proofeq:monotonicity2} holds for the transition $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$.

    \item CS \eqref{proofeq:counterfactual stability} is vacuously satisfied for the transitions $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$ and $\tilde{s}, \tilde{a} \rightarrow s_{t+1}$ because $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\leq\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$ (from conditions of Case 3) and $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} = \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}$.

    \item To ensure that Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} hold for all other transitions, we must consider two possible cases:

    \begin{itemize}
        \item If $P(s_{t+1} \mid \tilde{s}, \tilde{a}) \geq P(s_{t+1} \mid s_t, a_t)$, then we can assign $\theta$ such that:
        
        \[
            \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 0
        \]

        and 

        \[
            \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} = P(s_{t+1} \mid s_t, a_t) - \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}}
        \]

        which must be possible in our given assignment of $\theta$ because from the condition of Case 3(b) we have:

        \begin{align*}
            P(s_{t+1} \mid s_t, a_t) - (P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})) \geq P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t) \\ \implies P(s_{t+1} \mid s_t, a_t) - ( P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t))\geq P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})
        \end{align*}
        Because $\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 0$, $\forall s' \in \mathcal{S} \setminus \{\tilde{s}', s_{t+1}\}, \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\= 0$, and so $\forall s' \in \mathcal{S} \setminus \{\tilde{s}', s_{t+1}\}, \tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) = 0$. This satisfies the Mon2 \eqref{proofeq:monotonicity2} (since $0 \leq \tilde{P}_t(s' \mid \tilde{s}, \tilde{a})$) and CS \eqref{proofeq:counterfactual stability} constraints for all other transitions $\tilde{s}, \tilde{a} \rightarrow s'$.

        \item Otherwise, we must have $P(s_{t+1} \mid \tilde{s}, \tilde{a}) < P(s_{t+1} \mid s_t, a_t)$. We need to prove that there exists an assignment of $\theta$ where the Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} constraints are satisfied for all transitions $\tilde{s}, \tilde{a} \rightarrow s', \forall s' \in \mathcal{S}\setminus \{\tilde{s}', s_{t+1}\}$, which equates to proving:

        \[
        \max_{\theta}\left(\sum_{s' \in \mathcal{S}\setminus \{s_{t+1}\}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}}\right) \geq \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)
        \]

        since 
        \[
        \sum_{s' \in \mathcal{S}\setminus \{s_{t+1}\}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \leq 
        \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)
        \]
        
        in our given assignment of $\theta$. From Lemma \ref{lemma: existence of theta for overlapping case.}, we have:

        \begin{equation}
        \label{eq: implied max prob1}
            \max_{\theta}\left(\sum_{s' \in \mathcal{S}\setminus \{s_{t+1}\}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}}\right) \geq P(s_{t+1} \mid s_t, a_t) - P(s_{t+1} \mid \tilde{s}, \tilde{a})
        \end{equation}

        under the Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} constraints. Since we have assigned the maximum possible probability to $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} = P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)$ under the Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} constraints in our given assignment of $\theta$, \eqref{eq: implied max prob1} implies:

        \[\max \sum_{s' \in \mathcal{S}\setminus \{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \geq P(s_{t+1} \mid s_t, a_t) - P(s_{t+1} \mid \tilde{s}, \tilde{a}) -  P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)\]

        Therefore, we know that we can assign $\theta$ such that $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}}{\theta_{u_t}} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s_{t+1} \mid s_t, a_t)$, and all transitions satisfy the Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} constraints.

    \end{itemize}
    
    \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
    
    \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} +  \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \\+ \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s_{t+1}}} \theta_{u_t} + \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}', s_{t+1}\}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = 1$, satisfying \eqref{proofeq:valid prob2}.
\end{itemize}

All the constraints are satisfied, so this is a valid assignment of $\theta$ for this state-action pair.
\end{proof}

These two cases can be simplified to:

\begin{align*}
\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) &= \dfrac{\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}}}{P(s_{t+1} \mid s_t, a_t)}\\ &=
 \dfrac{\min(P(s_{t+1} \mid s_t, a_t) - (P(s_{t+1} \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})), P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t))}{P(s_{t+1} \mid s_t, a_t)}\\
 &= \min(1 - P(s_{t+1} \mid \tilde{s}, \tilde{a}), P(\tilde{s}' \mid \tilde{s}, \tilde{a}))
\end{align*}
\end{proof}