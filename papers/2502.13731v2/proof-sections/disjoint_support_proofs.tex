To enhance readability, we split the proof for Theorem \ref{theorem: ub disjoint} into two separate theorems: Theorem \ref{proof theorem: ub disjoint} proves the upper counterfactual probability bound, and Theorem \ref{proof theorem: lb disjoint} proves the lower counterfactual probability bound.

\begin{theorem}
\label{proof theorem: ub disjoint}
For outgoing transitions from state-action pairs $(\tilde{s}, \tilde{a})$ which have completely disjoint support from the observed $(s_t, a_t)$, the linear program will produce an upper bound of:

\[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = 
\begin{cases}
\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} & \text{if $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) < P(s_{t+1} \mid s_t, a_t)$} \\
1 & \text{otherwise} \\
\end{cases}
\]
for all next states $\tilde{s}' \in \mathcal{S}$.

\end{theorem}

\begin{proof} Take an arbitrary transition $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$ where $(\tilde{s}, \tilde{a})$ has disjoint support with the observed state-action pair $(s_t, a_t)$. By definition:

\[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \max_\theta \left( \frac{\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} \right)\]

Because $P(s_{t+1} \mid s_t, a_t)$ (the interventional probability of the observed transition) is fixed, to find the upper bound for $\tilde{P}_t(\tilde{s}' \mid \tilde{s}, \tilde{a})$ we need to maximise $\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}$. From Lemma \ref{lemma:absolute max cf prob}, we have:

\[
\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} \leq \min\left(P(s_{t+1} \mid s_t, a_t), P(\tilde{s}' \mid \tilde{s}, \tilde{a})\right)
\]

Therefore, if we can show that there exists a $\theta$ such that
\[
\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} = \min\left((P(s_{t+1} \mid s_t, a_t), P(\tilde{s}' \mid \tilde{s}, \tilde{a})\right)
\]

and $\theta$ satisfies the constraints of the optimisation problem, we know that this results in the maximum possible counterfactual transition probability $\tilde{P}_t(\tilde{s}' \mid \tilde{s}, \tilde{a})$. Since $\forall s,s' \in \mathcal{S}, \forall a \in \mathcal{A}, \forall u_t \in U_t, \mu_{s, a, u_t, s'} = 1 \iff f(s, a, u_t) = s'$ by definition of $\mu$, this is equivalent to showing that there exists a $\theta$ such that:

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}= \min\left((P(s_{t+1} \mid s_t, a_t), P(\tilde{s}' \mid \tilde{s}, \tilde{a})\right)
\]

As these notations are equivalent, we will use this second notation for brevity and clarity. Consider the following disjoint cases:

\begin{itemize}
    \item $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) < P(s_{t+1} \mid s_t, a_t)$
    \item $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \geq P(s_{t+1} \mid s_t, a_t)$
\end{itemize}

\paragraph{Case 1: $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) < P(s_{t+1} \mid s_t, a_t)$}
\noindent
\begin{proof}
In this case, assign $\theta$ as follows:

\[
\begin{cases}
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}= P(\tilde{s}' \mid \tilde{s}, \tilde{a})\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = P(s_{t+1} \mid s_t, a_t) - P(\tilde{s}' \mid \tilde{s}, \tilde{a})\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = 0\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 1 - P(s_{t+1} \mid s_t, a_t)\\
\end{cases}
\]

    This assignment of $\theta$ satisfies the constraints of the linear optimisation problem, as follows:

    \begin{itemize}        
        \item $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1}}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = P(s_{t+1} \mid s_t, a_t)$ \\satisfying \eqref{proofeq:interventional constraint}.

        \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} =1 -
        P(s_{t+1} \mid s_t, a_t)$ satisfying \eqref{proofeq:interventional constraint}.
        
        \item $\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})$ satisfying \eqref{proofeq:interventional constraint}.
        
        \item $\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} \\ = 1 - P(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}P(s' \mid \tilde{s}, \tilde{a})$, therefore it is possible to assign $\theta$ such that $\forall s' \in \mathcal{S}\setminus\{\tilde{s}'\}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$ satisfying \eqref{proofeq:interventional constraint}.
        
        \item Mon1 \eqref{proofeq:monotonicity1}, Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} are all vacuously true for all transitions from $(\tilde{s}, \tilde{a})$ due to Lemma \ref{lemma: constraints do not apply if disjoint}.

        \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
        
        \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \\+ \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 1$, satisfying \eqref{proofeq:valid prob2}.
    \end{itemize}

    Therefore,

    \[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \left( \max_\theta \frac{ \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} }{P(s_{t+1} \mid s_t, a_t)} \right) = \frac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\]
\end{proof}

\paragraph{Case 2: $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \geq P(s_{t+1} \mid s_t, a_t)$}
\noindent
\begin{proof}
In this case, assign $\theta$ as follows:

\[
\begin{cases}
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}= P(s_{t+1} \mid s_t, a_t)\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 0\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - P(s_{t+1} \mid s_t, a_t)\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 1 - P(\tilde{s}' \mid \tilde{s}, \tilde{a})\\
\end{cases}
\]
    This assignment of $\theta$ satisfies the constraints of the linear optimisation problem, as follows:

    \begin{itemize}        
        \item $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1}}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = P(s_{t+1} \mid s_t, a_t)$ \\satisfying \eqref{proofeq:interventional constraint}.

        \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} =1 -
        P(s_{t+1} \mid s_t, a_t)$ satisfying \eqref{proofeq:interventional constraint}.
        
        \item $\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})$ satisfying \eqref{proofeq:interventional constraint}.
        
        \item $\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} \\ = 1 - P(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}P(s' \mid \tilde{s}, \tilde{a})$, therefore it is possible to assign $\theta$ such that $\forall s' \in \mathcal{S}\setminus\{\tilde{s}'\}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$ satisfying \eqref{proofeq:interventional constraint}.
        
        \item Mon1 \eqref{proofeq:monotonicity1}, Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} are all vacuously true for all transitions from $(\tilde{s}, \tilde{a})$ due to Lemma \ref{lemma: constraints do not apply if disjoint}.

        \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
        
        \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \\ + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 1$, satisfying \eqref{proofeq:valid prob2}.
    \end{itemize}

     All the constraints are satisfied, so this is a valid assignment of $\theta$ for this state-action pair. Therefore,

        \[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \max_\theta \left(\frac{\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)}\right) = \frac{P(s_{t+1} \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)} = 1\]
    
\end{proof}

These two cases can be combined as follows:

\[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = 
\begin{cases}
\frac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} & \text{if $P(\tilde{s}' \mid \tilde{s}, \tilde{a})) < P(s_{t+1} \mid s_t, a_t)$} \\
1 & \text{otherwise} \\
\end{cases}
\]
for all next states $\tilde{s}' \in \mathcal{S}$.
\end{proof}

\pagebreak
\begin{theorem}
\label{proof theorem: lb disjoint}
For outgoing transitions from state-action pairs $(\tilde{s}, \tilde{a})$ which have completely disjoint support from the observed $(s_t, a_t)$, the linear program will produce a lower bound of:
\[\tilde{P}_{t}^{LB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = 
\begin{cases}
\frac{P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - (1 - P(s_{t+1} \mid s_t, a_t))}{P(s_{t+1} \mid s_t, a_t)} & \text{if $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) > 1 - P(s_{t+1} \mid s_t, a_t)$}\\
0 & \text{otherwise}\\
\end{cases}
\]
for all possible next states $\tilde{s}'$.
\end{theorem}

\begin{proof}
Take an arbitrary transition $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$ where $(\tilde{s}, \tilde{a})$ is disjoint from the observed state-action pair $(s_t, a_t)$. By definition:

\[\tilde{P}_{t}^{LB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \min_\theta \left(\frac{\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)}\right)\]

Because $P(s_{t+1} \mid s_t, a_t)$ (the interventional probability of the observed transition) is fixed, to find the lower bound for $\tilde{P}_t(\tilde{s}' \mid \tilde{s}, \tilde{a})$ we need to minimise $\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}$. Because $\sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} + \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, s'} \cdot \theta_{u_t} = 1$, this is equivalent to maximising the following equation:

\[
\max_\theta \left( \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s'} \cdot \theta_{u_t}\right)
\]

From the constraints of the optimisation problem, we have:

\begin{equation}
    \label{eq: theorem 4.8 constraint 1}
    \sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'}\cdot \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})
\end{equation}
and
\begin{equation}
\label{eq: theorem 4.8 constraint 2}
    \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, s'} \cdot \theta_{u_t} = \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}{P(s' \mid s_t, a_t)} = 1 - P(s_{t+1} \mid s_t, a_t)
\end{equation}

$\forall s,s' \in \mathcal{S}, \forall a \in \mathcal{A}, \forall u_t \in U_t, \mu_{s, a, u_t, s'} \in \{0, 1\}$ (from its definition). Therefore,\\ $\sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s'} \cdot \theta_{u_t}$ is maximal when the probability assigned to all $u_t$ where $\mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} = 1$ and $\mu_{s_t, a_t, u_t, s_{t+1}}=0$ is maximal:

\[
\sum_{u_t = 1}^{|U_t|}(\mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \theta_{u_t}) \cdot \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\mu_{s_t, a_t, u_t, s'} \leq \sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'}\cdot \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})
\]

\[
\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot (\sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\mu_{s_t, a_t, u_t, s'} \cdot \theta_{u_t}) \leq  \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, s'} \cdot \theta_{u_t} = 1 - P(s_{t+1} \mid s_t, a_t)
\]

Because of Eq. \eqref{eq: theorem 4.8 constraint 1} and Eq. \eqref{eq: theorem 4.8 constraint 2}, the probability assigned to all $u_t$ where $\mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} = 1$ and $\mu_{s_t, a_t, u_t, s_{t+1}}=0$ cannot be greater than $P(\tilde{s}' \mid \tilde{s}, \tilde{a})$ or $1 - P(s_{t+1} \mid s_t, a_t)$. So,

\[
    \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s'} \cdot \theta_{u_t} \leq \min\left(P(\tilde{s}' \mid \tilde{s}, \tilde{a}), (1 - P(s_{t+1} \mid s_t, a_t)\right)
\]

Therefore, if we can show that there exists a $\theta$ such that
\[
    \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s'} \cdot \theta_{u_t} = \min\left(P(\tilde{s}' \mid \tilde{s}, \tilde{a}), (1 - P(s_{t+1} \mid s_t, a_t)\right)
\]

and $\theta$ satisfies the constraints of the optimisation problem, we know that this results in the minimum possible counterfactual transition probability $\tilde{P}_t(\tilde{s}' \mid \tilde{s}, \tilde{a})$. Since $\forall s,s' \in \mathcal{S}, \forall a \in \mathcal{A}, \forall u_t \in U_t, \mu_{s, a, u_t, s'} = 1 \iff f(s, a, u_t) = s'$ by definition of $\mu$, this is equivalent to showing that there exists a $\theta$ such that:

\[
\sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s' \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}= \min\left(P(\tilde{s}' \mid \tilde{s}, \tilde{a}), (1 - P(s_{t+1} \mid s_t, a_t)\right)
\]

As these notations are equivalent, we will use this second notation for brevity and clarity. Consider the following disjoint cases:

\begin{itemize}
    \item $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) > 1 - P(s_{t+1} \mid s_t, a_t)$
    \item $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \leq 1 - P(s_{t+1} \mid s_t, a_t)$
\end{itemize}

\paragraph{Case 1: $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) > 1 - P(s_{t+1} \mid s_t, a_t)$}
\noindent
\begin{proof}
In this case,

\[
    \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s' \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \leq 1 - P(s_{t+1} \mid s_t, a_t)
\]

and so
\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \geq \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} - \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s' \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}= P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - (1 - P(s_{t+1} \mid s_t, a_t))
\]

If we can show that there exists a $\theta$ such that

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - (1 - P(s_{t+1} \mid s_t, a_t))
\]

and $\theta$ satisfies the constraints in the optimisation problem, we know that this results in the minimum possible counterfactual transition probability for $\tilde{P}_t(\tilde{s}' \mid \tilde{s}, \tilde{a})$. We can assign $\theta$ as follows:

%
%
%
%
%
%
%
%

\[
\begin{cases}
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}= P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - (1 - P(s_{t+1} \mid s_t, a_t))\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 1 - P(\tilde{s}' \mid \tilde{s}, \tilde{a})\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = 1 - P(s_{t+1} \mid s_t, a_t)\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 0\\
\end{cases}
\]

This assignment of $\theta$ satisfies the constraints of the linear optimisation problem, as follows:

%
%
%
%
%
%
%
%
%
%

\begin{itemize}        
    \item $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1}}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = P(s_{t+1} \mid s_t, a_t)$ \\satisfying \eqref{proofeq:interventional constraint}.

    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} =1 -
    P(s_{t+1} \mid s_t, a_t)$ satisfying \eqref{proofeq:interventional constraint}.
    
    \item $\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})$ satisfying \eqref{proofeq:interventional constraint}.
    
    \item $\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} \\= 1 - P(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}P(s' \mid \tilde{s}, \tilde{a})$, therefore it is possible to assign $\theta$ such that $\forall s' \in \mathcal{S}\setminus\{\tilde{s}'\}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$ satisfying \eqref{proofeq:interventional constraint}.
    
    \item Mon1 \eqref{proofeq:monotonicity1}, Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} are all vacuously true for all transitions from $(\tilde{s}, \tilde{a})$ due to Lemma \ref{lemma: constraints do not apply if disjoint}.

    \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
    
    \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \\+ \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 1$, satisfying \eqref{proofeq:valid prob2}.
\end{itemize}

All the constraints are satisfied, so this is a valid assignment of $\theta$ for this state-action pair. Therefore,
 \[\tilde{P}_{t}^{LB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \dfrac{\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)}= \frac{P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - (1 - P(s_{t+1} \mid s_t, a_t))}{P(s_{t+1} \mid s_t, a_t)}\]
\end{proof}

\paragraph{Case 2: $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) \leq 1- P(s_{t+1} \mid s_t, a_t)$}
\begin{proof}
In this case,

\[
    \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s' \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \leq P(\tilde{s}' \mid \tilde{s}, \tilde{a})
\]

and so
\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \geq \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} - \sum_{s' \in \mathcal{S}\setminus{\{s_{t+1}\}}}\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s' \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}= P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - P(\tilde{s}' \mid \tilde{s}, \tilde{a}) = 0
\]

If we can show that there exists a $\theta$ such that

\[
\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = 0
\]

and $\theta$ satisfies the constraints in the optimisation problem, we know that this results in the minimum possible counterfactual transition probability for $\tilde{P}_t(\tilde{s}' \mid \tilde{s}, \tilde{a})$. We can assign $\theta$ as follows:

\[
\begin{cases}
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}= 0\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = P(s_{t+1} \mid s_t, a_t)\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})\\
    \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 1 - P(s_{t+1} \mid s_t, a_t) - P(\tilde{s}' \mid \tilde{s}, \tilde{a})\\
\end{cases}
\]

This assignment of $\theta$ satisfies the constraints of the linear optimisation problem, as follows:

\begin{itemize}        
    \item $\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1}}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = P(s_{t+1} \mid s_t, a_t)$ \\satisfying \eqref{proofeq:interventional constraint}.

    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} =1 -
    P(s_{t+1} \mid s_t, a_t)$ satisfying \eqref{proofeq:interventional constraint}.
    
    \item $\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})$ satisfying \eqref{proofeq:interventional constraint}.
    
    \item $\sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}\sum_{\substack{u_t \in U_t \\f(\tilde{s}, \tilde{a}, u_t) = s'}} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} \\= 1 - P(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}P(s' \mid \tilde{s}, \tilde{a})$, therefore it is possible to assign $\theta$ such that $\forall s' \in \mathcal{S}\setminus\{\tilde{s}'\}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} = P(s' \mid \tilde{s}, \tilde{a})$ satisfying \eqref{proofeq:interventional constraint}.
    
    \item Mon1 \eqref{proofeq:monotonicity1}, Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} are all vacuously true for all transitions from $(\tilde{s}, \tilde{a})$ due to Lemma \ref{lemma: constraints do not apply if disjoint}.

    \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$, satisfying \eqref{proofeq:valid prob1}.
    
    \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} + \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \\+ \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) \neq s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) \neq \tilde{s}'}} \theta_{u_t} = 1$, satisfying \eqref{proofeq:valid prob2}.
\end{itemize}

All the constraints are satisfied, so this is a valid assignment of $\theta$ for this state-action pair. Therefore,

\[\tilde{P}_{t}^{LB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = \dfrac{\sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)}= \frac{0}{P(s_{t+1} \mid s_t, a_t)} =0\]

\end{proof}
These two cases can be combined as follows:

\[\tilde{P}_{t}^{LB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = 
\begin{cases}
\frac{P(\tilde{s}' \mid \tilde{s}, \tilde{a}) - (1 - P(s_{t+1} \mid s_t, a_t))}{P(s_{t+1} \mid s_t, a_t)} & \text{if $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) > 1 - P(s_{t+1} \mid s_t, a_t)$}\\
0 & \text{otherwise}\\
\end{cases}
\]
for all next states $\tilde{s}' \in \mathcal{S}$.
\end{proof}