\subsection{Counterfactual Transition Probability Bounds}
\label{sec: probability bounds proof}

In this section, we prove that the above optimisation problem reduces to the exact analytical bounds for counterfactual transition probabilities given in Section \ref{sec: bounds}, for any MDP $\mathcal{M}$.

\begin{theorem}
    For any MDP $\mathcal{M}$ and path $\tau$, the optimisation problem defined in \eqref{proofeq:objective}-\eqref{proofeq:valid prob2} reduces to the exact analytical bounds given in Theorems \ref{theorem: observed state}-\ref{theorem:ub overlapping} for the counterfactual transition probabilities of every transition in $\mathcal{M}$.
\end{theorem}

For any state-action pair $(\tilde{s}, \tilde{a})$ in $\mathcal{M}$, the counterfactual probabilities for all transitions from $(\tilde{s}, \tilde{a})$ depend only on the other transitions from $(\tilde{s}, \tilde{a})$, and the observed state-action pair $(s_t, a_t)$ (as shown in the equation for calculating counterfactual probabilities, \eqref{eq: counterfactual probability}). Since $P(s_{t+1} \mid s_t, a_t)$ is fixed, the counterfactual probability of each transition $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$ only depends on 

\[\sum_{u_t = 1}^{|U_t|} \mu_{s, a, u_t, s'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} = \sum_{\substack{u_t \in U_t \\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}\]
We need to prove that the constraints of the optimisation problem hold for \textit{all} state-action pairs in the MDP. We will use induction to show that new values of the state-action pairs can be added to the causal model (while adjusting $\theta$ to meet the constraints for the new pair) without affecting whether the constraints for previously included pairs are satisfied.

Therefore, if we can derive and prove closed-form solutions for the probability bounds for transitions from each state-action pair independently, we know that we can combine these solutions to produce a valid assignment of $\theta$ across all pairs (e.g., by taking the upper bound of one transition with non-zero probability from all state-action pairs). Section \ref{sec: probability bounds induction} contains the inductive proof, and Section \ref{sec: probability bounds cases} provides the closed-form solutions.

\input{proof-sections/probability-bounds-inductive-proof}

\pagebreak
\subsubsection{Closed-form Probability Bounds}
\label{sec: probability bounds cases}

For compactness in the proofs, we adjust the notation of the optimisation problem in \eqref{proofeq:objective}-\eqref{proofeq:valid prob2} as follows. $\forall s,s' \in \mathcal{S}, \forall a \in \mathcal{A}, \forall u_t \in U_t$

\begin{equation}
    \begin{aligned}
    \sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s},\tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}
    &= \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1}}} \mu_{\tilde{s},\tilde{a}, u_t, \tilde{s}'} \cdot \theta_{u_t} \text{ (by def, $\mu_{s_t, a_t, u_t, s_{t+1}} = 1 \iff f(s_t, a_t, u_t) = s_{t+1}$)}\\
    &= \sum_{\substack{u_t \in U_t\\ f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t} \text{ (by def, $\mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} = 1 \iff f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'$)}\\
\end{aligned}
\end{equation}

%

%

Take an arbitrary transition $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$ from the MDP. We need to consider the minimum/maximum possible value of 
$\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}} \theta_{u_t}$ 
to find the lower and upper bounds, subject to the following constraints over the state-action pair, $(\tilde{s}, \tilde{a})$:

\begin{itemize}
    \item $\forall \tilde{s}' \in \mathcal{S}, \sum_{\substack{u_t \in U_t \\ f(\tilde{s}, \tilde{a}, u_t) = \tilde{s}'}}{\theta_{u_t}} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})$ to satisfy \eqref{proofeq:interventional constraint}
    \item $\tilde{P}_t(s_{t+1} \mid \tilde{s}, \tilde{a}) \geq P(s_{t+1} \mid \tilde{s}, \tilde{a})$ to satisfy Mon1 \eqref{proofeq:monotonicity1}
    \item $\forall s' \in \mathcal{S}\setminus \{s_{t+1} \}, \tilde{P}_t(s' \mid \tilde{s}, \tilde{a}) \leq P(s' \mid \tilde{s}, \tilde{a})$ to satisfy Mon2 \eqref{proofeq:monotonicity2}
    \item $\forall \tilde{s}' \in \mathcal{S}, \tilde{P}_t(\tilde{s}' \mid \tilde{s}, \tilde{a})$ satisfies CS \eqref{proofeq:counterfactual stability}
    \item $0 \leq \theta_{u_t} \leq 1, \forall u_t$ \eqref{proofeq:valid prob1}
    \item $\sum_{u_t = 1}^{|U_t|} \theta_{u_t} = 1$ \eqref{proofeq:valid prob2}
\end{itemize}

From \eqref{proofeq:interventional constraint}, we also derive the following constraints over the state-action pair $(s_t, a_t)$,  which must hold when calculating the counterfactual probability bounds for every state-action pair.

\begin{itemize}
    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1}}}{\theta_{u_t}} = P(s_{t+1} \mid s_t, a_t)$ to satisfy \eqref{proofeq:interventional constraint}
    \item $\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) \neq s_{t+1}}}{\theta_{u_t}} = \sum_{s' \in \mathcal{S}\setminus \{s_{t+1} \}} P(s' \mid s_t, a_t) = 1 - P(s_{t+1} \mid s_t, a_t)$ to satisfy \eqref{proofeq:interventional constraint}
\end{itemize}

Consider the following distinct cases:
\textbf{\begin{enumerate}
    \item $(\tilde{s}, \tilde{a}) = (s_t, a_t)$
    \item $(\tilde{s}, \tilde{a}) \neq (s_t, a_t)$ and $(\tilde{s}, \tilde{a})$ has disjoint support with $(s_t, a_t)$
    \item $(\tilde{s}, \tilde{a}) \neq (s_t, a_t)$, $(\tilde{s}, \tilde{a})$ has overlapping support with $(s_t, a_t)$
\end{enumerate}}

These cases are disjoint, and cover all possible state-action pairs.

\pagebreak
\input{proof-sections/observed_state-action_pair}

\subsubsection{CF Bounds for Disjoint $(\tilde{s}, \tilde{a})$}
\input{proof-sections/disjoint_support_proofs}


\pagebreak
\subsubsection{CF Bounds for $(\tilde{s}, \tilde{a})$ with Overlapping Support with $(s_t, a_t)$}
\input{proof-sections/overlapping_support_proofs}