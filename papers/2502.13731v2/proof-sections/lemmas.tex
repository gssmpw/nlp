\subsection{Lemmas}
\begin{lemma}\label{lemma: constraints do not apply if disjoint}
If $(s_t, a_t)$ and $(\tilde{s}, \tilde{a})$ have disjoint support, the monotonicity constraints \eqref{proofeq:monotonicity1} and \eqref{proofeq:monotonicity2} and counterfactual stability \eqref{proofeq:counterfactual stability} will be satisfied for all possible counterfactual transition probabilities for transitions from $(\tilde{s}, \tilde{a})$.
\end{lemma}

\begin{proof}
Because $(s_t, a_t)$ and $(\tilde{s}, \tilde{a})$ have disjoint support, $P(s_{t+1} \mid \tilde{s}, \tilde{a}) = 0$ and, for all $\tilde{s}'$ where $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) > 0$, $P(\tilde{s}' \mid s_t, a_t) = 0$. This is because for all $\tilde{s}'$ where $P(\tilde{s}' \mid s_t, a_t) > 0$, $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) = 0$, and, for all $\tilde{s}'$ where $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) > 0$, $P(\tilde{s}' \mid s_t, a_t) = 0$. 
Because for all $\tilde{s}'$ where $P(\tilde{s}' \mid \tilde{s}, \tilde{a}) > 0$, $P(\tilde{s}' \mid s_t, a_t) = 0$, CS \eqref{proofeq:counterfactual stability} and Mon2 \eqref{proofeq:monotonicity2} will be vacuously true for all transitions from $(\tilde{s}, \tilde{a})$. Also, because $P(s_{t+1} \mid \tilde{s}, \tilde{a}) = 0$, Mon1 \eqref{proofeq:monotonicity1} is vacuously true.
\end{proof}

\begin{lemma}
\label{lemma:absolute max cf prob}
For any observed transition $s_t, a_t \rightarrow s_{t+1}$ and counterfactual transition $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$:
\[
    \sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} \leq \min(P(s_{t+1} \mid s_t, a_t), P(\tilde{s}' \mid \tilde{s}, \tilde{a}))
\]
\end{lemma}

\begin{proof}
From our interventional probability constraints \eqref{proofeq:interventional constraint}, we have:

\begin{equation}
    \label{eq: lemma 4.2 constraint 1}
   \sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} = P(s_{t+1} \mid s_t, a_t) 
\end{equation}

and

\begin{equation}
    \label{eq: lemma 4.2 constraint 2}
   \sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'}\cdot \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a}) 
\end{equation}

$\mu_{\tilde{s}, \tilde{a}, u, \tilde{s}'} \in \{0, 1\}$ (from its definition). $\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}$ is maximal when the probability assigned to all $u_t$ where $\mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} = 1$ and $\mu_{s_t, a_t, u_t, s_{t+1}}=1$ is maximal.

\[
\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot (\mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}) \leq \sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} = P(s_{t+1} \mid s_t, a_t)
\]

\[
\sum_{u_t = 1}^{|U_t|} (\mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \theta_{u_t}) \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \leq \sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'}\cdot \theta_{u_t} = P(\tilde{s}' \mid \tilde{s}, \tilde{a})
\]

 Because of Eq. \eqref{eq: lemma 4.2 constraint 1} and Eq. \eqref{eq: lemma 4.2 constraint 2}, the probability assigned to all $u_t$ where $\mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} = 1$ and $\mu_{s_t, a_t, u_t, s_{t+1}}=1$ cannot be greater than $P(s_{t+1} \mid s_t, a_t)$ or $P(\tilde{s}' \mid \tilde{s}, \tilde{a})$. Therefore,

\[
\sum_{u_t = 1}^{|U_t|} \mu_{\tilde{s}, \tilde{a}, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t} \leq \min(P(s_{t+1} \mid s_t, a_t), P(\tilde{s}' \mid \tilde{s}, \tilde{a}))
\]

%

This also means that the upper bound of any counterfactual transition probability \\$\tilde{P}_t^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) \leq \dfrac{\min(P(\tilde{s}' \mid \tilde{s}, \tilde{a}), P(s_{t+1} \mid s_t, a_t))}{P(s_{t+1} \mid s_t, a_t)}$.
\end{proof}

\begin{lemma}
    \label{lemma: CF probs of observed state-action pair}
    For any observed transition $s_t, a_t \rightarrow s_{t+1}$, $\tilde{P}_{t}(s_{t+1} \mid s_t, a_t) = 1$ and, $\forall \tilde{s}' \in \mathcal{S}$ where $\tilde{s}' \in \mathcal{S}\setminus \{s_{t+1}\}$, $\tilde{P}_{t}(\tilde{s}' \mid s_t, a_t) = 0$.
\end{lemma}

\begin{proof}
From \eqref{eq: counterfactual probability}, we have:
    \begin{align*}
      \tilde{P}_{t}(s_{t+1} \mid s_t, a_t)
      &= \frac{\sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} 
      \\ &= \frac{\sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)}
      \\ &= \frac{P(s_{t+1} \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)}
      \tag{from the interventional probability constraint \eqref{proofeq:interventional constraint}}
      \\ &= 1 \tag{since $s_t, a_t \rightarrow s_{t+1}$ was observed, $P(s_{t+1} \mid s_t, a_t) > 0$}
    \end{align*}

    \begin{align*}
      \tilde{P}_{t}(\tilde{s}' \mid s_t, a_t)
      &= \frac{\sum_{u_t = 1}^{|U_t|} \mu_{s_t, a_t, u_t, \tilde{s}'} \cdot \mu_{s_t, a_t, u_t, s_{t+1}} \cdot \theta_{u_t}}{P(s_{t+1} \mid s_t, a_t)} 
      \\ &=\frac{0}{P(s_{t+1} \mid s_t, a_t)}
      \tag{since at most one of $\mu_{s_t, a_t, u_t, \tilde{s}'}$ and $\mu_{s_t, a_t, u_t, s_{t+1}}$ can equal 1}
      \\ &= 0 \tag{since $s_t, a_t \rightarrow s_{t+1}$ was observed, $P(s_{t+1} \mid s_t, a_t) > 0$}
    \end{align*}

    These results are as expected, because, given the same exogenous noise and input, we must get the same output in the counterfactual world.
\end{proof}

\begin{lemma}
\label{lemma: existence of theta for overlapping case.}
Take an arbitrary counterfactual state-action pair $(\tilde{s}, \tilde{a})$ and observed state-action pair from an MDP, where $(\tilde{s}, \tilde{a}) \neq (s_t, a_t)$ and $(\tilde{s}, \tilde{a})$ has overlapping support with $(s_t, a_t)$ and $P(s_{t+1} \mid \tilde{s}, \tilde{a}) < P(s_{t+1} \mid s_t, a_t)$. Let $s_{t+1}$ be the observed next state. It can be shown that:

\[\max_{\theta} \left(\sum_{s' \in \mathcal{S}\setminus \{s_{t+1}\}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \geq P(s_{t+1} \mid s_t, a_t) - P(s_{t+1} \mid \tilde{s}, \tilde{a})\right)\]
\end{lemma}
\begin{proof}
First, let $S_{CS} \subset \mathcal{S}$ be the set of states $s'\in S_{CS}$ which must have a counterfactual transition probability $\tilde{P}_{t}(s' \mid \tilde{s}, \tilde{a}) = 0$ because of the counterfactual stability constraint (i.e., where $\forall s' \in S_{CS}, \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}>\dfrac{P(s' \mid \tilde{s}, \tilde{a})}{P(s' \mid s_t, a_t)}$ and $P(s' \mid s_t, a_t) > 0$). Consider the total interventional probability of across all states $s'\in S_{CS}$. $\forall s' \in S_{CS}$:

\begin{align*}
    \dfrac{P(s' \mid \tilde{s}, \tilde{a})}{P(s' \mid s_t, a_t)} &< \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} \text{  (from CS \eqref{proofeq:counterfactual stability})}\\
    P(s' \mid \tilde{s}, \tilde{a}) &< \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a}) \cdot P(s' \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)}
\end{align*}

The sum of the interventional probabilities of these transitions is:

\[
    \sum_{s' \in S_{CS}}P(s' \mid \tilde{s}, \tilde{a}) \leq \sum_{s' \in S_{CS}}\dfrac{P(s'\mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}
\]

Let $S_{other}$ be the set of all other states $s' \in \mathcal{S}\setminus{\{s_{t+1}\}\cup S_{CS}}$. We can calculate the sum of the interventional probabilities of the transitions going to states $s' \in S_{other}$:

\begin{align*}
    \sum_{s' \in S_{other}}P(s' \mid \tilde{s}, \tilde{a}) &= 1 - P(s_{t+1} \mid \tilde{s}, \tilde{a}) - \sum_{s'' \in S_{CS}}P(s'' \mid \tilde{s}, \tilde{a})\\
    &\geq 1 - P(s_{t+1} \mid \tilde{s}, \tilde{a}) - \sum_{s'' \in S_{CS}}\dfrac{P(s'' \mid s_t, a_t) \cdot P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\\
    &= 1 - P(s_{t+1} \mid \tilde{s}, \tilde{a}) - \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\cdot\sum_{s'' \in S_{CS}}P(s'' \mid s_t, a_t)\\
    &= 1 - P(s_{t+1} \mid \tilde{s}, \tilde{a}) \\&- \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\cdot(1 - P(s_{t+1} \mid s_t, a_t) - \sum_{s' \in S_{other}}P(s' \mid s_t, a_t))\\
    &= 1 - P(s_{t+1} \mid \tilde{s}, \tilde{a}) - \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\\ &+ P(s_{t+1} \mid \tilde{s}, \tilde{a}) + \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a}) \cdot \sum_{s' \in S_{other}}P(s' \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)}\\
    &= 1 - \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)} + \dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a}) \cdot \sum_{s' \in S_{other}}P(s' \mid s_t, a_t)}{P(s_{t+1} \mid s_t, a_t)}
\end{align*}

Because of the Mon2 \eqref{proofeq:monotonicity2} and CS \eqref{proofeq:counterfactual stability} constraints, we know that $\forall s'' \in S_{CS}, \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s''}}{\theta_{u_t}} =0$, and $s' \in S_{other}, \sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}} \leq P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)$. So,

\[\max_{\theta}\left(\sum_{s'' \in S_{CS}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s''}}{\theta_{u_t}}\right) = 0
\]
\[\max_{\theta}\left(\sum_{s' \in S_{other}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}}\right) \leq \sum_{s' \in S_{other}}P(s' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)\]

Therefore, the maximum $\sum_{s' \in \mathcal{S}\setminus \{s_{t+1}\}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}}$ is as follows:

\begin{equation}
    \begin{aligned}
        \max_{\theta}\left(\sum_{s' \in \mathcal{S}\setminus \{s_{t+1}\}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}}\right) &= \max_{\theta}\left(\sum_{s'' \in S_{CS}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s''}}{\theta_{u_t}}\right) + \max_{\theta}\left(\sum_{s' \in S_{other}}\sum_{\substack{u_t \in U_t\\f(s_t, a_t, u_t) = s_{t+1} \\ f(\tilde{s}, \tilde{a}, u_t) = s'}}{\theta_{u_t}}\right)\\
        &= \sum_{s' \in S_{other}}P(s'' \mid \tilde{s}, \tilde{a}) \cdot P(s_{t+1} \mid s_t, a_t)\\
        &\geq P(s_{t+1} \mid s_t, a_t) - P(s_{t+1} \mid \tilde{s}, \tilde{a}) + P(s_{t+1} \mid \tilde{s}, \tilde{a}) \cdot \sum_{s' \in S_{other}}P(s' \mid s_t, a_t)\\
        &\geq P(s_{t+1} \mid s_t, a_t) - P(s_{t+1} \mid \tilde{s}, \tilde{a})
    \end{aligned}
\end{equation} 
\end{proof}