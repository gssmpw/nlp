To enhance readability, we split the proof for Theorem \ref{theorem:ub overlapping} into two separate theorems: Theorem \ref{proof theorem:ub overlapping} proves the upper counterfactual probability bounds, and Theorem \ref{proof theorem:lb overlapping} proves the lower counterfactual probability bounds.

\begin{theorem}
\label{proof theorem:ub overlapping}
For outgoing transitions from state-action pairs $(\tilde{s}, \tilde{a})$ which have overlapping support with the observed $(s_t, a_t)$, but $(\tilde{s}, \tilde{a}) \neq (s_t, a_t)$, the linear program will produce an upper bound of:

\[\tilde{P}_{t}^{UB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) =
\begin{cases}
\dfrac{\min(P(s_{t+1} \mid s_t, a_t), P(s_{t+1} \mid \tilde{s}, \tilde{a}))}{P(s_{t+1} \mid s_t, a_t)} & \text{if $\tilde{s}' = s_{t+1}$}\\
0 & \text{if $P(\tilde{s}' \mid s_t, a_t) > 0$} \\ & \text{and $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}>\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$}\\
\min(P(\tilde{s}' \mid \tilde{s}, \tilde{a}), 1 - P(s_{t+1} \mid \tilde{s}, \tilde{a})) & \text{if $P(\tilde{s}' \mid s_t, a_t) > 0$}\\
\min(1 - P(s_{t+1} \mid \tilde{s}, \tilde{a}), \dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}) & \text{otherwise}\\
\end{cases}
\]
for all possible next states $\tilde{s}'$.
\end{theorem}

\begin{proof} 
Take an arbitrary transition $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$ where $(\tilde{s}, \tilde{a})$ has overlapping support with the observed state-action pair $(s_t, a_t)$ (and $(\tilde{s}, \tilde{a}) \neq (s_t, a_t)$). Consider the following distinct cases:
\begin{itemize}
    \item $\tilde{s}' = s_{t+1}$
    \item $\tilde{s}' \neq s_{t+1}$, $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}>\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$ and $P(\tilde{s}' \mid s_t, a_t) > 0$
    \item $\tilde{s}' \neq s_{t+1}$, $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\leq\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$ and $P(\tilde{s}' \mid s_t, a_t) >0$
    \item $\tilde{s}' \neq s_{t+1}$ and $P(\tilde{s}' \mid s_t, a_t) =0$
\end{itemize}
These cases are disjoint and cover all possible situations.

\input{proof-sections/overlapping_support_proofs_ub_case1}

\input{proof-sections/overlapping_support_proofs_ub_case2}

\input{proof-sections/overlapping_support_proofs_ub_case3}

\input{proof-sections/overlapping_support_proofs_ub_case4}

We have proven all the cases for Theorem \ref{proof theorem:ub overlapping}, therefore Theorem \ref{proof theorem:ub overlapping} holds.

\end{proof}

\pagebreak
\begin{theorem}
\label{proof theorem:lb overlapping}
For outgoing transitions from state-action pairs $(\tilde{s}, \tilde{a})$ which have overlapping support with the observed $(s_t, a_t)$, but $(\tilde{s}, \tilde{a}) \neq (s_t, a_t)$, the linear program will produce a lower bound of:

\[\tilde{P}_{t}^{LB}(\tilde{s}' \mid \tilde{s}, \tilde{a}) = 
\begin{cases}
\max(P(\tilde{s}' \mid \tilde{s}, \tilde{a}), 1 - \sum_{s' \in \mathcal{S}\setminus\{s_{t+1}\}}{\tilde{P}_{t}^{UB}(s' \mid \tilde{s}, \tilde{a})}) & \text{if $\tilde{s}' = s_{t+1}$}\\
0 & \text{if $P(\tilde{s}' \mid s_t, a_t) > 0$} \\ & \text{and $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}>\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$}\\
\max(0, 1 - \sum_{s' \in \mathcal{S}\setminus\{\tilde{s}'\}}{\tilde{P}_{t}^{UB}(s' \mid \tilde{s}, \tilde{a})}) & \text{otherwise}\\
\end{cases}
\]
\end{theorem}

\begin{proof}
Take an arbitrary transition $\tilde{s}, \tilde{a} \rightarrow \tilde{s}'$ where $(\tilde{s}, \tilde{a})$ has overlapping support with the observed state-action pair $(s_t, a_t)$. Consider the following disjoint cases:

\begin{itemize}
    \item $\tilde{s}' = s_{t+1}$
    \item $\tilde{s}' \neq s_{t+1}$, $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}>\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$ and $P(\tilde{s}' \mid s_t, a_t) > 0$
    \item $\tilde{s}' \neq s_{t+1}$, and $\dfrac{P(s_{t+1} \mid \tilde{s}, \tilde{a})}{P(s_{t+1} \mid s_t, a_t)}\leq\dfrac{P(\tilde{s}' \mid \tilde{s}, \tilde{a})}{P(\tilde{s}' \mid s_t, a_t)}$ or $P(\tilde{s}' \mid s_t, a_t) = 0$
\end{itemize}

These cases are disjoint and cover all possible situations.

\input{proof-sections/overlapping_support_proofs_lb_case1}

\input{proof-sections/overlapping_support_proofs_lb_case2}

\input{proof-sections/overlapping_support_proofs_lb_case3}

We have proven all the cases for Theorem \ref{proof theorem:lb overlapping}, therefore Theorem \ref{proof theorem:lb overlapping} holds.

\end{proof}