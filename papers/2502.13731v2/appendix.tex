%
%

\section{Explanation of Unintuitive Counterfactual Probabilities Produced by Gumbel-max SCMs}
\label{app: unintuitive probs explanation}

Take the example MDP from Figure \ref{fig:gumbel-max-scm-unintuitive-probs}, which contains three states and a single action. In this example, we observe the transition $s_t=0, a_t=0 \rightarrow s_{t+1}=1$. Neither state 0 nor state 2 was observed, although both were possible. This means that the observed transition gives us no information as to whether state 0 or state 2 would have been more likely where, counterfactually, $s_t = 1$, so intuitively these counterfactual probabilities should be equal to the nominal probabilities. However, the Gumbel-max SCM scales the probabilities, making state 2 even more likely than in the nominal MDP, and vice versa for state 0. This happens because the Gumbel distributions that the Gumbel values are drawn from for each transition are truncated in proportion to the log probability of the transition's nominal probability (instead of in proportion to their nominal probabilities).

\begin{figure}[h]
    \centering
    \begin{minipage}[b]{0.4\textwidth}
        \centering
                \resizebox{1.0\textwidth}{!}{%
            \begin{circuitikz}
            \tikzstyle{every node}=[font=\LARGE]
            \draw  (10.75,18.5) circle (1.25cm) node {\LARGE $s_1$} ;
            \draw [ fill={rgb,255:red,177; green,170; blue,170} ] (4.25,18.5) circle (1.25cm) node {\LARGE $s_0$} ;
            \draw  (16.75,18.5) circle (1.25cm) node {\LARGE $s_2$} ;
            \draw [ fill={rgb,255:red,177; green,170; blue,170} ] (10.75,14.75) circle (1.25cm) node {\LARGE $s_1$} ;
            \draw  (4.25,14.75) circle (1.25cm) node {\LARGE $s_0$} ;
            \draw  (16.75,14.75) circle (1.25cm) node {\LARGE $s_2$} ;
            \draw [->, >=Stealth] (4.25,17.25) -- (4.25,16)node[pos=0.5, fill=white]{0.3};
            \draw [->, >=Stealth] (16.75,17.25) -- (16.75,16)node[pos=0.5, fill=white]{1.0};
            \draw [->, >=Stealth] (10,17.5) -- (5.5,15);
            \draw [->, >=Stealth] (11.5,17.5) -- (15.5,15);
            \draw [->, >=Stealth] (5.25,17.75) -- (15.5,14.75);
            \draw [->, >=Stealth] (5,17.5) -- (9.5,14.75);
            \node [font=\LARGE] at (5.75,16.5) {0.4};
            \node [font=\LARGE] at (9,17.5) {0.4};
            \node [font=\LARGE] at (6.75,17.75) {0.3};
            \node [font=\LARGE] at (12.5,17.5) {0.6};
            \end{circuitikz}
        }%
        \caption{Example of MDP where Gumbel-Max produces unintuitive CF probabilities. The observed path $s_0 \rightarrow s_1$ is highlighted in grey.}
    \end{minipage}
    \hfill
    \begin{minipage}[b]{0.55\textwidth}
        \centering
        \captionof{table}{Counterfactual transition probabilities produced by the optimisation in \eqref{eq: optimisation} (without assumptions) vs. probabilities produced by Gumbel-max SCM \eqref{eq:cf_mdp_probs} vs. the optimisation in \eqref{eq: optimisation} with the additional assumptions in \eqref{eq: additional assumptions}.}
        \small
        \resizebox{1.0\textwidth}{!}{ %
             \begin{tabular}{|c|c|c|c|cc|c|cc|}
\hline
\multirow{2}{*}{\textbf{$s$}} & \multirow{2}{*}{\textbf{$a$}} & \multirow{2}{*}{\textbf{$s'$}} & \multirow{2}{*}{\textbf{$P(s' \mid s, a)$}}& \multicolumn{2}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}Optimisation\\ \eqref{eq: optimisation}\end{tabular}}} & \multirow{2}{*}{\textbf{\begin{tabular}[c]{@{}c@{}}Gumbel-\\Max \eqref{eq:cf_mdp_probs}\end{tabular}}} & \multicolumn{2}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}Optimisation\\ \eqref{eq: optimisation} + \eqref{eq: additional assumptions}\end{tabular}}} \\ \cline{5-6} \cline{8-9} 
                                &                                 &                 &                     & \multicolumn{1}{c|}{\textbf{LB}}                             & \textbf{UB}                            &                                      & \multicolumn{1}{c|}{\textbf{LB}}                              & \textbf{UB}                             \\ \hline
0                               & 0                               & 0      & 0.3                             & \multicolumn{1}{c|}{0.0}                                     & 0.0                                    & 0.0                                  & \multicolumn{1}{c|}{0.0}                                      & 0.0                                     \\ \hline
0                               & 0                               & 1      & 0.4                             & \multicolumn{1}{c|}{1.0}                                     & 1.0                                    & 1.0                                  & \multicolumn{1}{c|}{1.0}                                      & 1.0                                     \\ \hline
0                               & 0                               & 2      & 0.3                              & \multicolumn{1}{c|}{0.0}                                     & 0.0                                    & 0.0                                  & \multicolumn{1}{c|}{0.0}                                      & 0.0                                     \\ \hline
1                               & 0                               & 0           & 0.4                        & \multicolumn{1}{c|}{0.0}                                     & 1.0                                    & 0.35                                 & \multicolumn{1}{c|}{0.4}                                      & 0.4                                     \\ \hline
1                               & 0                               & 1      & 0.0                             & \multicolumn{1}{c|}{0.0}                                     & 0.0                                    & 0.0                                  & \multicolumn{1}{c|}{0.0}                                      & 0.0                                     \\ \hline
\textbf{1}                      & \textbf{0}                      & \textbf{2}          & \textbf{0.6}                & \multicolumn{1}{c|}{\textbf{0.0}}                            & \textbf{1.0}                           & \textbf{0.65}                        & \multicolumn{1}{c|}{\textbf{0.6}}                             & \textbf{0.6}                            \\ \hline
2                               & 0                               & 0       & 0.0                            & \multicolumn{1}{c|}{0.0}                                     & 0.0                                    & 0.0                                  & \multicolumn{1}{c|}{0.0}                                      & 0.0                                     \\ \hline
2                               & 0                               & 1       & 0.0                            & \multicolumn{1}{c|}{0.0}                                     & 0.0                                    & 0.0                                  & \multicolumn{1}{c|}{0.0}                                      & 0.0                                     \\ \hline
2                               & 0                               & 2      & 1.0                             & \multicolumn{1}{c|}{1.0}                                     & 1.0                                    & 1.0                                  & \multicolumn{1}{c|}{1.0}                                      & 1.0                                     \\ \hline
\end{tabular}
            }
    \end{minipage}
\end{figure}

\include{proofs}

\section{Training Details}
\label{app: training details}
Our algorithm was executed on a 128-core machine with an Intel Xeon CPU and 512 GB RAM. The interval CFMDP generation part of the algorithm is implemented in Python 3.10, and the value iteration algorithm over the interval CFMDP was implemented in Julia 1.9.4, using the Julia Interval MDP package (v.0.2.1) \citep{mathiesen2024intervalmdp}. Most of the algorithm was run single-threaded, except for generating the Sepsis interval CFMDP and Sepsis Gumbel-max SCM CFMDP, which were run in parallel. 10 threads were needed to generate the Sepsis interval CFMDP, and 32 threads were required to calculate the Gumbel-max SCM CFMDP.

%
%
%
%
%
%