\subsection{Random Discretization}
\label{sec:mainargs}
We now set out to prove Lemma~\ref{lem:subgoal}. So let $0 < \delta < 1$, and fix a pair $(\Gamma_i, L_j)$. Following the proof outline in Section~\ref{sec:overview}, we now consider the following random discretization of hypotheses in $\subH(\Gamma_i, L_j)$: Let $k= k(i,j)$ be an integer parameter to be determined. Sample a random $k \times d$ matrix $\rA$ with each entry $\Norm(0,1/k)$ distributed as well as $k$ random offsets $\rt = (\rt_1,\dots,\rt_k)$ all independent and uniformly distributed in $[0,1]$.

Let $\Disc$ be the set of all vectors in $\R^k$ with coordinates in 
\[
\{(1/2)(10 \sqrt{k})^{-1} + z (10 \sqrt{k})^{-1}  \mid z \in \Ints\}.
\]
For $w \in \finalH$ and an outcome $(A,t)$ of $(\rA,\rt)$, define $h_{A,t}(w) \in \Disc$ as the vector obtained as follows: Consider each coordinate $(Aw)_i$ and let $z_i$ denote the integer such that 
\[
(1/2)(10 \sqrt{k})^{-1}  + z_i (10 \sqrt{k})^{-1} \leq (Aw)_i < (1/2)(10 \sqrt{k})^{-1}  + (z_i+1) (10\sqrt{k})^{-1}.
\]
Let $(h_{A,t}(w))_i$ equal $(1/2)(10 \sqrt{k})^{-1} + z_i (10\sqrt{k})^{-1}$ if $t_i \leq p(z_i)$ ($(Aw)_i$ rounded down) and otherwise let it equal $(1/2)(10 \sqrt{k})^{-1}  + (z_i + 1)(10\sqrt{k})^{-1}$. We choose $p(z_i) \in [0,1]$ such that 
\begin{align}
(Aw)_i &= 
p(z_i)\left(\frac{1}{2 \cdot 10 \sqrt{k}} +\frac{z_i}{10\sqrt{k}}\right) + (1-p(z_i))\left(\frac{1}{2 \cdot 10 \sqrt{k}} +\frac{z_i+1}{10\sqrt{k}}\right) \label{eq:expectround}
\end{align}
i.e.\ for fixed $A$, the expected value of the coordinates satisfy $\E_{\rt}[(h_{A,\rt}(w))_i]=(Aw)_i$. 
\begin{remark}
\label{rmk:pIsProb}
The value $p(z_i)$ satisfying~\eqref{eq:expectround} has $p(z_i) \in [0,1]$.
\end{remark}
We thus have that $p(z_i)$ is a well-defined probability. We prove Remark~\ref{rmk:pIsProb} in Appendix~\ref{sec:aux}. The random discretization has the desirable property that it approximately preserves margins/inner products as stated in the following
\begin{lemma}
\label{lem:concdiscretize}
    There is a constant $c>0$, such that for any integer $k \geq 1$, $w \in \finalH, x \in \finalX$ and any $\gamma \in (0,1]$, it holds that 
    $
    \Pr_{\rA,\rt}[|\langle h_{\rA,\rt}(w),\rA x\rangle - \langle w, x\rangle| > \gamma] < c\exp(-\gamma^2 k/c)
    $.
\end{lemma}
The proof of Lemma~\ref{lem:concdiscretize} follows the work by~\cite{AK17} in their work on lower bounds for the Johnson-Lindenstrauss transform, and has thus been deferred to Appendix~\ref{sec:aux}. We now observe that
\begin{align*}
    \Loss_{\cD}(w) &= \Loss^{\gamma_i/2}_{\rA \cD}(h_{\rA,\rt}(w)) + \Pr_{(\rx,\ry) \sim \cD}[y \langle h_{\rA,\rt}(w), \rA \rx\rangle > \gamma_i/2 \wedge \ry \langle w, \rx\rangle \leq 0] \\
    &- \Pr_{(\rx,\ry) \sim \cD}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle \leq \gamma_i/2 \wedge \ry \langle w, \rx\rangle > 0].
\end{align*}
Similarly, we have for $\gamma \in \Gamma_i$ and any training set $S$ that
\begin{align*}
    \Loss_{S}^\gamma(w) &= \Loss^{\gamma_i/2}_{\rA S}(h_{\rA,\rt}(w)) + \Pr_{(\rx,\ry) \sim S}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle > \gamma_i/2 \wedge \ry \langle w, \rx\rangle \leq \gamma] \\
    &- \Pr_{(\rx,\ry) \sim S}[\ry \langle h_{\rA,\rt}(w), \rA\rx\rangle \leq \gamma_i/2 \wedge \ry \langle w, \rx\rangle > \gamma].
\end{align*}
We now have for any $\gamma \in \Gamma_i$ that
\begin{align}
\sup_{w \in \subH(\Gamma_i,L_j)} \Loss_\cD(w) - \Loss^\gamma_S(w) =& \nonumber \\ 
\sup_{w \in \subH(\Gamma_i,L_j)} \big(\E_{\rA,\rt} [\Loss^{\gamma_i/2}_{\rA \cD}(h_{\rA,\rt}(w)) - \Loss^{\gamma_i/2}_{\rA S}(h_{\rA,\rt}(w))] +& \nonumber\\ \E_{\rA,\rt} [\Pr_{\cD}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle > \gamma_i/2 \wedge \ry \langle w, \rx\rangle \leq 0] -\Pr_{S}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle > \gamma_i/2 \wedge \ry \langle w, \rx\rangle \leq \gamma] ] +& \nonumber\\
\E_{\rA,\rt} [\Pr_{S}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle \leq \gamma_i/2 \wedge \ry \langle w, \rx\rangle > \gamma] -\Pr_{\cD}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle \leq \gamma_i/2 \wedge \ry \langle w, \rx\rangle > 0] ]\big).\label{eq:3terms}
\end{align}
A critical observation is that the distribution of $y \langle h_{\rA,\rt}(w),\rA x \rangle$ depends only on $y \langle w, x \rangle$. 
\begin{claim}
\label{clm:distDeterm}
For any $(x,y) \in \finalX \times \{-1,1\}$ and any $w \in \finalH$, the distribution of $y \langle h_{\rA,\rt}(w),\rA x \rangle$ is completely determined from $y \langle w, x \rangle$.
\end{claim}
We prove Claim~\ref{clm:distDeterm} in Section~\ref{sec:lip} by exploiting that the entries of $\rA$ are i.i.d.\ $\Norm(0,1/k)$ distributed and using the rotational invariance of the Gaussian distribution.

As outlined in the proof overview in Section~\ref{sec:overview}, we can now use Claim~\ref{clm:distDeterm} together with the contraction inequality of Rademacher complexity to bound several of the terms in~\eqref{eq:3terms}. Similarly to the introduction of the ramp loss in classic proofs of generalization for large-margin halfspaces, we need to introduce a continuous function upper bounding the probabilities above. With this in mind, we now define the following functions $\phi$ and $\rho$:
\[
\phi(\alpha) = \begin{cases} \Pr_{\rA, \rt}[y \langle h_{\rA,\rt}(w), \rA x\rangle > \gamma_i/2 \mid y \langle w, x \rangle = \alpha] & \text{if } -c_\gamma \leq \alpha \leq 0 \\
                      \frac{(\gamma_i-\alpha)}{\gamma_i}\Pr_{\rA, \rt}[y \langle h_{\rA,\rt}(w), \rA x\rangle > \gamma_i/2 \mid y \langle w, x \rangle = 0]                                    & \text{if } 0 < \alpha \leq \gamma_i      \\
                      0 & \text{if } \gamma_i < \alpha \leq c_\gamma
        \end{cases}
\]
\[
\rho(\alpha) = \begin{cases} \Pr_{\rA, \rt}[y \langle h_{\rA,\rt}(w), \rA x\rangle \leq \gamma_i/2 \mid y \langle w, x \rangle = \alpha] & \text{if } \gamma_i < \alpha \leq c_\gamma\\
                      \frac{\alpha}{\gamma_i}\Pr_{\rA, \rt}[y \langle h_{\rA,\rt}(w), \rA x\rangle \leq \gamma_i/2 \mid y \langle w, x \rangle = \gamma_i]                                    & \text{if } 0 < \alpha \leq \gamma_i      \\
                      0 & \text{if } -c_\gamma \leq \alpha \leq 0
        \end{cases}
\]
Here we slightly abuse notation and write $\Pr_{\rA, \rt}[y \langle h_{\rA,\rt}(w), \rA x\rangle > \gamma_i/2 \mid y \langle w, x \rangle = \alpha]$ to denote the probability $\Pr_{\rA, \rt}[y \langle h_{\rA,\rt}(w), \rA x\rangle > \gamma_i/2]$ for an arbitrary $w \in \finalH, (x,y) \in \finalX \times \{-1,1\}$ with $y \ipr{w,x}=\alpha$ and remark that this probability is the same for all such $w,x,y$ by Claim~\ref{clm:distDeterm}.

We now observe that $\phi$ and $\rho$ upper and lower bounds the terms in~\eqref{eq:3terms}
\begin{remark}
\label{rmk:phirho}
For any training set $S$ and distribution $\cD$ over $\finalX \times \{-1,1\}$, we have
\begin{align*}
    \E_{\rA,\rt} [\Pr_{(\rx,\ry) \sim \cD}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle > \gamma_i/2 \wedge \ry \langle w, \rx\rangle \leq 0]] &\leq\E_{(\rx,\ry) \sim \cD}[\phi(\ry \langle w, \rx \rangle)] \\
    \E_{\rA,\rt} [\Pr_{(\rx,\ry) \sim S}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle > \gamma_i/2 \wedge \ry \langle w, \rx\rangle \leq \gamma]] &\geq \E_{(\rx,\ry) \sim S}[\phi(\ry \langle w, \rx \rangle)] \\
    \E_{\rA,\rt} [\Pr_{(\rx,\ry) \sim S}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle \leq \gamma_i/2 \wedge \ry \langle w, \rx\rangle > \gamma]] &\leq \E_{(\rx, \ry) \sim S}[\rho(\ry \langle w, \rx \rangle)]\\
    \E_{\rA,\rt} [\Pr_{(\rx,\ry) \sim \cD}[\ry \langle h_{\rA,\rt}(w), \rA \rx\rangle \leq \gamma_i/2 \wedge \ry \langle w, \rx\rangle > 0]] &\geq \E_{(\rx, \ry) \sim \cD}[\rho(\ry\langle w, \rx \rangle)].
\end{align*}
\end{remark}
The proof of Remark~\ref{rmk:phirho} follows from the definition of $\phi$ and $\rho$, along with monotonicity of $\Pr_{\rA,\rt}[y \ipr{h_{\rA,\rt}(w),\rA x} > \gamma_i \mid y\ipr{w,x}=\alpha]$ as a function of $\alpha$. The proofs have been deferred to Appendix~\ref{sec:aux}.
Continuing from~\eqref{eq:3terms} using Remark~\ref{rmk:phirho}, linearity of expectation and the triangle inequality, we have for any $\gamma \in \Gamma_i$ that
\begin{align}
\sup_{w \in \subH(\Gamma_i, L_j)} \Loss_\cD(w) - \Loss^\gamma_S(w) \leq&
\sup_{w \in \subH(\Gamma_i, L_j)} \left|\E_{\rA,\rt} [\Loss^{\gamma_i/2}_\cD(h_{\rA,\rt}(w)) - \Loss^{\gamma_i/2}_S(h_{\rA,\rt}(w))]\right| \label{eq:middle}\\
+&\sup_{w \in \subH(\Gamma_i, L_j)} \left| \E_{(\rx,\ry) \sim \cD}[\phi(\ry \langle w, \rx \rangle)] -\E_{(\rx,\ry) \sim S}[\phi(\ry \langle w, \rx \rangle)]\right| \label{eq:phi}\\
+&\sup_{w \in \subH(\Gamma_i, L_j)} \left|\E_{(\rx,\ry) \sim \cD}[\rho(\ry \langle w, \rx \rangle)] -\E_{(\rx,\ry) \sim S}[\rho(\ry \langle w, \rx \rangle)] \right|.\label{eq:rho}
\end{align}
In Section~\ref{sec:meetinmid}, we carefully use Bernstein's plus a (highly non-trivial) union bound over infinitely many grids of increasing size to bound~\eqref{eq:middle} as follows
\begin{lemma}
\label{lem:supW}
There is a constant $c>0$ such that with probability at least $1-\delta$ over $\rS \sim \cD^n$ we have
\begin{align*}
    \eqref{eq:middle} &\leq c \left(\sqrt{\frac{(\ell_{j+1}+ \exp(-\gamma_{i+1}^2k/c)) (k + \ln(e/\delta))}{n}} + \frac{(k + \ln(e/\delta))}{n} \right).
\end{align*}
\end{lemma}
In Section~\ref{sec:rademacher}, we then use Rademacher complexity and a bound on the Lipschitz constants of $\phi$ and $\rho$ to bound~\eqref{eq:phi} and~\eqref{eq:rho} as follows
\begin{lemma}
\label{lem:supPhi}
There are constants $c,c'>0$ such that with probability at least $1-\delta$ over $\rS \sim \cD^n$ we have
\begin{align*}
\max\{\eqref{eq:phi}, \eqref{eq:rho} \}\leq
c\exp(-\gamma_{i+1}^2k/c) \cdot \sqrt{(k + \gamma_{i+1}^{-2} + \ln(e/\delta))/n} .
\end{align*}
provided that $k \geq c' \gamma_{i+1}^{-2}$. 
\end{lemma}
To balance the expressions in Lemma~\ref{lem:supW} and Lemma~\ref{lem:supPhi}, we now set $k = c \gamma_{i+1}^{-2} \ln(e/\ell_{j+1})$ for a sufficiently large constant $c>0$ so that $\exp(-\gamma_{i+1}^2 k/c) \leq \ell_{j+1}/e$ and $k \geq c'\gamma_{i+1}^{-2}$. Combining Lemma~\ref{lem:supW} and Lemma~\ref{lem:supPhi} via a union bound with $\delta'=\delta/2$ and inserting into~\eqref{eq:middle},~\eqref{eq:phi} and~\eqref{eq:rho} gives
\begin{align*}
\sup_{w \in \subH(\Gamma_i, L_j)} \Loss_\cD(w) - \Loss^\gamma_S(w) \leq& \\c\left(\sqrt{\frac{\ell_{j+1}(\gamma_{i+1}^{-2}\ln(e/\ell_{j+1}) + \ln(e/\delta))}{n}}  + \frac{\gamma_{i+1}^{-2} \ln(e/\ell_{j+1})+\ln(e/\delta)}{n}\right) &+\\
c \left( \ell_{j+1} \sqrt{(\gamma_{i+1}^{-2} \ln(e/\ell_{j+1}) + \ln(e/\delta))/n} \right),
\end{align*}
for a constant $c>0$. This completes the proof of Lemma~\ref{lem:subgoal}, which together with Lemma~\ref{lem:subgoal2} completes the proof of our main result, Theorem~\ref{thm:main}.