\section{Stochastic One-Max Search}\label{sec: stochastic predictions}



One-max-search under competitive analysis is a worst-case abstraction of online selection
%decision-making,
which is highly skewed towards pessimistic scenarios. This is an approach rooted in theoretical computer science that has the benefit of worst-case guarantees, but does not capture the stochasticity of real markets, \eg \citep{cont_financial_2004,donnelly_optimal_2022}. In contrast,  in mathematical (and practical) finance, probabilistic analyses such as risk management are preferred, \eg \cite{MERTON1975621}.  While reconciling the two approaches remains a very challenging perspective, we aim to narrow the very large gap between the worst-case and stochastic regimes by leveraging a probabilistic approach. This necessitates algorithms that can be robust to the randomness of the market, and to this end, the established smoothness of our algorithm (\cref{sec: deterministic predictions}) will play a pivotal role, as we will show.  A probabilistic analysis can thus yield two main practical benefits: 1) estimate performance under price distributions obtained from financial modelling; 2) leverage the consistency-robustness trade-off to handle risk.

%the ability to directly manage the risk of using predictions by leveraging the trade-off presented by the consistency-robustness Pareto-front in the deterministic case.

In the stochastic formulation of \OMS{}, we now consider the prices $(\Prices_i)_{i=1}^n$ to be random variables whose maximum is $\Price\sim\dprice$. Since market prices are random, the historical data used to generate a machine-learned prediction should also be random, hence we consider the prediction to be a random variable $\Pred\sim\dpred$. As before, we consider that $\Prices_i$, for $i\in[n]$, and $\Pred$ take value in $\range$. The trading window unfolds as in the classic \OMS{} problem, except that the prices and predictions are now random. 

We will first give, in \cref{subsec: competitive analysis in stochastic framework}, a general probabilistic competitive analysis of the \OMS{} problem which shows that the bounds of \cref{sec: deterministic predictions} transfer naturally by weighting the bounds of \cref{thm: [deterministic Pareto-Optimal smooth Algorithm] consistency-robustness-smoothness complex} according to the coupling of $(\Price,\Pred)$. In order to better understand the intuition behind these results, in \cref{subsec: instances}, we instantiate the analysis with three insightful models. 
Finally, in \cref{subsec: OT}, we show how to isolate the interaction of $\dpred$ and $\dprice$ using analytical tools from optimal transport theory.



%Consistency fails to characterize the quality of an algorithm with predictions as the probability that the prediction $Y$ is exactly the maximal price $P^*$ can be arbitrarily close, or even equal, to $0$. While robustness (in the worst-case) might still hold, a probabilistic analysis based on the smooth error bounds obtained in \cref{thm: [deterministic Pareto-Optimal smooth Algorithm] consistency-robustness-smoothness complex} offers a natural beyond worst-case alternative.  It  has two main practical benefits: 1) the ability to estimate performance under realistic  conditions, \ie for realistic price distributions; 2) the ability to  exploit good predictions through the risk trade-off presented by the consistency-robustness Pareto-front.

%In \cref{subsec: competitive analysis in stochastic framework}, we give a general probabilistic competitive analysis of the \OMS{} problem. \Cref{thm: [Stochastic bounds] bound in expectation using true coupling} shows a natural transfer of our deterministic bounds into expectation. However, since $\dprice$ and $\dpred$ are arbitrary distributions in this setting, this approach yields integral functionals of the coupling of $(\Price,\Pred)$. In order to better understand the intuition behind these complex expression, we detail two practical settings in \cref{subsec: example models/deterministic prices,subsec: example models/independent predictions},\ltodo{explicti the settings} while deferring more technical results based on optimal transport to \cref{subsec: OT}.   

\subsection{Competitive analysis in the stochastic framework}\label{subsec: competitive analysis in stochastic framework}
In the stochastic setting, we will evaluate the performance of the algorithm using the ratio of expectations $\Eb[\Alg(\Price,\Pred)]/\Eb[\Price]$, but our results and arguments transfer readily to $\Eb[\Alg(\Price,\Pred)/\Price]$.


%a performance ratio analogous to $\Alg/\price$ can still capture the performance relative to an optimal algorithm. However, the probabilistic nature of the analysis introduces two possible choices for this ratio: \emph{Ratio of Expectations} (RoE) 
%or \emph{Expectation of Ratio} (EoR) $\Eb\left[{\Alg(\Price,\Pred)}/{\Price}\right]$.
%Both these ratios are considered in the competitive analysis literature, \eg \cite{ezra_prophet_2023}, though RoE is the most common. Hereafter, we state results for RoE, but our arguments and results adapt easily to EoR as well.
%


Because any algorithm must operate on the realisation of $\Pred$, its performance becomes a random variable depending on the specific relationship of $\Price$ and $\Pred$. This is captured the coupling $\truecoupling$ of $(\Price,\Pred)$, yielding
\begin{align}
    \Eb[\Alg(\Price,\Pred)]:=\int \Alg(\price,\pred) \de\truecoupling(\price,\pred)\,. \label{eq: expectation=coupling integral}
\end{align}
In consequence, we can identify $\truecoupling$ and the instance $(\Price,\Pred)\sim\truecoupling$ without loss of generality, as all such instances are indistinguishable to a probabilistic analysis. 


Taking into account the coupling, the bound proved in \cref{thm: [deterministic Pareto-Optimal smooth Algorithm] additive smoothness} adapts to the stochastic setting to yield \cref{thm: [Stochastic bounds] bound in expectation using true coupling} below.


\begin{lemma}\label{thm: [Stochastic bounds] bound in expectation using true coupling}
The family $\family$ satisfies 
    \begin{align}
     \hspace{-1em}\frac{\Eb[\algone(\Price,\Pred)]}{\Eb[\Price]}\ge \max\left\{\parr\,,\, \frac{1}{\rob\ub}\frac{\Eb\left[\Price\error(\Price,\Pred)^{\smth}\right]}{\Eb[\Price]}\right\}\hspace{-1pt}.\label{eq: PR bound in Expectation of ratio using coupling}
    \end{align}
\end{lemma}

\begin{proof}
    Apply Jensen's inequality to \cref{thm: [deterministic Pareto-Optimal smooth Algorithm] consistency-robustness-smoothness complex}.
\end{proof}
As expected,~\eqref{eq: PR bound in Expectation of ratio using coupling} shows that the robustness of $\family$ carries over to the stochastic setting through the $\max\{r,\cdot\}$ term.



\input{sections/ex_models}


\subsection{Dependent predictions and optimal transport}\label{subsec: OT}


The previous models successfully isolated the effect of the distributions $\dprice$ and $\dpred$. Using tools from Optimal Transport (OT) theory, one can generalise this approach. For brevity, we refer simply to \cite{villani_optimal_2009} for the technicalities and background of this field. The key observation is that the right-hand side of Eq.~\eqref{eq: expectation=coupling integral} is a \emph{transport functional} of $\pi^*$, which can be lower bounded uniformly over the set of couplings $\couplings(\dprice,\dpred)$  of $\dprice$ and $\dpred$. This set is exactly the set of joint distributions for $(\Price,\Pred)$ when $\Price\sim\dprice$ and $\Pred\sim\dpred$. Minimising a transport functional over couplings is the classic OT problem \citep{villani_optimal_2009}, hence \cref{thm: [Stochastic bounds] OT bound for coupling robustness}.


\begin{theorem}\label{thm: [Stochastic bounds] OT bound for coupling robustness}
    The family $\family$ satisfies 
        \begin{align}
        \frac{\Eb[\algone(\Price,\Pred)]}{\Eb[\Price]}\ge \frac{1}{r\theta}\frac{\inf\mathlarger{\int} \price\error(\price,\pred)^{\smth}\de\coupling(\price,\pred)}{\Eb[\Price]}\label{eq: in expectation of ratio using OT}\,.
    \end{align}
    where infimum is taken over couplings $\coupling\in\couplings(\dprice,\dpred)$ ; in particular, the numerator is as most $\Eb[\Price]$.
\end{theorem}

\Cref{thm: [Stochastic bounds] OT bound for coupling robustness} highlights a novel connection between (stochastic) competitive analysis and optimal transport.
Contrary to most literature in OT, in which the optimal configuration tries to minimise the distance points $(\price,\pred)$ are moved, the infimum in ~\eqref{eq: in expectation of ratio using OT} tries to push them far apart to induce the algorithm to make mistakes.

Optimal transport tools have been used before in algorithms with predictions, notably in the \emph{distributional predictions} setting in which the algorithm is given $\dpred$ itself \citep{angelopoulos_contract_2024,dinitz_binary_2024}. This analysis, however, is fundamentally different: it uses Wasserstein distances (see \cref{subapp: proba additive analysis}) in place of $\additiveerror$ in quantifying the error of the distributional prediction $\dpred$ of $\dprice$. Our stochastic framework ties its error metric closely to the asymmetric nature of the problem through $\price\error(\price,\pred)^\smth$, which is why our OT problem, \ie Eq.~\eqref{eq: in expectation of ratio using OT}, is \emph{not} symmetric: exchanging the roles of $(\dpred,\dprice)$ cannot be expected to yield the same performance. 
The optimal transport problem in Eq.~\eqref{eq: in expectation of ratio using OT} generally has no closed form, but thanks to its (strong) dual form (see \cref{subapp: OT}), one can use problem-specific knowledge to derive lower bounds, as demonstrated by \cref{prop: [stochastic predictions] OT dual bounds}.

\begin{restatable}{proposition}{OTdualBoundsOne}\label{prop: [stochastic predictions] OT dual bounds}
    The family $\family$ satisfies
    \begin{align}
    \frac{\Eb[\algone(\Price,\Pred)]}{\Eb[\Price]}\ge\frac{1}{\rob\ub} \frac{\displaystyle \int_\lb^{\ub^{\frac12}}\hspace{-11pt} {\price}^{1+\smth}\de\dprice(\price) \hspace{-2pt}+\hspace{-4pt} \int_{\hspace{-1pt}\ub^{\frac12}}^\ub\hspace{-3pt} {\price}^{1-\smth}\de\dprice(\price)}{\Eb[P^*]}\hspace{2pt}.\notag
    \end{align}
    Moreover, the RHS is the infimum over $\dpred$ of Eq.~\eqref{eq: in expectation of ratio using OT}.
\end{restatable}

% \lc{
% \begin{restatable}{proposition}{OTdualBoundsOne}\label{prop: [stochastic predictions] OT dual bounds}
%     The ratio $\dfrac{\Eb[\algone(\Price,\Pred)]}{\Eb[\Price]}$ is at least
%     \begin{align}
%     \frac{1}{\rob\ub} \frac{\displaystyle \int_\lb^{\ub^{\frac12}}\hspace{-11pt} {\price}^{1+\smth}\de\dprice(\price) \hspace{-2pt}+\hspace{-4pt} \int_{\hspace{-1pt}\ub^{\frac12}}^\ub\hspace{-3pt} {\price}^{1-\smth}\de\dprice(\price)}{\Eb[P^*]}\hspace{2pt}.\notag
%     \end{align}
% \end{restatable}
% }
%\VP{both options are equally good}

\Cref{prop: [stochastic predictions] OT dual bounds} once more highlights the asymmetry of the problem through different contributions of the regions above and below $\sqrt{\ub}$, which is the threshold that guarantees $1/\sqrt{\theta}$-robustness. The dual problem provides thus a practical tool for designing lower bounds for the performance of $\family$ in the stochastic \OMS{} setting.