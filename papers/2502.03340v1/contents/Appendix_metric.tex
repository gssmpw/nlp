\section{Theoretical Derivation of the Wasserstein Adjusted Score} \label{app:clustering}
\textcolor{black}{To address the lack of clustering evaluation metrics suited for FL with distributional heterogeneity and class imbalance, we introduced a theoretically grounded adjustment to standard metrics, derived from the Wasserstein distance, Kantorovichâ€“Rubinstein metric \citep{kantorovich1942translocation}. This metric, integrated with popular scores like Silhouette and Davies-Bouldin, enables a modular framework for a posteriori evaluation, effectively comparing clustering outcomes across federated algorithms.}
In this paragraph, we show how the proposed clustering metric that accounts for class imbalance can be derived from a probabilistic interpretation of clustering. 
\begin{definition}
    Let $(M,d)$ be a metric space, and $p \in [1,\infty]$. The Wasserstein distance between two probability measures $\mathbb{P}$ and $\mathbb{Q}$ over $M$ is defined as
    \begin{equation}\label{eq:wass}
        W_p(\mathbb{P}, \mathbb{Q}) =  \inf_{\gamma \in \Gamma(\mathbb{P}, \mathbb{Q})} \mathbb{E}_{(x,y)\sim \gamma}[d(x,y)^p]^{1/p}
    \end{equation}
where $\Gamma(\mathbb{P}, \mathbb{Q})$ is  the set of all the possible couplings of $\mathbb{P}$ and $\mathbb{Q}$ (see Def. \ref{couplings}).
\end{definition}
Furthermore, we need to introduce the notion of coupling of two probability measures.
\begin{definition}\label{couplings}
Let $(M,d)$ be a metric space, and $\mathbb{P}, \mathbb{Q}$ two probability measures over $M$. A coupling $\gamma$ of $\mathbb{P}$ and $\mathbb{Q}$ is a joint probability measure on $M \times M$ such that, for any measurable subset $A \subset M$,
\begin{equation}\label{eq:coupling}
\begin{split}
    \int_A \left(\int_M \gamma(dx, dy) \mathbb{Q}(dy)\right) \mathbb{P}(dx) = \mathbb{P}(A), \\
    \int_A \left(\int_M \gamma(dx, dy) \mathbb{P}(dx)\right) \mathbb{Q}(dy) = \mathbb{Q}(A).
\end{split}
\end{equation}
\end{definition}
Let us recall that the empirical measure over $M$ of a sample of observations $\{x_1, \cdots, x_N\}$ is defined such that for any measurable  set $A \subset M$
\begin{equation}\label{eq:emp_measure}
    \mathbb{P}(A) = \dfrac{1}{N}\sum_{i = 1}^C\delta_{x_i}(A) 
\end{equation}
where $\delta_{x_i}$ is  the Dirac's measure concentrated on the data point $x_i$.\\
In particular, we aim to measure the goodness of a cluster by taking into account the distance between the empirical frequencies between two clients' class distributions and use that to properly adjust the clustering metric. For the sake of simplicity, we assume that the distance $d$ over $M$ is the $L^2$-norm. We obtain the following theoretical result to justify the rationale behind our proposed metric.
\begin{theorem}
    Let $s$ be an arbitrary clustering score. Then, the class-imbalance adjusted score $\tilde{s}$ is exactly the metric $s$ computed with the Wasserstein distance between the empirical measures over each client's class distribution.
\end{theorem}
\begin{proof}
Let us consider two clients; each one has its own sample of observations $\{x_1, \dots, x_C\}$ and $\{y_1, \dots, y_C\}$ where the $i$-th position corresponds to the frequency of training points of class $i$ for each client. We aim to compute the $p$-Wasserstein distance between the empirical measures $\mathbb{P}$ and $\mathbb{Q}$ of the two clients, in particular for any $dx, dy > 0$
\begin{equation}
\begin{split}
    \mathbb{P}(dx) &= \dfrac{1}{N} \sum_{i = 1}^N \delta_{x_i}(dx), \\
    \mathbb{Q}(dy) &= \dfrac{1}{N} \sum_{i = 1}^N \delta_{y_i}(dy)\,\,\,.
\end{split}
\end{equation}
In order to compute $W_p^p(\mathbb{P}, \mathbb{Q})$ we need to carefully investigate the set of all possible coupling measures $\Gamma(\mathbb{P}, \mathbb{Q})$. However, since either $\mathbb{P}$ and $\mathbb{Q}$ are concentrated over countable sets, it is possible to see that the only possible couplings satisfying Eq. \ref{eq:coupling} are the Dirac's measures over all the possible permutations of $x_i$ and $y_i$. In particular, by fixing the ordering of $x_i$, according to the rank statistic $x_{(i)}$, the coupling set can be written as
\begin{equation}
    \Gamma(\mathbb{P}, \mathbb{Q}) = \left\{\dfrac{1}{C} \delta_{(x_{(i)}, y_{\pi(i)})}: \pi \in \mathcal{S}\right\}
\end{equation}
where $\mathcal{S}$  is the set of all possible permutations of $C$ elements. Therefore we could write Eq. \ref{eq:wass} as follows
\begin{equation}
    W_p^p = \min_{\pi \in \mathcal{S}} \int_{M\times M}|x - y|^p \dfrac{1}{N} \sum_{i = 1}^C \delta_{(x_{(i)}, y_{\pi(i)})}(dx,dy)
\end{equation}
since $\mathcal{S}$ is finite, the infimum is a minimum. By exploiting the definition of Dirac's distribution and the linearity of the Lebesgue integral, for any $\pi \in \mathcal{S}$, we get
\begin{equation}
\begin{split}
\int_{M\times M}|x - y|^p \dfrac{1}{C}\sum_{i = 1}^C \delta_{(x_{(i)}, y_{\pi(i)})}(dx,dy) &= \dfrac{1}{C}\sum_{i = 1}^C\int_{M\times M} |x - y|^p\delta_{(x_{(i)}, y_{\pi(i)})}(dx,dy)\\
&=\dfrac{1}{C}\sum_{i = 1}^C |x_{(i)} - y_{\pi(i)}|^p\,\,.
\end{split} 
\end{equation}
Therefore, finding the Wasserstein distance between $\mathbb{P}$ and $\mathbb{Q}$ boils down to a combinatorial optimization problem, that is, finding the permutation $\pi \in \mathcal{S}$ that solves
\begin{equation}\label{eq:min_pi_empirical}
W_p^p(\mathbb{P}, \mathbb{Q}) = \min_{\pi \in \mathcal{S}} \dfrac{1}{C}\sum_{i = 1}^C |x_{(i)}- y_{\pi(i)}|^p\,\,.
\end{equation}
The minimum is achieved when $\pi = \pi^*$ that is the permutation providing the ranking statistic, i.e. $\pi^*(y_i) = y_{(i)}$, since the smallest value of the sum is given for the smallest fluctuations. Thus we conclude that the $p$-Wasserstein distance between $\mathbb{P}$ and $\mathbb{Q}$ is given by
\begin{equation}\label{eq:wass_empirical}
    W_p(\mathbb{P}, \mathbb{Q}) = \left (\dfrac{1}{C} \sum_{i = 1}^C|x_{(i)}- y_{(i)}|^p\right )^{1/p}
\end{equation}
that is the pairwise distance computed between the class frequency vectors, sorted in order of magnitude, for each client, introduced in Section \ref{clustereing_metric}, where we chose $p = 2$.
\end{proof}
