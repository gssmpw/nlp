\begin{proofof}{Theorem \ref{thm:holy grail}}
Fix an arbitrary instance. We prove the claim by a two-dimensional induction on the size of $\above(s),\below(s)$, for states $s\in \mS$. The base cases are 
\begin{itemize}
\item $\abs{\above(s)}\geq 2 $ and $\abs{\below(s)} = 1$ (Proposition \ref{prop:W case of one}), and
\item $\abs{\above(s)}=1$ and $\abs{\below(s)}\geq 2$ (Proposition \ref{prop:W case of one strong}),
\end{itemize}
which we relegate to Section \ref{sec:for theorem}. Next, assume the statement holds for all $s\in \mS$ such that $\abs{\above(s)}\leq K_1$, $\abs{\below(s)}\leq K_2$ and $\abs{\above(s)}+\abs{\below(s)}< K_1+K_2$. Let $U\in\mS$ denote a state with $\abs{\above(U)}=K_1$ and $\abs{\below(U)}=K_2$. For abbreviation, let $\ug\defeq\above(U)=\{a_{i_1},a_{i_2},\dots ,a_{i_{K_1}}\}$ and $\ul\defeq\below(U)=\{a_{j_1},a_{j_2},\dots ,a_{j_{K_2}}\}$, and assume the indices follow the stochastic order. Further, for every $a_i \in \ug, a_j\in \ul$ let 
\[
W^*_{i,j}(\ug,\ul)\defeq\bl p_{i,j}(a_j)W^*(\ug,\ul\setminus \{a_j\}) +\bl p_{i,j}(a_i)W^*(\ug\setminus\{a_i\},\ul).
\]
We need to prove that $W^*_{{i_1},{j_1}}(s)=W^*(s)$.
\paragraph{Remarks} Notice that if $X_{a_i'}>0$ for $a_{i'}\in \above(A)$, any $\mP$-valid policy gets $W^*(s)$. To see this, recall that $\mP$-valid policies reach terminate states only after exploring all arms in $\above(A)$. Consequently, we assume for the rest of the proof that $X_{a_i'}\leq 0$ for $a_{i'}\in \above(A)$. 
\paragraph{Step 1}
\begin{figure}[htbp]
\centering
\input{input/tree_thm_illustration}
\caption{Illustration of the policies $\pi,\rho$ from Step 1 of Theorem \ref{thm:holy grail}. Notice that the left sub-trees of $\pi$ and $\rho$ are identical.\label{fig:helping for thm two}
}% caption command
\end{figure}

Fix $a_{i'} \in \ug$. We show that for every $k$, $1\leq k<K_2$ it holds that $W^*_{{i'},{j_k}}(s) \geq W^*_{{i'},{j_{k+1}}}(s)$. We define the ordered, $\mP$-valid policy $\pi^*$ by $\sigl_\pi = (a_{i'},\dots)$  namely, $\sigl_{\pi^*}$ ranks $a_{i'}$ first and all the other arms in $\ug$ arbitrarily, and $\sigr_{\pi^*}=(a_{j_1},a_{j_2},\dots,a_{j_{K_2}})$. Due to the inductive assumption, for every state $s$ with $\abs{s}<\abs{U}$, $W^*(s) = W(\pi^*,s)$. Next, we define the policies $\pi,\rho$ explicitly, as follows:
\[
\pi(s) = 
\begin{cases}
\bl p_{{i'},{j_k}} & \textnormal{if $s=(\ug,\ul)$} \\
\pi^*(s)& \textnormal{otherwise} 
\end{cases},\quad 
\rho(s) = 
\begin{cases}
\bl p_{{i'},{j_{k+1}}} & \textnormal{if $s=(\ug,\ul)$} \\
\pi^*(s)& \textnormal{otherwise}
\end{cases}.
\]
We illustrate $\pi$ and $\rho$ in Figure \ref{fig:helping for thm two}. Note that both $\pi,\rho$ have on-path states that are off-path for $\pi^*$. For instance, $\rho$ reaches the state $(\ug,\ul\setminus\{a_{j_{k+1}}\})$ with positive probability, while $\pi^*$ cannot reach it at all. In addition, $\pi$ and $\rho$ are left-ordered with $\sigl_\pi=\sigl_\rho=\sigl_{\pi^*}$. Due to the inductive assumption, it is enough to show that $W(\pi,U)-W(\rho,U)\geq 0$, as this implies $W^*_{{i'},{j_k}}(s) \geq W^*_{{i'},{j_{k+1}}}(s)$.

Next, we factor $W(\pi,U)$ as follows: for every state $U'\subset U$, we factor $W(\pi,U')$ as long as $a_{j_k},a_{j_{k+1}}\in U'$. Once we reach a term $W(\pi,U')$ with $a_{j_k},a_{j_{k+1}}\notin U'$, we stop. Let $\Psi\defeq \prefix(a_{j_1},a_{j_2}\dots, a_{j_{k-1}})$ be the set of (possibly empty) prefixes of the first $k-1$ arms in $\ul$ according to $\pi^*$. Observe that\footnote{The reader can think of $\psi$ as the set of arms from $(a_{j_1},a_{j_2}\dots, a_{j_{k-1}})$ that were explored.}  
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align}\label{eq:w of pi}
W(\pi,U)&=\sum_{\psi\in \Psi}
\Pr(\pathto{s}{(\ul\setminus \psi)})R(\ul\setminus \psi)+\Pr(\pathto{s}{(\ul\setminus (\psi \cup \{a_{j_k}\})})R(\ul\setminus (\psi \cup \{a_{j_k}\})\nonumber \\
&\qquad +\underbrace{\sum_{\substack{Z\in \suff(\sigl_\pi)}}
f^\pi_Z \cdot W(\pi,Z,\ul\setminus \{a_{j_1},a_{j_2},\dots,a_{j_{k}},a_{j_{k+1}} \})}_{I^\pi}
\end{align}}
The coefficients $(f^\pi_Z)$ follow from the factorization process. Using similar factorization,
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align}\label{eq:w of rho}
W(\rho,U)&=\sum_{\psi\in \Psi}
\Pr(\pathtorho{s}{(\ul\setminus \psi)})R(\ul\setminus \psi)+\Pr(\pathtorho{s}{(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))})R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))\nonumber\\
&\qquad +\underbrace{\sum_{\substack{Z\in \suff(\sigl_\rho)}}
f^\rho_Z \cdot W(\rho,Z,\ul\setminus \{a_{j_1},a_{j_2},\dots,a_{j_{k}},a_{j_{k+1}} \})}_{I^\rho}. 
\end{align}}%
Next, we express $(f^\pi_Z)_Z$ in terms of $Q$. By relying on the Equivalence lemma, we show that
\begin{claim}\label{claim:f are equal}
For every $Z\in \suff(\sigl_\pi)=\suff(\sigl_\rho)$, it holds that $f^\pi_Z=f^\rho_Z$.
\end{claim}
To see why Claim \ref{claim:f are equal} holds, notice that we can represent $f^\pi_Z$ as 
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\[
Q(\pi,\ug\setminus Z \cup \{a_{i(Z)}\}, \ul\setminus \{a_{j_1},a_{j_2},\dots,a_{j_{k}},a_{j_{k+1}} \})-Q(\pi,\ug\setminus Z, \ul\setminus \{a_{j_1},a_{j_2},\dots,a_{j_{k}},a_{j_{k+1}} \}),
\]}%
where $a_{i(Z)}$ is the minimal element in $Z$ according to $\sigl_\pi$. By invoking the Equivalence lemma, we can replace $\pi$ in the above expression with $\rho$ and thus for every $Z\in \suff(\sigl_\pi)=\suff(\sigl_\rho)$, it holds that $f^\pi_Z=f^\rho_Z$. Combining Claim \ref{claim:f are equal} with the inductive step and $\sigl_\pi,\sigl_\rho$ being equal, we conclude that $I^\pi=I^\rho$. 


Next, we focus on the first sum of $W(\pi,U)$ in Equation \refeq{eq:w of pi}. For every $\psi\in \Psi$, we denote the event $E^\pi_\psi$ as a shorthand for
\[
E^\pi_\psi \defeq \left(\pathto{s}{(\ul\setminus \psi)}\right)\cup\left( \pathto{s}{(\ul\setminus (\psi \cup \{a_{j_k}\}))}\right).
\]
In words, $E^\pi_\psi$ is the event that the GMDP reaches the final state $(\ul\setminus \psi)$ or $(\ul\setminus (\psi \cup \{a_{j_k}\}))$ after starting in $s_0$ and following $\pi$. We use conditional expectation to simplify the summands in the first sum of Equation (\ref{eq:w of pi}),
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align}\label{eq:pi with alpha}
&\Pr(\pathto{s}{(\ul\setminus \psi)})R(\ul\setminus \psi)+\Pr(\pathto{s}{(\ul\setminus (\psi \cup \{a_{j_k}\})})R(\ul\setminus (\psi \cup \{a_{j_k}\})\nonumber\\
&=\Pr\left(E^\pi_\psi\right)\cdot \underbrace{\left( \Pr(\pathto{s}{(\ul\setminus \psi)}\mid E^\pi_\psi)R(\ul\setminus \psi)+\Pr(\pathto{s}{(\ul\setminus (\psi \cup \{a_{j_k}\})}\mid E^\pi_\psi)R(\ul\setminus (\psi \cup \{a_{j_k}\}))\right)}_{\alpha^\pi_\psi}\nonumber\\
&=\Pr(E^\pi_\psi) \alpha^\pi_\psi. 
\end{align}}%
Similarly for $\rho$, by letting
\[
E^\rho_\psi \defeq \left(\pathtorho{s}{(\ul\setminus \psi)}\right)\cup\left( \pathtorho{s}{(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))}\right)
\]
and following the derivation in Equation \refeq{eq:pi with alpha} for $\rho$, we get
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align}\label{eq:rho with alpha}
&\Pr(\pathtorho{s}{(\ul\setminus \psi)})R(\ul\setminus \psi)+\Pr(\pathtorho{s}{(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})})R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})\nonumber\\
&=\Pr\left(E^\rho_\psi\right)\cdot \underbrace{\left( \Pr(\pathtorho{s}{(\ul\setminus \psi)}\mid E^\rho_\psi)R(\ul\setminus \psi)+\Pr(\pathtorho{s}{(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})}\mid E^\rho_\psi)R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})) \right)}_{\alpha^\rho_\psi}\nonumber\\
&=\Pr(E^\rho_\psi) \alpha^\rho_\psi. 
\end{align}}%
Due to the fact that $I^\pi=I^\rho$ and relying on Equations (\ref{eq:w of pi})-(\ref{eq:rho with alpha}), we have  
\begin{align}\label{eq:w minus w}
W(\pi,U)-W(\rho,U)=\sum_{\psi\in \Psi}\left(\Pr(E^\pi_\psi) \alpha^\pi_\psi-\Pr(E^\rho_\psi) \alpha^\rho_\psi\right).
\end{align}
At this point, we might be tempted to show that every summand of the sum in Equation \refeq{eq:w minus w} is non-negative. Unfortunately, this approach would not work---stochastic order does not mean $\Pr(E^\pi_\psi) \alpha^\pi_\psi\geq \Pr(E^\rho_\psi) \alpha^\rho_\psi$. Instead, we take a different approach. For every $l, 1\leq l \leq k-1$ let $E^\pi_{l}$ denote the event that $a_{j_l}$ was observed in the final state. Formally,
\[
E^\pi_{l} \defeq  \bigcup_{\substack{\psi' \in \Psi\\a_{j_l} \in \psi' }} \left(\pathto{s}{(\ul\setminus \psi')}\right)\cup\left(\pathto{s}{(\ul\setminus (\psi' \cup \{a_{j_k}\})}\right).
\]
In addition, we let $E^\pi_{k}$ denote the empty event, and $E^\pi_{0}$ be the full event (that occurs w.p.~$1$).   For every non-empty $\psi \in \Psi$, i.e. $\abs{\psi}\geq 1$, let $\max(\psi)\defeq\argmax_{j_l:{a_{j_l}} \in \psi} \sigr_{\pi^*}(a_{j_l})$. According to our assumption about the index of the arms, $\max(\psi)$ is simply the maximal index of an arm in $\psi$ (that is well-defined when $\abs{\psi}\geq 1$). In addition, for completeness, if $\psi=\emptyset$ we let $\max(\emptyset)=0$. We can use the terms $(E^\pi_{l})_{l=0}^k$ to provide an alternative form for $E^\pi_\psi$:
\[
E^\pi_\psi=E^\pi_{\max(\psi)}\setminus E^\pi_{\max(\psi)+1}.
\]
Put differently, for $\psi$ with $\max(\psi)<k-1$, $E^\pi_\psi$ can be viewed as the collection of all of events in which arm $a_{j_{\max(\psi)}}$ was explored, but arm $a_{j_{\max(\psi)+1}}$ was not (where the ``arm'' $a_{j_0}$ for $\psi=\emptyset$ refers to $E^\pi_{0}$). Recall that for $\psi$ with $\max(\psi)=k-1$, $E^\pi_\psi=E^\pi_{\max(\psi)}$ since $E^\pi_{k}$ is the empty event.

Since $E^\pi_{\max(\psi)+1}\subseteq E^\pi_{\max(\psi)}$, we have that for every $\psi\in \Psi$,
\begin{align}\label{eq:e pi with Z}
\Pr(E^\pi_\psi)=\Pr(E^\pi_{\max(\psi)})-\Pr(E^\pi_{\max(\psi)+1}),
\end{align}
taking care of edge cases too. By renaming $\alpha^\pi_\psi$ to $\alpha^\pi_{\max(\psi)}$, i.e., $\alpha^\pi_{\max(\psi)} \defeq \alpha^\pi_\psi $, and rearranging Equation \refeq{eq:w of pi} using Equations \refeq{eq:pi with alpha} and \refeq{eq:e pi with Z},
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align}\label{eq:w pi with diff}
W(\pi,U)&= I^\pi+\sum_{\psi\in \Psi} \Pr\left(E^\pi_\psi\right) \alpha^\pi_\psi=I^\pi+\sum_{l=0}^{k-1}\left(\Pr(E^\pi_{l})-\Pr(E^\pi_{l+1})\right) \alpha^\pi_l.
\end{align}}%
By defining $E^\rho_l$ analogously,
\[
E^\rho_{l} \defeq  \bigcup_{\substack{\psi' \in \Psi\\a_{j_l} \in \psi' }} \left(\pathtorho{s}{(\ul\setminus \psi')}\right)\cup\left(\pathtorho{s}{(\ul\setminus (\psi' \cup \{a_{j_{k+1}}\})}\right),
\]
and following similar arguments, we conclude that
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align}\label{eq:w rho with diff}
W(\rho,U)&= I^\rho+\sum_{\psi\in \Psi} \Pr\left(E^\rho_\psi\right) \alpha^\rho_\psi=I^\rho+\sum_{l=0}^{k-1}\left(\Pr(E^\rho_{l})-\Pr(E^\rho_{l+1})\right) \alpha^\rho_l.
\end{align}}%
By rephrasing Equation (\ref{eq:w minus w}) using Equations (\ref{eq:w pi with diff}) and (\ref{eq:w rho with diff}),
\begin{align}\label{eq: thm step 1 good}
W(\pi,U)-W(\rho,U)=\sum_{l=0}^{k-1}\left(\Pr(E^\pi_{l})-\Pr(E^\pi_{l+1})\right) \alpha^\pi_l-\left(\Pr(E^\rho_{l})-\Pr(E^\rho_{l+1})\right) \alpha^\rho_l.
\end{align}
Next, we show two monotonicity properties.
\begin{proposition}\label{prop: monotonicity in thm}
Under Assumption \ref{assumption:dominance},
\begin{enumerate}
\item for every $l\in \{0,1,\dots,k-1 \}$, it holds that $\alpha^\pi_l \geq \alpha^\rho_l$. \label{item:prop alphas rho pi}
%\item for every $l\in \{0,1,\dots,k-1 \}$, it holds that $\Pr\left(E^\pi_l\right) \geq \Pr\left(E^\rho_l\right)$.\label{item:prop E} {\red I am not sure we need it! Even after double checking}
\item for every $l\in \{0,1,\dots,k-2\}$, it holds that $\alpha^\pi_{l+1} \geq \alpha^\pi_{l}$ and $\alpha^\rho_{l+1} \geq \alpha^\rho_{l}$. \label{item:prop alphas alpha pi}
\end{enumerate}
\end{proposition}
In fact, this is the only place in the proof of Theorem \ref{thm:holy grail} where we rely on Assumption \ref{assumption:dominance}. Equipped with Proposition \ref{prop: monotonicity in thm}, we can make the final argument. For every $r,r\in \{1\dots,k-1\}$ let
\[
f(r) \defeq \left( \Pr(E^\pi_{r})-\Pr(E^\rho_{r}) \right)\alpha^\pi_{r-1}.
\]
In addition, let
\[
g(r)\defeq \sum_{l=0}^{r}\left(\Pr(E^\pi_{l})-\Pr(E^\pi_{l+1})\right) \alpha^\pi_l-\left(\Pr(E^\rho_{l})-\Pr(E^\rho_{l+1})\right) \alpha^\rho_l
\]
We shall show that for every $r,r\in \{0,\dots,k-2\}$ it holds that
\begin{align}\label{eq:thm last argument}
W(\pi,U)-W(\rho,U)\geq f(r+1)+g(r).
\end{align}
For $r=k-2$, we have
{
\begin{align*}
\textnormal{Eq. (\ref{eq: thm step 1 good})}&=\left(\Pr(E^\pi_{k-1})-\Pr(E^\pi_{k})\right) \alpha^\pi_{k-1}-\left(\Pr(E^\rho_{k-1})-\Pr(E^\rho_{k})\right) \alpha^\rho_{k-1}+g(k-2)\\
&\stackrel{\substack{E^\pi_{k},E^\rho_{k}\\\textnormal{are empty}}}{=}\Pr(E^\pi_{k-1})\alpha^\pi_{k-1}-\Pr(E^\rho_{k-1}) \alpha^\rho_{k-1}+g(k-2)\\
&\stackrel{\textnormal{Prop. \ref{prop: monotonicity in thm}.\ref{item:prop alphas rho pi}}}{\geq}\left(\Pr(E^\pi_{k-1})-\Pr(E^\rho_{k-1}) \right)\alpha^\pi_{k-1}+g(k-2)\\
&\stackrel{\textnormal{Prop. \ref{prop: monotonicity in thm}.\ref{item:prop alphas alpha pi}}}{\geq}\left(\Pr(E^\pi_{k-1})-\Pr(E^\rho_{k-1}) \right)\alpha^\pi_{k-2}+g(k-2)\\
&=f(k-1)+g(k-2).
\end{align*}}%
Assume Inequality \refeq{eq:thm last argument} holds for $r+1$. Then, for $r$ we have 
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align*}
f(r+1)+g(r) &= \left( \Pr(E^\pi_{r+1})-\Pr(E^\rho_{r+1}) \right)\alpha^\pi_{r}+g(r-1)\\
&\qquad \qquad +\left(\Pr(E^\pi_{r})-\Pr(E^\pi_{r+1})\right) \alpha^\pi_r-\underbrace{\left(\Pr(E^\rho_{r})-\Pr(E^\rho_{r+1})\right)}_{\geq 0,\textnormal{ Eq. \refeq{eq:e pi with Z}}}  \alpha^\rho_r\\
&\stackrel{\textnormal{Prop. \ref{prop: monotonicity in thm}.\ref{item:prop alphas rho pi}}}{\geq} \left( \Pr(E^\pi_{r+1})-\Pr(E^\rho_{r+1}) \right)\alpha^\pi_{r}+g(r-1)\\
&\qquad \qquad +\left(\Pr(E^\pi_{r})-\Pr(E^\pi_{r+1})\right) \alpha^\pi_r-\left(\Pr(E^\rho_{r})-\Pr(E^\rho_{r+1})\right) \alpha^\pi_r\\
&=\Pr(E^\pi_{r})\alpha^\pi_r-\Pr(E^\rho_{r}) \alpha^\pi_r +g(r-1)\\
&\stackrel{\textnormal{Prop. \ref{prop: monotonicity in thm}.\ref{item:prop alphas alpha pi}}}{\geq}\Pr(E^\pi_{r})\alpha^\pi_{r-1}-\Pr(E^\rho_{r}) \alpha^\pi_{r-1} +g(r-1)\\
&= f(r)+g(r-1).
\end{align*}}%
Ultimately, by setting $r=0$ in Inequality \refeq{eq:thm last argument},
\begin{align*}
W(\pi,U)-W(\rho,U)&\geq f(1)+g(0)\\
&=\left( \Pr(E^\pi_{1})-\Pr(E^\rho_{1}) \right)\alpha^\pi_{0}\\
&\qquad \qquad +\left(\Pr(E^\pi_{0})-\Pr(E^\pi_{1})\right) \alpha^\pi_0-\left(\Pr(E^\rho_{0})-\Pr(E^\rho_{1})\right) \alpha^\rho_0\\
&\geq\Pr(E^\pi_{0}) \alpha^\pi_0-\Pr(E^\rho_{0}) \alpha^\pi_0\\
&=0.
\end{align*}
This concludes the first step of the theorem.
\paragraph{Step 2}  In this step, we show that for every $k$, $1\leq k < K_1$ it holds that $W^*_{{i_k},{j_1}}(s) = W^*_{{i_{k+1}},{j_1}}(s)$. Define an ordered, $\mP$-valid policy $\pi^*$ by $\sigl_\pi = (a_{i_1},a_{i_2},\dots,a_{i_{K_1}})$,  namely, $\sigl_{\pi^*}$ ranks the elements of $\ug$ according to the stochastic order, and $\sigr_{\pi^*}=(a_{j_1},a_{j_2},\dots,a_{j_{K_2}})$. Due to the inductive assumption, for every state $s$ with $\abs{s}<\abs{U}$, $W^*(s) = W(\pi^*,s)$. Next, we define the policies $\pi,\rho$ explicitly, as follows:
\[
\pi(s) = 
\begin{cases}
\bl p_{{i_k},{j_1}} & \textnormal{if $s=(\ug,\ul)$} \\
\pi^*(s)& \textnormal{otherwise} 
\end{cases},\quad 
\rho(s) = 
\begin{cases}
\bl p_{{i_{k+1}},{j_{1}}} & \textnormal{if $s=(\ug,\ul)$} \\
\pi^*(s)& \textnormal{otherwise}
\end{cases}.
\]
As in the previous step, the inductive step suggests that showing $W(\pi,s)=W(\rho,s)$ is suffice. However, unlike the previous step, here the set of reachable terminal state is the same for $\pi$ and $\rho$; hence, this equality is almost immediate due to the Equivalence lemma. Let $\Psi'\defeq \prefix(a_{j_1},a_{j_2}\dots, a_{j_{K_2-1}})$ be the set of (possibly empty) prefixes of the arms in $\ul \setminus \{a_{j_{K_2}}\}$ according to $\pi^*$. Observe that we can factor $W(\pi,s)$ as follows:
\begin{align}\label{eq:w for pi with prob}
W(\pi,s) &= Q(\pi,U)\cdot R(\emptyset)+ \sum_{\psi \in \Psi}\Pr(\pathto{s}{(\ul \setminus \psi)})R(\ul \setminus \psi).
\end{align}
The next Claim \ref{claim:thm:step 2 claim} suggests we can replace probabilities with functions of $Q$.
\begin{claim}\label{claim:thm:step 2 claim}
For every $\psi \in \Psi$, it holds that 
\[
\Pr(\pathto{s}{(\ul \setminus \psi)})=Q(\pi,\ug, \psi)-Q(\pi,\ug,\psi \cup\{a_{j_{max(\psi)+1}} \}).
\]
\end{claim}
By applying the Equivalence lemma on the statement of  Claim \ref{claim:thm:step 2 claim}, we obtain that for every $\psi \in \Psi$
\[
\Pr(\pathto{s}{(\ul \setminus \psi)})=\Pr(\pathtorho{s}{(\ul \setminus \psi)});
\]
hence, we can rewrite Equation \refeq{eq:w for pi with prob} as 
\begin{align*}
W(\pi,s) &= Q(\rho,U)\cdot R(\emptyset)+ \sum_{\psi \in \Psi}\Pr(\pathtorho{s}{(\ul \setminus \psi)})R(\ul \setminus \psi)\\
&=W(\rho,s).
\end{align*}
This concludes the second step of the theorem.
\paragraph{Step 3 (final)} We are ready to prove the theorem. Fix arbitrary $a_{\tilde i}$ and $a_{\tilde j}$ such that $a_{\tilde i} \in \ug$ and  $a_{\tilde j} \in \ul$. By the previous steps, we know that
\[
W^*_{{i_1},{j_1}}(U)\stackrel{\textnormal{Step 2}}{=}W^*_{{\tilde i},{j_1}}(U)\stackrel{\textnormal{Step 1}}{\geq}W^*_{{\tilde i},{\tilde j}}(U).
\]
This ends the proof of Theorem \ref{thm:holy grail}.
\end{proofof}

