\begin{proposition}\label{prop:W case of one}
Let $U$ be a state such that $\abs{\above(U)}\geq 2$ and $\abs{\below(U)} =1$. 
It holds that $W(\pi^\star,U)=W^*(U)$.
\end{proposition}
\begin{proofof}{Proposition \ref{prop:W case of one}}
Denote $\below(U)=\{a_{j}\}$. We can assume w.l.o.g. that the realization of all arms in $\above(U)$ are non-positive, as otherwise every $\mP$-valid policy will explore all the arms; thus, $W^*(U)=Q^*(U)\cdot \max\{0, X_{a_{j}}  \}$. Finally, the Equivalence lemma suggests that   $Q^*(U)$ is policy invariant; hence, $W(\pi,U)=W^*(U)$ holds for any $\mP$-valid policy $\pi$, and in particular for $\pi=\pi^\star$.
\end{proofof}

\begin{proposition}\label{prop:W case of one strong}
Let $U$ be a state such that $\abs{\above(U)}=1$ and $\abs{\below(U)} \geq 2$. It holds that $W(\pi^\star,U)=W^*(U)$.
\end{proposition}
\begin{proofof}{Proposition \ref{prop:W case of one strong}}
This statement is a special case of Proposition \ref{prop:index with ugeq one} for instances satisfying Assumption \ref{assumption:dominance}.
\end{proofof}
\begin{proposition}\label{prop:index with ugeq one}
Let $U$ be a state such that $\abs{\above(U)}=1$ and $\abs{\below(U)} \geq 2$. Let $f^*$ be a real-valued function, $f^*:\below(U)\rightarrow \mathbb R$, such that for every $a_l \in \below(U)$,
\[
f^*(a_{l})=\frac{\Pr(X_{a_l} > 0 )\E(\max_{a_j \in {U} } X_{a_j}\mid X_{a_l}>0 )}{\abs{\mu(a_l)}}.
\]  
Denote by $\pi_{f^*}$ the right-ordered policy that orders $\below(U)$ according to decreasing order of $f^*$. Then, $W(\pi_{f^*},U)=W^*(U)$. 
%Let $R_1 \in [H]$ and $U\subseteq A$, and assume $\{a_i\}= U_>$ and $\abs{U_<}\geq 2$. If $\pi^\star(U,R_1,R_1)=\bl p_{ir}$ and $\pi^\star(U\setminus\{a_r' \},R_1,R_1)=\bl p_{ir'}$, then $\text{\red{what is the condition here}}$. Namely, if $\pi^\star$ selects $a_r$ before $a_{r'}$, then it has a higher \red{index}. \omer{Assuming the "order" I talked to Gal about}
\end{proposition}

\begin{proofof}{Proposition \ref{prop:index with ugeq one}}
Denote $\above(U)=\ug=\{a_{i}\}$  and $\below(U)=\ul=\{a_{j_1},\dots a_{j_k}\}$ for $k=\abs{\ul}$. Let $\pi$ be any right-ordered policy with the matching $\sigr_\pi$, such that $\pi\neq \pi_{f^*}$. Assume that there are indices $r,l$, for $1\leq r,l \leq k$, such that $\sigr_\pi(a_{l})<\sigr_\pi(a_{r})$ yet $f(a_{l})<f(a_{{r}})$, for arms $a_l,a_r\in \ul$. Moreover, if such a pair $(l,r)$ exists,  assume w.l.o.g. that $\sigr_\pi$ orders them consequentially, i.e., for every arm $a\in U$ such that $a\notin \{ a_{l}, a_{r} \}$,  either $\sigr_\pi(a)< \sigr_\pi(a_{l})$ or $\sigr_\pi(a)> \sigr_\pi(a_{r})$.


Denote by $\pi'$ the right-ordered policy that swaps $a_{l}$ and $a_{r}$. If we show that $\pi'$ yields a better reward than $\pi$, we could swap the order of $\pi$ one pair at a time, thereby showing that $\pi_{f^*}$ is indeed optimal. To simplify notation, we denote by $\ind_{a}$ the event that $X_a>0$ for arm $a\in U$.


Let $\ul'$ be the set of all arms in $\ul$ such that $\ul'=\{a\in \ul\mid \sigr_\pi(a)< \sigr_\pi(a_{l})  \}$. We divide the analysis into two cases: in case $X_{a_{i}} >0$ or $\max_{a\in \ul'} X_a > 0$, both $\pi,\pi'$ obtain the same reward. Otherwise, assume that $X_{a_{i}} \leq 0$ and $\max_{a\in \ul'} X_a \leq 0$ ; hence, in case arm $a_{i}$ is selected, the policy reaches a terminal state with a reward of 0. The reward of $\pi$ is given by 
{\small
\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align*}
W(\pi,U)=C_1 \left( \bl p_{i,l}(l)\E(\ind_l \max_{a_j \in {U_< \setminus \ul'}} X_{a_j} )+\bl p_{i,l}(l)\bl p_{i,r}(r)\E((1-\ind_l)\ind_r \max_{a_j \in {U_< \setminus \ul'}} X_{a_j})+\bl p_{i,l}(l)\bl p_{i,r}(r)C_2 \right),
\end{align*}}%
where $C_1$ and $C_2$ are constants that depend on $\sigr_\pi$. Similarly, the reward of $\pi'$ is given by 
{\small
\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align*}
W(\pi',U) = C_1\left( \bl p_{i,r}(r)\E(\ind_r \max_{a_j \in {U_< \setminus \ul'}} X_{a_j} )+\bl p_{i,r}(r)\bl p_{i,l}(l)\E((1-\ind_r)\ind_l \max_{a_j \in {U_< \setminus \ul'}} X_{a_j})+\bl p_{i,r}(r)\bl p_{i,l}(l)C_2 \right),
\end{align*}}%
where $C_1$ and $C_2$ are the same constants.
If $W(\pi,U)\geq W(\pi',U)$, then
\begin{align*}
& \bl p_{i,l}(l)\E(\ind_l \max_{a_j \in {U_< \setminus \ul'}} X_{a_j} )+\bl p_{i,l}(l)\bl p_{i,r}(r)\E((1-\ind_l)\ind_r \max_{a_j \in {U_< \setminus \ul'}} X_{a_j}) \\
&\qquad \geq \bl p_{i,r}(r)\E(\ind_r \max_{a_j \in {U_< \setminus \ul'}} X_{a_j} )+\bl p_{i,r}(r)\bl p_{i,l}(l)\E((1-\ind_r)\ind_l \max_{a_j \in {U_< \setminus \ul'}} X_{a_j}),
\end{align*}
implying that
\begin{align*}
&\bl p_{i,l}(l)\E(\ind_l \max_{a_j \in  {U_< \setminus \ul'}} X_{a_j} )(1-\bl p_{i,r}(r)) \geq \bl p_{i,r}(r)\E(\ind_r \max_{a_j \in  {U_< \setminus \ul'}} X_{a_j} )(1-\bl p_{i,l}(l)).
\end{align*}
Stated otherwise,
\begin{align*}
\frac{\bl p_{i,l}(l)\E(\ind_l \max_{a_j \in {U_< \setminus \ul'}} X_{a_j} )}{ 1-\bl p_{i,l}(l)} > \frac{\bl p_{i,r}(r)\E(\ind_r \max_{a_j \in {U_< \setminus \ul'}} X_{a_j} )}{1-\bl p_{i,r}(r) }.
\end{align*}
Finally, due to the definitions of $\bl p_{i,r},\ind_l$ and $\bl p_{i,l}, \ind_r$,
\begin{align*}
\frac{\Pr(X_{a_l} > 0 )\E(\max_{a_j \in {U_< \setminus \ul'} } X_{a_j}\mid X_{a_l}>0 )}{\abs{\mu(a_l)}} \geq \frac{\Pr(X_{a_l} > 0 )\E( \max_{a_j \in {U_< \setminus \ul'}} X_{a_j} \mid X_{a_r} >0 )}{\abs{\mu(a_r)}},
\end{align*}
which contradicts our assumption that $f(a_{l})<f(a_{r})$.
\end{proofof}


\begin{proofof}{Claim \ref{claim:f are equal}}
Notice that we can represent $f^\pi_Z$ as 
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\[
Q(\pi,\ug\setminus Z \cup \{a_{i(Z)}\}, \ul\setminus \{a_{j_1},a_{j_2},\dots,a_{j_{k}},a_{j_{k+1}} \})-Q(\pi,\ug\setminus Z, \ul\setminus \{a_{j_1},a_{j_2},\dots,a_{j_{k}},a_{j_{k+1}} \}),
\]}%
where $a_{i(Z)}$ is the minimal element in $Z$ according to $\sigl_\pi$. This process is similar in spirit to the proof of Proposition \ref{prop:coef c} and is hence omitted. Then, we can mirror the same arguments for $f^\rho_Z$. Finally, the Equivalence lemma suggests that the two representations are equal.
\end{proofof}


\begin{proofof}{Proposition \ref{prop: monotonicity in thm}}
We address the two parts separately below.
\paragraph{Part \ref{item:prop alphas rho pi}} 
Notice that the terminal state $(\ul\setminus \psi)$ is reachable from the left sub-tree of $\pi$ and $\rho$ solely (see Figure \ref{fig:helping for thm two} for illustration). Due to the construction of $\pi$ and $\rho$,
\begin{align}\label{eq:pi to rho}
\Pr(\pathto{s}{(\ul\setminus \psi)})&= \bl p_{{i_1},{j_k}}(a_{i_1})\Pr(\pathto{s\setminus \{a_{i_1}\}}{(\ul\setminus \psi)})\nonumber\\
&=\frac{-\mu(a_{j_{k}})}{- \mu(a_{j_{k}})+ \mu(a_{i_{1}})} \Pr(\pathto{s\setminus \{a_{i_1}\}}{(\ul\setminus \psi)})\nonumber\\
&=\frac{-\mu(a_{j_{k}})}{- \mu(a_{j_{k}})+ \mu(a_{i_{1}})} \Pr(\pathtorho{s\setminus \{a_{i_1}\}}{(\ul\setminus \psi)})\nonumber\\
&\leq\frac{-\mu(a_{j_{k+1}})}{- \mu(a_{j_{k+1}})+ \mu(a_{i_{1}})} \Pr(\pathtorho{s\setminus \{a_{i_1}\}}{(\ul\setminus \psi)})\nonumber\\
&\leq \bl p_{{i_1},{j_{k+1}}}(a_{i_1})\Pr(\pathtorho{s\setminus \{a_{i_1}\}}{(\ul\setminus \psi)})\nonumber \\
& = \Pr(\pathtorho{s}{(\ul\setminus \psi)}),
\end{align}
since $\mu(a_{j_{k+1}})\geq \mu(a_{j_{k}})$, and due to monotonicity of $f(x)=\frac{x}{x+c}$ for positive $c$. Using similar arguments, 
\begin{align}\label{eq: pi with rho again}
\Pr(\pathto{s}{(\ul\setminus (\psi \cup \{a_{j_k}\})}) \geq \Pr(\pathtorho{s}{(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})}).
\end{align}
Now, observe that
\begin{align}\label{eq: with Ez}
\Pr(\pathto{s}{(\ul\setminus \psi)}\mid E^\pi_\psi)
&=\frac{\Pr(\pathto{s}{(\ul\setminus \psi)})}{\Pr(\pathto{s}{(\ul\setminus \psi)}) +\Pr(\pathto{s}{(\ul\setminus (\psi \cup \{a_{j_k}\})})} \nonumber\\
&\stackrel{\textnormal{Eq. }(\ref{eq:pi to rho}),(\ref{eq: pi with rho again})}{\leq} \frac{\Pr(\pathtorho{s}{(\ul\setminus \psi)})}{\Pr(\pathtorho{s}{(\ul\setminus \psi)}) +\Pr(\pathtorho{s}{(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})})} \nonumber\\
&=\Pr(\pathtorho{s}{(\ul\setminus \psi)}\mid E^\rho_\psi),
\end{align}
where the second to last step follows again from monotonicity of $f(x)=\frac{x}{x+c}$ for positive $c$. Further, due to monotonicity of the reward function $R$,
\[
R(\ul\setminus (\psi\cup \{a_{j_k}\})) \geq R(\ul\setminus \psi), \qquad R(\ul\setminus (\psi\cup \{a_{j_{k+1}}\})) \geq R(\ul\setminus \psi).
\]
In addition, due to Assumption \ref{assumption:dominance}, $R(\ul\setminus (\psi\cup \{a_{j_k}\})) \geq  R(\ul\setminus (\psi\cup \{a_{j_{k+1}}\}))$. Wrapping up,
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align*}
\alpha^\pi_\psi&=\Pr(\pathto{s}{(\ul\setminus \psi)}\mid E^\pi_\psi)R(\ul\setminus \psi)+(1-\Pr(\pathto{s}{(\ul\setminus \psi)}\mid E^\pi_\psi))R(\ul\setminus (\psi \cup \{a_{j_k}\}))\\
&\geq \Pr(\pathto{s}{(\ul\setminus \psi)}\mid E^\pi_\psi)R(\ul\setminus \psi)+(1-\Pr(\pathto{s}{(\ul\setminus \psi)}\mid E^\pi_\psi))R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))\\
&\stackrel{\textnormal{Eq. }(\ref{eq: with Ez})}{\geq} \Pr(\pathtorho{s}{(\ul\setminus \psi)}\mid E^\rho_\psi)R(\ul\setminus \psi)+(1-\Pr(\pathtorho{s}{(\ul\setminus \psi)}\mid E^\rho_\psi))R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))\\
&=\alpha^\rho_\psi.
\end{align*}}%
This completes the proof of the first part.
%\paragraph{Part \ref{item:prop E}} \omer{TODO! but not sure we need it papers on the wall}This completes the proof of the second part.

\paragraph{Part \ref{item:prop alphas alpha pi}} We prove the claim for $\alpha^\rho_{l+1} \geq \alpha^\rho_{l}$, and the other part is symmetrical. Let $\psi=\psi(l)$ such that $\max(\psi)=l$. Notice that the reward function $R$ is a set function, and is, by definition monotonically decreasing; hence, $R(\ul\setminus \psi) \leq R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))$. Consequently,
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align*}
\alpha^\rho_\psi&=\Pr(\pathtorho{s}{(\ul\setminus \psi)}\mid E^\rho_\psi)R(\ul\setminus \psi)+\Pr(\pathtorho{s}{(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})}\mid E^\rho_\psi)R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))\nonumber\\
&\leq R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})).
\end{align*}}%
Further, let $\psi'$ such that $\max(\psi')=l+1$, namely $\psi'=\psi\cup\{a_{j_{l+1}} \}$. Using the same properties of $R$, we have that $R(\ul\setminus \psi') \leq R(\ul\setminus (\psi' \cup \{a_{j_{k+1}}\}))$; thus,
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align*}
\alpha^\rho_{\psi'}&=\Pr(\pathtorho{s}{(\ul\setminus \psi')}\mid E^\rho_{\psi'})R(\ul\setminus \psi')+\Pr(\pathtorho{s}{(\ul\setminus (\psi' \cup \{a_{j_{k+1}}\})}\mid E^\rho_{\psi'})R(\ul\setminus (\psi' \cup \{a_{j_{k+1}}\}))\nonumber\\
&\geq R(\ul\setminus \psi' ).
\end{align*}}%
Next, let $V_\psi$ denote the event that $(X_{a})_{a\in \psi}$ attain value below $\alpha$. Observe that 
{\thinmuskip=.2mu
\medmuskip=0mu plus .2mu minus .2mu
\thickmuskip=1mu plus 1mu
\begin{align*}
R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})) &=\Pr(V_\psi)R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))+(1-\Pr(V_\psi))R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\}))\nonumber\\
&=\Pr(V_\psi)\max\{\alpha,X_{a_{j_{k+1}}}\}+(1-\Pr(V_\psi))\max\{a_{j_1},\dots ,a_{j_l},a_{j_{k+1}}  \}\nonumber\\
&\leq \Pr(V_\psi)\max\{\alpha,X_{a_{j_{l+1}}}\}+(1-\Pr(V_\psi))\max\{a_{j_1},\dots ,a_{j_l},a_{j_{l+1}}  \}\\
&=R(\ul\setminus \psi' ) ,
\end{align*}}%
where the second to last inequality is due to Assumption \ref{assumption:dominance} and independence of $(X_{a_i})_{i=1}^K$. Ultimately, 
\[
\alpha^\rho_{l+1}=\alpha^\rho_{\psi'} \geq R(\ul\setminus \psi' ) \geq R(\ul\setminus (\psi \cup \{a_{j_{k+1}}\})) \geq \alpha^\rho_{\psi}=\alpha^\rho_{l}.
\]
This completes the proof of the second part.
\end{proofof}

\begin{proofof}{Claim \ref{claim:thm:step 2 claim}}
The proof goes along the lines of Claim \ref{claim:f are equal}, and is hence omitted.
\end{proofof}
