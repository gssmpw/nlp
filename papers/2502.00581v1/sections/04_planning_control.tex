\section{Trajectory Planning}
\label{sec:Planning}

% problem definition for motion planning 
%In the previous section, we introduced the differentially flat model for FW constrained to a coordinated flying condition. 
We focus on designing an optimal, dynamically feasible trajectory for a FW that leverages the differential flatness property and employs Bernstein polynomials adhering to the following conditions

 %Using this concise yet powerful representation, it is possible to obtain the desired input $\mathbf{u}$ to the vehicle directly from the third derivative of the desired trajectory $\rho(t)$, which has to be continuous and differentiable, in order to guarantee smooth roll rate control. 
 
\begin{itemize}
    \item The axial velocity of the plane $\dot{x}_{x} \neq 0$.
    \item The trajectory should satisfy that $a_{v_z} \neq 0 $.
    \item Bounding the maximum curvature $\kappa$ of the trajectory.
\end{itemize}
We formulate a convex quadratic optimization of Bernstein polynomials to minimize the trajectory jerk $\mathbf{x}_{r}^{(3)}(t)$ (input in eq. \eqref{eq:differential_flatness}) while keeping velocity, acceleration and curvature $\kappa$ constraints within specified bounds. %Since the FW aircraft are constrained to continuous forward motion.%, each Bernstein trajectory is followed by a circular loitering motion with a predetermined radius when no new trajectory is defined. This loitering phase serves as the fixed-wing equivalent of the hovering phase seen in quadrotors or tail-sitters, as described in \cite{lu2024trajectory}.

%that will span  entire flight is significantly challenging compared to multi-rotor platforms \cite{loianno2016estimation}. Unlike quadrotors or tail-sitters \cite{lu2024trajectory}, which can hover in place, fixed-wing must continue its forward motion. This constraint forces the fixed wing either to immediately transition into a loiter motion or begin a new trajectory as soon as it completes its current one. In addition to a smooth transition between trajectories, it is important to respect the kino-dynamic constraint of a fixed-wing while generating these trajectories, particularly its minimum turning radius, which directly influences the required roll angle during flight. Respecting these kino-dynamic constraints and ensuring smooth transitions between trajectories is important to maintain stability and control throughout the entire flight. 

% solution discussion about a seamless transition
%To ensure the seamless transition between trajectories, we generate continuous and dynamically feasible trajectories within the vehicle's flat output space, defined by the vector $\mathbf{x}$. Throughout the entire flight span, the vehicle's trajectory is composed of three distinct types of polynomial trajectories: i) line trajectory, ii) loiter trajectory, and iii) Bernstein Trajectory. Each of these trajectories is defined by a sequence of flat outputs, which correspond to the desired positions and their higher derivatives up to the jerk at each time $t$ from the initial time $t_0$ to a final time $t_f$ for the respective trajectory.




\subsection{Bernstein Trajectory}
\label{sec:planner}

A Bernstein polynomial shows interesting properties in terms of smoothness and ability to impose global spatial constraints compared to time-based polynomials~\cite{kielas2019bebot,kielas2022bernstein}. For a given $m_j$  trajectory, it can be described by the following form of degree $n$
\begin{equation}
C_{n,m_j}(t) = \sum_{i=0}^{n}\mathbf{p}_{i,n}^{m_j}\beta^n_i(t),   \quad t\in [t_0, t_f]
\label{eq:bernstein_equation}
\end{equation}
where $\mathbf{p}_{i,n}^{m_j}$ are the Bernstein coefficient or control points of  size $n$ control, and $\beta^n_i(t)$ is the Bernstein basis. The $k^{\text{th}}$ derivative of the polynomial can be obtained as
\begin{equation}
\frac{d^{k}}{dt^{k}}C_{n,m_j}(t) = \frac{n!}{(n-k)!(t_f - t_0)^k} \sum_{i=0}^{n-k} {{\mathbf{p}}^{{m_j}^{'}}_{i,n-k}}\beta_{i}^{n-k}(t),
\label{eq:bernstein_derivative}
\end{equation}
with ${\mathbf{p}}^{{m_j}^{'}}_{i,n-k} = \mathbf{p}_{i,n}^{m_j}\mathbf{D}_k$ and $\mathbf{D}_k = \text{diag}(\mathbf{c}\circledast^k, \mathbf{c}\circledast^k, \cdots, \mathbf{c}\circledast^k)$ is the Differential matrix with $ \mathbf{c} = [-1, 1]$ convoluted $k$ times. Considering $M+1$ waypoints, a full trajectory $\mathbf{x}_{r}(t)$ can be modeled by stacking together $M$ Bernstein polynomials connected at the extremal points as

%A trajectory $\rho(t)$ can be efficiently modeled as a piece-wise stacking of consecutive Bernstein polynomial segments passing through multiple waypoints, combined into a single optimized Bernstein polynomial and connected at the extremes in order to be continuous-time in the flat output space $\mathbf{x}=\{x, y, z\}$ and its higher derivatives. 

%These trajectories can be efficiently optimized and evaluated under various constraints, including velocity, acceleration, and, especially in our case, roll rate and turning radius. By representing continuous-time trajectories as piecewise BÃ©zier curves passing through multiple waypoints, these can be combined into a single Bernstein polynomial after optimization, ensuring both computational efficiency and respect the imposed constraints.

 %The general equation of Bernstein polynomial trajectory for a single dimension is represented as \cite{kielas2022bernstein}
%\begin{equation}
%C_n(t) = \sum_{i=0}^{n}\mathbf{p}_{i,n}\beta^n_i(t),   \quad t\in [t_0, t_f]
%\label{eq:bernstein_equation}
%\end{equation}

%where $\mathbf{p}_{i,n}$ are the Bernstein coefficient or control points, with each segment having a total of $n$ control points, and $\beta^n_i(t)$ is the Bernstein basis. To represent the complete trajectory passing through $M+1$ waypoints, we employ a set of $M$ Bernstein polynomials, where $M$ is the total number of trajectory segments:

\begin{equation}
\mathbf{x}_{r}(t)  = 
\begin{cases} 
    \sum_{i=0}^{n}\mathbf{p}_{i,n}^{m_1}\beta_i^n(T_1 - t) \quad \text{for} \ t\in [0, T_1]\\
    \sum_{i=0}^{n}\mathbf{p}_{i,n}^{m_2}\beta_i^n(T_2 - t) \quad \text{for} \ t\in [T_1, T_2] \\
    \vdots \\ 
    \sum_{i=0}^{n}\mathbf{p}_{i,n}^{M}\beta_i^n(T_{M}-t) \quad \text{for} \ t\in [T_{M-1}, T_M]
\end{cases}
\label{eq:piecewise_bernstein_equation}
\end{equation}
where $\mathbf{p}_{i,n}^{m_j}$ is the $i^{th}$ control point of the $m_j$ sub trajectory, with $j \in [1, M]$, and the time instants $T_1, T_2, \dots, T_M$ represent the allocated time for each of sub trajectory. 

%\begin{itemize}
%\item $P^{'}_{i,n-m} = P_{i,n}\mathbf{D}_m$
%\item Differential Matrix: $\mathbf{D}_m = \begin{bmatrix}\mathbf{s}\circledast^m  & 0 & \cdots  & 0 \\ 0 & \mathbf{s}\circledast^m & \cdots  & 0 \\\vdots  & \vdots  & \ddots  & \vdots  \\0 & 0 & \cdots  & \mathbf{s}\circledast^m\end{bmatrix}$
%\item $\mathbf{s} = [-1, 1] \quad \text{and} \quad \underbrace{s \circledast s \circledast \cdots \circledast s}_{m}=\mathbf{s}\circledast^m$
%\end{itemize}

To find the Bernstein Coefficients $\mathbf{p}$ we formalize  a Convex Quadratic Programming (QP) problem \cite{mao2023robust}
\begin{equation}
\begin{aligned}
\text{min} \quad & \mathbf{p}_d^T\mathbf{Q} \mathbf{p}_d\\
\text{s.t.} \quad & \mathbf{A}_{eq}\mathbf{p}_d = \mathbf{b}_{eq} \\
& \mathbf{A}_{ineq}\mathbf{p}_d \le  \mathbf{b}_{ineq}
\end{aligned}
\end{equation}
where $\mathbf{Q} = \text{diag}(Q_1, \hdots, Q_M)$ with $Q_i \in \mathbb{R}^{n \times n}$ representing the Hessian semi-definite matrix of the objective function, related to the $n$ number of Bernstein Coefficients each sub trajectory. The vector $\mathbf{p}_d$, with dimension $M \times n$, contains the Bernstein coefficients to be optimized for each spatial dimension $d$. To ensure continuity in position and higher derivatives between the segments, the optimization problem is subject to various equality and inequality constraints, which are represented by the matrices $\mathbf{A}_{eq}, \mathbf{A}_{ineq}$, and vectors $\mathbf{b}_{eq}, \mathbf{b}_{ineq}$


% Matrix $\mathbf{A}_{eq}, \mathbf{A}_{ineq}$, and vector $\mathbf{b}_{eq}, \mathbf{b}_{ineq}$ are derived from the equality and inequality constraints imposed by user for each dimension $d$. 
%The optimization problem is solved using an off-the-shelf OOQP \cite{gertz2003object} convex solver. 

% The vectors $\mathbf{b}_{id}$ consists of all number $i$ of constraints imposed by the user for each dimension $d$. Finally the matrix $\mathbf{A}  = \text{diag}(A_1, \hdots, A_j, \hdots, A_m)$ is composed by submatrix $A_j$ which one with dimension $A_j \in \mathbb{R}^{i \times n}$ and it is stacked for the $d$ dimesions of the polynomial.

\begin{enumerate}
    \renewcommand{\labelenumi}{\roman{enumi}.}
    \item \textit{Endpoint constraint:}
    Considering a starting time $t_0$ and an ending time $t_{f}$, we constrain $\mathbf{x}_{r}$ at the reference waypoints position $\mathbf{x}_{r}$, velocity $\dot{\mathbf{x}}_{r}$, and acceleration $\ddot{\mathbf{x}}_{r}$
     \begin{equation}\begin{aligned}
        C_{n,0}^{(k)}(t_0) = \mathbf{x}^{(k)}(t_0), \qquad C_{n,M}^{(k)}(t_f) = \mathbf{x}^{(k)}(t_f) 
    \end{aligned}.\end{equation}

    \item \textit{Continuity Constraints:}
    %Given a set $S_{\mathcal{B}}$ of $m_{i+1}$ waypoints, defined by a starting and ending time $t_{{m}_0}$ $t_{{m}_f}$,
    The goal is to ensure the continuity in position and higher derivatives of the trajectory $\mathbf{x}_r(t)$ at the junction of the $M$ sub trajectories as

    % \begin{equation}\begin{aligned}
    % \mathbf{C_m}(t_f) = \mathbf{C_{m+1}}(0) \\
    % \left\|  \mathbf{\dot{C}_m}(t_f) \right\| = \left\| \mathbf{\dot{C}_{m+1}}(0) \right\| \\
    % \left\|  \mathbf{\ddot{C}_m}(t_f) \right\| = \left\| \mathbf{\ddot{C}_{m+1}}(0) \right\|
    % \end{aligned}\end{equation}

    \begin{equation}\begin{aligned}
        C_{n,m}(t_{f}) = C_{n,m+1}(t_{{0}}). \\
    \end{aligned}\end{equation}



    
    \item \textit{Dynamic feasibility Constraints:}
    Given the FW dynamics, the curvature $\kappa = f(\dot{\mathbf{x}}_{r_x}, \dot{\mathbf{x}}_{r_y}, \ddot{\mathbf{x}}_{r_x}, \ddot{\mathbf{x}}_{r_y})$ evaluated from $t_0$ to $t_f$ of a given trajectory, needs to be constrained for its entire duration within the range  $\kappa_{min} \leq \kappa \leq \kappa_{max}$ to be considered feasible in order to avoid exceeding the maximum roll angle of the aircraft. Due to the non-linear nature of the curvature function $\kappa$, we apply a Taylor expansion around the equilibrium point to linearize the constraint, allowing us to maintain the original convex optimization problem formulation. The constraint  $k$ on the lineared curve is
    
    %The curvature $\kappa$ is a nonlinear function of $v_x, v_y, a_x$ and $a_y$ as expressed in the following equation:

    %\begin{equation}\begin{aligned}
   % k = f(v_x, v_y, a_x, a_y) = \frac{v_xa_y - a_xv_y}{(v_x^2 + v_y^2)^{3/2}}
    %\label{eq:curvature_k}
    %\end{aligned}\end{equation}

    \begin{equation}
    \begin{split}
        % &\phantom{=} k_{min} \leq k \leq k_{max} \\
        & \kappa_{min} \leq 
f(\dot{\mathbf{x}}_{r_x}, \dot{\mathbf{x}}_{r_y}, \ddot{\mathbf{x}}_{r_x}, \ddot{\mathbf{x}}_{r_y}) + \\
        &\begin{bmatrix} 
            \frac{\partial f}{\partial  \dot{\mathbf{x}}_{r_x}} &  \frac{\partial f}{\partial  \dot{\mathbf{x}}_{r_y}} & 
            \frac{\partial f}{\partial  \ddot{\mathbf{x}}_{r_x}} & \frac{\partial f}{\partial  \ddot{\mathbf{x}}_{r_y}}
        \end{bmatrix}
        \begin{bmatrix} 
            \dot{\mathbf{x}}_{r_x} - \dot{\mathbf{x}}_{r_x}(t_{rp}) \\\dot{\mathbf{x}}_{r_y} - \dot{\mathbf{x}}_{r_y}(t_{rp}) \\ \ddot{\mathbf{x}}_{r_x} - \ddot{\mathbf{x}}_{r_x}(t_{rp})  \\ \ddot{\mathbf{x}}_{r_y} - \ddot{\mathbf{x}}_{r_y}(t_{rp}) 
        \end{bmatrix} 
        \leq \kappa_{max}.
    \end{split}
    \label{eq:curvature}
    \end{equation}
    where $t_{rp} \in [t_0, t_f]$ represents the time instant where the linearization is applied.
    In particular, for a continuous linearization of the entire trajectory around a local point, a replanning strategy visible in Fig. \ref{fig:planned_mission} (top right) is applied at constant intervals. To avoid discontinuities between the current trajectory $\mathbf{x}_{r, j-1}$ and new replanned trajectory $\mathbf{x}_{r, j}$, we account for the optimization time $t_{opt}$ such that $\mathbf{x}_{r, j}(t_0) = \mathbf{x}_{r, j-1}(t + t_{opt})$.
    
    %The Taylor series approximation of the nonlinear constraint $k$ is accurate near the equilibrium point but insufficient for the entire trajectory. To address this problem, we implemented periodic replanning to maintain the $k$-constaint throughout the trajectory. As shown in Figure \ref{fig:planned_mission} (upper right), the replanning strategy is applied at constant intervals. In order  This transition point ensures continuity, allowing the aircraft to seamlessly switch to the new replanned trajectory when it reaches the $\rho(s(t))_j$. The real-world implementation and effectiveness of this strategy are discussed in the experimental results section. 
   
    
\end{enumerate}



