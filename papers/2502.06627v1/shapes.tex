%
% declare a new shape for the service interface
\makeatletter

\pgfdeclareshape{openinterface}
{
  \inheritsavedanchors[from=circle] % this is nearly a circle
  \inheritanchorborder[from=circle]
  \inheritanchor[from=circle]{north}
  \inheritanchor[from=circle]{north west}
  \inheritanchor[from=circle]{north east}
  \inheritanchor[from=circle]{center}
  \inheritanchor[from=circle]{west}
  \inheritanchor[from=circle]{east}
  \inheritanchor[from=circle]{mid}
  \inheritanchor[from=circle]{mid west}
  \inheritanchor[from=circle]{mid east}
  \inheritanchor[from=circle]{base}
  \inheritanchor[from=circle]{base west}
  \inheritanchor[from=circle]{base east}
  \inheritanchor[from=circle]{south}
  \inheritanchor[from=circle]{south west}
  \inheritanchor[from=circle]{south east}
  \backgroundpath{
    \centerpoint%
    \pgf@xc=\pgf@x%                 \pgf@xc = x value of centerpoint
    \pgf@yc=\pgf@y%                 \pgf@yc = y value of centerpoint
    \pgfutil@tempdima=\radius%      \pgfutil@tempdima = radius
	 \pgfpathmoveto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{+1pt}{\pgfutil@tempdima}}}
    \pgfpatharc{80}{280}{\pgfutil@tempdima}
  }
}
\pgfdeclareshape{interface}
{
  \inheritsavedanchors[from=circle] % this is nearly a circle
  \inheritanchorborder[from=circle]
  \inheritanchor[from=circle]{north}
  \inheritanchor[from=circle]{north west}
  \inheritanchor[from=circle]{north east}
  \inheritanchor[from=circle]{center}
  \inheritanchor[from=circle]{west}
  \inheritanchor[from=circle]{east}
  \inheritanchor[from=circle]{mid}
  \inheritanchor[from=circle]{mid west}
  \inheritanchor[from=circle]{mid east}
  \inheritanchor[from=circle]{base}
  \inheritanchor[from=circle]{base west}
  \inheritanchor[from=circle]{base east}
  \inheritanchor[from=circle]{south}
  \inheritanchor[from=circle]{south west}
  \inheritanchor[from=circle]{south east}
  \backgroundpath{
    \centerpoint%
    \pgf@xc=\pgf@x%                 \pgf@xc = x value of centerpoint
    \pgf@yc=\pgf@y%                 \pgf@yc = y value of centerpoint
    \pgfutil@tempdima=\radius%      \pgfutil@tempdima = radius
	 \pgfpathmoveto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{+1pt}{.95\pgfutil@tempdima}}}
    \pgfpatharc{80}{280}{\pgfutil@tempdima}
  }
  \foregroundpath{
	 \centerpoint
    \pgf@xc=\pgf@x%                 \pgf@xc = x value of centerpoint
    \pgf@yc=\pgf@y%                 \pgf@yc = y value of centerpoint
    \pgfutil@tempdima=\radius%      \pgfutil@tempdima = radius
    \pgfutil@tempdimb=\radius%      \pgfutil@tempdima = radius
	 \advance\pgfutil@tempdima by-.25\pgfutil@tempdima%
	 \pgfcircle{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfpoint{+.25\pgfutil@tempdimb}{0pt}}}{\pgfutil@tempdima}
	 \pgfusepath{fill}
  }
}
% UML component
\pgfdeclareshape{umlcomponent}
{
  \inheritsavedanchors[from=rectangle] % this is nearly a rectangle
  \inheritanchorborder[from=rectangle]
  \inheritanchor[from=rectangle]{north}
  \inheritanchor[from=rectangle]{north west}
  \inheritanchor[from=rectangle]{north east}
  \inheritanchor[from=rectangle]{center}
  \inheritanchor[from=rectangle]{west}
  \inheritanchor[from=rectangle]{east}
  \inheritanchor[from=rectangle]{mid}
  \inheritanchor[from=rectangle]{mid west}
  \inheritanchor[from=rectangle]{mid east}
  \inheritanchor[from=rectangle]{base}
  \inheritanchor[from=rectangle]{base west}
  \inheritanchor[from=rectangle]{base east}
  \inheritanchor[from=rectangle]{south}
  \inheritanchor[from=rectangle]{south west}
  \inheritanchor[from=rectangle]{south east}
  \backgroundpath{
	  \newdimen\pgf@xd\newdimen\pgf@yd
	  \newdimen\pgf@xe\newdimen\pgf@ye
	  \newdimen\pgf@xf\newdimen\pgf@yf
		% store lower right in xa/ya and upper right in xb/yb
		\southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
		\northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
		% compute west point as well as vertical distance and height of decoration
		\pgf@xc=\pgf@xa \pgf@yc=.5\pgf@yb \advance\pgf@yc by .5\pgf@ya
		\pgf@yd=.3\pgf@yb
		\pgf@ye=.2\pgf@yb
%		% compute position of second decoration in xe/ye and xf/yf
%		\pgf@xe=\pgf@xa \pgf@ye=.1\pgf@y
%		\pgf@xf=\pgf@xa \pgf@yf=.2\pgf@ya
		% draw main shape
		\pgfpathmoveto{\pgfpoint{\pgf@xa}{\pgf@ya}}
		\pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc-\pgf@yd-\pgf@ye}}
		\pgfpathlineto{\pgfpoint{\pgf@xc-\pgf@ye}{\pgf@yc-\pgf@yd-\pgf@ye}}
		\pgfpathlineto{\pgfpoint{\pgf@xc-\pgf@ye}{\pgf@yc-\pgf@yd}}
		\pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc-\pgf@yd}}
		\pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc+\pgf@yd}}
		\pgfpathlineto{\pgfpoint{\pgf@xc-\pgf@ye}{\pgf@yc+\pgf@yd}}
		\pgfpathlineto{\pgfpoint{\pgf@xc-\pgf@ye}{\pgf@yc+\pgf@yd+\pgf@ye}}
		\pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc+\pgf@yd+\pgf@ye}}
		\pgfpathlineto{\pgfpoint{\pgf@xa}{\pgf@yb}}
		\pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@yb}}
		\pgfpathlineto{\pgfpoint{\pgf@xb}{\pgf@ya}}
		\pgfpathclose
		% draw internal lines
		\pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc-\pgf@yd}}
		\pgfpathlineto{\pgfpoint{\pgf@xc+\pgf@ye}{\pgf@yc-\pgf@yd}}
		\pgfpathlineto{\pgfpoint{\pgf@xc+\pgf@ye}{\pgf@yc-\pgf@yd-\pgf@ye}}
		\pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc-\pgf@yd-\pgf@ye}}
		\pgfpathmoveto{\pgfpoint{\pgf@xc}{\pgf@yc+\pgf@yd+\pgf@ye}}
		\pgfpathlineto{\pgfpoint{\pgf@xc+\pgf@ye}{\pgf@yc+\pgf@yd+\pgf@ye}}
		\pgfpathlineto{\pgfpoint{\pgf@xc+\pgf@ye}{\pgf@yc+\pgf@yd}}
		\pgfpathlineto{\pgfpoint{\pgf@xc}{\pgf@yc+\pgf@yd}}
  }
}

% arrows
\pgfarrowsdeclare{srvarrow}{srvarrow}{%
  \pgfutil@tempdima=4pt\relax
  \advance\pgfutil@tempdima-\pgflinewidth
  \pgfarrowsleftextend{+-\pgfutil@tempdima}%
  \pgfarrowsrightextend{+1.5\pgflinewidth}%
}{%
  \pgftransformshift{\pgfqpoint{0.4\pgfutil@tempdima}{0pt}}%
  \pgfpathmoveto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{-0.5\pgfutil@tempdima}{0.94\pgfutil@tempdima}}}%
  \pgfpatharc{110}{-110}{\pgfutil@tempdima}
  \pgfsetfillcolor{white}
  \pgfusepathqfill
  \pgftransformshift{\pgfqpoint{0.35\pgfutil@tempdima}{0pt}}%
  \pgfpathmoveto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{-0.8\pgfutil@tempdima}{0.94\pgfutil@tempdima}}}%
  \pgfpatharc{110}{-110}{\pgfutil@tempdima}
  \pgfsetfillcolor{.}
  \pgfusepathqstroke
  \pgftransformshift{\pgfqpoint{-0.5\pgfutil@tempdima}{0pt}}%
  \pgfpathmoveto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{-0.55\pgfutil@tempdima}{.98\pgfutil@tempdima}}}%
  \pgfcircle{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfpoint{+0.2\pgfutil@tempdimb}{0pt}}}{0.75\pgfutil@tempdima}
  \pgfsetfillcolor{.}
  \pgfusepathqfill
}

\pgfarrowsdeclare{srvrequired}{srvrequired}{%
  \pgfutil@tempdima=4pt\relax
  \advance\pgfutil@tempdima-\pgflinewidth
  \pgfarrowsleftextend{+-\pgfutil@tempdima}%
  \pgfarrowsrightextend{+1.5\pgflinewidth}%
}{%
  \pgftransformshift{\pgfqpoint{0.35\pgfutil@tempdima}{0pt}}%
  \pgfpathmoveto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{1.3\pgfutil@tempdima}{0.95\pgfutil@tempdima}}}%
  \pgfpatharc{80}{280}{\pgfutil@tempdima}
  \pgfsetfillcolor{.}
  \pgfusepathqstroke 
}

\pgfarrowsdeclare{srvprovided}{srvprovided}{%
  \pgfutil@tempdima=4pt\relax
  \advance\pgfutil@tempdima-\pgflinewidth
  \pgfarrowsleftextend{+-\pgfutil@tempdima}%
  \pgfarrowsrightextend{+1.5\pgflinewidth}%
}{%
  \pgfpathmoveto{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfqpoint{-0.4\pgfutil@tempdima}{.98\pgfutil@tempdima}}}%
  \pgfcircle{\pgfpointadd{\pgfqpoint{\pgf@xc}{\pgf@yc}}{\pgfpoint{+0.2\pgfutil@tempdimb}{0pt}}}{0.75\pgfutil@tempdima}
  \pgfsetfillcolor{.}
  \pgfusepathqfill 
}


\pgfdeclareshape{vehicle}
{
	 \savedanchor{\center}{
		\pgfpointorigin
	}
	\savedanchor{\cog}{
		\pgfpointadd{\pgfpointorigin}{\pgfpoint{-0.5cm}{0cm}}
	}
	\savedanchor{\origin}{
		\pgfpointadd{\pgfpointorigin}{\pgfpoint{-0.8cm}{0cm}}
	}
	\savedanchor{\front}{
		\pgfpointadd{\pgfpointorigin}{\pgfpoint{1.5cm}{0cm}}
	}
	\savedanchor{\rear}{
		\pgfpointadd{\pgfpointorigin}{\pgfpoint{-1.5cm}{0cm}}
	}
	\savedanchor{\upperleft}{
		\pgfpointadd{\pgfpointorigin}{\pgfpoint{-0.5cm}{0.5cm}}
	}
	\savedanchor{\lowerleft}{
		\pgfpointadd{\pgfpointorigin}{\pgfpoint{-0.5cm}{-0.5cm}}
	}
	\anchor{center}{\center}
	\anchor{cog}{\cog}
	\anchor{origin}{\origin}
	\anchor{front}{\front}
	\anchor{rear}{\rear}
	\anchor{west}{\left}
	\anchor{east}{\right}
	\backgroundpath{
    	\expandafter\let\expandafter\pgfsavedstrokecolor\csname\string\color@pgfstrokecolor\endcsname
		\pgf@xc=\pgf@x%                 \pgf@xc = x value of centerpoint
		\pgf@yc=\pgf@y%                 \pgf@yc = y value of centerpoint
		\pgftransformscale{8}
		\pgfpathmoveto{\pgfpointadd{\pgfpointorigin}{\pgfpoint{0.055cm}{-2.4}}}
		\pgfpathsvg{m 0,0 c 0.0308,0.13266 0.0758,0.27807 0.1092,0.37722 -0.007,0.003 -0.4436,-0.002 -0.97048,-0.0114 -0.87783,-0.0147 -1.03106,-0.0153 -1.82986,-0.004 -0.71279,0.01 -0.91136,0.01 -1.08934,10e-4 -0.39667,-0.0206 -0.77743,-0.003 -1.17616,0.0532 -0.0998,0.0142 -0.24948,0.0318 -0.33228,0.0398 -0.38256,0.0395 -0.75861,0.0824 -1.08417,0.1928 -0.12972,0.0803 -0.22624,0.1779 -0.27853,0.28112 -0.0492,0.0971 -0.15119,0.51145 -0.19379,0.78755 -0.0836,0.46772 -0.0505,0.99968 -5.2e-4,1.40567 0.0426,0.2761 0.14459,0.69045 0.19379,0.78755 0.0523,0.10322 0.14881,0.20082 0.27853,0.28112 0.32556,0.12455 0.7655,0.16241 1.08418,0.19271 0.0828,0.008 0.23248,0.0256 0.33228,0.0398 0.39873,0.0562 0.77948,0.0738 1.17615,0.0532 0.17798,-0.009 0.37655,-0.009 1.08934,0.001 0.7988,0.0112 0.95203,0.0106 1.82986,-0.004 0.52688,-0.009 0.96349,-0.0144 0.97049,-0.0114 -0.0372,0.12893 -0.079,0.26258 -0.1092,0.37721 0.0859,0.003 0.16072,0.002 0.20708,-0.006 0.10563,-0.1056 0.19121,-0.24562 0.2327,-0.38147 0.2485,-0.009 0.50354,-0.007 0.74672,-0.003 0.31623,0.0178 0.67684,0.007 1.05162,-0.031 0.31915,-0.0323 0.67421,-0.18303 0.94258,-0.40049 0.21095,-0.19094 0.3535,-0.37017 0.4987,-0.58703 0.0955,-0.68869 0.10307,-1.43594 10e-4,-2.02314 -0.13761,-0.22291 -0.32681,-0.41931 -0.4987,-0.58703 -0.26837,-0.21746 -0.62343,-0.36819 -0.94258,-0.40049 -0.37478,-0.038 -0.73538,-0.0488 -1.05161,-0.031 -0.27247,0.01 -0.47316,0.003 -0.74673,-0.003 -0.068,-0.20326 -0.17394,-0.32302 -0.21807,-0.35758 -0.0874,-0.0486 -0.11683,-0.0386 -0.2222,-0.0294 z}
	}
  \beforebackgroundpath{
	\pgf@xc=\pgf@x%                 \pgf@xc = x value of centerpoint
	\pgf@yc=\pgf@y%                 \pgf@yc = y value of centerpoint
	\pgfutil@definecolor{windowblue}{RGB}{168,196,196}
	\pgfpathmoveto{\pgfpointadd{\pgfpointorigin}{\pgfpoint{0.055cm}{-2.4}}}
	\pgfpathsvg{m -2.28723, 0.55668 c -0.32841,5e-5 -1.43918,0.0302 -1.48725,0.0403 -0.0232,0.005 -0.0231,0.006 0.0103,0.21187 l 0.0186,0.11473 0.15968,0.003 c 0.2659,0.005 1.31692,-0.0245 1.32912,-0.0367 0.0163,-0.0162 0.12751,-0.3088 0.12247,-0.32195 -0.003,-0.009 -0.0383,-0.0115 -0.15296,-0.0114 z m 0.6227,0.006 c -0.0219,0.0125 -0.26071,0.31771 -0.25528,0.32246 0.66703,0.003 1.41404,-0.0423 2.01745,-0.1746 0.0939,-0.022 0.10042,-0.0251 0.11731,-0.0537 0.0311,-0.0526 0.0299,-0.0533 -0.0992,-0.0594 -0.5927,-0.0184 -1.18929,-0.0423 -1.78028,-0.0348 z m -2.40708,0.0481 c -0.10328,-0.009 -1.36469,0.0745 -1.44695,0.0966 -0.0422,0.0113 -0.0811,0.0491 -0.0811,0.0718 0,0.01 0.012,0.039 0.0264,0.0641 v 5.2e-4 c 0.034,0.0594 0.0664,0.0743 0.18087,0.0847 0.0492,0.004 0.38906,0.008 0.7555,0.008 0.52523,2.3e-4 0.66715,-0.002 0.67025,-0.0109 0.002,-0.006 -0.0127,-0.079 -0.0336,-0.16174 l -0.0382,-0.15038 z m -2.64687,2.28254 c 0.0361,0.36599 0.11901,0.71377 0.21601,0.90641 0.0443,0.088 0.10539,0.17052 0.14469,0.19482 l 0.0315,0.0191 0.15555,-0.0987 c 0.0854,-0.0543 0.15554,-0.10194 0.15554,-0.10594 0,-0.004 -0.0144,-0.016 -0.032,-0.0269 -0.0664,-0.041 -0.14428,-0.17356 -0.19688,-0.33538 -0.0873,-0.26877 -0.1308,-0.64875 -0.13074,-1.02474 -7e-5,-0.376 0.0434,-0.75598 0.13074,-1.02475 0.0526,-0.16182 0.13051,-0.29436 0.19688,-0.33538 0.0176,-0.0109 0.032,-0.0229 0.032,-0.0269 0,-0.004 -0.0701,-0.0516 -0.15554,-0.10594 l -0.15555,-0.0987 -0.0315,0.0191 c -0.0393,0.0243 -0.1004,0.10685 -0.14469,0.19482 -0.097,0.19264 -0.17986,0.54042 -0.21601,0.90641 -0.0176,0.17802 -0.0194,0.2417 -0.0181,0.47129 -10e-4,0.22958 4.9e-4,0.29326 0.0181,0.47128 z m 6.24819,0.005 c -0.0174,0.28352 -0.0477,0.58871 -0.0796,0.79891 h -0.001 c -0.0235,0.15794 -0.0261,0.18934 -0.0155,0.19534 0.004,0.002 0.0341,0.007 0.0682,0.01 0.13705,0.0137 0.58706,0.0779 0.9338,0.13332 0.202,0.0323 0.39156,0.0587 0.42116,0.0589 0.1653,0.001 0.3057,-0.16225 0.41031,-0.47853 0.1047,-0.31587 0.15499,-0.75432 0.15399,-1.19062 v -0.006 c 0.001,-0.4363 -0.0493,-0.87476 -0.15399,-1.19063 -0.10461,-0.31628 -0.24501,-0.47978 -0.41031,-0.47852 -0.0296,2.3e-4 -0.21917,0.0266 -0.42117,0.0589 -0.34674,0.0554 -0.79674,0.11964 -0.93379,0.13332 -0.0341,0.003 -0.0645,0.008 -0.0682,0.01 -0.0106,0.006 -0.008,0.0374 0.0155,0.19534 h 0.001 c 0.0319,0.2102 0.0622,0.5154 0.0796,0.79892 0.0129,0.32362 0.009,0.63395 0,0.95188 z m -4.16667,1.00975 c -0.36644,0 -0.7063,0.004 -0.7555,0.008 -0.11447,0.0104 -0.14687,0.0253 -0.18087,0.0847 v 5.3e-4 c -0.0144,0.0251 -0.0264,0.0541 -0.0264,0.0641 0,0.0227 0.0389,0.0605 0.0811,0.0718 0.0823,0.0221 1.34367,0.10564 1.44695,0.0966 l 0.0331,-0.003 0.0382,-0.15037 c 0.0209,-0.0827 0.0356,-0.15575 0.0336,-0.16175 -0.003,-0.009 -0.14502,-0.0111 -0.67025,-0.0109 z m 1.0511,0.01 -0.15968,0.003 -0.0186,0.11472 c -0.0334,0.20587 -0.0335,0.20688 -0.0103,0.21188 0.0481,0.0101 1.15883,0.0403 1.48724,0.0403 0.11466,1e-4 0.14997,-0.002 0.15297,-0.0114 0.005,-0.0131 -0.10618,-0.30575 -0.12248,-0.32195 -0.0122,-0.0122 -1.06322,-0.0417 -1.32912,-0.0367 z m 1.66605,0.0413 c 0.0964,0.14656 0.23338,0.30996 0.25528,0.32246 0.0201,0.0115 1.34512,-0.0143 1.78026,-0.0346 0.1291,-0.006 0.13032,-0.007 0.0992,-0.0594 -0.0169,-0.0286 -0.0234,-0.0317 -0.11731,-0.0537 -0.59115,-0.0993 -1.33329,-0.16979 -2.01743,-0.17476 z}
	\pgfsetcolor{windowblue}

	\begingroup
		\tikz@mode
		\iftikz@mode@draw
			\expandafter\pgf@setstrokecolor\pgfsavedstrokecolor
			\pgfusepath{stroke, fill}
		\else
			\pgfusepath{fill}
		\fi
	\endgroup
}
}
\newdimen\ya
\newdimen\xa
\newdimen\lastangle
\newdimen\pgfdecorationlanewidth
\makeatletter
%\pgfmathparse{10*\pgflinewidth}
\pgfdecorationlanewidth10\pgflinewidth
%
\newif\ifpgfdecoratehascenterline
\pgfkeys{%
	/pgf/decoration/.cd,
	lane width/.code={\pgfmathsetlength\pgfdecorationlanewidth{#1}},
	outer modulation/.default=1,
	outer modulation/.store in=\pgfdecorationlanemodulation,
	outer modulation,
	draw centerline/.is if=pgfdecoratehascenterline,
	draw centerline=true,
}
\pgfdeclaredecoration{road}{initial}
{
	\state{initial}[%
	width=\pgfdecorationsegmentlength, %
	next state=curve, %
	persistent postcomputation={
		%store the next control point
		\pgfmathsetlength{\lastangle}{\pgfdecoratedangle}%
	}
	]{
		\pgfpathmoveto{\pgfpointorigin}
		%calculate the next control point
		\pgfcoordinate{@1}{\pgfpoint{0pt}{0pt}}
		\pgfcoordinate{@2}{\pgfpoint{.3\pgfdecorationsegmentlength}{0pt}}
		\pgfcoordinate{@3}{\pgfpoint{0pt}{\pgfdecorationlanewidth}}
		\pgfcoordinate{@4}{\pgfpoint{.4\pgfdecorationsegmentlength}{\pgfdecorationlanewidth}}
		\pgfcoordinate{@5}{\pgfpoint{0pt}{-\pgfdecorationlanewidth}}
		\pgfcoordinate{@6}{\pgfpoint{.4\pgfdecorationsegmentlength}{-\pgfdecorationlanewidth}}
		\pgf@process{\pgfpointtransformed{\pgfpoint{0}{0}}}
		%\pgfmathsetmacro{\lastangle}{\pgfdecoratedangletonextinputsegment}
	}
	%
	\state{curve}[%
	width=\pgfdecorationsegmentlength,
	next state=curve,
	switch if less than=\pgfdecorationsegmentlength to final,
	persistent postcomputation={
		%store the next control point
		\pgfmathsetlength{\lastangle}{\pgfdecoratedangle}%
	}
	]{	
		%
		%
		\edef\curlinewidth{\the\pgflinewidth}
		\pgfmathsetlengthmacro\pgf@decoration@contour@shorten{%
			\pgfdecorationlanewidth*sin((\pgfdecoratedangle-\lastangle))}
		\begin{pgfscope}
			\pgfpathmoveto{\pgfpoint{0}{0}}
			\pgfsetlinewidth{2.4\pgfdecorationlanewidth}
			\pgfpathlineto{\pgfpointanchor{@1}{center}}
			\pgfsetstrokecolor{lightgray}
			\pgfpathmoveto{\pgfpoint{\pgf@decoration@contour@shorten}{1.2*\pgfdecorationlanewidth}}
			\pgfpathlineto{\pgfpoint{0}{1.2\pgfdecorationlanewidth}}
			\pgfpathmoveto{\pgfpoint{\pgf@decoration@contour@shorten}{1.2*\pgfdecorationlanewidth}}
			\pgfusepath{stroke}
		\end{pgfscope}
		%
		\pgfpathmoveto{\pgfpoint{0}{0}}
		%
		\pgfpathmoveto{\pgfpoint{0.2}{0}}
		%
		\begin{pgfscope}
			\pgfsetlinewidth{\curlinewidth}
			\pgfsetstrokecolor{white}
			%
			\ifpgfdecoratehascenterline
			\pgfpathcurvebetweentime{0.5}{1}{%
				\pgfpoint{0.0}{0}
			}%
			{%
				\pgfpoint{-.3\pgfdecorationsegmentlength}{0pt}%
			}%
			{%
				\pgfpointanchor{@2}{center}%
			}%
			{%
				\pgfpointanchor{@1}{center}%
			}%
			\fi
			%
			\newdimen\dummy
			\dummy = \pgfdecorationlanemodulation pt
			\ifdim\dummy>0.0pt
			\pgfpathmoveto{\pgfpoint{0}{\pgfdecorationlanewidth}}
			\pgfpathcurvebetweentime{0}{\pgfdecorationlanemodulation}{%
				\pgfpoint{0}{\pgfdecorationlanewidth}
			}%
			{%
				\pgfpoint{-.5\pgfdecorationsegmentlength}{\pgfdecorationlanewidth}%
			}%
			{%
				\pgfpointanchor{@4}{center}%
			}%
			{%
				\pgfpointanchor{@3}{center}%
			}%
			\pgfpathmoveto{\pgfpoint{0}{-\pgfdecorationlanewidth}}
			\pgfpathcurvebetweentime{0}{\pgfdecorationlanemodulation}{%
				\pgfpoint{0}{-\pgfdecorationlanewidth}
			}%
			{%
				\pgfpoint{-.5\pgfdecorationsegmentlength}{-\pgfdecorationlanewidth}%
			}%
			{%
				\pgfpointanchor{@6}{center}%
			}%
			{%
				\pgfpointanchor{@5}{center}%
			}%	
			%
			\fi
			\pgfusepath{stroke}
		\end{pgfscope}
		%
		\pgfcoordinate{@1}{\pgfpoint{-0.5pt}{0pt}}
		\pgfcoordinate{@2}{\pgfpoint{.3\pgfdecorationsegmentlength}{0pt}}
		\pgfcoordinate{@3}{\pgfpoint{-0.7pt}{\pgfdecorationlanewidth}}
		\pgfcoordinate{@4}{\pgfpoint{.4\pgfdecorationsegmentlength}{\pgfdecorationlanewidth}}
		\pgfcoordinate{@5}{\pgfpoint{-0.7pt}{-\pgfdecorationlanewidth}}
		\pgfcoordinate{@6}{\pgfpoint{.4\pgfdecorationsegmentlength}{-\pgfdecorationlanewidth}}
	}
	\state{final}
	{%
		\edef\curlinewidth{\the\pgflinewidth}
		\begin{pgfscope}
			\pgfpathmoveto{\pgfpoint{\pgfdecoratedremainingdistance}{0}}
			\pgfsetlinewidth{2.4\pgfdecorationlanewidth}
			\pgfpathlineto{\pgfpointanchor{@1}{center}}
			\pgfsetstrokecolor{lightgray}
			\pgfusepath{stroke}
		\end{pgfscope}
		%
		\pgfpathmoveto{\pgfpoint{0}{0}}
		%
		\pgfpathmoveto{\pgfpoint{0.2}{0}}
		%
		\begin{pgfscope}
			\pgfsetlinewidth{\curlinewidth}
			\pgfsetstrokecolor{white}
			\ifpgfdecoratehascenterline
			\pgfpathcurvebetweentime{0.5}{1}{%
				\pgfpoint{0.0}{0}
			}%
			{%
				\pgfpoint{-.3\pgfdecorationsegmentlength}{0pt}%
			}%
			{%
				\pgfpointanchor{@2}{center}%
			}%
			{%
				\pgfpointanchor{@1}{center}%
			}%
			\fi
			%
			\newdimen\dummy
			\dummy = \pgfdecorationlanemodulation pt
			\ifdim\dummy>0.0pt
			\pgfpathmoveto{\pgfpoint{\pgfdecoratedremainingdistance}{\pgfdecorationlanewidth}}
			\pgfpathcurvebetweentime{0}{\pgfdecorationlanemodulation}{%
				\pgfpoint{\pgfdecoratedremainingdistance}{\pgfdecorationlanewidth}
			}%
			{%
				\pgfpoint{-.5\pgfdecorationsegmentlength}{\pgfdecorationlanewidth}%
			}%
			{%
				\pgfpointanchor{@4}{center}%
			}%
			{%
				\pgfpointanchor{@3}{center}%
			}%
			%	
			\pgfpathmoveto{\pgfpoint{\pgfdecoratedremainingdistance}{-\pgfdecorationlanewidth}}
			\pgfpathcurvebetweentime{0}{\pgfdecorationlanemodulation}{%
				\pgfpoint{\pgfdecoratedremainingdistance}{-\pgfdecorationlanewidth}
			}%
			{%
				\pgfpoint{-.5\pgfdecorationsegmentlength}{-\pgfdecorationlanewidth}%
			}%
			{%
				\pgfpointanchor{@6}{center}%
			}%
			{%
				\pgfpointanchor{@5}{center}%
			}%	
			%
			\fi
			\ifpgfdecoratehascenterline
			\ifdim\pgfdecoratedinputsegmentremainingdistance<\pgfdecorationsegmentlength*0.55
			\pgfmoveto{\pgfpoint{\pgfdecoratedinputsegmentremainingdistance}{0}}
			\pgflineto{\pgfpoint{0}{0}}
			\fi
			\fi
			\pgfusepath{stroke}
		\end{pgfscope}	
	}
}

\pgfkeys{/pgf/.cd,
	parallelepiped offset x/.initial=2mm,
	parallelepiped offset y/.initial=2mm
}
\pgfdeclareshape{parallelepiped}
{
	\inheritsavedanchors[from=rectangle] % this is nearly a rectangle
	\inheritanchorborder[from=rectangle]
	\inheritanchor[from=rectangle]{north}
	\inheritanchor[from=rectangle]{north west}
	\inheritanchor[from=rectangle]{north east}
	\inheritanchor[from=rectangle]{center}
	\inheritanchor[from=rectangle]{west}
	\inheritanchor[from=rectangle]{east}
	\inheritanchor[from=rectangle]{mid}
	\inheritanchor[from=rectangle]{mid west}
	\inheritanchor[from=rectangle]{mid east}
	\inheritanchor[from=rectangle]{base}
	\inheritanchor[from=rectangle]{base west}
	\inheritanchor[from=rectangle]{base east}
	\inheritanchor[from=rectangle]{south}
	\inheritanchor[from=rectangle]{south west}
	\inheritanchor[from=rectangle]{south east}
	\backgroundpath{
		% store lower right in xa/ya and upper right in xb/yb
		\southwest \pgf@xa=\pgf@x \pgf@ya=\pgf@y
		\northeast \pgf@xb=\pgf@x \pgf@yb=\pgf@y
		\pgfmathsetlength\pgfutil@tempdima{\pgfkeysvalueof{/pgf/parallelepiped offset x}}
		\pgfmathsetlength\pgfutil@tempdimb{\pgfkeysvalueof{/pgf/parallelepiped offset y}}
		\def\ppd@offset{\pgfpoint{\pgfutil@tempdima}{\pgfutil@tempdimb}}
		\pgfpathmoveto{\pgfqpoint{\pgf@xa}{\pgf@ya}}
		\pgfpathlineto{\pgfqpoint{\pgf@xb}{\pgf@ya}}
		\pgfpathlineto{\pgfqpoint{\pgf@xb}{\pgf@yb}}
		\pgfpathlineto{\pgfqpoint{\pgf@xa}{\pgf@yb}}
		\pgfpathclose
		\pgfpathmoveto{\pgfqpoint{\pgf@xb}{\pgf@ya}}
		\pgfpathlineto{\pgfpointadd{\pgfpoint{\pgf@xb}{\pgf@ya}}{\ppd@offset}}
		\pgfpathlineto{\pgfpointadd{\pgfpoint{\pgf@xb}{\pgf@yb}}{\ppd@offset}}
		\pgfpathlineto{\pgfpointadd{\pgfpoint{\pgf@xa}{\pgf@yb}}{\ppd@offset}}
		\pgfpathlineto{\pgfqpoint{\pgf@xa}{\pgf@yb}}
		\pgfpathmoveto{\pgfqpoint{\pgf@xb}{\pgf@yb}}
		\pgfpathlineto{\pgfpointadd{\pgfpoint{\pgf@xb}{\pgf@yb}}{\ppd@offset}}
	}
}

\makeatother