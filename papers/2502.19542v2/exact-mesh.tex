\section{Exact Meshes}\label{sec:exact-meshes}

To begin this section, we introduce some notation to help the readability of the forthcoming
proofs. First, we define the subset \(\Bll \subseteq \bspbasis^{\boldvec{0}}_{\level}\)
composed of B-splines in level \(\level\) whose support is contained in
\(\domain_{\level+1}\), i.e., 
\begin{equation*}\label{eq:bll-definition}
	\Bll \coloneqq \left\{\bsp \in \bspbasis^{\boldvec{0}}_{\level}:
	\supp(\bsp) \subseteq \domain_{\level+1}\right\}\;.
\end{equation*}
Second, we will simplify the notation of B-spline basis functions, and write
\(\xbsp_{\boldvec{i}} \coloneqq \bsp^{\boldvec{0}}_{\boldvec{i}, \level} \), since all arguments in the proofs rely only on B-splines in the first space of the de Rham complex and two consecutive hierarchical levels.

We now move on to define precisely when a hierarchical refinement leads to an inexact
complex, and how it can be altered by refining some additional functions to form an exact complex that satisfies the sufficient conditions in \cite{Shepherd2024}. We first recall the definitions of chains and shortest chains from that paper, and we introduce some particular cases of shortest chains.

\begin{defn}[Chain]\label{def:chain}
	Let \(\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \in \Bll\).
	We say that there is a chain between \(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{j}}\)
	if there exists \(r \in \mathbb{Z}_{\geq 0}\) and B-splines \(\xbsp_{\boldvec{t}_l} \in
	\Bll,~l = \{0,\dots,r\}\), such that \(\xbsp_{\boldvec{i}} = \xbsp_{\boldvec{t}_0},
	\xbsp_{\boldvec{j}} = \xbsp_{\boldvec{t}_r}\) and \(|\boldvec{t}_{l} - \boldvec{t}_{l-1}| = 1\)
	for all \(l \in \{1,\dots,r\}\). 
	We will denote this chain by \(\chain{\boldvec{i}}{\boldvec{j}} :=
	\{\xbsp_{\boldvec{t}_l} \in \Bll~:~l = 0,\dots,r\}\), and we will call \(r\) the
	length of the chain.
\end{defn}
\begin{defn}[Shortest chain]\label{def:shortest-chain}
	Let \(\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \in \Bll\). A chain between
	\(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{j}}\), as in \Cref{def:chain}, is said to
	be a shortest chain if we have \(r= \sum_k \abs{j_k - i_k}\).
\end{defn}

\begin{defn}[Direction-\(k\) chain]\label{def:k-chain}
	Let \(\xbsp_{ \boldvec{i} }, \xbsp_{\boldvec{j}} \in \Bll\) and \(k \in \{1,2\}\) be
	such that \(i_{k'} = j_{k'}\) for \(k' \not = k\).
	We say that there is a direction-\(k\) chain between \(\xbsp_{\boldvec{i}}\) and
	\(\xbsp_{\boldvec{j}}\) if \(\xbsp_{\boldvec{r}} \in \Bll\) for every \(\boldvec{r} \in
	\mathbb{N}^2\) such that \[
	\min\{i_k,j_k\} < r_k < \max\{i_k,j_k\}
	~\wedge~	
	i_{k'} = r_{k'} = j_{k'} \text{ for } k'  \neq k.
	\]
\end{defn}

\begin{defn}[\lchain]\label{def:L-chain}
	Let \(\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \in \Bll \).
	We say that there exists an \lchain between them if for some \(\xbsp_{\boldvec{c}} \in
	\Bll\) there exists a direction-\(k_1\) chain, \(\chain{\boldvec{i}}{\boldvec{c}}\),
	between \(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{c}}\) and a direction-\(k_2\)
	chain, \(\chain{\boldvec{c}}{\boldvec{j}}\), between \(\xbsp_{\boldvec{c}}\) and
	\(\xbsp_{\boldvec{j}}\), such that \(k_1 \neq k_2\).
	The union of the chains \(\chain{\boldvec{i}}{\boldvec{c}}\) and
	\(\chain{\boldvec{c}}{\boldvec{j}}\) is called the \lchain between
	\(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{j}}\), and \(\xbsp_{\boldvec{c}}\) is
	called its corner element.
\end{defn}

\begin{lem}\label{lem:k-chain-shortest}
	Let \(\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \in \Bll \) have a direction-\(k\) chain
	\(\chain{\boldvec{i}}{\boldvec{j}}\) between them.
	Then, \(\chain{\boldvec{i}}{\boldvec{j}}\) is a shortest chain.
\end{lem}
\begin{proof}
	Let \(\boldsymbol{\Delta} = \boldvec{j} -\boldvec{i}\) and assume \wlg that
	\(\Delta_k\geq0\). Then, the direction-\(k\) chain \(\chain{\boldvec{i}}{\boldvec{j}}\) is
	equal to \[
	\{
		\xbsp_{\boldvec{i}},
		\xbsp_{\boldvec{i}+\boldvec{\delta}_k},\xbsp_{\boldvec{i}+2\boldvec{\delta}_k},\dots,
		\xbsp_{\boldvec{j}}
	\}\;.
	\]
	It is clear that this chain satisfies the conditions for being a shortest chain, since
	its length is \(\abs{\boldsymbol{\Delta}} = j_k - i_k\).
\end{proof}

\begin{lem}\label{lem:L-chain-shortest}
	Let \(\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \in \Bll \). Then, any \lchain between
	them is a shortest chain.
\end{lem}
\begin{proof}
	Assume without loss of generality that \(j_k \geq i_k\), for \(k = 1,2\).
	Since the \lchain is the union of a direction-\(1\) and direction-\(2\) chain, it is
	easy to see that its length is \((j_1 - i_1) + (j_2 - i_2) = \abs{\boldvec{j} - \boldvec{i}}\), and hence it is a shortest chain.
\end{proof}

The following are two definitions and the main result from \cite{Shepherd2024}, that gives a sufficient condition for exactness.
\begin{defn}\label{def:nlintersec}
	Let \( \xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \in \Bll \).
	We say that \(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{j}}\) share a \nlintersec if
	there exists some \(k_0 \in\{1, 2\}\) and
	\((\knot_{t_1,\level+1,1},\knot_{t_2,\level+1,2}) \in
	\knotvec_{\level+1,1} \times \knotvec_{\level+1,2}\) such that
    \begin{align*}
		\overline{\supp(\xbsp_{\boldvec{i}})} \cap \overline{\supp(\xbsp_{\boldvec{j}})} &\supseteq
		\bigtimes_{k=1}^2 I_k\;, \\
        I_k &\coloneqq 
		\begin{cases*}
			(\knot_{t_k,\level+1,k}, \knot_{t_k+p_{(\level+1, k)},\level+1,k})\;,
			& \( k\neq k_0\)\;, \\
			\left\{\knot_{t_k,\level+1,k}\right\}\;,& \( k = k_0\)\;.
        \end{cases*}
    \end{align*}
\end{defn}

\begin{defn}[Problematic pairs and chains]
	Let \( \xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \in \Bll \) share a \nlintersec. We say
	that the pair is problematic if there is no shortest chain between them.
	We also say that a chain is problematic with \( \xbsp_{\boldvec{i}}
	\) if any spline in the chain is problematic with \( \xbsp_{\boldvec{i}} \).
\end{defn}

\begin{thm}[\cite{Shepherd2024}, Theorem 4.24]
	Let us assume that, for every \( \xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \in \Bll \) sharing a \nlintersec, there exists a shortest chain \(\chain{\boldvec{i}}{\boldvec{j}}\) between them, 
	for \(\level = 0, \ldots, L\). Then the hierarchical complex \eqref{eq:hierarchical-complex} is exact for \(\level = 0, \ldots, L\).
\end{thm}

To fix problematic pairs it is necessary to join them by a shortest chain of refined
B-splines. However, additional refinement can lead to new problematic pairs that need to be
checked and resolved recursively. The following results show that \lchains reduce the number of checks to be performed during this process.
\begin{defn}\label{def:resolved}
	Let \(\xbsp_{\boldvec{i}} \in \Bll\) and \(k \in \{1,2\}\). We define the \(k\)-side configuration of
	\(\xbsp_{\boldvec{i}}\) as \[
		\sideconfig_{\boldvec{i}, k} \coloneqq \left\{
			\xbsp_{\boldvec{t}} \in \bspbasis^{\boldvec{0}}_{\level} :
			\, \boldvec{t} - \boldvec{i} = \pm \boldvec{\delta}_k,
		\right\}\;.
    \]
	Moreover, we say that \(\xbsp_{\boldvec{i}} \in \Bll\) is resolved in direction \(k\) if \(
		\sideconfig_{\boldvec{i}, k} \subseteq \Bll.
	\)
\end{defn}

\begin{lem}[Problematic sides]\label{lem:problematic-sides}
	Let \(\xbsp_{\boldvec{i}},\xbsp_{\boldvec{j}} \in \Bll \) be a problematic pair, and
	\(\xbsp_{\boldvec{i}}\) be resolved in direction \(k \in \{1,2\}\).
	Then, there must be some \(\xbsp_{\boldvec{t}} \in \sideconfig_{\boldvec{i}, k}\) that
	is problematic with \(\xbsp_{\boldvec{j}}\), and \(\abs{t_k - j_k} < \abs{i_k - j_k}\).
\end{lem}
\begin{proof}
	Since \(\xbsp_{\boldvec{i}}\) is resolved in direction \(k\), by definition there exists
	\(\xbsp_{\boldvec{t}}\in \sideconfig_{\boldvec{i},k}\) such that \(\abs{t_k - j_k} <
	\abs{i_k - j_k}\). 
	This implies that \(\overline{\supp(\xbsp_{\boldvec{i}})} \cap \overline{\supp(\xbsp_{\boldvec{j}})}
	\subseteq \overline{\supp(\xbsp_{\boldvec{t}})} \cap \overline{\supp(\xbsp_{\boldvec{j}})}\), which in turn means
	that there is a \nlintersec between \(\xbsp_{\boldvec{t}}\) and \(\xbsp_{\boldvec{j}}\).
	Since a shortest chain between \(\xbsp_{\boldvec{t}}\) and \(\xbsp_{\boldvec{j}}\) would
	result in a shortest chain between \(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{j}}\),
	and hence a contradiction, the pair \(\xbsp_{\boldvec{t}}, \xbsp_{\boldvec{j}}\) must be
	problematic.
\end{proof}

\begin{lem}[Problematic chain in 2D] \label{lem:problematic-chain}
	Let \(\xbsp_{\boldvec{i}},\xbsp_{\boldvec{j}},
	\xbsp_{\boldvec{l}}  \in \Bll\) be such that there exists an
	\lchain \( \chain{\boldvec{i}}{\boldvec{j}} \) between \( \xbsp_{\boldvec{i}} \) and
	\(\xbsp_{\boldvec{j}}\), with corner
	element \( \xbsp_{\boldvec{c}}\).
	If \(\xbsp_{\boldvec{l}}\) is problematic with
	\(\chain{\boldvec{i}}{\boldvec{j}}\), then it must be problematic with at least one of
	\(\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}} \)
	and \(\xbsp_{\boldvec{c}}\).
\end{lem}
\begin{proof}
	Suppose \( \xbsp_{\boldvec{l}} \) is problematic with some \(
	\xbsp_{\boldvec{t}} \in \chain{\boldvec{i}}{\boldvec{j}}\). If \( \xbsp_{\boldvec{t}}
	\in \{\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}}, \xbsp_{\boldvec{c}}\} \) the proof is
	trivial, so, consider \( \xbsp_{\boldvec{t}} \in \chain{\boldvec{i}}{\boldvec{j}}
	\backslash \{\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}}, \xbsp_{\boldvec{c}}\}\).
	Then, since \(\xbsp_{\boldvec{t}}\) will be resolved in some direction \(k\), we can
	recursively apply \Cref{lem:problematic-sides} to prove that there exists
	\(\xbsp_{\boldvec{v}} \in \{\xbsp_{\boldvec{i}}, \xbsp_{\boldvec{j}},
	\xbsp_{\boldvec{c}}\} \) that is problematic with \(\xbsp_{\boldvec{l}}\).
\end{proof}

We now introduce the concept of an interaction box, and some related
results that will help to simplify the search for shortest chains in
the algorithms of \Cref{sec:algorithms}.

\begin{defn}\label{def:int-box}
	Let \(\xbsp_{\boldvec{i}} \in \Bll\). We define the interaction box
	\(\interbox{\boldvec{i}}\) of \(\xbsp_{\boldvec{i}}\) as the set of
	B-splines in \(\Bll\) that are at a maximum distance of \(\degree_{(\ell, k)}+1\) knot
	indices, in each dimension. In other words, \[
		\interbox{\boldvec{i}} \coloneqq \left\{
			\xbsp_{\boldvec{j}} \in \Bll : \abs{i_k - j_k} \leq \degree_{(\ell, k)} + 1, \text{ for } k = 1,2
		\right\}.
	\]
\end{defn}

To refer to the intersection of two interaction boxes \(\interbox{\boldvec{i}}\)
and \(\boldvec{j}\) we will write \(\interbox{\boldvec{i}}{\boldvec{j}}\coloneqq
\interbox{\boldvec{i}}\cap\interbox{\boldvec{j}}\).

\begin{lem}\label{lem:int-box-chain}
	Let \(\xbsp_{\boldvec{i}},\xbsp_{\boldvec{j}}
	\in \Bll\). 
	If \(\chain{\boldvec{i}}{\boldvec{j}}\) is a chain contained in
	\(\interbox{\boldvec{i}}{\boldvec{j}}\), then there exists a shortest chain between
	\(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{j}}\).
\end{lem}
\begin{proof}
	If a subset of \(\chain{\boldvec{i}}{\boldvec{j}}\) is a shortest chain then we are done.
	Suppose then that no subset of \(\chain{\boldvec{i}}{\boldvec{j}}\) is a shortest chain and assume, \wlg,
	that \(i_k<j_k\), for \(k =1,2\). By the chain not being a shortest chain, we know that
	there must exist at least one pair, \(\xbsp_{\boldvec{l}},\xbsp_{\boldvec{t}} \in \chain{\boldvec{i}}{\boldvec{j}} \cap \interbox{\boldvec{i}}{\boldvec{j}}\), with a ``kink''. By this, we mean that there exists
	\(k \in \{1,2\}\) such that \(l_{k} = t_{k}\) but the corresponding
	direction-\(k'\) chain \(\chain{\boldvec{l}}{\boldvec{t}}\), \(k' \in \{1, 2\} \backslash k\), is not a subset of \(\chain{\boldvec{i}}{\boldvec{j}}\). However, since
	\(\xbsp_{\boldvec{l}}\) and \(\xbsp_{\boldvec{t}}\) are both in \(\interbox{\boldvec{i}}{\boldvec{j}}\), their supports have a non-empty intersection, which implies
	that \(\supp(\xbsp_{\boldvec{r}}) \subseteq \overline{\supp(\xbsp_{\boldvec{l}})} \cup \overline{\supp(\xbsp_{\boldvec{t}})} \subseteq \Omega_{\level+1} \) for all \(\boldvec{r} \in \NN^{2}\) such that
	\[
		l_{k} = r_{k} = t_{k} ~\wedge~ 
		\min(l_{k'},t_{k'}) < r_{k'} < \max(l_{k'},t_{k'})\;.
	\]
	Hence, all the B-splines in \(\chain{\boldvec{l}}{\boldvec{t}}\) belong to \(\Bll\), and as a consequence to \(\interbox{\boldvec{i}}{\boldvec{j}}\),
	and we can use them to remove the ``kink'' between \(\xbsp_{\boldvec{l}}\) and
	\(\xbsp_{\boldvec{t}}\) to obtain a new chain \(\widetilde{C}_{\boldvec{i},\boldvec{j}}\) with a smaller length.
	Repeating the procedure for every such ``kink'' will yield a shortest chain
	between \(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{j}}\).
\end{proof}

\begin{lem}\label{lem:containment}
	Let \(\xbsp_{\boldvec{i}},\xbsp_{\boldvec{j}} \in \Bll\) share a \nlintersec and have an
	\lchain in \(\chain{\boldvec{i}}{\boldvec{j}}\) between them.
	Moreover, let \(\xbsp_{\boldvec{l}}\) share a \nlintersec with some
	\(\xbsp_{\boldvec{t}} \in \chain{\boldvec{i}}{\boldvec{j}}\) and such that there is an \lchain \(\chain{\boldvec{l}}{\boldvec{t}}\).
	Then, there are no problematic pairs between \(\chain{\boldvec{i}}{\boldvec{j}}\) and
	\(\chain{\boldvec{l}}{\boldvec{t}}\).
\end{lem}
\begin{proof}
	We will prove the result directly, by showing that there is a shortest chain between any
	pair of B-splines, one in each \lchain, that share a \nlintersec.

	As such, suppose that \(\xbsp_{\boldvec{p}} \in \chain{\boldvec{i}}{\boldvec{j}}\)
	and \(\xbsp_{\boldvec{p}'}\in \chain{\boldvec{l}}{\boldvec{t}}\) share a \nlintersec.
	Since \(\xbsp_{\boldvec{i}}\) and \(\xbsp_{\boldvec{j}}\) share a \nlintersec, the same is true for any other pair of B-splines in \(\chain{\boldvec{i}}{\boldvec{j}}\), and in particular for \(\xbsp_{\boldvec{p}}\) and \(\xbsp_{\boldvec{t}}\). Analogously, \(\xbsp_{\boldvec{p}'}\) and \(\xbsp_{\boldvec{t}}\) must also
	share a \nlintersec.
	Hence, we can conclude that \(\xbsp_{\boldvec{t}} \in
	\interbox{\boldvec{p}}{\boldvec{p}'} \).

	Using the definition of \lchains, it is clear that we can find subsets of
	\(\chain{\boldvec{i}}{\boldvec{j}}\) and \(\chain{\boldvec{l}}{\boldvec{t}}\), contained
	in \(\interbox{\boldvec{p}}{\boldvec{p}'}\), that are chains between
	\(\xbsp_{\boldvec{t}}\) and \(\xbsp_{\boldvec{p}}\) and \(\xbsp_{\boldvec{t}}\) and
	\(\xbsp_{\boldvec{p}'}\), respectively.
	Invoking \Cref{lem:int-box-chain}, we reason that there is a shortest chain between
	\(\xbsp_{\boldvec{p}}\) and \(\xbsp_{\boldvec{p}'}\), thus finishing the proof.
\end{proof}

\begin{rem}\label{rem:preferable-lchain}
	Let \(\xbsp_{\boldvec{i}},\xbsp_{\boldvec{j}}\in \Bll\) be a problematic pair.
	There are two possible \lchains that can be constructed between the pair â€• depending on
	the corner element chosen.
	It is always preferable to choose the \lchain that leads to the highest number of
	resolved B-splines, as this reduces the necessary checks for new problematic pairs.
\end{rem}
